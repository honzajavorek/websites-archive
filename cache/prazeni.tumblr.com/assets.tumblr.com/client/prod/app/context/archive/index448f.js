require=function t(e,i,s){function n(a,r){if(!i[a]){if(!e[a]){var l="function"==typeof require&&require;if(!r&&l)return l(a,!0);if(o)return o(a,!0);throw new Error("Cannot find module '"+a+"'")}var h=i[a]={exports:{}};e[a][0].call(h.exports,function(t){var i=e[a][1][t];return n(i?i:t)},h,h.exports,t,e,i,s)}return i[a].exports}for(var o="function"==typeof require&&require,a=0;a<s.length;a++)n(s[a]);return n}({1:[function(t,e,i){"use strict";var s=t("prima/bootloader"),n=t("prima/lib/domeventor"),o=t("prima/lib/logger"),a=s.extend({setup:function(e){s.prototype.setup.apply(this,arguments),n.init(),o.log("Exec","Bootstrap/DOMEventor"),o.log("Exec","Bootstrap/Legacy"),t("./legacy")},initialize:function(){this.context=new(t("context"))}});e.exports=a},{"./legacy":428,context:"Ymdf+y","prima/bootloader":508,"prima/lib/domeventor":516,"prima/lib/logger":519}],2:[function(t,e,i){var s=t("prima/collection"),n=t("../models/tumblelog"),o=s.extend({model:n});e.exports=o},{"../models/tumblelog":436,"prima/collection":510}],3:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/component"),o=t("./views/account-popover"),a=t("app/lib/currentuser"),r=n.extend({name:"AccountPopover",view:function(t){return t=s.extend({},{model:a(),pinnedTarget:this.container,isFixedPosition:!0,autoTeardown:!1,teardownOnEscape:!1},t),new o(t)},show:function(){this.view.show()},render:function(){return this.view.render(),this.trigger("append"),this}});e.exports=r},{"./views/account-popover":9,"app/lib/currentuser":432,lodash:"MicNly","prima/component":511}],4:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __t,__p="";Array.prototype.join;with(obj||{})__p+='<ul data-blog-details-inner class="blog-sub-nav-details"><li class="blog-sub-nav-item ',isSelected("/blog/"+model.name)&&(__p+="selected"),__p+='" data-js-menu-item><a href="/blog/'+(null==(__t=model.name)?"":_.escape(__t))+'" class="blog-sub-nav-item-link" data-js-menu-item-link><div class="blog-sub-nav-item-label">'+(null==(__t=__("Posts"))?"":_.escape(__t))+"</div>",model.post_count>0&&(__p+='<div class="blog-sub-nav-item-data">'+(null==(__t=numberFormat(model.post_count))?"":_.escape(__t))+"</div>"),__p+="</a></li>",model.radar_feature_premium&&(__p+='<li class="blog-sub-nav-item ',isSelected("/radar/analytics")&&(__p+="selected"),__p+='" data-js-menu-item><a href="/radar/analytics" class="blog-sub-nav-item-link" data-js-menu-item-link><div class="blog-sub-nav-item-label">'+(null==(__t=__("Reach"))?"":_.escape(__t))+"</div></a></li>"),__p+='<li class="blog-sub-nav-item ',isSelected("/blog/"+model.name+"/followers")&&(__p+="selected"),__p+='" data-js-menu-item><a href="/blog/'+(null==(__t=model.name)?"":_.escape(__t))+'/followers" class="blog-sub-nav-item-link" data-js-menu-item-link><div class="blog-sub-nav-item-label">'+(null==(__t=__("Followers"))?"":_.escape(__t))+"</div>",model.follower_count>0&&(__p+='<div class="blog-sub-nav-item-data">'+(null==(__t=numberFormat(model.follower_count))?"":_.escape(__t))+"</div>"),__p+="</a></li>",model.activity_data&&model.activity_data.sparkline&&(__p+='<li class="blog-sub-nav-item ',isSelected("/blog/"+model.name+"/activity")&&(__p+="selected"),__p+='" data-js-menu-item><a href="/blog/'+(null==(__t=model.name)?"":_.escape(__t))+'/activity" class="blog-sub-nav-item-link" data-js-menu-item-link><div class="blog-sub-nav-item-label">'+(null==(__t=__("Activity"))?"":_.escape(__t))+'</div><div class="blog-sub-nav-item-data sparkline" data-sparkline="'+(null==(__t=model.activity_data.sparkline)?"":_.escape(__t))+'"></div></a></li>'),__p+="",model.member_count>0&&(__p+='<li class="blog-sub-nav-item ',isSelected(model.dashboard_url+"/members")&&(__p+="selected"),__p+='" data-js-menu-item><a href="'+(null==(__t=model.dashboard_url)?"":_.escape(__t))+'/members" class="blog-sub-nav-item-link" data-js-menu-item-link><div class="blog-sub-nav-item-label">'+(null==(__t=__("Members"))?"":_.escape(__t))+'</div><div class="blog-sub-nav-item-data">'+(null==(__t=numberFormat(model.member_count))?"":_.escape(__t))+"</div></a></li>"),__p+="",model.draft_count>0&&(__p+='<li class="blog-sub-nav-item ',isSelected(model.dashboard_url+"/drafts")&&(__p+="selected"),__p+='" data-js-menu-item><a href="'+(null==(__t=model.dashboard_url)?"":_.escape(__t))+'/drafts" class="blog-sub-nav-item-link" data-js-menu-item-link><div class="blog-sub-nav-item-label">'+(null==(__t=__("Drafts"))?"":_.escape(__t))+'</div><div class="blog-sub-nav-item-data">'+(null==(__t=numberFormat(model.draft_count))?"":_.escape(__t))+"</div></a></li>"),__p+="",model.queued_post_count>0&&(__p+='<li class="blog-sub-nav-item ',isSelected(model.dashboard_url+"/queue")&&(__p+="selected"),__p+='" data-js-menu-item><a href="'+(null==(__t=model.dashboard_url)?"":_.escape(__t))+'/queue" class="blog-sub-nav-item-link" data-js-menu-item-link><div class="blog-sub-nav-item-label">'+(null==(__t=__("Queue"))?"":_.escape(__t))+'</div><div class="blog-sub-nav-item-data">'+(null==(__t=numberFormat(model.queued_post_count))?"":_.escape(__t))+"</div></a></li>"),__p+="",model.transcoding_count>0&&(__p+='<li class="blog-sub-nav-item ',isSelected(model.dashboard_url+"/processing")&&(__p+="selected"),__p+='" data-js-menu-item><a href="'+(null==(__t=model.dashboard_url)?"":_.escape(__t))+'/processing" class="blog-sub-nav-item-link" data-js-menu-item-link><div class="blog-sub-nav-item-label">'+(null==(__t=__("Processing"))?"":_.escape(__t))+'</div><div class="blog-sub-nav-item-data">'+(null==(__t=numberFormat(model.transcoding_count))?"":_.escape(__t))+"</div></a></li>"),__p+="",model.is_visible_premium_partner&&(__p+='<li class="blog-sub-nav-item ',isSelected(model.analytics_url)&&(__p+="selected"),__p+='" data-js-menu-item><a href="'+(null==(__t=model.analytics_url)?"":_.escape(__t))+'" class="blog-sub-nav-item-link" data-js-menu-item-link><div class="blog-sub-nav-item-label">'+(null==(__t=__("Analytics"))?"":_.escape(__t))+"</div></a></li>"),__p+="",model.can_view_customize&&(__p+='<li class="blog-sub-nav-item ',isSelected("/settings/blog/"+model.name)&&(__p+="selected"),__p+='" data-js-menu-item><a href="/settings/blog/'+(null==(__t=model.name)?"":_.escape(__t))+'" class="blog-sub-nav-item-link" data-js-menu-item-link><div class="blog-sub-nav-item-label">'+(null==(__t=__("Edit appearance"))?"":_.escape(__t))+"</div></a></li>"),__p+="</ul>";return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],5:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __t,__p="";Array.prototype.join;with(obj||{})__p+='<div class="blog-list-item blog-list-item--on-light '+(null==(__t=model.is_private_group_channel?"blog-list-item--private":"")?"":_.escape(__t))+'">'+(null==(__t=_subview("loader"))?"":__t)+'<a data-js-action-blog-anchor data-js-menu-item-link class="blog-list-item-anchor" href="/blog/'+(null==(__t=model.name)?"":_.escape(__t))+'"><span class="blog-list-item-avatar"><img class="blog-list-item-avatar-image" alt="avatar" src="'+(null==(__t=avatarUrl)?"":_.escape(__t))+'">',model.unread_count>0&&(__p+=' <span class="blog-list-item-icon blog-list-item-unread-notice tab_notice tab-notice--outlined tab-notice--active on-light"><span class="tab_notice_value">'+(null==(__t=model.unread_count>99?"99+":model.unread_count)?"":_.escape(__t))+"</span></span>"),__p+='</span> <span class="blog-list-item-info"><span class="blog-list-item-info-name">'+(null==(__t=model.name)?"":_.escape(__t))+"</span>",model.is_private_group_channel&&(__p+='<i class="blog-list-item-icon blog-list-item-icon-private icon_lock_12"></i>'),__p+='<br><span class="blog-list-item-info-title">'+(null==(__t=model.directory_safe_title)?"":__t)+'</span></span></a> <a data-js-action-details-open class="blog-list-item-button blog-list-item-button-details icon_manburger"></a></div>'+(null==(__t=_subview("details"))?"":__t);return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],6:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __t,__p="";Array.prototype.join;with(obj||{})__p+='<div class="popover popover_menu popover_gradient"><div class="popover_inner"><ul data-js-account-list class="popover_inner_list"><li class="popover_subsection"><div class="popover_header">'+(null==(__t=__("Account"))?"":_.escape(__t))+'<div class="popover_item_suffix"><a data-js-action-logout class="logout" href="/logout" id="logout_button">'+(null==(__t=__("Log out"))?"":_.escape(__t))+'</a></div></div><ul class="popover_menu_list"><li class="popover_menu_item" data-js-menu-item><a class="popover_menu_item_anchor" href="/likes" data-js-menu-item-link>',model.liked_post_count&&model.liked_post_count>0&&(__p+='<div class="popover_item_suffix" data-js-like-count>'+(null==(__t=numberFormat(model.liked_post_count))?"":_.escape(__t))+"</div>"),__p+='<i class="popover_menu_item_anchor_icon like-icon"></i>'+(null==(__t=__("Likes"))?"":_.escape(__t))+"</a></li>",model.friend_count&&model.friend_count>0&&(__p+='<li class="popover_menu_item" data-js-menu-item><a class="popover_menu_item_anchor" href="/following" data-js-menu-item-link><div class="popover_item_suffix" data-js-following-count>'+(null==(__t=numberFormat(model.friend_count))?"":_.escape(__t))+'</div><i class="popover_menu_item_anchor_icon following-icon"></i>'+(null==(__t=__("Following"))?"":_.escape(__t))+"</a></li>"),__p+='<li class="popover_menu_item" data-js-menu-item><a class="popover_menu_item_anchor" href="/settings" data-js-menu-item-link><i class="popover_menu_item_anchor_icon settings-icon"></i>'+(null==(__t=__("Settings"))?"":_.escape(__t))+'</a></li><li class="popover_menu_item" data-js-menu-item><a class="popover_menu_item_anchor" href="/help" data-js-menu-item-link><i class="popover_menu_item_anchor_icon help-icon"></i>'+(null==(__t=__("Help"))?"":_.escape(__t))+'</a></li></ul></li><li class="popover_subsection"><div class="popover_header">'+(null==(__t=__("Blogs"))?"":_.escape(__t))+'<div class="popover_item_suffix"><a href="/new/blog">+&nbsp;'+(null==(__t=__("New"))?"":_.escape(__t))+'</a></div></div><ul class="popover_menu_list"><li class="popover_menu_sublist"><ul data-js-channel-list></ul></li></ul></li></ul></div></div>';return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],7:[function(t,e,i){"use strict";var s=t("lodash"),n=t("backbone"),o=t("velocity-animate"),a=t("numeral"),r=t("prima/views/base"),l=t("../templates/account-popover-blog-sub-nav-details.tpl"),h=r.extend({template:l,className:"popover_menu_item_blog_details",serialize:function(){return{isSelected:this.isSelected,numberFormat:this.numberFormat}},isSelected:function(t){var e="/"+n.history.fragment;return e===t},numberFormat:function(t){return a(t).format("0,0")},addSparkline:function(){var t=this.$el.find(".sparkline"),e=JSON.parse(this.model.get("activity_data").sparkline);e&&0!==s.max(e)&&s.isFunction(t.sparkline)&&(t.sparkline(e,{type:"line",lineColor:"#7f7f7f",fillColor:!1,lineWidth:4,spotColor:!1,minSpotColor:!1,maxSpotColor:!1,disableInteraction:!0,width:"72px",height:"30px"}),t.find("canvas").css({height:"15px",width:"36px"}))},beforeRender:function(){this.stopListening()},afterRender:function(){this.$detailsInner=this.$("[data-blog-details-inner]"),this.listenTo(this.model,"change",function(t){s.any(t.changed,function(t,e){return e.match(/_count$/i)})&&this.render()}),s.defer(s.bind(this.addSparkline,this))},show:function(){this.animateOpen()},hide:function(){this.animateClosed()},animateOpen:function(){var t=this.$detailsInner.outerHeight();return o(this.$el,{height:t},{duration:250,easing:"ease-in-out"})},animateClosed:function(){return o(this.$el,{height:0},{duration:250,easing:"ease-in-out"})},showImmediately:function(){this.$el.css({height:"auto"})},teardown:function(){return this.remove(),this}});e.exports=h},{"../templates/account-popover-blog-sub-nav-details.tpl":4,backbone:"5kFNoY",lodash:"MicNly",numeral:"ubjloo","prima/views/base":581,"velocity-animate":"lWl/mc"}],8:[function(t,e,i){"use strict";var s=t("lodash"),n=t("when"),o=t("app/lib/avatar-size"),a=t("prima/views/base"),r=t("../templates/account-popover-blog-sub-nav.tpl"),l=t("components/loader"),h=t("./account-popover-blog-sub-nav-details"),c=a.extend({tagName:"li",className:"popover_menu_item popover_menu_item_blog",template:r,events:{"click [data-js-action-details-open]":"onClickItem","click [data-js-menu-item-link]":"onClickBlogLink"},defaults:{open:!1,showImmediately:!1,detailsReady:!1,uncloseable:!1},initialize:function(){this.on("change:open",this.toggleOpen),this.on("change:uncloseable",this.toggleUncloseable),this.setAvatarSize(),this.$el.attr({id:"blog-list-item--"+this.model.get("name"),"data-js-menu-item":!0})},setAvatarSize:function(){var t=o(this.model.get("avatar_url"));this.set("avatarUrl",t(64))},toggleUncloseable:function(){this.$el.toggleClass("popover_menu_item_blog--uncloseable",this.get("uncloseable"))},toggleOpen:function(t,e){s.isObject(t)||(e=!!t),e?(this.toggleLoader(!0),this.toggleAnimate(!0),this.$el.addClass("popover_menu_item_blog--open")):(this.toggleAnimate(!1),this.$el.removeClass("popover_menu_item_blog--open"))},toggleLoader:function(t){t===!0?this.loader?this.loader.set("loading",!0):this.loader=new l({$container:this.$el,type:"bar",classModifiers:"top",loading:!0}):this.loader.set("loading",!1)},toggleAnimate:function(t,e){s.isObject(t)||(e=!!t),e?this.getDetailsView().then(s.bind(function(t){this.toggleLoader(!1),this.get("showImmediately")?(t.showImmediately(),this.set("showImmediately",!1)):t.show()},this)):this.getDetailsView().then(function(t){t.hide()})},onClickItem:function(t){t.preventDefault(),this.toggle("open")},onClickBlogLink:function(t){t.metaKey||this.toggleLoader(!0),t.stopPropagation()},isLoaded:function(){return this.model.has("follower_count")},loadDetails:function(){return this.model.fetch_analytics_data()},getDetailsView:function(){return n.promise(s.bind(function(t,e){return this.subviews.details?void t(this.subviews.details):void(this.isLoaded()?t(this.renderDetailsView()):this.loadDetails().then(s.bind(function(){t(this.renderDetailsView())},this))["catch"](function(t){e(t)}))},this))},renderDetailsView:function(){return this.subviews.details?this.subviews.details:(this.subviews.details=new h({model:this.model}),this.renderSubviews(),this.subviews.details)},teardown:function(){return this.remove(),this}});e.exports=c},{"../templates/account-popover-blog-sub-nav.tpl":5,"./account-popover-blog-sub-nav-details":7,"app/lib/avatar-size":429,"components/loader":464,lodash:"MicNly","prima/views/base":581,when:"RG2dij"}],9:[function(t,e,i){"use strict";var s=t("jquery"),n=t("lodash"),o=t("numeral"),a=t("app/lib/scrollbar"),r=t("prima/views/base"),l=t("../templates/account-popover.tpl"),h=t("prima/events"),c=t("prima/utils/bindendevent").transition,u=t("prima/lib/clickoutside"),d=t("prima/lib/translate"),p=t("prima/mixins/popoverbase"),m=t("prima/mixins/selectorcache"),g=t("app/components/dialog"),f=t("./account-popover-blog-sub-nav"),_=r.extend({className:"popover--account-popover",mixins:[p,m],template:l,defaults:{popoverData:{},preventInteraction:!0,order:[]},events:{"click [data-js-action-logout]":"logout"},initialize:function(t){this.options=n.extend({},this.defaults,t),this.listenTo(this.model,"change:liked_post_count",this.onLikeCountChange),this.listenTo(this.model,"change:friend_count",this.onFollowingCountChange)},logout:function(t){t.preventDefault();var e=s(t.currentTarget),i=e.attr("href"),o={text:d("Are you sure you want to log out?"),animate_in:{dialog_class:"fade-in-up log-out-dialog"}};return this.hide(),g.confirm(o,n.bind(function(){window.location.href=i})),!1},numberFormat:function(t){return o(t).format("0,0")},render:function(){return this.$el.html(this.template({model:this.model.toJSON(),numberFormat:this.numberFormat})),this.$pinned.addClass("active"),this.renderUserChannels(),this.makeChannelsSortable(),this.$main=this.$el.find(".popover"),n.delay(n.bind(function(){this.$main.addClass("popover--active"),this.updateScrollbar(),this.bindClickOutside()},this),1),this.bindKeyNavigation(),this},updateScrollbar:function(){this.channelScrollBar&&this.channelScrollBar.update()},afterRender:function(){},bindClickOutside:function(){this.clickOutside=new u(this.el,{preventInteraction:!0}),this.clickOutside.on("click:outside",this.hide,this),this.listenTo(h,"DOMEventor:keyup:escape",this.hide)},unbindClickOutside:function(){this.clickOutside.remove(),this.clickOutside=null,this.stopListening(h,"DOMEventor:keyup:escape")},renderUserChannels:function(){var t=document.createDocumentFragment(),e=this.model.channels.models;if(e.length){var i=this.model.channels.findWhere({is_current:!0});i&&(n.pull(e,i),e.unshift(i)),n.each(e,n.bind(function(e){t.appendChild(this.renderUserChannelItem(e).el)},this)),this.firstItem=this.subViews[e[0].get("name")],this.firstItem.set({showImmediately:!0,uncloseable:!0,open:!0}),this.js$("channel-list").append(t),this.model.channels.length>1&&(n.defer(n.bind(this.addChannelScrollbar,this)),n.defer(n.bind(this.setOrder,this)))}},addChannelScrollbar:function(){this.channelScrollBar=new a(this.js$("channel-list")),this.js$("channel-list").addClass("popover_sublist popover_sublist--scrollable")},renderUserChannelItem:function(t){return this.subViews[t.get("name")]=new f({model:t}),this.listenTo(this.subViews[t.get("name")],"all",this._onSubviewEvent,this),this.subViews[t.get("name")].render()},_onSubviewEvent:function(){var t=n.toArray(arguments);t[0]="subview:"+t[0],this.trigger.apply(this,t)},_removeSubviewReference:function(t){t.off("all",this._onSubviewEvent,this)},makeChannelsSortable:function(){this.model.channels.length>1&&window.Tumblr.SortableView&&(this.sortable=new window.Tumblr.SortableView({el:this.js$("channel-list"),items:".popover_menu_item",callback:n.bind(this.saveOrder,this),scrollable:!0}))},getOrder:function(){return n.map(this.sortable.sequence(),function(t){return t.replace("blog-list-item--","")})},setOrder:function(t){t||(t=this.getOrder()),this.set("order",t)},saveOrder:function(){if(this.model.channels.length<=1)return!1;var t=this.getOrder();n.isEqual(t,this.get("order"))||(this.setOrder(t),s.ajax({type:"POST",url:"/order",data:"channel_names="+JSON.stringify(t)}),this.firstItem.set({uncloseable:!1}))},hide:function(){this.$pinned.removeClass("active"),this.$main.removeClass("popover--active"),this.unbindClickOutside(),this.unbindKeyNavigation(),this.resetKeyboardSelection(),c(this.$el,n.bind(function(){this.afterHide()},this))},afterHide:function(){this.$el.css({display:"none"})},show:function(){this.bindKeyNavigation(),this.bindClickOutside(),this.$pinned.addClass("active"),this.$el.css({display:"block"}),n.delay(n.bind(function(){this.updateScrollbar(),this.$main.addClass("popover--active")},this),1)},bindKeyNavigation:function(){this.listenTo(h,"DOMEventor:keydown:up",this.highlightPreviousItem),this.listenTo(h,"DOMEventor:keydown:down",this.highlightNextItem),this.listenTo(h,"DOMEventor:keydown:left",this.collapseItem),this.listenTo(h,"DOMEventor:keydown:right",this.expandItem),this.listenTo(h,"DOMEventor:keydown:enter",this.openItemLink)},unbindKeyNavigation:function(){this.stopListening(h,"DOMEventor:keydown:up"),this.stopListening(h,"DOMEventor:keydown:down"),this.stopListening(h,"DOMEventor:keydown:left"),this.stopListening(h,"DOMEventor:keydown:right"),this.stopListening(h,"DOMEventor:keydown:enter")},highlightNextItem:function(t){t.preventDefault();var e=this.$el.find("[data-js-menu-item]:visible"),i=this.$el.find(".currentItem"),s=i.length>0?n.findIndex(e,i.get(0))+1:0;s===e.length&&(s=0);var o=e.get(s);this.highlightItem(o)},highlightPreviousItem:function(t){t.preventDefault();var e=this.$el.find("[data-js-menu-item]:visible"),i=n.findIndex(e,this.$el.find(".currentItem").get(0))-1;-1===i&&(i=e.length-1);var s=e.get(i);this.highlightItem(s)},highlightItem:function(t){this.resetKeyboardSelection();var e=s(t);e.addClass("currentItem"),this.scrollToItem(e)},scrollToItem:function(t){var e=this.js$("channel-list");if(t.closest(e).length){var i=t.closest(".popover_menu_item_blog--open");i.length>0&&(t=i);var s=e.offset().top,n=s+e.height(),o=t.offset().top,a=o+t.height(),r=0;o>=s&&n>=a||(r=s>o?o-s:a-n,e.animate({scrollTop:e.scrollTop()+r},100))}},resetKeyboardSelection:function(){this.$el.find(".currentItem").removeClass("currentItem")},expandItem:function(t){t.preventDefault(),this.$el.find(".currentItem.popover_menu_item_blog:not(.popover_menu_item_blog--open) [data-js-action-details-open]").trigger("click")},collapseItem:function(t){t.preventDefault();var e=this.$el.find(".currentItem.popover_menu_item_blog--open");if(e.length||(e=this.$el.find("[data-js-menu-item]:has(.currentItem)")),e.length>0){var i=e.find("[data-js-action-details-open]:visible");i.length>0&&(i.trigger("click"),this.highlightItem(e.get(0)))}},openItemLink:function(t){t.preventDefault();var e=this.$el.find(".currentItem [data-js-menu-item-link]:first");e.length>0&&e.get(0).click()},beforeTeardown:function(){return n.each(this.subViews,function(t){this._removeSubviewReference(t)},this),this.channelScrollBar&&this.channelScrollBar.destroy(),this.remove(),this.$pinned.removeClass("active"),this},onFollowingCountChange:function(){var t=this.model.get("friend_count");this.js$("following-count").text(0!==t?this.numberFormat(t):"")},onLikeCountChange:function(){var t=this.model.get("liked_post_count");this.js$("like-count").text(0!==t?this.numberFormat(t):"")}});e.exports=_},{"../templates/account-popover.tpl":6,"./account-popover-blog-sub-nav":8,"app/components/dialog":44,"app/lib/scrollbar":433,jquery:"HlZQrA",lodash:"MicNly",numeral:"ubjloo","prima/events":512,"prima/lib/clickoutside":513,"prima/lib/translate":541,"prima/mixins/popoverbase":550,"prima/mixins/selectorcache":553,"prima/utils/bindendevent":560,"prima/views/base":581}],10:[function(t,e,i){"use strict";var s=t("jquery"),n=t("lodash"),o=t("prima/component"),a=t("prima/events"),r=t("prima/utils/bindendevent").transition,l=t("./views/account-tour-guide"),h=o.extend({name:"AccountTourGuide",initialize:function(){this.$glass=null,this.$container=s(this.container),this.$body=s("body"),this.$tabBar=s(".tab-bar"),this.listenTo(this.view,"clickCloseButton",this.close)},onClickGlass:function(){this.triggerEvent("clickClose"),this.close()},onClickEsc:function(){this.triggerEvent("clickClose"),this.close()},view:function(){return new l({pinnedTarget:this.container,isFixedPosition:!0})},showGlass:function(){this.$glass=s("<div>",{"class":"glass--account-tour-guide"}).appendTo(this.$body);var t=n.bind(function(){this.$glass.addClass("active")},this);n.delay(t,150),this.$glass.on("click",n.bind(this.onClickGlass,this))},hideGlass:function(){this.$glass.removeClass("active"),this.$glass.remove(),this.$glass=null},close:function(){this.view&&(this.view.teardown(),this.hideGlass(),a.trigger("keycommands:resume"),a.trigger("drawer:resume"),a.trigger("toaster:resume"),this.stopListening(a,"DOMEventor:flatresize"),this.stopListening(a,"DOMEventor:keyup:escape"),this.trigger("close"))},open:function(){this.showGlass(),r(this.$glass,n.bind(function(){this.append()},this)),a.trigger("keycommands:suspend"),a.trigger("drawer:suspend"),a.trigger("toaster:suspend"),this.listenTo(a,"DOMEventor:keyup:escape",this.onClickEsc),this.triggerEvent("seen"),s.ajax({url:"/svc/post/set_seen_atg",type:"POST",with_form_key:!0})},append:function(){return this.view.render(),this.clonedTabNavAccountItem=this.$tabBar.find(".tab_nav_account").clone(),this.clonedTabNavActivityItem=this.$tabBar.find(".tab_activity").clone(),this.view.$tabBar.append([this.clonedTabNavAccountItem,this.clonedTabNavActivityItem]),this.listenTo(a,"DOMEventor:flatresize",this.positionClonedTabNavAccountItem),this.trigger("append"),this},triggerEvent:function(t){this.trigger(t),a.trigger("TourGuideAccount:"+t,{loggingData:t})}});e.exports=h},{"./views/account-tour-guide":12,jquery:"HlZQrA",lodash:"MicNly","prima/component":511,"prima/events":512,"prima/utils/bindendevent":560}],11:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __t,__p="";Array.prototype.join;with(obj||{})__p+='<div class="popover popover_gradient"><div class="popover_inner"><div class="step current"><h3 class="title">'+(null==(__t=__("Don't freak out. Your things are right here."))?"":_.escape(__t))+'</h3><p class="content">'+(null==(__t=__("Your blog info, account info, and recent activity are in these menus."))?"":_.escape(__t))+'</p><button class="button-continue flat-button" type="button" data-js-next-step>'+(null==(__t=__("Wait, why?"))?"":_.escape(__t))+'</button> <button class="button-close blue flat-button" type="button" data-js-close>'+(null==(__t=__("Okay, phew"))?"":_.escape(__t))+'</button></div><div class="step"><h3 class="title">'+(null==(__t=__("Why?"))?"":_.escape(__t))+'</h3><p class="content">'+(null==(__t=__("It's so you never have to scroll to the top of the dashboard to access this stuff."))?"":_.escape(__t))+'</p><button class="button-close blue flat-button full-width" type="button" data-js-close>'+(null==(__t=__("Ohhh"))?"":_.escape(__t))+'</button></div></div></div><div class="tab_bar"></div>';return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],12:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/view"),o=t("../templates/account-tour-guide.tpl"),a=t("prima/events"),r=t("prima/mixins/popoverbase"),l=n.extend({className:"popover--account-tour-guide",mixins:[r],template:o,defaults:{},events:{"click [data-js-next-step]":"onClickNexStep","click [data-js-close]":"onClickClose"},initialize:function(t){this.options=s.extend({},this.defaults,t)},render:function(){return this.duration=300,this.$el.html(this.template()),this.$wrapper=this.$el.find(".popover_inner"),this.$tabBar=this.$el.find(".tab_bar"),this},onClickNexStep:function(){var t=this.$el.find(".step:nth-child(1)"),e=this.$el.find(".step:nth-child(2)"),i=this.duration,s=e.height();t.fadeOut(i),this.$wrapper.animate({height:s},i,"swing",function(){e.fadeIn(i)}),this.triggerEvent("clickNextButton")},onClickClose:function(){this.$el.find(".popover_inner").animate({height:0,opacity:0},this.duration,s.bind(function(){this.teardown()},this)),this.triggerEvent("clickCloseButton")},beforeTeardown:function(){return this.remove(),this},triggerEvent:function(t){this.trigger(t),a.trigger("TourGuideAccount:"+t,{loggingData:t})}});e.exports=l},{"../templates/account-tour-guide.tpl":11,lodash:"MicNly","prima/events":512,"prima/mixins/popoverbase":550,"prima/view":580}],13:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/component"),o=t("./views/activity-popover"),a=t("app/lib/currentuser"),r=n.extend({name:"ActivityPopover",view:function(t){return t=s.extend({},{model:a(),pinnedTarget:this.container,isFixedPosition:!0,autoTeardown:!1,teardownOnEscape:!1},t),new o(t)},show:function(){this.view.show()},render:function(){return this.view.render(),this.trigger("append"),this}});e.exports=r},{"./views/activity-popover":24,"app/lib/currentuser":432,lodash:"MicNly","prima/component":511}],14:[function(t,e,i){var s=t("prima/model"),n=s.extend({});e.exports=n},{"prima/model":557}],15:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __t,__p="";Array.prototype.join;with(obj||{})__p+='<div class="date_header clearfix"><div class="part_relative_date">'+(null==(__t=model.relativeDate)?"":__t)+'</div><div class="part_full_date">'+(null==(__t=model.dateHeader.format("dddd, MMMM D"))?"":__t)+"</div></div>";return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],16:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __t,__p="";Array.prototype.join;with(obj||{})__p+='<div class="ui_note '+(null==(__t=model.type)?"":__t)+" "+(null==(__t=model.from_tumblelog&&model.from_tumblelog.is_friend?" is_friend":"")?"":__t)+'" data-timestamp="'+(null==(__t=model.timestamp)?"":__t)+'" data-tumblelog-name="'+(null==(__t=model.from_tumblelog?model.from_tumblelog.name:"")?"":__t)+'"><div class="stage"><div class="part_activity"><div class="part_main"><span class="activity">'+(null==(__t=model.message)?"":__t),model.post&&model.post.summary&&(__p+='<span class="summary">&#8220;'+(null==(__t=model.post.summary)?"":_.escape(__t))+"&#8221;</span>"),__p+='</span></div></div><a class="part_glass" target="_blank" href="'+(null==(__t=model.clickthrough_url)?"":__t)+'"></a><div class="part_avatar">',__p+=model.from_tumblelog?'<div class="ui_avatar"><div data-avatar-url="'+(null==(__t=model.from_tumblelog.avatar_url_128)?"":__t)+'" target="_blank" class="ui_avatar_link frame '+(null==(__t=model.type)?"":__t)+'" title="'+(null==(__t=model.from_tumblelog.name)?"":__t)+'"><a href="'+(null==(__t=model.from_tumblelog.tumblr_url)?"":__t)+'" class="avatar" style="background-image: url(\''+(null==(__t=model.from_tumblelog.avatar_url_48)?"":__t)+'\')"><div class="inner_frame"></div><div class="avatar_glass"></div><span class="ui_avatar_tumblelog_name">'+(null==(__t=model.from_tumblelog.name)?"":__t)+"</span></a></div></div>":'<div class="ui_avatar"><div data-avatar-url="/images/anonymous_avatar_64.gif" target="_blank" class="ui_avatar_link frame '+(null==(__t=model.type)?"":__t)+'" title="Anonymous"><div class="avatar" style="background-image: url(\'/images/anonymous_avatar_64.gif\')"><div class="inner_frame"></div><div class="avatar_glass"></div><span class="ui_avatar_tumblelog_name"></span></div></div></div>',__p+='</div><div class="part_icon">',!model.from_tumblelog||model.from_tumblelog.is_friend||"follower"!==model.type&&"user_mention"!==model.type?model.post&&(__p+=' <a href="'+(null==(__t=model.post.url)?"":__t)+'" target="_blank" class="ui_post_badge '+(null==(__t=model.post.type)?"":__t)+'"><div class="inner_frame"></div></a>'):__p+='<a class="note_follow plus-follow-button blue" href="/follow/'+(null==(__t=model.from_tumblelog.name)?"":__t)+'" data-tumblelog-name="'+(null==(__t=model.from_tumblelog.name)?"":__t)+'" title="'+(null==(__t=__("Follow"))?"":__t)+'"><span class="icon_plus follow_icon"></span></a>',__p+="</div>",model.note_meta&&(model.note_meta.answer_text||model.note_meta.reply_text)?__p+='<div class="part_response '+(null==(__t=model.note_meta.answer_text?"is_part_answer":"")?"":__t)+" "+(null==(__t=model.note_meta.reply_text?"is_part_reply":"")?"":__t)+'"><blockquote>'+(null==(__t=model.note_meta.answer_text?model.note_meta.answer_text:"")?"":__t)+(null==(__t=model.note_meta.reply_text?model.note_meta.reply_text:"")?"":__t)+"</blockquote></div>":"reblog"===model.type&&model.new_post&&model.new_post.diff?__p+='<div class="part_response is_part_reblog"><blockquote>'+(null==(__t=model.new_post.diff)?"":__t)+"</blockquote></div>":"user_mention"==model.type&&model.new_post&&model.new_post.quote&&(__p+='<div class="part_response is_part_user_mention"><blockquote>'+(null==(__t=model.new_post.quote)?"":__t)+"</blockquote></div>"),__p+="</div></div>";return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],17:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __t,__p="";Array.prototype.join;with(obj||{})__p+="",__p+=model.activity_notifications.length>1?'<div class="blog-activity-content"><ul data-js-blog-activity-notification-list class="ui_notes"></ul></div><a href="/blog/'+(null==(__t=model.name)?"":_.escape(__t))+'/activity" class="blog-activity-more">'+(null==(__t=__("See everything"))?"":_.escape(__t))+"</a>":'<div class="blog-activity--empty"><i class="icon_activity"></i><p class="blog-activity--empty-text">'+(null==(__t=__("Check out this tab when you make a post to see Likes, Reblogs, and new followers."))?"":_.escape(__t))+"</p></div>",
__p+="";return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],18:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __t,__p="";Array.prototype.join;with(obj||{})__p+='<a class="activity-popover-sparkline-link" href="'+(null==(__t=activityPageUrl)?"":__t)+'" title="Activity"><div class="sparkline"></div></a>';return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],19:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __t,__p="";Array.prototype.join;with(obj||{})__p+='<div class="popover popover_menu popover_gradient"><div class="popover_inner"><div class="activity-popover-header">'+(null==(__t=_subview("tumblelogSelect"))?"":__t)+(null==(__t=_subview("sparkline"))?"":__t)+(null==(__t=_subview("loader"))?"":__t)+'</div><div class="activity-popover-notifications">'+(null==(__t=_subview("activityNotifications"))?"":__t)+"</div></div></div>";return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],20:[function(t,e,i){"use strict";var s=t("prima/views/base"),n=t("../templates/activity-popover-date.tpl"),o=t("moment"),a=t("prima/lib/translate"),r=s.extend({tagName:"li",className:"blog-activity-date",template:n,events:{},defaults:{},beforeRender:function(){var t=o();this.model.set("relativeDate",this.getRelativeDate(t))},getRelativeDate:function(t){var e=t.diff(this.model.attributes.dateHeader),i=o.duration(e).asHours(),s=Math.floor(i/24);return 0>=s?a("Today"):1>=s?a("Yesterday"):a("%d days ago",s)},teardown:function(){return this.remove(),this}});e.exports=r},{"../templates/activity-popover-date.tpl":15,moment:"iROhDJ","prima/lib/translate":541,"prima/views/base":581}],21:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/views/base"),o=t("../templates/activity-popover-notification-item.tpl"),a=t("app/models/tumblelog"),r=t("prima/utils/bindendevent").animation,l=n.extend({tagName:"li",className:"blog-activity-notification",template:o,events:{"click .plus-follow-button":"onClickFollow"},defaults:{tumblelogToFollow:!1,followSource:"FOLLOW_SOURCE_ACTIVITY_POPOVER"},initialize:function(t){if(this.options=s.defaults(t,this.defaults),!this.model.get("is_friend")&&!this.get("tumblelogToFollow")){var e=this.model.get("from_tumblelog");e&&(this.set("tumblelogToFollow",new a({name:e.name})),this.listenTo(this.get("tumblelogToFollow"),"change:following",this.onFollow))}},beforeRender:function(){var t="";this.model.get("new_post")&&this.model.get("new_post").url?t=this.model.get("new_post").url:this.model.get("post")&&this.model.get("post").url?t=this.model.get("post").url:this.model.get("from_tumblelog")&&this.model.get("from_tumblelog").tumblr_url&&(t=this.model.get("from_tumblelog").tumblr_url),this.model.set("clickthrough_url",t)},afterRender:function(){this.$tumblelogLink=this.$(".notification-tumblelog-link"),this.$followButton=this.$(".plus-follow-button"),this.$ui_post_badge=this.$(".ui_post_badge");var t=this.model.get("post"),e={},i="",s=t?t.type:"regular";switch(s){case"photo":case"photoset":e.backgroundImage="url('"+t.media_url+"')";break;case"video":t.video_thumbnail_url&&(e.backgroundImage="url('"+t.video_thumbnail_url+"')",i="has_video_thumbnail");break;case"note":t.is_ask?i="ask":t.is_answer&&(i="ask_answer");break;case"postcard":i="fanmail"}this.$tumblelogLink&&this.$tumblelogLink.addClass("js-hover-trigger-TumblelogPopover"),this.$ui_post_badge.css(e).addClass(i)},onClickFollow:function(t){t.preventDefault(),this.$followButton.closest(".ui_note").addClass("is_friend"),this.get("tumblelogToFollow").follow({tumblelog:this.get("tumblelogToFollow").name})},onFollow:function(t,e){r(this.$followButton,s.bind(function(){this.hideFollowButton()},this)),this.$followButton.toggleClass("follow_poof",e)},hideFollowButton:function(){this.$followButton.css({display:"none"})},teardown:function(){return this.remove(),this}});e.exports=l},{"../templates/activity-popover-notification-item.tpl":16,"app/models/tumblelog":436,lodash:"MicNly","prima/utils/bindendevent":560,"prima/views/base":581}],22:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/views/base"),o=t("../templates/activity-popover-notifications.tpl"),a=t("prima/mixins/selectorcache"),r=t("app/lib/scrollbar"),l=t("./activity-popover-notification-item"),h=t("./activity-popover-date"),c=t("../models/activity-notification"),u=t("moment"),d=n.extend({className:"blog-activity",template:o,mixins:[a],defaults:{removable:!0},initialize:function(){},addChannelScrollbar:function(){this.notificationScrollBar=new r(this.js$("blog-activity-notification-list"))},afterRender:function(){this.model.get("activity_notifications").length>1&&(s.defer(s.bind(this.addChannelScrollbar,this)),this.js$("blog-activity-notification-list").addClass("popover_sublist popover_sublist--scrollable"),this.createSubviews())},beforeTeardown:function(){this.notificationScrollBar&&this.notificationScrollBar.destroy()},createSubviews:function(){for(var t,e=this.model.get("activity_notifications"),i=0;i<e.length;i++){var s=!1,n=u.unix(e[i].timestamp).startOf("day");if(t&&n.fromNow()===t.fromNow()||(s=n),s){e[i].dateHeader=s;var o=new h({model:new c(e[i])});this.appendSubview(o,"ul[data-js-blog-activity-notification-list]")}var a=new l({model:new c(e[i])});this.appendSubview(a,"ul[data-js-blog-activity-notification-list]"),t=u.unix(e[i].timestamp).startOf("day")}},teardown:function(){return this.remove(),this}});e.exports=d},{"../models/activity-notification":14,"../templates/activity-popover-notifications.tpl":17,"./activity-popover-date":20,"./activity-popover-notification-item":21,"app/lib/scrollbar":433,lodash:"MicNly",moment:"iROhDJ","prima/mixins/selectorcache":553,"prima/views/base":581}],23:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/views/base"),o=t("../templates/activity-popover-sparkline.tpl"),a=n.extend({template:o,className:"activity-popover-sparkline-container",defaults:{removable:!0,sparklineFormatting:{type:"line",lineColor:"#7f7f7f",fillColor:!1,lineWidth:4,spotColor:!1,minSpotColor:!1,maxSpotColor:!1,disableInteraction:!0,width:"72px",height:"30px"}},getTemplateData:function(){return{activityPageUrl:"/blog/"+this.model.get("name")+"/activity"}},addSparkline:function(){var t=this.$el.find(".sparkline"),e=JSON.parse(this.model.get("activity_data").sparkline);e&&0!==s.max(e)&&s.isFunction(t.sparkline)&&(t.sparkline(e,this.get("sparklineFormatting")),t.find("canvas").css({height:"15px",width:"36px"}))},afterRender:function(){s.defer(s.bind(this.addSparkline,this))},teardown:function(){return this.remove(),this}});e.exports=a},{"../templates/activity-popover-sparkline.tpl":18,lodash:"MicNly","prima/views/base":581}],24:[function(t,e,i){"use strict";var s=t("lodash"),n=t("jquery"),o=t("prima/views/base"),a=t("../templates/activity-popover.tpl"),r=t("prima/events"),l=t("prima/utils/url"),h=t("prima/mixins/popoverbase"),c=t("prima/lib/clickoutside"),u=t("prima/utils/bindendevent").transition,d=t("when"),p=t("app/components/blog-selector"),m=t("./activity-popover-sparkline"),g=t("./activity-popover-notifications"),f=t("components/loader"),_=o.extend({defaults:{popoverData:{},preventInteraction:!0,currentTumblelog:!1},className:"popover--activity-popover",mixins:[h],template:a,initialize:function(t){if(this.options=s.extend({},this.defaults,t),!this.get("currentTumblelog")){var e=this.model.channels.findWhere({is_current:!0});this.set("currentTumblelog",e)}},render:function(){return this.$el.html(this.template()),this.$pinned.addClass("active"),this.$activityNotifications=this.$(".activity-popover-notifications"),this.$activityHeader=this.$(".activity-popover-header"),this.$activityPopoverMenu=this.$(".popover_menu"),s.delay(s.bind(function(){this.$activityPopoverMenu.addClass("popover--active"),this.bindClickOutside(),this.addTumblelogPopoverZIndex()},this),1),this.subviews.tumblelogSelect=new p({className:"activity-popover-tumblelog-select-container",collection:this.model.channels,dropdownClass:"popover--activity-popover-tumblelog-select-dropdown",popoverOptions:{popoverContainer:".popover--activity-popover"}}),this.prepareActivityNotifications(),this.listenTo(this.subviews.tumblelogSelect,"change:currentTumblelog",this.updateSubviews),this},addTumblelogPopoverZIndex:function(){this.$el.attr("data-tumblelog-popover-zindex",this.$el.css("z-index"))},bindClickOutside:function(){var t={preventInteraction:!0,ignoreSelectors:[".popover_content_wrapper"]};this.clickOutside=new c(this.el,t),this.clickOutside.on("click:outside",this.hide,this),this.clickOutside.on("click:inside",this.hideActivityPopover,this),this.listenTo(r,"DOMEventor:keyup:escape",this.hide)},unbindClickOutside:function(){this.clickOutside.remove(),this.clickOutside=null,this.stopListening(r,"DOMEventor:keyup:escape")},createSubviews:function(){this.removeSubviews(),this.toggleLoader(!1),this.subviews.sparkline=new m({model:this.get("currentTumblelog")}),this.subviews.activityNotifications=new g({model:this.get("currentTumblelog")}),this.rendered&&(this.appendSubview(this.subviews.sparkline,this.$activityHeader),this.appendSubview(this.subviews.activityNotifications,this.$activityNotifications))},hasNecessaryData:function(){return this.get("currentTumblelog").has("activity_notifications")},loadData:function(){return this.get("currentTumblelog").fetch_activity_notifications()},prepareActivityNotifications:function(){return d.promise(s.bind(function(t,e){this.hasNecessaryData()?t(this.createSubviews()):(this.toggleLoader(!0),this.loadData().then(s.bind(function(){t(this.createSubviews())},this))["catch"](function(t){e(t)}))},this))},updateSubviews:function(t,e){this.set("currentTumblelog",e),this.prepareActivityNotifications()},removeSubviews:function(){this.subviews&&s.each(this.subviews,function(t){t.get("removable")&&t.remove()})},toggleLoader:function(t){t===!0?this.loader?this.loader.set("loading",!0):this.loader=new f({$container:this.$el,type:"bar",classModifiers:"bottom",loading:!0}):this.loader&&this.loader.set("loading",!1)},beforeTeardown:function(){return this.remove(),this.$pinned.removeClass("active"),this},hideActivityPopover:function(t){var e=n(t.target),i=e.closest(".tumblelog_popover"),o=e.closest("[href]");s.isEmpty(i)||s.isEmpty(o)||!l.isTumblelogUrl(o.attr("href"))||this.hide()},hide:function(){this.unbindClickOutside(),this.$pinned.removeClass("active"),this.$activityPopoverMenu.removeClass("popover--active"),u(this.$el,s.bind(function(){this.afterHide()},this))},afterHide:function(){this.$el.css({display:"none"})},show:function(){this.bindClickOutside(),this.$pinned.addClass("active"),this.$el.css({display:"block"}),s.delay(s.bind(function(){this.$activityPopoverMenu.addClass("popover--active")},this),1)}});e.exports=_},{"../templates/activity-popover.tpl":19,"./activity-popover-notifications":22,"./activity-popover-sparkline":23,"app/components/blog-selector":37,"components/loader":464,jquery:"HlZQrA",lodash:"MicNly","prima/events":512,"prima/lib/clickoutside":513,"prima/mixins/popoverbase":550,"prima/utils/bindendevent":560,"prima/utils/url":579,"prima/views/base":581,when:"RG2dij"}],25:[function(t,e,i){"use strict";var s=t("jquery"),n=t("lodash"),o=t("prima/component"),a=t("prima/lib/translate"),r=t("app/lib/avatar-size"),l=t("prima/events"),h=t("../post-form-builder/views/glass"),c=t("../post-form-builder/views/modal"),u=t("./views/ask-form"),d=t("./models/question"),p=o.extend({name:"AskComponent",initialize:function(t){t=t||{},this.user=t.user,this.user&&(this.blog=this.user.getChannel(),this.question=new d({recipient:null,anonymous:!1,question:""}),this.listenTo(l,"ask:form:open",this.presentAskForm),this.listenTo(this.question,"save:success",this.onSaveSuccess))},presentAskForm:function(t){return this.askFormView?this:(this.question.set("recipient",t.recipient),s("body").addClass("postforms-open"),l.trigger("drawer:suspend"),l.trigger("keycommands:suspend"),this.glass=new h,this.modal=new c,this.askFormView=new u({model:this.question,characterLimit:500,recipient:{name:t.recipient,allowAnonymous:t.allow_anonymous},sender:this.blog}),this.askFormView.render(),this.modal.setContentSubView(this.askFormView),this.glass.render().$el.appendTo("body"),this.modal.render().$el.appendTo("body"),this.glass.show().then(n.bind(this.modal.show,this.modal)),this.listenTo(this.askFormView,"close",this.dismissAskForm),this.listenTo(this.askFormView,"submit",this.submit),this)},beforeRemove:function(){this.dismissAskForm()},dismissAskForm:function(){this.askFormView&&(this.stopListening(this.askFormView),this.modal.hide(),this.modal.remove(),this.modal=null,this.glass.hide(),this.glass.remove(),this.glass=null,this.askFormView.remove(),this.askFormView=null,l.trigger("keycommands:resume"),l.trigger("drawer:resume"),l.trigger("ask:form:hidden"),s("body").removeClass("postforms-open"))},submit:function(t){this.question.set("anonymous",!!t.anonymous),this.question.set("question",t.question),this.question.save()},onSaveSuccess:function(){l.trigger("ask:form:success"),this.dismissAskForm(),n.delay(n.bind(this.toastSuccess,this,{recipient:this.question.get("recipient"),avatar:this.question.get("anonymous")?"https://secure.assets.tumblr.com/images/anonymous_avatar_64.gif":r(this.blog.get("avatar_url"))(64)}),350)},toastSuccess:function(t){var e=a("Question sent to %1$s",t.recipient),i={type:"image_text",message:"<strong>"+e+" </strong>",is_link:!1,href:"#",img1:{url:t.avatar,is_link:!1,href:"#"}};l.trigger("toaster:toast",i)}});e.exports=p},{"../post-form-builder/views/glass":228,"../post-form-builder/views/modal":230,"./models/question":26,"./views/ask-form":28,"app/lib/avatar-size":429,jquery:"HlZQrA",lodash:"MicNly","prima/component":511,"prima/events":512,"prima/lib/translate":541}],26:[function(t,e,i){"use strict";var s=t("prima/model"),n=t("lodash"),o=t("prima/lib/translate"),a=s.extend({urlRoot:"/svc/post/ask",validate:function(t){return n.trim(t.question)?this.isUrl(t.question)?{error:o("Sorry, but please don't include links in questions.")}:void 0:{error:o("You need to enter a question!")}},isUrl:function(t){return!!(t.match(/(http|https):\/\//i)||t.match(/www\./i)||t.match(/[a-zA-Z0-9]+(\.arpa|\.root|\.aero|\.biz|\.cat|\.com|\.coop|\.edu|\.gov|\.info|\.int|\.jobs|\.mil|\.mobi|\.museum|\.name|\.net|\.org|\.pro|\.travel|TLD|\.ac|\.ad|\.ae|\.af|\.ag|\.ai|\.al|\.am|\.an|\.ao|\.aq|\.ar|\.as|\.at|\.au|\.aw|\.ax|\.az|\.ba|\.bb|\.bd|\.be|\.bf|\.bg|\.bh|\.bi|\.bj|\.bm|\.bn|\.bo|\.br|\.bs|\.bt|\.bv|\.bw|\.by|\.bz|\.ca|\.cc|\.cd|\.cf|\.cg|\.ch|\.ci|\.ck|\.cl|\.cm|\.cn|\.co|\.cr|\.cu|\.cv|\.cx|\.cy|\.cz|\.de|\.dj|\.dk|\.dm|\.do|\.dz|\.ec|\.ee|\.eg|\.er|\.es|\.et|\.eu|\.fi|\.fj|\.fk|\.fm|\.fo|\.fr|\.ga|\.gb|\.gd|\.ge|\.gf|\.gg|\.gh|\.gi|\.gl|\.gm|\.gn|\.gp|\.gq|\.gr|\.gs|\.gt|\.gu|\.gw|\.gy|\.hk|\.hm|\.hn|\.hr|\.ht|\.hu|\.id|\.ie|\.il|\.im|\.in|\.io|\.iq|\.ir|\.is|\.it|\.je|\.jm|\.jo|\.jp|\.ke|\.kg|\.kh|\.ki|\.km|\.kn|\.kr|\.kw|\.ky|\.kz|\.la|\.lb|\.lc|\.li|\.lk|\.lr|\.ls|\.lt|\.lu|\.lv|\.ly|\.ma|\.mc|\.md|\.mg|\.mh|\.mk|\.ml|\.mm|\.mn|\.mo|\.mp|\.mq|\.mr|\.ms|\.mt|\.mu|\.mv|\.mw|\.mx|\.my|\.mz|\.na|\.nc|\.ne|\.nf|\.ng|\.ni|\.nl|\.no|\.np|\.nr|\.nu|\.nz|\.om|\.pa|\.pe|\.pf|\.pg|\.ph|\.pk|\.pl|\.pm|\.pn|\.pr|\.ps|\.pt|\.pw|\.py|\.qa|\.re|\.ro|\.ru|\.rw|\.sa|\.sb|\.sc|\.sd|\.se|\.sg|\.sh|\.si|\.sj|\.sk|\.sl|\.sm|\.sn|\.so|\.sr|\.st|\.su|\.sv|\.sy|\.sz|\.tc|\.td|\.tf|\.tg|\.th|\.tj|\.tk|\.tl|\.tm|\.tn|\.to|\.tp|\.tr|\.tt|\.tv|\.tw|\.tz|\.ua|\.ug|\.uk|\.um|\.us|\.uy|\.uz|\.va|\.vc|\.ve|\.vg|\.vi|\.vn|\.vu|\.wf|\.ws|\.ye|\.yt|\.yu|\.za|\.zm|\.zw)/i))},save:function(t,e){e=e||{};var i=e.success,o=e.error;e.success=n.bind(function(t,e){if(n.isEmpty(n.result(e.response,"errors")))this.trigger("save:success"),i&&i.call(null,t,e);else{var s=e.response.errors[0];this.trigger("save:error",s),o&&o.call(null,t,s)}this.set("isSaving",!1)},this),e.error=n.bind(function(t,e){this.trigger("save:error",e),o&&o.call(null,t,e)},this),this.set("isSaving",!0);var a=s.prototype.save.call(this,t,e);!a&&this.validationError&&(this.trigger("save:error",this.validationError.error),this.set("isSaving",!1))}});e.exports=a},{lodash:"MicNly","prima/lib/translate":541,"prima/model":557}],27:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __t,__p="";Array.prototype.join;with(obj||{}){__p+='<div class="post_form_wrapper v_center_el"><div class="post_avatar"><a class="post_avatar_link use_blog_avatar animating" data-user-avatar-url="'+(null==(__t=sender.avatar_url)?"":_.escape(__t))+'" data-avatar-url="'+(null==(__t=sender.avatar_url)?"":_.escape(__t))+'" data-blog-url="'+(null==(__t=sender.blog_url)?"":_.escape(__t))+'"><span class="post_avatar_link blog_avatar anonymous" data-anonymous-avatar-url="/images/anonymous_avatar_64.gif" style="background-image: url(/images/anonymous_avatar_64.gif)"></span> <span class="post_avatar_link blog_avatar new" style="background-image: url('+(null==(__t=sender.avatar_url)?"":_.escape(__t))+')"></span></a></div><div class="post-container"><form enctype="multipart/form-data" class="active"><div class="post-container-inner post post-form--asks"><div class="post-form--header"><div class="controls-container">';var senderMarkup='<span class="ask-from"><span class="tumblelog_name">'+sender.name+'</span><span class="anonymous">'+__("anonymous")+"</span></span>",recipientMarkup='<span class="ask-recipient-label">'+recipient.name+"</span>";if(__p+=""+(null==(__t=__('%1$s <span class="ask-to-label">to</span> %2$s',senderMarkup,recipientMarkup))?"":__t)+'<span class="ask-character-count"></span></div></div><div class="post-form--form post-content-text"><textarea class="ask-question" name="question" placeholder="'+(null==(__t=__("Ask me anything"))?"":_.escape(__t))+'" maxlength="'+(null==(__t=character_limit)?"":_.escape(__t))+'" autofocus></textarea></div><div class="post-form--bottom"><div class="post-form--controls"><div class="controls-container"><div class="control left"><button type="button" class="chrome flat close">'+(null==(__t=__("Close"))?"":_.escape(__t))+"</button></div>",recipient.allow_anonymous){__p+='<div class="control right"><div class="ask-anonymously">';var randId=Math.floor(1e6*Math.random());__p+='<label class="binary_switch"><input id="ask_anonymously_switch_'+(null==(__t=randId)?"":_.escape(__t))+'" class="ask-anonymously-switch" type="checkbox" name="anonymous" value="1"> <span class="binary_switch_track"></span> <span class="binary_switch_button"></span></label><label class="ask-anonymously-label" for="ask_anonymously_switch_'+(null==(__t=randId)?"":_.escape(__t))+'">'+(null==(__t=__("Ask anonymously"))?"":_.escape(__t))+"</label></div></div>"}__p+='<div class="control right"><button class="chrome blue ask-button" type="submit" disabled="disabled">'+(null==(__t=__("Ask"))?"":_.escape(__t))+'</button></div></div></div><ul class="post-form--error-bar messages errors-ask"></ul></div></div></form></div></div>'}return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],28:[function(t,e,i){"use strict";var s=t("jquery"),n=t("lodash"),o=t("app/lib/avatar-size"),a=t("prima/views/base"),r=t("prima/mixins/keycommands"),l=t("prima/mixins/selectorcache"),h=t("../templates/ask-form.tpl"),c=a.extend({className:"ask-form",template:h,mixins:[r,l],keycommands:{"keydown:enter":"preventNewlines","keydown:escape":"dismiss"},events:{"click button.close":"dismiss","change .ask-anonymously-switch":"toggleAnonymous","submit form":"submit","input .ask-question":"onTextAreaUpdate"},initialize:function(t){this.characterLimit=t.characterLimit,this.sender=t.sender,this.recipient=t.recipient,this.onTextAreaUpdate=n.throttle(n.bind(this.onTextAreaUpdate,this),100),this.listenTo(this.model,"change:isSaving",this.toggleSubmit),this.listenTo(this.model,"save:success",this.render),this.listenTo(this.model,"save:error",this.displayErrors)},getTemplateData:function(){var t={};return t.recipient=n.clone(this.recipient)||{},t.recipient.allow_anonymous=t.recipient.allowAnonymous,t.sender=this.sender.toJSON(),t.sender.avatar_url=o(this.sender.get("avatar_url"))(128),t.character_limit=this.characterLimit,t},dismiss:function(){this.trigger("close")},toggleSubmit:function(t,e){e?this.disableSubmit():this.enableSubmit()},toggleAnonymous:function(t){var e=this.$(t.target);this.isAnonymous=e.prop("checked");var i=this.$$(".post_avatar_link"),s=this.$$(".ask-from .tumblelog_name"),n=this.$$(".ask-from .anonymous");this.isAnonymous?(i.removeClass("use_blog_avatar"),s.hide(),n.show()):(i.addClass("use_blog_avatar"),s.show(),n.hide())},submit:function(t){t.preventDefault(),this.trigger("submit",{question:this.$$(".ask-question").val(),anonymous:this.isAnonymous})},preventNewlines:function(t){t.preventDefault()},onTextAreaUpdate:function(){var t=this.$$(".ask-question").val(),e=t;t.match(/\n/g)&&(t=t.replace(/\n/g,""));var i=n.trim(t).length;i>0&&i<=this.characterLimit?this.enableSubmit():this.disableSubmit(),t!==e&&this.$$(".ask-question").val(t);var s=this.characterLimit-t.length,o=this.$$(".ask-character-count");o.text(s),100>=s?(o.addClass("active"),o.removeClass("count-ok count-warning count-danger"),s>40?o.addClass("count-ok"):s>20?o.addClass("count-warning"):o.addClass("count-danger")):o.removeClass("active")},enableSubmit:function(){this.model.get("isSaving")||this.$$(".ask-button").prop("disabled",!1)},disableSubmit:function(){this.$$(".ask-button").prop("disabled",!0)},showMessages:function(t,e){var i=this.$$("."+t),o=i.get(0);o&&(i.removeClass("active").hide().empty(),"string"==typeof e&&(e=[e]),n.each(e,n.bind(function(t){var e=s("<li/>",{text:t});i.append(e)},this)),i.show(),n.defer(function(){i.addClass("active")}))},displayErrors:function(t){this.showMessages("errors-ask",t)}});e.exports=c},{"../templates/ask-form.tpl":27,"app/lib/avatar-size":429,jquery:"HlZQrA",lodash:"MicNly","prima/mixins/keycommands":547,"prima/mixins/selectorcache":553,"prima/views/base":581}],29:[function(t,e,i){"use strict";var s=t("prima/events"),n=t("lodash"),o=t("backbone"),a=t("prima/class"),r=t("prima/lib/domeventor"),l=a.extend({defaults:{offset:175,throttle:200,lockStep:!1,triggerCachingDelta:-1},constructor:function(t){this.options=n.extend({},this.defaults,t),this.handler=n.bind(this.options.$target?this.onTargetScroll:this.onWindowScroll,this),this.options.throttle&&(this.handler=n.throttle(this.handler,this.options.throttle)),this.locked=!1,this.bindEvents()},forceCheck:function(t){this.options.$target?this.handler(null,t):this.handler(r.rect(),t)},bindEvents:function(){this.options.$target?this.options.$target.parent().on("scroll",this.handler):(this.listenTo(s,"DOMEventor:flatscroll",this.handler),this.listenTo(s,"DOMEventor:flatresize",this.handler))},unlock:function(){this.locked=!1},onWindowScroll:function(t,e){if(!this.locked&&(this.buffer||(this.buffer=this.getBuffer(t)),this.nearBottom(t))){var i=n.clone(t);if(!e&&-1!==this.options.triggerCachingDelta&&this.triggerCache){var s=Math.abs(t.windowScrollTop-this.triggerCache.windowScrollTop);if(s<this.options.triggerCachingDelta)return}this.trigger("trigger"),this.options.lockStep&&(this.locked=!0),e||-1===this.options.triggerCachingDelta||(this.triggerCache=i)}},onTargetScroll:function(t,e){var i=this.options.$target.parent().height(),s=this.options.$target.outerHeight(),n=this.options.$target.position().top,o={windowScrollTop:-n,documentHeight:s,windowHeight:i};this.onWindowScroll(o,e)},getRemainingDocHeight:function(t){return t.documentHeight-t.windowScrollTop-t.windowHeight-this.buffer},getBuffer:function(t){var e=t.windowHeight;return n.isNull(e)?!1:Math.round(.666*e)},nearBottom:function(t){if(n.isNull(t.windowScrollTop))return!1;var e=this.options.offset,i=this.getRemainingDocHeight(t);return e>i},close:function(){this.options.$target&&this.options.$target.parent().off("scroll",this.handler)}});n.extend(l.prototype,o.Events),e.exports=l},{backbone:"5kFNoY",lodash:"MicNly","prima/class":509,"prima/events":512,"prima/lib/domeventor":516}],30:[function(t,e,i){"use strict";e.exports=t("./views/blog_card_view")},{"./views/blog_card_view":34}],31:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __t,__p="";Array.prototype.join;with(obj||{}){__p+="";var is_popover="boolean"==typeof popover?popover:!1,has_avatar=avatar_url&&global_theme_params.show_avatar,has_bg_img=global_theme_params.header_image_focused&&global_theme_params.show_header_image,has_title=title&&global_theme_params.show_title,has_description=description_sanitized&&global_theme_params.show_description,expanded_name=cname?cname:name+".tumblr.com",description_color=title_color_rgb?"rgba("+title_color_rgb+",0.7)":global_theme_params.title_color,header_class=global_theme_params.header_stretch?"":" no_stretch_header";header_class+=has_bg_img?"":" no_header_image",header_class+=has_avatar?"":" no_avatar",header_class+=!has_bg_img||has_avatar||has_title||has_description?"":" header_image_only",header_class+=has_title||has_description?" has_info":" no_info",__p+='<div class="indash_header_wrapper '+(null==(__t=header_class)?"":__t)+" tumblelog_name_"+(null==(__t=name)?"":_.escape(__t))+'" style="background-color:'+(null==(__t=global_theme_params.background_color)?"":__t)+"; color:"+(null==(__t=global_theme_params.title_color)?"":__t)+'">',show_navigation&&(__p+='<div class="navigation"><div class="navigation_bg" style="background-color: '+(null==(__t=global_theme_params.background_color)?"":__t)+'"></div><div class="navigation_inner">',"undefined"!==name&&(__p+='<h3><a href="'+(null==(__t=url)?"":_.escape(__t))+'" target="_blank" class="blog_name" data-peepr="{&quot;tumblelog&quot;: &quot;'+(null==(__t=name)?"":_.escape(__t))+'&quot;}"><span class="name">'+(null==(__t=name)?"":_.escape(__t))+'</span> <span class="full_url">'+(null==(__t=expanded_name)?"":_.escape(__t))+"</span></a></h3>"),__p+="",show_share_controls&&(__p+='<a class="open_blog_button nav_icon icon_export"></a>'),__p+="",!customizable&&show_user_controls&&(__p+=' <a class="info_popover_button nav_icon user_dropdown_lockup"><i class="user_dropdown_icon user_dropdown_icon_user icon_user_settings"></i></a>'),__p+="",!customizable&&show_follow_button&&(__p+="",__p+=following?' <button class="chrome unfollow" type="button">'+(null==(__t=unfollowText)?"":_.escape(__t))+'</button> <button class="chrome follow" type="button" style="display:none">'+(null==(__t=followText)?"":_.escape(__t))+"</button>":' <button class="chrome unfollow" type="button" style="display:none">'+(null==(__t=unfollowText)?"":_.escape(__t))+'</button> <button class="chrome follow" type="button">'+(null==(__t=followText)?"":_.escape(__t))+"</button>",__p+=""),__p+="</div></div>"),__p+="",global_theme_params.header_image_focused&&global_theme_params.show_header_image&&(__p+='<div class="header_image_wrapper',has_avatar&&(__p+=" has_avatar"),__p+='"><div class="header_image" style="background-image:url('+(null==(__t=global_theme_params.header_image_focused)?"":_.escape(__t))+')">',__p+=is_popover||!customizable?'<a href="'+(null==(__t=url)?"":__t)+'" target="_blank"><img src="'+(null==(__t=global_theme_params.header_image_focused)?"":_.escape(__t))+'" data-peepr="{&quot;tumblelog&quot;: &quot;'+(null==(__t=name)?"":_.escape(__t))+'&quot;}" alt="'+(null==(__t=title)?"":_.escape(__t))+'"></a>':' <img src="'+(null==(__t=global_theme_params.header_image_focused)?"":_.escape(__t))+'" alt="">',__p+="</div></div>"),__p+="",avatar_url&&global_theme_params.show_avatar&&(__p+='<div class="avatar '+(null==(__t=global_theme_params.avatar_shape)?"":__t)+'" style="background-color:'+(null==(__t=global_theme_params.background_color)?"":__t)+"; background-image:url("+(null==(__t=avatar_url)?"":__t)+"); color:"+(null==(__t=global_theme_params.background_color)?"":__t)+'">',__p+=is_popover||!customizable?'<a href="'+(null==(__t=url)?"":__t)+'" target="_blank"><img src="'+(null==(__t=avatar_url)?"":__t)+'" data-peepr="{&quot;tumblelog&quot;: &quot;'+(null==(__t=name)?"":_.escape(__t))+'&quot;}" alt="'+(null==(__t=title)?"":_.escape(__t))+'"></a>':' <img src="'+(null==(__t=avatar_url)?"":__t)+'" alt="">',__p+="</div>"),__p+="",(has_title||has_description)&&(__p+='<div class="info_wrapper"><div class="info">',has_title&&(__p+='<h1 class="title" style="font-family:'+(null==(__t=title_font_family||"inherit")?"":__t)+"; font-weight:"+(null==(__t=global_theme_params.title_font_weight)?"":__t)+'">'+(null==(__t=title)?"":_.escape(__t))+"</h1>"),__p+="",has_description&&(__p+='<div class="description" style="color:'+(null==(__t=description_color)?"":__t)+'"><div class="description_inner">'+(null==(__t=description_sanitized)?"":__t)+"</div></div>"),__p+="</div></div>"),__p+="</div>"}return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],32:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __t,__p="";Array.prototype.join;with(obj||{}){__p+="";var color="undefined"!=typeof loader_color?loader_color:"#D9D9D9";__p+='<div class="Knight-Rider-loader centered animate"><div class="Knight-Rider-bar" style="background-color:'+(null==(__t=color)?"":__t)+'"></div><div class="Knight-Rider-bar" style="background-color:'+(null==(__t=color)?"":__t)+'"></div><div class="Knight-Rider-bar" style="background-color:'+(null==(__t=color)?"":__t)+'"></div></div>'}return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],33:[function(t,e,i){"use strict";var s={"1785 GLC Baskerville":{display_name:"1785 Baskerville",family:"'1785 GLC Baskerville', serif",path:"1785glcbaskerville",_v:"1"},"Alternate Gothic":{display_name:"Alternate Gothic",family:"'Alternate Gothic', sans-serif",path:"alternategothic",_v:"3"},Arquitecta:{display_name:"Arquitecta",family:"'Arquitecta', sans-serif",path:"arquitecta",_v:"3"},Avalon:{display_name:"Avalon",family:"'Avalon', sans-serif",path:"avalon",_v:"1"},Baskerville:{display_name:"Baskerville",family:"Baskerville, 'Times New Roman', Times, serif"},"Bodoni Recut FS":{display_name:"Bodoni",family:"'Bodoni Recut FS', serif",path:"bodonirecutfs",_v:"3"},Bookmania:{display_name:"Bookmania",family:"'Bookmania', serif",path:"bookmania",_v:"1"},"Brutal Type":{display_name:"Brutal Type",family:"'Brutal Type', sans-serif",path:"brutaltype",_v:"1"},Calluna:{display_name:"Calluna",family:"'Calluna', serif",path:"calluna",_v:"3"},"Calluna Sans":{display_name:"Calluna Sans",family:"'Calluna Sans', sans-serif",path:"callunasans",_v:"3"},Capita:{display_name:"Capita",family:"'Capita', serif",path:"capita",_v:"1"},"Caslon FS":{display_name:"Caslon FS",family:"'Caslon FS', serif",path:"caslonfs",_v:"3"},"Clarendon Text Pro":{display_name:"Clarendon",family:"'Clarendon Text Pro', serif",path:"clarendontextpro",_v:"3"},"Clearface FS":{display_name:"Clearface",family:"'Clearface FS', serif",path:"clearface",_v:"4"},"Courier New":{display_name:"Courier New",family:"'Courier New', Courier, monospace"},FangSong:{display_name:"Fang Song",family:"'FangSong', 'STFangsong', sans-serif"},Futura:{display_name:"Futura",family:"Futura, 'Century Gothic', AppleGothic, sans-serif"},"Garamond Classic FS":{display_name:"Garamond",family:"'Garamond Classic FS', serif",path:"garamondclassicfs",_v:"3"},Georgia:{display_name:"Georgia",family:"Georgia, Palatino, 'Palatino Linotype', Times, 'Times New Roman', serif"},Gibson:{display_name:"Gibson",family:"'Gibson', sans-serif",path:"gibson",_v:"3"},"Grumpy Black 48":{display_name:"Grumpy",family:"'Grumpy Black 48', serif",path:"grumpyblack48",_v:"3"},"Helvetica Neue":{display_name:"Helvetica",family:"'Helvetica Neue', Arial, Helvetica, sans-serif"
},Kaiti:{display_name:"Kaiti",family:"'Kaiti TC', 'KaiTi', sans-serif"},"Lorimer No 2":{display_name:"Lorimer No 2",family:"'Lorimer No 2', sans-serif",path:"lorimerno2",_v:"3"},"Lucida Sans":{display_name:"Lucida Sans",family:"'Lucida Sans', 'Lucida Grande', 'Lucida Sans Unicode', sans-serif"},"News Gothic FS":{display_name:"News Gothic",family:"'News Gothic FS', sans-serif",path:"newsgothicfs",_v:"3"},"Pratt Pro":{display_name:"Pratt Pro",family:"'Pratt Pro', serif",path:"prattpro",_v:"1"},Quadrat:{display_name:"Quadrat",family:"'Quadrat', serif",path:"quadrat",_v:"1"},SimHei:{display_name:"Sim Hei",family:"'SimHei', 'STHeiti', sans-serif"},"Sofia Pro":{display_name:"Sofia Pro",family:"'Sofia Pro', sans-serif",path:"sofiapro",_v:"2"},Spade:{display_name:"Spade",family:"'Spade', serif",path:"spade",_v:"1"},"Square Serif":{display_name:"Square Serif",family:"'Square Serif', serif",path:"squareserif",_v:"4"},Streetscript:{display_name:"Streetscript",family:"'Streetscript', sans-serif",path:"streetscript",_v:"1"},"Typewriter FS":{display_name:"Typewriter",family:"'Typewriter FS', serif",path:"typewriterfs",_v:"1"},Verdana:{display_name:"Verdana",family:"Verdana, Geneva, Tahoma, sans-serif"},Ziclets:{display_name:"Ziclets",family:"'Ziclets', serif",path:"ziclets",_v:"1"}};e.exports=s},{}],34:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/view"),o=t("./header/compact"),a=t("./posts/highlighted"),r=n.extend({defaults:{include_info_popover:!0,disableUnfollowConfirm:!1},className:"poptica_header",initialize:function(t){this.options=s.extend({},this.defaults,t);var e=s.extend({model:this.model},s.pick(this.options,"targetPost","include_info_popover","disableUnfollowConfirm"));this.header=new o(e),this.posts=new a({model:this.model}),this.bindEvents()},bindEvents:function(){this.listenToOnce(this.header,"ready",this._triggerReady)},_triggerReady:function(){this.trigger("ready")},render:function(){return this.$el.append(this.header.render().el,this.posts.render().el),this}});e.exports=r},{"./header/compact":35,"./posts/highlighted":36,lodash:"MicNly","prima/view":580}],35:[function(t,e,i){"use strict";var s=t("lodash"),n=t("jquery"),o=t("prima/lib/flags"),a=t("prima/lib/data"),r=t("prima/view"),l=t("prima/events"),h=t("prima/utils/colors"),c=t("prima/utils/url"),u=t("prima/lib/translate"),d=t("../../templates/blog_card.tpl"),p=t("../../utils/webfonts"),m=r.extend({className:"indash_tumblelog_compact",template:d,defaults:{current_data:{},unfollow_data:{},follow_data:{},template_data:{},hide_posts_on_unfollow:!1,stripDescriptionLineBreaks:!1,include_info_popover:!0},events:{"click .description a":"_descriptionLinkClicked","click .info_popover_button":"_infoPopoverButtonClicked","click .follow":"_onFollowClick","click .unfollow":"_onFollowClick"},initialize:function(t){if(this.options=s.extend({},this.defaults,t||{}),this.bindEvents(),this.is_rendered=!1,this.assets_host=a.get("Context/hosts/assets_host")||"",this.$description=null,this.$description_inner=null,!s.isEmpty(this.current_data)){var e=s.extend({},this.current_data,this.model.toJSON());this.model.set(e,{silent:!0})}this.model.get("global_theme_params")&&s.delay(s.bind(this.render,this),1)},bindEvents:function(){this.listenTo(this.model,"change:following",this._renderFollowButton),this.listenTo(this.model,"change:global_theme_params",this.render)},render:function(){var t=this.model.toJSON();if(t.following||(t.following=!1),this.is_rendered||!t.global_theme_params)return this;var e=s.result(p,t.global_theme_params.title_font),i=h.hexToRgb(t.global_theme_params.title_color);if(this.$el.html(this.template(s.merge({},t,{show_navigation:!0,show_share_controls:!1,show_user_controls:this.options.include_info_popover,show_follow_button:!0,show_dismiss_controls:!1,title_font_family:e?e.family:!1,title_color_rgb:String(s.values(i).join(",")),followText:u("Follow"),unfollowText:u("Unfollow")},this.options.template_data))),this.$description=this.$(".description"),this.$description_inner=this.$description.find(".description_inner"),this._renderFontStyles(),this._renderInlineStyles(),this.options.include_info_popover){var n={el:this.$el,auto_show:!1,trigger:this.$el.find(".info_popover_button"),recipient:this.model.get("name"),asks:this.model.get("asks"),anonymous_asks:this.model.get("anonymous_asks"),url:this.model.get("url"),skip_glass:!0,model:this.model,targetPost:this.options.targetPost};l.trigger("popticainfopopover:initialize",{options:n})}return this.is_rendered=!0,this.$description.length&&(s.delay(s.bind(this.truncateDescription,this),100),this.options.stripDescriptionLineBreaks&&this.stripDescriptionLineBreaks()),this.trigger("ready"),this},stripDescriptionLineBreaks:function(){this.$description_inner.find("br").remove();var t=this.$description_inner.html(),e=t.replace(/[\n\r]/g," ");this.$description_inner.html(e)},truncateDescription:function(){var t=this.$description_inner.get(0);if(!(t.scrollHeight<=t.clientHeight)){var e=this.model.get("global_theme_params"),i=e.background_color,n=h.hexToRgb(i);this.$description.append(this.description_gradient_template({background_color:String(s.values(n).join(","))}))}},_onFollowClick:function(t){if(t.preventDefault(),!o.bool("is_logged_in"))return void window.open("/follow/"+this.model.get("name"),"_self");var e={follow_data:this.options.follow_data};this.model.get("following")?this._confirm_unfollow(e):(l.trigger("tumblelog:log_follow"),this.model.follow(e))},_confirm_unfollow:function(t){var e={tumblelog:this.model.get("name")},i=this.model.requestUnfollow();if(this.options.disableUnfollowConfirm)i.resolve(),l.trigger("tumblelog:log_unfollow",{loggingData:e});else{var s=u("Are you sure you want to unfollow %1$s?").replace("%1$s","<strong>"+this.model.get("name")+"</strong>"),n={text:s,text_ok:u("Ok"),text_cancel:u("Nevermind")};i.promise.then(function(){l.trigger("tumblelog:log_unfollow",{loggingData:e})}),l.trigger("dialog:confirm:promise",i,n)}},_infoPopoverButtonClicked:function(t){t.preventDefault(),t.stopPropagation(),l.trigger("popticainfopopover:show")},_descriptionLinkClicked:function(t){t.preventDefault();var e=n(t.currentTarget).attr("href");try{if(c&&c.hasAllowedProtocol(e)){if(!c.isAbsoluteUrl(e)){var i="http://"+this.model.get("name")+".tumblr.com/";e="/"===e.charAt(0)?e.substr(1):e,e=i+e}window.open(e,"_blank")}}catch(s){}},_renderFollowButton:function(){var t=this.model.get("following");this.$el.find(".follow").toggle(!t),this.$el.find(".unfollow").toggle(t)},_hidePosts:function(){},_open_dialog:function(t,e){function i(t,e){t.is_disabled=t.is_menu_open,e&&e()}this.is_disabled=!0,t.fail(s.bind(i,null,this)),t.done(s.bind(i,null,this,e))},_renderInlineStyles:function(){var t=this.model.get("global_theme_params"),e=t.header_image_focused&&t.header_stretch&&t.show_header_image,i=h.hexToHsv(t.background_color),s=h.hexToHsv(t.link_color),n=t.link_color;return h.compare(s,i)&&(n=h.readable(i)),e||(this.$(".navigation .nav_icon").css("color",n),this.$(".navigation .blog_name").css("color",n),this.$(".navigation button").css({color:t.background_color,"background-color":n})),this.$(".description a").css("color",t.link_color),this},_renderFontStyles:function(){if(p){var t=this.model.get("global_theme_params");if(s.has(p,t.title_font)){var e=s.result(p,t.title_font),i="webfont_"+e.path;if(e.path&&!n("head #"+i).length){var o=this.assets_host+"/fonts/"+e.path+"/stylesheet.css";o+=s.has(e,"_v")?"?v="+e._v:"",n("<link>",{id:i,rel:"stylesheet",type:"text/css",href:o}).appendTo(n("head"))}}}},description_gradient_template:s.template('<div class="description_gradient" style="background: -moz-linear-gradient(top,  rgba(<%= background_color %>,0) 0%, rgba(<%= background_color %>,0.75) 50%, rgba(<%= background_color %>,1) 100%);background: -webkit-gradient(linear, left top, left bottom, color-stop(0%,rgba(<%= background_color %>,0)), color-stop(50%,rgba(<%= background_color %>,0.75)), color-stop(100%,rgba(<%= background_color %>,1)));background: -webkit-linear-gradient(top,  rgba(<%= background_color %>,0) 0%,rgba(<%= background_color %>,0.75) 50%,rgba(<%= background_color %>,1) 100%);background: -o-linear-gradient(top,  rgba(<%= background_color %>,0) 0%,rgba(<%= background_color %>,0.75) 50%,rgba(<%= background_color %>,1) 100%);background: -ms-linear-gradient(top,  rgba(<%= background_color %>,0) 0%,rgba(<%= background_color %>,0.75) 50%,rgba(<%= background_color %>,1) 100%);background: linear-gradient(to bottom, rgba(<%= background_color %>,0) 0%,rgba(<%= background_color %>,0.75) 50%,rgba(<%= background_color %>,1) 100%);"></div>')});e.exports=m},{"../../templates/blog_card.tpl":31,"../../utils/webfonts":33,jquery:"HlZQrA",lodash:"MicNly","prima/events":512,"prima/lib/data":514,"prima/lib/flags":"f/LVtH","prima/lib/translate":541,"prima/utils/colors":564,"prima/utils/url":579,"prima/view":580}],36:[function(t,e,i){"use strict";var s=t("lodash"),n=t("jquery"),o=t("prima/view"),a=t("prima/events"),r=t("../../templates/posts/highlighted_posts.tpl"),l=o.extend({className:"recent_posts",template:r,events:{"click a":"onPostClick",mouseenter:"onMouseEnter"},defaults:{on_bottom:!0,blog_bg_color:!0,$popover:n(),min_load_time:500,model:{},dashboard_post:{}},initialize:function(t){s.extend(this,this.defaults,t),this.model&&(this.renderLoader(),this.renderInlineStyles(),this.posts=this.model.get("highlighted_posts"),s.isUndefined(this.posts)&&this.fetchPosts(),this.bindEvents())},bindEvents:function(){this.listenTo(this.model,"change:highlighted_posts",this.render),this.listenTo(this.model,"change:global_theme_params",this.renderInlineStyles)},fetchPosts:function(){this.model.fetch_popover_data({is_tumblelog_popover:!0})},updatePosts:function(t){this.model=t,this.posts=this.model.get("highlighted_posts"),s.isUndefined(this.posts)?this.fetchPosts():this.render(!0)},renderLoader:function(){var t=this.model.toJSON();this.$el.html(this.template({loader_color:t.global_theme_params?t.global_theme_params.title_color:"#D9D9D9"}))},renderInlineStyles:function(){var t=this.model.get("global_theme_params");t&&this.blog_bg_color&&this.$el.css("background-color",t.background_color)},render:function(t){var e=this.posts||this.model.get("highlighted_posts");if(!s.isArray(e))return this;var i=e.join("");return e.length<2?(setTimeout(s.bind(function(){this.$popover.addClass("is_empty"),this.$el.html("")},this),this.min_load_time),this):(this.$el.addClass("has_"+e.length+"_posts"),t===!0?this.$el.addClass("is_cached").html(i):setTimeout(s.bind(function(){this.$el.addClass("is_loaded").html(i)},this),this.min_load_time),this)},onPostClick:function(t){},onMouseEnter:function(t){a.trigger("TumblelogPopover:mouseenter_posts")}});e.exports=l},{"../../templates/posts/highlighted_posts.tpl":32,jquery:"HlZQrA",lodash:"MicNly","prima/events":512,"prima/view":580}],37:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/views/base"),o=t("./templates/index.tpl"),a=t("./views/dropdown"),r=t("prima/mixins/selectorcache"),l=t("app/lib/avatar-size"),h=n.extend({template:o,mixins:[r],defaults:{currentTumblelog:!1,isOpen:!1,requiresDropdown:!1,showCaret:!0,showName:!0,dropdownClass:null,popoverOptions:null,avatarSize:96,badgeCountField:null,showTotalBadge:!0,showNumberInBadge:!1,includeCurrentBlogInTotalBadge:!1,maxBadgeCount:99,badgeActiveClass:"has-badge"},events:{"click [data-js-button]":"toggleDropdown"},initialize:function(t){t=s.extend({},t),s.extend(this.attributes,s.pick(t,s.keys(this.defaults))),s.extend(this,s.pick(t,"collection")),this.get("currentTumblelog")||this.set("currentTumblelog",this.collection.findWhere({is_current:!0})),this.set("requiresDropdown",this.collection.length>1),(s.isEmpty(this.get("badgeCountField"))||!this.get("requiresDropdown"))&&this.set("showTotalBadge",!1)},getTemplateData:function(){var t=this.get("showTotalBadge"),e=t&&this.get("showNumberInBadge"),i=t?this.getBadgeCount():null;return{avatarUrl:l(this.getCurrentTumblelogProperty("avatar_url"),this.get("avatarSize")),displayName:this.getCurrentTumblelogProperty("name"),requiresDropdown:this.get("requiresDropdown"),hasBadge:t&&i>0,badgeCountString:e?this.getBadgeCountString(i):null}},createDropdown:function(){var t=s.extend({},this.get("popoverOptions"),{identifier:"blogSelector:dropdown",pinnedTarget:this.js$("avatar"),shift:{x:86,y:10},collection:this.collection,currentTumblelog:this.getCurrentTumblelog(),badgeCountField:this.get("badgeCountField"),maxBadgeCount:this.get("maxBadgeCount")});this.dropdown=new a(t),this.get("dropdownClass")&&this.dropdown.$el.addClass(this.get("dropdownClass")),this.listenTo(this.dropdown,"change:currentTumblelog",this.adjustCurrentTumblelog),this.listenTo(this.dropdown,"open",this._onDropdownOpen),this.listenTo(this.dropdown,"close",this._onDropdownClose)},_onDropdownOpen:function(){this.set("isOpen",!0)},_onDropdownClose:function(){this.set("isOpen",!1)},_onChangeIsOpen:function(t,e){this.js$("caret").toggleClass("is-open",e)},toggleDropdown:function(){this.get("requiresDropdown")&&(this.dropdown.isOrWasRecentlyRendered()||this.dropdown.render())},afterRender:function(){return this.get("showTotalBadge")&&(this.listenTo(this.collection,"change:"+this.get("badgeCountField"),this._onBadgeCountChange),this._onBadgeCountChange()),this.get("requiresDropdown")&&(this.createDropdown(),this.js$("button").addClass("has-dropdown"),this.listenTo(this,"change:isOpen",this._onChangeIsOpen),this.listenTo(this,"change:showCaret",this._onChangeShowCaret),this._onChangeIsOpen(this,this.get("isOpen")),this._onChangeShowCaret(this,this.get("showCaret"))),this.listenTo(this,"change:showName",this._onChangeShowName),this._onChangeShowName(this,this.get("showName")),this},getCurrentTumblelog:function(){return this.get("currentTumblelog")},getCurrentTumblelogProperty:function(t){var e=this.getCurrentTumblelog();return e&&e.has(t)&&s.isString(t)?e.get(t):void 0},adjustCurrentTumblelog:function(){var t;this.set("currentTumblelog",this.dropdown.get("currentTumblelog")),this.rendered&&(t=l(this.getCurrentTumblelogProperty("avatar_url"),this.get("avatarSize")),this.js$("avatar").attr("src",t),this.js$("label").text(this.getCurrentTumblelogProperty("name")),this.get("showTotalBadge")&&!this.get("includeCurrentBlogInTotalBadge")&&this._onBadgeCountChange())},teardown:function(){return this.remove(),this},getBadgeCount:function(){var t,e=this.get("currentTumblelog");return this.get("badgeCountField")?(t=s.sum(this.collection.pluck(this.get("badgeCountField"))),e&&!this.get("includeCurrentBlogInTotalBadge")&&(t-=e.get(this.get("badgeCountField"))),Math.max(0,t)):null},getBadgeCountString:function(t){var e=this.get("maxBadgeCount");return t>e?e+"+":t>0?t:""},updateBadge:function(t){var e=this.js$("badge");e.toggleClass(this.get("badgeActiveClass"),t>0),this.get("showNumberInBadge")&&e.text(this.getBadgeCountString(t))},_onBadgeCountChange:function(){this.updateBadge(this.getBadgeCount())},_onChangeShowCaret:function(t,e){this.js$("caret").toggle(e)},_onChangeShowName:function(t,e){this.js$("label").toggle(e)}});e.exports=h},{"./templates/index.tpl":39,"./views/dropdown":40,"app/lib/avatar-size":429,lodash:"MicNly","prima/mixins/selectorcache":553,"prima/views/base":581}],38:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __t,__p="";Array.prototype.join;with(obj||{})__p+='<div class="pop-menu"><ul class="inner select-right" data-js-scrollbar>',_.forEach(channels,function(t){__p+='<li class="item-option '+(null==(__t=t.name===currentTumblelog?"selected":"")?"":_.escape(__t))+'" data-js-tumblelog><div class="avatar"><img src="'+(null==(__t=t.avatarUrl)?"":_.escape(__t))+'" alt="'+(null==(__t=t.name)?"":_.escape(__t))+'">',isShowBadges&&(__p+=' <span class="unread-indicator tab_notice tab-notice--outlined on-light ',t.badgeCountString&&(__p+="tab-notice--active "),__p+='" data-js-channel-badge="'+(null==(__t=t.name)?"":_.escape(__t))+'"><span class="tab_notice_value" data-js-channel-badge-text>'+(null==(__t=t.badgeCountString)?"":_.escape(__t))+"</span></span>"),__p+='</div><div class="info-container"><p class="name">'+(null==(__t=t.displayName)?"":_.escape(__t))+'</p><p class="title">'+(null==(__t=t.directory_safe_title)?"":__t)+"</p></div></li>"}),__p+="</ul></div>";return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],39:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __t,__p="";Array.prototype.join;with(obj||{})__p+='<div class="blog-selector-container"><div class="selected-blog" data-js-button><img class="avatar" src="'+(null==(__t=avatarUrl)?"":_.escape(__t))+'" alt="'+(null==(__t=displayName)?"":__t)+'" data-js-avatar> <span class="name" data-js-label>'+(null==(__t=displayName)?"":__t)+"</span>",requiresDropdown&&(__p+=' <span class="caret '+(null==(__t=hasBadge?"has-badge":"")?"":_.escape(__t))+'" data-js-caret data-js-badge>',badgeCountString&&(__p+=""+(null==(__t=badgeCountString)?"":_.escape(__t))),__p+="</span>"),__p+="</div></div>";return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],40:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/views/base"),o=t("../templates/dropdown.tpl"),a=t("prima/mixins/popoverbase"),r=t("prima/mixins/selectorcache"),l=t("app/lib/avatar-size"),h=t("app/lib/scrollbar"),c=n.extend({className:"popover--blog-selector-dropdown",events:{"click [data-js-tumblelog]":"selectBlog"},mixins:[r,a],template:o,defaults:{currentTumblelog:!1,avatarSize:96,badgeCountField:null,maxBadgeCount:99,badgeActiveClass:"tab-notice--active"},initialize:function(t){if(t=s.extend({},t),s.extend(this.attributes,s.pick(t,s.keys(this.defaults))),s.extend(this,s.pick(t,"collection")),!this.get("currentTumblelog")){var e=this.collection.findWhere({is_current:!0});this.set("currentTumblelog",e)}},selectBlog:function(t){var e=this.$(t.currentTarget).index();this.set("currentTumblelog",this.collection.at(e)),this.teardown()},createScrollbar:function(){this.scrollbar||(this.scrollbar=new h(this.js$("scrollbar")))},afterRender:function(){return this.js$("scrollbar").addClass("popover-sublist popover-sublist--scrollable"),s.defer(s.bind(this.createScrollbar,this)),this.delegateEvents(),this.isShowBadges()&&this.listenTo(this.collection,"change:"+this.get("badgeCountField"),this._onBadgeCountChange),this},isShowBadges:function(){return!s.isEmpty(this.get("badgeCountField"))},getBadgeCount:function(t){return this.get("badgeCountField")&&t?t.get(this.get("badgeCountField")):null},getBadgeCountString:function(t){var e=this.get("maxBadgeCount");return t>e?e+"+":t>0?t:""},getTemplateData:function(){var t,e=this.toJSON(),i=this.get("currentTumblelog");return i&&s.extend(e,{currentTumblelog:i.get("name")}),t=this.collection.map(function(t){return s.extend({avatarUrl:l(t.get("avatar_url"),this.get("avatarSize")),displayName:t.getDisplayName(),badgeCountString:this.getBadgeCountString(this.getBadgeCount(t))},t.toJSON())},this),s.extend(e,{channels:t,isShowBadges:this.isShowBadges()}),e},beforeTeardown:function(){this.scrollbar&&(this.scrollbar.destroy(),this.scrollbar=null),this.stopListening()},teardown:function(){return this.$el.remove(),this},updateBadge:function(t){var e,i=this.$$("[data-js-channel-badge="+t.get("name")+"]");0!==i.length&&(e=this.getBadgeCount(t),i.toggleClass(this.get("badgeActiveClass"),e>0),e>0&&i.find("[data-js-channel-badge-text]").text(this.getBadgeCountString(e)))},_onBadgeCountChange:function(t){return this.updateBadge(t)}});e.exports=c},{"../templates/dropdown.tpl":38,"app/lib/avatar-size":429,"app/lib/scrollbar":433,lodash:"MicNly","prima/mixins/popoverbase":550,"prima/mixins/selectorcache":553,"prima/views/base":581}],41:[function(t,e,i){"use strict";var s=t("app/vendor/ace"),n=s.acequire("ace/lib/dom"),o=t("./post_form.scss").getCSSText(),a={isDark:!1,cssClass:"ace-post-form",cssText:o};n.importCssString(a.cssText,a.cssClass),e.exports=a},{"./post_form.scss":42,"app/vendor/ace":"4e8++S"}],42:[function(t,e,i){"use strict";var s,n=t("sassr/lib/utils"),o=".ace-post-form .ace_selection{background-color:rgba(220,236,245,.8)}.ace-post-form .ace_entity{color:#f2992e}.ace-post-form .ace_string{color:#748089}.ace-post-form .ace_underline{color:#56bc8a;text-decoration:underline}.ace-post-form .ace_storage{color:#d95e40}.ace-post-form .ace_operator{color:#748089}.ace-post-form .ace_identifier{color:#444}.ace-post-form .ace_function{color:#f2992e}.ace-post-form .ace_type{color:#a77dc2}.ace-post-form .ace_constant{color:#d95e40}.ace-post-form .ace_variable{color:#56bc8a}.ace-post-form .ace_keyword{color:#f2992e}.ace-post-form .ace_tag,.ace-post-form .ace_attribute-equals,.ace-post-form .ace_attribute-name{color:#529ecc}.ace-post-form .ace_attribute-value{color:#a77dc2}.ace-post-form .ace_heading{color:#529ecc}.ace-post-form .ace_strong{color:#000}.ace-post-form .ace_emphasis{color:#748089}.ace-post-form .ace_list.ace_markup{color:#a77dc2}",a=o;i.getStyleElement=function(){return n.element},i.getCSSText=function(){return a},i.setBaseHost=function(t){return a=n.insertHost(o,t)},i.append=function(){return s||(n.inject(a),s=!0),n.element},i.remove=function(){return s&&(n.eject(a),s=!1),n.element};var s,n=t("sassr/lib/utils"),o=".ace-post-form .ace_selection{background-color:rgba(220,236,245,.8)}.ace-post-form .ace_entity{color:#f2992e}.ace-post-form .ace_string{color:#748089}.ace-post-form .ace_underline{color:#56bc8a;text-decoration:underline}.ace-post-form .ace_storage{color:#d95e40}.ace-post-form .ace_operator{color:#748089}.ace-post-form .ace_identifier{color:#444}.ace-post-form .ace_function{color:#f2992e}.ace-post-form .ace_type{color:#a77dc2}.ace-post-form .ace_constant{color:#d95e40}.ace-post-form .ace_variable{color:#56bc8a}.ace-post-form .ace_keyword{color:#f2992e}.ace-post-form .ace_tag,.ace-post-form .ace_attribute-equals,.ace-post-form .ace_attribute-name{color:#529ecc}.ace-post-form .ace_attribute-value{color:#a77dc2}.ace-post-form .ace_heading{color:#529ecc}.ace-post-form .ace_strong{color:#000}.ace-post-form .ace_emphasis{color:#748089}.ace-post-form .ace_list.ace_markup{color:#a77dc2}",a=o;i.getStyleElement=function(){return n.element},i.getCSSText=function(){return a},i.setBaseHost=function(t){return a=n.insertHost(o,t)},i.append=function(){return s||(n.inject(a),s=!0),n.element},i.remove=function(){return s&&(n.eject(a),s=!1),n.element}},{"sassr/lib/utils":629}],43:[function(t,e,i){"use strict";var s=t("jquery"),n=t("lodash"),o=t("prima/view"),a=t("prima/events"),r=o.extend({id:"milestone-confetti",tagName:"canvas",defaults:{amount:100,autoParty:!1,colors:["#D95E40","#F2992E","#56BC8A","#529ECC","#A77DC2","#748089"],size:40,speed:.5,onDone:s.noop},__resize:function(){this.$parent.length&&(this.el.width=this.$parent.width(),this.el.height=this.$parent.height())},_updateConfetti:function(t,e){this.confettiAngle+=.001,t.off||(t.tiltAngle+=t.tiltAngleIncrement,t.tilt=15*Math.sin(t.tiltAngle-e/3),t.y+=(Math.cos(this.confettiAngle+t.density)+.5*t.radius)*this.options.speed),t.y>this.el.height+20&&(this.isAnimating?(t.tilt=r.range(-10,10,!0),t.tileAngle=0,t.tiltAngleIncrement=r.range(.05,.1),t.x=Math.random()*this.el.width,t.y=-20):t.off||(t.off=!0,this.confettiOffscreen++))},_stopAnimating:function(){this.animationInterval&&(clearInterval(this.animationInterval),this.animationInterval=null),this.isAnimating=!1},_startAnimating:function(t){t=t||!1,this._stopAnimating(),this.animationInterval=setInterval(n.bind(this.draw,this),15),this.isAnimating=t?!0:this.isAnimating},initialize:function(t){this.options=n.extend({},this.defaults,t||{}),this.colors=this.options.colors,this.$win=s(window),this.$parent=s(),this.context=this.el.getContext("2d"),this.animationInterval=null,this.confetti=[],this.confettiAngle=0,this.confettiOffscreen=0,this.isAnimating=!1},render:function(){return n.defer(n.bind(this.setup,this)),this},setup:function(){this.$parent=this.$el.parent(),this.$parent.length&&(this.el.width=this.$parent.width(),this.el.height=this.$parent.height()),this.listenTo(a,"DOMEventor:flatresize",this.__resize);for(var t=this.options.size,e=.5*t,i=0,s=this.options.amount;s>i;i++)this.confetti.push({x:Math.random()*this.el.width,y:Math.random()*-this.el.height,radius:r.range(e,t),density:r.range(10,s),tilt:r.range(-10,10,!0),tiltAngle:0,tiltAngleIncrement:r.range(.05,.1),color:this.colors[r.range(0,this.colors.length-1,!0)],off:!1});this.options.autoParty&&this.party()},draw:function(){if(this.context.clearRect(0,0,this.el.width,this.el.height),this.confettiOffscreen===this.confetti.length)return void this.remove();for(var t=5,e=0;e<this.confetti.length;e++){var i=this.confetti[e];this.context.beginPath(),this.context.lineWidth=.5*i.radius,this.context.strokeStyle=i.color,this.context.moveTo(i.x+i.tilt+i.radius/t,i.y),this.context.lineTo(i.x+i.tilt,i.y+i.tilt+i.radius/t),this.context.stroke(),this._updateConfetti(i,e)}},party:function(){return this.confettiOffscreen=0,this._startAnimating(!0),this},stopPartying:function(){return this.isAnimating=!1,this},remove:function(){return this._stopAnimating(),this.options.onDone(),o.prototype.remove.call(this)}},{range:function(t,e,i){i=i||!1;var s=(e-t)*Math.random()+t;return i?Math.round(s):s}});e.exports=r},{jquery:"HlZQrA",lodash:"MicNly","prima/events":512,"prima/view":580}],44:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/component"),o=t("./views/dialog"),a=n.extend({name:"Dialog",initialize:function(t){this.dialogView=o,this.options=s.extend({},this.defaults,t)},alert:function(t,e,i){return this.dialogView.alert.call(this.dialogView,t,e,i)},confirm:function(t,e,i,s,n){return this.dialogView.confirm.call(this.dialogView,t,e,i,s,n)},dialog:function(t){return this.dialogView.dialog.call(this.dialogView,t)},isActive:function(t){return this.dialogView.isActive.call(this.dialogView,t)},close:function(t){return this.dialogView.close.call(this.dialogView,t)},getDialogEl:function(){return this.dialogView.getDialogEl.call(this.dialogView)},__:function(t){return this.dialogView.__.call(this.dialogView,t)}});e.exports=new a},{"./views/dialog":48,lodash:"MicNly","prima/component":511}],45:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __t,__p="";Array.prototype.join;with(obj||{})__p+='<button class="ui_button btn_'+(null==(__t=btn_id)?"":__t)+" chrome "+(null==(__t=btn_class)?"":__t)+'" data-btn-id="'+(null==(__t=btn_id)?"":__t)+'"><span>'+(null==(__t=text)?"":__t)+"</span></button>";return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],46:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __t,__p="";Array.prototype.join;with(obj||{})__p+='<span class="text">'+(null==(__t=text)?"":__t)+"</span>";return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],47:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __t,__p="";Array.prototype.join;with(obj||{})__p+='<div class="ui_dialog '+(null==(__t=type)?"":__t)+'">'+(null==(__t=content_html)?"":__t)+'<div class="buttons">'+(null==(__t=buttons_html)?"":__t)+"</div></div>";return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],48:[function(t,e,i){"use strict";var s=t("jquery"),n=t("lodash"),o=t("prima/view"),a=t("prima/events"),r=t("prima/lib/translate"),l=t("prima/utils/bindendevent"),h=o.extend({el:".ui_dialog",translations:{},defaultTemplates:{dialog:t("../templates/dialog.tpl"),content:t("../templates/content.tpl"),button:t("../templates/button.tpl")},events:{"click .ui_button":"buttonClick"},defaultDialog:{text:"",type:"default",has_form:"auto",visible_glass:!0,confirm_by_enter:!0,close_by_space:!0,key_tab:!0,key_close:!0,scroll_lock:!1,keycommand_maintain:!1,animate:!0,animate_in:{dialog_el:".ui_dialog",dialog_class:"fade-in-up"},on_close:function(){},on_open:function(){}},initialize:function(t){this.options=n.extend(this.defaults,this.options),this.templates=this.defaultTemplates,this.is_visible=!1,this.dialogQueueOrder=[],this.dialogQueue={},this.queueCounter=0,this.currentDialog=!1,this.currentDialogId=0,this.uid=0,this.$body=s("body"),this._initClickLock(),this._setupKeys(),a&&!i.Dialog&&(this.listenTo(a,"dialog:dialog",this.dialog),this.listenTo(a,"dialog:confirm",this.confirm),this.listenTo(a,"dialog:confirm:promise",this.confirmPromise),this.listenTo(a,"dialog:alert",this.alert),this.listenTo(a,"dialog:close",this.close))},dialog:function(t){return n.isObject(t)?this._dialog(t):!1},confirm:function(t,e,i,s,o){n.isString(t)&&(t={text:t});var a={callback_ok:e,callback_cancel:i,text_ok:s,text_cancel:o};t=n.extend(this.defaultDialog,a,t);var l={text:t.text,customClass:t.customClass||null,type:"confirm",visible_glass:!0,keycommand_maintain:t.keycommand_maintain||!1,templates:t.templates||null,escape_button:0,animate_in:{dialog_el:t.animate_in.dialog_el||".ui_dialog",dialog_class:t.animate_in.dialog_class||"fade-in-up"},buttons:{0:{text:t.text_cancel||r("Cancel"),close:!0,callback:n.isFunction(t.callback_cancel)?t.callback_cancel:function(){}},1:{text:t.text_ok||r("OK"),selected:!0,btn_class:"blue",close:!0,callback:n.isFunction(t.callback_ok)?t.callback_ok:function(){}}}};return this._dialog(l)},confirmPromise:function(t,e){this.confirm(e,t.resolve,t.reject)},alert:function(t,e,i){n.isString(t)&&(t={text:t});var s={callback_ok:e,text_ok:i};t=n.extend({},s,t);var o={text:t.text,customClass:t.customClass||null,type:"alert",visible_glass:!0,keycommand_maintain:t.keycommand_maintain||!1,templates:t.templates||null,escape_button:0,buttons:{0:{text:t.text_ok||r("OK"),selected:!0,btn_class:"blue",close:!0,callback:n.isFunction(t.callback_ok)?t.callback_ok:function(){}}}};return this._dialog(o)},getDialogEl:function(){return this.el},buttonClick:function(t){var e=s(t.currentTarget),i=e.data("btn-id");if(n.isUndefined(this.currentDialog.buttons[i])||e.hasClass("disabled"))return!1;var o=this.currentDialog.buttons[i],a=null;n.isFunction(o.callback)&&(a=o.callback(this)),a!==!1&&(!n.isUndefined(o.close)&&o.close||n.isUndefined(o.close))&&this.close()},isActive:function(t){return this.currentDialog===!1||this.currentDialog.uid!==t?!1:!0},close:function(t){if(this.currentDialog===!1)return!1;if(n.isUndefined(t)&&(t=!1),t!==!1&&this.currentDialog.uid!==t)return!1;if(this.$dialog_lock.removeClass("opaque"),this.$dialog_el.addClass("fade-out-down"),l.transition(this.$dialog_lock,n.bind(function(){this.$dialog_lock.hide()},this)),l.animation(this.$dialog_el,n.bind(function(){s(".ui_dialog_pos").remove()},this)),this.is_visible=!1,this.currentDialog.keycommand_maintain||a.trigger("keycommands:resume"),n.isFunction(this.currentDialog.on_close)&&this.currentDialog.on_close(),a.trigger("dialog:closed"),this.currentDialog=!1,s("html").removeClass("dialog_lock"),this.dialogQueueOrder.length>0){var e=this.dialogQueueOrder.shift(),i=this.dialogQueue[e];delete this.dialogQueue[e],this._dialog(i)}},_tab:function(t){var e=this.$el.find(".buttons .tab_frame"),i=e.filter(".focus"),s=e.index(i),n=e.length,o=!1;o=n>s+1?s+1:0,i.removeClass("focus init_focus");var a=e.eq(o);a.length>0&&(a.addClass("focus"),a.find("button").focus())},_formIsTabToButton:function(t,e){var i=this.$el.find(":focus");if(0===i.length)return!0;var s=this.$el.find(".buttons .tab_frame"),n=this.$el.find(":input:visible"),o=n.index(i);if(e&&o===n.length-1)return this.$el.find(":input:visible:first").focus(),t.preventDefault(),s.removeClass("focus init_focus"),!1;if(o>=0){var a=this.$el.find(":input:visible:eq("+(o+1)+")");if(a.length>0&&a.hasClass("ui_button"))return!0}return s.removeClass("focus init_focus"),
!1},_select:function(t){var e=this.$el.find(".buttons .tab_frame.focus"),i=e;1===i.length&&i.find(".ui_button").click()},_formIsFocusOnButton:function(t){var e=this.$el.find(":focus");return 0===e.length?!1:e.hasClass("ui_button")},_escape:function(t){if(!n.isUndefined(this.currentDialog.escape_button)){var e=this.$el.find(".btn_"+this.currentDialog.escape_button);e.length&&e.click()}},_dialog:function(t){if(n.isUndefined(t.uid)&&(t.uid=this._getUid()),this.currentDialog!==!1)return this.dialogQueueOrder.push(this.queueCounter),this.dialogQueue[this.queueCounter]=t,this.queueCounter++,t.uid;n.defaults(t,this.defaultDialog);var e=this._buildButtons(t.buttons);n.extend(t,{buttons_html:e});var i=this.templates;n.isObject(t.templates)&&(i=n.extend({},this.templates,t.templates));var o=n.isString(i.dialog)?n.template(i.dialog):i.dialog,r=n.isString(i.content)?n.template(i.content):i.content;t.content_html=r(t);var l=o(t);this.$dialog_lock.show(),n.isUndefined(t.visible_glass)?this.$dialog_lock.removeClass("opaque"):t.visible_glass&&n.defer(n.bind(function(){this.$dialog_lock.addClass("opaque")},this)),!n.isUndefined(t.scroll_lock)&&t.scroll_lock&&s("html").addClass("dialog_lock"),this.currentDialogId=t.uid,this.currentDialog=t;var h=s('<div id="dialog_'+this.currentDialogId+'" class="ui_dialog_pos">'+l+"</div>");return n.isString(t.customClass)&&h.addClass(t.customClass),h.appendTo(this.$body),this.setElement(h),this.is_visible=!0,this.$dialog_el=this.$el.find(t.animate_in.dialog_el),t.animate&&n.isObject(t.animate_in)&&this.$dialog_el.length&&this.$dialog_el.addClass(t.animate_in.dialog_class),this._focus(),this.currentDialog.keycommand_maintain||a.trigger("keycommands:suspend"),n.isUndefined(t.has_form)&&(t.has_form="auto"),"auto"===t.has_form&&(t.has_form=this.$el.find("form, input").length>0),n.isFunction(t.on_open)&&t.on_open(),this.el=this.$el[0],this.delegateEvents(),a.trigger("dialog:opened"),t.uid},_button:function(t,e,i,s){var o,a=n.isString(this.templates.button)?n.template(this.templates.button):this.templates.button;n.isObject(this.currentDialog.templates)&&(o=this.currentDialog.templates.button);var r=a({btn_class:e,text:t,btn_id:n.isUndefined(i)?"":i});return r='<div class="tab_frame">'+r+"</div>"},_focus:function(){if(!this.currentDialog)return!1;for(var t in this.currentDialog.buttons){var e=this.currentDialog.buttons[t];if(!n.isUndefined(e.selected)&&e.selected){var i=this.$el.find(".btn_"+t);i.length>0&&i.parent().addClass("focus init_focus")}}},_setupKeys:function(){s(document).on("keydown",n.bind(function(t){var e=t.ctrlKey||t.shiftKey||t.metaKey;if(this.is_visible&&!e){var i=t.keyCode||t.which;if(9===i&&this.currentDialog.key_tab){if(this.currentDialog.has_form&&!this._formIsTabToButton(t,!0))return;t.preventDefault(),this._tab(t)}if(13===i&&this.currentDialog.confirm_by_enter||32===i&&this.currentDialog.close_by_space){if(this.currentDialog.has_form&&32===i&&!this._formIsFocusOnButton(t))return;t.preventDefault(),this._select(t)}27===i&&this.currentDialog.key_close&&(t.preventDefault(),this._escape(t))}},this))},_buildButtons:function(t){if(!n.isObject(t))return"";var e=0;for(var i in t)t.hasOwnProperty(i)&&e++;for(var s="",o=0;e>o;o++)if(!n.isUndefined(t[o])){var a=n.isUndefined(t[o].text)?"":t[o].text,r=n.isUndefined(t[o].btn_class)?"":t[o].btn_class,l=n.isUndefined(t[o].selected)?!1:t[o].selected;s+=this._button(a,r,o,l)}return s},_initClickLock:function(){var t=this.$dialog_lock=s("<div>",{"class":"ui_dialog_lock",css:{display:"none"}});s(document).ready(function(){t.prependTo("body")})},_getUid:function(){return this.uid++},__:function(t){return r(t)}});e.exports=new h},{"../templates/button.tpl":45,"../templates/content.tpl":46,"../templates/dialog.tpl":47,jquery:"HlZQrA",lodash:"MicNly","prima/events":512,"prima/lib/translate":541,"prima/utils/bindendevent":560,"prima/view":580}],49:[function(t,e,i){"use strict";var s,n=t("jquery"),o=t("lodash"),a=t("prima/lib/translate"),r=t("prima/component"),l=t("prima/events"),h=t("prima/mixins/keycommands"),c=t("app/components/dialog"),u=t("./views/drawer-view"),d=r.extend({name:"drawer",selector:"body",mixins:[h],defaults:{suspended:!1,needsCloseConfirmation:!1},keycommands:{"keydown:escape":"initiateClose"},initialize:function(){this.$glass=null,this.$container=n(this.container),this.bindEvents()},bindEvents:function(){this.listenTo(l,"post:form:show",this.suspend),this.listenTo(l,"post:form:hide",this.resume),this.listenTo(l,"drawer:suspend",this.suspend),this.listenTo(l,"drawer:resume",this.resume),this.listenTo(l,"drawer:enableCloseConfirmation",this.enableCloseConfirmation),this.listenTo(l,"drawer:disableCloseConfirmation",this.disableCloseConfirmation),this.listenTo(l,"drawer:hideGlass",this.hideGlass),this.listenTo(l,"indashblog:post:photo_lightbox",this.disableKeys),this.listenTo(l,"tumblr_lightbox:form:hide",this.enableKeys),this.$container.on("click.drawerOpen","[data-drawer-open]",o.bind(this.onClickOpen,this))},suspend:function(){this.set("suspended",!0)},resume:function(){this.set("suspended",!1)},enableCloseConfirmation:function(){this.set("needsCloseConfirmation",!0)},disableCloseConfirmation:function(){this.set("needsCloseConfirmation",!1)},canOpen:function(){return!this.get("suspended")&&!this.view},isSuspended:function(){return this.get("suspended")},isOpen:function(){return!!this.view},toggle:function(t,e){this.canOpen?this.open(t,e):this.close()},open:function(t,e,i){this.view=new u({subviews:{"drawer-content":{constructor:t,options:e||{}}}}),this.view.$el.addClass(i),this.showGlass(),l.trigger("keycommands:suspend"),l.trigger("toaster:suspend"),this.append(),this.trigger("open"),l.trigger("drawer:open")},replace:function(t,e,i){this.view?(this.view.animateRemove(),this.view=null,o.delay(o.bind(function(){this.view=new u({subviews:{"drawer-content":{constructor:t,options:e||{}}}}),this.view.$el.addClass(i),this.append()},this),400)):this.open(t,e,i)},onClickOpen:function(t){t.preventDefault();var e=n(t.currentTarget).attr("data-drawer-open");this.trigger("open:"+e),l.trigger("drawer:open:"+e)},initiateClose:function(){this.view&&!this.get("suspended")&&(this.get("needsCloseConfirmation")===!0?c.confirm(a("Close without sending?"),o.bind(this.close,this),this.noop,a("OK"),a("Cancel")):this.close())},close:function(){this.view&&(this.view.animateRemove(),this.view=null,this.hideGlass(),l.trigger("keycommands:resume"),l.trigger("toaster:resume"),this.trigger("close"),l.trigger("drawer:close"))},remove:function(){return this.close(),this},showGlass:function(){this.$glass=n("<div>",{"class":"ui_peepr_glass"}).appendTo(this.$container);var t=o.bind(function(){this.$container.addClass("peepr")},this);this.animationDelay=o.delay(t,50),this.$glass.on("click",o.bind(this.initiateClose,this))},hideGlass:function(){var t=this.$glass;this.$glass=null,this.$container.removeClass("peepr"),this.animationDelay&&clearTimeout(this.animationDelay),o.delay(function(){t.remove()},150)}});e.exports=function(){return s||(s=new d),s}},{"./views/drawer-view":51,"app/components/dialog":44,jquery:"HlZQrA",lodash:"MicNly","prima/component":511,"prima/events":512,"prima/lib/translate":541,"prima/mixins/keycommands":547}],50:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __t,__p="";Array.prototype.join;with(obj||{})__p+=""+(null==(__t=_subview("drawer-content"))?"":__t);return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],51:[function(t,e,i){"use strict";var s=t("jquery"),n=t("lodash"),o=t("prima/events"),a=t("prima/views/base"),r=t("../templates/drawer-view.tpl"),l=a.extend({template:r,className:"drawer",defaults:{visible:!1},initialize:function(t){t.subviews&&(this.$body=s("body"),this.bindEvents())},bindEvents:function(){this.listenTo(o,"DOMEventor:keydown:tab",this.disableKey)},afterRender:function(){this.show()},disableKey:function(t){var e=s(t.target).is("input");e||t.preventDefault()},show:function(){this.get("visible")||(this.set("visible",!0),this.toggleAnimation("open",!0))},hide:function(t){this.get("visible")?(this.set("visible",!1),this.toggleAnimation("open",!1),n.delay(t,500)):t()},toggleAnimation:function(t,e){var i=n.bind(function(){this.$el.toggleClass(t,e)},this);window.requestAnimationFrame?window.requestAnimationFrame(i):n.defer(i)},animateRemove:function(){return this.hide(n.bind(function(){this.remove()},this)),this}});e.exports=l},{"../templates/drawer-view.tpl":50,jquery:"HlZQrA",lodash:"MicNly","prima/events":512,"prima/views/base":581}],52:[function(t,e,i){"use strict";var s=t("prima/component"),n=t("./views/flat-select"),o=s.extend({name:"FlatSelect",view:function(t){return new n(t)}});e.exports=o},{"./views/flat-select":53,"prima/component":511}],53:[function(t,e,i){"use strict";var s=t("jquery"),n=t("lodash"),o=t("prima/view"),a=o.extend({el:"body",defaults:{},events:{"change .flat_select select":"__selectChange"},__selectChange:function(t){var e=s(t.currentTarget);this.updateSelect(e)},initialize:function(t){this.options=n.extend({},this.defaults,t)},updateSelect:function(t){var e=t.siblings("label");e.text(t.find(":selected").text())}});e.exports=a},{jquery:"HlZQrA",lodash:"MicNly","prima/view":580}],54:[function(t,e,i){"use strict";var s,n=t("jquery"),o=t("prima/component"),a=t("./views/footer"),r=t("./views/sidebar_footer"),l=o.extend({name:"footer",initialize:function(){this.createFooter()},createFooter:function(){n(".l-footer").length&&(this.footerView=new a({el:".l-footer"})),n(".sidebar_nav").length&&(this.sidebarFooterView=new r({el:".pinned_sidebar_footer"}))}});e.exports=function(){return s||(s=new l),s}},{"./views/footer":55,"./views/sidebar_footer":56,jquery:"HlZQrA","prima/component":511}],55:[function(t,e,i){"use strict";var s=t("prima/view"),n=s.extend({initialize:function(){}});e.exports=n},{"prima/view":580}],56:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/views/base"),o=t("prima/events"),a=t("prima/utils/bindendevent").transition,r=n.extend({defaults:{fadeScrollDistance:2e3,visible:!0},initialize:function(){this.listenTo(o,"DOMEventor:flatscroll",this.onScroll),this.on("change:visible",this.toggleVisibility),this.$nav=this.$el.find(".sidebar_nav")},onScroll:function(t){t&&(t.windowScrollY>=this.get("fadeScrollDistance")?this.set("visible",!1):this.set("visible",!0))},toggleVisibility:function(t,e){e===!0?(this.showElement(),s.defer(s.bind(function(){this.$nav.toggleClass("visible",e)},this))):(a(this.$nav,s.bind(function(){this.hideElement()},this)),this.$nav.toggleClass("visible",e))},hideElement:function(){this.$el.css({display:"none"})},showElement:function(){this.$el.css({display:"block"})}});e.exports=r},{lodash:"MicNly","prima/events":512,"prima/utils/bindendevent":560,"prima/views/base":581}],57:[function(t,e,i){"use strict";var s=t("lodash"),n=t("when"),o=t("prima/collection"),a=t("../models/search-image-query"),r=3e5,l=o.extend({model:a,resultCountForQuery:function(t){t=(t||"").toLowerCase().trim();var e=this.get(t);return e?e.media.length:0},fetchGifs:function(t,e,i){var o,l=n.defer();t=(t||"").toLowerCase().trim();var h=this.get(t);return h||(h=new a({query:t,limit:e}),this.add(h)),!i&&s.now()-h.get("ts")<r?(this.trigger("search",t,!0),l.resolve(h)):(this.trigger("search",t,!1),o=h.fetch({success:function(){o=null,l.resolve(h)},error:function(t){o=null,l.reject(t)}})),l.promise["catch"](function(){o&&o.abort()}),l},clearCache:function(t){this.remove(t)}});e.exports=l},{"../models/search-image-query":60,lodash:"MicNly","prima/collection":510,when:"RG2dij"}],58:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/collection"),o=t("../models/search-image"),a=n.extend({model:o,previousFrom:function(t){return this.rotateFrom(t,-1)},nextFrom:function(t){return this.rotateFrom(t,1)},rotateFrom:function(t,e){for(var i=(s.isNumber(t)?this.at(t):this.findWhere({mediaUrl:t}))||this.sample(),n=this.indexOf(i)+e;0>n;)n+=this.length;return this.at(n%this.length)}});e.exports=a},{"../models/search-image":61,lodash:"MicNly","prima/collection":510}],59:[function(t,e,i){"use strict";var s=t("lodash"),n=t("backbone"),o=t("prima/events"),a=t("prima/component"),r=t("./views/image-search-container"),l=t("./collections/search-image-queries"),h=function(){};h.extend=n.Model.extend,s.extend(h.prototype,n.Events);var c=new h,u=a.extend({name:"ImageSearch",selector:"body",initialize:function(t){t=t||{},this.collection=t.collection||new l,this.view=new r(s.extend({eventBus:c,collection:this.collection,query:t.query,imageWidth:t.imageWidth,resultLimit:t.resultLimit,selectedImageUrl:t.selectedImageUrl},this.viewOptions)),this.listenTo(c,"image:select",function(t,e){this.logGifSearchEvent("select",e),this.trigger("selectImage",t.toJSON(),this.getQuery())}),this.listenTo(c,"image:impression",function(t){this.logGifSearchEvent("impression",t)}),this.listenTo(c,"gifsearch:resultChange",function(t){this.logGifSearchResultChange("search",t)}),this.listenTo(this.view,"dismiss",function(){this.trigger("dismiss")})},render:function(){return this.view.render(),this.trigger("append"),this.view},setQuery:function(t){this.view.setQuery(t)},getQuery:function(){return this.view.getQuery()},getCurrentResults:function(){return this.view.get("currentResults")},logGifSearchEvent:function(t,e){var i={popularSearch:e.model.get("popularSearchTag")?e.model.get("popularSearchTag"):null,query:this.getQuery()?this.getQuery():null,resultsIndex:this.getCurrentResults().indexOf(e.model),top:Math.round(e.$el.position().top),left:Math.round(e.$el.position().left),postBlog:e.model.get("postBlog"),postId:e.model.get("postId")};o.trigger("gifsearch:"+t,{loggingData:i})},logGifSearchResultChange:function(t,e){var i=this.getQuery();if(i){var s={query:i};o.trigger("gifsearch:"+t,{loggingData:s})}}});e.exports=u},{"./collections/search-image-queries":57,"./views/image-search-container":67,backbone:"5kFNoY",lodash:"MicNly","prima/component":511,"prima/events":512}],60:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/model"),o=n.prototype,a=t("../collections/search-images"),r=function(t,e,i){this.name="EmbedError",this.message=t,this.input=e,this.data=i,this.stack=(new Error).stack},l=n.extend({idAttribute:"query",url:"/svc/search/inline_gif",defaults:{query:"",limit:200},initialize:function(t,e){this.media=new a},fetch:function(t){return t=s.extend({type:"POST",with_form_key:!0,data:{q:this.get("query"),limit:this.get("limit")}},t),o.fetch.call(this,t)},parse:function(t,e){if(e&&e.xhr&&(t=(t||{}).response),s.isEmpty(t))throw new r("Invalid GIF search response",this.get("query"),t);return this.media.reset(t.media),delete t.media,t.ts=s.now(),t},toJSON:function(){var t=o.toJSON.apply(this,arguments);return t.media=this.media?this.media.toJSON():[],t}});e.exports=l},{"../collections/search-images":58,lodash:"MicNly","prima/model":557}],61:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/model"),o=t("prima/utils/camelize-keys"),a=n.extend({defaults:{mediaUrl:"",postUrl:"",rootPostUrl:"",rootPostUrlHash:"",rootBlog:"",rootBlogUrl:"",rootBlogKey:"",postTags:[],popularSearchTag:"",width:0,height:0},initialize:function(t,e){this.attributes={},this.set(s.defaults(o(t||{}),this.defaults))}});e.exports=a},{lodash:"MicNly","prima/model":557,"prima/utils/camelize-keys":561}],62:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __p="";Array.prototype.join;with(obj||{})__p+='<div data-subview="searchInput"></div><div data-subview="loader"></div><div data-subview="searchResults"></div><div data-subview="searchMessage"></div>';return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],63:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __p="";Array.prototype.join;with(obj||{})__p+='<div data-subview="textEditor"></div>';return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],64:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __t,__p="";Array.prototype.join;with(obj||{})__p+='<div class="gif-search-message-container">',header&&(__p+='<h2 class="gif-search-message-header">'+(null==(__t=header)?"":__t)+"</h2>"),__p+='<div class="gif-search-message-body">'+(null==(__t=body)?"":__t)+"</div>",hasResults&&(__p+='<p><span class="gif-search-show-results" data-js-showresults>'+(null==(__t=__("View results anyway"))?"":_.escape(__t))+"</span></p>"),__p+="</div>";return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],65:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __t,__p="";Array.prototype.join;with(obj||{})__p+='<figure data-js-select style="width: '+(null==(__t=width)?"":_.escape(__t))+"px; height: "+(null==(__t=height)?"":_.escape(__t))+'px"><img data-js-img data-img-src="'+(null==(__t=mediaUrl)?"":_.escape(__t))+'" width="'+(null==(__t=width)?"":_.escape(__t))+'" height="'+(null==(__t=height)?"":_.escape(__t))+'"></figure><footer><nav class="tags">',_.each(tags,function(t){__p+="",_.isEmpty(t)||(__p+='<a href="#" data-js-tag="'+(null==(__t=t)?"":_.escape(__t))+'">#'+(null==(__t=t)?"":_.escape(__t))+"</a>"),__p+=""}),__p+='</nav><a class="attribution" href="http://tmblr.co/'+(null==(__t=rootPostUrlHash)?"":_.escape(__t))+'" target="_blank">'+(null==(__t=__("Originally posted by %1$s",rootBlog))?"":_.escape(__t))+"</a></footer>";return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],66:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __p="";Array.prototype.join;with(obj||{})__p+='<div class="results-scroller" data-subview="searchResults[]"></div>';return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],67:[function(t,e,i){"use strict";var s=t("jquery"),n=t("lodash"),o=t("prima/lib/translate"),a=t("prima/views/base"),r=t("./image-search-input"),l=t("./image-search-results"),h=t("./image-search-message"),c=t("components/loader"),u=t("../templates/image-search-container.tpl"),d=a.extend({className:"gif-search-container",template:u,subviews:{searchInput:{constructor:r,options:function(t){return{eventBus:t.eventBus}}},searchResults:{constructor:l,options:function(t){return{imageWidth:t.get("imageWidth"),selectedImageUrl:t.get("selectedImageUrl"),eventBus:t.eventBus}}},searchMessage:{constructor:h,options:function(t){return{eventBus:t.eventBus}}}},defaults:{imageWidth:null,resultLimit:200,selectedImageUrl:"",query:null},initialize:function(t){t=n.extend({},t),n.extend(this.attributes,n.pick(t,n.keys(this.defaults))),n.extend(this,n.pick(t,"eventBus","collection")),this.noResults=[o("Nothing turned up. Bummer."),o("Looked around but didn't see anything about that."),o("Sadly, nothing."),o("Tragically, nothing."),o("Welcome to the void. There is nothing here."),o("We found nothing. Here it isn't."),o("Couldn't find that. Please, don't be upset. Please."),o("Sincerely, we found nothing."),o("Maybe try a similar search but use different words? Dunno.")],this.listenTo(this,"change:query",this._onChangeQuery),this.listenTo(this.eventBus,"image:tag",function(t,e){this.set("query",t),this.searchInput.setValue(this.get("query"))}),this.listenTo(this.eventBus,"showHiddenResults",function(){this.searchResults.setCollection(this.get("currentResults")),this.hasResults()&&this.searchMessage.hide()})},hasResults:function(){return!(n.isEmpty(this.get("currentResults"))||n.isEmpty(this.get("currentResults").models))},dismiss:function(){this.trigger("dismiss")},_onKeyDown:function(t){27===t.keyCode&&(t.stopPropagation(),this.dismiss())},_onChangeQuery:function(t,e){n.isString(e)&&(this.rendered&&this.loader.set("loading",!0),this.currentQuery&&this.currentQuery.reject(),this.searchResults.cancelPreloads(),this.searchResults.cancelFullImageLoads(),this.currentQuery=this.collection.fetchGifs(e,this.get("resultLimit")),this.currentQuery.promise.then(n.bind(function(t){if(this.set("currentResults",t.media),this.rendered){this.loader.set("loading",!1);var e=t.get("message");e&&(e.header||e.body)?this.searchMessage.setMessage(e.header,e.body,this.hasResults()):(this.searchResults.setCollection(this.get("currentResults")),this.hasResults()?this.searchMessage.hide():this.searchMessage.setMessage("",n.sample(this.noResults),!1))}this.currentQuery=null},this)))},afterRenderSubviews:function(){n.defer(n.bind(function(){this.searchInput.focus()},this)),this.listenTo(this.searchInput,"userQueryChanged",function(t){this.setQuery(t)}),this.loader=new c({$container:this.$el,type:"bar",classModifiers:"top",loading:!1}),n.isString(this.get("query"))&&(this._onChangeQuery(this,this.get("query")),this.searchInput.setValue(this.get("query"))),s("body").on("keydown.image-search-container",n.bind(this._onKeyDown,this))},setQuery:function(t){this.set("query",t)},getQuery:function(){return this.get("query")},beforeRemove:function(){s("body").off(".image-search-container"),this.currentQuery&&this.currentQuery.reject()}});e.exports=d},{"../templates/image-search-container.tpl":62,"./image-search-input":68,"./image-search-message":69,"./image-search-results":71,"components/loader":464,jquery:"HlZQrA",lodash:"MicNly","prima/lib/translate":541,"prima/views/base":581}],68:[function(t,e,i){"use strict";var s=t("prima/views/base"),n=t("../templates/image-search-input.tpl"),o=t("prima/lib/translate"),a=t("lodash"),r=t("app/components/post-form/views/plaintext_editor"),l=s.extend({className:"gif-search-input",template:n,subviews:{textEditor:{constructor:r,options:function(t){return{forceSingleLine:!0,placeholder:o("Find a GIF"),syncWithModel:!1,onChange:a.debounce(a.bind(t._onUserChangeInput,t),250)}}}},_onUserChangeInput:function(){this.trigger("userQueryChanged",this.textEditor.getEditorValue())},focus:function(){this.textEditor.focus()},setValue:function(t){this.textEditor.setEditorValue(t)}});e.exports=l},{"../templates/image-search-input.tpl":63,"app/components/post-form/views/plaintext_editor":337,lodash:"MicNly","prima/lib/translate":541,"prima/views/base":581}],69:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/utils/filter-html-by-dom"),o=t("prima/views/base"),a=t("../templates/image-search-message.tpl"),r=o.extend({className:"gif-search-message",template:a,defaults:{header:"",body:"",hasResults:!1},events:{"click [data-js-showResults]":"_onClickShowResults"},initialize:function(t){s.extend(this,s.pick(t,"eventBus"))},_onClickShowResults:function(){this.eventBus.trigger("showHiddenResults")},_filterMessageHtml:function(t,e){e.find("script, link").remove(),e.find("a[onerror]").removeAttr("onerror")},getTemplateData:function(){var t=o.prototype.getTemplateData.apply(this,arguments);return t.body=n(t.body||"",this._filterMessageHtml),t},afterRender:function(){this.rendered||this.listenTo(this,"change",this.render),this.$el.toggleClass("gif-search-message--hidden",!(this.get("header")||this.get("message")))},setMessage:function(t,e,i){s.isString(e)||(e=t,t=""),s.isBoolean(i)||(i=this.get("hasResults")),this.set({header:t,body:e,hasResults:i}),e||t?this.show():this.hide()},show:function(){this.$el.removeClass("gif-search-message--hidden")},hide:function(){this.$el.addClass("gif-search-message--hidden")}});e.exports=r},{"../templates/image-search-message.tpl":64,lodash:"MicNly","prima/utils/filter-html-by-dom":570,"prima/views/base":581}],70:[function(t,e,i){"use strict";var s=t("lodash"),n=t("jquery"),o=t("prima/views/base"),a=t("../templates/image-search-result.tpl"),r=t("prima/utils/image/loader"),l=t("prima/mixins/selectorcache"),h=t("components/knight-rider-loader"),c=t("when"),u=o.extend({className:"gif-search-result",template:a,events:{"click [data-js-select]":"_onClickSelect","click [data-js-tag]":"_onClickTag"},mixins:[l],defaults:{skipTags:["gif","gifs"],imageWidth:null,isVirtualized:!0,hasStillImage:!0,isPreselected:!1,unloadImageOnVirtualize:!1,isLoaded:!1,isSelectable:!0,loadFullImageBeforeSelect:!0,loadingFullImage:!1,containerWidth:150,isImpressionLogged:!1},initialize:function(t){t=s.extend({},t),s.extend(this.attributes,s.pick(t,s.keys(this.defaults))),s.extend(this,s.pick(t,"eventBus")),this._loadDefer=c.defer()},afterRender:function(){this.listenTo(this,"change:isPreselected",this._onChangeIsPreselected),this.listenTo(this,"change:isVirtualized",this._onChangeIsVirtualized),this.listenTo(this,"change:hasStillImage",this._onChangeHasStillImage),this.listenTo(this,"change:isSelectable",this._onChangeIsSelectable),this.listenTo(this,"change:isLoaded",this._onChangeIsLoaded),this.listenTo(this.eventBus,"image:full:cancelLoad",this._onCancelAllFullImageLoads),this._onChangeIsVirtualized(this,this.get("isVirtualized")),this._onChangeHasStillImage(this,this.get("hasStillImage")),this._onChangeIsPreselected(this,this.get("isPreselected")),this._onChangeIsSelectable(this,this.get("isSelectable")),this._onChangeIsLoaded(this,this.get("isLoaded"))},getTemplateData:function(){var t=this.model.toJSON(),e=t.popularSearchTag?[t.popularSearchTag]:t.postTags,i=this.get("skipTags"),n=this.get("containerWidth"),o=Math.round(this.model.get("height")*(n/this.model.get("width")));return e=s.reject(e,function(t){return s.contains(i,t.toLowerCase())}),s.extend(t,{tags:e.slice(0,3),width:n,height:o}),this.get("imageWidth")&&s.extend(t,{mediaUrl:t.mediaUrl.replace(/_\d+\./,"_"+this.get("imageWidth")+".")}),t},loadImage:function(){var t=this.js$("img"),e=t.attr("data-img-src");return this.get("isLoaded")||(t.attr("src",e),r.load(e,100).then(s.bind(function(){this.rendered&&this.set("isLoaded",!0),this._loadDefer.resolve()},this))),this._loadDefer.promise},unloadImage:function(){this.js$("img").removeAttr("src")},refreshStillImage:function(){this._onChangeHasStillImage(this,this.get("hasStillImage"))},getLoadPromise:function(){return this._loadDefer.promise},_onCancelAllFullImageLoads:function(){this._cancelLoadFullImage()},_onClickSelect:function(){var t=this.model.get("mediaUrl"),e=this.js$("img").attr("src"),i=function(){this.$el.addClass("gif-search-result--selected"),this.eventBus.trigger("image:select",this.model,this)};this.get("loadFullImageBeforeSelect")&&t!==e?this._loadFullImage(t,i):i.call(this)},_loadFullImage:function(t,e){this.eventBus.trigger("image:full:cancelLoad"),this.set("loadingFullImage",!0),this.eventBus.trigger("image:full:loading"),this.loader=new h({variation:"centered small",loading:!0}),this.$el.addClass("loading-full").append(this.loader.render().$el),r.load(t).then(s.bind(function(){this.get("loadingFullImage")&&s.isFunction(e)&&e.call(this)},this))["finally"](s.bind(this._cancelLoadFullImage,this))},_cancelLoadFullImage:function(){this.rendered&&this.get("loadingFullImage")&&(this.loader&&(this.loader.remove(),this.loader=null),this.$el.removeClass("loading-full"),this.set("loadingFullImage",!1))},_onClickTag:function(t){var e=n(t.target).attr("data-js-tag");this.eventBus.trigger("image:tag",e,this.model),t.preventDefault(),t.stopPropagation()},_onChangeIsPreselected:function(t,e){this.$el.toggleClass("gif-search-result--preselected",e)},_onChangeIsVirtualized:function(t,e){this.$el.toggleClass("off",e),e&&this.get("unloadImageOnVirtualize")?this.unloadImage():e||this.loadImage()},_onChangeHasStillImage:function(t,e){this._removeStillCanvas(),e&&this._prepareCreateStillCanvas()},_onChangeIsSelectable:function(t,e){this.$el.toggleClass("gif-search-result--selectable",e)},_onChangeIsLoaded:function(t,e){this.$el.toggleClass("loaded",e)},_createStillCanvas:function(){if(this.rendered){var t,e=this.js$("img"),i=e.parent(),s=parseInt(e.width(),10),o=parseInt(e.height(),10),a=n("<canvas />").attr({width:s,height:o});this.$("canvas").remove(),i.append(a),t=a.get(0).getContext("2d"),t.drawImage(e.get(0),0,0,s,o),this.$el.addClass("show-still")}},_prepareCreateStillCanvas:function(){this.getLoadPromise().then(s.bind(this._createStillCanvas,this))["catch"](s.noop)},_removeStillCanvas:function(){this.$("canvas").remove(),this.$el.removeClass("show-still")}});e.exports=u},{"../templates/image-search-result.tpl":65,"components/knight-rider-loader":461,jquery:"HlZQrA",lodash:"MicNly","prima/mixins/selectorcache":553,"prima/utils/image/loader":573,"prima/views/base":581,when:"RG2dij"}],71:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/views/base"),o=n.prototype,a=t("../templates/image-search-results.tpl"),r=t("./image-search-result"),l=t("masonry-layout"),h=t("velocity-animate"),c=h.animate,u=h.hook,d=t("when"),p=t("app/lib/scrollbar"),m=function(t){var e=Math.round(t.position().top),i=Math.round(e+t.height());return{top:e,bottom:i}},g=function(t,e){return!(e.bottom<t.top||e.top>t.bottom)},f=function(t,e){return e.bottom>=t.bottom&&e.top<=t.top},_=function(t){return{top:Math.round(t.scrollTop()),bottom:Math.round(t.scrollTop()+t.height())}},v=function(t,e){return Math.floor(e.position().top/t.height())},b=function(t){return Math.floor(t.scrollTop()/t.outerHeight(!0))},y=function(t){return Math.ceil(t.get(0).scrollHeight/t.height())},w=n.extend({className:"gif-search-results",template:a,subviews:{searchResults:{constructor:r,options:function(t){return{eventBus:t.eventBus,imageWidth:t.get("imageWidth")}},collection:function(t){return t.collection}}},defaults:{renderBatchSize:50,renderBatchDelay:5,selectedImageUrl:"",imageWidth:null,enablePreloading:!0,isPreloading:!1,preloadPollInterval:1e3},initialize:function(t){t=s.extend({},t),s.extend(this.attributes,s.pick(t,s.keys(this.defaults))),s.extend(this,s.pick(t,"eventBus","collection"))},setCollection:function(t){this.collection&&this.stopListening(this.collection),this.collection=t,this.eventBus.trigger("gifsearch:resultChange",this.collection),this.rendered&&this.render()},populatePreloadQueue:function(){this._preloadQueue=s.range(y(this.$el)),this.sortPreloadQueue()},sortPreloadQueue:function(){var t;s.isEmpty(this._preloadQueue)||(t=b(this.$el),this._preloadQueue=s.sortBy(this._preloadQueue,function(e){return Math.abs(t-e)+(t>e?.1:0)}))},clearPreloadQueue:function(){this._preloadQueue&&(this._preloadQueue.length=0)},processPreloadQueue:function(){var t,e;if(!this.get("isPreloading")){if(!this.rendered||s.isEmpty(this._preloadQueue))return this.stopPreloadPoller();t=this._preloadQueue.shift(),e=this.getViewsAtPageIndex(t),this.set("isPreloading",!0),this.preloadSubviews(e)["finally"](s.bind(function(){this.set("isPreloading",!1)},this))["catch"](s.noop)}},startPreloadPoller:function(){this.stopPreloadPoller(),this._preloadTimer=setInterval(s.bind(this.processPreloadQueue,this),this.get("preloadPollInterval"))},stopPreloadPoller:function(){this._preloadTimer&&(clearInterval(this._preloadTimer),this._preloadTimer=null)},renderCollectionSubviews:function(t){if("searchResults"!==t)return o.renderCollectionSubviews.apply(this,arguments);var e=this.subviews[t],i=e.container||s.bind(function(){return this.$('[data-subview="'+t+'[]"]')},this),n=e.prepareView||function(i,s){var n=new e.constructor(s);return n.$el.attr("data-subview",t),i.append(n.$el),n},a=e.options||{},r=e.collection;if(s.isFunction(r)&&(r=r(this)),r){var l=this.get("renderBatchSize"),h=this.get("renderBatchDelay");this._deferredRenders=s(r.models).groupBy(function(t,e){return Math.floor(e/l)}).toArray().map(function(e,o){return s.delay(this.createCollectionSubviewRenderer(e,i,n,a,t,!!o),o*h)},this).value()}},hideViews:function(t){s.each(t,function(t){t.rendered&&(t.set("isSelectable",!1),t.$el.css("opacity",0))})},animateShowViews:function(t){var e=0;s.each(t,function(t){this.animateShowView(t,100*e++)},this)},animateShowView:function(t,e,i,n){
var o,a=!1;n=s.isNumber(n)?n:250,e=s.isNumber(e)?e:0,i=s.isNumber(i)?i:1e3,u(t.$el,"translateY","40px");var r=function(){a=!0,c(t.$el,"stop"),c(t.$el,{translateY:0,opacity:1},{duration:n,delay:e,complete:s.bind(function(){t.rendered&&(t.set("isSelectable",!0),t.$el.css({transform:"",opacity:""}))},this)})};i>0&&(o=setTimeout(r,i)),t.getLoadPromise().then(function(){o&&clearTimeout(o),a||r()})},beforeRender:function(){this.$el.css("visibility","hidden"),this.removeSubviews()},afterRender:function(){this.collection&&0!==this.collection.length&&(this.listenTo(this.eventBus,"image:full:loading",this.cancelPreloads),s.defer(s.bind(function(){if(this.rendered){this._deferredRenders||(this._deferredRenders=[]);var t=s.delay(s.bind(this.resetMasonry,this),this.get("renderBatchDelay")*this._deferredRenders.length);this._deferredRenders.push(t),this.scrollbar?this.scrollbar.update():this.scrollbar=new p(this.$el)}},this)))},removeSubviews:function(){return s.forEach(this._deferredRenders,clearTimeout),this._deferredRenders=[],delete this.masonry,o.removeSubviews.apply(this,arguments)},resetMasonry:function(){this.setupMasonary(),this.setupElementCaches(),this.get("enablePreloading")&&(this.populatePreloadQueue(),this.startPreloadPoller()),this.setSelectedImage(),this.setupVirtualization();var t=this.getSubviewsInBounds();this.hideViews(t),this.$el.css("visibility",""),this.animateShowViews(t)},getViewBounds:function(t){return s.result(this._elementPositionCache,t.cid)?this._elementPositionCache[t.cid]:m(t.$el)},getSubviewsInBounds:function(t){return t=t||_(this.$el),s.filter(this.searchResults,function(e){return g(this.getViewBounds(e),t)},this)},setupMasonary:function(){this.masonry?this.masonry.reload():this.masonry=new l(this.$(".results-scroller").get(0),{transitionDuration:0,isFitWidth:!0,gutter:10},this)},setupElementCaches:function(){var t=this.$el;this._pageIndexCache={},this._elementPositionCache={},s.each(this.searchResults,function(e){var i=v(t,e.$el);s.isArray(this._pageIndexCache[i])||(this._pageIndexCache[i]=[]),this._pageIndexCache[i].push(e),this._elementPositionCache[e.cid]=m(e.$el)},this)},getViewsAtPageIndex:function(t){return this._pageIndexCache[t]||[]},setupVirtualization:function(){var t=s.bind(function(){this.rendered&&(this.sortPreloadQueue(),this.virtualizeSubviews())},this),e=s.debounce(t,250);this.$el.off(".image-search-virtualization").on("scroll.image-search-virtualization",e),this.virtualizeSubviews()},setSelectedImage:function(){var t,e;if(this.get("selectedImageUrl")&&(e=s.find(this.searchResults,function(t,e){return t.model.get("mediaUrl")===this.get("selectedImageUrl")},this))){if(e.set("isPreselected",!0),t=e.$el.offset().top-this.$el.offset().top,0===t)return;t-=(this.$el.height()-e.$el.height())/2,this.$el.scrollTop(t)}},cancelPreloads:function(){this.stopPreloadPoller(),this.clearPreloadQueue()},cancelFullImageLoads:function(){this.eventBus.trigger("image:full:cancelLoad")},preloadSubviews:function(t,e){return d.all(s.map(t,function(t){return t.loadImage()}))},_virtualizeSubviews:function(t,e,i){s.forEach(this.searchResults,function(n,o){if(n&&n.$el){var a=this.getViewBounds(n);g(a,t)?s.isFunction(e)&&e.call(this,n,f(a,t)):s.isFunction(i)&&i.call(this,n)}},this)},virtualizeSubviews:function(){var t=this.$el,e={top:t.scrollTop(),bottom:t.scrollTop()+t.height()};this._virtualizeSubviews(e,function(t,e){t.set({isVirtualized:!1}),e&&t.get("isImpressionLogged")===!1&&(this.eventBus.trigger("image:impression",t),t.set("isImpressionLogged",!0))},function(t){t.set({isVirtualized:!0})})},beforeRemove:function(){this.$el.off(),this.cancelPreloads(),this.cancelFullImageLoads(),this.scrollbar&&this.scrollbar.destroy()}});e.exports=w},{"../templates/image-search-results.tpl":66,"./image-search-result":70,"app/lib/scrollbar":433,lodash:"MicNly","masonry-layout":"EDlLR4","prima/views/base":581,"velocity-animate":"lWl/mc",when:"RG2dij"}],72:[function(t,e,i){"use strict";var s=t("prima/component"),n=t("prima/lib/domeventor"),o=t("prima/events"),a=t("jquery"),r=t("lodash"),l=s.extend({name:"GutterMediaManager",gutteredView:null,gutterMargin:20,gutterWidth:215,maxViewWidth:300,viewportTransitionWidth:900,initialize:function(){this.layoutHasGutter=this.$right_column().length>0,this.layoutHasGutter||(this.gutterMargin=-65)},$right_column:function(){return this._$right_column||(this._$right_column=a(".right_column")),this._$right_column},toggleBackground:function(t){this.layoutHasGutter&&(t?(this.$right_column().addClass("has_docked_post"),this.$right_column().on("click.gutterManager",r.bind(this.handleGutterClick,this))):(this.$right_column().removeClass("has_docked_post"),this.$right_column().off("click.gutterManager")))},putViewInGutter:function(t,e){return e=r.defaults(e||{},{winRect:n.rect(),gutterPosition:this.gutterPosition(),animation:null,dimRadar:!0,removeOnGutterClick:!1,onDock:r.noop,onUndock:r.noop,dockLoggingName:"post:docked",dockLoggingData:null,undockLoggingName:"post:undocked",undockLoggingData:null}),this.isDockable(t,e)?(e.onDock=e.onDock||r.noop,this.gutteredView&&this.removeGutteredView(),this.gutteredView={view:t,options:e},e.onDock.call(t,e),e.dimRadar&&this.toggleBackground(!0),e.dockLoggingName&&e.dockLoggingData&&o.trigger(e.dockLoggingName,{loggingData:e.dockLoggingData}),this.gutteredView):!1},removeGutteredView:function(){if(this.gutteredView){var t=this.gutteredView.options,e=this.gutteredView.view;t.onUndock=t.onUndock||r.noop,t.onUndock.call(e,t),this.gutteredView=null,t.dimRadar&&this.toggleBackground(!1),t.undockLoggingName&&t.undockLoggingData&&o.trigger(t.undockLoggingName,{loggingData:t.undockLoggingData})}},isViewInGutter:function(t){return this.gutteredView&&this.gutteredView.view===t},isDockable:function(t,e){if(!this.gutteredView)return!0;var i=this.gutteredView?this.gutteredView.options.alwaysEvict:!0,s=e.alwaysEvict;return this.gutteredView.view===t||s&&!i?!1:!0},handleGutterClick:function(t){this.gutteredView&&(t.preventDefault(),this.gutteredView.options.removeOnGutterClick&&this.removeGutteredView())},gutterPosition:function(){var t=n.rect(),e=this.viewportTransitionWidth/2-this.gutterMargin-this.gutterWidth,i={width:this.maxViewWidth,left:"50%",bottom:20,translateX:e},s=this.maxViewWidth-this.gutterWidth+this.viewportTransitionWidth;return t.windowWidth<s&&(i.width=s-t.windowWidth),i.width<this.gutterWidth&&(i.width=this.gutterWidth),i}});e.exports=new l},{jquery:"HlZQrA",lodash:"MicNly","prima/component":511,"prima/events":512,"prima/lib/domeventor":516}],73:[function(t,e,i){"use strict";var s,n=t("prima/component"),o=t("./views/header"),a=n.extend({name:"header",autoAppend:!0,append:function(){this.headerView=new o({el:this.container}),this.enableFunctionality()},enableFunctionality:function(){this.headerView.enableCompose()},disableSticky:function(){this.headerView.disableSticky()}});e.exports=function(){return s||(s=new a),s}},{"./views/header":78,"prima/component":511}],74:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __t,__p="";Array.prototype.join;with(obj||{})__p+='<span class="tab_notice tab-notice--outlined ',value>0&&(__p+="tab-notice--active"),__p+='"><span class="tab_notice_value">'+(null==(__t=value)?"":_.escape(__t))+"</span></span>";return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],75:[function(t,e,i){"use strict";var s=t("prima/view"),n=t("app/components/account-popover"),o=t("app/components/account-tour-guide"),a=t("app/lib/currentuser"),r=t("../templates/tab-notice.tpl"),l=s.extend({events:{click:"openPopover"},addUnreadCount:function(){this.$el.append(r({value:this.user.getUnreadCount()}))},initialize:function(){this.popover=null,this.user=a(),this.addUnreadCount(),this.popoverOptions={container:this.$el,viewOptions:{}},this.user.get("seen_atg")||this.beginTourGuide()},openPopover:function(t){if(t.preventDefault(),this.popover)this.popover.show();else{var e=this.$el.closest(".l-header-container");e.length&&(this.popoverOptions.viewOptions.isFixedPosition="fixed"===e.css("position")),this.popover=new n(this.popoverOptions).render()}},beginTourGuide:function(){this.tourGuide=new o({container:this.$el}),this.tourGuide.open()}});e.exports=l},{"../templates/tab-notice.tpl":74,"app/components/account-popover":3,"app/components/account-tour-guide":10,"app/lib/currentuser":432,"prima/view":580}],76:[function(t,e,i){"use strict";var s=t("prima/view"),n=t("prima/events"),o=t("app/components/activity-popover"),a=t("app/lib/currentuser"),r=s.extend({events:{click:"openPopover"},addUnreadCount:function(){},initialize:function(){this.popover=null,this.user=a(),this.addUnreadCount(),this.popoverOptions={container:this.$el,viewOptions:{}}},openPopover:function(t){if(t.preventDefault(),this.popover)this.popover.show();else{var e=this.$el.closest(".l-header-container");e.length&&(this.popoverOptions.viewOptions.isFixedPosition="fixed"===e.css("position")),this.popover=new o(this.popoverOptions).render()}n.trigger("activityLinks:click",{loggingData:{source:"app-header"}})}});e.exports=r},{"app/components/activity-popover":13,"app/lib/currentuser":432,"prima/events":512,"prima/view":580}],77:[function(t,e,i){"use strict";var s=t("prima/lib/flags"),n=t("prima/view"),o=t("prima/events"),a=t("prima/mixins/accessor"),r=n.extend({mixins:[a],el:".compose-button",events:{click:"toggleOpen"},defaults:{open:!1},loggingData:{source:"compose-button"},initialize:function(){this.on("change:open",this.onChangeOpen),s.bool("dashboard_refresh")?(this.listenTo(o,"fastCompose:init:complete",this.open),this.listenTo(o,"fastCompose:dismiss:complete",this.close)):(this.listenTo(o,"fastCompose:init:complete",this.open),this.listenTo(o,"fastCompose:dismiss:complete",this.close))},toggleOpen:function(){this.toggle("open")},open:function(){this.set("open",!0)},close:function(){this.set("open",!1)},onChangeOpen:function(t,e){s.bool("dashboard_refresh")?e?o.trigger("fastCompose:init",{loggingData:this.loggingData}):o.trigger("fastCompose:dismiss",{loggingData:this.loggingData}):e?o.trigger("fastCompose:init"):o.trigger("fastCompose:dismiss")}});e.exports=r},{"prima/events":512,"prima/lib/flags":"f/LVtH","prima/mixins/accessor":542,"prima/view":580}],78:[function(t,e,i){"use strict";var s=t("jquery"),n=t("prima/views/base"),o=t("prima/lib/flags"),a=t("prima/events"),r=t("./compose_btn"),l=t("app/components/switcher"),h=t("./logo"),c=t("./account-menu"),u=t("./activity-menu"),d=t("app/components/messaging"),p=t("app/lib/currentuser"),m=n.extend({defaults:{headerHeight:52,headerTop:0},events:{"click .tab_discover > a":"onClickExplore",mouseenter:"__mouseenter",mouseleave:"__mouseleave"},initialize:function(){var t=o.bool("is_logged_in");this.logo=new h({el:'[prima-component="svg-logo"]'}),t&&(this.accountMenu=new c({el:".tab_nav_account"}),s(".tab_activity").length&&(this.activityMenu=new u({el:".tab_activity"})),this._initializeMessaging()),this.set("headerTop",this.$el.position().top),this.listenTo(a,"Header:hide",this.hide),this.listenTo(a,"Header:show",this.show),this.listenTo(a,"Header:setTransparent",this.setTransparent),this.$window=s(window)},enableCompose:function(){this.composeBtn=new r,this.switcher=new l},disableSticky:function(){this.$el.addClass("l-header-container--unstuck")},setTransparent:function(t){this.$el.toggleClass("l-header-container--transparent",!!t)},hide:function(){var t=this.$window.scrollTop()+this.get("headerTop"),e=t<this.get("headerHeight")?t:this.get("headerHeight");this.$el.css({position:"absolute",top:t+"px"}),this.$el.velocity({translateY:[-e,0],translateZ:"0px"},150).velocity({translateY:"0px",translateZ:"0px",top:0},0)},show:function(){var t=this.$window.scrollTop(),e=t<this.get("headerHeight")?t:this.get("headerHeight");this.$el.css({position:"absolute",top:t+"px",transform:"translateY("+-e+"px) translateZ(0)"}),this.$el.velocity({translateY:[0,-e],translateZ:"0px"},150).css({position:"fixed",top:this.get("headerTop")})},onClickExplore:function(){a.trigger("explore-links:click",{loggingData:{source:"app-header"}})},_initializeMessaging:function(){var t=p(),e=this.$(".tab_messaging"),i=o.bool("is_logged_in")&&e.length>0&&t.canMessage();i?this.messaging=new d({inboxAnchorEl:e,inboxPopoverOptions:{isFixedPosition:"fixed"===this.$el.css("position")}}).render():e.length&&e.hide()},__mouseenter:function(){a.trigger("Header:mouseenter")},__mouseleave:function(){a.trigger("Header:mouseleave")}});e.exports=m},{"./account-menu":75,"./activity-menu":76,"./compose_btn":77,"./logo":79,"app/components/messaging":101,"app/components/switcher":381,"app/lib/currentuser":432,jquery:"HlZQrA","prima/events":512,"prima/lib/flags":"f/LVtH","prima/views/base":581}],79:[function(t,e,i){"use strict";var s=t("prima/views/base"),n=t("prima/lib/data"),o=t("lodash"),a=s.extend({events:{mouseleave:"onMouseLeave"},defaults:{totalImages:10,changeOnHover:!0,image:!1},initialize:function(){this.$rolloverImage=this.$("#rollover-image"),this.generateImageIds(),this.get("image")||this.applyRandomImage(),this.setBackgroundImage(this.get("image")),this.listenTo(this,"change:image",function(t,e){this.setBackgroundImage(e)})},generateImageIds:function(){this.imageIds=o.shuffle(o.range(1,this.get("totalImages")+1))},onMouseLeave:function(t){this.get("changeOnHover")&&this.applyRandomImage()},applyRandomImage:function(){0===this.imageIds.length&&this.generateImageIds(),this.set("image",this.imageIds[0]),this.imageIds.shift()},setBackgroundImage:function(t){var e=n.get("Context/hosts/assets_host"),i=e+"/images/logo/hover-animations/"+t+".gif";this.$rolloverImage.attr("xlink:href",i)}});e.exports=a},{lodash:"MicNly","prima/lib/data":514,"prima/views/base":581}],80:[function(t,e,i){"use strict";var s=t("lodash"),n=t("backbone"),o=t("prima/component"),a=t("app/lib/currentuser"),r=t("app/models/tumblelog"),l=t("prima/events"),h=t("./views/messaging-share-post-popover"),c=t("app/components/messaging/collections/compose-recipients"),u=t("app/components/messaging/models/participant"),d=new c,p=o.extend({name:"MessagingSharePost",initialize:function(t){t=s.extend({},t),s.extend(this.attributes,s.pick(t,s.keys(this.defaults))),this.options=t,this.user=a(),this.channels=this._getChannelsEnabledForMessagingAsCollection()},render:function(){return this.openPopover(this.options),this},openPopover:function(t){var e,i,n=s.get(t,"postId"),o=s.get(t,"blogUuid"),a=s.get(t,"favoritesNames",[]),r=s.get(t,"popoverContainer"),l=s.get(t,"pinnedTarget");return s.isEmpty(n)||s.isEmpty(o)||s.isEmpty(l)?void 0:(e={viewOptions:s.bind(function(t){return{shareData:{blogUuid:o,postId:n},popoverContainer:t.el,favoritesCollection:d,additionalFavorites:this._getAdditionalFavoritesAsParticipants(a),channels:this.channels}},this),autoTeardown:!0,pinnedSide:"bottom",isFixedPosition:!1,pinnedTarget:l,popoverContainer:r},i=new h(e).render(),this._afterPopoverOpen(i),i)},_afterPopoverOpen:function(t){this.listenToOnce(t,"close",this._onPopoverClose),l.trigger("keycommands:suspend")},_onPopoverClose:function(){l.trigger("keycommands:resume")},_getChannelsEnabledForMessagingAsCollection:function(){return new n.Collection(this.user.getChannelsEnabledForMessaging())},_getAdditionalFavoritesAsParticipants:function(t){return s.reduce(t,function(t,e){var i=new r({name:e});return i.get("uuid")&&i.get("can_receive_messages")&&t.push(new u(i.toJSON(),{parse:!0})),t},[],this)}});e.exports=p},{"./views/messaging-share-post-popover":89,"app/components/messaging/collections/compose-recipients":95,"app/components/messaging/models/participant":128,"app/lib/currentuser":432,"app/models/tumblelog":436,backbone:"5kFNoY",lodash:"MicNly","prima/component":511,"prima/events":512}],81:[function(t,e,i){"use strict";var s=t("prima/model"),n=s.extend({defaults:{participant:null}});e.exports=n},{"prima/model":557}],82:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __p="";Array.prototype.join;with(obj||{})__p+='<div data-subview="searchView"></div><div class="messaging-share-post-main"><div class="messaging-share-post-results-wrapper"><div data-subview="errorView"></div><div data-subview="resultsView"></div><div data-subview="favoritesLoaderView"></div></div><div data-subview="loader"></div></div><div data-js-submission class="messaging-share-post-submission"><div data-subview="messageView"></div></div>';return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],83:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __t,__p="";Array.prototype.join;with(obj||{})__p+="<p data-js-title>"+(null==(__t=title)?"":_.escape(__t))+"</p>";return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],84:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __t,__p="";Array.prototype.join;with(obj||{})__p+='<div class="container" data-js-theme-accent-color-on-grey><div class="avatar" data-js-theme-avatar-shape-class><img src="'+(null==(__t=avatarUrl)?"":_.escape(__t))+'" alt="'+(null==(__t=name)?"":_.escape(__t))+'" title="'+(null==(__t=name)?"":_.escape(__t))+'"></div><div class="name">'+(null==(__t=name)?"":_.escape(__t))+'</div><div class="title">',__p+=_.isEmpty(title)?"&nbsp;":""+(null==(__t=title)?"":_.escape(__t)),__p+="</div></div>";return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],85:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __p="";Array.prototype.join;with(obj||{})__p+='<div data-subview="resultView[]"></div>';return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],86:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __t,__p="";Array.prototype.join;with(obj||{})__p+='<div class="search-input-wrapper" data-js-search-container><div class="search-input-container"><input type="text" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" class="search-input" placeholder="'+(null==(__t=_("Message to..."))?"":_.escape(__t))+'" data-js-input> <button class="selected-blog" data-js-selected-blog data-js-theme-accent-color-as-background></button></div></div>';return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],87:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/lib/translate"),o=t("prima/events"),a=t("prima/mixins/selectorcache"),r=t("prima/mixins/keycommands"),l=t("prima/views/base"),h=t("components/loader"),c=t("../templates/index.tpl"),u=t("components/knight-rider-loader"),d=t("./messaging-share-post-search"),p=t("./messaging-share-post-results"),m=t("./messaging-share-post-error"),g=t("app/components/messaging/lib/messaging-keyboard-manager"),f=t("app/components/messaging/models/conversation"),_=t("app/components/messaging/views/conversation/conversation-theme"),v=t("app/components/messaging/views/conversation/conversation-compose"),b=t("app/components/messaging/collections/compose-recipients"),y=t("../models/selected-recipient"),w=l.extend({className:"messaging-share-post",template:c,defaults:{senderBlog:null,isSending:!1,isLoading:!1,isLoadingFavorites:!1,isDisabled:!1,isEmpty:!1,isShowFavorites:!0,isShowMessage:!1,showLoadingAfterMs:250,numFavorites:20,defaultPlaceholder:null,additionalFavoritesPlaceholder:null,sendingPlaceholder:null,currentPlaceholder:null,focusIndex:0,isResultContainerFocused:!1,loadingClass:"is-loading",baseLoggingContext:"send-a-post"},mixins:[a,r],keycommands:{"keydown:up":"_onKeyPressUp","keydown:down":"_onKeyPressDown","keydown:tab":"_onKeyPressTab","keydown:shift+tab":"_onKeyPressShiftTab"},subviews:{searchView:{constructor:d,options:function(t){return{collection:t.collection,selectedRecipientModel:t.selectedRecipientModel,keyboardManager:t.keyboardManager,keyboardNamespace:"messagingshare:search"}}},resultsView:{constructor:p,options:function(t){return{collection:t.collection,selectedRecipientModel:t.selectedRecipientModel,keyboardManager:t.keyboardManager,keyboardNamespace:"messagingshare:results"}}},messageView:{constructor:v,options:function(t){return{showBlogSelector:!0,isAutoValidationEnabled:!1,className:"messaging-share-post-message",placeholder:t.get("currentPlaceholder"),channels:t.channels,popoverContainer:t.popoverContainer,keyboardManager:t.keyboardManager,keyboardNamespace:"messagingshare:message",currentTumblelog:t.get("senderBlog"),buttonSubmittedClass:"submitted--send-a-post",animationSpeed:250}}},errorView:{constructor:m},favoritesLoaderView:{constructor:u,options:{className:"messaging-share-post-favorites-loader",variation:"small centered",loading:!1}}},initialize:function(t){t=s.extend({},t),s.extend(this.attributes,s.pick(t,s.keys(this.defaults))),s.extend(this,s.pick(t,"favoritesCollection","shareData","channels","popoverContainer","additionalFavorites")),this.collection=new b,this.keyboardManager=new g({allowMultipleActiveViews:!0}),s.isEmpty(this.get("defaultPlaceholder"))&&this.set("defaultPlaceholder",n("Say something if you like...")),s.isEmpty(this.get("additionalFavoritesPlaceholder"))&&this.set("additionalFavoritesPlaceholder",n("Discuss this post if you like...")),s.isEmpty(this.get("sendingPlaceholder"))&&this.set("sendingPlaceholder",n("Sending...")),this.additionalFavoritesIds=s.pluck(s.invoke(this.additionalFavorites,"toJSON"),"uuid"),this.channelIds=this.channels.pluck("uuid"),this.selectedRecipientModel=new y,this.set({currentPlaceholder:this.get("defaultPlaceholder"),senderBlog:this._getInitiallySelectedChannel()}),this.disableKeys()},afterRenderSubviews:function(){this.loader=new h({$container:this.$el,type:"bar",classModifiers:"top",loading:!1}),this._onSearchInputDebounced=s.bind(s.debounce(function(){this._onSearchInput(this.searchView.getQuery())},250),this),this.listenTo(this.selectedRecipientModel,"change:participant",this._onChangeSelectedRecipient),this.listenTo(this,"change:isSending",this._onChangeIsSending),this.listenTo(this,"change:isDisabled",this._onChangeIsDisabled),this.listenTo(this,"change:isLoading",this._onChangeIsLoading),this.listenTo(this,"change:isLoadingFavorites",this._onChangeisLoadingFavorites),this.listenTo(this,"change:isEmpty",this._onChangeIsEmpty),this.listenTo(this,"change:isShowFavorites",this._onChangeIsShowFavorites),this.listenTo(this,"change:currentPlaceholder",this._onChangeCurrentPlaceholder),this.listenTo(this,"change:focusIndex",this._onChangeFocusIndex),this.listenTo(this.messageView,"change:currentTumblelog",this._onBlogSelectorChange),this.listenTo(this.messageView,"submit:animated",this._onMessageSubmit),this.listenTo(this.searchView,"search",this._onSearchInputDebounced),this.listenTo(this.searchView,"clear",this._onSearchClear),this.listenTo(this.searchView,"focus",this._onViewFocusChange),this.listenTo(this.searchView,"submit",this._onSearchSubmit),this.listenTo(this.messageView,"focus",this._onViewFocusChange),this.listenTo(this.resultsView,"focus",this._onViewFocusChange),this.listenTo(this.collection,"sync",this._onCollectionSync),this._setViewStates(),this._fetchFavorites(),this._setCollectionState(),this.messageTheme=new _({removeDataAttrAfterApplyingTheme:!1,el:this.messageView.el}),this.searchTheme=new _({removeDataAttrAfterApplyingTheme:!1,el:this.searchView.el}),s.defer(s.bind(function(){this.rendered&&this.searchView.focus()},this)),this.keyboardManager.add("messagingshare:main",this)},fetchByQuery:function(t){s.isEmpty(t)?this.set({isEmpty:!1,isShowFavorites:!0,isLoading:!1}):(this.set("isLoading",!0),this.collection.fetchByQuery(t,this.get("senderBlog").get("uuid")).always(s.bind(function(){this.rendered&&this.set("isLoading",!1)},this)))},getSelectedRecipient:function(){return this.selectedRecipientModel.get("participant")},clearSelectedRecipient:function(){this.selectedRecipientModel.set("participant",null)},sendPost:function(t){var e,i,n,a=this.shareData,r=s.get(this.shareData,"postId"),l=s.get(this.shareData,"blogUuid"),h=[],c=!s.isEmpty(t),u=this._getLoggingContext();this.get("isDisabled")||this.get("isSending")||s.isEmpty(a)||(i=f.createPostMessage(r,l,{postHasTextMessage:c,context:u}),h.push(i),c&&(n=f.createTextMessage(t,{context:u}),h.push(n)),e=this._createConversation(),s.isEmpty(e)||(this.set("isSending",!0),e.appendToQueue(h),o.trigger("messaging:conversation:open:model",e,u),this.trigger("close")))},beforeRemove:function(){this.keyboardManager.remove("messagingshare")},_createConversation:function(){var t=this.get("senderBlog"),e=this.getSelectedRecipient();if(s.isEmpty(t)||s.isEmpty(e))return null;var i=t.toJSON(),n=e.toJSON();return new f({participant:i,participants:[i,n]})},_onCollectionSync:function(t){var e;return!this.rendered||s.isEmpty(this.searchView.getQuery())?void this._setCollectionState():(this.clearSelectedRecipient(),e=0===this.collection.length,e&&this.errorView.setTitle(this.collection.getNoResultsFoundMessage()),this.set({isShowFavorites:!1,isEmpty:e}),void this._resetResultsScroll())},_resetResultsScroll:function(){this.resultsView.$el.scrollLeft(0)},_getInitiallySelectedChannel:function(){return this.channels.findWhere({is_current:!0})||s.first(this.channels.models)},_applyTheme:function(t){this.messageTheme.setTheme(t),this.searchTheme.setTheme(t)},_setViewStates:function(){var t=this.get("isShowMessage"),e=this.get("isEmpty"),i=this.get("isLoadingFavorites");this.js$("submission").toggleClass("show-submission",t),this.errorView.$el.toggle(e),this.resultsView.toggle(!e),this.favoritesLoaderView.set("loading",i),this._setFocusViews()},_onSearchInput:function(t){this.rendered&&this.fetchByQuery(t)},_onSearchClear:function(){this.rendered&&(this.fetchByQuery(null),this.clearSelectedRecipient())},_onSearchSubmit:function(){this.get("isShowFavorites")||1===this.collection.length&&this.selectedRecipientModel.set("participant",this.collection.first())},_setPlaceholderState:function(){var t=this.getSelectedRecipient(),e=this.get("isSending"),i=!s.isEmpty(t)&&s.contains(this.additionalFavoritesIds,t.get("uuid"));return e?void this.set("currentPlaceholder",this.get("sendingPlaceholder")):void this.set("currentPlaceholder",i?this.get("additionalFavoritesPlaceholder"):this.get("defaultPlaceholder"))},_setButtonState:function(){var t=this.get("isSending"),e=this.get("isDisabled"),i=t||e;this.messageView.set("isDisabled",i)},_setDisabledState:function(){var t=this.getSelectedRecipient(),e=this.get("senderBlog"),i=!s.isEmpty(t)&&t.get("uuid")===e.get("uuid");this.set("isDisabled",i)},_setCollectionState:function(){this.get("isShowFavorites")&&this.collection.reset(this.favoritesCollection.toJSON())},_setFocusViews:function(){var t=[this.searchView];this.get("isEmpty")||this.get("isLoadingFavorites")||t.push(this.resultsView),this.get("isShowMessage")&&t.push(this.messageView),this._focusViews=t},_getLoggingContext:function(){var t,e,i=this.get("baseLoggingContext"),n=this.getSelectedRecipient();return s.isEmpty(n)?i:(t=s.contains(this.additionalFavoritesIds,n.get("uuid")),e=t?"trail":this.get("isShowFavorites")?"favorites":"search",i+":"+e)},_onChangeIsSending:function(t,e){this._setButtonState(),this._setPlaceholderState()},_onChangeIsDisabled:function(t,e){this._setButtonState()},_onChangeSelectedRecipient:function(t,e){var i=!s.isEmpty(e);i?(this.messageView.focus(),this._applyTheme(e.get("theme"))):this.searchView.focus(),this.set("isShowMessage",i),this._setViewStates(),this._setDisabledState(),this._setPlaceholderState()},_onChangeIsEmpty:function(){this._setViewStates()},_onChangeIsShowFavorites:function(t,e){this._setCollectionState(),this._resetResultsScroll()},_onBlogSelectorChange:function(t,e){this.set("senderBlog",e),this.messageView.focus(),this._setDisabledState()},_onChangeIsLoading:function(t,e){return this._loaderTimeout&&(clearTimeout(this._loaderTimeout),this._loaderTimeout=null),e?void(this._loaderTimeout=setTimeout(s.bind(function(){this.rendered&&(this.loader.set("loading",!0),this.$el.addClass(this.get("loadingClass")))},this),this.get("showLoadingAfterMs"))):(this.$el.removeClass(this.get("loadingClass")),this.loader.set("loading",!1))},_onChangeisLoadingFavorites:function(){this._setViewStates()},_onMessageSubmit:function(t){this.sendPost(t)},_onChangeCurrentPlaceholder:function(t,e){this.messageView.setPlaceholder(e)},_addAdditionalFavorites:function(){!s.isEmpty(this.additionalFavorites)&&s.isArray(this.additionalFavorites)&&s.each(this.additionalFavorites.reverse(),function(t){var e=t.get("uuid"),i=this.favoritesCollection.get(e);s.contains(this.channelIds,e)||(s.isEmpty(i)?this.favoritesCollection.unshift(t):(this.favoritesCollection.remove(e),this.favoritesCollection.unshift(i)))},this)},_fetchFavorites:function(){this.set("isLoadingFavorites",!0),this.favoritesCollection.fetchFavorites(this.get("numFavorites"),null,!0).always(s.bind(function(){this.rendered&&(this._addAdditionalFavorites(),this._setCollectionState(),this.set("isLoadingFavorites",!1))},this))},_getFocusViews:function(){return this._focusViews},_moveFocusUp:function(){this.set("focusIndex",Math.max(0,this.get("focusIndex")-1))},_moveFocusDown:function(){var t=this._getFocusViews()||[];this.set("focusIndex",Math.min(t.length-1,this.get("focusIndex")+1))},_onViewFocusChange:function(t){var e=this._getFocusViews(),i=s.indexOf(e,t);this.set("isResultContainerFocused",t===this.resultsView),this.set("focusIndex",i,{silent:!0})},_onChangeFocusIndex:function(t,e){var i=s.get(this._getFocusViews(),e);this.set("isResultContainerFocused",i===this.resultsView),s.result(i,"focus")},_onKeyPressTab:function(t){var e=this.resultsView,i=this.get("isResultContainerFocused");t.preventDefault(),i&&!e.isLastFocused()?e.focusNext():this._moveFocusDown()},_onKeyPressShiftTab:function(t){var e=this.resultsView,i=this.get("isResultContainerFocused");t.preventDefault(),i&&!e.isFirstFocused()?e.focusPrevious():this._moveFocusUp()},_onKeyPressUp:function(t){t.preventDefault(),this._moveFocusUp()},_onKeyPressDown:function(t){t.preventDefault(),this._moveFocusDown()}});e.exports=w},{"../models/selected-recipient":81,"../templates/index.tpl":82,"./messaging-share-post-error":88,"./messaging-share-post-results":91,"./messaging-share-post-search":92,"app/components/messaging/collections/compose-recipients":95,"app/components/messaging/lib/messaging-keyboard-manager":110,"app/components/messaging/models/conversation":122,"app/components/messaging/views/conversation/conversation-compose":157,"app/components/messaging/views/conversation/conversation-theme":170,"components/knight-rider-loader":461,"components/loader":464,lodash:"MicNly","prima/events":512,"prima/lib/translate":541,"prima/mixins/keycommands":547,"prima/mixins/selectorcache":553,"prima/views/base":581}],88:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/views/base"),o=t("prima/mixins/selectorcache"),a=t("../templates/messaging-share-post-error.tpl"),r=n.extend({className:"messaging-share-post-error",mixins:[o],template:a,defaults:{title:null},initialize:function(t){t=s.extend({},t),s.extend(this.attributes,s.pick(t,s.keys(this.defaults)))},setTitle:function(t){this.set("title",t)},getTemplateData:function(){return{title:this.get("title")}},afterRender:function(){this.listenTo(this,"change:title",this._onChangeTitle)},_onChangeTitle:function(t,e){this.js$("title").text(e)}});e.exports=r},{"../templates/messaging-share-post-error.tpl":83,lodash:"MicNly","prima/mixins/selectorcache":553,"prima/views/base":581}],89:[function(t,e,i){"use strict";var s=t("lodash"),n=t("jquery"),o=t("prima/views/base"),a=t("prima/mixins/popoverbase"),r=t("./index"),l=o.extend({
className:"popover--messaging-share-post popover popover_menu popover_gradient",mixins:[a],initialize:function(t){t=s.extend({},t),s.extend(this.attributes,s.pick(t,s.keys(this.defaults))),s.extend(this,s.pick(t,"viewOptions"))},render:function(){var t=s.isFunction(this.viewOptions)?this.viewOptions.call(this,this):this.viewOptions;return this.$wrapper=n("<div />").addClass("popover-inner popover_inner").appendTo(this.$el),this.$pinned.addClass("active"),this.sharePostView&&(this.stopListening(this.sharePostView),this.sharePostView.remove()),this.sharePostView=new r(t),this.listenToOnce(this.sharePostView,"close",this.teardown),this.listenToOnce(this,"close",this._onClose),this.$wrapper.html(this.sharePostView.render().$el),this},_onClose:function(){this.sharePostView&&this.sharePostView.remove(),this.remove()}});e.exports=l},{"./index":87,jquery:"HlZQrA",lodash:"MicNly","prima/mixins/popoverbase":550,"prima/views/base":581}],90:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/views/base"),o=t("../templates/messaging-share-post-result.tpl"),a=t("app/components/messaging/views/conversation/conversation-theme"),r=n.extend({className:"messaging-share-post-result",tagName:"a",attributes:{href:"#",tabIndex:1},events:{click:"_onSelect",focus:"_onFocus",blur:"_onBlur"},defaults:{isSelected:!1,isFocused:!1,selectedClass:"is-selected",focusedClass:"is-focused"},template:o,initialize:function(t){t=s.extend({},t),s.extend(this.attributes,s.pick(t,s.keys(this.defaults))),s.extend(this,s.pick(t,"onSelect","onFocus","onBlur"))},afterRender:function(){this.listenTo(this,"change:isSelected",this._onChangeIsSelected),this.listenTo(this,"change:isFocused",this._onChangeIsFocused),this.conversationTheme=new a({theme:this.model.get("theme"),el:this.el}).render()},getTemplateData:function(){return{name:this.model.get("name"),title:this.model.get("title"),avatarUrl:this.model.getAvatarUrl(),avatarShape:this.model.getAvatarShape()}},setSelected:function(t){this.rendered&&this.set("isSelected",t)},setFocused:function(t){this.rendered&&this.set("isFocused",t)},_onSelect:function(t){t.preventDefault(),s.isFunction(this.onSelect)&&this.onSelect(this,this.model)},_onFocus:function(t){t.preventDefault(),s.isFunction(this.onFocus)&&this.onFocus(this,this.model)},_onBlur:function(t){t.preventDefault(),s.isFunction(this.onBlur)&&this.onBlur(this,this.model)},_onChangeIsSelected:function(t,e){this.$el.toggleClass(this.get("selectedClass"),e)},_onChangeIsFocused:function(t,e){this.$el.toggleClass(this.get("focusedClass"),e),e&&this.$el.focus()}});e.exports=r},{"../templates/messaging-share-post-result.tpl":84,"app/components/messaging/views/conversation/conversation-theme":170,lodash:"MicNly","prima/views/base":581}],91:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/views/base"),o=t("prima/mixins/collection-view"),a=t("prima/mixins/keycommands"),r=t("app/lib/scrollbar"),l=t("app/components/messaging/mixins/selectable-subviews"),h=t("./messaging-share-post-result"),c=t("../templates/messaging-share-post-results.tpl"),u=n.extend({className:"messaging-share-post-results",template:c,defaults:{isFocused:!1,focusedView:null,selectedView:null,isRestoreFocus:!1},mixins:[a,o,l],keycommands:{"keydown:left":"_onKeyPressLeft","keydown:right":"_onKeyPressRight","keydown:backspace":"_onKeyPressBackspace","keydown:shift+backspace":"_onKeyPressBackspace"},subviews:{resultView:{constructor:h,options:function(t){return{onSelect:s.bind(t._onSubviewSelect,t),onFocus:s.bind(s.partial(t._setIsFocusedDebounced,!0),t),onBlur:s.bind(s.partial(t._setIsFocusedDebounced,!1),t)}},collection:function(t){return t.collection}}},initialize:function(t){t=s.extend({},t),s.extend(this.attributes,s.pick(t,s.keys(this.defaults))),s.extend(this,s.pick(t,"collection","selectedRecipientModel","keyboardNamespace","keyboardManager")),this.keyboardViewName="resultView",this.disableKeys()},afterRenderSubviews:function(){this.listenTo(this.collection,"reset update",this._onCollectionChange),this.listenTo(this,"change:isFocused",this._onChangeIsFocused),this.listenTo(this,"change:focusedView",this._onChangeFocusedView),this.listenTo(this,"change:selectedView",this._onChangeSelectedView),this.listenTo(this.selectedRecipientModel,"change:participant",this._onChangeSelectedRecipientModel),this._setIsFocusedDebounced=s.debounce(s.bind(this._setIsFocused,this),0),this.scrollbar=new r(this.$el),this.updateScrollbar()},resetFocus:function(){this.set("focusedView",null),this.deselect(this.keyboardViewName)},toggle:function(t){this.$el.toggle(t),t||this.resetFocus()},focus:function(){var t=this.get("selectedView"),e=this.get("isRestoreFocus"),i=!s.isEmpty(t);i&&this.setSelectedIndex(this.keyboardViewName,s.indexOf(this.resultView,t)),e||i?this.set("focusedView",this.getSelectedView(this.keyboardViewName)):this.focusFirst()},focusFirst:function(){this.set("focusedView",this.selectFirst(this.keyboardViewName))},focusLast:function(){this.set("focusedView",this.selectLast(this.keyboardViewName))},focusNext:function(){this.set("focusedView",this.selectNext(this.keyboardViewName))},focusPrevious:function(){this.set("focusedView",this.selectPrevious(this.keyboardViewName))},isLastFocused:function(){return this.isLastSelected(this.keyboardViewName)},isFirstFocused:function(){return this.isFirstSelected(this.keyboardViewName)},updateScrollbar:function(t){this.rendered&&this.scrollbar&&s.defer(s.bind(this.scrollbar.update,this.scrollbar))},beforeRemove:function(){this.keyboardManager.remove(this.keyboardNamespace),this.scrollbar&&this.scrollbar.destroy()},_onKeyPressLeft:function(t){t.preventDefault(),this.focusPrevious()},_onKeyPressRight:function(t){t.preventDefault(),this.focusNext()},_onKeyPressBackspace:function(t){t.preventDefault()},_onChangeFocusedView:function(t,e){var i=this.previous("focusedView");i&&i.setFocused(!1),e&&e.setFocused(!0)},_onChangeSelectedView:function(t,e){var i=this.previous("selectedView");i&&i.setSelected(!1),e&&e.setSelected(!0)},_onSubviewSelect:function(t,e){var i=t!==this.get("selectedView")?t:null,n=s.isEmpty(i)?null:e;this.selectedRecipientModel.set("participant",n),this.set("selectedView",i)},_setIsFocused:function(t){this.rendered&&this.set("isFocused",t)},_onChangeIsFocused:function(t,e){e?(this.keyboardManager.add(this.keyboardNamespace,this),this.trigger("focus",this)):(this.set("focusedView",null),this.keyboardManager.remove(this.keyboardNamespace),this.trigger("blur",this))},_onCollectionChange:function(){this.resetFocus(),this.updateScrollbar()},_onChangeSelectedRecipientModel:function(t,e){var i;return s.isEmpty(e)?void this.set("selectedView",null):(i=s.find(this.resultView,function(t){return t.model.get("uuid")===e.get("uuid")}),void this.set("selectedView",i))}});e.exports=u},{"../templates/messaging-share-post-results.tpl":85,"./messaging-share-post-result":90,"app/components/messaging/mixins/selectable-subviews":118,"app/lib/scrollbar":433,lodash:"MicNly","prima/mixins/collection-view":544,"prima/mixins/keycommands":547,"prima/views/base":581}],92:[function(t,e,i){"use strict";var s=t("lodash"),n=t("jquery"),o=t("prima/views/base"),a=t("prima/mixins/selectorcache"),r=t("prima/mixins/keycommands"),l=t("../templates/messaging-share-post-search.tpl"),h=o.extend({className:"messaging-share-post-search",template:l,mixins:[a,r],events:{"input [data-js-input]":"_onInputChange","focus [data-js-input]":"_onInputFocus","blur [data-js-input]":"_onInputBlur",click:"_onContainerClick"},defaults:{hasSelectedBlogNameClass:"has-selected-blog",isFocused:!1,currentQuery:""},keycommands:{"keydown:backspace":"_onKeyPressBackspace","keydown:enter":"_onKeyPressEnter"},initialize:function(t){t=s.extend({},t),s.extend(this.attributes,s.pick(t,s.keys(this.defaults))),s.extend(this,s.pick(t,"selectedRecipientModel","keyboardManager","keyboardNamespace")),this.disableKeys()},afterRender:function(){this.listenTo(this.selectedRecipientModel,"change:participant",this._onChangeSelectedRecipient),this.listenTo(this,"change:isFocused",this._onChangeIsFocused),this.listenTo(this,"change:currentQuery",this._onChangeCurrentQuery),this.js$("selected-blog").hide()},focus:function(){this.js$("input").focus()},getQuery:function(){return this.get("currentQuery")},_clearInput:function(){this._setInputValue()},_setInputValue:function(t){t=t||"",this.js$("input").val(t),this._prevVal=t},_getSelectedRecipient:function(){return this.selectedRecipientModel.get("participant")},_hasSelectedRecipient:function(){return!s.isEmpty(this._getSelectedRecipient())},_onChangeSelectedRecipient:function(t,e){this._setBlogPillRecipient(e),s.isEmpty(e)?this._setInputValue(this.get("currentQuery")):this._clearInput()},_setBlogPillRecipient:function(t){var e=!s.isEmpty(t);this.js$("selected-blog").text(e?t.get("name"):"").toggle(e),this.$el.toggleClass(this.get("hasSelectedBlogNameClass"),e)},_setCurrentQuery:function(t,e){e&&this.unset("currentQuery",{silent:!0}),this.set("currentQuery",t)},_onInputChange:function(t){var e,i,s=n(t.currentTarget).val();this._prevVal!==s&&(e=this.get("currentQuery"),i=this._hasSelectedRecipient()&&s===e,this._setCurrentQuery(s,i),this._prevVal=s)},_onKeyPressBackspace:function(t){this._hasSelectedRecipient()&&(t.preventDefault(),this._setCurrentQuery("",!0))},_onKeyPressEnter:function(t){t.preventDefault(),this.trigger("submit",this)},_onContainerClick:function(){this.focus()},_onInputFocus:function(){this.set("isFocused",!0)},_onInputBlur:function(){this.set("isFocused",!1)},_onChangeIsFocused:function(t,e){e?(this.keyboardManager.add(this.keyboardNamespace,this),this.trigger("focus",this)):(this.keyboardManager.remove(this.keyboardNamespace),this.trigger("blur",this))},_onChangeCurrentQuery:function(t,e){e=e||"",this._hasSelectedRecipient()&&this._setBlogPillRecipient(null),s.isEmpty(e)?this.trigger("clear"):this.trigger("search",e)}});e.exports=h},{"../templates/messaging-share-post-search.tpl":86,jquery:"HlZQrA",lodash:"MicNly","prima/mixins/keycommands":547,"prima/mixins/selectorcache":553,"prima/views/base":581}],93:[function(t,e,i){"use strict";var s=t("prima/collection"),n=t("../models/channel-unread-count"),o=s.extend({model:n});e.exports=o},{"../models/channel-unread-count":119,"prima/collection":510}],94:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/collection"),o=t("../models/channel"),a=n.extend({model:o,getSortedModels:function(t){return this.sortBy(function(e){return e.get("uuid")===t?-1:0})},getSortedIds:function(t){var e=this.getSortedModels(t);return s.pluck(s.invoke(e,"toJSON"),"uuid")}});e.exports=a},{"../models/channel":120,lodash:"MicNly","prima/collection":510}],95:[function(t,e,i){"use strict";var s=t("jquery"),n=t("lodash"),o=t("prima/lib/translate"),a=t("prima/collection"),r=t("../models/participant"),l=t("../lib/random-text-responder"),h=a.extend({url:"/svc/conversations/participant_suggestions",model:r,resultCache:{},initialize:function(){return this.getNoResultsFoundMessage=l([o("That isn't anyone."),o("Uh, who?"),o("Huh what?"),o("Never heard of 'em."),o("???"),o("Eh?"),o("Whaaa?")]),a.prototype.initialize.apply(this,arguments)},parse:function(t,e){return n.get(t,"response.blogs")||t},fetchByQuery:function(t,e,i){return i=i||{},n.extend(i,{reset:!0,data:{q:t,participant:e}}),this.fetch(i)},fetchFavorites:function(t,e,i,s){return t=t||8,s=s||{},n.extend(s,{reset:!0,data:{limit:t,participant:e,include_recent:i}}),this.fetch(s)},fetch:function(t){var e=JSON.stringify(n.get(t,"data")),i=new s.Deferred,o=n.get(this.resultCache,e);return this.cancelFetch(),o?(this.reset(o),this.trigger("sync",this),i.resolve(),i):(this._request=a.prototype.fetch.apply(this,arguments),this._request.then(n.bind(function(t){n.set(this.resultCache,e,this.parse(t))},this)).always(n.bind(function(){this._request=null},this)),this._request)},cancelFetch:function(){this._request&&(this._request.abort(),this._request=null)}});e.exports=h},{"../lib/random-text-responder":116,"../models/participant":128,jquery:"HlZQrA",lodash:"MicNly","prima/collection":510,"prima/lib/translate":541}],96:[function(t,e,i){"use strict";var s=t("prima/collection"),n=t("../models/conversation-window"),o=s.extend({model:n});e.exports=o},{"../models/conversation-window":121,"prima/collection":510}],97:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/collection"),o=t("prima/mixins/paginated-fetch"),a=t("../models/conversation"),r=n.extend({url:"/svc/conversations",mixins:[o],model:a,comparator:function(t){return-t.get("last_modified_ts")},_getRoot:function(t){return s.has(t,"response")?s.get(t,"response"):t},parse:function(t,e){return s.get(this._getRoot(t),"conversations")||[]},parsePreviousLink:function(t,e){return s.get(this._getRoot(t),"_links.previous")},parseNextLink:function(t,e){return s.get(this._getRoot(t),"_links.next")},fetchInbox:function(t,e){e=e||{};var i=s.extend({},e.data,{participant:t});return s.extend(e,{cache:!1,remove:!1,skipParseLinks:0!==this.length,data:i}),this.fetch(e)},getUnreadCount:function(){return s.reduce(this.models,function(t,e){return e.isUnread()?t+1:t},0)}});e.exports=r},{"../models/conversation":122,lodash:"MicNly","prima/collection":510,"prima/mixins/paginated-fetch":549}],98:[function(t,e,i){"use strict";var s=t("prima/collection"),n=t("../models/keyboard-stack-item"),o=s.extend({model:n,getByNamespace:function(t){return this.filter(function(e){return this._isNamespaceMatch(t,e.get("namespace"))},this)},_isNamespaceMatch:function(t,e){return t===e?!0:0===e.indexOf(t+":")}});e.exports=o},{"../models/keyboard-stack-item":124,"prima/collection":510}],99:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/collection"),o=t("prima/mixins/paginated-fetch"),a=t("../models/message"),r=n.extend({url:"/svc/conversations/messages",mixins:[o],model:a,comparator:function(t){return t.getTimestamp()},_getRoot:function(t){return s.has(t,"response")?s.get(t,"response.messages"):t},parse:function(t,e){return s.get(this._getRoot(t),"data")||[]},parsePreviousLink:function(t,e){return s.get(this._getRoot(t),"_links.previous")},parseNextLink:function(t,e){return s.get(this._getRoot(t),"_links.next")},poll:function(t){return t=t||{},s.extend(t,{cache:!1,remove:!1,skipParseLinks:!0}),this.fetch(t)}});e.exports=r},{"../models/message":127,lodash:"MicNly","prima/collection":510,"prima/mixins/paginated-fetch":549}],100:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/collection"),o=t("../models/participant"),a=n.extend({model:o,getSortedByChannels:function(t,e){var i=this.clone(),n=e?-1:1,o=t.length;return i.sortBy(function(e){var i=s.indexOf(t,e.get("uuid")),a=i>-1,r=a?o-i:-1;return n*r})},getWithout:function(t){var e=this.clone();return e.filter(function(e){return!s.contains(t,e.get("uuid"))})}});e.exports=a},{"../models/participant":128,lodash:"MicNly","prima/collection":510}],101:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/lib/translate"),o=t("prima/component"),a=t("prima/events"),r=t("prima/utils/url"),l=t("app/lib/currentuser"),h=t("app/lib/block"),c=t("app/components/dialog"),u=t("app/models/tumblelog"),d=t("./lib/messaging-logger"),p=t("./lib/messaging-poller"),m=t("./lib/messaging-event-bus"),g=t("./lib/messaging-unread-manager"),f=t("./lib/messaging-window-manager"),_=t("./lib/messaging-keyboard-manager"),v=t("./views/inbox/inbox-badge"),b=t("./views/tutorial"),y=t("./models/current-blog"),w=t("./models/participant"),x=t("./models/conversation"),C=t("./collections/conversations"),k=t("./collections/channels"),S=t("./collections/compose-recipients"),T=new m,E={CONVERSATION_OPEN_TUMBLELOGS:"messaging:conversation:open:tumblelogs",CONVERSATION_OPEN_MODEL:"messaging:conversation:open:model"},P=o.extend({name:"Messaging",defaults:{blogNetworkQueryParameter:"conversation",blogNetworkQueryParameterPathWhitelist:["/dashboard"],resetPollingTypingDebounceRate:3e4},initialize:function(t){t=s.extend({},t),s.extend(this.attributes,s.pick(t,s.keys(this.defaults))),s.extend(this,s.pick(t,"inboxAnchorEl","inboxPopoverOptions")),this.eventBus=T,this.user=l(),this.channels=this._getChannelsEnabledForMessagingAsCollection(),this.inboxCollection=new C,this.currentBlogModel=new y({channel:this._getInitiallySelectedChannel()}),this.favoritesCollection=new S,this.emptyInboxCollection=new S,this.unreadManager=new g({channels:this.channels}),this.inboxBadge=new v({el:this.inboxAnchorEl,channels:this.channels}).render(),this.messagingLogger=new d,this.keyboardManager=new _,this.windowManager=new f({eventBus:this.eventBus,user:this.user,channels:this.channels,currentBlogModel:this.currentBlogModel,keyboardManager:this.keyboardManager,inboxViewOptions:{favoritesCollection:this.favoritesCollection,emptyInboxCollection:this.emptyInboxCollection,appendFavoritesToInboxLimit:this.getAppendFavoritesToInboxLimit(),isAutoFetch:!1},inboxPopoverOptions:s.extend({autoTeardown:!0,pinnedSide:"bottom",isFixedPosition:!0,pinnedTarget:this.inboxAnchorEl},this.inboxPopoverOptions),conversationViewOptions:{isAutoFetch:!1,isMinimizeEnabled:this.isMinimizeEnabled()}}),this._onConversationMessageInputThrottled=s.throttle(this._onConversationMessageInput,this.get("resetPollingTypingDebounceRate"),{leading:!0,trailing:!1}),this.listenTo(a,E.CONVERSATION_OPEN_TUMBLELOGS,this._onEventBusOpenConversationUsingTumblelogModels),this.listenTo(a,E.CONVERSATION_OPEN_MODEL,this._onEventBusOpenConversationUsingModel),this.listenTo(this.eventBus,this.eventBus.CONVERSATION_OPEN_CONVERSATION_MODEL,this._onOpenConversationUsingConversationModel),this.listenTo(this.eventBus,this.eventBus.CONVERSATION_OPEN_PARTICIPANT_MODELS,this._onOpenConversationUsingParticipantModels),this.listenTo(this.eventBus,this.eventBus.CONVERSATION_OPEN_TUMBLR_URL,this._onConversationClickBlog),this.listenTo(this.eventBus,this.eventBus.CONVERSATION_DELETE_MODEL,this._onConversationDelete),this.listenTo(this.eventBus,this.eventBus.CONVERSATION_FETCHING,this._onConversationFetching),this.listenTo(this.eventBus,this.eventBus.BLOCK,this._onBlock),this.listenTo(this.eventBus,this.eventBus.CONVERSATION_MESSAGE_SENT,this._onConversationMessageSent),this.listenTo(this.eventBus,this.eventBus.CONVERSATION_MESSAGE_FAILED,this._onConversationMessageFailed),this.listenTo(this.eventBus,this.eventBus.CONVERSATION_MESSAGE_INPUT,this._onConversationMessageInputThrottled),this.listenTo(a,"toaster:updateMessagingUnreadCounts",this._onPollUpdate),this.listenTo(this.currentBlogModel,"change",this._onCurrentBlogModelChange),this.listenTo(this.windowManager,"change",this._onWindowManagerChange),this.listenTo(this.unreadManager,"change:channel",this._onUnreadManagerChannelChange),this.listenTo(this.unreadManager,"change:conversation",this._onUnreadManagerConversationChange),this.listenTo(this.windowManager,"inbox:added",this._onWindowManagerInboxAdded),this.listenTo(this.windowManager,"inbox:removed",this._onWindowManagerInboxRemoved),this.listenTo(this.windowManager,"conversation:added",this._onWindowManagerConversationAdded),this.listenTo(this.windowManager,"conversation:removed",this._onWindowManagerConversationRemoved),this.messagingPoller=new p({channels:this.channels,user:this.user,callback:s.bind(this._onPollUpdate,this),frequency:this.getPollingFrequencyInbox()}),this.hasTutorial()&&this.openTutorialPopover(),this._onWindowManagerChange(this.windowManager),this._processMessagingQuery()},render:function(){this.inboxAnchorEl&&this.inboxAnchorEl.on("click.messaging",s.bind(this._onClickInboxAnchor,this))},openInboxPopover:function(){this.windowManager.addInbox(this.inboxCollection),this.tutorialPopover&&this.tutorialPopover.hideTutorial()},openConversationPopover:function(t,e){var i;return s.isEmpty(t.get("participant").get("uuid"))&&t.set("participant",t.get("participants").get(this.getCurrentChannel().get("uuid"))),i=this.windowManager.getOpenConversationPopover(t),this.windowManager.removeInbox(this.inboxCollection),i?void i.refresh(t):(this.isMinimizeEnabled()||this.windowManager.removeConversations(),this.windowManager.addConversation(t,{context:e}),void(this.tutorialPopover&&this.tutorialPopover.hideTutorial()))},openTutorialPopover:function(){return this.tutorialPopover?void 0:(this.tutorialPopover=new b({eventBus:this.eventBus,viewOptions:{title:n("Talk to a Tumblr"),content:n("Just tap this balloon, type the Tumblr's name, and start a conversation."),ok_text:n("Send a message"),pinnedTarget:this.inboxAnchorEl,fixed_position:s.get(this.inboxPopoverOptions,"isFixedPosition",!0)}}),this.listenToOnce(this.tutorialPopover,"dismiss",s.bind(function(){s.delay(s.bind(function(){this.openInboxPopover()},this),250)},this)),this.listenToOnce(this.tutorialPopover,"hide",s.bind(function(){this.stopListening(this.tutorialPopover),this.tutorialPopover=null},this)),this.tutorialPopover.render(),this.tutorialPopover)},fetchInbox:function(){var t=this.getCurrentBlogId();if(this._pendingInboxRequest&&this._pendingInboxBlog){if(t===this._pendingInboxBlog)return;this._pendingInboxRequest.abort()}this._pendingInboxBlog=t,this._pendingInboxRequest=this.inboxCollection.fetchInbox(t).always(s.bind(function(){this._pendingInboxRequest=null,this._pendingInboxBlog=null},this))},getCurrentChannel:function(){return this.currentBlogModel.getChannel()},getCurrentBlogId:function(){return this.currentBlogModel.getId()},getPollingFrequencyInbox:function(){return s.get(this.data,"polling_frequency_inbox")},getPollingFrequencyConversation:function(){return s.get(this.data,"polling_frequency_conversation")},hasTutorial:function(){return s.get(this.data,"has_tutorial")},getAppendFavoritesToInboxLimit:function(){return s.get(this.data,"append_favorites_to_inbox_limit")},isMinimizeEnabled:function(){return s.get(this.data,"is_minimize_enabled",!1)},getBackoffRatesInbox:function(){return[1,1,2,2,4]},getBackoffRatesConversation:function(){return[1,1,1,1,2,2,2,2,4,4,4,4,8,8,8,8,16]},_onWindowManagerInboxAdded:function(t,e){this.fetchInbox(),this.messagingLogger.logInboxOpened()},_onWindowManagerInboxRemoved:function(t,e){this.messagingLogger.logInboxClosed()},_onWindowManagerConversationAdded:function(t,e,i){e.fetch().always(s.bind(function(){this.messagingLogger.logConversationOpened(t,s.get(i,"context"))},this)),e.focus()},_onWindowManagerConversationRemoved:function(t,e,i){this.messagingLogger.logConversationClosed(t,s.get(i,"context"))},_getChannelsEnabledForMessagingAsCollection:function(){return new k(s.invoke(this.user.getChannelsEnabledForMessaging(),"toJSON"))},_getInitiallySelectedChannel:function(){return this.channels.findWhere({is_current:!0})||s.first(this.channels.models)},_onClickInboxAnchor:function(t){t.preventDefault(),this.openInboxPopover()},_onEventBusOpenConversationUsingTumblelogModels:function(t,e){this._openConversationUsingTumblelogModels(t,e)},_onEventBusOpenConversationUsingModel:function(t,e){this.openConversationPopover(t,e)},_onOpenConversationUsingConversationModel:function(t,e){this.openConversationPopover(t,e)},_openConversationUsingTumblelogModels:function(t,e){var i=s.map(t,function(t){return new w(t.toJSON(),{parse:!0})});this._onOpenConversationUsingParticipantModels(i,e)},_onOpenConversationUsingParticipantModels:function(t,e){var i=new w(this.getCurrentChannel().toJSON()),s=new x({participants:[i].concat(t),participant:i});this.openConversationPopover(s,e)},_onPollUpdate:function(t,e){t=s.get(t,"unread_messages"),s.get(t,"error")!==!0&&this.unreadManager.setData(t)},_onConversationClickBlog:function(t){t=t||{},t.originalEvent&&t.originalEvent.preventDefault(),a.trigger("peepr-open-request",{url:t.url,tumblelog_name:t.blogName,post_id:t.postId})},_onBlock:function(t,e){s.isEmpty(t)||h.confirmBlock(t).then(s.bind(function(){h.block(t).then(s.bind(function(){this._onBlockSuccess(t,e)},this))},this))},_onBlockSuccess:function(t,e){s.isEmpty(t)||(e&&(this.windowManager.removeConversation(e),this.inboxCollection.remove(e)),a.trigger("blocks:block_added",{loggingData:{from:"messaging"}}),this.messagingLogger.logBlock(t))},_copyCollectionData:function(t,e){e.reset(t.models),e.setNextLink(t.getNextLink())},_onCurrentBlogModelChange:function(){var t=this.currentBlogModel.getPrevChannel(),e=this.currentBlogModel.getChannel();t&&this._copyCollectionData(this.inboxCollection,t.get("conversations")),e&&this._copyCollectionData(e.get("conversations"),this.inboxCollection),this.fetchInbox()},_onConversationDelete:function(t){c.confirm(n("Permanently delete this conversation?"),s.bind(function(){this.messagingLogger.logConversationDeleted(t),t.destroy(),this.windowManager.removeConversation(t),this.inboxCollection.remove(t.get("id"))},this),null,n("Delete"),n("Nevermind"))},_onConversationFetching:function(t){this.unreadManager.setConversationModelCount(t,0)},_onUnreadManagerChannelChange:function(t,e){var i=this.getCurrentChannel(),n=s.sum(e);this.windowManager.get("isInboxOpen")&&i===t&&this.fetchInbox(),t.set("unread_messages_count_sum",n)},_onUnreadManagerConversationChange:function(t,e,i){var s;this.windowManager.get("isConversationOpen")&&(s=this.windowManager.getOpenConversationModelByIdAndParticipant(t,i.get("uuid")),s&&s.set("unreadCount",e))},_onWindowManagerChange:function(t){var e,i,s=t.get("isInboxOpen"),n=t.get("isConversationOpen");return s||n?(n?(e=this.getPollingFrequencyConversation(),i=this.getBackoffRatesConversation()):(e=this.getPollingFrequencyInbox(),i=this.getBackoffRatesInbox()),this.messagingPoller.setFrequency(e),this.messagingPoller.setBackoffRates(i),void this.messagingPoller.start()):void this.messagingPoller.stop()},_onConversationMessageSent:function(t,e){this.messagingLogger.logMessageSent(t,e)},_onConversationMessageFailed:function(t,e){this.messagingLogger.logMessageFailed(t,e)},_onConversationMessageInput:function(t,e){this.messagingPoller.resetPollingFrequency(),this.messagingPoller.poll()},_getRecipientURLParam:function(){return r.getParameter(this.get("blogNetworkQueryParameter"))},_removeRecipientURLParam:function(){var t,e=window.location,i=this.get("blogNetworkQueryParameter"),n=r.parseUrl(e),o=s.get(n,"query"),a=s.get(n,"path","");s.isEmpty(o)||(t=r.getQueryStringHash(o),!s.isEmpty(t)&&s.has(t,i)&&(delete t[i],history.replaceState({},null,r.buildUrl(a,t))))},_openConversationFromBlogName:function(t,e){var i=new u({name:t});return i.fetch_popover_data().then(s.bind(function(){return s.isEmpty(i.get("uuid"))?void 0:this._openConversationUsingTumblelogModels([i],e)},this))},_processMessagingQuery:function(){var t=window.location,e=r.parseUrl(t),i=e.path;if(s.contains(this.get("blogNetworkQueryParameterPathWhitelist"),i)){var n=this._getRecipientURLParam();s.isEmpty(n)||(this._removeRecipientURLParam(),this._openConversationFromBlogName(n,"blog-network"))}}});e.exports=P},{"./collections/channels":94,"./collections/compose-recipients":95,"./collections/conversations":97,"./lib/messaging-event-bus":109,"./lib/messaging-keyboard-manager":110,"./lib/messaging-logger":111,"./lib/messaging-poller":112,"./lib/messaging-unread-manager":113,"./lib/messaging-window-manager":114,"./models/conversation":122,"./models/current-blog":123,"./models/participant":128,"./views/inbox/inbox-badge":172,"./views/tutorial":185,"app/components/dialog":44,"app/lib/block":430,"app/lib/currentuser":432,"app/models/tumblelog":436,lodash:"MicNly","prima/component":511,"prima/events":512,"prima/lib/translate":541,"prima/utils/url":579}],102:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/component"),o=t("../collections/keyboard-stack"),a=n.extend({name:"BaseKeyboardManager",defaults:{isDebugEnabled:!1,keepInactiveItems:!0,allowMultipleActiveViews:!1},initialize:function(t){t=s.extend({},t),s.extend(this.attributes,s.pick(t,s.keys(this.defaults))),this.collection=new o,this.listenTo(this.collection,"add",this._onAddItem),this.listenTo(this.collection,"remove",this._onRemoveItem),this.listenTo(this.collection,"change:isActive",this._onItemActiveChange)},addKeyboardAccess:s.noop,removeKeyboardAccess:s.noop,add:function(t,e){return t&&e?this.collection.get(t)?!1:(this.get("keepInactiveItems")||this.get("allowMultipleActiveViews")||this.collection.remove(this.collection.models),this.collection.unshift({namespace:t,view:e}),this._adjustActiveStates(),!0):!1},remove:function(t){var e=this.collection.getByNamespace(t);return s.isEmpty(e)?!1:(this.collection.remove(e),this._adjustActiveStates(),!0)},toggle:function(t,e,i){return i?this.add(t,e):this.remove(t)},_onAddItem:function(t){return this.addKeyboardAccess(t.get("view"))},_onRemoveItem:function(t){return this.removeKeyboardAccess(t.get("view"))},_adjustActiveStates:function(){var t,e;0!==this.collection.length&&(t=this.collection.first(),e=this.collection.rest(),t&&t.set("isActive",!0),this.get("allowMultipleActiveViews")||s.each(e,function(t){t.set("isActive",!1)},this))},_onItemActiveChange:function(t,e){return e?this.addKeyboardAccess(t.get("view")):this.removeKeyboardAccess(t.get("view"))}});e.exports=a},{"../collections/keyboard-stack":98,lodash:"MicNly","prima/component":511}],103:[function(t,e,i){"use strict";var s=t("lodash"),n=t("jquery"),o=t("prima/component"),a=o.extend({name:"BasePoller",defaults:{url:null,requestType:"GET",dataType:"JSON",cache:!1,frequency:6e4,backoffRates:[],stopAfterNumErrors:3,isPolling:!1,hasPolled:!1,isDebugEnabled:!1},initialize:function(t){t=s.extend({},t),s.extend(this.attributes,s.pick(t,s.keys(this.defaults))),s.extend(this,s.pick(t,"callback")),this.currentErrorCount=0,this.currentUnchangedCount=0},start:function(t){this.set("isPolling",!0),t?this.scheduleNextPoll():this.poll()},stop:function(){this.set("isPolling",!1),this.cancel()},cancel:function(){this.cancelCurrent(),this.cancelNext()},cancelCurrent:function(){this._currentRequest&&(s.result(this._currentRequest,"abort"),this._currentRequest=null)},cancelNext:function(){this._nextPollToken&&(clearTimeout(this._nextPollToken),this._nextPollToken=null)},beforeRemove:function(){this.stop()},setFrequency:function(t){this.set("frequency",t),this.resetPollingFrequency()},setBackoffRates:function(t){this.set("backoffRates",t),this.resetPollingFrequency()},resetPollingFrequency:function(){this.currentUnchangedCount=0,this.set("hasPolled",!1)},poll:function(){this.cancel(),this._lastPollTime=(new Date).getTime();var t=this.makeRequest.call(this);return t.done(s.bind(this._onRequestSuccess,this)).fail(s.bind(this._onRequestFail,this)).always(s.bind(this._onRequestAlways,this)),this._currentRequest=t,t},getRequestData:function(){return{}},hasResponseChanged:function(){return!0},resetErrorCount:function(){this.currentErrorCount=0,this.start()},parse:function(t){return t},getBackoffRate:function(){var t,e=this.get("backoffRates");return s.isEmpty(e)||!s.isArray(e)||0===this.currentUnchangedCount?1:(t=Math.min(this.currentUnchangedCount,e.length)-1,Math.max(1,s.get(e,t,1)))},getPollingFrequency:function(){return this.get("frequency")*this.getBackoffRate()},makeRequest:function(){var t=this.getRequestData(),e={url:this.get("url"),type:this.get("requestType"),dataType:this.get("dataType"),cache:this.get("cache"),data:t};return n.ajax(e)},scheduleNextPoll:function(){var t=this.getPollingFrequency();return this.set("hasPolled",!0),this.get("isPolling")?void(!s.isFinite(t)||0>=t||(this.currentErrorCount<=this.get("stopAfterNumErrors")?(this.cancelNext(),this._nextPollToken=setTimeout(s.bind(this.poll,this),t)):this.stop())):!1},_onRequestSuccess:function(t){this.currentErrorCount=0,t=this.parse(t),this.callback&&this.callback(t,this._lastPollTime),this.hasResponseChanged(t)||!this.get("hasPolled")?this.currentUnchangedCount=0:this.currentUnchangedCount++},_onRequestFail:function(){this.currentErrorCount++},_onRequestAlways:function(){this.scheduleNextPoll()}});e.exports=a},{jquery:"HlZQrA",lodash:"MicNly","prima/component":511}],104:[function(t,e,i){"use strict";var s=t("lodash"),n=t("app/lib/scrollbar"),o=n.extend({defaults:s.defaults({isDisabled:!1,isAtTop:!1,isAtBottom:!1,topThreshold:50,bottomThreshold:50},n.prototype.defaults),initialize:function(t){return this.options=t||{},
n.prototype.initialize.call(this,this.options.el,this.options)},render:function(){return this.listenTo(this,"change:isAtTop",this._changeIsAtTop),this.listenTo(this,"change:isAtBottom",this._changeIsAtBottom),n.prototype.render.apply(this,arguments)},_stealScroll:function(t){return this.get("isDisabled")?(t.preventDefault(),void t.stopPropagation()):n.prototype._stealScroll.apply(this,arguments)},update:function(){return this._updateInfiniteScrollFlags(),n.prototype.update.apply(this,arguments)},_onScrollStop:function(){return this._updateInfiniteScrollFlags(),n.prototype._onScrollStop.apply(this,arguments)},getCurrentPositions:function(){return{height:this._currentHeight,scrollBottom:this._currentScrollBottom,scrollTop:this._currentScrollTop}},isAtTop:function(){return this.get("isAtTop")},isAtBottom:function(){return this.get("isAtBottom")},_isAtTop:function(t){return this._isUserScroll()&&!this.get("isDisabled")&&this._currentScrollTop<=t&&this._currentHeight>t},_isAtBottom:function(t){return this._isUserScroll()&&!this.get("isDisabled")&&this._currentScrollBottom<=t&&this._currentHeight>t},_isUserScroll:function(){var t,e=5;return s.isFinite(this._previousScrollHeight)?(t=Math.abs(this._currentScrollHeight-this._previousScrollHeight),e>=t):!1},setDisabled:function(t){this.set("isDisabled",t)},isDisabled:function(){return this.get("isDisabled")},_setCurrentPositions:function(){var t=this.container;this._previousScrollHeight=this._currentScrollHeight,this._currentScrollHeight=t.scrollHeight,this._currentHeight=t.clientHeight,this._currentScrollBottom=t.scrollHeight-t.scrollTop-this.container.clientHeight,this._currentScrollTop=t.scrollTop},_updateInfiniteScrollFlags:function(){return this.destroyed?!1:(this._setCurrentPositions(),void this.set({isAtTop:this._isAtTop(this.get("topThreshold")),isAtBottom:this._isAtBottom(this.get("bottomThreshold"))}))},_changeIsAtTop:function(t,e){this.trigger("scrolltop",e)},_changeIsAtBottom:function(t,e){this.trigger("scrollbottom",e)}});e.exports=o},{"app/lib/scrollbar":433,lodash:"MicNly"}],105:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/class"),o=n.extend({name:"unknown",formatters:{},constructor:function(t){this.options=t||{},s.isFunction(this.formatters)?this.formatters=this.formatters():this.formatters=s.clone(this.formatters||{})},registerFormatter:function(t,e){this.formatters[t]=e},getFormatter:function(t){return s.result(this.formatters,t)},escape:function(t){return t},applyFormatting:function(t,e){return this.escape(t)},postFilter:function(t){return t},render:function(t,e){return this.postFilter(this.applyFormatting(t,e))}});e.exports=o},{lodash:"MicNly","prima/class":509}],106:[function(t,e,i){"use strict";var s=t("lodash"),n=t("../base"),o=t("./link"),a=n.extend({name:"html",formatters:{link:o},escape:function(t){return s.escape(t)},applyFormatting:function(t,e){var i=s.bind(this.escape,this),n=s.bind(this.getFormatter,this),o={};s.forEach(e,function(t){var e=n(t.type);if(e){var i=t.position,a=t.attributes,r=i[0],l=i[1];s.isEmpty(o[r])&&(o[r]=[]),s.isEmpty(o[l])&&(o[l]=[]),o[r].push(s.bind(e.open,this,a)),o[l].unshift(s.bind(e.close,this,a))}},this);var a,r,l=s.sortBy(s.keys(o),function(t){return s.parseInt(t)}),h="",c=0;return s.forEach(l,function(e){a=o[e],r=t.substr(c,e-c),h+=i(r),s.forEach(a,function(t){h+=t()}),c=e},this),r=t.substr(c),h+=i(r)}});e.exports=a},{"../base":105,"./link":107,lodash:"MicNly"}],107:[function(t,e,i){"use strict";function s(t){return n(t).omit(n.isUndefined).reduce(function(t,e,i){return(t?t+" ":"")+o('%s="%s"',n.escape(i),n.escape(e))},"")}var n=t("lodash"),o=t("sprintf-js").sprintf,a={open:function(t){var e=s({"data-js-tumblelog-name":t.blog_name,"data-js-post-id":t.post_id,target:"_blank",href:t.url});return"<a "+e+">"},close:function(t){return"</a>"}};e.exports=a},{lodash:"MicNly","sprintf-js":"qPOUxN"}],108:[function(t,e,i){e.exports={html:t("./formatters/html")}},{"./formatters/html":106}],109:[function(t,e,i){var s=t("backbone"),n=t("lodash"),o={CONVERSATION_FETCHING:"conversation:fetching",CONVERSATION_OPEN_CONVERSATION_MODEL:"conversation:open:model:conversation",CONVERSATION_OPEN_PARTICIPANT_MODELS:"conversation:open:model:partipants",CONVERSATION_OPEN_TUMBLR_URL:"conversation:open:tumblr:url",CONVERSATION_DELETE_MODEL:"conversation:delete:model",CONVERSATION_MESSAGE_SENT:"conversation:message:sent",CONVERSATION_MESSAGE_FAILED:"conversation:message:failed",CONVERSATION_MESSAGE_INPUT:"conversation:message:input",BLOCK:"block"},a=function(){};a.extend=s.Model.extend,n.extend(a.prototype,s.Events),n.extend(a.prototype,o),e.exports=a},{backbone:"5kFNoY",lodash:"MicNly"}],110:[function(t,e,i){"use strict";var s=t("lodash"),n=t("./base-keyboard-manager"),o=n.extend({name:"MessagingKeyboardManager",addKeyboardAccess:function(t){return s.isFunction(s.get(t,"soloKeys"))?(t.enableKeys(),t.soloKeys(!0),!0):!1},removeKeyboardAccess:function(t){return s.isFunction(s.get(t,"unSoloKeys"))?(t.disableKeys(),t.unSoloKeys(),!0):!1}});e.exports=o},{"./base-keyboard-manager":102,lodash:"MicNly"}],111:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/component"),o=t("prima/events"),a=n.extend({name:"MessagingLogger",defaults:{namespace:"messaging-interaction",isDebugEnabled:!1},initialize:function(t){t=s.extend({},t),s.extend(this.attributes,s.pick(t,s.keys(this.defaults)))},logInboxOpened:function(){this._logIt("inbox:open")},logInboxClosed:function(){this._logIt("inbox:closed")},logConversationOpened:function(t,e){this._logIt("conversation:open",{conversationId:t.get("id"),context:e})},logConversationClosed:function(t,e){this._logIt("conversation:closed",{conversationId:t.get("id"),context:e})},logConversationDeleted:function(t){this._logIt("conversation:deleted",{conversationId:t.get("id")})},logConversationStarted:function(t,e){this._logIt("conversation:started",{context:e})},logMessageSent:function(t,e){!s.isEmpty(e)&&e.isNew()&&this.logConversationStarted(e),this._logIt("message:sent",this._getMessageLoggingData(t,e))},logMessageFailed:function(t,e){this._logIt("message:failure",this._getMessageLoggingData(t,e))},logFollow:function(t){this._logIt("conversation:follow",{blogName:t})},logBlock:function(t){this._logIt("block",{blockingBlog:t.currentTumblelog,blockedBlog:t.blockedTumblelog})},_getMessageLoggingData:function(t,e){var i,n,o,a;return s.isEmpty(t)?null:(i=t.isPost()?0:(t.getMessage()||"").length,n=t.get("type"),o=t.get("context"),a={conversationId:e?e.get("id"):null,messageLength:i,messageType:n},s.isEmpty(o)||s.extend(a,{context:o}),a)},_logIt:function(t,e){e=e||{},o.trigger(this.get("namespace")+":"+t,{loggingData:e})}});e.exports=a},{lodash:"MicNly","prima/component":511,"prima/events":512}],112:[function(t,e,i){"use strict";var s=t("lodash"),n=t("./base-poller"),o=n.extend({name:"MessagingPoller",defaults:s.defaults({url:"/services/poll",frequency:15e3},n.prototype.defaults),initialize:function(t){return t=s.extend({},t),s.extend(this.attributes,s.pick(t,s.keys(this.defaults))),s.extend(this,s.pick(t,"channels","user")),this._requestData={token:this.user.get("polling_token"),unread_messages:!0,mention_keys:this.channels.pluck("mention_key").join(",")},n.prototype.initialize.apply(this,arguments)},getRequestData:function(){return this._requestData},hasResponseChanged:function(t){return!s.isEmpty(s.get(t,"unread_messages"))}});e.exports=o},{"./base-poller":103,lodash:"MicNly"}],113:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/component"),o=t("../collections/channels-unread-count"),a=n.extend({name:"MessagingUnreadManager",defaults:{dataChannelKey:"mention_key",overridesExpirationInMs:500},initialize:function(t){t=s.extend({},t),s.extend(this.attributes,s.pick(t,s.keys(this.defaults))),s.extend(this,s.pick(t,"channels"));var e=this.channels.map(function(t){return{channelId:t.get("uuid")}});this.unreadCollection=new o(e),this.unreadCollectionOverrides=new o(e),this.listenTo(this.unreadCollection,"change:data",this._onUnreadCollectionChange)},setData:function(t){this._pruneOverrides(),this._updateUnreadCollection(t),this.unreadData=t},setConversationModelCount:function(t,e){var i,s=t.get("id"),n=t.get("participant").get("uuid"),o=this.unreadCollectionOverrides.findWhere({channelId:n});o&&(i=o.get("data")||{},i[s]=e,o.set({data:i,updateDate:new Date}),this._updateUnreadCollection(this.unreadData))},_getOverridesData:function(){var t=this.get("dataChannelKey");return this.unreadCollectionOverrides.reduce(function(e,i){var n=i.get("data"),o=this.channels.get(i.get("channelId")),a=o.get(t);return s.isEmpty(n)||(e[a]=n),e},{},this)},_pruneOverrides:function(){var t=new Date,e=this.get("overridesExpirationInMs");this.unreadCollectionOverrides.each(function(i){var n=i.get("updateDate");s.isDate(n)&&t-n>e&&i.set({updateDate:null,data:null})})},_updateUnreadCollection:function(t,e){var i=this._getOverridesData();this.unreadCollection.each(function(e){var n=this.channels.get(e.get("channelId")),o=n.get(this.get("dataChannelKey")),a=s.get(t,o),r=s.get(i,o);s.isEmpty(r)||(a=s.merge({},a,r)),e.set("data",a)},this)},_onUnreadCollectionChange:function(t){var e=t.get("data")||null,i=this.channels.get(t.get("channelId"));this.trigger("change:channel",i,e),s.each(e,function(t,e){this.trigger("change:conversation",e,t,i)},this)}});e.exports=a},{"../collections/channels-unread-count":93,lodash:"MicNly","prima/component":511}],114:[function(t,e,i){"use strict";var s=t("jquery"),n=t("lodash"),o=t("prima/component"),a=t("../collections/conversation-windows"),r=t("../views/inbox/inbox-popover"),l=t("../views/conversation/conversation-popover"),h=o.extend({name:"MessagingWindowManager",defaults:{isInboxOpen:!1,isConversationOpen:!1,inboxAnimationSpeed:100,conversationAnimationSpeed:250,conversationPopoversContainerClass:"messaging-conversation-popovers",openConversationsContainerClass:"messaging-open-conversations",minimizedConversationsContainerClass:"messaging-minimized-conversations"},initialize:function(t){t=n.extend({},t),n.extend(this.attributes,n.pick(t,n.keys(this.defaults))),n.extend(this,n.pick(t,"eventBus","user","channels","currentBlogModel","keyboardManager","inboxViewOptions","inboxPopoverOptions","conversationViewOptions","conversationPopoverOptions")),this.openConversations=new a,this.listenTo(this.openConversations,"add remove",this._onConversationsCollectionChange)},addInbox:function(t,e){return this.get("isInboxOpen")?void 0:(this.inboxCollection=t,this.inboxPopover=this._createInboxPopover(t),this.trigger("inbox:adding",t,this.inboxPopover,e),setTimeout(n.bind(function(){this._afterInboxOpened(e)},this),this.get("inboxAnimationSpeed")),this.listenToOnce(this.inboxPopover,"close",function(){this._onInboxClose(e)}),this.inboxPopover)},removeInbox:function(t){t===this.inboxCollection&&this.inboxPopover&&this.inboxPopover.teardown()},addConversation:function(t,e){var i=this._createConversationPopover(t);return this.trigger("conversation:adding",t,i,e),setTimeout(n.bind(function(){this.trigger("conversation:added",t,i,e)},this),this.get("conversationAnimationSpeed")),this.openConversations.add({model:t,view:i,options:e}),i},removeConversation:function(t,e){var i=this._getWindowModel(t);return i?this._removeConversationWindowModel(i,e):void 0},setConversationMinimized:function(t,e){var i,s=this.getOpenConversationPopover(t);s&&(i=e?this._getMinimizedConversationsContainer():this._getOpenConversationsContainer(),i.append(s.$el))},removeConversations:function(t){this.openConversations.each(function(t){this._removeConversationWindowModel(t,!0)},this)},getOpenConversationPopover:function(t){var e=this._getWindowModel(t);return e?e.get("view"):void 0},getOpenConversationModelByIdAndParticipant:function(t,e){var i=this.openConversations.find(function(i){var s=i.get("model");return s.get("id")===t&&s.get("participant").get("uuid")===e});return i?i.get("model"):void 0},_createConversationPopover:function(t){var e,i=n.bind(function(e){return n.extend({},this.conversationViewOptions,{eventBus:this.eventBus,user:this.user,channels:this.channels,model:t,popoverContainer:e.el,keyboardManager:this.keyboardManager})},this),s=n.extend({},this.conversationPopoverOptions,{viewOptions:i}),o=new l(s);o.render(),e=o.getView(),this.listenToOnce(e,"close",function(){this.removeConversation(t)}),this.listenTo(e,"change:isMinimized",function(e,i){this.setConversationMinimized(t,i)});var a=this._getOpenConversationsContainer();return a.append(o.$el),this._removeTimer&&clearTimeout(this._removeTimer),o},_createInboxPopover:function(t){var e=n.bind(function(e){return n.extend({},this.inboxViewOptions,{eventBus:this.eventBus,collection:t,user:this.user,channels:this.channels,currentBlogModel:this.currentBlogModel,keyboardManager:this.keyboardManager,popoverContainer:e.el})},this),i=n.extend({},this.inboxPopoverOptions,{viewOptions:e}),s=new r(i);return s.render(),s},_removeConversationPopover:function(t,e){this.stopListening(t.getView()),e?t.remove():t.teardown(),this._removeTimer&&(clearTimeout(this._removeTimer),this._removeTimer=null),0===this.openConversations.length&&(this._removeTimer=setTimeout(n.bind(function(){0===this.openConversations.length&&this._removeConversationPopoversContainer(),this._removeTimer=null},this),this.get("conversationAnimationSpeed")))},_onConversationsCollectionChange:function(){this.set("isConversationOpen",this.openConversations.length>0)},_onInboxClose:function(t){this.trigger("inbox:removing",this.inboxCollection,this.inboxPopover,t),setTimeout(n.bind(function(){this._afterInboxClosed(t)},this),this.get("inboxAnimationSpeed"))},_afterInboxOpened:function(t){this.set("isInboxOpen",!0),this.trigger("inbox:added",this.inboxCollection,this.inboxPopover,t)},_afterInboxClosed:function(t){this.set("isInboxOpen",!1),this.trigger("inbox:removed",this.inboxCollection,this.inboxPopover,t),this.inboxPopover=null,this.inboxCollection=null},_getConversationsPopoversContainer:function(){return this.conversationsPopoversContainer||(this.conversationsPopoversContainer=s("<div />").addClass(this.get("conversationPopoversContainerClass")).appendTo(s("body"))),this.conversationsPopoversContainer},_getOpenConversationsContainer:function(){var t;return this.openConversationsContainer||(t=this._getConversationsPopoversContainer(),this.openConversationsContainer=s("<div />").addClass(this.get("openConversationsContainerClass")).appendTo(t)),this.openConversationsContainer},_getMinimizedConversationsContainer:function(){var t;return this.minimizedConversationsContainer||(t=this._getConversationsPopoversContainer(),this.minimizedConversationsContainer=s("<div />").addClass(this.get("minimizedConversationsContainerClass")).appendTo(t)),this.minimizedConversationsContainer},_removeConversationPopoversContainer:function(){this.conversationsPopoversContainer&&(this.conversationsPopoversContainer.remove(),this.conversationsPopoversContainer=null),this.openConversationsContainer&&(this.openConversationsContainer.remove(),this.openConversationsContainer=null),this.minimizedConversationsContainer&&(this.minimizedConversationsContainer.remove(),this.minimizedConversationsContainer=null)},_getWindowModel:function(t){var e=t.get("participant").get("uuid"),i=t.get("participants").pluck("uuid");return this.openConversations.find(function(t){var s=t.get("model"),o=s.get("participant").get("uuid"),a=s.get("participants").pluck("uuid");return o===e&&n.union(i,a).length===a.length})},_removeConversationWindowModel:function(t,e){var i=t.get("view"),s=t.get("model"),o=t.get("options");this.openConversations.remove(t),this._removeConversationPopover(i,e),this.trigger("conversation:removing",s,i,o),e?this.trigger("conversation:removed",s,i,o):setTimeout(n.bind(function(){this.trigger("conversation:removed",s,i,o)},this),this.get("conversationAnimationSpeed"))}});e.exports=h},{"../collections/conversation-windows":96,"../views/conversation/conversation-popover":169,"../views/inbox/inbox-popover":180,jquery:"HlZQrA",lodash:"MicNly","prima/component":511}],115:[function(t,e,i){"use strict";function s(t,e){return t.scrollHeight-e.maxHeight<5}function n(t){return parseInt(h(t).css("max-height"),10)}function o(t,e,i){var n,o=t.nodeValue,a=l.get(e,"truncationString","..."),r="",h="",c=0,u=o.length;if(s(i,e))return!0;for(;u>=c;)n=c+u>>>1,r=l.trimRight(o.substring(0,n))+a,t.nodeValue=r,s(i,e)?(c=n+1,r.length>h.length&&(h=r)):u=n-1;return h.length>0?(t.nodeValue=h,!0):(t.nodeValue="",!1)}function a(t,e,i){var s=h(t).contents();l.each(s.get().reverse(),function(t){t.nodeType===Node.TEXT_NODE?o(t,e,i):a(t,e,i)})}function r(t,e){return e=e||{},l.defaults(e,{truncationString:"..."}),t instanceof h&&(t=t.get(0)),l.has(e,"maxHeight")||l.extend(e,{maxHeight:n(t)}),l.isFinite(l.get(e,"maxHeight"))&&!s(t,e)?a(t,e,t):void 0}var l=t("lodash"),h=t("jquery");e.exports=r},{jquery:"HlZQrA",lodash:"MicNly"}],116:[function(t,e,i){"use strict";function s(t){var e,i;return t=t||[],function(){return n.isEmpty(e)&&(e=n.shuffle(t),n.isEmpty(i)||(e=n.without(e,i))),i=e.pop()}}var n=t("lodash");e.exports=s},{lodash:"MicNly"}],117:[function(t,e,i){"use strict";var s=t("lodash"),n=t("jquery"),o=t("prima/lib/mixin"),a=new o({extend:{getQueue:function(){return this.queue||(this.queue=[]),this.queue},clearQueue:function(){this.getQueue().length=0},appendToQueue:function(t){var e=this.getQueue();return e.push.apply(e,this._getItemsAsArray(t)),e},prependToQueue:function(t){var e=this.getQueue();return e.unshift.apply(e,this._getItemsAsArray(t)),e},removeFromQueue:function(t){return this.queue=s.difference(this.getQueue(),this._getItemsAsArray(t)),this.queue},flushQueue:function(t,e){var i,o=this.getQueue();return this._isFlushingQueue?this._flushQueueDeferred:s.isFunction(t)?(this._isFlushingQueue=!0,this._flushQueueDeferred=new n.Deferred,i=function(){var n;if(this._isFlushingQueue){if(0===o.length)return this._isFlushingQueue=!1,void this._onQueueSuccess(e);n=o.shift(),this._onQueueItemStart(n,e),t.call(this,n,e).then(s.bind(function(){this._onQueueItemSuccess(n,e),i.call(this)},this)).fail(s.bind(function(){this._isFlushingQueue=!1,this._onQueueItemFail(n,e)},this))}},i.call(this),this._flushQueueDeferred):void 0},abortFlush:function(){this._isFlushingQueue&&(this._isFlushingQueue=!1,this._flushQueueDeferred.reject())},_getItemsAsArray:function(t){return s.isArray(t)||(t=[t]),t},_onQueueItemStart:function(t,e){this._flushQueueDeferred.notify(t,!1,e,this.getQueue())},_onQueueItemSuccess:function(t,e){this._flushQueueDeferred.notify(t,!0,e,this.getQueue())},_onQueueItemFail:function(t,e){this._flushQueueDeferred.reject(t,e,this.getQueue())},_onQueueSuccess:function(t){this._flushQueueDeferred.resolve(t)}}});e.exports=a},{jquery:"HlZQrA",lodash:"MicNly","prima/lib/mixin":538}],118:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/lib/mixin"),o=new n({defaults:{hasSelection:function(t){return this._validateParams(t)?s.has(this._selectedIndexes,t):null},getSelectedIndex:function(t){return this._validateParams(t)?s.get(this._selectedIndexes,t,0):null},deselect:function(t){this._validateParams(t)&&this.hasSelection(t)&&delete this._selectedIndexes[t]},resetSelected:function(t){this._validateParams(t)&&this.setSelectedIndex(t,0)},setSelectedIndex:function(t,e){var i;return this._validateParams(t)?(i=s.get(this,t,[]),e=Math.max(0,Math.min(e,i.length-1)),s.set(this._selectedIndexes,t,e),e):null},getSelectedView:function(t){var e;return this._validateParams(t)?(e=s.get(this,t,[]),s.get(e,this.getSelectedIndex(t))):null},isFirstSelected:function(t){return this._validateParams(t)?0===this.getSelectedIndex(t):null},isLastSelected:function(t){var e;return this._validateParams(t)?(e=s.get(this,t,[]),this.getSelectedIndex(t)===e.length-1):null},selectFirst:function(t){var e;if(!this._validateParams(t))return null;e=s.get(this,t,[]);var i=this.setSelectedIndex(t,0);return s.get(e,i)},selectLast:function(t){var e;if(!this._validateParams(t))return null;e=s.get(this,t,[]);var i=this.setSelectedIndex(t,e.length-1);return s.get(e,i)},selectNext:function(t){var e,i;return this._validateParams(t)?this.hasSelection(t)?(e=s.get(this,t,[]),i=this._increaseSelectedIndex(t),s.get(e,i)):this.selectFirst(t):null},selectPrevious:function(t){var e,i;return this._validateParams(t)?(e=s.get(this,t,[]),i=this._decreaseSelectedIndex(t),s.get(e,i)):null},_validateParams:function(t){return t?!0:!1},_increaseSelectedIndex:function(t){return this._validateParams(t)?this.setSelectedIndex(t,this.getSelectedIndex(t)+1):null},_decreaseSelectedIndex:function(t){return this._validateParams(t)?this.setSelectedIndex(t,this.getSelectedIndex(t)-1):null}},before:{initialize:function(){this._selectedIndexes={}}}});e.exports=o},{lodash:"MicNly","prima/lib/mixin":538}],119:[function(t,e,i){"use strict";var s=t("prima/model"),n=s.extend({idAttribute:"channelId",defaults:{channelId:null,data:null}});e.exports=n},{"prima/model":557}],120:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/model"),o=t("prima/mixins/relational-model"),a=t("../collections/conversations"),r=t("app/models/tumblelog"),l=n.extend({idAttribute:"uuid",mixins:[o],relations:{conversations:a},defaults:{conversations:null,unread_messages_count_sum:0}});s.defaults(l.prototype,r.prototype),e.exports=l},{"../collections/conversations":97,"app/models/tumblelog":436,lodash:"MicNly","prima/mixins/relational-model":552,"prima/model":557}],121:[function(t,e,i){"use strict";var s=t("prima/model"),n=s.extend({defaults:{view:null,model:null,options:null}});e.exports=n},{"prima/model":557}],122:[function(t,e,i){"use strict";var s=t("lodash"),n=t("jquery"),o=t("prima/mixins/relational-model"),a=t("../mixins/message-queue"),r=t("prima/model"),l=t("../models/message"),h=t("../collections/messages"),c=t("../collections/participants"),u=t("./participant"),d=r.extend({url:"/svc/conversations/messages",mixins:[o,a],relations:{messages:h,participants:c,participant:u},relationsOrder:["participants","participant","messages"],defaults:{id:null,status:null,last_modified_ts:null,last_read_ts:null,participants:null,messages:null,can_send:!0,participant:null,unreadCount:0},fetchNonErrorCodes:[404],fetchNoRetryOnErrorCodes:[403,428,429],isUnread:function(){return this.get("last_modified_ts")>this.get("last_read_ts")},hasQueuedMessages:function(){return(this.getQueue()||[]).length>0},flushMessageQueue:function(t){return this.flushQueue(this.sendMessage,t).fail(s.bind(function(t){t.isPost()&&(t.canRetry()?this.prependToQueue(t):t.postHasTextMessage()&&this.removeFromMessageQueue(s.first(this.getMessageQueue())))},this))},getMessageQueue:function(){return this.getQueue()},removeFromMessageQueue:function(t){return this.removeFromQueue(t)},appendToMessageQueue:function(t){return this.appendToQueue(t)},prependToMessageQueue:function(t){return this.prependToQueue(t)},canRetryFetch:function(t){return s.isFinite(t)&&!s.contains(this.fetchNoRetryOnErrorCodes,t)},markAsRead:function(){var t=(new Date).getTime();this.set({last_read_ts:parseInt(t/1e3,10),unreadCount:0})},parse:function(t,e){var i=s.get(t,"response")||t;return i},destroy:function(t){var e={conversation_id:this.get("id"),participant:this.getParticipantId()};return t=s.extend({},t,{url:this.url+"?"+n.param(e)}),r.prototype.destroy.call(this,t)},_getFullFetchOptions:function(t){var e=this.isNew()?this._getDataForFetchByParticipants():this._getDataForFetchById();return e=s.extend({},e,{participant:this.getParticipantId()}),s.extend({},t,{isFetching:!0,cache:!1,reset:!0,data:e})},fetchConversation:function(t){var e=new n.Deferred,i=function(){e.resolve.apply(this,arguments)},o=function(){e.reject.apply(this,arguments)};return this.fetch(this._getFullFetchOptions(t)).then(s.bind(i,this)).fail(s.bind(function(t,e){var n=s.get(t,"status");this.isNew()&&s.contains(this.fetchNonErrorCodes,n)?i.call(this,{},e):o.apply(this,arguments)},this)),e},poll:function(t,e){var i;if(!this.isNew())return i={participant:this.getParticipantId(),conversation_id:this.get("id")},e&&s.extend(i,{limit:e}),this.get("messages").poll({isPolling:!0,data:i})},getConversationDataForMessage:function(){var t={participant:this.getParticipantId()};return this.isNew()?s.extend(t,{participants:this.getParticipantsIds()}):s.extend(t,{conversation_id:this.get("id")}),t},sendMessage:function(t,e){return e=e||{},t.set(this.getConversationDataForMessage()),this.get("messages").add(t,e),t.save(null,e).then(s.bind(function(t){this.isNew()&&this.set(s.omit(this.parse(t,e),"messages"))},this))},getParticipantId:function(){return this.get("participant").get("uuid")},getParticipantsIds:function(){return this.get("participants").pluck("uuid")},getInboxMessage:function(){var t=this.get("messages").where({isError:!1});return s.last(t)},_getDataForFetchById:function(t){return{conversation_id:this.get("id")}},_getDataForFetchByParticipants:function(t){return{participants:this.getParticipantsIds()}}},{createPostMessage:function(t,e,i){return i=s.extend({},i,{clientTs:new Date,isPending:!0,type:l.POST,post:{blog:e,id:t}}),new l(i)},createTextMessage:function(t,e){return e=s.extend({},e,{clientTs:new Date,isPending:!0,type:l.TEXT,message:t,content:{text:t}}),new l(e)}});e.exports=d},{"../collections/messages":99,"../collections/participants":100,"../mixins/message-queue":117,"../models/message":127,"./participant":128,jquery:"HlZQrA",lodash:"MicNly","prima/mixins/relational-model":552,"prima/model":557}],123:[function(t,e,i){"use strict";var s=t("prima/model"),n=s.extend({defaults:{channel:null},getChannel:function(){return this.get("channel")},setChannel:function(t){return this.set("channel",t)},getId:function(){return this.get("channel").get("uuid")},getPrevChannel:function(){return this.previous("channel")},getPrevProperty:function(t){var e=this.getPrevChannel();return e?e.get(t):null},getPrevId:function(){return this.getPrevProperty("uuid")}});e.exports=n},{"prima/model":557}],124:[function(t,e,i){"use strict";var s=t("prima/model"),n=s.extend({idAttribute:"namespace",defaults:{namespace:null,view:null,isActive:!0}});e.exports=n},{"prima/model":557}],125:[function(t,e,i){"use strict";var s=t("prima/model"),n=s.extend({defaults:{text:null,formatting:[]}});e.exports=n},{"prima/model":557}],126:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/lib/translate"),o=t("prima/model"),a=o.extend({defaults:{type:null,summary:null,state:null,photos:[]},getMessage:function(){return this.get("summary")},getSentString:function(t){var e,i=this.getType(),o=!s.isEmpty(t),a=o?n("%1$s sent a post",t):n("sent a post:"),r=o?n("%1$s sent a post that's no longer available",t):n("sent a post that's no longer available");return this.isDisabled()?r:(e=o?{photo:n("%1$s sent a photo",t),photoset:n("%1$s sent a photoset",t),link:n("%1$s sent a link",t),quote:n("%1$s sent a quote",t),audio:n("%1$s sent an audio post",t),video:n("%1$s sent a video",t),chat:n("%1$s sent a chat",t)}:{photo:n("sent a photo:"),photoset:n("sent a photoset:"),link:n("sent a link:"),quote:n("sent a quote:"),audio:n("sent an audio post:"),video:n("sent a video:"),chat:n("sent a chat:")},s.has(e,i)?s.get(e,i):a)},getType:function(){return"photo"===this.get("type")&&(this.get("photos")||[]).length>1?"photoset":this.get("type")},getThumbnail:function(t){var e,i,n=this.get("thumbnail_url"),o=this.get("thumbnail_height"),a=this.get("thumbnail_width"),r=this.get("photos");return t=t||250,!s.isEmpty(r)||!s.isEmpty(n)&&s.isFinite(o)&&s.isFinite(a)?s.isEmpty(r)?{url:n,height:o,width:a}:(i=s.sortBy(s.get(s.first(r),"alt_sizes"),"width"),e=s.find(i,function(e){return s.get(e,"width",0)>=t}),s.isEmpty(e)?s.last(i):e):null},getScaledDimensionsForWidth:function(t,e){var i;return s.has(t,"width")&&s.has(t,"height")?(i=Math.round(s.get(t,"height")/(s.get(t,"width")/e)),{width:e,height:i}):null},isDisabled:function(){return"disabled"===this.get("state")}});e.exports=a},{lodash:"MicNly","prima/lib/translate":541,"prima/model":557}],127:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/model"),o=t("prima/mixins/relational-model"),a=t("./message-content"),r=t("./message-post"),l={TEXT:"TEXT",POST:"POSTREF"},h=n.extend({mixins:[o],relations:{content:a,post:r},idAttribute:"ts",defaults:{type:l.TEXT,ts:null,participant:null,content:null,message:null,post:null,collapseGroup:null,clientTs:null,tsHeader:null,isPending:!1,isError:!1,isCollapsed:!1,canRetry:!0,hasAnimation:!1,postHasTextMessage:!1,context:null},saveNoRetryOnErrorCodes:[403,404,428],parse:function(t,e){return s.get(t,"response.messages.data.0")||t},save:function(t,e){var i;return e=e||{},t=t||{},t&&this.set(t),s.extend(e,{data:this.toJSON(),emulateJSON:!0}),i=n.prototype.save.call(this,t,e),this.set("isPending",!0),i.then(s.bind(function(){this.set("isError",!1)},this)).fail(s.bind(function(t){this.set({isError:!0,canRetry:this._canRetryOnErrorCode(s.get(t,"status"))})},this)).always(s.bind(function(){this.set("isPending",!1)},this)),i},updateClientTimestamp:function(){this.set("clientTs",(new Date).getTime())},getTimestamp:function(){return this.get("clientTs")||parseInt(this.get("ts"),10)},getMessage:function(){return this.isText()?this.get("content").get("text"):this.isPost()?this.get("post").getMessage():void 0},isError:function(){return this.get("isError")},isText:function(){return this.get("type")===l.TEXT},isPost:function(){return this.get("type")===l.POST},isDisabledPost:function(){return this.isPost()&&this.get("post").isDisabled()},isPending:function(){return this.get("isPending")},canRetry:function(){return this.get("canRetry")},postHasTextMessage:function(){return this.isPost()&&this.get("postHasTextMessage")},_canRetryOnErrorCode:function(t){return s.isFinite(t)&&!s.contains(this.saveNoRetryOnErrorCodes,t)}},l);e.exports=h},{"./message-content":125,"./message-post":126,lodash:"MicNly","prima/mixins/relational-model":552,"prima/model":557}],128:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/mixins/relational-model"),o=t("app/lib/avatar-size"),a=t("prima/model"),r=t("./theme"),l=a.extend({mixins:[n],relations:{theme:r},defaults:{theme:null},idAttribute:"uuid",parse:function(t){return!s.has(t,"theme")&&s.has(t,"global_theme_params")&&s.extend(t,{theme:s.get(t,"global_theme_params")}),t},getAvatarUrl:function(t){return t=t||96,o(this.get("avatar_url"),t)},getAvatarShape:function(){return this.get("theme").get("avatar_shape")}});e.exports=l},{"./theme":129,"app/lib/avatar-size":429,lodash:"MicNly","prima/mixins/relational-model":552,"prima/model":557}],129:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/utils/colors"),o=t("prima/model"),a=o.extend({defaults:{background_color:null,link_color:null,avatar_shape:null,header_image_focused:null,show_header_image:!0,adjustBrightnessFactor:.3},getHeaderImage:function(){return this.get("show_header_image")===!0?this.get("header_image_focused"):null},getBackgroundTint:function(){return this.getTint(this.get("background_color"))},getAccentTint:function(){return this.getTint(this.get("link_color"))},getTint:function(t){var e;return this.get("tint"+t)?this.get("tint"+t):s.isEmpty(t)?null:(e=n.isLight(t,.5)?n.isLight(t,.05,.95)?a.TINT_WHITE:a.TINT_LIGHT:a.TINT_DARK,this.set("tint"+t,e),e)},isDark:function(t){return this.getTint(t)===a.TINT_DARK},isReadableOn:function(t,e){return t=n.hexToHsv(t),e=n.hexToHsv(e),!n.compare(t,e)},adjustColorForBackground:function(t,e){var i=this.get("adjustBrightnessFactor");return this.isReadableOn(t,e)?t:this.adjustBrightness(t,this.isDark(t)?i:-1*i)},getReadableColor:function(t,e){return this.isReadableOn(t,e)?t:n.readable(t)},adjustBrightness:function(t,e){return n.brighten(t,e)},getTintSuffix:function(t){return t===a.TINT_WHITE?"-white":t===a.TINT_LIGHT?"-light":t===a.TINT_DARK?"-dark":void 0}},{TINT_LIGHT:"light",TINT_DARK:"dark",TINT_WHITE:"white"});e.exports=a},{lodash:"MicNly","prima/model":557,"prima/utils/colors":564}],130:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){
var __t,__p="";Array.prototype.join;with(obj||{})__p+='<li><a href="#" data-js-delete-conversation>'+(null==(__t=__("Delete conversation"))?"":_.escape(__t))+"</a></li>",_.each(blockableParticipants,function(t){__p+='<li><a href="#" data-js-block-blogname="'+(null==(__t=t.name)?"":_.escape(__t))+'">'+(null==(__t=__("Block %1$s",t.name))?"":_.escape(__t))+"</a></li>"}),__p+="";return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],131:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __t,__p="";Array.prototype.join;with(obj||{})__p+='<div data-subview="blogSelectorView" class="blog-selector-container"></div><div class="text-input-container"><textarea class="text-input" placeholder="'+(null==(__t=placeholder)?"":_.escape(__t))+'" rows="1" maxlength="4096" data-js-text-input></textarea></div><button type="submit" data-js-submit-button data-js-theme-accent-color-on-white class="submit">'+(null==(__t=__("Send"))?"":_.escape(__t))+"</button>";return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],132:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __t,__p="";Array.prototype.join;with(obj||{})__p+='<div class="content"><label>'+(null==(__t=message)?"":_.escape(__t))+'</label><button data-js-theme-button data-js-button class="chrome">'+(null==(__t=buttonText)?"":_.escape(__t))+"</button></div>";return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],133:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __t,__p="";Array.prototype.join;with(obj||{}){__p+='<div class="conversation-header-image" data-js-theme-header-image></div><div class="conversation-header-main"><div data-js-title class="title">';var lastIndex=participants.length-2;__p+="",_.each(participants,function(t,e){__p+='<a href="'+(null==(__t=t.url)?"":_.escape(__t))+'" target="_blank" data-js-tumblelog-name="'+(null==(__t=t.name)?"":_.escape(__t))+'">'+(null==(__t=t.name)?"":_.escape(__t))+"</a>"+(null==(__t=e===lastIndex?" "+separator+" ":lastIndex>e?", ":"")?"":_.escape(__t))}),__p+='</div><div class="controls" data-js-theme-accent-color-on-background><a href="#" data-js-more-actions class="more-actions">'+(null==(__t=__("Actions"))?"":_.escape(__t))+"</a>",isMinimizeEnabled&&(__p+=' <a href="#" data-js-minimize class="minimize">'+(null==(__t=__("Minimize"))?"":_.escape(__t))+"</a>"),__p+=' <a href="#" data-js-close class="close">'+(null==(__t=__("Close"))?"":_.escape(__t))+"</a></div></div>"}return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],134:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __t,__p="";Array.prototype.join;with(obj||{})__p+='<div class="message">'+(null==(__t=message)?"":_.escape(__t))+"</div>";return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],135:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __t,__p="";Array.prototype.join;with(obj||{})__p+='<div class="message-container conversation-message-post--'+(null==(__t=postType)?"":_.escape(__t))+" "+(null==(__t=_.isEmpty(thumbnail)?"no-thumbnail":"has-thumbnail")?"":_.escape(__t))+(null==(__t=isDisabled?" is-disabled":"")?"":_.escape(__t))+'"><div class="avatar"><a href="'+(null==(__t=url)?"":_.escape(__t))+'" target="_blank" data-js-tumblelog-name="'+(null==(__t=name)?"":_.escape(__t))+'"><img src="'+(null==(__t=avatarUrl)?"":_.escape(__t))+'"></a></div>',isDisabled?__p+='<div class="message-bubble" data-js-message-bubble><div class="message-bubble-header">'+(null==(__t=sentString)?"":_.escape(__t))+"</div></div>":(__p+='<div class="message-bubble" data-js-message-bubble><a href="'+(null==(__t=url)?"":_.escape(__t))+'" data-js-tumblelog-name="'+(null==(__t=postBlogName)?"":_.escape(__t))+'" data-js-post-id="'+(null==(__t=postId)?"":_.escape(__t))+'"><div class="message-bubble-header" data-js-summary><span class="name">'+(null==(__t=sentString)?"":_.escape(__t))+"</span>",_.isEmpty(message)||(__p+=' <span class="text">'+(null==(__t=message)?"":_.escape(__t))+"</span>"),__p+='</div></a></div><a href="'+(null==(__t=url)?"":_.escape(__t))+'" data-js-tumblelog-name="'+(null==(__t=postBlogName)?"":_.escape(__t))+'" data-js-post-id="'+(null==(__t=postId)?"":_.escape(__t))+'" class="icon"></a>'),__p+="</div>",_.isEmpty(thumbnail)||(__p+='<a href="'+(null==(__t=url)?"":_.escape(__t))+'" data-js-tumblelog-name="'+(null==(__t=postBlogName)?"":_.escape(__t))+'" data-js-post-id="'+(null==(__t=postId)?"":_.escape(__t))+'" class="thumbnail"><img src="'+(null==(__t=_.get(thumbnail,"url"))?"":_.escape(__t))+'" width="'+(null==(__t=_.get(thumbnail,"width"))?"":_.escape(__t))+'" height="'+(null==(__t=_.get(thumbnail,"height"))?"":_.escape(__t))+'"></a>'),__p+="";return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],136:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __t,__p="";Array.prototype.join;with(obj||{})__p+='<a class="avatar" href="'+(null==(__t=url)?"":_.escape(__t))+'" target="_blank" data-js-tumblelog-name="'+(null==(__t=name)?"":_.escape(__t))+'"><img src="'+(null==(__t=avatarUrl)?"":_.escape(__t))+'"></a><div class="message-bubble" data-js-message-bubble><div class="message-bubble-header"><a href="'+(null==(__t=url)?"":_.escape(__t))+'" class="name" target="_blank" data-js-tumblelog-name="'+(null==(__t=name)?"":_.escape(__t))+'">'+(null==(__t=name)?"":_.escape(__t))+'</a> <button class="retry-button" data-js-retry-button>'+(null==(__t=__("Retry"))?"":_.escape(__t))+'</button></div><div class="message">'+(null==(__t=message)?"":__t)+"</div></div>";return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],137:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __t,__p="";Array.prototype.join;with(obj||{})__p+='<div data-js-label class="inline-activity timestamp">'+(null==(__t=label)?"":_.escape(__t))+"</div>";return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],138:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __p="";Array.prototype.join;with(obj||{})__p+="<div data-js-message-container></div>";return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],139:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __p="";Array.prototype.join;with(obj||{})__p+='<div class="conversation-pagination-loader" data-js-loader-container><div data-subview="paginationLoaderView"></div></div><div data-subview="messagesView[]" class="message-list"></div><div data-subview="pillView"></div>';return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],140:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __t,__p="";Array.prototype.join;with(obj||{})__p+='<div class="avatar"><img src="'+(null==(__t=avatarUrl)?"":_.escape(__t))+'" title="'+(null==(__t=blogName)?"":_.escape(__t))+'"></div><div class="conversation-minimized-badge tab_notice tab-notice--outlined" data-js-badge><span class="tab_notice_value" data-js-badge-value>2</span></div>';return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],141:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __p="";Array.prototype.join;with(obj||{})__p+="<p></p>";return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],142:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __t,__p="";Array.prototype.join;with(obj||{})__p+='<button data-js-theme-button data-js-unread-button class="unread-button">'+(null==(__t=title)?"":_.escape(__t))+"</button>";return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],143:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __p="";Array.prototype.join;with(obj||{})__p+='<div class="messaging-conversation messaging-conversation--open" data-js-theme-background-tint data-js-conversation-open><div data-subview="headerView"></div><div class="conversation-main" data-js-theme-background-color data-js-main><div data-subview="messagesView"></div><div data-subview="conversationLoaderView"></div><div data-subview="newConversationView"></div></div><div data-subview="composeView"></div></div><div class="messaging-conversation messaging-conversation--minimized" data-js-conversation-minimized><div data-subview="minimizedView"></div></div>';return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],144:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __t,__p="";Array.prototype.join;with(obj||{})__p+='<a href="#" class="compose-toggle compose-start" data-js-compose-toggle>'+(null==(__t=__("Compose message"))?"":_.escape(__t))+'</a> <a href="#" class="compose-toggle compose-cancel" data-js-compose-toggle>'+(null==(__t=__("Nevermind"))?"":_.escape(__t))+"</a>";return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],145:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __t,__p="";Array.prototype.join;with(obj||{})__p+='<div class="inbox-compose-input"><label class="label"><span class="label-text-container">'+(null==(__t=__("To:"))?"":_.escape(__t))+'</span> <span class="input-container"><input type="text" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" class="input" data-js-textinput></span></label></div><div class="inbox-compose-main"><div data-subview="loader"></div><div data-subview="favoritesView"></div><div data-subview="searchResultView"></div></div>';return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],146:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __t,__p="";Array.prototype.join;with(obj||{})__p+='<a data-open-conversation href="#" class="inbox-row"><img class="avatar" src="'+(null==(__t=avatarUrl)?"":_.escape(__t))+'"><div class="info-container"><div class="name-container"><h3 class="name">'+(null==(__t=name)?"":_.escape(__t))+'</h3></div><h4 class="message" data-js-message><span class="additional-blog-name" data-js-additional-blog-name>'+(null==(__t=additionalBlogName)?"":_.escape(__t))+'</span> <span class="text" data-js-message-text>'+(null==(__t=message)?"":_.escape(__t))+"</span></h4></div></a>";return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],147:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __p="";Array.prototype.join;with(obj||{})__p+='<div data-js-conversations-container><div data-subview="conversations[]"></div><div data-subview="favoritesView"></div></div><div class="inbox-pagination-loader" data-js-loader-container><div data-subview="paginationLoaderView"></div></div>';return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],148:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __t,__p="";Array.prototype.join;with(obj||{})__p+="",_.isEmpty(blogs)||(__p+='<div class="blogs">',_.each(blogs,function(t){__p+='<a class="blog" href="/messaging/conversation/'+(null==(__t=t.name)?"":_.escape(__t))+'" data-js-start-conversation="'+(null==(__t=t.name)?"":_.escape(__t))+'"><img class="avatar" src="'+(null==(__t=t.avatarUrl)?"":_.escape(__t))+'" alt="'+(null==(__t=t.name)?"":_.escape(__t))+'" title="'+(null==(__t=t.name)?"":_.escape(__t))+'" width="40" height="40"></a>'}),__p+="</div>"),__p+="";return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],149:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __t,__p="";Array.prototype.join;with(obj||{})__p+='<div class="content"><div class="header-container"><h2 class="header" data-js-header>'+(null==(__t=header)?"":_.escape(__t))+'</h2></div><div data-subview="blogsView"></div></div>';return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],150:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __p="";Array.prototype.join;with(obj||{})__p+='<div data-subview="senderView"></div><div data-subview="composeToggleView"></div>';return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],151:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __t,__p="";Array.prototype.join;with(obj||{})__p+='<a data-start-conversation href="/conversation/new/'+(null==(__t=name)?"":_.escape(__t))+'" class="inbox-row"><img class="avatar" src="'+(null==(__t=avatarUrl)?"":_.escape(__t))+'"><div class="info-container"><h3>'+(null==(__t=name)?"":_.escape(__t))+"</h3><h4>"+(null==(__t=title)?"":_.escape(__t))+"</h4></div></a>";return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],152:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __t,__p="";Array.prototype.join;with(obj||{})__p+="<div data-js-container>",title&&(__p+="<h2>"+(null==(__t=title)?"":_.escape(__t))+"</h2>"),__p+='<div data-subview="recipients[]"></div><div data-js-no-results-container class="no-results"><p data-js-no-results-text>'+(null==(__t=noResultsText)?"":_.escape(__t))+"</p></div></div>";return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],153:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __p="";Array.prototype.join;with(obj||{})__p+='<div data-subview="blogSelector" class="blog-selector"></div>';return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],154:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __p="";Array.prototype.join;with(obj||{})__p+='<div data-subview="headerView"></div><div data-subview="composeView"></div><div class="inbox-main"><div data-subview="loader"></div><div data-subview="conversationsView"></div></div><div data-subview="emptyView"></div>';return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],155:[function(t,e,i){"use strict";var s=t("lodash"),n=t("jquery"),o=t("prima/views/base"),a=t("prima/mixins/popoverbase"),r=t("./conversation-actions"),l=o.extend({className:"popover--conversation-actions info_popover popover_gradient popover",mixins:[a],initialize:function(t){t=s.extend({},t),s.extend(this.attributes,s.pick(t,s.keys(this.defaults))),s.extend(this,s.pick(t,"viewOptions")),this.view=new r(this.viewOptions)},render:function(){return this.$wrapper=n("<div />").addClass("popover-inner popover_inner").appendTo(this.$el),this.$wrapper.html(this.view.render().$el),this},teardown:function(){this.view&&this.view.remove(),this.$el.remove()},getView:function(){return this.view}});e.exports=l},{"./conversation-actions":156,jquery:"HlZQrA",lodash:"MicNly","prima/mixins/popoverbase":550,"prima/views/base":581}],156:[function(t,e,i){"use strict";var s=t("lodash"),n=t("jquery"),o=t("prima/views/base"),a=t("../../templates/conversation/conversation-actions.tpl"),r=o.extend({className:"conversation-actions",tagName:"ul",template:a,events:{"click [data-js-block-blogname]":"_onBlockClick","click [data-js-delete-conversation]":"_onDeleteConversationClick"},initialize:function(t){t=s.extend({},t),s.extend(this.attributes,s.pick(t,s.keys(this.defaults))),s.extend(this,s.pick(t,"eventBus","user","participants")),this.blockableParticipants=this.participants.getWithout(this.user.channels.pluck("uuid"))},getTemplateData:function(){return{blockableParticipants:s.invoke(this.blockableParticipants,"toJSON")}},_onBlockClick:function(t){var e=n(t.currentTarget),i=e.attr("data-js-block-blogname");t.preventDefault(),s.isEmpty(i)||this.trigger("block",i)},_onDeleteConversationClick:function(t){t.preventDefault(),this.trigger("delete")}});e.exports=r},{"../../templates/conversation/conversation-actions.tpl":130,jquery:"HlZQrA",lodash:"MicNly","prima/views/base":581}],157:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/lib/translate"),o=t("prima/mixins/selectorcache"),a=t("prima/mixins/keycommands"),r=t("prima/views/base"),l=t("app/components/blog-selector"),h=t("../../lib/random-text-responder"),c=t("../../templates/conversation/conversation-compose.tpl"),u=r.extend({className:"conversation-compose",template:c,mixins:[o,a],events:{"click [data-js-submit-button]":"_onSubmitButtonClick","input [data-js-text-input]":"_onTextInputChange","keydown [data-js-text-input]":"_onTextInputKeydown","focus [data-js-text-input]":"_onTextInputFocus","blur [data-js-text-input]":"_onTextInputBlur"},keycommands:{"keydown:escape":"_onKeyPressEscape"},defaults:{isValid:!0,isDisabled:!1,isOffline:!1,placeholder:null,offlinePlaceholder:null,currentPlaceholder:null,currentText:null,hasEditorFocus:!1,showBlogSelector:!1,isAutoValidationEnabled:!0,currentTumblelog:null,buttonSubmittedClass:"submitted",isShufflePlaceholder:!0,animationSpeed:250},subviews:{blogSelectorView:{constructor:l,options:function(t){return{className:"conversation-compose-blog-selector",collection:t.channels,currentTumblelog:t.get("currentTumblelog"),showName:!1,showCaret:!1,popoverOptions:{popoverContainer:t.popoverContainer}}}}},initialize:function(t){t=s.extend({},t),s.extend(this.attributes,s.pick(t,s.keys(this.defaults))),s.extend(this,s.pick(t,"eventBus","keyboardManager","keyboardNamespace","channels","currentTumblelog","popoverContainer")),this.getRandomPlaceholder=h([n("New message"),n("Your message here"),n("Write a message"),n("Say something"),n("Say your thing")]),this.set("isShufflePlaceholder",s.isEmpty(this.get("placeholder"))),s.isEmpty(this.get("placeholder"))&&this.set("placeholder",this.getRandomPlaceholder()),this.set("currentPlaceholder",this.get("placeholder")),s.isEmpty(this.get("offlinePlaceholder"))&&this.set("offlinePlaceholder",n("Currently offline")),this.keyboardManager&&this.disableKeys()},afterRenderSubviews:function(){this.listenTo(this,"change:isValid",this._onChangeIsValid),this.listenTo(this,"change:isDisabled",this._onChangeIsDisabled),this.listenTo(this,"change:isOffline",this._onChangeIsOffline),this.listenTo(this,"change:currentPlaceholder",this._onChangeCurrentPlaceholder),this.listenTo(this,"change:currentText",this._onChangeCurrentText),this.listenTo(this,"change:hasEditorFocus",this._onChangeHasEditorFocus),this.listenTo(this,"change:showBlogSelector",this._onChangeShowBlogSelector),this.listenTo(this.blogSelectorView,"change:currentTumblelog",this._onChangeBlogCurrentTumblelog),this._onChangeIsValid(this,this.get("isValid")),this._onChangeIsDisabled(this,this.get("isDisabled")),this._onChangeIsOffline(this,this.get("isOffline")),this._onChangeCurrentPlaceholder(this,this.get("currentPlaceholder")),this._onChangeCurrentText(this,this.get("currentText")),this._onChangeShowBlogSelector(this,this.get("showBlogSelector")),this._onChangeBlogCurrentTumblelog(this.blogSelectorView,this.blogSelectorView.get("currentTumblelog")),this._setValidState(),s.defer(s.bind(function(){this._resizeInput()},this))},getTemplateData:function(){return{placeholder:this.get("placeholder")}},submit:function(){var t=this.get("currentText");this.get("isValid")&&!this.get("isDisabled")&&(this.trigger("submit",t),this._startAnimation(s.bind(function(){this.trigger("submit:animated",t)},this)),this.clear())},escape:function(){s.isEmpty(this.get("currentText"))?this.trigger("close"):this.clear()},clear:function(){this.js$("text-input").val(""),this.set("currentText",""),this.get("isShufflePlaceholder")&&this._setPlaceholderState(),this._resizeInput()},focus:function(){s.defer(s.bind(function(){this.rendered&&this.js$("text-input").focus()},this))},getMessage:function(){return this.js$("text-input").val()},setPlaceholder:function(t){this.set({placeholder:t,isShufflePlaceholder:!1}),this._setPlaceholderState()},beforeRemove:function(){this.keyboardManager&&this.keyboardManager.remove(this.keyboardNamespace)},_onKeyPressEscape:function(t){t.preventDefault(),this.escape()},_onTextInputChange:function(){var t=s.trim(this.js$("text-input").val());this._resizeInput(),this.set("currentText",t),this.trigger("input",t)},_setValidState:function(){this.get("isAutoValidationEnabled")&&this.set("isValid",!s.isEmpty(this.get("currentText")))},_resizeInput:function(){var t,e=this.js$("text-input"),i=e.get(0);this._originalInputHeight||(this._originalInputHeight=e.outerHeight()),this.$el.css("height",this.$el.height()),e.css("height","auto"),t=i.scrollHeight,Math.abs(t-this._originalInputHeight)<5&&(t=this._originalInputHeight),e.css("height",t),this.$el.css("height",""),this._detectResize()},_detectResize:function(){var t=this.$el.height();return this._previousHeight?void(t!==this._previousHeight&&(this.trigger("resize",t),this._previousHeight=t)):void(this._previousHeight=t)},_startAnimation:function(t){var e=this.js$("submit-button"),i=this.get("buttonSubmittedClass");return s.isEmpty(i)?void(s.isFunction(t)&&t.call(this)):(e.addClass(i),void s.delay(s.bind(function(){e.removeClass(i),s.isFunction(t)&&t.call(this)},this),this.get("animationSpeed")))},_setPlaceholderState:function(){var t=this.get("isShufflePlaceholder")?this.getRandomPlaceholder():this.get("placeholder");this.set("currentPlaceholder",this.get("isOffline")?this.get("offlinePlaceholder"):t)},_onChangeCurrentText:function(t,e){this._setValidState()},_onChangeIsValid:function(t,e){this.js$("submit-button").prop("disabled",!e||this.get("isDisabled"))},_onSubmitButtonClick:function(t){t.preventDefault(),this.submit()},_onChangeIsDisabled:function(t,e){this.js$("text-input").prop("disabled",e),this.js$("submit-button").prop("disabled",e||!this.get("isValid"))},_onChangeIsOffline:function(t,e){this._setPlaceholderState()},_onChangeCurrentPlaceholder:function(t,e){this.js$("text-input").attr("placeholder",e)},_onTextInputFocus:function(){this.set("hasEditorFocus",!0),this.trigger("focus",this)},_onTextInputBlur:function(){this.set("hasEditorFocus",!1),this.trigger("blur",this)},_onTextInputKeydown:function(t){13!==t.keyCode||t.shiftKey||(this.submit(),t.preventDefault())},_onChangeHasEditorFocus:function(t,e){this.keyboardManager&&this.keyboardManager.toggle(this.keyboardNamespace,t,e)},_onChangeShowBlogSelector:function(t,e){this.blogSelectorView.$el.toggle(e),this.$el.toggleClass("hide-blog-selector",!e)},_onChangeBlogCurrentTumblelog:function(t,e){this.set("currentTumblelog",e)}});e.exports=u},{"../../lib/random-text-responder":116,"../../templates/conversation/conversation-compose.tpl":131,"app/components/blog-selector":37,lodash:"MicNly","prima/lib/translate":541,"prima/mixins/keycommands":547,"prima/mixins/selectorcache":553,"prima/views/base":581}],158:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/lib/translate"),o=t("prima/views/base"),a=t("prima/mixins/selectorcache"),r=t("../../templates/conversation/conversation-error.tpl"),l=o.extend({className:"conversation-error",mixins:[a],template:r,defaults:{message:null,isLoading:!1,showButton:!0,buttonText:null,buttonTextLoading:null,buttonTextCurrent:null},events:{"click [data-js-button]":"_onClickButton"},initialize:function(t){t=s.extend({},t),s.extend(this.attributes,s.pick(t,s.keys(this.defaults))),s.extend(this,s.pick(t,"eventBus","buttonCallback")),s.isEmpty(this.get("message"))&&this.set("message",n("Something went screwy.")),s.isEmpty(this.get("buttonText"))&&this.set("buttonText",n("Retry")),s.isEmpty(this.get("buttonTextLoading"))&&this.set("buttonTextLoading",n("Retrying...")),s.isEmpty(this.get("buttonTextCurrent"))&&this.set("buttonTextCurrent",this.get("buttonText"))},afterRender:function(){this.listenTo(this,"change:isLoading",this._onChangeIsLoading),this.listenTo(this,"change:buttonTextCurrent",this._onChangeButtonTextCurrent),this.listenTo(this,"change:showButton",this._onChangeShowButton),this._onChangeIsLoading(this,this.get("isLoading")),this._onChangeShowButton(this,this.get("showButton"))},getTemplateData:function(){return{message:this.get("message"),buttonText:this.get("buttonTextCurrent")}},_onClickButton:function(t){t.preventDefault(),this.get("isLoading")||(this.set("isLoading",!0),this.trigger("buttonClick"),s.isFunction(this.buttonCallback)&&this.buttonCallback.call(this,this))},_onChangeIsLoading:function(t,e){var i=e?this.get("buttonTextLoading"):this.get("buttonText");this.set("buttonTextCurrent",i),this.js$("button").toggleClass("disabled",e).prop("disabled",e)},_onChangeButtonTextCurrent:function(t,e){this.js$("button").text(e)},_onChangeShowButton:function(t,e){this.js$("button").toggle(e)}});e.exports=l},{"../../templates/conversation/conversation-error.tpl":132,lodash:"MicNly","prima/lib/translate":541,"prima/mixins/selectorcache":553,"prima/views/base":581}],159:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/views/base"),o=t("prima/mixins/selectorcache"),a=t("../../templates/conversation/conversation-header.tpl"),r=n.extend({className:"conversation-header",template:a,mixins:[o],defaults:{separator:"+",isMinimizeEnabled:!1},attributes:{"data-js-theme-background-color-or-image-class":!0,"data-js-theme-accent-color-on-background":!0},events:{"click [data-js-close]":"_onClickCloseButton","click [data-js-more-actions]":"_onClickMoreActions","click [data-js-minimize]":"_onClickMinimizeButton"},initialize:function(t){t=s.extend({},t),s.extend(this.attributes,s.pick(t,s.keys(this.defaults))),s.extend(this,s.pick(t,"eventBus","participants","user","channels"))},getTemplateData:function(){var t;return t=this.channels.length>1?this.participants.toJSON():s.invoke(this.participants.getWithout(this.channels.pluck("uuid")),"toJSON"),t=s.filter(t,function(t){return!s.isEmpty(s.get(t,"name"))}),{participants:t,separator:this.get("separator"),isMinimizeEnabled:this.get("isMinimizeEnabled")}},_onClickCloseButton:function(t){this.trigger("closeClick"),t.preventDefault()},_onClickMoreActions:function(t){var e=t.currentTarget;this.trigger("moreActionsClick",e),t.preventDefault()},_onClickMinimizeButton:function(t){this.trigger("minimizeClick"),t.preventDefault()}});e.exports=r},{"../../templates/conversation/conversation-header.tpl":133,lodash:"MicNly","prima/mixins/selectorcache":553,"prima/views/base":581}],160:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/views/base"),o=t("../../templates/conversation/conversation-message-error.tpl"),a=n.extend({className:"conversation-message-error",template:o,defaults:{message:null},initialize:function(t){t=s.extend({},t),s.extend(this.attributes,s.pick(t,s.keys(this.defaults))),s.extend(this,s.pick(t,"eventBus"))},getTemplateData:function(){return{message:this.get("message")}}});e.exports=a},{"../../templates/conversation/conversation-message-error.tpl":134,lodash:"MicNly","prima/views/base":581}],161:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/views/base"),o=t("prima/mixins/selectorcache"),a=t("../../lib/multiline-truncate"),r=t("../../templates/conversation/conversation-message-post.tpl"),l=n.extend({className:"conversation-message-post",mixins:[o],template:r,defaults:{thumbnailWidth:210},initialize:function(t){t=s.extend({},t),s.extend(this.attributes,s.pick(t,s.keys(this.defaults))),s.extend(this,s.pick(t,"eventBus","participants","model"))},afterRenderSubviews:function(){this.listenTo(this.model,"change:isError change:isPending",this._onModelChange),this.listenTo(this.model.get("post"),"change:summary change:state",this._onModelChange),this._startTruncateSummary()},getThumbnailAtWidth:function(t){var e,i=this.model.get("post"),n=i.getThumbnail(t);return s.isEmpty(n)?null:(e=i.getScaledDimensionsForWidth(n,t),s.extend({},n,e))},getTemplateData:function(){var t=this.model.get("post"),e=this.participants.get(this.model.get("participant")),i=this.getThumbnailAtWidth(this.get("thumbnailWidth"));return{postType:t.getType(),isDisabled:t.isDisabled(),isError:this.model.get("isError"),isPending:this.model.get("isPending"),sentString:e?t.getSentString(e.get("name")):null,message:t.getMessage(),thumbnail:i,avatarUrl:e?e.getAvatarUrl():null,name:e?e.get("name"):null,url:t.get("post_url"),postBlogName:t.get("blog_name"),postId:t.get("id")}},_startTruncateSummary:function(){s.defer(s.bind(this._truncateSummary,this))},_truncateSummary:function(){a(this.js$("summary",!0))},_onModelChange:function(){this.renderWithTemplate(),this._startTruncateSummary()}});e.exports=l},{"../../lib/multiline-truncate":115,"../../templates/conversation/conversation-message-post.tpl":135,lodash:"MicNly","prima/mixins/selectorcache":553,"prima/views/base":581}],162:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/lib/translate"),o=t("prima/views/base"),a=t("prima/mixins/selectorcache"),r=t("app/components/messaging/lib/message-formatter").html,l=t("../../templates/conversation/conversation-message-text.tpl"),h=o.extend({className:"conversation-message-text message-container",mixins:[a],template:l,defaults:{pendingClassName:"is-pending",fullWidthBubblePercentThreshold:60,fullWidthBubbleClass:"full-width-bubble"},events:{"click [data-js-retry-button]":"_onRetryClick"},initialize:function(t){t=s.extend({},t),s.extend(this.attributes,s.pick(t,s.keys(this.defaults))),s.extend(this,s.pick(t,"eventBus","participants","afterRetryClick")),this.formatter=t.formatter||new r},afterRenderSubviews:function(){this.listenTo(this.model,"change:isPending change:isError change:canRetry",this._setButtonState),this.listenTo(this.model.get("content"),"change",this.render),this._setButtonState(),this.$el.width()?this._setBubbleStyles():s.defer(s.bind(this._setBubbleStyles,this))},getTemplateData:function(){var t=this.participants.get(this.model.get("participant")),e=this.model.toJSON(),i=this.formatter.render(s.get(e,"content.text"),s.get(e,"content.formatting"));return{message:i,avatarUrl:t?t.getAvatarUrl():null,name:t?t.get("name"):null,url:t?t.get("url"):null}},_setBubbleStyles:function(){var t=this.get("fullWidthBubblePercentThreshold"),e=this.js$("message-bubble"),i=this.$el.width(),s=e.width();s>t/100*i&&e.addClass(this.get("fullWidthBubbleClass"))},_setButtonState:function(){
var t,e,i,s,o,a,r;this.rendered&&(t=this.js$("retry-button"),e=this.model.get("isPending"),i=this.model.get("canRetry"),s=this.model.get("isError"),o=n(i?"Retry":"Could not send"),a=e?n("Trying..."):o,r=s,t.toggle(r),r&&(t.text(a).prop("disabled",e||!i),t.toggleClass(this.get("pendingClassName"),e)))},_onRetryClick:function(t){t.preventDefault(),this.model.get("canRetry")&&(this.trigger("retryClick",this.model),s.isFunction(this.afterRetryClick)&&this.afterRetryClick(this.model))}});e.exports=h},{"../../templates/conversation/conversation-message-text.tpl":136,"app/components/messaging/lib/message-formatter":108,lodash:"MicNly","prima/lib/translate":541,"prima/mixins/selectorcache":553,"prima/views/base":581}],163:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/views/base"),o=t("../../templates/conversation/conversation-message-timestamp.tpl"),a=n.extend({className:"conversation-message-timestamp",template:o,initialize:function(t){t=s.extend({},t),s.extend(this.attributes,s.pick(t,s.keys(this.defaults))),s.extend(this,s.pick(t,"eventBus"))},getTemplateData:function(){return{label:this.model.get("tsHeader")}}});e.exports=a},{"../../templates/conversation/conversation-message-timestamp.tpl":137,lodash:"MicNly","prima/views/base":581}],164:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/views/base"),o=t("prima/mixins/selectorcache"),a=t("../../models/message"),r=t("../../templates/conversation/conversation-message.tpl"),l=t("./conversation-message-text"),h=t("./conversation-message-post"),c=t("./conversation-message-timestamp"),u=n.extend({className:"conversation-message",mixins:[o],template:r,messagesTypes:{},initialize:function(t){t=s.extend({},t),s.extend(this.attributes,s.pick(t,s.keys(this.defaults))),s.extend(this,s.pick(t,"eventBus","participants","afterRetryClick","formatter","animateInMessage")),this.addMessageType(a.POST,h),this.addMessageType(a.TEXT,l,function(t){return{afterRetryClick:t.afterRetryClick,formatter:t.formatter}})},afterRenderSubviews:function(){var t=this.createMessageView(this.model.get("type"));return t?(this.js$("message-container").html(t.render().$el),this.model.get("hasAnimation")&&s.isFunction(this.animateInMessage)&&this.animateInMessage(this,this.js$("message-bubble"),this.model),this.listenTo(this.model,"change:isPending",this._onChangeIsPending),this.listenTo(this.model,"change:isError",this._onChangeIsError),this.listenTo(this.model,"change:isCollapsed",this._onChangeIsCollapsed),this.listenTo(this.model,"change:tsHeader",this._onChangeTsHeader),this._onChangeTsHeader(this.model,this.model.get("tsHeader")),void this._onChangeIsCollapsed(this.model,this.model.get("isCollapsed"))):this.remove()},addMessageType:function(t,e,i){this.messagesTypes[t]={constructor:e,options:i}},getMessageType:function(t){return s.get(this.messagesTypes,t)},createMessageView:function(t){var e,i=this.getMessageType(t);return s.isEmpty(i)||!s.has(i,"constructor")?null:(e=s.get(i,"options",{}),s.isFunction(e)&&(e=e.call(this,this)),s.extend(e,{model:this.model,participants:this.participants,eventBus:this.eventBus}),new i.constructor(e))},_onChangeTsHeader:function(t,e){this.timestampView&&this.timestampView.remove(),s.isEmpty(e)||(this.timestampView=new c({model:this.model}),this.$el.prepend(this.timestampView.render().$el))},_onChangeIsCollapsed:function(t,e){this.$el.toggleClass("collapsed",e)},_onChangeIsPending:function(t,e){this.$el.toggleClass("pending",e)},_onChangeIsError:function(t,e){this.$el.toggleClass("error",e)}});e.exports=u},{"../../models/message":127,"../../templates/conversation/conversation-message.tpl":138,"./conversation-message-post":161,"./conversation-message-text":162,"./conversation-message-timestamp":163,lodash:"MicNly","prima/mixins/selectorcache":553,"prima/views/base":581}],165:[function(t,e,i){"use strict";var s=t("lodash"),n=t("moment"),o=t("when"),a=t("prima/views/base"),r=t("prima/mixins/collection-view"),l=t("prima/mixins/selectorcache"),h=t("components/knight-rider-loader"),c=t("../../lib/infinite-scrollbar"),u=t("./conversation-message"),d=t("./conversation-pill"),p=t("./conversation-message-error"),m=t("../../templates/conversation/conversation-messages.tpl"),g=a.extend({className:"conversation-messages",template:m,mixins:[l,r],defaults:{isVisible:!0,isPaginating:!1,tsHeaderThreshold:36e5,collapseMessagesThreshold:6e4,pillClickScrollSpeed:500,pillBottomThreshold:80},subviews:{paginationLoaderView:{constructor:h,options:{variation:"small h-centered",loading:!1}},messagesView:{constructor:u,options:function(t){return{eventBus:t.eventBus,participants:t.participants,formatter:t.messageFormatter,animateInMessage:t.animateInMessage,afterRetryClick:s.bind(t.afterRetryClick,t)}},collection:function(t){return t.collection}},pillView:{constructor:d,options:function(t){return{eventBus:t.eventBus}}}},initialize:function(t){t=s.extend({},t),s.extend(this.attributes,s.pick(t,s.keys(this.defaults))),s.extend(this,s.pick(t,"eventBus","collection","participants","messageFormatter","animateInMessage"))},afterRenderSubviews:function(){this.scrollBar=new c({el:this.el,bottomThreshold:this.get("pillBottomThreshold")}),this.listenTo(this.collection,"update reset",this._onCollectionUpdate),this.listenTo(this.collection,"change:hasNextPage",this._onChangeHasNextPage),this.listenTo(this.collection,"change:isError",this._onChangeMessageIsError),this.listenTo(this.scrollBar,"scrolltop",this._onScrollChangeIsAtTop),this.listenTo(this.scrollBar,"scrollbottom",this._onScrollChangeIsAtBottom),this.listenTo(this.scrollBar,"scrollstop",this._createPositionSnapshot),this.listenTo(this.pillView,"click",this._onPillViewClick),this.listenTo(this,"change:isPaginating",this._onChangeIsPaginating),this.listenTo(this,"change:isVisible",this._onChangeIsVisible),this._onChangeHasNextPage(this.collection,this.collection.hasNextPage()),s.defer(s.bind(function(){this._processMessages(),this.updateScrollBar(),this.scrollToBottom()},this))},beforeRemove:function(){this.scrollBar&&this.scrollBar.destroy()},scrollToBottom:function(t){this._setScrollTop(this.el.scrollHeight,t)},getNextPage:function(){this.collection.hasNextPage()&&(this.set("isPaginating",!0),this.collection.fetchNextPage({isPaginating:!0,scrollBottom:this.el.scrollHeight-this.$el.scrollTop()}).always(s.bind(function(){this.set("isPaginating",!1)},this)))},updateScrollBar:function(){var t,e=this.scrollBar.isDisabled();this.scrollBar.setDisabled(!0),this.scrollBar&&this.scrollBar.update(),t=this._getPositionDiff(),t&&this._setScrollTop(this.$el.scrollTop()+t.height+t.scrollTop),this._createPositionSnapshot(),this.scrollBar.setDisabled(e)},afterRetryClick:function(t){this.trigger("messageRetryClick",t)},toggle:function(t){this.set("isVisible",t)},isAtBottom:function(){return this._lastPosition&&this.scrollBar?this._lastPosition.scrollBottom<this.get("pillBottomThreshold"):!0},showPill:function(t){return this._pillDefer&&this._pillDefer.reject(),this._pillDefer=o.defer(),this.pillView.setCount(t),this._pillDefer.promise},addErrorMessage:function(t){var e=new p({message:t});return this.$el.append(e.render().$el),e},setIsAnimating:function(t){this.$el.toggleClass("is-animating",t)},_onChangeIsVisible:function(t,e){this.$el.css("visibility",e?"":"hidden"),e&&(this.updateScrollBar(),this.scrollToBottom())},_setScrollTop:function(t,e){e?this.$el.animate({scrollTop:t},e):this.$el.scrollTop(t)},_onCollectionUpdate:function(t,e){this._processMessages(e),s.get(e,"isPaginating")&&this._adjustScrollbarAfterPagination(t,e),s.defer(s.bind(function(){this.rendered&&this._adjustScrollbarAfterFetch(t,e)},this))},_adjustScrollbarAfterFetch:function(t,e){this.scrollBar&&this.scrollBar.update(),s.get(e,"isPolling")||s.get(e,"isPaginating")||this.scrollToBottom(),this._createPositionSnapshot()},_adjustScrollbarAfterPagination:function(t,e){s.has(e,"scrollBottom")&&(this.scrollBar.setDisabled(!0),this._setScrollTop(this.el.scrollHeight-e.scrollBottom),s.delay(s.bind(function(){this.scrollBar.setDisabled(!1)},this),500))},_onChangeIsPaginating:function(t,e){this.paginationLoaderView.set("loading",e)},_onChangeHasNextPage:function(t,e){this.js$("loader-container").toggle(e)},_processMessages:function(t){var e,i=this.get("tsHeaderThreshold"),n=this.get("collapseMessagesThreshold"),o=(new Date).getTime();s.get(t,"isPolling")&&(o="new"),this.collection.each(function(t){t.set({tsHeader:this._getTimestampHeader(t,e,i),isCollapsed:this._getIsCollapsed(t,e,n,o)}),e=t},this)},_getTimestampHeader:function(t,e,i){var s=t?t.getTimestamp():null,o=e?e.getTimestamp():null,a=!o||s-o>i;return a?n(s).calendar():null},_getIsCollapsed:function(t,e,i,s){return t.has("collapseGroup")||t.set("collapseGroup",t.isNew()?"new":s),e?t.get("collapseGroup")!==e.get("collapseGroup")?!1:t.get("participant")!==e.get("participant")?!1:t.getTimestamp()-e.getTimestamp()<i:!1},_getScrollPosition:function(){return this.scrollBar.getCurrentPositions()},_createPositionSnapshot:function(){this._lastPosition=this._getScrollPosition()},_getPositionDiff:function(){if(this._lastPosition){var t=this._getScrollPosition();return{scrollTop:this._lastPosition.scrollTop-t.scrollTop,scrollBottom:this._lastPosition.scrollBottom-t.scrollBottom,height:this._lastPosition.height-t.height}}},_onScrollChangeIsAtTop:function(t){t&&this.getNextPage()},_onScrollChangeIsAtBottom:function(t){t&&this._pillDefer&&(this._pillDefer.resolve(this.pillView.getCount()),this.pillView.setCount(0))},_onPillViewClick:function(){this.pillView.setCount(0),this.scrollToBottom(this.get("pillClickScrollSpeed")),this._pillDefer&&this._pillDefer.resolve()},_onChangeMessageIsError:function(){this.scrollToBottom()}});e.exports=g},{"../../lib/infinite-scrollbar":104,"../../templates/conversation/conversation-messages.tpl":139,"./conversation-message":164,"./conversation-message-error":160,"./conversation-pill":168,"components/knight-rider-loader":461,lodash:"MicNly",moment:"iROhDJ","prima/mixins/collection-view":544,"prima/mixins/selectorcache":553,"prima/views/base":581,when:"RG2dij"}],166:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/views/base"),o=t("prima/mixins/selectorcache"),a=t("../../templates/conversation/conversation-minimized.tpl"),r=n.extend({className:"conversation-minimized",template:a,mixins:[o],events:{click:"_onClick"},defaults:{maxBadgeCount:99,activeBadgeClass:"tab-notice--active",newMessageClass:"new-message"},initialize:function(t){t=s.extend({},t),s.extend(this.attributes,s.pick(t,s.keys(this.defaults))),s.extend(this,s.pick(t,"eventBus","participant"))},getTemplateData:function(){return{blogName:this.participant?this.participant.get("name"):null,avatarUrl:this.participant?this.participant.getAvatarUrl():null}},afterRender:function(){this.listenTo(this.model,"change:unreadCount",this._onChangeUnreadCount)},updateBadge:function(t){var e=this.get("maxBadgeCount"),i=this.get("activeBadgeClass");t>0&&this.js$("badge-value").text(t>e?e+"+":t),this.js$("badge").toggleClass(i,t>0)},animate:function(){var t=this.get("newMessageClass");this.$el.addClass(t),s.delay(s.bind(function(){this.$el.removeClass(t)},this),250)},_onChangeUnreadCount:function(t,e){this.updateBadge(e),e>0&&this.animate()},_onClick:function(){this.trigger("click")}});e.exports=r},{"../../templates/conversation/conversation-minimized.tpl":140,lodash:"MicNly","prima/mixins/selectorcache":553,"prima/views/base":581}],167:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/views/base"),o=t("../../templates/conversation/conversation-new.tpl"),a=n.extend({className:"conversation-new",template:o,initialize:function(t){t=s.extend({},t),s.extend(this.attributes,s.pick(t,s.keys(this.defaults))),s.extend(this,s.pick(t,"eventBus"))}});e.exports=a},{"../../templates/conversation/conversation-new.tpl":141,lodash:"MicNly","prima/views/base":581}],168:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/lib/translate"),o=t("prima/views/base"),a=t("prima/mixins/selectorcache"),r=t("../../templates/conversation/conversation-pill.tpl"),l=o.extend({className:"conversation-pill hide-pill",template:r,mixins:[a],events:{"click [data-js-unread-button]":"_onClick"},defaults:{count:0,maxCount:99},initialize:function(t){t=s.extend({},t),s.extend(this.attributes,s.pick(t,s.keys(this.defaults))),s.extend(this,s.pick(t,"eventBus"))},afterRender:function(){this.listenTo(this,"change:count",this._onChangeCount),this._onChangeCount(this,this.get("count"))},setCount:function(t){this.set("count",s.isFinite(t)?t:0)},getCount:function(){return this.get("count")},getTitle:function(t){var e,i;return s.isFinite(t)?(e=this.get("maxCount"),i=t>e?e+"+":t,t>1?n("%1$s unread messages",i):n("%1$s unread message",i)):null},getTemplateData:function(){return{title:this.getTitle(this.get("count"))}},_onChangeCount:function(t,e){var i=this.getTitle(e);this.$el.toggleClass("hide-pill",0===e||s.isEmpty(i)),e>0&&this.js$("unread-button").text(i)},_onClick:function(t){t.preventDefault(),this.trigger("click")}});e.exports=l},{"../../templates/conversation/conversation-pill.tpl":142,lodash:"MicNly","prima/lib/translate":541,"prima/mixins/selectorcache":553,"prima/views/base":581}],169:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/utils/bindendevent").transition,o=t("prima/views/base"),a=t("./index"),r=o.extend({className:"popover--conversation-popover hide-popover",initialize:function(t){t=s.extend({},t),s.extend(this.attributes,s.pick(t,s.keys(this.defaults))),s.extend(this,s.pick(t,"viewOptions")),s.isFunction(this.viewOptions)&&(this.viewOptions=this.viewOptions.call(this,this))},render:function(){return this.conversationView=new a(this.viewOptions),this.$el.html(this.conversationView.render().$el),s.defer(s.bind(function(){this.$el.removeClass("hide-popover")},this)),this},teardown:function(){return n(this.$el,s.bind(function(){this.remove()},this)),this.$el.addClass("hide-popover"),this},beforeRemove:function(){this.conversationView&&this.conversationView.remove()},getView:function(){return this.conversationView},poll:function(){var t=this.getView();return t?t.poll():void 0},refresh:function(t){var e=this.getView();return e?e.refresh(t):void 0},fetch:function(){var t=this.getView();return t?t.fetch():void 0},focus:function(){var t=this.getView();return t?t.focus():void 0}});e.exports=r},{"./index":171,lodash:"MicNly","prima/utils/bindendevent":560,"prima/views/base":581}],170:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/view"),o=t("prima/mixins/selectorcache"),a=t("prima/mixins/accessor"),r=n.extend({mixins:[o,a],defaults:{removeDataAttrAfterApplyingTheme:!0},configuration:{"theme-background-color":{themeField:"background_color",applyStyle:"background-color"},"theme-accent-color":{themeField:"link_color",applyStyle:"color"},"theme-accent-color-on-white":{themeField:"link_color",unsetMissingStyle:"color",applyStyle:function(t,e,i){t.css("color",i.adjustColorForBackground(e,"#ffffff"))}},"theme-accent-color-on-grey":{themeField:"link_color",unsetMissingStyle:"color",applyStyle:function(t,e,i){t.css("color",i.adjustColorForBackground(e,"#f2f2f2"))}},"theme-accent-color-on-background":{themeField:"link_color",unsetMissingStyle:"color",applyStyle:function(t,e,i){t.css("color",i.getReadableColor(e,i.get("background_color")))}},"theme-accent-color-as-background":{themeField:"link_color",unsetMissingStyle:"background-color",applyStyle:function(t,e,i){t.css("background-color",i.adjustColorForBackground(e,"#ffffff"))}},"theme-button":{themeField:function(t){var e=t.get("background_color"),i=t.get("link_color");return s.isEmpty(e)||s.isEmpty(i)?null:{text:e,background:t.getReadableColor(i,e)}},applyStyle:function(t,e,i){t.addClass("themed"),i.getHeaderImage()||t.css({"background-color":e.background,"border-color":e.background,color:e.text})}},"theme-header-image":{themeField:function(t){return t.getHeaderImage()},applyStyle:function(t,e){t.css("background-image","url("+e+")")}},"theme-background-tint":{themeField:function(t){return t.getTintSuffix(t.getBackgroundTint())},applyStyle:function(t,e,i){t.addClass("theme-background"+e)}},"theme-background-color-or-image-class":{themeField:"background_color",applyStyle:function(t,e,i){s.isEmpty(i.getHeaderImage())?t.css("background-color",e):t.addClass("has-image")}},"theme-avatar-shape-class":{themeField:"avatar_shape",applyStyle:function(t,e){t.addClass("avatar-shape--"+e)}}},initialize:function(t){t=s.extend({},t),s.extend(this.attributes,s.pick(t,s.keys(this.defaults))),s.extend(this,s.pick(t,"theme"))},render:function(){this.theme&&s.each(this.configuration,function(t,e){var i,n,o=t.unsetMissingStyle,a=t.applyStyle;if(i=s.isFunction(t.themeField)?t.themeField.call(this,this.theme):this.theme.get(t.themeField),n=this.js$(e),0!==n.length){if(s.isEmpty(i))return void(s.isFunction(o)?o.call(this,n,i,this.theme):s.isEmpty(o)?s.isFunction(a)||n.css(a,""):n.css(o,""));s.isFunction(a)?a.call(this,n,i,this.theme):n.css(a,i),this.get("removeDataAttrAfterApplyingTheme")&&n.removeAttr("data-js-"+e)}},this)},setTheme:function(t){return this.theme=t,this.render()}});e.exports=r},{lodash:"MicNly","prima/mixins/accessor":542,"prima/mixins/selectorcache":553,"prima/view":580}],171:[function(t,e,i){"use strict";var s=t("lodash"),n=t("jquery"),o=t("velocity-animate"),a=t("prima/lib/translate"),r=t("prima/views/base"),l=t("components/knight-rider-loader"),h=t("prima/mixins/selectorcache"),c=t("prima/utils/bindendevent").animation,u=t("./conversation-header"),d=t("./conversation-messages"),p=t("./conversation-new"),m=t("./conversation-compose"),g=t("./conversation-minimized"),f=t("./conversation-error"),_=t("./conversation-theme"),v=t("../../models/conversation"),b=t("./conversation-actions-popover"),y=t("app/components/messaging/lib/message-formatter").html,w=t("../../lib/random-text-responder"),x=t("../../templates/conversation/index.tpl"),C=r.extend({template:x,className:"messaging-conversation-wrapper",defaults:{isNewConversation:!1,isError:!1,canSend:!0,isLoading:!0,isSendingPost:!1,isFetching:!0,isOffline:!1,isAutoFetch:!0,isMinimized:!1,isMinimizeEnabled:!1,animateInMessageDuration:500,minimizeOpeningClass:"is-minimize-opening",minimizeClosingClass:"is-minimize-closing"},events:{"click [data-js-tumblelog-name]":"_onBlogClick","click [data-js-main]":"_onMainContainerClick"},mixins:[h],subviews:{conversationLoaderView:{constructor:l,options:{variation:"small centered",loading:!1}},headerView:{constructor:u,options:function(t){return{eventBus:t.eventBus,participants:t.sortedParticipants,theme:t.theme,channels:t.channels,user:t.user,isMinimizeEnabled:t.isMinimizeEnabled()}}},newConversationView:{constructor:p,options:function(t){return{eventBus:t.eventBus}}},messagesView:{constructor:d,options:function(t){return{eventBus:t.eventBus,collection:t.model.get("messages"),participants:t.model.get("participants"),messageFormatter:t.messageFormatter,animateInMessage:s.bind(t._animateInMessage,t)}}},composeView:{constructor:m,options:function(t){return{eventBus:t.eventBus,keyboardManager:t.keyboardManager,keyboardNamespace:t.keyboardNamespace+":compose",channels:t.nonParticipantingChannels,currentTumblelog:t.model.get("participant"),popoverContainer:t.popoverContainer}}},minimizedView:{constructor:g,options:function(t){return{eventBus:t.eventBus,participant:t.otherParticipant,model:t.model}}}},initialize:function(t){t=s.extend({},t),s.extend(this.attributes,s.pick(t,s.keys(this.defaults))),s.extend(this,s.pick(t,"eventBus","user","model","channels","messageFormatter","popoverContainer","keyboardManager")),this.keyboardNamespace="conversation:"+this.cid,this.model||(this.model=new v),this.messageFormatter||(this.messageFormatter=new y),this.conversation=this.model,this.sortedParticipants=this._getSortedParticipantsCopy(),this.nonParticipantingChannels=this._getNonParticipantingChannels(),this.otherParticipant=this.sortedParticipants.last(),this.getGenericErrorMessage=w([a("Something went screwy."),a("Something's busted."),a("Something got snagged."),a("Something's acting up."),a("Something sucks!"),a("Internet is being dumb."),a("Computer weirdness."),a("The server is being foolish."),a("Something fizzled."),a("The internet evaporated."),a("The internet is being wiggly."),a("Something went splat."),a("Server turned to dust."),a("Something's wonky."),a("Something's not happening."),a("Something's not working."),a("Something got messed up."),a("Unknown, totally annoying error."),a("A nameless error mysteriously occurred."),a("Our computer is a loser."),a("Something pooped out."),a("Something fell into a volcano."),a("Something is all gummed up."),a("Something melted.")]),this.permanentPostErrorMessage=a("Can't send this post."),this.getRetryPostErrorMessage=w([a("Hrm. Post didn't send."),a("Blegh. Post didn't send."),a("Fffft. Post didn't send."),a("Welp. Post didn't send."),a("Sending machine broke.")]),this.customErrorMessages={409:a("You can only send messages to Tumblrs you follow."),428:a("Sorry, %1$s only allows messages from Tumblrs they follow.",this.otherParticipant.get("name")),429:a("You've hit the daily limit on new conversations. Impressive.")},this.easeOutExpo=[.19,1,.22,1]},afterRenderSubviews:function(){this.listenTo(this,"change:isNewConversation change:isError change:isLoading",this._setOpenViewStates),this.listenTo(this,"change:isSendingPost change:isFetching change:isError",this._setLoadingState),this.listenTo(this,"change:isOffline",this._onChangeIsOffline),this.listenTo(this,"change:canSend",this._onChangeCanSend),this.listenTo(this,"change:isMinimized",this._onChangeIsMinimized),this.listenTo(this.composeView,"submit",this._onComposeSubmit),this.listenTo(this.composeView,"resize",this._onComposeResize),this.listenTo(this.composeView,"input",this._onComposeInput),this.listenTo(this.composeView,"change:currentTumblelog",this._onComposeViewChangeBlog),this.listenTo(this.headerView,"closeClick",this._onTriggeredClose),this.listenTo(this.headerView,"minimizeClick",this._onHeaderMinimizeClick),this.listenTo(this.headerView,"moreActionsClick",this._onHeaderMoreActions),this.listenTo(this.conversation,"change:id",this._onChangeId),this.listenTo(this.conversation,"change:unreadCount",this._onChangeUnreadCount),this.listenTo(this.conversation,"change:can_send",this._onChangeConversationCanSend),this.listenTo(this.messagesView,"pillClick",this._onPillClick),this.listenTo(this.messagesView,"messageRetryClick",this._onMessageRetryClick),this.listenTo(this.composeView,"close",this._onTriggeredClose),this.listenTo(this.minimizedView,"click",this._onMinimizedViewClick),this._setLoadingState(),this._setMainViewStates(),this._setOpenViewStates(),this._onChangeConversationCanSend(this.conversation,this.conversation.get("can_send")),this._onChangeCanSend(this,this.get("canSend")),this.set({isNewConversation:this.conversation.isNew()}),this.get("isAutoFetch")&&this.fetch(),this.mainTheme=this._applyTheme(this.el),this.isMinimizeEnabled()||(this.minimizedView.remove(),this.js$("conversation-minimized").remove())},beforeRemove:function(){this.conversation.get("messages").reset(this.conversation.getInboxMessage()),this.keyboardManager.remove(this.keyboardNamespace),this.trigger("close")},fetch:function(t){return t=t||{},s.extend(t,{error:s.bind(this._onFetchConversationFail,this)}),this.set("isFetching",!0),this.eventBus.trigger(this.eventBus.CONVERSATION_FETCHING,this.conversation),this.conversation.fetchConversation(t).then(s.bind(this._onFetchConversationSuccess,this)).always(s.bind(this._onFetchConversationAlways,this))},poll:function(t,e){return t=t||{},this.eventBus.trigger(this.eventBus.CONVERSATION_FETCHING,this.conversation),this.conversation.poll(t,e).then(s.bind(function(){this.messagesView.scrollToBottom()},this))},refresh:function(t){this.conversation.appendToMessageQueue(t.getMessageQueue()),this._flushMessageQueue(),this.unminimize(),this.focus()},focus:function(){return this.composeView&&this.composeView.focus(),this},isMinimizeEnabled:function(){return this.get("isMinimizeEnabled")},isMinimized:function(){return this.get("isMinimized")},toggleMinimize:function(t){var e=this.get("minimizeOpeningClass"),i=this.get("minimizeClosingClass"),n=this.js$("conversation-open"),o=this.js$("conversation-minimized");this.isMinimizeEnabled()&&t!==this.isMinimized()&&(t?this._addAnimationClass(n,i).then(s.bind(function(){this.set("isMinimized",!0),this._addAnimationClass(o,e)},this)):this._addAnimationClass(o,i).then(s.bind(function(){this.set("isMinimized",!1),this._addAnimationClass(n,e)},this)))},minimize:function(){this.toggleMinimize(!0)},unminimize:function(){this.toggleMinimize(!1)},_showError:function(t){var e,i;return this.conversationErrorView&&this.conversationErrorView.remove(),i=this.js$("main"),e=new f(t),i.append(e.render().$el),this.conversationErrorView=e,this.set({isError:!0,isOffline:!0}),this._applyTheme(e.el),e},_hideError:function(){this.conversationErrorView&&(this.conversationErrorView.remove(),this.conversationErrorView=null),this.set({isError:!1,isOffline:!1}),this.focus()},_onFetchConversationSuccess:function(){this._flushMessageQueue(),this.rendered&&(this._hideError(),this.conversation.markAsRead())},_flushMessageQueue:function(){return this.conversation.hasQueuedMessages()?(this.rendered&&this.set("isSendingPost",!0),this.conversation.flushMessageQueue().progress(s.bind(this._onFlushProgress,this)).fail(s.bind(this._onFlushFail,this)).always(s.bind(this._onFlushAlways,this))):void 0},_onFlushProgress:function(t,e){e&&this.eventBus.trigger(this.eventBus.CONVERSATION_MESSAGE_SENT,t,this.conversation)},_onFlushFail:function(t){this.eventBus.trigger(this.eventBus.CONVERSATION_MESSAGE_FAILED,t,this.conversation),this.rendered&&t.isPost()&&(this.conversation.get("messages").remove(t),this._showPostSendingError(t))},_onFlushAlways:function(){this.rendered&&(this.set("isSendingPost",!1),this.focus())},_onFetchConversationFail:function(t,e){var i,n=e.status;this.rendered&&(i=s.get(this.customErrorMessages,n,this.getGenericErrorMessage()),this._showError({message:i,buttonCallback:s.bind(this._onConversationErrorRetryClick,this),showButton:t.canRetryFetch(s.get(e,"status"))}))},_showPostSendingError:function(t){var e,i,n;this.rendered&&(t.canRetry()?(e=this.getRetryPostErrorMessage(),n=this._onPostSendingErrorRetryClick):(e=this.permanentPostErrorMessage,i=a("Close"),n=this._onPostSendingErrorCloseClick),this._showError({message:e,buttonCallback:s.bind(n,this),buttonText:i}))},_onPostSendingErrorCloseClick:function(){this._hideError()},_onPostSendingErrorRetryClick:function(){this._flushMessageQueue().progress(s.bind(function(t){t.isPost()&&!t.isError()&&this._hideError()},this))},_onFetchConversationAlways:function(){this.rendered&&this.set("isFetching",!1)},_onComposeSubmit:function(t){var e=v.createTextMessage(t,{hasAnimation:!0});return this._sendMessage(e,{isSendingMessage:!0})},_sendMessage:function(t,e){return this.conversation.sendMessage(t,e).then(s.bind(function(){this.eventBus.trigger(this.eventBus.CONVERSATION_MESSAGE_SENT,t,this.conversation)},this)).fail(s.bind(function(){this.eventBus.trigger(this.eventBus.CONVERSATION_MESSAGE_FAILED,t,this.conversation)},this)).always(s.bind(function(){this.rendered&&this.set("isNewConversation",!1)},this))},_resendMessage:function(t){var e=this.conversation.get("messages"),i={isResendingMessage:!0};this._sendMessage(t,i).then(s.bind(function(){e.last()!==t&&(e.remove(t),t.updateClientTimestamp(),e.add(t,i))},this))},_onComposeResize:function(){this.messagesView.updateScrollBar()},_onComposeInput:function(t){this.eventBus.trigger(this.eventBus.CONVERSATION_MESSAGE_INPUT,this.conversation,t)},_onChangeId:function(t){t.isNew()||(this.set("isNewConversation",!1),this.trigger("created",t))},_onChangeUnreadCount:function(t,e){0===e||this.isMinimized()||(this.messagesView.isAtBottom()?this._fetchUnreadMessages():this.messagesView.showPill(e).then(s.bind(this._fetchUnreadMessages,this))["catch"](s.noop))},_fetchUnreadMessages:function(){var t=this.conversation.get("unreadCount"),e=Math.min(10,t+5);0!==t&&(this.conversation.markAsRead(),this.poll(null,e))},_getSortedParticipantsCopy:function(){var t=this.conversation.get("participants"),e=this.channels.getSortedIds(this.conversation.get("participant").get("uuid")),i=t.getSortedByChannels(e,!0);return new t.constructor(i)},_getNonParticipantingChannels:function(){var t=this.channels,e=this.conversation.get("participants").pluck("uuid"),i=t.filter(function(t){return!s.contains(e,t.get("uuid"))});return new t.constructor(i)},_setLoadingState:function(){this.set("isLoading",!this.get("isError")&&(this.get("isFetching")||this.get("isSendingPost")))},_setMainViewStates:function(){var t=this.get("isMinimized"),e=this.js$("conversation-open"),i=this.js$("conversation-minimized");e.toggle(!t),i.toggle(t),t?i.css("display",""):e.css("display","")},_setOpenViewStates:function(){var t=this.get("isError"),e=this.get("isLoading"),i=this.get("isNewConversation");this.messagesView.toggle(!t&&!e),this.newConversationView.$el.toggle(!t&&i),this.composeView.set("isDisabled",t||e),this.conversationLoaderView.set("loading",e)},_onTriggeredClose:function(){this.trigger("close")},_onHeaderMoreActions:function(t){this.actionsPopover&&this.actionsPopover.isOrWasRecentlyRendered()||this._showMoreActionsPopover(t)},_onHeaderMinimizeClick:function(){this.minimize()},_onMinimizedViewClick:function(){this.unminimize()},_onPillClick:function(){this.focus()},_onBlogClick:function(t){var e=n(t.currentTarget);this.eventBus.trigger(this.eventBus.CONVERSATION_OPEN_TUMBLR_URL,{blogName:e.attr("data-js-tumblelog-name"),postId:e.attr("data-js-post-id"),url:e.attr("href"),originalEvent:t})},_onActionsBlock:function(t){this.eventBus.trigger(this.eventBus.BLOCK,{currentTumblelog:this.conversation.get("participant").get("name"),blockedTumblelog:t,context:"messaging"},this.conversation)},_onActionsDelete:function(){this.eventBus.trigger(this.eventBus.CONVERSATION_DELETE_MODEL,this.conversation)},_applyTheme:function(t){var e;if(!s.isEmpty(this.otherParticipant)&&(e=this.otherParticipant.get("theme"),!s.isEmpty(e)))return new _({el:t,theme:e}).render()},_showMoreActionsPopover:function(t){var e;this.actionsPopover&&this.actionsPopover.remove(),this.actionsPopover=new b({autoTeardown:!0,pinnedSide:"bottom",pinnedTarget:t,popoverContainer:this.popoverContainer,viewOptions:{participants:this.conversation.get("participants"),user:this.user}}),e=this.actionsPopover.getView(),this.listenTo(e,"block",this._onActionsBlock),this.listenTo(e,"delete",this._onActionsDelete),this.actionsPopover.render()},_animateInMessage:function(t,e,i){var n=t.$el,a=this.composeView.$el.offset(),r=n.offset(),l=e.offset(),h=Math.max(0,a.top-r.top)+n.height(),c=a.left-l.left;this.messagesView.setIsAnimating(!0),o.animate(n,{translateY:[0,h],translateX:[0,c],opacity:[1,1]},{duration:this.get("animateInMessageDuration"),easing:this.easeOutExpo,complete:s.bind(function(){this.messagesView.setIsAnimating(!1),i.set("hasAnimation",!1),n.css("transform","")},this)})},_addAnimationClass:function(t,e){var i=new n.Deferred;return t.removeClass(e),c(t,function(){t.removeClass(e),i.resolve()}),t.addClass(e),i},_onConversationErrorRetryClick:function(t){return this.fetch()},_onChangeIsOffline:function(t,e){this.composeView.set("isOffline",e)},_onMessageRetryClick:function(t){this._resendMessage(t)},_onChangeConversationCanSend:function(t,e){this.set("canSend",e)},_onChangeCanSend:function(t,e){var i=a("This Tumblr can't receive messages.");this.composeView.$el.toggle(e),e?this.canSendErrorView&&this.canSendErrorView.remove():this.canSendErrorView||(this.canSendErrorView=this.messagesView.addErrorMessage(i))},_onChangeIsMinimized:function(t,e){this._setMainViewStates(),e||s.defer(s.bind(function(){this.messagesView.updateScrollBar(),this.focus(),this.conversation.get("unreadCount")>0&&(this._fetchUnreadMessages(),this.messagesView.scrollToBottom())},this))},_onComposeViewChangeBlog:function(t,e){
var i=new v({participant:e,participants:[e,this.otherParticipant]});this.eventBus.trigger(this.eventBus.CONVERSATION_OPEN_CONVERSATION_MODEL,i)},_onMainContainerClick:function(){window.getSelection().isCollapsed&&this.focus()}});e.exports=C},{"../../lib/random-text-responder":116,"../../models/conversation":122,"../../templates/conversation/index.tpl":143,"./conversation-actions-popover":155,"./conversation-compose":157,"./conversation-error":158,"./conversation-header":159,"./conversation-messages":165,"./conversation-minimized":166,"./conversation-new":167,"./conversation-theme":170,"app/components/messaging/lib/message-formatter":108,"components/knight-rider-loader":461,jquery:"HlZQrA",lodash:"MicNly","prima/lib/translate":541,"prima/mixins/selectorcache":553,"prima/utils/bindendevent":560,"prima/views/base":581,"velocity-animate":"lWl/mc"}],172:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/views/base"),o=n.extend({renderWithTemplate:s.noop,initialize:function(t){t=s.extend({},t),s.extend(this.attributes,s.pick(t,s.keys(this.defaults))),s.extend(this,s.pick(t,"channels"))},afterRender:function(){this.listenTo(this.channels,"change:unread_messages_count_sum",this._onChangeChannelUnreadCount),this._onChangeChannelUnreadCount()},updateBadge:function(t){t>0&&this.$(".tab_notice_value").text(t>99?"99+":t),this.$(".tab_notice").toggleClass("tab-notice--active",t>0)},_onChangeChannelUnreadCount:function(){this.updateBadge(s.sum(this.channels.pluck("unread_messages_count_sum")))}});e.exports=o},{lodash:"MicNly","prima/views/base":581}],173:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/views/base"),o=t("../../templates/inbox/inbox-compose-toggle.tpl"),a=n.extend({className:"inbox-compose-toggle",template:o,defaults:{isComposing:!1},events:{"click [data-js-compose-toggle]":"_onClickToggleCompose"},initialize:function(t){t=s.extend({},t),s.extend(this.attributes,s.pick(t,s.keys(this.defaults))),s.extend(this,s.pick(t,"eventBus"))},afterRender:function(){this.listenTo(this,"change:isComposing",this._onChangeIsComposing)},_onChangeIsComposing:function(t,e){this.$el.toggleClass("active",e)},_onClickToggleCompose:function(t){t.preventDefault(),this.set("isComposing",!this.get("isComposing"))}});e.exports=a},{"../../templates/inbox/inbox-compose-toggle.tpl":144,lodash:"MicNly","prima/views/base":581}],174:[function(t,e,i){"use strict";var s=t("lodash"),n=t("jquery"),o=t("prima/lib/translate"),a=t("prima/views/base"),r=t("prima/mixins/selectorcache"),l=t("../../collections/compose-recipients"),h=t("./inbox-recipients"),c=t("components/loader"),u=t("../../templates/inbox/inbox-compose.tpl"),d=a.extend({className:"inbox-compose",template:u,defaults:{isShowFavorites:!0,isLoading:!1,showLoadingAfterMs:250,hasEditorFocus:!1},events:{"input [data-js-textinput]":"_onTextInputChange","focus [data-js-textinput]":"_onTextInputFocus","blur [data-js-textinput]":"_onTextInputBlur"},mixins:[r],subviews:{favoritesView:{constructor:h,options:function(t){return{showMessageOnEmpty:!1,eventBus:t.eventBus,collection:t.favoritesCollection,title:o("Favorites"),context:"inbox:favorites"}}},searchResultView:{constructor:h,options:function(t){return{eventBus:t.eventBus,collection:t.collection,context:"inbox:typeahead"}}}},initialize:function(t){t=s.extend({},t),s.extend(this.attributes,s.pick(t,s.keys(this.defaults))),s.extend(this,s.pick(t,"eventBus","favoritesCollection","currentBlogModel","keyboardManager")),this.collection=new l,this._debouncedSearch=s.bind(s.debounce(this._search,250),this)},afterRenderSubviews:function(){this.loader=new c({$container:this.$el,type:"bar",classModifiers:"top",loading:!1}),this.listenTo(this,"change:isShowFavorites",this._onChangeIsShowFavorites),this.listenTo(this,"change:isLoading",this._onChangeIsLoading),this.listenTo(this,"change:hasEditorFocus",this._onChangeHasEditorFocus),this._onChangeIsShowFavorites(this,this.get("isShowFavorites"))},_setKeyboardState:function(){this.keyboardManager.remove("inbox:compose"),this.get("hasEditorFocus")&&(this.get("isShowFavorites")?this.keyboardManager.add("inbox:compose:favorites",this.favoritesView):this.keyboardManager.add("inbox:compose:results",this.searchResultView))},_onChangeHasEditorFocus:function(t,e){this._setKeyboardState()},fetchResults:function(t){var e=this.currentBlogModel.getChannel().get("uuid");return this.set("isLoading",!0),this.collection.fetchByQuery(t,e).always(s.bind(function(){this.rendered&&this.set({isShowFavorites:!1,isLoading:!1})},this))},clear:function(){this.js$("textinput").val("")},focus:function(){this.js$("textinput").focus()},blur:function(){this.js$("textinput").blur()},beforeRemove:function(){this.keyboardManager.remove("inbox:compose")},_search:function(t){s.isEmpty(t)?this.set("isShowFavorites",!0):this.fetchResults(t)},_onTextInputChange:function(t){this._debouncedSearch(n(t.target).val())},_onTextInputBlur:function(t){this.set("hasEditorFocus",!1)},_onTextInputFocus:function(t){this.set("hasEditorFocus",!0)},_onChangeIsShowFavorites:function(t,e){this.favoritesView.toggle(e),this.searchResultView.toggle(!e),this._setKeyboardState()},_onChangeIsLoading:function(t,e){return this._loaderTimeout&&(clearTimeout(this._loaderTimeout),this._loaderTimeout=null),e?void(this._loaderTimeout=setTimeout(s.bind(function(){this.loader.set("loading",!0)},this),this.get("showLoadingAfterMs"))):this.loader.set("loading",!1)}});e.exports=d},{"../../collections/compose-recipients":95,"../../templates/inbox/inbox-compose.tpl":145,"./inbox-recipients":182,"components/loader":464,jquery:"HlZQrA",lodash:"MicNly","prima/lib/translate":541,"prima/mixins/selectorcache":553,"prima/views/base":581}],175:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/views/base"),o=t("../../templates/inbox/inbox-conversation.tpl"),a=t("../../lib/multiline-truncate"),r=t("prima/mixins/selectorcache"),l=n.extend({className:"inbox-conversation",template:o,mixins:[r],defaults:{maxInitialMessageLength:100,currentMessage:null},events:{"click [data-open-conversation]":"_onClickConversation"},initialize:function(t){t=s.extend({},t),s.extend(this.attributes,s.pick(t,s.keys(this.defaults))),s.extend(this,s.pick(t,"eventBus","channels","currentBlogModel")),this.participants=this.model.get("participants"),this.sortedParticipants=this.participants.getSortedByChannels(this._getOwnSortedBlogIds()),this.otherParticipant=s.first(this.sortedParticipants),this.set("currentMessage",this.model.getInboxMessage())},afterRender:function(){this.listenTo(this.model,"change:last_read_ts change:last_modified_ts",this._onChangeTimestamps),this.listenTo(this,"change:currentMessage",this._onChangeCurrentMessage),this._onChangeCurrentMessage(this,this.get("currentMessage"))},openConversation:function(){this.eventBus.trigger(this.eventBus.CONVERSATION_OPEN_CONVERSATION_MODEL,this.model,"inbox")},getTemplateData:function(){return{name:this.otherParticipant.get("name"),avatarUrl:this.otherParticipant.getAvatarUrl(),message:this._getMessageText(this.get("currentMessage")),additionalBlogName:this._getAdditionalBlogName(this.get("currentMessage"))}},getMessageParticipant:function(t){return this.participants.get(t.get("participant"))},_getMessageText:function(t){var e,i,n;return s.isEmpty(t)?"":(e=t.getMessage(),t.isPost()&&(i=this.getMessageParticipant(t),n=t.get("post").getSentString(),e=s.compact([n,e]).join(" ")),s.isEmpty(e)?"":e.substring(0,this.get("maxInitialMessageLength")))},_safeTruncateMessage:function(t){var e=this.js$("message"),i=this.js$("message-text"),n=function(){a(e),s.isFunction(t)&&t.call(this,i.text())};e.height()?n.call(this):(this.$el.css("visibility","hidden"),s.defer(s.bind(function(){this.rendered&&(n.call(this),this.$el.css("visibility",""))},this)))},_isLastMessageFromSelf:function(t){return!s.isEmpty(t)&&!s.isEmpty(this.otherParticipant)&&this.otherParticipant.get("uuid")!==t.get("uuid")},_getAdditionalBlogName:function(t){var e;return s.isEmpty(t)?null:(e=this.getMessageParticipant(t),s.isEmpty(e)?null:this._isLastMessageFromSelf(e)?e.get("name"):void 0)},_onChangeTimestamps:function(t){this.set("currentMessage",this.model.getInboxMessage())},_onChangeCurrentMessage:function(t,e){var i=this.getMessageParticipant(e),n=e.get("truncatedText"),o=this._getAdditionalBlogName(e);this.js$("additional-blog-name").text(o).toggle(!s.isEmpty(o)),this.$el.toggleClass("is-unread",this.model.isUnread()&&!this._isLastMessageFromSelf(i)),s.isEmpty(n)?(this.js$("message-text").text(this._getMessageText(e)),this._safeTruncateMessage(function(t){e.set("truncatedText",t)})):this.js$("message-text").text(n)},_onClickConversation:function(t){t.preventDefault(),this.openConversation()},_getOwnSortedBlogIds:function(){return this.channels.getSortedIds(this.currentBlogModel.getId())}});e.exports=l},{"../../lib/multiline-truncate":115,"../../templates/inbox/inbox-conversation.tpl":146,lodash:"MicNly","prima/mixins/selectorcache":553,"prima/views/base":581}],176:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/lib/translate"),o=t("prima/views/base"),a=t("prima/mixins/collection-view"),r=t("prima/mixins/selectorcache"),l=t("components/knight-rider-loader"),h=t("./inbox-conversation"),c=t("../../lib/infinite-scrollbar"),u=t("./inbox-recipients"),d=t("../../templates/inbox/inbox-conversations.tpl"),p=o.extend({className:"inbox-conversations",template:d,mixins:[r,a],defaults:{isPaginating:!1,showFavorites:!1,hasNextPage:!0,showLoadingContainer:!0,appendFavoritesToInboxLimit:3},subviews:{conversations:{constructor:h,enableBatchRendering:!0,options:function(t){return{eventBus:t.eventBus,channels:t.channels,currentBlogModel:t.currentBlogModel}},collection:function(t){return t.collection}},paginationLoaderView:{constructor:l,options:{variation:"small h-centered",loading:!1}},favoritesView:{constructor:u,options:function(t){return{showMessageOnEmpty:!1,eventBus:t.eventBus,collection:t.favoritesCollection,title:n("More Tumblrs to talk to"),context:"inbox:moretumblrs"}}}},initialize:function(t){t=s.extend({},t),s.extend(this.attributes,s.pick(t,s.keys(this.defaults))),s.extend(this,s.pick(t,"eventBus","collection","channels","favoritesCollection","currentBlogModel"))},afterRenderSubviews:function(){this.scrollBar=new c({el:this.el}),this.listenTo(this,"change:isPaginating",this._onChangeIsPaginating),this.listenTo(this,"change:showFavorites",this._onChangeShowFavorites),this.listenTo(this,"change:hasNextPage",this._onChangeHasNextPage),this.listenTo(this,"change:showLoadingContainer",this._onChangeShowLoadingContainer),this.listenTo(this.collection,"sort",this._onCollectionSort),this.listenTo(this.collection,"update reset change",this._onCollectionChange),this.listenTo(this.favoritesCollection,"update reset",this._onFavoritesCollectionChange),this.listenTo(this.collection,"reset",this._onCollectionReset),this.listenTo(this,"batch:rendered:conversations",this._onConversationsBatchRendered),this.listenTo(this.collection,"sync",this._onCollectionSync),this.listenTo(this.collection,"change:hasNextPage",this._onChangeCollectionHasNextPage),this.listenTo(this.scrollBar,"scrollbottom",this._onScrollBottom),this._setViewStates(),this._onChangeCollectionHasNextPage(this.collection,this.collection.hasNextPage()),this._onChangeShowFavorites(this,this.get("showFavorites")),this._onChangeHasNextPage(this,this.get("hasNextPage")),this._onChangeShowLoadingContainer(this,this.get("showLoadingContainer")),s.defer(s.bind(this.updateScrollBar,this))},toggle:function(t){this.$el.toggle(t),this.updateScrollBar()},beforeRemove:function(){this.scrollBar&&this.scrollBar.destroy()},getNextPage:function(){this.rendered&&this.collection.hasNextPage()&&(this.set("isPaginating",!0),this.collection.fetchNextPage().always(s.bind(function(){this.rendered&&this.set("isPaginating",!1)},this)))},updateScrollBar:function(){this.scrollBar&&this.scrollBar.update()},_setViewStates:function(){var t=this.get("hasNextPage"),e=this.collection.length>0&&!t&&this.collection.length<=this.get("appendFavoritesToInboxLimit");this.set({showFavorites:e,showLoadingContainer:t}),this.updateScrollBar()},_saveModelOrder:function(){this.lastModelOrder=this._getModelOrderString()},_getModelOrderString:function(){return s.pluck(this.collection.models,"cid").join(" ")},_onCollectionSort:function(t){var e=this._getModelOrderString();this.lastModelOrder&&-1===e.indexOf(this.lastModelOrder)&&this.renderCollectionSubviews("conversations"),this._saveModelOrder()},_onCollectionChange:function(t,e){this._setViewStates(),this._saveModelOrder()},_onCollectionSync:function(){this._onChangeCollectionHasNextPage(this.collection,this.collection.hasNextPage())},_onCollectionReset:function(t){this.$el.scrollTop(0),this._saveModelOrder()},_onConversationsBatchRendered:function(){this.updateScrollBar()},_onChangeCollectionHasNextPage:function(t,e){this.set("hasNextPage",e&&t.length>=10)},_onChangeHasNextPage:function(t,e){this._setViewStates()},_onChangeIsPaginating:function(t,e){this.paginationLoaderView.set("loading",e)},_onScrollBottom:function(t){t&&this.getNextPage()},_onChangeShowFavorites:function(t,e){this.favoritesView.$el.toggle(e)},_onChangeShowLoadingContainer:function(t,e){this.js$("loader-container").toggle(e)},_onFavoritesCollectionChange:function(){this.updateScrollBar()}});e.exports=p},{"../../lib/infinite-scrollbar":104,"../../templates/inbox/inbox-conversations.tpl":147,"./inbox-conversation":175,"./inbox-recipients":182,"components/knight-rider-loader":461,lodash:"MicNly","prima/lib/translate":541,"prima/mixins/collection-view":544,"prima/mixins/selectorcache":553,"prima/views/base":581}],177:[function(t,e,i){"use strict";var s=t("lodash"),n=t("jquery"),o=t("prima/views/base"),a=t("../../templates/inbox/inbox-empty-blogs.tpl"),r=o.extend({className:"inbox-empty-blogs",template:a,defaults:{numItemsPerRow:4},events:{"click [data-js-start-conversation]":"_onStartConversation"},initialize:function(t){t=s.extend({},t),s.extend(this.attributes,s.pick(t,s.keys(this.defaults))),s.extend(this,s.pick(t,"eventBus","collection"))},afterRender:function(){this.listenTo(this.collection,"update reset",this.render)},getTemplateData:function(){var t,e=this.get("numItemsPerRow"),i=s.map(this.collection.models,function(t){return s.extend(t.toJSON(),{avatarUrl:t.getAvatarUrl()})});return i.length>0&&(t=Math.max(1,Math.floor(i.length/e)),i=i.slice(0,t*e)),{blogs:i}},_onStartConversation:function(t){var e=n(t.currentTarget).attr("data-js-start-conversation"),i=this.collection.findWhere({name:e});this.eventBus.trigger(this.eventBus.CONVERSATION_OPEN_PARTICIPANT_MODELS,[i],"inbox:empty"),t.preventDefault()}});e.exports=r},{"../../templates/inbox/inbox-empty-blogs.tpl":148,jquery:"HlZQrA",lodash:"MicNly","prima/views/base":581}],178:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/lib/translate"),o=t("prima/mixins/selectorcache"),a=t("prima/views/base"),r=t("./inbox-empty-blogs"),l=t("../../templates/inbox/inbox-empty.tpl"),h=a.extend({className:"inbox-empty",template:l,mixins:[o],subviews:{blogsView:{constructor:r,options:function(t){return{collection:t.collection,eventBus:t.eventBus}}}},initialize:function(t){t=s.extend({},t),s.extend(this.attributes,s.pick(t,s.keys(this.defaults))),s.extend(this,s.pick(t,"eventBus","collection"))},getTemplateData:function(){return{header:n("Talk to a Tumblr")}},toggle:function(t){this.$el.toggle(t)}});e.exports=h},{"../../templates/inbox/inbox-empty.tpl":149,"./inbox-empty-blogs":177,lodash:"MicNly","prima/lib/translate":541,"prima/mixins/selectorcache":553,"prima/views/base":581}],179:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/views/base"),o=t("./inbox-sender"),a=t("./inbox-compose-toggle"),r=t("../../templates/inbox/inbox-header.tpl"),l=n.extend({className:"inbox-header",template:r,defaults:{isComposing:!1},subviews:{senderView:{constructor:o,options:function(t){return{eventBus:t.eventBus,user:t.user,channels:t.channels,popoverContainer:t.popoverContainer,currentBlogModel:t.currentBlogModel}}},composeToggleView:{constructor:a,options:function(t){return{eventBus:t.eventBus}}}},initialize:function(t){t=s.extend({},t),s.extend(this.attributes,s.pick(t,s.keys(this.defaults))),s.extend(this,s.pick(t,"eventBus","user","channels","popoverContainer","currentBlogModel"))},afterRenderSubviews:function(){this.listenTo(this.composeToggleView,"change:isComposing",function(t,e){this.set("isComposing",e)}),this.listenTo(this,"change:isComposing",function(t,e){this.composeToggleView.set("isComposing",e)})}});e.exports=l},{"../../templates/inbox/inbox-header.tpl":150,"./inbox-compose-toggle":173,"./inbox-sender":183,lodash:"MicNly","prima/views/base":581}],180:[function(t,e,i){"use strict";var s=t("lodash"),n=t("jquery"),o=t("prima/views/base"),a=t("prima/mixins/popoverbase"),r=t("./index"),l=t("prima/utils/bindendevent").transition,h=o.extend({className:"popover--inbox-popover",mixins:[a],initialize:function(t){t=s.extend({},t),s.extend(this.attributes,s.pick(t,s.keys(this.defaults))),s.extend(this,s.pick(t,"viewOptions"))},render:function(){return this.$wrapper=n("<div />").addClass("popover-inner").appendTo(this.$el),this.$wrapper.addClass("hide-popover"),this.$pinned.addClass("active"),this._createView(this.viewOptions),s.defer(s.bind(function(){this.$wrapper.removeClass("hide-popover")},this)),this},teardown:function(){return l(this.$wrapper,s.bind(this._afterHide,this)),this.$wrapper.addClass("hide-popover"),this.$pinned.removeClass("active"),this},_createView:function(t){t=s.isFunction(t)?t.call(this,this):t,this.inboxView&&this.inboxView.remove(),this.inboxView=new r(t),this.$wrapper.html(this.inboxView.render().$el)},_afterHide:function(){this.inboxView&&this.inboxView.remove(),this.$el.remove()}});e.exports=h},{"./index":184,jquery:"HlZQrA",lodash:"MicNly","prima/mixins/popoverbase":550,"prima/utils/bindendevent":560,"prima/views/base":581}],181:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/views/base"),o=t("../../templates/inbox/inbox-recipient.tpl"),a=n.extend({className:"inbox-recipient",template:o,defaults:{isSelected:!1,context:"inbox:recipients"},events:{"click [data-start-conversation]":"_onStartConversationClick",mouseenter:"_onRecipientHover",mouseleave:"_onRecipientLeave"},initialize:function(t){t=s.extend({},t),s.extend(this.attributes,s.pick(t,s.keys(this.defaults))),s.extend(this,s.pick(t,"eventBus","onSelect","onClear","context"))},afterRender:function(){this.listenTo(this,"change:isSelected",this._onChangeIsSelected)},setSelected:function(t){this.rendered&&this.set("isSelected",t)},getTemplateData:function(){return{name:this.model.get("name"),title:this.model.get("title"),avatarUrl:this.model.getAvatarUrl()}},_onStartConversationClick:function(t){t.preventDefault(),this.eventBus.trigger(this.eventBus.CONVERSATION_OPEN_PARTICIPANT_MODELS,[this.model],this.get("context"))},_onChangeIsSelected:function(t,e){this.$el.toggleClass("selected",e)},_onRecipientHover:function(){s.isFunction(this.onSelect)&&this.onSelect(this,this.model)},_onRecipientLeave:function(){s.isFunction(this.onClear)&&this.onClear(this,this.model)}});e.exports=a},{"../../templates/inbox/inbox-recipient.tpl":151,lodash:"MicNly","prima/views/base":581}],182:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/views/base"),o=t("prima/mixins/collection-view"),a=t("prima/mixins/selectorcache"),r=t("prima/mixins/keycommands"),l=t("../../mixins/selectable-subviews"),h=t("./inbox-recipient"),c=t("../../templates/inbox/inbox-recipients.tpl"),u=n.extend({className:"inbox-recipients",template:c,mixins:[a,r,o,l],keycommands:{"keydown:down":"_onKeyPressDown","keydown:up":"_onKeyPressUp","keydown:enter":"_onKeyPressEnter"},defaults:{isEmpty:!0,showMessageOnEmpty:!0,selectedView:null,context:"inbox:recipients"},subviews:{recipients:{constructor:h,options:function(t){return{eventBus:t.eventBus,onSelect:s.bind(t._onSubviewSelect,t),onClear:s.bind(t._onSubviewClear,t),context:t.context}},collection:function(t){return t.collection}}},initialize:function(t){t=s.extend({},t),s.extend(this.attributes,s.pick(t,s.keys(this.defaults))),s.extend(this,s.pick(t,"eventBus","collection","title","context")),this.keyboardViewName="recipients",this.disableKeys()},afterRender:function(){this.listenTo(this.collection,"reset update",this._onCollectionChange),this.listenTo(this.collection,"sync",this._onCollectionSync),this.listenTo(this.collection,"sort",this._onCollectionSort),this.listenTo(this,"change:isEmpty",this._onChangeIsEmpty),this.listenTo(this,"change:selectedView",this._onChangeSelectedView),this._onCollectionChange(this.collection),this._onChangeIsEmpty(this,this.get("isEmpty"))},getTemplateData:function(){return{title:this.title,noResultsText:this.collection.getNoResultsFoundMessage()}},toggle:function(t){this.$el.toggle(t),t&&this.deselect(this.keyboardViewName)},_onChangeSelectedView:function(t,e){var i=this.previous("selectedView");i&&i.setSelected(!1),e&&e.setSelected(!0)},_onChangeIsEmpty:function(t,e){this.get("showMessageOnEmpty")?this.js$("no-results-container").toggle(e):(this.js$("container").toggle(!e),this.js$("no-results-container").hide())},_shuffleNoResultsText:function(){this.js$("no-results-text").text(this.collection.getNoResultsFoundMessage())},_onCollectionSort:function(){this.renderCollectionSubviews("recipients")},_onCollectionChange:function(t){this.set("isEmpty",0===t.length),this.deselect(this.keyboardViewName)},_onCollectionSync:function(t){0===t.length&&this.get("showMessageOnEmpty")&&this._shuffleNoResultsText()},_onSubviewSelect:function(t){this.set("selectedView",t),this.setSelectedIndex(this.keyboardViewName,s.indexOf(this.recipients,t))},_onSubviewClear:function(t){this.set("selectedView",null),this.deselect(this.keyboardViewName)},_onKeyPressDown:function(t){var e;t.preventDefault(),e=this.isLastSelected(this.keyboardViewName)?this.selectFirst(this.keyboardViewName):this.selectNext(this.keyboardViewName),this.set("selectedView",e)},_onKeyPressUp:function(t){var e;t.preventDefault(),e=this.isFirstSelected(this.keyboardViewName)?this.selectLast(this.keyboardViewName):this.selectPrevious(this.keyboardViewName),this.set("selectedView",e)},_onKeyPressEnter:function(t){var e,i=this.get("selectedView");t.preventDefault(),i?e=i.model:1===this.collection.length&&(e=this.collection.first()),e&&this.eventBus.trigger(this.eventBus.CONVERSATION_OPEN_PARTICIPANT_MODELS,[e],this.context)}});e.exports=u},{"../../mixins/selectable-subviews":118,"../../templates/inbox/inbox-recipients.tpl":152,"./inbox-recipient":181,lodash:"MicNly","prima/mixins/collection-view":544,"prima/mixins/keycommands":547,"prima/mixins/selectorcache":553,"prima/views/base":581}],183:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/views/base"),o=t("app/components/blog-selector"),a=t("../../templates/inbox/inbox-sender.tpl"),r=n.extend({className:"inbox-sender",template:a,subviews:{blogSelector:{constructor:o,options:function(t){return{className:"inbox-sender-blog-selector",collection:t.channels,popoverOptions:{popoverContainer:t.popoverContainer},currentTumblelog:t.channels.findWhere({uuid:t.currentBlogModel.getId()}),badgeCountField:"unread_messages_count_sum"}}}},initialize:function(t){t=s.extend({},t),s.extend(this.attributes,s.pick(t,s.keys(this.defaults))),s.extend(this,s.pick(t,"eventBus","user","channels","currentBlogModel","popoverContainer"))},afterRenderSubviews:function(){this.listenTo(this.blogSelector,"change:currentTumblelog",this._onBlogSelectorChange)},_onBlogSelectorChange:function(t,e){this.currentBlogModel.setChannel(e)}});e.exports=r},{"../../templates/inbox/inbox-sender.tpl":153,"app/components/blog-selector":37,lodash:"MicNly","prima/views/base":581}],184:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/mixins/selectorcache"),o=t("prima/views/base"),a=t("components/loader"),r=t("./inbox-conversations"),l=t("./inbox-header"),h=t("./inbox-compose"),c=t("./inbox-empty"),u=t("../../templates/inbox/index.tpl"),d=o.extend({className:"messaging-inbox",template:u,defaults:{isLoading:!1,isAutoFetch:!0,isEmpty:!1,isLoadingEmptyInboxFavorites:!1,numFavorites:5},mixins:[n],subviews:{headerView:{constructor:l,options:function(t){return{eventBus:t.eventBus,user:t.user,channels:t.channels,currentBlogModel:t.currentBlogModel,popoverContainer:t.popoverContainer}}},composeView:{constructor:h,options:function(t){return{eventBus:t.eventBus,favoritesCollection:t.favoritesCollection,currentBlogModel:t.currentBlogModel,keyboardManager:t.keyboardManager}}},conversationsView:{constructor:r,options:function(t){return{eventBus:t.eventBus,collection:t.collection,emptyInboxCollection:t.emptyInboxCollection,currentBlogModel:t.currentBlogModel,channels:t.channels,favoritesCollection:t.favoritesCollection,appendFavoritesToInboxLimit:t.appendFavoritesToInboxLimit}}},emptyView:{constructor:c,options:function(t){return{eventBus:t.eventBus,collection:t.emptyInboxCollection}}}},initialize:function(t){t=s.extend({},t),s.extend(this.attributes,s.pick(t,s.keys(this.defaults))),s.extend(this,s.pick(t,"eventBus","collection","user","channels","favoritesCollection","emptyInboxCollection","popoverContainer","currentBlogModel","appendFavoritesToInboxLimit","keyboardManager"))},afterRenderSubviews:function(){this.loader=new a({$container:this.$el,type:"bar",classModifiers:"top",loading:!1}),this.set({isLoading:!this.getCurrentChannel().get("isInboxFetched"),isEmpty:0===this.collection.length}),this.listenTo(this,"change",this._setViewStates),this.listenTo(this.collection,"sync error",this._onSyncCollection),this.listenTo(this.collection,"update reset",this._onChangeCollection),this.listenTo(this.collection,"request",this._onRequestCollection),this.listenTo(this.composeView,"submit",this._onComposeSubmitRecipient),this.listenTo(this.headerView,"change:isComposing",this._setViewStates),this._setViewStates(),this.get("isAutoFetch")&&this.fetch(),this._fetchEmptyInboxFavorites()},beforeRemove:function(){this.keyboardManager.remove("inbox")},getCurrentChannel:function(){return this.currentBlogModel.getChannel()},fetch:function(t){this.collection.fetchInbox(this.currentBlogModel.getId(),t)},_onComposeSubmitRecipient:function(t){this.eventBus.trigger(this.eventBus.CONVERSATION_OPEN_PARTICIPANT_NAMES,t)},_setViewStates:function(){var t=this.get("isEmpty"),e=this.get("isLoading")||this.get("isLoadingEmptyInboxFavorites"),i=this.headerView.get("isComposing");this.loader.set("loading",e&&!i),this.conversationsView.toggle(!i&&!t&&!e),this.emptyView.toggle(t&&!i&&!e),this.composeView.$el.toggle(i),i&&this.composeView.focus()},_onChangeCollection:function(){this.set("isEmpty",0===this.collection.length)},_onSyncCollection:function(){this.set({isLoading:!1,isEmpty:0===this.collection.length}),this.getCurrentChannel().set("isInboxFetched",!0)},_onRequestCollection:function(t,e,i){this.set({isEmpty:0===this.collection.length,isLoading:!this.getCurrentChannel().get("isInboxFetched")})},_fetchEmptyInboxFavorites:function(){this.set("isLoadingEmptyInboxFavorites",!0),this.emptyInboxCollection.fetchFavorites().then(s.bind(function(){this.rendered&&this.favoritesCollection.reset(s.take(this.emptyInboxCollection.toJSON(),this.get("numFavorites")))},this)).always(s.bind(function(){this.rendered&&this.set("isLoadingEmptyInboxFavorites",!1)},this))}});e.exports=d},{"../../templates/inbox/index.tpl":154,"./inbox-compose":174,"./inbox-conversations":176,"./inbox-empty":178,"./inbox-header":179,"components/loader":464,lodash:"MicNly","prima/mixins/selectorcache":553,"prima/views/base":581}],185:[function(t,e,i){"use strict";var s=t("jquery"),n=t("lodash"),o=t("prima/component"),a=t("components/popover").FeatureHelpPopoverView,r=t("app/components/confetti/views/confetti-view"),l=o.extend({name:"MessagingTutorial",initialize:function(t){t=n.extend({},t),n.extend(this.attributes,n.pick(t,n.keys(this.defaults))),n.extend(this,n.pick(t,"viewOptions")),this.viewOptions=n.extend({},this.viewOptions,{name:"messaging",template:"standard",className:"messaging-tutorial-popover",glass:!0,position:a.POSITION.BOTTOM,isFadeOnScroll:!1})},render:function(){var t;this.popover=this.createPopover(),this.confettiView=this.createConfetti(),t=s("<div />").addClass("messaging-tutorial-confetti"),t.append(this.confettiView.$el),this.popover.show(this.viewOptions),this.popover.getGlassElement().after(t),this.confettiView.render()},createConfetti:function(){var t=new r({autoParty:!0,amount:50});return t.$el.on("click",n.bind(this._onConfettiClick,this)),t},createPopover:function(){var t=new a;return this.listenTo(t,"dismiss",this._onPopoverDismiss),this.listenTo(t,"removed",this._onPopoverRemoved),t},setSeen:function(){s.ajax({url:"/svc/conversations/tutorial_seen",method:"POST",with_form_key:!0,dataType:"json"})},hideTutorial:function(){this.popover.hide()},_onConfettiClick:function(){this.popover.hide()},_onPopoverDismiss:function(){this.trigger("dismiss")},_onPopoverRemoved:function(){this.remove()},remove:function(){return this.confettiView&&this.confettiView.remove(),this.trigger("hide"),this.setSeen(),o.prototype.remove.apply(this,arguments)}});e.exports=l},{"app/components/confetti/views/confetti-view":43,"components/popover":469,jquery:"HlZQrA",lodash:"MicNly","prima/component":511}],186:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/events"),o=t("app/models/post"),n=t("prima/events"),a=t("prima/collection"),r=t("../models/header"),l=a.extend({model:o,url:"/svc/indash_blog/posts",blogNameOrId:"",_hasFetchedEverything:!1,initialize:function(t,e){this.loading=!1,this.tumblelog=new r,e=e||{},this.blogNameOrId=e.blogNameOrId,this.postId=e.postId,e.url&&(this.url=e.url),this.listenTo(n,"indashblog:post:like",this.likePostbyId),this.bindBlogSearchEvents()},bindBlogSearchEvents:function(){this.listenTo(n,"indashblog:search:start",this.blogSearchStarted),this.listenTo(n,"indashblog:search:complete",this.blogSearchCompleted),this.listenTo(n,"indashblog:search:post-added",this.blogSearchPostAdded),this.listenTo(n,"indashblog:search:results-end",this.blogSearchResultsEnd),this.listenTo(n,"indashblog:search:clear",this.blogSearchClear)},blogSearchStarted:function(){this.searchMode=!0,this.reset(),this.trigger("request",this),this.loading=!0,n.trigger("indashblog:search:fetch-requested")},blogSearchPostAdded:function(t){this.add(t)},blogSearchCompleted:function(t){this.reset(t),this.trigger("sync",this),this.loading=!1},blogSearchResultsEnd:function(t){this._hasFetchedEverything=!0,this.loading=!1,this.trigger("sync",this)},blogSearchClear:function(){this.searchMode=!1,this.reset(),this.trigger("request",this),this.fetch()},fetch:function(t){return this.loading?void 0:this.searchMode?(this.trigger("request",this),void n.trigger("indashblog:search:fetch-requested",t)):(t=t||{},t.blogNameOrId&&(this.blogNameOrId=t.blogNameOrId),t.data={tumblelog_name_or_id:this.blogNameOrId,post_id:this.postId||null,limit:this.postId?1:t.limit||10,offset:t.offset||0},this.loading=!0,a.prototype.fetch.call(this,t))},fetchMore:function(t){if(t=t||{},!this.hasFetchedEverything()&&!this.loading){if(this.searchMode)return this.trigger("request",this),void n.trigger("indashblog:search:fetch-requested",t);var e=this.models.length;return this.postId&&(e-=1,this.postId=null),t=s.extend({offset:e,remove:!1},t),this.fetch(t)}},parse:function(t,e){return(!t.response.posts.length||t.response.posts.length<e.data.limit)&&(this._hasFetchedEverything=!0),t.response.tumblelog&&this.tumblelog.set(t.response.tumblelog),t.response.tracking_html&&!s.isEmpty(t.response.tracking_html)&&n.trigger("component:TrackingPixels",{init:t.response.tracking_html}),this.loading=!1,t.response.posts},reset:function(){this._hasFetchedEverything=!1,a.prototype.reset.apply(this,arguments)},hasFetchedEverything:function(){return this._hasFetchedEverything},likePostbyId:function(t,e){var i=this.get(t);i&&(e=e||"mouse",i.like(e),n.trigger("peepr:like_update",i.get("tumblelog"),i.toJSON()))}});e.exports=l},{"../models/header":195,
"app/models/post":435,lodash:"MicNly","prima/collection":510,"prima/events":512}],187:[function(t,e,i){"use strict";e.exports=t("./views/messaging-popover-icon")},{"./views/messaging-popover-icon":191}],188:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __t,__p="";Array.prototype.join;with(obj||{})__p+=""+(null==(__t=_("Send a message"))?"":_.escape(__t));return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],189:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __t,__p="";Array.prototype.join;with(obj||{})__p+="",hasAsks&&(__p+='<li data-js-ask><a class="ask" href="'+(null==(__t=url)?"":_.escape(__t))+'/ask">'+(null==(__t=_("Ask a question"))?"":_.escape(__t))+"</a></li>"),__p+="",hasMessaging&&(__p+='<li data-js-message><a href="#">'+(null==(__t=_("Send a message"))?"":_.escape(__t))+"</a></li>"),__p+="";return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],190:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __p="";Array.prototype.join;with(obj||{})__p+='<div class="popover_inner"></div>';return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],191:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/events"),o=t("prima/views/base"),a=t("./messaging-popover"),r=t("../templates/messaging-popover-icon.tpl"),l=o.extend({template:r,className:"messaging-popover-icon nav_icon",events:{click:"_onIconClick"},initialize:function(t){this.options=s.extend({},this.defaults,t),s.extend(this,s.pick(t,"model"))},showPopover:function(){this.popover||(this.popover=new a({pinnedTarget:this.$el,model:this.model,preventInteraction:!0}),this.popover.render(),this.listenTo(this.popover.getView(),"messagingSelected",this._onMessagingSelected),this.listenTo(this.popover.getView(),"askSelected",this._onAskSelected),this.listenTo(this.popover,"close",this._onPopoverClose))},openMessaging:function(){n.trigger("messaging:conversation:open:tumblelogs",[this.model],"peepr")},openAsk:function(){n.trigger("ask:form:open",{recipient:this.model.get("name"),allow_anonymous:this.model.get("anonymous_asks")})},_onIconClick:function(){this.model.get("asks")?this.showPopover():this.openMessaging()},_onMessagingSelected:function(){this.openMessaging()},_onAskSelected:function(){this.openAsk()},_onPopoverClose:function(){this.stopListening(this.popover),this.stopListening(this.popover.getView()),this.popover=null}});e.exports=l},{"../templates/messaging-popover-icon.tpl":188,"./messaging-popover":193,lodash:"MicNly","prima/events":512,"prima/views/base":581}],192:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/views/base"),o=t("../templates/messaging-popover-list.tpl"),a=n.extend({tagName:"ul",template:o,events:{"click [data-js-ask]":"_onClickAsk","click [data-js-message]":"_onClickMessage"},getTemplateData:function(){return{hasMessaging:this.model.get("can_receive_messages")===!0,hasAsks:this.model.get("asks")===!0,url:this.model.get("url")}},_onClickMessage:function(t){t.preventDefault(),this.trigger("messagingSelected"),this.trigger("popoverClose")},_onClickAsk:function(t){t.preventDefault(),this.trigger("askSelected"),s.delay(s.bind(function(){this.trigger("popoverClose")},this),1)}});e.exports=a},{"../templates/messaging-popover-list.tpl":189,lodash:"MicNly","prima/views/base":581}],193:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/view"),o=t("./messaging-popover-list"),a=t("prima/mixins/popoverbase"),r=t("../templates/messaging-popover.tpl"),l=n.extend({className:"popover--messaging-peepr popover info_popover popover_gradient",template:r,mixins:[a],initialize:function(t){this.options=s.extend({},this.defaults,t),this.view=new o({model:this.model})},render:function(){return this.$el.html(this.template),this.$(".popover_inner").append(this.view.render().$el),this.listenTo(this.view,"popoverClose",this.teardown),this},teardown:function(){this.view.remove(),this.remove()},getView:function(){return this.view}});e.exports=l},{"../templates/messaging-popover.tpl":190,"./messaging-popover-list":192,lodash:"MicNly","prima/mixins/popoverbase":550,"prima/view":580}],194:[function(t,e,i){"use strict";var s=t("jquery"),n=t("lodash"),o=t("prima/events"),a=t("prima/component"),r=t("app/components/drawer"),l=t("./views/body"),h=t("prima/lib/data"),c=a.extend({name:"peepr",params:"",initialize:function(){this.listenTo(o,"peepr-open-request",this.onPeeprRequest);var t=h.get("Components/Peepr")||{};this.params=t,t.blog_name&&(this.listenToOnce(o,"peepr:close",this.onPeeprClose),s(document).ready(n.bind(this.onPeeprRequestWithParams,this)))},onPeeprClose:function(){window.Backbone.history.navigate("/dashboard")},onPeeprRequestWithParams:function(){o.trigger("peepr-open-request",{tumblelog_name:this.params.blog_name,post_id:this.params.post_id})},onPeeprRequest:function(t){t.tumblelog_name&&this.open(t)},open:function(t){t.className="peepr-drawer",r().canOpen()&&(s("body").addClass("flag--peepr-redux"),r().open(l,t,"peepr-drawer-container"))}});e.exports=c},{"./views/body":198,"app/components/drawer":49,jquery:"HlZQrA",lodash:"MicNly","prima/component":511,"prima/events":512,"prima/lib/data":514}],195:[function(t,e,i){"use strict";var s=t("lodash"),n=t("app/models/tumblelog"),o=t("prima/events"),a=t("prima/model"),r=t("app/components/blog-card/utils/webfonts"),l=a.extend({url:"/svc/indash_blog/header",initialize:function(t,e){e=e||{},this.listenTo(this,"change",this.onModelChange)},onModelChange:function(){this.tumblelog=this.tumblelog||new n({name:this.get("name")}),this.tumblelog_name_or_id=this.get("name");var t=this.tumblelog.get("following");if(!s.isUndefined(t)&&this.get("following")!==t){var e={source:this.get("following")?"FOLLOW_SOURCE_PEEPR_HEADER":"UNFOLLOW_SOURCE_PEEPR_HEADER"};this.tumblelog.save_following({following:this.get("following")},e),o.trigger("peepr:follow_update",this.get("following"))}this.tumblelog.set(this.toJSON())},get_theme_param:function(t){var e=this.get("global_theme_params")||{};return e[t]},set_theme_params:function(t){var e=s.clone(this.get("global_theme_params"));this.set("global_theme_params",s.extend({},e,t))},fetch:function(t){t=t||{},t.data={tumblelog_name_or_id:t.tumblelog_name_or_id||this.get("name")},a.prototype.fetch.call(this,t)},save:function(t,e){var i=s.extend({},this.defaults,t);return i.global_theme_params=s.omit(i.global_theme_params,["header_image_dimens","header_image_focused"]),e=e||{},e.contentType="application/json",e.data=JSON.stringify({tumblelog_name_or_id:this.get("name"),tumblelog:i}),e.with_form_key=!0,a.prototype.save.call(this,t,e)},getAvailableFonts:function(){return r}});e.exports=l},{"app/components/blog-card/utils/webfonts":33,"app/models/tumblelog":436,lodash:"MicNly","prima/events":512,"prima/model":557}],196:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __p="";Array.prototype.join;with(obj||{})__p+='<div class="peepr-body"><div class="indash_blog"><header data-subview="header" class="header"></header><main data-subview="posts" class="posts"></main></div></div><div data-subview="bigLoader"></div>';return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],197:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/views/base"),o=t("components/knight-rider-loader"),a=n.extend({renderWithTemplate:s.noop,className:"peepr-big-loader",initialize:function(t){this.options=s.defaults({},t),this.loader=new o,this.loader.set("loading",this.options.loading)},render:function(){this.$el.append(this.loader.render().$el)},toggle:function(t){this.options.loading=t,this.loader.set("loading",t),this.$el.toggleClass("hidden",!t)},show:function(){this.toggle(!0)},hide:function(){this.toggle(!1)}});e.exports=a},{"components/knight-rider-loader":461,lodash:"MicNly","prima/views/base":581}],198:[function(t,e,i){"use strict";var s=t("lodash"),n=t("jquery"),o=t("prima/events"),a=t("prima/views/base"),r=t("app/components/tracking-pixels"),l=t("app/components/auto-pager"),h=t("../templates/body.tpl"),c=t("./posts"),u=t("./header"),d=t("../collections/posts"),p=t("./big-loader"),m=t("./post-keycommands-view"),g=a.extend({template:h,subviews:{posts:{constructor:c},header:{constructor:u},bigLoader:{constructor:p}},initialize:function(t){this.$body=n("body"),this.options=t,this.loadCount=0,this.setCollection(),this.postKeycommandsView=new m({el:this.$el}),this.collection.fetch().then(s.bind(this.onFirstSync,this)),this.bindEvents(),o.trigger("peepr:open",{tumblelog_name:this.options.tumblelog_name,post_id:this.options.post_id,loggingData:{tumblelog_name:this.options.tumblelog_name,post_id:this.options.post_id}}),r.setup()},setCollection:function(){this.collection&&this.collection.stopListening(),this.collection=new d([],{blogNameOrId:this.options.tumblelog_name,postId:this.options.post_id}),this.listenTo(this.collection.tumblelog,"change:global_theme_params",this.setBkgColor),this.listenTo(this.collection,"error",this.onSyncError),s.each(this.subviews,function(t){t.options=s.defaults({collection:this.collection,editing_appearance:this.options.editing_appearance,searchTagTerm:this.options.searchTagTerm||""},t.options||{})},this)},bindEvents:function(){this.$el.scroll(this.onBodyScroll),this.listenTo(o,"peepr-open-request",this.onPeeprOpenRequest),this.listenTo(o,"peepr:like_update",this.onPostLike),this.listenTo(o,"peepr:follow_update",this.onHeaderFollow),this.listenTo(o,"indashblog:post:reblog",this.onLegacyReblog),this.listenTo(o,"indashblog:search:start indashblog:search:clear",this.scrollToPosts)},afterRender:function(){this.autoPager&&(this.autoPager.close(),this.autoPager=null),this.autoPager=new l({$target:this.$(".peepr-body")}),this.listenTo(this.autoPager,"trigger",s.throttle(this.onAutopagerTrigger,500,{trailing:!1})),document.activeElement.blur()},onAutopagerTrigger:function(){this.collection.fetchMore(),this.log("paginate",{postCount:this.collection.length})},onBodyScroll:function(t){var e={windowScrollTop:n(t.currentTarget).scrollTop()};window.requestAnimationFrame?requestAnimationFrame(function(){o.trigger("peepr-body-scroll",e)}):o.trigger("peepr-body-scroll",e)},onLegacyReblog:function(t){var e="POST_CONTEXT_PEEPR";t.reblog_key||(t.reblog_key=this.collection.get(t.id).get("reblog_key")),o.trigger("postForms:reblog",{reblogSource:e,reblogId:t.id,reblogKey:t.reblog_key,pt:t.pt}),this.listenToOnce(o,"postForms:saved",this.onPostFormReblogSuccess),this.log("peepr_reblog",{postId:t.id})},onPostFormReblogSuccess:function(t,e){this.log("peepr_reblog_success",{postId:e.responseJSON.post.id})},onPostLike:function(t,e){this.log("peepr_like_update",{postId:e.id,liked:e.liked})},onHeaderFollow:function(t){this.log("peepr_follow",{following:t})},onFirstSync:function(){this.rendered&&(this.bigLoader.hide(),this.$(".indash_blog").addClass("intro"),s.delay(s.bind(function(){this.rendered&&this.$(".indash_blog").removeClass("intro")},this),1e3),this.log(this.loadCount?"reload":"load"),this.loadCount++)},onPeeprOpenRequest:function(t){t.tumblelog_name&&(this.options=t,this.setCollection(),this.reload())},reload:function(){this.stopListening(this.autoPager),this.removeSubviews(),this.render(),this.collection.fetch().then(s.bind(this.onFirstSync,this))},setBkgColor:function(){var t=this.collection.tumblelog.get("global_theme_params")||{};s.has(t,"background_color")&&this.$(".peepr-body").css("background-color",t.background_color)},scrollToPosts:function(){this.headerScrollHeight=this.headerScrollHeight||this.$(".header_image_wrapper").height()-this.$(".navigation").height(),this.$el.scrollTop(this.headerScrollHeight)},onSyncError:function(){this.log("ajax-error",{offset:this.collection.length,path:window.location.href})},log:function(t,e){var i=s.defaults({blogname:this.options.tumblelog_name,postId:this.options.postId,loadCount:this.loadCount},e||{});o.trigger("peepr:log:"+t,{loggingData:{payload:i}})},remove:function(){this.log("close"),this.collection.stopListening(),this.postKeycommandsView&&this.postKeycommandsView.remove(),o.trigger("peepr:close",this.options.tumblelog_name,this.options.post_id),a.prototype.remove.call(this)}});e.exports=g},{"../collections/posts":186,"../templates/body.tpl":196,"./big-loader":197,"./header":199,"./post-keycommands-view":200,"./posts":201,"app/components/auto-pager":29,"app/components/tracking-pixels":387,jquery:"HlZQrA",lodash:"MicNly","prima/events":512,"prima/views/base":581}],199:[function(t,e,i){"use strict";var s=t("lodash"),n=t("jquery"),o=t("prima/events"),a=t("prima/views/base"),r=t("prima/lib/data"),l=t("app/components/blog-card/utils/webfonts"),h=a.extend({renderWithTemplate:s.noop,className:"header",initialize:function(t){this.options=t,this.listenToOnce(this.collection,"sync",this.insertHeader)},insertHeader:function(){this.header=new window.Tumblr.IndashBlog.HeaderView({model:this.collection.tumblelog,el:this.$el,is_peepr:!0,show_share_controls:!0,show_follow_button:!0,show_user_controls:!0,show_dismiss_controls:!1,on_customize_open:s.bind(this.renderAllFontStyles,this)}).render(),this.setupHeader()},setupHeader:function(){var t=this.collection.tumblelog.get("global_theme_params").title_font;this.renderSingleFontStyle(t),this.$(".navigation").width(this.$el.width()||585),o.trigger("indashblog:ready-animation-start"),this.options.editing_appearance&&this.header.start_customizing(),this.options.searchTagTerm&&o.trigger("peeprsearch:change:term",{term:this.options.searchTagTerm})},renderAllFontStyles:function(){s.each(l,function(t){this.appendFontToHead(t)},this)},renderSingleFontStyle:function(t){var e=s.result(l,t);e&&this.appendFontToHead(e)},appendFontToHead:function(t){var e=r.get("Context/hosts/assets_host")||"",i="webfont_"+t.path;if(t.path&&!n("head #"+i).length){var o=e+"/fonts/"+t.path+"/stylesheet.css";o+=s.has(t,"_v")?"?v="+t._v:"",n("<link>",{id:i,rel:"stylesheet",type:"text/css",href:o}).appendTo(n("head"))}},remove:function(){this.header&&this.header.remove(),a.prototype.remove.call(this)}});e.exports=h},{"app/components/blog-card/utils/webfonts":33,jquery:"HlZQrA",lodash:"MicNly","prima/events":512,"prima/lib/data":514,"prima/views/base":581}],200:[function(t,e,i){"use strict";var s=t("lodash"),n=t("jquery"),o=t("prima/events"),a=t("prima/mixins/keycommands"),r=t("prima/view"),l=r.extend({mixins:[a],keycommands:{"keydown:j":"scrollToNextItem","keydown:k":"scrollToPrevItem","keydown:l":"like","keydown:r":"reblog","keydown:period":"ttt","keydown:enter":"openBlog"},defaults:{selector:".post",scrollOffset:60,speed:200},initialize:function(t){this.options=s.defaults(t||{},this.defaults),this.listenTo(o,"post:form:show indashblog:keycommands:suspend",this.disableKeys),this.listenTo(o,"post:form:hide indashblog:keycommands:resume",this.enableKeys),this.listenTo(o,"keycommands:resume",this.onDashboardKeycommandsResume),this.listenTo(o,"drawer:close",this.resumeDashboardKeycommands)},onDashboardKeycommandsResume:function(){o.trigger("keycommands:suspend")},resumeDashboardKeycommands:function(){this.stopListening(o,"keycommands:resume"),o.trigger("keycommands:resume")},indexPageableItems:function(){var t={};this.currentPosition=this.getScrollOffset(),this.goToPosition=0,this.$(this.options.selector).each(function(e){var i=n(this);t[e]=Math.round(i.position().top)}),this.positions=t},getScrollOffset:function(){return this.$el.scrollTop()},like:function(){var t=this.findPostId();t&&o.trigger("indashblog:post:like",t,"keyboard")},reblog:function(){var t=this.findPostId();t&&o.trigger("indashblog:post:reblog",{id:t},"keyboard")},ttt:function(){this.goToPosition=1,this.$el.stop().animate({scrollTop:0},this.options.speed,s.bind(function(){this.animating=!1},this))},openBlog:function(){var t=this.$("[data-post-id="+this.findPostId()+"] .reblog_info.post_info_link");t.length&&o.trigger("peepr-open-request",{url:t.attr("href"),tumblelog_name:t.data("tumblelog-name")})},scrollToNextItem:function(){this.indexPageableItems(),this.nextPosition(),o.trigger("keycommands:jk",{loggingData:{source:"peepr"}})},scrollToPrevItem:function(){this.indexPageableItems(),this.previousPosition(),o.trigger("keycommands:jk",{loggingData:{source:"peepr"}})},nextPosition:function(){for(var t in this.positions){var e=this.positions[t];e>this.currentPosition+this.options.scrollOffset&&(e<this.goToPosition||!this.goToPosition)&&(this.goToPosition=e)}this.animate()},previousPosition:function(){for(var t in this.positions){var e=this.positions[t];e<this.currentPosition-this.options.scrollOffset&&e>this.goToPosition&&(this.goToPosition=e)}this.animate()},animate:function(){this.goToPosition&&!this.animating&&(this.animating=!0,this.$el.stop().animate({scrollTop:this.goToPosition-this.options.scrollOffset},this.options.speed,s.bind(function(){this.animating=!1},this)))},findPostId:function(){if(this.goToPosition-this.options.scrollOffset===this.getScrollOffset()){var t=s.invert(this.positions)[this.goToPosition];if(t){var e=this.$(this.options.selector).get(t);if(e)return n(e).data("post-id")}}return!1}});e.exports=l},{jquery:"HlZQrA",lodash:"MicNly","prima/events":512,"prima/mixins/keycommands":547,"prima/view":580}],201:[function(t,e,i){"use strict";var s=t("lodash"),n=t("jquery"),o=t("prima/events"),a=t("prima/views/base"),r=t("prima/lib/flags"),l=t("components/knight-rider-loader"),h=a.extend({className:"posts",initialize:function(){this.postViews=[],this.listenTo(o,"indashblog:post:photo_lightbox",this.onLightboxRequest),this.listenTo(this.collection,"sync",this.onCollectionSync),this.listenTo(this.collection,"reset",this.onCollectionReset),this.listenTo(this.collection,"request",this.onCollectionRequest),this.listenTo(this.collection,"add",this.renderPost),this.listenTo(o,"DOMEventor:flatresize",this.setMinHeight),this.listenTo(o,"indashblog:search:results-end",this.onSearchResultsEnd)},render:function(){return this.loader=new l,this.$el.append(this.loader.render().$el),this.setMinHeight(),this},renderWithTemplate:s.noop,setMinHeight:function(){var t=n(window).height();this.navHeight=this.navHeight||n(".peepr-body .navigation").height()+n(".peepr-body .info_wrapper").height(),this.$el.css("min-height",t-this.navHeight+"px")},renderPost:function(t){if(!r.bool("hide_legacy_posts")){var e=new window.Tumblr.IndashBlog.PostView({model:t});this.postViews.push(e),this.$(".knight-rider-container").before(e.render().el),s.defer(s.bind(function(){this.make_tags_draggable()},e))}},onSearchResultsEnd:function(t){t&&(this.searchResultsEndView=t,this.$(".knight-rider-container").before(this.searchResultsEndView.render().$el))},onCollectionReset:function(){this.searchResultsEndView&&this.searchResultsEndView.remove(),this.collection.length?this.collection.each(this.renderPost,this):(s.each(this.postViews,function(t){t.remove()}),this.postViews=[])},onCollectionRequest:function(){this.loader.set("loading",!0)},onCollectionSync:function(){this.loader.set("loading",!1)},onLightboxRequest:function(t){var e=t.post,i=e.get("photos"),n=t.photosetIndex||0,a=[];s.each(i,function(t){a.push({width:t.original_size.width,height:t.original_size.height,low_res:t.alt_sizes[0].url,high_res:t.original_size.url})}),o.trigger("lightbox-open-request",a,n)}});e.exports=h},{"components/knight-rider-loader":461,jquery:"HlZQrA",lodash:"MicNly","prima/events":512,"prima/lib/flags":"f/LVtH","prima/views/base":581}],202:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/collection"),o=t("../models/photo"),a=n.extend({model:o,getSubset:function(t){return s.isUndefined(t)?[]:s.map(s.isArray(t)?t:s.toArray(arguments),this.get,this)},getSubCollection:function(t){return new a(this.getSubset.apply(this,arguments))},setIdOrder:function(t,e){e||(e={}),this.models=s.map(t,function(t){return this.get(t)},this),e.silent||this.trigger("sort",this,e)}});e.exports=a},{"../models/photo":204,lodash:"MicNly","prima/collection":510}],203:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/component"),o=t("./models/photoset"),a=(t("./models/photo"),t("./collections/photos"),t("./utils"),t("./views/photoset")),r=t("./views/photo"),l=n.extend({name:"Photoset",initialize:function(t){(s.isArray(t)||t instanceof o)&&(t={photoset:t}),this.options=t=s.extend({},t),t.photoset instanceof o?this.model=t.photoset:this.model=new o(t.photoset);var e=s.keys(a.prototype.defaults);e.push("PhotoView"),e.push("post");var i=s.pick(t,e);i.photoset=this.model,this._PhotosetView=t.PhotosetView||a,this._PhotoView=t.PhotoView||r,this.indexView=new this._PhotosetView(i),this.listenTo(this.model,"all",this._relayModelEvent),this.listenTo(this.model.photos,"all",this._relayModelEvent)},_relayModelEvent:function(){this.trigger.apply(this,arguments)},teardown:function(){return this.indexView.teardown(),this.stopListening(),this},remove:function(){return this.teardown(),this.indexView.remove(),this},render:function(){return this.indexView.render(),this},getElement:function(){return this.indexView.$el}});e.exports=l},{"./collections/photos":202,"./models/photo":204,"./models/photoset":205,"./utils":210,"./views/photo":213,"./views/photoset":214,lodash:"MicNly","prima/component":511}],204:[function(t,e,i){"use strict";var s=t("prima/model"),n=t("../utils/imagelayout"),o=s.extend({defaults:{width:null,height:null,x:"50%",y:"50%",url:"",caption:"",clickthroughUrl:""},getAspectRatio:function(){return n.aspectRatio(this.get("width"),this.get("height"))},getWidthForHeight:function(t){return n.widthForHeight(this.get("width"),this.get("height"),t)},getHeightForWidth:function(t){return n.heightForWidth(this.get("width"),this.get("height"),t)}});e.exports=o},{"../utils/imagelayout":209,"prima/model":557}],205:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/model"),o=t("../collections/photos"),a=t("../utils/imagelayout"),r=["","1","11","12","13","123","133","1232","1323","12223"],l=3,h=n.extend({defaults:{layout:null},initialize:function(t,e){e=s.extend({},e),this.layouts=e.layouts||r,this.maxPerRow=e.maxPerRow||l,(s.isArray(t)||t instanceof o)&&(this.attributes=s.extend({photos:t},this.defaults)),this.get("photos")instanceof o?this.photos=this.get("photos"):this.photos=new o(this.get("photos")),this.unset("photos"),this.fixLayout()},fixLayout:function(){var t=this.get("layout");return t=t?a.fix(t,this.photos.length,this.layouts,this.maxPerRow):a.calculateDefault(this.photos.length,this.layouts,this.maxPerRow),this.set("layout",t),t},getRows:function(t){return a.toArray(t||this.get("layout"),this.photos,this.layouts,this.maxPerRow)},getPhotoRow:function(t){var e={id:t};return s.findIndex(this.getRows(),function(t){return s.some(t,e)})},removePhoto:function(t){var e=this.getPhotoRow(t),i=this.photos.remove(t),n=s.reduce(this.get("layout").split(""),function(t,i,n){return i=s.parseInt(i),n===e&&i--,t+(i>0?i:"")},"");this.set("layout",n),i&&this.trigger("photo:remove",i,t,n)},toJSON:function(){var t=n.prototype.toJSON.apply(this,arguments);return t.photos=this.photos.toJSON(),t.rows=this.getRows(),t}}),c=["add","remove","reset","push","pop","unshift","shift","slice","where","findWhere","forEach","each","map","collect","reduce","foldl","inject","reduceRight","foldr","find","detect","filter","select","reject","every","all","some","any","include","contains","invoke","max","min","toArray","size","first","head","take","initial","rest","tail","drop","last","without","difference","indexOf","shuffle","lastIndexOf","isEmpty","chain","sample"];s.forEach(c,function(t){var e=o.prototype[t];h.prototype[t]=function(){return e.apply(this.photos,s.toArray(arguments))}}),e.exports=h},{"../collections/photos":202,"../utils/imagelayout":209,lodash:"MicNly","prima/model":557}],206:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __t,__p="";Array.prototype.join;with(obj||{})__p+='<div data-js-imagecrop style="width:'+(null==(__t=displayWidth)?"":_.escape(__t))+"px;height:"+(null==(__t=displayHeight)?"":_.escape(__t))+'px" class="photoset--image-crop"><div data-js-imagewrap style="background-image:url('+(null==(__t=url)?"":_.escape(__t))+");background-position:"+(null==(__t=x)?"":_.escape(__t))+" "+(null==(__t=y)?"":_.escape(__t))+'" class="photoset--image-wrap"><img data-js-image src="'+(null==(__t=url)?"":_.escape(__t))+'" alt="'+(null==(__t=caption)?"":_.escape(__t))+'" data-width="'+(null==(__t=width)?"":_.escape(__t))+'" data-height="'+(null==(__t=height)?"":_.escape(__t))+'" class="photoset--image"></div></div>';return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],207:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __t,__p="";Array.prototype.join;with(obj||{}){__p+="";var rows=photoset.rows,cellId=0;__p+='<div data-js-layout class="photoset--layout">',_.forEach(rows,function(t,e){__p+="";var i=e>0?padding:0,s=e<rows.length-1?padding:0,n=_rowSize(t,width,padding),o=n.height;__p+='<div data-photoset-row="'+(null==(__t=e)?"":_.escape(__t))+'" style="height:'+(null==(__t=o+i+s)?"":_.escape(__t))+'px" class="photoset--row">',_.forEach(t,function(e,a){__p+="";var r=n.photos[a],l=r.width,h=r.height,c=o,u=a<t.length-1?padding:0,d=a>0?padding:0,p=l+d+u,m=_.map([i,u,s,d],function(t){return t?t+"px":0}).join(" ");__p+='<div data-photoset-position="'+(null==(__t=cellId)?"":_.escape(__t))+'" data-photo-id="'+(null==(__t=e.id)?"":_.escape(__t))+'" style="width:'+(null==(__t=p)?"":_.escape(__t))+"px;height:"+(null==(__t=o)?"":_.escape(__t))+"px;padding:"+(null==(__t=m)?"":_.escape(__t))+'" class="photoset--cell">'+(null==(__t=photoTemplate(_.defaults({scaledWidth:l,scaledHeight:h,displayWidth:r.width,displayHeight:c},e)))?"":__t)+"</div>",cellId++,__p+=""}),__p+="</div>"}),__p+="</div>"}return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],208:[function(t,e,i){"use strict";var s=t("lodash"),n=t("jquery"),o={},a=function(t,e,i){var o=t instanceof n?t:n(t),a=e;s.isObject(e)||(a={},a[e]=i),o.attr(a);var r=s.transform(a,function(t,e,i){i.match(/^data\-/i)&&(t[s.camelCase(i.replace(/^data\-/,""))]=e)},{});return o.data(r),o},r=function(t,e){var i=t instanceof n?t:n(t);return s.isString(e)&&(e=s.rest(arguments)),s.forEach(e,function(t){i.removeAttr(t),t.match(/^data\-/i)&&i.removeData(s.camelCase(t.replace(/^data\-/,"")))}),i};o.set=a,o.remove=r,e.exports=o},{jquery:"HlZQrA",lodash:"MicNly"}],209:[function(t,e,i){"use strict";var s=t("lodash"),n=t("../models/photo"),o={},a=function(t,e,i){return t<e.length?e[t]:s.trim(s.pad(t%i||" ",Math.floor(t/i)+1,i+"","right"))},r=function(t,e,i,n){var o=s.isNumber(e)?e:e.length;t?s.isString(t)||(t=t.toString()):t="";var r=o-s.reduce(t.split(""),function(t,e){return t+s.parseInt(e)},0);return r>0?t+=a(r,i,n):0>r&&(t=s(t.split("")).reverse().transform(function(t,e){r?(r+=s.parseInt(e),r>0&&(t.push(r),r=0)):t.push(e)},[]).reverse().value().join("")),t},l=function(t,e,i,n){var o=r(t,e,i,n).split(""),a=0;return s.map(o,function(t){t=s.parseInt(t);var i=s.map(e.slice(a,a+t),function(t){return s.isFunction(t.toJSON)?t.toJSON():t});return a+=t,i})},h=function(t,e){return t&&e?t/e:0},c=function(t,e,i){var s=e?i/e:0;return t*s},u=function(t,e,i){var s=t?i/t:0;return e*s},d=function(t,e){if(!t.length)return 0;var i=s.map(t,function(t){var i,s;return t instanceof n?(i=t.get("width"),s=t.get("height")):(i=t.width,s=t.height),u(i,s,e)});return s.min(i)},p=function(t,e,i){return i||(i=0),(i+e+i)/t-i-i};o.calculateDefault=a,o.fix=r,o.toArray=l,o.aspectRatio=h,o.widthForHeight=c,o.heightForWidth=u,o.rowHeightForWidth=d,o.rowImageWidth=p,e.exports=o},{"../models/photo":204,lodash:"MicNly"}],210:[function(t,e,i){"use strict";var s={ImageLoader:t("prima/utils/image/loader"),ImageLayout:t("./imagelayout")};e.exports=s},{"./imagelayout":209,"prima/utils/image/loader":573}],211:[function(t,e,i){"use strict";var s=t("lodash"),n=function(t,e){e||(e=t.originalEvent),s.extend(t,s.pick(e,"pageX","pageY"));var i,n,o;return null==t.pageX&&null!=e.clientX&&(i=t.target.ownerDocument||document,n=i.documentElement,o=i.body,t.pageX=e.clientX+(n&&n.scrollLeft||o&&o.scrollLeft||0)-(n&&n.clientLeft||o&&o.clientLeft||0),t.pageY=e.clientY+(n&&n.scrollTop||o&&o.scrollTop||0)-(n&&n.clientTop||o&&o.clientTop||0)),{x:t.pageX,y:t.pageY}};e.exports=n},{lodash:"MicNly"}],212:[function(t,e,i){"use strict";var s=t("lodash"),n=t("jquery"),o=t("when"),a=t("velocity-animate").animate,r=t("prima/events"),l=t("./photoset"),h=150,c=n(window),u=t("../utils/attrdata"),d=t("../utils/page_coords"),p=0,m=1,g=2,f=l.extend({className:"editable-photoset photoset",defaults:s.extend({x:null,y:null,dragId:null,sourceCell:null,targetCell:null,dragOverCell:null,isLocked:!1,isDragging:!1,dragScrollVelocityY:0,dragScrollUpdateMs:50,dragScrollHeight:100,dragSlide:20,ghostWidth:100,ghostMaxHeight:120},l.prototype.defaults),events:s.defaults({'mousedown [data-js-sortable][draggable="true"]':"_onMouseDownSortable","dragstart .photoset--photo-dragger":"_onDragStart"},l.prototype.events),initialize:function(){l.prototype.initialize.apply(this,arguments),this.__updateCursorPosition=s.throttle(s.bind(function(t){this.set(d(t))},this)),s.forEach(["_onDragStart","_onDragEnter","_onDragOver","_onDragLeave","_onDragEnd","_onDrop"],function(t){var e=this[t]||s.noop;this["_"+t]=s.bind(e,this)},this)},_onMouseDownSortable:function(t){if(this.get("isLocked"))return t.preventDefault(),void t.stopPropagation();if(1===t.which&&!t.ctrlKey){if(this.get("isDragging"))return this._onDragEnd(t);if(this.trigger("photoset:predrag",this),!window.DataTransfer||!s.isFunction(window.DataTransfer.prototype.setDragImage)){var e=n(t.target),i=e.closest(".photoset--photo"),o=this.photoset.photos.get(i.data("photoId")),a=o?o.get("url")||"":"";a&&(e.css({backgroundColor:"#ffffff",backgroundImage:"url("+a+")"}),e.one("mouseout mouseup",s.bind(function(){e.css({backgroundColor:"",backgroundImage:""})},this)))}}},_onDragStart:function(t){if(this.get("isLocked"))return t.preventDefault(),void t.stopPropagation();r.trigger("photoset:dragstart");var e=n(t.target),i=e.closest(".photoset--photo"),o=i.data("photoId"),a=t.originalEvent.dataTransfer;if(a){a.effectAllowed="move",a.dropEffect="move";var l=this.$('[data-ghost-id="'+o+'"]');!s.isEmpty(l)&&s.isFunction(a.setDragImage)&&a.setDragImage(l.get(0),.5*l.outerWidth(),.5*l.outerHeight());try{var h=this.photoset.photos.get(o),u=h?h.get("url")||"":"";a.setData("text/uri-list",u),a.setData("text/plain",u)}catch(t){}}var d=i.closest(this.$$cacheKeys.cell),p=d.closest(this.$$cacheKeys.row);this.set({sourceCell:null,targetCell:null,dragOverCell:null,dragId:o}),this.listenTo(this,"change:targetCell",this._onChangeTargetCell),this.$el.on("dragover .photoset--cell",this.__onDragOver),this.$el.on("dragend",this.__onDragEnd),this.$el.on("drop .photoset--cell",this.__onDrop),c.on("dragover",this.__updateCursorPosition),this.startDragScroll(),s.defer(s.bind(function(){var t=this.$$cacheKeys.cell;this.set("isDragging",!0),d.addClass("photoset--placeholder-cell photoset--source-cell"),p.addClass("photoset--source-row"),s.isEmpty(d.siblings(t))&&d.closest(this.$$cacheKeys.row).addClass("photoset--placeholder-row"),e.css({backgroundColor:"",backgroundImage:""}),this.createPlaceholders(),this.set({sourceCell:d.data("placeholderCell"),targetCell:d.data("placeholderCell"),dragOverCell:d.data("dragOverCell")}),this.listenTo(this,"change:dragOverCell change:x change:y",this._onChangeDragTarget)},this))},_onDragOver:function(t){t.preventDefault(),t.stopPropagation(),this.__updateCursorPosition(t);
var e=n(t.target),i=e.closest(this.$$cacheKeys.cell);this.set("dragOverCell",i.data("dragOverCell"))},_onDragEnd:function(t){t.preventDefault(),t.stopPropagation(),this.stopListening(this,"change:targetCell",this._onChangeTargetCell),this.stopListening(this,"change:dragOverCell change:x change:y",this._onChangeDragTarget);var e=this.get("dragId");if(null!=e){var i=this.placePhotoInCell(e,this.get("targetCell"));this.set({sourceCell:null,targetCell:null,dragId:null}),i.removeClass("photoset--placeholder-cell"),i.closest(this.$$cacheKeys.row).removeClass("photoset--placeholder-row")}this.removePlaceholders(),this.set("isDragging",!1);var n=this.determineLayout();this.photoset.photos.setIdOrder(n.order),this.photoset.set("layout",n.layout),this.set("isLocked",!0),this.resize().then(s.bind(function(){this.removeTemporary(),this.set("isLocked",!1)},this)),this._ensurePhotoInViewport(e),this.$el.off("dragover .photoset--cell",this.__onDragOver),this.$el.off("dragend",this.__onDragEnd),this.$el.off("drop .photoset--cell",this.__onDrop),c.off("dragover",this.__updateCursorPosition),this.stopDragScroll(),r.trigger("photoset:dragend")},_onDrop:function(t){t.preventDefault(),t.stopPropagation()},_onChangeIsDragging:function(t,e){this.$el.toggleClass("photoset--drag-to-sort",e)},_onChangeIsLocked:function(t,e){this.$el.toggleClass("photoset--locked",e),e||this.$(".photoset--cropped-cell").removeClass("photoset--cropped-cell")},_onUpdate:function(t,e){this.teardown().render(),this.photoset.photos.length>1&&this._ensurePhotoInViewport(this.photoset.photos.last().get("id"))},startDragScroll:function(){this.set({dragScrollTop:this.get("dragScrollHeight"),dragScrollBottom:c.height()-this.get("dragScrollHeight")}),this.listenTo(this,"change:y",this._onChangeDragY)},stopDragScroll:function(){clearInterval(this.dragScrollInterval),delete this.dragScrollInterval,this.stopListening(this,"change:y",this._onChangeDragY)},_onChangeDragY:function(t,e){var i=0,n=e-c.scrollTop();i=n<this.get("dragScrollTop")?Math.ceil(100*(n-this.get("dragScrollTop"))/this.get("dragScrollHeight")):n>this.get("dragScrollBottom")?Math.ceil(100*(n-this.get("dragScrollBottom"))/this.get("dragScrollHeight")):0,this.set("dragScrollVelocityY",i),i?this.dragScrollInterval||(this.dragScrollInterval=setInterval(s.bind(function(){var t=this.get("dragScrollVelocityY");t&&r.trigger("Photoset:dragScroll",t)},this),this.get("dragScrollUpdateMs"))):this.dragScrollInterval&&(clearInterval(this.dragScrollInterval),delete this.dragScrollInterval)},_ensurePhotoInViewport:function(t,e){s.isNumber(e)||(e=h);var i=this._layoutCache||this._updateLayoutCache(),n=this.$el.offset().top||0,o=s.find(i.rows,function(e){return s.find(e.cells,{photo:t})?!0:void(n+=e.height)});o&&r.trigger("Photoset:scrollToRow",n,o.height,e)},createPhotoSubView:function(t){var e=l.prototype.createPhotoSubView.apply(this,arguments);return this.options.post&&(e.post=this.options.post),this.listenTo(e,"photoset:hover",function(){var t=s.toArray(arguments);t.unshift("photoset:unhover"),s(this.subViews).omit(e.photo.get("id")).invoke(function(){this.trigger.apply(this,t)}).value()}),e},createPlaceholders:function(){var t=this.photoset.maxPerRow,e=".photoset--placeholder-row",i=".photoset--placeholder-cell",o=".photoset--source-row",a=".photoset--source-cell",r=this.$$cacheKeys.cell,l='<div class="photoset--row photoset--placeholder-row"></div>',h='<div class="photoset--cell photoset--placeholder-cell"></div>';this._createPlaceholders(this.js$("layout"),this.$$rows(),l,e),s.forEach(this.$$rows(!0),function(e,s){var a=n(e),r=a.children(this.$$cacheKeys.cell);(r.length<t||a.is(o))&&this._createPlaceholders(a,r,h,i)},this),s.forEach(this.$$cells(!0).filter(i),function(t,e){u.set(t,"data-placeholder-cell",e)},this);var c=this.determineLayout(),d=this.get("padding"),p=0;s.forEach(this.$$rows(!0),function(t,l){var h=n(t),m=h.index(),g=this.get("width"),f=m<=c.topRow||m>c.bottomRow?0:d,_=m>=c.bottomRow||m<c.topRow?0:d,v=h.height()||0;h.height(v);var b=h.children(r),y=h.prev(e).not(o).find(r),w=h.next(e).not(o).find(r),x=y.data("placeholderCell"),C=w.data("placeholderCell");s.forEach(b,function(t,s){var o=n(t);o.is(i)&&!o.is(a)&&o.css({paddingTop:f,paddingBottom:_,width:h.is(e)?g:0,height:v});var r={top:x,left:o.prev(i).data("placeholderCell"),center:o.data("placeholderCell"),right:o.next(i).data("placeholderCell"),bottom:C};o.data("targetCells",r),u.set(o,"data-drag-over-cell",p++)},!0)},this)},_createPlaceholders:function(t,e,i,o){e.first().is(o)||t.prepend(i),s.forEach(e.not(o),function(t,e){var a=n(t);s.isEmpty(a.next(o))&&a.after(i)},this)},removePlaceholders:function(){this.$$rows(!0).removeClass("photoset--source-row"),this.$$cells(!0).removeClass("photoset--source-cell").removeData("targetCells"),this.$$rows().filter(".photoset--placeholder-row").remove(),this.$$cells().filter(".photoset--placeholder-cell").remove(),this.renumberRowsAndCells(),u.remove(this.$$cells(),"data-drag-over-cell","data-placeholder-cell")},removeTemporary:function(){this.$(".photoset--temporary").remove(),this.$$rows(!0),this.$$cells(!0),this.renumberRowsAndCells()},resize:function(t){s.isNumber(t)||(t=h);var e=s.map(this.$$rows(),function(e,i){return this.resizeRow(e,t,i)},this);return this._updateLayoutCache(),o.all(e)},_calculateCellSize:function(t){var e=n(t),i=e.find(".photoset--photo [data-js-imageCrop]"),o={width:0,height:0,$content:i,$el:e},a=this.photoset.photos.get(e.data("photoId"));return a&&s.extend(o,{isCurrentCell:!0,width:a.get("width"),height:a.get("height")}),o},resizeRow:function(t,e,i){s.isNumber(e)||(e=h);var r=t instanceof n?t:n(t),l=this.determineLayout();s.isNumber(i)||(i=r.index());var c=this.get("width"),u=this.get("padding"),d=i<=l.topRow||i>l.bottomRow?0:u,p=i>=l.bottomRow||i<l.topRow?0:u,m=this.$$cacheKeys.cell,g=s.map(r.children(m),this._calculateCellSize,this),f=[],_=0;s.forEach(g,function(t,e){t.index=e,t.isCurrentCell&&(t.position=_++,t.id=f.length,f.push(t))});var v=this.rowSize(f,c),b=v.height,y=b?b+d+p:0,w=s.map(g,function(t,i){var n={width:t.width,height:b,paddingTop:d,paddingRight:0,paddingBottom:p,paddingLeft:0};null!=t.id&&(n.width=v.photos[t.id].width),null!=t.position&&(n.paddingRight=t.position<_-1?u:0,n.paddingLeft=t.position>0?u:0),s.isEmpty(t.$content)||(a(t.$content,"stop"),a(t.$content,{opacity:1,width:n.width,height:n.height,translateX:0,translateY:0},{duration:e}));var o=this.subViews[t.$el.data("photoId")];return o&&o.set({displayWidth:n.width,displayHeight:n.height}),a(t.$el,"stop"),a(t.$el,s.defaults({width:n.width+n.paddingLeft+n.paddingRight,height:n.height+n.paddingTop+n.paddingBottom},n),{duration:e})},this);a(r,"stop"),w.push(a(r,{height:y},{duration:e})),this.get("isDragging")&&(this._rowHeightCache[r.data("photosetRow")]=y);var x=o.all(w);return x},determineLayout:function(t){if(t&&this._determineLayout)return this._determineLayout;var e="",i=[],o=-1,a=-1,r=this.$$cacheKeys.cell;return s.forEach(this.$$rows(),function(t,l){var h=0;s.forEach(n(t).children(r),function(t){var e=n(t).data("photoId");(e||0===e)&&(i.push(e),h++)},this),h&&(e+=h,0>o&&(o=l),a=l)},this),this._determineLayout={topRow:o,bottomRow:a,order:i,layout:e},this._determineLayout},_onChangeTargetCell:function(t,e){if(null!=e){var i=this.$$cells().filter('[data-placeholder-cell="'+e+'"]'),o=i.closest(this.$$cacheKeys.row),r=i.data("dragOverCell"),l=p;l=i.is(".photoset--source-cell")?p:o.is(".photoset--placeholder-row")?m:g,s.forEach(this.$$cells(),function(t,e){var i=n(t),c=i.find(".photoset--image-crop");if(!s.isEmpty(c)){var u={translateX:0,translateY:0};switch(l){case m:s.isEmpty(o.find(i))&&(i.data("dragOverCell")<r?u.translateY=-this.get("dragSlide"):i.data("dragOverCell")>r&&(u.translateY=this.get("dragSlide")));break;case g:s.isEmpty(o.find(i))||(i.data("dragOverCell")<r?u.translateX=-this.get("dragSlide"):i.data("dragOverCell")>r&&(u.translateX=this.get("dragSlide")))}a(c,"stop"),a(c,u,h)}},this)}else s.forEach(this.$$cells(),function(t){var e=n(t).find(".photoset--image-crop");s.isEmpty(e)||(a(e,"stop"),a(e,{translateX:0,translateY:0},h))},this)},_onChangeDragTarget:function(){var t=this.get("dragOverCell");if(null!=t){var e=this.$$cells().filter('[data-drag-over-cell="'+t+'"]'),i=e.offset(),s=e.width(),n=e.height(),o=this.get("x")-(i.left+.5*s),a=this.get("y")-(i.top+.5*n),r=e.data("targetCells");null!=r.top&&-n/3>a?this.set("targetCell",r.top):null!=r.bottom&&a>n/3?this.set("targetCell",r.bottom):null!=r.center?null!=r.left&&-s/3>o?this.set("targetCell",r.left):null!=r.right&&o>s/3?this.set("targetCell",r.right):this.set("targetCell",r.center):null!=r.left&&0>o?this.set("targetCell",r.left):null!=r.right&&o>0&&this.set("targetCell",r.right)}},placePhotoInCell:function(t,e){var i=this.subViews[t],s=i.$el.closest(this.$$cacheKeys.cell),n=s.closest(this.$$cacheKeys.row),o=this.$$cells().filter('[data-placeholder-cell="'+e+'"]');return u.set(o,"data-photo-id",t),o.is(s)||(s.removeClass("photoset--placeholder-cell").addClass("photoset--temporary"),u.remove(s,"data-photo-id"),n.is(".photoset--placeholder-row")&&n.removeClass("photoset--placeholder-row").addClass("photoset--temporary"),i.js$("imageCrop").css({opacity:0,width:o.width(),height:o.height()}),i.$el.detach(),o.append(i.$el),o.addClass("photoset--cropped-cell")),o},beforeRender:function(){this.listenTo(this,"update",this._onUpdate),this.listenTo(this,"change:isDragging",this._onChangeIsDragging),this.listenTo(this,"change:isLocked",this._onChangeIsLocked)},afterRender:function(){this.renderSubViews(),this.$el.prepend('<div data-js-ghosts class="photoset--ghosts"></div>'),s.forEach(this.subViews,function(t,e){var i=t.thumbnailDimensions(this.get("ghostWidth"),this.get("ghostMaxHeight"));i["background-image"]="url("+t.photo.get("url")+")";var s=n('<div data-js-ghost class="photoset--ghost"></div>').css(i);u.set(s,"data-ghost-id",e),this.js$("ghosts").append(s)},this),this.js$("ghosts").append('<div class="photoset--ghost-cover"></div>').css({width:this.get("ghostWidth"),height:this.get("ghostMaxHeight")})}});e.exports=f},{"../utils/attrdata":208,"../utils/page_coords":211,"./photoset":214,jquery:"HlZQrA",lodash:"MicNly","prima/events":512,"velocity-animate":"lWl/mc",when:"RG2dij"}],213:[function(t,e,i){"use strict";var s=t("lodash"),n=t("when"),o=t("velocity-animate").animate,a=t("prima/view"),r=150,l=t("prima/mixins/subviewable"),h=t("prima/mixins/selectorcache"),c=t("prima/mixins/accessor"),u=t("../models/photo"),d=t("../templates/photo.tpl"),p=a.extend({className:"photoset--photo",template:d,mixins:[l,h,c],defaults:{scaledWidth:null,scaledHeight:null,displayWidth:null,displayHeight:null},initialize:function(t){t=s.extend({},t),s.extend(this.attributes,s.pick(t,s.keys(this.defaults))),this.photo=t.photo||new u,this.photos=t.photos,this.photoset=t.photoset,this.$el.attr("data-photo-id",this.photo.get("id")),this.listenTo(this.photo,"change:id",function(t,e){this.$el.attr("data-photo-id",e)})},thumbnailDimensions:function(t,e){var i=this.photo.getHeightForWidth(100);return e&&i>e&&(i=e,t=this.photo.getWidthForHeight(100)),{width:Math.ceil(t),height:Math.ceil(i)}},resize:function(t){t||(t=r);var e=this.get("displayWidth")||0,i=this.get("displayHeight")||0,s=this.get("scaledWidth")||0,a=this.get("scaledHeight")||0;return o(this.js$("crop"),"stop"),o(this.js$("positioner"),"stop"),o(this.js$("image"),"stop"),n.join(o(this.js$("crop"),{width:e,height:i},{duration:t}),o(this.js$("positioner"),{width:Math.max(0,s-e),height:Math.max(0,a-i)},{duration:t}),o(this.js$("image"),{width:s,height:a},{duration:t}))},serialize:function(){return s.defaults(this.toJSON(),this.photo.toJSON())},beforeTeardown:function(){return this.stopListening(),this},render:function(){var t=this.serialize();return this.$el.html(this.template(t)),this.attachSubViews(),this}});e.exports=p},{"../models/photo":204,"../templates/photo.tpl":206,lodash:"MicNly","prima/mixins/accessor":542,"prima/mixins/selectorcache":553,"prima/mixins/subviewable":554,"prima/view":580,"velocity-animate":"lWl/mc",when:"RG2dij"}],214:[function(t,e,i){"use strict";var s=t("lodash"),n=t("jquery"),o=t("prima/view"),a=t("../utils/imagelayout"),r=(t("prima/lib/logger"),t("prima/mixins/subviewable")),l=t("prima/mixins/selectorcache"),h=t("prima/mixins/accessor"),c=t("../models/photo"),u=t("../models/photoset"),d=t("../templates/photoset.tpl"),p=t("./photo"),m=t("../utils/attrdata"),g=t("prima/utils/image/types").getImageType,f=function(t,e,i){s.isNumber(i)||(i=0);var n=0,o=t.length,r=e-2*i*(o-1),l=r/o,h=s.map(t,function(t,e){t instanceof c&&(t=t.toJSON());var i=e%2?Math.ceil(l):Math.floor(l);e>=o-1&&(i=r),r-=i;var s=Math.round(a.heightForWidth(t.width,t.height,i));return(!n||s&&n>s)&&(n=s),{width:i,height:s}});return{width:e,height:n,photos:h}},_=o.extend({className:"photoset",template:d,mixins:[r,l,h],defaults:{dynamic:!1,width:500,height:0,padding:5,minFullWidthSize:300},$$cacheKeys:{row:".photoset--row",cell:".photoset--cell"},$$rows:function(t){return this.$$(this.$$cacheKeys.row,t)},$$cells:function(t){return this.$$(this.$$cacheKeys.cell,t)},initialize:function(t){this.options=t=s.extend({},t),s.extend(this.attributes,s.pick(t,s.keys(this.defaults))),this._PhotoView=t.PhotoView||p,this.photoset=t.photoset||new u},_updateRowCache:function(){return this._rowCache=s.map(this.photoset.getRows(),function(t){return s.pluck(t,"id")}),this._rowCache},_updateLayoutCache:function(){var t=this._updateRowCache(),e=this._layoutCache={rows:[],photos:{}},i=this.get("padding"),n=this.get("width"),o=0;return s.forEach(t,function(a,r){var l=this.photoset.photos.getSubset(a),h=r>0?i:0,c=r<t.length-1?i:0,u=this.rowSize(l,n,i),d=u.height+h+c;e.rows[r]={unpaddedHeight:u.height,paddingTop:h,paddingBottom:c,height:d,cells:[]},o+=d,s.forEach(l,function(t,s){var n=s<l.length-1?i:0,o=s>0?i:0,a=u.photos[s],h=t.get("id");e.photos[h]={scaledWidth:a.width,scaledHeight:a.height,displayWidth:a.width,displayHeight:u.height},e.rows[r].cells[s]={photo:h,unpaddedWidth:a.width,paddingLeft:o,paddingRight:n,width:a.width+o+n,height:d}},this)},this),e.width=n,e.height=o,this.set("height",o),e},rowSize:function(t,e,i){return t||(t=this.photoset.photos),s.isNumber(e)||(e=this.get("width")),s.isNumber(i)||(i=this.get("padding")),f(t,e,i)},createRowElement:function(){return n('<div class="photoset--row"></div>')},createCellElement:function(t){var e=n('<div class="photoset--cell"></div>');return null!=t&&m.set(e,"data-photo-id",t),e},createPhotoSubView:function(t){var e=new this._PhotoView({photoset:this.photoset,photos:this.photoset.photos,photo:t});return t.get("id")&&(this.subViews[t.get("id")]=e),e},createSubViews:function(){this.photoset.photos.forEach(this.createPhotoSubView,this)},createSinglePhotoLayout:function(){this._layoutCache||this._updateLayoutCache();var t=this.photoset.photos.at(0),e=t.get("width"),i=t.get("height"),s=g(t.get("url"))||"gif",n=this.getMinFullWidthSize(s);e>=n&&(i=Math.round(a.heightForWidth(e,i,this.get("width"))),e=this.get("width"));var o=t.get("id"),r=this.subViews[o];r.set({scaledWidth:e,scaledHeight:i,displayWidth:e,displayHeight:i});var l=this.js$("layout"),h=this.createRowElement().height(i),c=this.createCellElement(o);c.css({width:e,height:i,padding:0}).addClass("photoset--single-cell"),n>e&&c.addClass("photoset--single-cell-margin"),c.append(r.$el),h.append(c),l.append(h),this.renumberRowsAndCells()},createPhotosetLayout:function(){var t=this._layoutCache||this._updateLayoutCache();s.forEach(t.rows,function(e,i){var n=this.createRowElement();n.height(e.height),s.forEach(e.cells,function(i,o){var a=i.photo,r=t.photos[a],l=this.subViews[a];l.set(r);var h=this.createCellElement(a);h.css({width:i.width,height:i.height,padding:s.map([e.paddingTop,i.paddingRight,e.paddingBottom,i.paddingLeft],function(t){return t?t+"px":0}).join(" ")}),h.append(l.$el),n.append(h)},this),this.js$("layout").append(n)},this),this.renumberRowsAndCells()},renumberRowsAndCells:function(){s.forEach(this.$$rows(!0),function(t,e){m.set(t,"data-photoset-row",e)},this),s.forEach(this.$$cells(!0),function(t,e){m.set(t,"data-photoset-position",e)},this)},getMinFullWidthSize:function(t){var e=this.get("minFullWidthSize");return s.isNumber(e)?e:s.has(e,t)?e[t]:300},serialize:function(){return s.extend(this.toJSON(),{_rowSize:s.bind(this.rowSize,this),photoTemplate:p.prototype.template,photoset:this.photoset.toJSON()})},afterTeardown:function(){return this.stopListening(),delete this._rowCache,delete this._layoutCache,this.teardownSubViews()},render:function(){return this.get("dynamic")?(this.$el.html('<div class="photoset--layout" data-js-layout></div>'),this.createSubViews(),1===this.photoset.photos.length?this.createSinglePhotoLayout():this.createPhotosetLayout()):this.$el.html(this.template(this.serialize())),this}});e.exports=_},{"../models/photo":204,"../models/photoset":205,"../templates/photoset.tpl":207,"../utils/attrdata":208,"../utils/imagelayout":209,"./photo":213,jquery:"HlZQrA",lodash:"MicNly","prima/lib/logger":519,"prima/mixins/accessor":542,"prima/mixins/selectorcache":553,"prima/mixins/subviewable":554,"prima/utils/image/types":574,"prima/view":580}],215:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/component"),o=t("./templates/embed-code.tpl"),a=t("prima/lib/data"),r=n.extend({name:"PostEmbedCodeGenerator",defaults:{embed_host:"//embed.tumblr.com",secure_assets_host:"https://secure.assets.tumblr.com",tumblelog_mention_key:"",post_id:"",post_url:"",embed_key:"",embed_did:""},initialize:function(t){this.options=s.extend({},this.defaults,t);var e=a.get("Context/hosts");e&&(e.embed_host&&(this.options.embed_host=e.embed_host),e.secure_assets_host&&(this.options.secure_assets_host=e.secure_assets_host)),this.template=o},getCode:function(){return this.template(this.options)}});e.exports=r},{"./templates/embed-code.tpl":216,lodash:"MicNly","prima/component":511,"prima/lib/data":514}],216:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __t,__p="";Array.prototype.join;with(obj||{})__p+="",__p+="undefined"!=typeof language&&"undefined"!=typeof width?'<div class="tumblr-post" data-href="'+(null==(__t=embed_host)?"":_.escape(__t))+"/embed/post/"+(null==(__t=embed_key)?"":_.escape(__t))+"/"+(null==(__t=post_id)?"":_.escape(__t))+'" data-did="'+(null==(__t=embed_did)?"":_.escape(__t))+'" data-language="'+(null==(__t=language)?"":_.escape(__t))+'" data-width="'+(null==(__t=width)?"":_.escape(__t))+'"><a href="'+(null==(__t=post_url)?"":_.escape(__t))+'">'+(null==(__t=post_url)?"":_.escape(__t))+"</a></div>":"undefined"!=typeof language?'<div class="tumblr-post" data-href="'+(null==(__t=embed_host)?"":_.escape(__t))+"/embed/post/"+(null==(__t=embed_key)?"":_.escape(__t))+"/"+(null==(__t=post_id)?"":_.escape(__t))+'" data-did="'+(null==(__t=embed_did)?"":_.escape(__t))+'" data-language="'+(null==(__t=language)?"":_.escape(__t))+'"><a href="'+(null==(__t=post_url)?"":_.escape(__t))+'">'+(null==(__t=post_url)?"":_.escape(__t))+"</a></div>":"undefined"!=typeof width?'<div class="tumblr-post" data-href="'+(null==(__t=embed_host)?"":_.escape(__t))+"/embed/post/"+(null==(__t=embed_key)?"":_.escape(__t))+"/"+(null==(__t=post_id)?"":_.escape(__t))+'" data-did="'+(null==(__t=embed_did)?"":_.escape(__t))+'" data-width="'+(null==(__t=width)?"":_.escape(__t))+'"><a href="'+(null==(__t=post_url)?"":_.escape(__t))+'">'+(null==(__t=post_url)?"":_.escape(__t))+"</a></div>":'<div class="tumblr-post" data-href="'+(null==(__t=embed_host)?"":_.escape(__t))+"/embed/post/"+(null==(__t=embed_key)?"":_.escape(__t))+"/"+(null==(__t=post_id)?"":_.escape(__t))+'" data-did="'+(null==(__t=embed_did)?"":_.escape(__t))+'"><a href="'+(null==(__t=post_url)?"":_.escape(__t))+'">'+(null==(__t=post_url)?"":_.escape(__t))+"</a></div>",__p+='<script async src="'+(null==(__t=secure_assets_host)?"":_.escape(__t))+'/post.js"></script>';return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],217:[function(t,e,i){"use strict";var s=(t("prima/utils/exposer"),t("lodash")),n=t("jquery"),o=t("when"),a=t("prima/utils/sequence-with-context"),r=t("prima/mixins/promisifyevents"),l=t("prima/component"),h=t("prima/events"),c=t("prima/lib/domeventor"),u=(t("prima/lib/logger"),t("backbone")),d=(t("./utils/transition_speed"),t("./utils/scroll_helper")),p=t("./utils/save_hook"),m=t("./utils/post_form_container_type"),g="/dashboard",f=t("prima/lib/translate"),_=n("body"),v=t("app/components/post-form"),b=t("app/components/dialog"),y=t("app/lib/currentuser"),w=t("app/components/post-form/models/post"),x=t("app/components/post-form/services/embed_data"),C=t("./views/glass"),k=t("./views/modal"),S=t("./views/container"),T=t("./views/post_buttons"),E=l.extend({name:"PostFormBuilder",initialize:function(){var t=this.data;if(this.user=y(),this.user){var e={baseRoute:void 0,currentChannel:void 0,supportImageSearch:!1,minFullWidthSize:{},redirectTo:!1,reblogActionContext:!1,updateURL:!0};s.extend(this,e,s.pick(t,s.keys(e))),this._addGlobalEventListeners(),this.user.set(t.limits),this.user.set(t.dashboardSettings),this.user.set("language",t.language||"en_US"),x.setEmbedRegexes(t.embedRegexes),this.glass=new C,this.modal=new k,this.modalContainer=new S({className:"post-form-modal-content",animateHeightWithContent:!0}),this.modal.setContentSubView(this.modalContainer),this.postButtons=new T({el:"#new_post"}),this.postButtonsContainer=new S({el:this.postButtons.$el.parent(),originalContent:this.postButtons,transitionBackground:!0,animateHeightWithContent:!0,useLoader:!1}),this.scrollHelper=new d,this.saveHook=new p(s.extend({$postButtonsContainer:this.postButtonsContainer.$el},t)),this.legacyEvents(),this._updateData=s.once(this.updateData),this.render()}},updateData:function(){var t=n.ajax({url:"/svc/post/get_post_form_builder_data",type:"POST",with_form_key:!0,data:{}});return t.then(s.bind(function(t){var e=t.response;return s.forEach(e.channels,function(t){var e=t.name?this.user.getChannel(t.name):!1;e&&e.set(s.omit(t,"name"))},this),this.user.set(e.limits),e},this))},legacyEvents:function(){var t={"postForms:closed":["post:form:hide","keycommands:resume"],"postForms:saved":["post:form:success"],"postForms:opened":["post:form:show","keycommands:suspend"]};s.forEach(t,function(t,e){this.listenTo(h,e,function(){var e=s.toArray(arguments);s.each(t,function(t){h.trigger.apply(h,[].concat(t,e))},this)})},this)},_addGlobalEventListeners:function(){this.listenTo(h,"postForms:open",this.createPostForm),this.listenTo(h,"postForms:new",this._createPostFormNew),this.listenTo(h,"postForms:edit",this._createPostFormEdit),this.listenTo(h,"postForms:reblog",this._createPostFormReblog),this.listenTo(h,"postForms:saved",this.destroyPostForm),this._registerDismissListener(),this.listenTo(h,"postForms:dismissListener:suspend",function(){this._toggleDismissListener(!1)}),this.listenTo(h,"postForms:dismissListener:resume",function(){this._toggleDismissListener(!0)})},_toggleDismissListener:function(t){this.stopListening(h,"postForms:close"),t&&this._registerDismissListener()},_registerDismissListener:function(){this.listenTo(h,"postForms:close",this.dismissPostForm)},createInlineContainer:function(t){return t?new S({el:t.parent(),originalContent:t,transitionBackground:!0}):!1},_createPostFormNew:function(t){return this.createPostForm(t)},_createPostFormEdit:function(t){return t.postEl&&(t.containerView=this.createInlineContainer(t.postEl),t.postFormType=m.inline),this.createPostForm(t)},_createPostFormReblog:function(t){return this.createPostForm(t)},createPostForm:function(t){if(this.postForm)return this.destroyPostForm(t).then(s.bind(function(){return this.createPostForm(t)},this));t=s.extend({fastCompose:!1,supportImageSearch:this.supportImageSearch,minFullWidthSize:this.minFullWidthSize,updateURL:this.updateURL,glass:!0,postFormType:m.modal},t),s.defaults(t,{containerView:t.postFormType===m.inline?this.postButtonsContainer:null}),t.post||(t.post=this._createPostModel(t)),t.url||(t.url=this._postFormUrl(t.post)),t.containerView===this.postButtonsContainer&&this.postButtons.setPostType(t.post.get("type")),this._updateData();var e=t.postFormType===m.modal,i=["supportImageSearch","minFullWidthSize","post"];"photo"===t.post.get("type")&&i.push("showPhotoBooth");var r=this.postForm=new v(s.extend(s.pick(t,i),{isModal:e,popoverContainer:e?this.modal.$el:_,redirectTo:this.redirectTo,reblogActionContext:this.reblogActionContext,fastCompose:t.fastCompose})),l=this.postFormContainer=t.containerView||this.modalContainer;if(!l)throw new Error("No post form container!");this.listenTo(r,"pauseScrollHelper",this.pauseScrollHelper),this.listenTo(r,"resumeScrollHelper",this.resumeScrollHelper),l.isRendered()||l.render(),l.setPostFormComponent(r);var d=s.once(s.bind(function(){return t.glass?this.glass.show():o.resolve()},this)),p=a([function(){return h.trigger("Header:hide"),o.join(l.prepare(d),r.whenRendered(!0))},function(){return r.disable(),l.attach(d)},function(){return t.updateURL&&u.history.navigate(t.url,{replace:!0}),function(){var t=c.rect(),i=t.windowScrollTop,o=t.windowHeight,a=r.getRect(),u=a.offsetHeight,d=l.$el.offset().top,p=d+u,m=20,g=n("[prima-component=header]").height()||0,f=o>u+2*m,_=this.scrollHelper.calculateScrollTop(d-m,p+m+g,o,f),v=400,b=e?this.modal.$el:void 0;l===this.postButtonsContainer&&_>i&&o>u&&(_=i),this.previousScrollPosition=e?!1:i,this.scrollHelper.scrollToPosition(_,v,b),this.listenTo(h,"Photoset:dragScroll",function(t,e){s.isNumber(e)||(e=50);var i=c.rect().windowScrollTop+t;this.scrollHelper.scrollToPosition(i,e,b)}),this.listenTo(h,"Photoset:scrollToRow",function(t,e,i){s.isNumber(i)||(i=50),t+=0,this.scrollHelper.checkScrollBounds(!1,{keepInside:!0,contentPadding:70,contentRect:{offsetTop:t,offsetHeight:e}})})}.call(this),l.showPostForm(d)},function(){return d()},function(){r.enable()}],this).then(s.bind(function(){return h.trigger("postForms:opened"),_.addClass("postforms-open"),r},this),s.bind(function(){this.destroyPostForm()},this));return t.postFormType===m.inline&&p.then(s.bind(function(){this.scrollHelper.start({el:l.$el})},this)),p["catch"](function(t){t instanceof Error&&s.defer(function(){throw t})}),p},_postFormStateChanged:function(t){if(this.postForm){var e=this.postForm.initialPostState,i=this.postForm.post;return i.deepHasChanged(e)}return!1},dismissPostForm:function(){(!this.postForm||this.postForm.isEnabled())&&(this._postFormStateChanged()?this._buildDismissPrompt():this.destroyPostForm())},_buildDismissPrompt:function(){var t=f("Discard this post?");this.postForm&&this.postForm.post&&"edit"===this.postForm.post.get("mode")&&(t=f("Discard edits to this post?"));var e={text:t,text_ok:f("Discard"),text_cancel:f("Nevermind"),keycommand_maintain:!0};b.confirm(e,s.bind(function(){this.destroyPostForm(),h.trigger("postForms:dismissListener:resume")},this),function(){s.defer(function(){h.trigger("postForms:dismissListener:resume")})}),h.trigger("postForms:dismissListener:suspend")},destroyPostForm:function(t,e){t=s.extend({updateURL:this.updateURL,url:this.baseRoute,glass:!0},t),this.scrollHelper.stop();var i=this.postForm,n=this.postFormContainer,r=!!i.fastCompose;this.postForm=null,this.postFormContainer=null,this.stopListening(i),this.stopListening(h,"Photoset:dragScroll");var l=s.once(s.bind(function(){return t.glass?this.glass.hide():o.resolve()},this)),c=i&&!!i.postForm.get("saved"),d=a([function(){c&&this.saveHook.preExecute(e)},function(){i&&i.disable()},function(){return function(){if(this.previousScrollPosition!==!1){var t=this.previousScrollPosition,e=400;this.scrollHelper.scrollToPosition(t,e)}}.call(this),n?n.hidePostForm(l).then(function(){n.teardown()}):void 0},function(){if(i&&i.remove(),t.updateURL){var e=u.history.root||"",s=t.url?t.url.replace(new RegExp("^"+e),""):"";u.history.navigate(s,{replace:!0})}},function(){return l()},function(){c&&e&&(this.saveHook.$inlinePostEl=n.$el,this.saveHook.execute(e,{fastCompose:r}))}],this).then(function(){return h.trigger("postForms:closed"),h.trigger("Header:show"),_.removeClass("postforms-open"),i});return d["catch"](function(t){t instanceof Error&&s.defer(function(){throw t})}),d},pauseScrollHelper:function(){this.scrollHelper&&this.scrollHelper.pause()},resumeScrollHelper:function(){this.scrollHelper&&this.scrollHelper.resume()},_createPostModel:function(t){"string"==typeof t&&(t={postType:t});var e=s.extend({tumblelog:t.channelId||this.currentChannel,editorType:this.user.get("defaultEditorType"),contextData:{baseRoute:this.baseRoute}},s.pick(t,"tags","sourceUrl","loggingData"));return t.reblogId?s.defaults(e,{lookupData:{reblog_id:t.reblogId,reblog_key:t.reblogKey},mode:"reblog",pt:t.pt,reblogSource:t.reblogSource}):t.editId?s.defaults(e,{lookupData:{post_id:t.editId,channel_id:t.channelId||this.redirectChannel},mode:"edit"}):s.defaults(e,{type:t.postType||t.type||"text",mode:"new"}),new w(e)},_postFormUrl:function(t){if(t){if(t.has("lookupData")){var e=t.get("lookupData");return e.reblog_id?this._reblogPostUrl(e.reblog_id,e.reblog_key):e.post_id?this._editPostUrl(e.post_id):this._newPostUrl(t.get("type"))}return t.has("reblog_id")?this._reblogPostUrl(t.get("reblog_id"),t.get("reblog_key")):t.has("id")?this._editPostUrl(t.get("id")):this._newPostUrl(t.get("type"))}return this._newPostUrl("text")},_newPostUrl:function(t){var e=this.baseRoute!==g?this.baseRoute:"";return e+"/new/"+t},_editPostUrl:function(t){return"/edit/"+t},_reblogPostUrl:function(t,e){return"/reblog/"+t+"/"+e},render:function(){return this.glass.render().$el.appendTo("body"),this.modal.render().$el.appendTo("body"),this},updateBaseRoute:function(t){var e;t?this.baseRoute=t:(e=u&&u.history?u.history.location.pathname:g,this.baseRoute=e)}},{containerType:function(t){return m[t]}});r.applyTo(E.prototype),e.exports=E},{"./utils/post_form_container_type":222,"./utils/save_hook":223,"./utils/scroll_helper":224,"./utils/transition_speed":225,"./views/container":226,"./views/container_content":227,"./views/glass":228,"./views/modal":230,"./views/post_buttons":231,"app/components/dialog":44,"app/components/post-form":233,"app/components/post-form/models/post":242,"app/components/post-form/services/embed_data":249,"app/lib/currentuser":432,backbone:"5kFNoY",jquery:"HlZQrA",lodash:"MicNly","prima/component":511,"prima/events":512,"prima/lib/domeventor":516,"prima/lib/logger":519,"prima/lib/translate":541,"prima/mixins/promisifyevents":551,"prima/utils/exposer":569,"prima/utils/sequence-with-context":577,when:"RG2dij"}],218:[function(t,e,i){"use strict";var s=t("lodash"),n=t("sprintf-js").sprintf,o=t("prima/model"),a=o.extend({endpoint:"/svc/post/%s/%s/%s",parse:function(t){return{dashboardHTML:t.trim()}},sync:function(t,e,i){if("read"!==t)throw new Error("The DashboardPostFetch model may only READ from server!");if(i=s.defaults(i||{},{pageRoot:!1,direction:!1,refPostID:!1}),!1===(i.pageRoot&&i.direction))throw new Error(n("These two fetch params must be passed: pageRoot [%s], direction [%s]",i.pageRoot,i.direction));return s.defaults(i,{dataType:"html",emulateHTTP:!0,url:n(this.endpoint,i.pageRoot,i.direction,i.refPostID)}),o.prototype.sync.call(this,t,e,i)}});e.exports=a},{lodash:"MicNly","prima/model":557,"sprintf-js":"qPOUxN"}],219:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __p="";Array.prototype.join;with(obj||{})__p+="",transitionBackground&&(__p+='<div class="post-transition-background"></div>'),__p+="",originalContent&&(__p+='<div data-subview="originalContent"></div>'),__p+='<div data-subview="loader"></div><div data-subview="postForm"></div>';return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],220:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __p="";Array.prototype.join;
with(obj||{})__p+='<div class="Knight-Rider-loader ',loading&&(__p+="animate"),__p+='"><div class="Knight-Rider-bar"></div><div class="Knight-Rider-bar"></div><div class="Knight-Rider-bar"></div></div>';return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],221:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __p="";Array.prototype.join;with(obj||{})__p+='<div class="v-center-outer"><div class="v-center-inner"><div class="v-center-content"><div data-subview="content"></div></div></div></div>';return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],222:[function(t,e,i){"use strict";var s={modal:1,inline:2};e.exports=s},{}],223:[function(t,e,i){"use strict";var s=t("lodash"),n=t("jquery"),o=t("numeral"),a=t("prima/events"),r=t("../models/dashboard_post_fetch"),l=t("app/lib/currentuser"),h=function(){var t=".post_container",e=".post:not([data-is-pinned])",i=["dashboard","drafts","inbox"],h={preExecute:function(){return"queue"===this.contextData.contextPage?(n(window).off("beforeunload"),void window.location.replace(this.contextData.baseRoute)):void 0},execute:function(t,e){if(e=s.merge({fastCompose:!1},e||{}),this.saveResponse=t.responseJSON,-1!==i.indexOf(this.contextData.contextPage)){var a=!this.saveResponse.post.is_edit&&!this.saveResponse.post.is_reblog,r="post_dashboard_html"in this.saveResponse,h=!(!this.saveResponse.post||!this.saveResponse.post.is_edit)&&this.contextData.contextPage!==this.saveResponse.post_context_page&&this.$inlinePostEl.hasClass("post_container");if(a?this._fetchMorePosts():r&&(h?this._removeInline():this._updateInline()),this._displayNotification(this.saveResponse,e),this.saveResponse.context_tumblelog){var c=this.saveResponse.context_tumblelog.name_or_id,u=n('#dashboard_controls_open_blog[data-blog-name="'+c+'"]');s.forEach(this.saveResponse.context_tumblelog,function(t,e){if(e.match(/_count$/i)){var i=u.find('[data-blog-controls-count="'+e+'"]');i.toggleClass("count_0","0">=t),i.find(".count").text(o(t).format("0,0"))}},this);var d=l().getChannel(c),p=s.pick(this.saveResponse.context_tumblelog,d.keys());d.set(p)}}},_fetchMorePosts:function(){var t=this.contextData.baseRoute.replace(/^\/|\/$/g,""),e="drafts"===this.contextData.contextPage?"after":"before",i=this._findLatestPostId(),n=new r;n.fetch({pageRoot:t,direction:e,refPostID:i,success:s.bind(this._fetchSuccess,this),error:this._fetchFailure})},_fetchSuccess:function(i){var s=n(i.get("dashboardHTML")),o=this.contextData.$postButtonsContainer.nextAll(t).has(e).first();0===o.length?this.contextData.$postButtonsContainer.parent().append(s):s.insertBefore(o),n(".no_posts_found").remove(),a.trigger("posts:load")},_fetchFailure:function(){console.error("Failed loading dashboard HTML after successful post submission.")},_findLatestPostId:function(){var i=this.contextData.$postButtonsContainer.nextAll(t).find(e).first().data("post-id");return i},_updateInline:function(){var t=n(this.saveResponse.post_dashboard_html.trim());this.$inlinePostEl.replaceWith(t.eq(0)),a.trigger("posts:load")},_removeInline:function(){var t=this.contextData.baseRoute.split("/");t.splice(-1,1);var e=this.$inlinePostEl;return e.fadeOut(200,function(){e.remove()}),n("#posts .post").not(".new_post").length<=1?void(window.location=t.join("/")):void 0},_displayNotification:function(t,e){var i=this.contextData.baseRoute.split("/"),n=i[1]||"",o=t.message,r=s.parseInt(this.contextData.notificationDelay),l={url:t.post_tumblelog.post_url,tumblelog:{name:t.post_tumblelog.name_or_id,url:t.post_tumblelog.url,avatar:t.post_tumblelog.avatar}};(!t.created_post||t.post.is_reblog||e&&e.fastCompose||"tagged"===n.toLowerCase())&&s.delay(function(){a.trigger("postForms:saveHook:toast",o,l)},r)}},c=function(t){this.contextData=s.defaults(t||{},{notificationDelay:250}),s.extend(this,h)};return c}();e.exports=h},{"../models/dashboard_post_fetch":218,"app/lib/currentuser":432,jquery:"HlZQrA",lodash:"MicNly",numeral:"ubjloo","prima/events":512}],224:[function(t,e,i){"use strict";var s=t("lodash"),n=t("jquery"),o=t("velocity-animate").animate,a=t("../utils/transition_speed"),r=t("prima/class"),l=t("backbone"),h=t("prima/lib/domeventor"),c=t("prima/events"),u=(t("prima/lib/logger"),n("html")),d=r.extend({defaults:{keepInside:!1,scrollSpeedMs:250,triggerPadding:-50,contentPadding:20,debounceMs:200},start:function(t){return this._running&&this.stop(),this._running=!0,t&&!s.isPlainObject(t)&&(t={el:t}),this.options=t=s.extend({},this.defaults,t),this.$el=n(t.el),this.updateContentRect(),this.listenTo(c,"DOMEventor:flatscroll",this.checkScrollBounds),this},stop:function(){return this._running=!1,this._scrollTop=!1,this.cancelEnforceScrollBounds(),this.stopListening(),this},pause:function(){this._running&&(this._ignoreScroll=!0)},resume:function(){this._running&&this._ignoreScroll&&(this._ignoreScroll=!1,this.checkScrollBounds())},updateContentRect:function(){this.contentRect||(this.contentRect={}),this.lastContentRect&&(this.lastContentRect.offsetTop=this.contentRect.offsetTop,this.lastContentRect.offsetLeft=this.contentRect.offsetLeft,this.lastContentRect.offsetHeight=this.contentRect.offsetHeight,this.lastContentRect.offsetWidth=this.contentRect.offsetWidth);var t=this.$el.offset();return this.contentRect.offsetTop=t.top,this.contentRect.offsetLeft=t.left,this.contentRect.offsetHeight=this.$el.outerHeight(),this.contentRect.offsetWidth=this.$el.outerWidth(),this.lastContentRect||(this.lastContentRect=s.clone(this.contentRect)),this.contentRect},calculateScrollTop:function(t,e,i,s){return s?t:e-i},checkScrollBounds:function(t,e){if(!this._ignoreScroll){e=e?s.extend({},this.defaults,this.options,e):this.options,t||(t=h.rect());var i,n,o=e.contentRect||this.updateContentRect(),a=e.triggerPadding||0,r=e.contentPadding||0,l=o.offsetHeight,c=o.offsetTop,u=c+l,d=t.windowHeight,p=Math.max(0,t.windowScrollTop),m=p+d;return e.keepInside?(i=p-c,n=u-m):(i=p-u,n=c-m),n>a?(this._scrollTop=this.calculateScrollTop(c-r,u+r,d,l+2*r>d),this.enforceScrollBounds(e),!0):i>a?(this._scrollTop=this.calculateScrollTop(c-r,u+r,d,e.bottom||d>l+2*r),this.enforceScrollBounds(e),!0):(this._scrollTop=!1,this.cancelEnforceScrollBounds(),!1)}},enforceScrollBounds:function(t){var e=null!=t.scrollTop?t.scrollTop:this._scrollTop,i=t.scrollSpeedMs,n=t.debounceMs,o=t.container;n?this._enforceTimeout||(this._enforceTimeout=s.delay(s.bind(function(){null==t.scrollTop&&(e=this._scrollTop),this.scrollTop!==!1&&this.scrollToPosition(e,i,o)},this),n)):this.scrollToPosition(e,i,o)},cancelEnforceScrollBounds:function(){this._enforceTimeout,clearTimeout(this._enforceTimeout),this._enforceTimeout=!1},scrollToPosition:function(t,e,i){this._ignoreScroll=!0,o(u,"stop"),o(u,"scroll",{offset:t,container:i,duration:a(e||this.defaults.scrollSpeedMs)}).then(s.bind(function(){this._ignoreScroll=!1},this))}});s.extend(d.prototype,l.Events),e.exports=d},{"../utils/transition_speed":225,backbone:"5kFNoY",jquery:"HlZQrA",lodash:"MicNly","prima/class":509,"prima/events":512,"prima/lib/domeventor":516,"prima/lib/logger":519,"velocity-animate":"lWl/mc"}],225:[function(t,e,i){"use strict";var s=1,n=function(t){return t*s};n.get=function(){return s},n.set=function(t){s=t},e.exports=n},{}],226:[function(t,e,i){"use strict";var s=t("lodash"),n=t("when"),o=t("velocity-animate").animate,a=t("prima/utils/sequence-with-context"),r=t("../utils/transition_speed"),l=t("prima/mixins/promisifyevents"),h=t("prima/view"),c=(t("prima/lib/logger"),t("prima/mixins/subviewable")),u=t("prima/mixins/selectorcache"),d=t("prima/mixins/accessor"),p=t("./container_content"),m=t("./loader"),g=t("../templates/container.tpl"),f=h.extend({mixins:[c,u,d,l],template:g,defaultOptions:{animateDuringPrepare:!0,animateHeightWithContent:!1,startHeight:null,useLoader:!0,loaderDelay:250,transitionBackground:!1},defaults:{minHeight:!1,pretransition:!1,midtransition:!1},initialize:function(t){t instanceof h&&(t={postForm:t}),this.options=t=s.extend({},this.defaultOptions,t),s.extend(this.attributes,s.pick(t,s.keys(this.defaults))),t.postForm&&this.setPostForm(t.postForm),this.listenTo(this,"change:minHeight",this._onChangeMinHeight),this.listenTo(this,"change:pretransition",this._onChangePretransition),this.listenTo(this,"change:midtransition",this._onChangeMidtransition)},_onChangeMinHeight:function(t,e){o(this.$el,"stop"),e||s.isNumber(e)?o(this.$el,{"min-height":e},{duration:r(Math.min(Math.max(250,e),750))}):(e=s.parseInt(this.$el.css("min-height"),10)||0,o(this.$el,{"min-height":[0,e]},{duration:r(Math.min(Math.max(250,e),750))}).then(s.bind(function(){this.$el.css("min-height","")},this)))},_onChangePretransition:function(t,e){e?this.$el.addClass("post-form-container-pretransition"):this.$el.removeClass("post-form-container-pretransition")},_onChangeMidtransition:function(t,e){e?this.$el.addClass("post-form-container-transition"):this.$el.removeClass("post-form-container-transition")},setPostFormComponent:function(t){return this._postFormComponent!==t?(this._postFormComponent&&this.stopListening(this._postFormComponent),this._postFormComponent=t,this.postForm=t.postForm,this):void 0},prepare:function(t){return this.isRendered()||this.render(),this.trigger("prepared",this),this.loadingDelay=s.delay(s.bind(function(){this.loader&&this.options.useLoader&&this.loader.set("loading",!0)},this),this.options.loadingDelay),this.options.animateDuringPrepare&&(this._hideOriginalContent=this.hideOriginalContent(t).then(s.bind(function(){return this._hideOriginalContent=!1,this},this))),n.resolve(this)},attach:function(t){return this.loader&&(clearTimeout(this.loadingDelay),this.loader.set("loading",!1)),this.set("pretransition",!0),this.postForm.forceHidden(),this.attachSubView(this.postForm,"postForm"),n.resolve(this)},hideOriginalContent:function(t){var e=this.options.startHeight||this.originalContent.measureHeight(),i=this.postForm.measureHeight();return e||this.options.originalContent||(e=i),a([function(){null!=e&&this.$el.css("height",e),this.set("midtransition",!0),this.originalContent.set("enabled",!1)},function(){return n.join(t(),this.originalContent.animateHide(r(100)))}],this)},showPostForm:function(t){var e=this.options.startHeight||this.originalContent.measureHeight(),i=this.postForm.measureHeight();return e||this.options.originalContent||(e=i),a([function(){return this.options.animateHeightWithContent||this.originalContent.get("hidden")?void 0:this._hideOriginalContent||this.hideOriginalContent(t)},function(){var s=[];return this.options.animateHeightWithContent&&!this.originalContent.get("hidden")&&s.push(this._hideOriginalContent||this.hideOriginalContent(t)),null==i||null==e||(i===e?this.$el.height(i):s.push(o(this.$el,{height:[i,e]},{duration:r(150),easing:[.4,1.3,.7,1]}))),n.all(s)},function(){return this.set("placeholder",!1),this.postForm.animateShow(r(100))},function(){this.set("pretransition",!1),this.set("midtransition",!1),this.$el.css("height","")}],this)},hidePostForm:function(t){var e=this.postForm.measureHeight(),i=this.originalContent.measureHeight();return i||this.options.originalContent||(i=e),a([function(){this.$el.css("height",e),this.set("midtransition",!0)},function(){return this.postForm.animateHide(r(100))},function(){if(this.set("pretransition",!0),null==i||null==e);else{if(i!==e)return o(this.$el,{height:[i,e]},{duration:r(100),easing:[0,0,.6,1]});this.$el.height(i)}},function(){return n.join(t(),this.originalContent.animateShow(r(50)))},function(){this.set("midtransition",!1),this.set("pretransition",!1),this.$el.css("height",""),this.originalContent.set("enabled",!0)}],this)},serialize:function(){return{originalContent:!!this.options.originalContent,transitionBackground:this.options.transitionBackground}},beforeRender:function(){this.loader||(this.loader=new m),this.originalContent||(this.options.originalContent instanceof p?this.originalContent=this.options.originalContent:this.originalContent=new p({el:this.options.originalContent})),this.originalContent.$el.detach()},render:function(){return this.$el.html(this.template(this.serialize())),this.subViews.originalContent=this.originalContent,this.subViews.loader=this.loader,this.subViews.postForm=this.postForm,this.attachSubViews(),this},afterRender:function(){return this.$el.addClass("post-forms-above-glass is_persistent"),this.renderSubViews()},beforeTeardown:function(){return this.subViews.loader=void 0,this},afterTeardown:function(){return this.$el.removeClass("post-forms-above-glass post-form-container-pretransition post-form-container-transition is_persistent"),this.loader&&(this.loader.remove(),this.loader=void 0),this.$el.children(".post-transition-background").remove(),delete this.postForm,this.trigger("torndown",this),this.teardownSubViews()}});e.exports=f},{"../templates/container.tpl":219,"../utils/transition_speed":225,"./container_content":227,"./loader":229,lodash:"MicNly","prima/lib/logger":519,"prima/mixins/accessor":542,"prima/mixins/promisifyevents":551,"prima/mixins/selectorcache":553,"prima/mixins/subviewable":554,"prima/utils/sequence-with-context":577,"prima/view":580,"velocity-animate":"lWl/mc",when:"RG2dij"}],227:[function(t,e,i){"use strict";var s=t("lodash"),n=t("velocity-animate").animate,o=t("prima/view"),a=t("prima/mixins/subviewable"),r=t("prima/mixins/accessor"),l=o.extend({defaults:{hidden:!1,enabled:!0},mixins:[a,r],initialize:function(t){this.set("hasContent",t&&t.el),this.originalCSS=this._getCSS(["opacity"]),this.listenTo(this,"change:enabled",this._onChangeEnabled),this.listenTo(this,"change:hidden",this._onChangeHidden)},_getCSS:function(t){var e={};return s.forEach(t,function(t){e[t]=this.$el.css(t)},this),e},_onChangeEnabled:function(t,e){this.$el.toggleClass("no-pointer-events",!e)},_onChangeHidden:function(t,e){this.$el.toggleClass("collapse",e)},measureHeight:function(){if(!this.get("hasContent"))return void 0;var t=this.get("hidden");this.set("hidden",!1);var e=this.$el.outerHeight();return this.set("hidden",t),e},animateShow:function(t,e){return t||(t=0),e||(e=0),n(this.$el,{opacity:1},{duration:t,delay:e,begin:s.bind(function(){this.set("hidden",!1)},this)})},animateHide:function(t,e){return t||(t=0),e||(e=0),n(this.$el,{opacity:0},{duration:t,delay:e}).then(s.bind(function(){this.set("hidden",!0)},this))},render:function(){return this},teardown:function(){return this.$el.css(this.originalCSS),this}});e.exports=l},{lodash:"MicNly","prima/mixins/accessor":542,"prima/mixins/subviewable":554,"prima/view":580,"velocity-animate":"lWl/mc"}],228:[function(t,e,i){"use strict";var s=t("lodash"),n=t("velocity-animate").animate,o=t("prima/view"),a=t("../utils/transition_speed"),r=t("prima/mixins/subviewable"),l=t("prima/mixins/selectorcache"),h=t("prima/mixins/accessor"),c=o.extend({className:"post-forms-glass",mixins:[r,l,h],initialize:function(t){this.options=t=s.extend({active:!1,visible:!1},t),this.set({active:!!t.active,visible:!!t.visible}),this.get("visible")?this.$el.css({opacity:1,display:"block"}):this.$el.css({opacity:0,display:this.get("active")?"block":"none"}),this.listenTo(this,{"change:active":this._changeActive,"change:visible":this._changeVisible})},show:function(t){return this.set("active",!(null!=t&&!t)),this.attributes.visible&&this._showing?this._showing:(this.attributes.visible=!0,this._show())},hide:function(t){return this.set("active",!(null==t&&!t)),!this.attributes.visible&&this._hiding?this._hiding:(this.attributes.visible=!1,this._hide())},_show:function(){var t=this._showing=n(this.$el,{opacity:1},{duration:a(150),display:"block"});return t},_hide:function(){var t=this._hiding=n(this.$el,{opacity:0},{duration:a(150),display:this.get("active")?"block":"none"});return t},_changeActive:function(t,e){e?this.$el.addClass(this.className+"_active active"):(this.$el.removeClass(this.className+"_active active"),!this._changing||s.has(this.changed,"visible")||this.get("visible")||this.$el.css("display","none"))},_changeVisible:function(t,e){e?(this.$el.addClass(this.className+"_visible visible"),this._show()):(this.$el.removeClass(this.className+"_visible visible"),this._hide())},render:function(){return this}});e.exports=c},{"../utils/transition_speed":225,lodash:"MicNly","prima/mixins/accessor":542,"prima/mixins/selectorcache":553,"prima/mixins/subviewable":554,"prima/view":580,"velocity-animate":"lWl/mc"}],229:[function(t,e,i){"use strict";var s=t("prima/view"),n=t("prima/mixins/subviewable"),o=t("prima/mixins/selectorcache"),a=t("prima/mixins/accessor"),r=t("../templates/loader.tpl"),l=s.extend({className:"post-forms-loader",mixins:[n,o,a],template:r,initialize:function(t){this.listenTo(this,"change:loading",this._onChangeLoading),this.set("loading",t&&t.loading)},_onChangeLoading:function(t,e){this.isRendered()&&(e?(this.$el.addClass("loading"),this.$$(".Knight-Rider-loader").addClass("animate")):(this.$el.removeClass("loading"),this.$$(".Knight-Rider-loader").removeClass("animate")))},render:function(){return this.$el.html(this.template(this.attributes)),this}});e.exports=l},{"../templates/loader.tpl":220,"prima/mixins/accessor":542,"prima/mixins/selectorcache":553,"prima/mixins/subviewable":554,"prima/view":580}],230:[function(t,e,i){"use strict";var s=t("jquery"),n=t("velocity-animate").animate,o=t("prima/view"),a=t("../utils/transition_speed"),r=t("prima/mixins/subviewable"),l=t("prima/mixins/selectorcache"),h=t("prima/mixins/accessor"),c=t("../templates/modal.tpl"),u=o.extend({className:"post-forms-modal",mixins:[r,l,h],template:c,initialize:function(t){this.set("visible",t&&t.visible),this.get("visible")?this.$el.css({opacity:1,display:"block"}):this.$el.css({opacity:0,display:"none"}),this.$body=s("body"),this.listenTo(this,"change:visible",this._toggleVisible)},show:function(){return this.attributes.visible=!0,this._show()},hide:function(){return this.attributes.visible=!1,this._hide()},setContentSubView:function(t){return this.subViews.content&&(this.stopListening(this.subViews.content),this.subViews.content.remove()),this.subViews.content=t,this.listenTo(t,"prepared",this._onSubViewPrepare),this.listenTo(t,"torndown",this._onSubViewTeardown),this.isRendered()&&this.attachSubView("content"),this},_onSubViewPrepare:function(t){this.show()},_onSubViewTeardown:function(t){this.hide()},_show:function(){this._disableBodyScroll(),this.$el.css("display","block");var t=n(this.$el,{opacity:1},{duration:a(100),display:"block"});return t},_hide:function(){this._enableBodyScroll();var t=n(this.$el,{opacity:0},{duration:a(100),display:"none"});return t},_toggleVisible:function(t,e){e?(this.$el.addClass(this.className+"_visible visible"),this._show()):(this.$el.removeClass(this.className+"_visible visible"),this._hide())},_disableBodyScroll:function(){this.$body.css("overflow","hidden")},_enableBodyScroll:function(){this.$body.css("overflow","")},render:function(){return this.$el.html(this.template(this.attributes)),this.attachSubViews(),this}});e.exports=u},{"../templates/modal.tpl":221,"../utils/transition_speed":225,jquery:"HlZQrA","prima/mixins/accessor":542,"prima/mixins/selectorcache":553,"prima/mixins/subviewable":554,"prima/view":580,"velocity-animate":"lWl/mc"}],231:[function(t,e,i){"use strict";var s=t("lodash"),n=t("when"),o=t("velocity-animate").animate,a=t("./container_content"),r=t("prima/mixins/selectorcache"),l=t("prima/mixins/accessor"),h=t("prima/events"),c=t("../utils/post_form_container_type"),u=a.extend({mixins:[r,l],events:{"click [data-js-text]":"_onClickNewPost","click [data-js-photo]":"_onClickNewPost","click [data-js-quote]":"_onClickNewPost","click [data-js-link]":"_onClickNewPost","click [data-js-chat]":"_onClickNewPost","click [data-js-audio]":"_onClickNewPost","click [data-js-video]":"_onClickNewPost"},setPostType:function(t){this.postType=t},animateShow:function(t,e){return t||(t=0),e||(e=0),this.$el.css({display:"block",opacity:1}),function(i){var s=this.js$(i),a=s.children("i"),r=s.children(".new_post_label_text"),l=this.$(".new_post_label").not(s),h=l.children("i"),c=l.children(".new_post_label_text"),u=[o(h,{scale:1,translateY:[0,10],opacity:1},{duration:t,delay:e}),o(c,{translateY:[0,10],opacity:1},{duration:t,delay:e})];return s.length&&a.length&&u.push(o(a,{scale:[1,1.5],translateY:[0,0],opacity:1},{duration:t,delay:e}),o(r,{translateY:[0,0],opacity:1},{duration:t,delay:e})),n.all(u)}.call(this,this.postType)},animateHide:function(t,e){t||(t=0),e||(e=0),function(i){var s=this.js$(i),a=s.children("i"),r=s.children(".new_post_label_text"),l=this.$(".new_post_label").not(s),h=l.children("i"),c=l.children(".new_post_label_text"),u=[o(h,{scale:[1,1],translateY:[10,0],opacity:0},{duration:t,delay:e}),o(c,{translateY:[10,0],opacity:0},{duration:t,delay:e})];return s.length&&a.length&&u.push(o(a,{scale:[1.5,1],translateY:[0,0],opacity:0},{duration:t,delay:.5*t+e}),o(r,{translateY:[0,0],opacity:0},{duration:t,delay:e})),n.all(u)}.call(this,this.postType).then(s.bind(function(){this.$el.css({display:"none",opacity:0})},this))},_onClickNewPost:function(t){if(t.stopPropagation(),t.preventDefault(),this.get("enabled")){var e=t.currentTarget.getAttribute("data-post-endpoint")||t.currentTarget.getAttribute("data-post-type");h.trigger("postForms:open",{postType:e,postFormType:c.inline})}}});e.exports=u},{"../utils/post_form_container_type":222,"./container_content":227,lodash:"MicNly","prima/events":512,"prima/mixins/accessor":542,"prima/mixins/selectorcache":553,"velocity-animate":"lWl/mc",when:"RG2dij"}],232:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/collection"),o=t("../models/photo"),a=n.extend({model:o,add:function(t,e){return t&&!s.isArray(t)&&(t=[t]),s.forEach(t,function(t,e){t.id||(s.isFunction(t.set)?t.set("id",this.generateId(e)):t.id=this.generateId(e))},this),n.prototype.add.apply(this,arguments)},generateId:function(t){var e=1+(t||0),i=s.map(s.range(this.length+1),function(t){return"o"+(e+t)});return s.find(i,function(t){return!this.get(t)},this)},setIdOrder:function(t,e){e||(e={}),this.models=s.map(t,function(t){return this.get(t)},this),e.silent||this.trigger("sort",this,e)}});e.exports=a},{"../models/photo":240,lodash:"MicNly","prima/collection":510}],233:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/lib/translate"),o=t("when"),a=t("prima/mixins/promisifyevents"),r=t("prima/events"),l=t("prima/utils/sequence-with-context"),h=t("prima/component"),c=(t("prima/lib/logger"),t("app/lib/avatar-size")),u=t("./models/post"),d=t("app/lib/currentuser"),p=t("app/components/upload/collections/uploads"),m=t("./views/post_form"),g=t("./utils/drag_eventor"),f=new g("body"),_=t("app/components/dialog"),v=h.extend({name:"PostForm",viewOptionKeys:["showPhotoBooth","supportImageSearch","minFullWidthSize","isModal","popoverContainer","dragEvents","redirectTo","reblogActionContext","closeLabel","disableNavigation","disablePhotoFromUrl"],initialize:function(t){t=s.extend({dragEvents:f,autoFetch:!0},t),this.user=t.user||d(),this.post=t.post||new u,this.uploads=new p,this._preloadAvatars(),this.postForm=new m(s.extend(s.pick(t,this.viewOptionKeys),{user:this.user,post:this.post,uploads:this.uploads,model:this.post})),this.fastCompose=!!t.fastCompose,t.autoFetch&&(this.postFetch=this.fetchPostData(this.post))},_preloadAvatars:function(t){t||(t=this.user.channels.pluck("avatar_url")),s.forEach(t,function(t){var e=new Image;e.src=c(t)(128)})},fetchPostData:function(t){if(this.postFetch)return this.postFetch;t||(t=this.post);var e=this.user;return o.promise(function(i,s){t.has("lookupData")?t.fetch(t.get("lookupData")).then(function(){t.unset("lookupData"),e&&"html"===e.get("defaultEditorType")&&"edit"===t.get("mode")&&"rich"===t.get("editorType")&&t.set("editorType","html"),i(t)},function(t){403===t.status?s("blocked"):s()}):i(t)})},addEventListeners:function(){this.listenTo(r,"DOMEventor:keydown:escape",function(){this.isEnabled()&&r.trigger("postForms:close")}),this.listenTo(this.postForm,"all",function(){this.trigger.apply(this,arguments)}),this.listenToOnce(this.postForm,"postForms:changePostType",this.reloadPostForm)},_logInteraction:function(t){var e={action:t,tumblelog:this.post.get("tumblelog"),mode:this.post.get("mode"),postType:this.post.get("type"),editorType:this.post.get("editorType")};r.trigger("postform-interaction:"+t,{loggingData:e})},enable:function(){this.postForm.set("enabled",!0)},disable:function(){this.postForm.set("enabled",!1)},isEnabled:function(){return this.postForm.get("enabled")||!1},getRect:function(){return this.postForm.getRect()},isRendered:function(){return this.postForm.isRendered()},whenRendered:function(t){return null==t&&(t=!this.isRendered()),o.promise(s.bind(function(e,i){t?(this.listenToOnce(this,"ready",function(){e(this)}),this.listenToOnce(this,"reject",function(){i()}),this.render()):e(this)},this))},_render:function(){this._logInteraction("open-postform");var t=this.whenEvent(this.postForm,"media:ready");return this.postForm.render(),this.initialPostState=this.postForm.post.toJSON(),this.postForm.set("initialPostState",this.initialPostState),this.addEventListeners(),this.postForm.get("useMediaReady")?t.then(s.bind(function(){this.trigger("ready")},this)):this.trigger("ready"),delete this.postFetch,this},_reject:function(t){"blocked"===t&&_.alert(n("This post cannot be reblogged.")),this.trigger("reject")},render:function(){return this.fetchPostData(this.post).then(s.bind(this._render,this),s.bind(this._reject,this))},teardown:function(){return this.stopListening(),this},remove:function(){this.stopListening(),this.postForm.remove()},reloadPostForm:function(t){t=t||{};var e=l([function(){return this.postForm.animateHide(200)},function(){this.postForm.teardown();var e={lookupData:this.post.getLookupData(),tumblelog:this.post.get("tumblelog"),mode:this.post.get("mode"),loggingData:this.post.loggingData};s.extend(e,t.postParams||{}),this.post=this.postForm.post=this.postForm.model=new u(e),this.render()},function(){s.isFunction(t.afterReload)&&t.afterReload.call(this,this.postForm)}],this);return e}});a.applyTo(v.prototype),e.exports=v},{"./models/post":242,"./utils/drag_eventor":308,"./views/post_form":338,"app/components/dialog":44,"app/components/upload/collections/uploads":388,"app/lib/avatar-size":429,"app/lib/currentuser":432,lodash:"MicNly","prima/component":511,"prima/events":512,"prima/lib/logger":519,"prima/lib/translate":541,"prima/mixins/promisifyevents":551,"prima/utils/sequence-with-context":577,when:"RG2dij"}],234:[function(t,e,i){"use strict";function s(){}var n=t("lodash"),o=t("prima/lib/translate"),a=t("../utils/string_helpers").truncateLongStrings;s.prototype.genericFieldMap={two:"caption",three:"url"},s.prototype.editorField="two",s.prototype.allowsTypeSwitch=function(){return"new"===this.get("mode")},s.prototype.typeAttributes={service:!1,preuploadUrl:"",trackTitle:"",trackArtist:"",trackAlbum:"",preuploadAlbumArt:!1,albumArt:"",caption:"",confirmTos:!1},s.prototype.allowAnswerFields=["caption"],s.prototype.generateTweetText=function(t,e){var i=this.getHtmlStripped("caption");return i=i.replace(/[\r\n\s]*\[\[MORE\]\].*$/gi,""),a(i,e)},s.prototype.resetPreserveFields=["caption","tags"],s.prototype.resetAttributes=["service","url","preuploadUrl","trackTitle","trackArtist","trackAlbum","confirmTos","preuploadAlbumArt","albumArt","copyrightFallback"],s.prototype.parseForType=function(t,e,i){i.service&&"direct"!==i.service||(e.url=i.audio_url),delete e.audio_url,e.albumArt=i.audio_artwork,delete e.audio_artwork;var s=i.id3_tags||{};return delete e.id3_tags,e.trackTitle=s.Title||"",e.trackArtist=s.Artist||"",e.trackAlbum=s.Album||"",e},s.prototype.serializeForServer=function(t){var e=t.apply(this,n.rest(arguments)),i={"id3_tags[title]":this.get("trackTitle")||null,"id3_tags[artist]":this.get("trackArtist")||null,"id3_tags[album]":this.get("trackAlbum")||null,preuploaded_url:this.get("preuploadUrl"),confirm_tos:this.get("confirmTos"),artwork_pre_upload:this.get("preuploadAlbumArt"),album_art:this.get("albumArt"),remove_album_art:"edit"===this.get("mode")&&n.isEmpty(this.get("albumArt")),copyright_fallback:this.get("copyrightFallback")};return n.extend(e,n.pick(i,function(t){return!n.isUndefined(t)})),n.isEmpty(e.preuploaded_url)||(e["post[three]"]=null),e},s.prototype.validate=function(t,e,i){var s=[];return n.isEmpty(e.url)?s.push(o("Please choose an audio source before continuing.")):e.preuploadUrl?e.confirmTos||s.push(o("You must agree that you have permission to share this file.")):n.isEmpty(e.url)&&s.push(o("Please choose an audio source before continuing.")),t.call(this,e,{errors:s})},e.exports=s},{"../utils/string_helpers":312,lodash:"MicNly","prima/lib/translate":541}],235:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/model"),o=t("prima/mixins/withformkeytrue"),a=n.extend({url:"/svc/post/get_preview_key",defaults:{name:"",key:""},parse:function(t,e){var i=s.get(t,"response.blog_preview_key");return{key:i}}},{fetchForBlog:function(t){var e=new a({name:t});return e.fetch({async:!1,type:"POST",data:{name:e.get("name")}}),e.get("key")}});o.applyTo(a.prototype),e.exports=a},{lodash:"MicNly","prima/mixins/withformkeytrue":556,"prima/model":557}],236:[function(t,e,i){"use strict";function s(){}var n=t("lodash"),o=t("sprintf-js").sprintf,a=t("../utils/string_helpers").truncateLongStrings;s.prototype.genericFieldMap={one:"title",two:"chat"},s.prototype.typeAttributes={title:"",chat:""},s.prototype.generateTweetText=function(t,e){var i,s=this.getHtmlStripped("title"),n=this.getHtmlStripped("chat");return i=s&&n?o("%s - %s",s,n):s||n||"",a(i,e)},s.prototype.validate=function(t,e,i){var s=[];return(!e.chat||e.chat.length<1)&&s.push("No chat."),t.call(this,e,{errors:s})},s.prototype.serializeForServer=function(t){var e=this,i=t.apply(this,n.rest(arguments));return i["post[two]"]=e.get("chat").replace(/\u00A0/gm," "),i},e.exports=s},{"../utils/string_helpers":312,lodash:"MicNly","sprintf-js":"qPOUxN"}],237:[function(t,e,i){"use strict";function s(){}var n=t("lodash"),o=t("sprintf-js").sprintf,a=t("prima/utils/url"),r=t("../utils/string_helpers").truncateLongStrings,l=t("../utils/validation");s.prototype.genericFieldMap={one:"title",two:"url",three:"caption",thumbnail:"thumbnail",excerpt:"excerpt",author:"author"},s.prototype.typeAttributes={title:"",url:"",caption:"",excerpt:"",author:""},s.prototype.allowAnswerFields=["caption"],s.prototype.generateTweetText=function(t,e){var i=this.getHtmlStripped("title"),s=this.getHtmlStripped("url"),n=this.getHtmlStripped("caption");n=n.replace(/[\r\n\s]*\[\[MORE\]\].*$/gi,"");var l;return l=i&&n?o("%s - %s",i,n):i||n||a.parseUrl(s).host||"",r(l,e)},s.prototype.editorField="three",s.prototype.typeAttributes={title:"",url:"",excerpt:"",author:""},s.prototype.resetPreserveFields=["caption","tags"],s.prototype.resetAttributes=["title","url","thumbnail","excerpt","author"],s.prototype.softReset=function(t){t.apply(this,n.rest(arguments)),n.isEmpty(this.get("thumbnail"))||"new"===this.get("mode")||this.set("remove_thumbnail",1)},s.prototype.serializeForServer=function(t){var e=t.apply(this,n.rest(arguments));return this.get("remove_thumbnail")&&(e.remove_thumbnail=this.get("remove_thumbnail")),n.extend(e,{author:this.getAttributeFromGeneric("author"),excerpt:this.getAttributeFromGeneric("excerpt")}),e},s.prototype.validate=function(t,e,i){var s=[];return e.loading&&s.push("Loading OpenGraph data."),(!e.url||e.url.length<1)&&s.push("No url."),l.isUrl(e.url)||s.push("Not a valid URL"),t.call(this,e,{errors:s})},e.exports=s},{"../utils/string_helpers":312,"../utils/validation":313,lodash:"MicNly","prima/utils/url":579,"sprintf-js":"qPOUxN"}],238:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/model"),o=n.extend({defaults:{fetchOptions:{url:"/svc/mention",with_form_key:!0},suggestCache:{},queryHistory:[],maxCacheSize:20,maxSuggests:5,blogSuggestions:{}},fetch:function(t){"query"in t&&"success"in t&&s.isFunction(t.success)||console.error("Mention must be provided a query and a success callback.");
var e=t.query;if(s.extend(t,this.get("fetchOptions")),e in this.get("suggestCache")){var i=this.get("suggestCache")[e];return this.set("blogSuggestions",i),t.success.call(this,this,i,t)}return t.data={q:e},n.prototype.fetch.call(this,t)},parse:function(t,e){var i=this._processQueryResults(t,e);return this._cacheQueryResults(i,e),i},_processQueryResults:function(t,e){var i=e.query;return s.extend(t,{queryRegex:this._escapeRegex(i)})},_cacheQueryResults:function(t,e){var i=s.clone(this.get("suggestCache")),n=s.clone(this.get("queryHistory"));i[e.query]=t,n.push(e.query),s.size(i)>this.get("maxCacheSize")&&(delete i[n[0]],n.shift()),this.set("suggestCache",i),this.set("queryHistory",n)},_escapeRegex:function(t){return t.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|\~\`\!\@\#]/g,"\\$&")}});e.exports=o},{lodash:"MicNly","prima/model":557}],239:[function(t,e,i){"use strict";function s(){}var n=t("lodash"),o=t("../utils/string_helpers").truncateLongStrings;s.prototype.genericFieldMap={one:"ask",two:"answer",three:"caption"},s.prototype.editorField="three",s.prototype.typeAttributes={ask:"",answer:"",caption:""},s.prototype.generateTweetText=function(t,e){return o(this.getHtmlStripped("ask"),e)},s.prototype.parseForType=function(t,e,i){return e.ask=n.escape(e.ask),e},s.prototype.validate=function(t,e,i){var s=[];return e.ask||s.push("Post question empty."),t.call(this,e,{errors:s})},e.exports=s},{"../utils/string_helpers":312,lodash:"MicNly"}],240:[function(t,e,i){"use strict";var s=t("lodash"),n=t("jquery"),o=t("prima/model"),a=t("prima/utils/image/loader"),r=t("prima/utils/image/filereader"),l=t("prima/utils/image/canvas"),h=1080,c=o.extend({defaults:{url:"",preuploadUrl:"",externalUrl:"",file:null,photoRaw:null,base64:null,isSelfie:!1,isSelfieGif:!1,width:null,height:null,caption:"",id:""},initialize:function(){this.on("change:externalUrl",function(t,e){e&&this.readUrl(e),this.set({preuploadUrl:null,base64:null})},this),this.get("externalUrl")&&!this.get("base64")&&this.trigger("change:file",this,this.get("file")),this.on("change:file",function(t,e){e&&this.readFile(e),this.set({externalUrl:null,base64:null})},this),this.get("file")&&!this.get("base64")&&this.trigger("change:file",this,this.get("file"))},readUrl:function(t,e){e||(e="photo:readUrl"),a.load(t).then(s.bind(function(t){this.set({url:t.src,width:t.width,height:t.height}),this.trigger(e,!0,this)},this),s.bind(function(i){this.set({url:t,width:null,height:null}),this.trigger(e,!1,this)},this))},readFile:function(t){return r.canReadFiles()?void r.read(t).then(s.bind(function(t){if(!t.file.type.match(/image\/(jpg|jpeg|png)/i))return this.readUrl(t.objectUrl||t.base64,"photo:readFile");var e=n("<img/>");e.attr("src",t.objectUrl||t.base64),a.load(t.objectUrl||t.base64).then(s.bind(function(i){var s=l.drawScaledAndRotated(e,i.width,i.height,t.rotation,t.mirrored,h);return this.readUrl(s.toDataURL(t.file.type),"photo:readFile")},this))},this),s.bind(function(){this.trigger("photo:readFile",!1,this)},this)):void this.trigger("photo:readFile",!1,this)},getDisplayUrl:function(){return this.get("preuploadUrl")?this.get("preuploadUrl"):this.get("externalUrl")?this.get("externalUrl"):this.get("base64")?this.get("base64"):this.get("url")},getUploadUrl:function(){return this.get("preuploadUrl")?this.get("preuploadUrl"):this.get("externalUrl")?this.get("externalUrl"):""},toJSON:function(){var t=o.prototype.toJSON.apply(this,arguments);return t.displayUrl=this.getDisplayUrl(),t.uploadUrl=this.getUploadUrl(),t}});e.exports=c},{jquery:"HlZQrA",lodash:"MicNly","prima/model":557,"prima/utils/image/canvas":571,"prima/utils/image/filereader":572,"prima/utils/image/loader":573}],241:[function(t,e,i){"use strict";function s(){}var n=t("lodash"),o=t("../collections/photos"),a=t("../utils/string_helpers").truncateLongStrings;s.prototype.genericFieldMap={two:"caption",three:"linkthrough"},s.prototype.editorField="two",s.prototype.typeAttributes={caption:"",layout:"",linkthrough:"",photos:[]},s.prototype.allowAnswerFields=["caption"],s.prototype.generateTweetText=function(t,e){var i=this.getHtmlStripped("caption");return i=i.replace(/[\r\n\s]*\[\[MORE\]\].*$/gi,""),a(i,e)},s.prototype.MAX_IMAGES=10,s.prototype.resetPreserveFields=["caption","tags"],s.prototype.afterDelegate=function(t){t.apply(this,n.rest(arguments)),this.photos=new o(this.attributes.photos,{parse:!0}),this.on("change:photos",function(t,e){this.photos.reset(e,{parse:!0}),delete this.attributes.photos},this),this.trigger("change:photos",this,this.get("photos")),this.listenTo(this.photos,"add remove change:preuploadUrl change:externalUrl",function(){this.trigger("validate")})},s.prototype.parseForType=function(t,e,i){return e.layout=i.photoset_layout,delete e.photoset_layout,e},s.prototype.serializeForServer=function(t){var e=this,i=t.apply(this,n.rest(arguments));return n.forEach(this.photos.toJSON(),function(t){i["images["+t.id+"]"]=t.uploadUrl,i["caption["+t.id+"]"]=(t.caption||"").substr(0,200),t.photoRaw&&(i.photo_raw=t.photoRaw,i.is_selfie_gif=t.isSelfieGif,i.is_selfie=t.isSelfie)}),i["post[photoset_layout]"]=e.get("layout"),i["post[photoset_order]"]=this.photos.pluck("id").join(","),i},s.prototype.canAddPhotos=function(t){return this.photos.length<this.MAX_IMAGES},s.prototype.validate=function(t,e,i){var s=[];0===this.photos.length&&s.push("No photos specified.");var n=this.photos.all(function(t){return t.getUploadUrl()||!t.has("upload")});return n||s.push("Uploads in progress."),t.call(this,e,{errors:s})},e.exports=s},{"../collections/photos":232,"../utils/string_helpers":312,lodash:"MicNly"}],242:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/model"),o=t("prima/utils/exposer"),a=t("prima/mixins/delegator"),r=t("./text_post"),l=t("./photo_post"),h=t("./quote_post"),c=t("./link_post"),u=t("./chat_post"),d=t("./audio_post"),p=t("./video_post"),m=t("./note_post"),g=t("../utils/bool_tool"),f=t("../utils/string_helpers"),_=t("prima/utils/url"),v=t("../utils/validation"),b=n.extend({mixins:[a],typeDelegateMap:{text:r,photo:l,quote:h,link:c,chat:u,audio:d,video:p,note:m},_VALID_STATES:{published:"0",draft:"1",queued:"2",scheduled:"on.2","private":"private",unapproved:"0 3",transcoding:"4"},_FORMAT_CODE_TO_EDITOR_TYPE:{0:"rich",1:"html",2:"markdown"},_STATE_CODE_TO_TEXT:{0:"published","0 3":"published",1:"draft",2:"queued",3:"unapproved",4:"transcoding","on.2":"scheduled","private":"private"},defaults:{allow_photo_replies:Boolean(),postDate:String(),customUrl:String(),sourceUrl:String(),state:"published",editorType:"rich",tags:[],publish_on:String(),tumblelog:String(),uploading:!1,mode:"new",contentStats:{},loading:!1,hasLoadingInlineImages:!1},shortUrlLength:29,typeAttributes:{},editorField:!1,resetPreserveFields:[],resetAttributes:[],allowAnswerFields:[],_syntheticAttributes:{pseudoState:function(){var t=this.get("state"),e=this.get("publish_on");return"published"===t&&1===parseInt(this.get("is_private"),10)&&(t="private"),"queued"===t?s.isEmpty(e)?"queued":"scheduled":t},formattedSourceUrl:function(){var t,e=this.get("sourceUrl");return s.isEmpty(e)?"":(t=_.addProtocolIfMissing(e,"http:"),v.isUrl(t)?t:e)}},initialize:function(t,e){s.has(t,"tags")||this.set("tags",[]),this._assignPostTypeFunctionality()},_assignPostTypeFunctionality:function(){var t=this.get("type"),e=s.bind(function(t){return t in this.typeDelegateMap?this.typeDelegateMap[t].prototype:!1},this);t?(this.delegateObject(e(t)),this.afterDelegate()):this.listenToOnce(this,"change:type",function(t,i){this.delegateObject(e(i)),this.afterDelegate()})},afterDelegate:function(){s.defaults(this.attributes,this.typeAttributes)},_normalizeType:function(t,e){var i={regular:"text",conversation:"chat"};return e===!1&&(i=s.invert(i)),t in i?i[t]:t},get:function(t){return(this._syntheticAttributes[t]||n.prototype.get).apply(this,arguments)},getHtmlStripped:function(t,e,i){return"undefined"!=typeof e||(e=!0),"undefined"!=typeof i||(i=" "),s.trim(f.stripHtml(this.get(t)||"",e,i))},fetch:function(t){var e={data:t};return n.prototype.fetch.call(this,e)},parse:function(t,e){if(e.parse===!1)return this.attributes;var i=t.post,n=e.data,o={},a=i.id?"edit":"reblog";o.type=this._normalizeType(i.type,!0),o.can_reblog_as=s.map(i.can_reblog_as,s.bind(function(t){return this._normalizeType(t,!0)},this)),this.set("type",o.type),s.forEach(this.genericFieldMap,function(t,e){o[t]=i[e]});var r=["one","two","three","state","publish_on","tags","type","can_reblog_as"];return s.extend(o,s.omit(i,r),{createdPost:!!t.created_post,postTumblelog:t.post_tumblelog||{},postContextPage:t.post_context_page}),"edit"===a?(o["post-id"]=i.id,o.tags=i.tags?i.tags.split(","):[],o.tumblelog=o.postTumblelog.name_or_id||!1):"reblog"===a&&s.extend(o,s.pick(n,["reblog_id","reblog_key"])),"state"in i&&(o.state=this._extractState(i)),i.from_app&&1===s.parseInt(i.format)||(o.editorType=this._FORMAT_CODE_TO_EDITOR_TYPE[s.parseInt(i.format||0)]),o.editorType||(o.editorType=this.get("editorType")||this._FORMAT_CODE_TO_EDITOR_TYPE[0]),s.has(i,"custom_tweet")&&(o.customTweet=i.custom_tweet),s.extend(o,{sourceUrl:o.source_url||"",htmlEdited:"rich"!==o.format&&!(this.editorField&&!i[this.editorField]),postDate:o.date||"",customUrl:o.slug||""},s.mapValues(s.pick(o,["allow_answers","allow_photo_replies","html_mode"]),g)),"edit"!==a||"queued"!==o.state||s.isEmpty(i.publish_on)||(o.state="scheduled",o.publish_on=i.publish_on),this.parseForType(o,i)},parseForType:function(t,e){return t},sync:function(t,e,i){var o={create:"/svc/post/update",read:"/svc/post/fetch",update:"/svc/post/update"};return s.defaults(i||(i={}),{emulateHTTP:!0,forServer:!0,url:o[t]}),i.parse="read"===t,n.prototype.sync.call(this,t,e,i)},toJSON:function(t){return t=s.defaults(t||{},{forServer:!1}),t.forServer?this.serializeForServer(t):n.prototype.toJSON.call(this,t)},serializeForServer:function(){var t=this,e=t.attributes,i={channel_id:e.tumblelog,post_id:e["post-id"],"post[date]":e.postDate,"post[one]":this.getAttributeFromGeneric("one"),"post[publish_on]":e.publish_on,"post[slug]":e.customUrl,"post[tags]":e.tags.join(),"post[two]":this.getAttributeFromGeneric("two"),"post[three]":this.getAttributeFromGeneric("three"),thumbnail:this.getAttributeFromGeneric("thumbnail"),editor_type:e.editorType,send_to_twitter:e.send_to_twitter,custom_tweet:e.customTweet,send_to_fbog:e.send_to_fbog,loggingData:e.loggingData,allow_photo_replies:e.allow_photo_replies,content_stats:e.contentStats};"edit"===e.mode&&(i.edit_post_id=e["post-id"]),i["post[source_url]"]=t.get("formattedSourceUrl"),i["post[state]"]=t._VALID_STATES[e.state],i["post[type]"]=this._normalizeType(e.type,!1);var n={reblog:e.is_reblog,reblog_key:e.reblog_key,reblog_post_id:e.reblog_id,pt:e.pt,remove_reblog_tree:e.remove_reblog_tree,reblog_source:e.reblogSource};s.extend(i,s.pick(n,function(t){return!s.isUndefined(t)})),e.allow_answers&&(i.allow_answers="on"),this.getAttributeFromGeneric("thumbnail")&&(i.thumbnail_pre_upload="1");var o=this.getContextPage();return s.extend(i,{context_id:e.tumblelog,context_page:o,"is_rich_text[one]":"0","is_rich_text[two]":"0","is_rich_text[three]":"0"}),this.editorField&&(i["is_rich_text["+this.editorField+"]"]="1"),e.reblogActionContext&&(i.reblog_source=e.reblogActionContext),e.shareData&&s.isObject(e.shareData)&&(e.shareData.canonicalUrl=i["post[source_url]"],i.share_data=e.shareData),i},validate:function(t,e){var i="errors"in e?e.errors:[];return t.state&&(s.has(this._VALID_STATES,t.state)||i.push('Invalid "state" value')),t.hasLoadingInlineImages&&i.push("There are still pending images."),s.each(this.defaults,function(e,s){typeof e!=typeof t[s]&&i.push('Invalid "'+s+'" type. Expected '+typeof e+", got "+typeof t[s]+".")}),i.length?i:void 0},_extractState:function(t){var e=this._STATE_CODE_TO_TEXT[t.state];return 1===parseInt(t.is_private,10)&&(e="private"),e},findBlogChannelByName:function(t){return this.attributes.tumblelog&&this.attributes.tumblelog.collection&&"findWhere"in this.attributes.tumblelog.collection?this.attributes.tumblelog.collection.findWhere({name_or_id:t}):void 0},getPreservedData:function(){return this.resetPreserveFields.some(s.bind(function(t){return this.get(t)&&this.get(t).length>0},this))},softReset:function(){s.forEach(this.resetAttributes,function(t){s.has(this.typeAttributes,t)?this.set(t,this.typeAttributes[t]):s.has(this.defaults,t)?this.set(t,this.defaults[t]):this.unset(t)},this)},getLookupData:function(){return"reblog"===this.get("mode")?{reblog_id:this.get("reblog_id"),reblog_key:this.get("reblog_key"),post_type:this.get("type")}:void 0},getContextPage:function(){var t=this.attributes,e="dashboard";return t.contextData&&"baseRoute"in t.contextData&&(e=t.contextData.baseRoute.split("/").pop()),e},getAttributeFromGeneric:function(t){return this.get(this.genericFieldMap[t])},getTweetText:function(){var t=this.get("customTweet");return s.isString(t)||(t=this.generateTweetText(140-this.shortUrlLength-1),t?t+=" [URL]":t="[URL]"),t},getTweetTextLength:function(t){s.isString(t)||(t=this.getTweetText()),t=s.trim(t).replace(/([^\s])\[URL\]/gi,"$1 [URL]").replace(/\[URL\]([^\s])/gi,"[URL] $1");var e=t.length;return e+=(this.shortUrlLength-5)*(t.match(/\[URL\]/gi)||"").length},generateTweetText:function(t){return""},canEditMedia:function(){return!this.get("is_reblog")},isReblog:function(){return!!this.get("is_reblog")},allowsTypeSwitch:function(t){return!1},canPreview:function(){return this.isValid()},deepHasChanged:function(t){var e=this.toJSON(),i=this.get("mode"),n=s.keys(t),o=s.keys(e);if(s.isEqual(t,e))return!1;if("new"!==i)return!0;var a=s.difference(o,n),r=s.reduce(a,function(t,i){var n=e[i],o=s.isUndefined(n)||s.isNull(n)?0:n.length;return t+o},0);return r>0?!0:(t=s.omit(t,a),e=s.omit(e,a),!s.isEqual(t,e))}});o({"Tumblr.Prima.PostForms.Post":b}),e.exports=b},{"../utils/bool_tool":306,"../utils/string_helpers":312,"../utils/validation":313,"./audio_post":234,"./chat_post":236,"./link_post":237,"./note_post":239,"./photo_post":241,"./quote_post":243,"./text_post":245,"./video_post":246,lodash:"MicNly","prima/mixins/delegator":545,"prima/model":557,"prima/utils/exposer":569,"prima/utils/url":579}],243:[function(t,e,i){"use strict";function s(){}var n=t("sprintf-js").sprintf,o=t("../utils/string_helpers").truncateLongStrings;s.prototype.genericFieldMap={one:"quote",two:"source"},s.prototype.typeAttributes={quote:"",source:""},s.prototype.generateTweetText=function(t,e){var i=this.getHtmlStripped("quote"),s=this.getHtmlStripped("source");s=s.replace(/[\r\n\s]*\[\[MORE\]\].*$/gi,"");var a;return a=s&&i.length+(s.length>1?7:6)<=e?a=n("“%s” - %s",i,s):i?n("“%s”",o(i,e-2)):s,o(a,e)},s.prototype.editorField="two",s.prototype.validate=function(t,e,i){var s=[];return(!e.quote||e.quote.length<1)&&s.push("No quote."),t.call(this,e,{errors:s})},e.exports=s},{"../utils/string_helpers":312,"sprintf-js":"qPOUxN"}],244:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/model"),o=n.extend({defaults:{fetchOptions:{url:"/svc/tag_suggest",with_form_key:!0},suggestCache:{},queryHistory:[],maxCacheSize:20,maxSuggests:5,tagSuggestions:{}},initialize:function(t){if(!1==("user"in t&&"post"in t))throw new Error("Tag Suggestions must be provided user and post models.")},fetch:function(t){return"query"in t&&"success"in t&&s.isFunction(t.success)||console.error("TagSuggestion must be provided a query and a success callback."),s.extend(t,this.get("fetchOptions")),t.query in this.get("suggestCache")?(this.set("tagSuggestions",this.get("suggestCache")[t.query]),t.success.call(this,this,"suggestCache",t)):(t.data={q:t.query},n.prototype.fetch.call(this,t))},parse:function(t,e){var i=this.get("user"),s=this.get("post").get("tumblelog"),n={suggestions:"tags"in t?t.tags:[],userTags:s?i.getChannelProperty(s,"tags"):[]};return n.userTags||(n.userTags=[]),n=this._processQueryResults(n,e),this._cacheQueryResults(n,e),{tagSuggestions:n}},_processQueryResults:function(t,e){var i=new RegExp(this._escapeRegex(e.query),"i");return t.suggestions=s.compact(s.map(t.suggestions,function(t){return t.tag})).slice(0,this.get("maxSuggests")),t.userTags=s.compact(s.filter(t.userTags,function(t){return i.test(t)})).slice(0,this.get("maxSuggests")),t},_cacheQueryResults:function(t,e){var i=s.clone(this.get("suggestCache")),n=s.clone(this.get("queryHistory"));i[e.query]=t,n.push(e.query),s.size(i)>this.get("maxCacheSize")&&(delete i[n[0]],n.shift()),this.set("suggestCache",i),this.set("queryHistory",n)},_escapeRegex:function(t){return t.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&")}});e.exports=o},{lodash:"MicNly","prima/model":557}],245:[function(t,e,i){"use strict";function s(){}var n=t("lodash"),o=t("sprintf-js").sprintf,a=t("../utils/string_helpers").truncateLongStrings;s.prototype.genericFieldMap={one:"title",two:"body"},s.prototype.editorField="two",s.prototype.typeAttributes={title:"",body:""},s.prototype.allowAnswerFields=["title","body"],s.prototype.generateTweetText=function(t,e){var i=this.getHtmlStripped("title"),s=this.getHtmlStripped("body");s=s.replace(/[\r\n\s]*\[\[MORE\]\].*$/gi,"");var n;return n=i&&s?o("%s - %s",i,s):i||s||"",a(n,e)},s.prototype.validate=function(t,e,i){var s=[],o=!n.isUndefined(e.reblog_tree)&&e.reblog_tree!==!1&&""!==e.reblog_tree;return(!e.body||e.body.length<1)&&(!e.title||e.title.length<1)&&(o||s.push("Post body empty.")),t.call(this,e,{errors:s})},e.exports=s},{"../utils/string_helpers":312,lodash:"MicNly","sprintf-js":"qPOUxN"}],246:[function(t,e,i){"use strict";function s(){}var n=t("lodash"),o=t("prima/lib/translate"),a=t("../utils/remap_keys"),r=t("prima/utils/camelize-keys"),l=t("../utils/string_helpers").truncateLongStrings;s.prototype.genericFieldMap={one:"embedCode",two:"caption"},s.prototype.allowAnswerFields=["caption"],s.prototype.editorField="two",s.prototype.resetPreserveFields=["caption","tags"],s.prototype.resetAttributes=["preuploadUrl","preuploadKey","embedCode","confirmTos","copyrightFallback"],s.prototype.typeAttributes={caption:"",confirmTos:!1},s.prototype.generateTweetText=function(t,e){var i=this.getHtmlStripped("caption");return i=i.replace(/[\r\n\s]*\[\[MORE\]\].*$/gi,""),l(i,e)},s.prototype.validate=function(t,e,i){var s=[];return e.embedCode?0===e.embedCode.length&&s.push("No embed specified."):e.preuploadUrl?e.confirmTos||s.push(o("You must agree that you have permission to share this file.")):e.video?0===e.video.embed_code.length&&s.push("Direct embed missing."):s.push("No video specified."),t.call(this,e,{errors:s})},s.prototype.canPreview=function(){return!this.get("preuploadKey")&&this.isValid()},s.prototype.serializeForServer=function(t){var e=t.apply(this,n.rest(arguments)),i=n.omit({preuploaded_url:this.get("preuploadUrl"),preuploaded_ch:this.get("preuploadKey"),confirm_tos:this.get("confirmTos"),copyright_fallback:this.get("copyrightFallback")},n.isUndefined);return n.extend(e,i),e=a(e,"snake",["embedCode"])},s.prototype.getEmbedData=function(t){var e=!1;return this.has("video")?(e=r(this.get("video")),e={isNativeVideo:!0,embedRenderContext:"inline",width:e.dimensions.width,height:e.dimensions.height,previewIframe:e.previewIframe,embedCode:e.embedCode}):this.has("video_embed")&&(e=r(this.get("video_embed"))),e},e.exports=s},{"../utils/remap_keys":310,"../utils/string_helpers":312,lodash:"MicNly","prima/lib/translate":541,"prima/utils/camelize-keys":561}],247:[function(t,e,i){"use strict";var s=t("lodash"),n=t("jquery"),o=t("backbone"),a=function(){var t=4,e=["spotify","soundcloud","bandcamp"],i=["spotify","soundcloud"],a={},r=[],l=10,h={normalizeResults:function(t,e,i){var n={service:t};switch(t){case"spotify":return s.extend(n,{tracks:s.map(s.take(e.tracks.items,i),function(t){return{primary:t.name,secondary:s.first(t.artists).name,info:t.album.name,href:t.uri,id:t.uri}})});case"soundcloud":return s.extend(n,{tracks:s.map(s.take(e,i),function(t){return{primary:t.title,secondary:t.user.username,info:null,href:t.permalink_url,id:t.id}})});case"youtube":return s.extend(n,{tracks:s.map(s.take(e.items,i),function(t){return{primary:t.snippet.title,secondary:t.snippet.channelTitle,info:null,href:"https://www.youtube.com/watch?v="+t.id.videoId,id:t.id.videoId}})});default:throw"Invalid service: "+t}},getServiceByUrl:function(t){var e={spotify:/(open\.spotify\.com|spotify)[\/|:](track|album|artist|playlist|user)[\/|:](.*)?([\d\w]{22})$/,soundcloud:/(http|https):\/\/soundcloud\.com\/[^\/]+\/(sets\/)?[^\/]+\/?(\?.*)?$/,bandcamp:/(http|https):\/\/(?:([^\/]+\.)\.bandcamp\.com|[^\/]+\.[^\/]+)\/(track|album)\/[^\/]+$/,direct:/[.](mp3)$/i};for(var i in e)if(e[i].test(t))return i;return!1},getData:function(t,i){if(!s.contains(e,i))return!1;if(t in a){var o=a[t];this._notifyOnDataLookup(t,i,o.data,o.isOK)}else{if("spotify"!==i||!t.match(new RegExp(/[\/:]playlist[\/:]/))){var r=n.ajax({url:"/svc/post/get_"+i+"_data",type:"POST",with_form_key:!0,data:{url:t,service:i}});return r.then(s.bind(function(e){e&&!e.error?this._notifyOnDataLookup(t,i,e,!0):this._notifyOnDataLookup(t,i,e,!1)},this),s.bind(function(e){this._notifyOnDataLookup(t,i,e,!1)},this))}this._notifyOnDataLookup(t,i,{},!0)}},_notifyOnDataLookup:function(t,e,i,s){var n=s?"audioEmbedData:fetched":"audioEmbedData:error";this.trigger(n,t,e,i,s)},_cacheDataLookupResults:function(t,e,i,n){a[t]={data:i,isOK:n},r.push(t),s.size(a)>l&&(delete a[r[0]],r.shift())},search:function(e,i,o){var a=o&&o.maxResults&&s.isNumber(o.maxResults)?o.maxResults:t,r=n.ajax({url:"/search_audio",type:"POST",with_form_key:!0,data:{q:i,audio_search_provider:e}});return r.then(s.bind(function(t){this.trigger("searchResults:fetched",this.normalizeResults(e,t,a))},this),s.bind(function(t){this.trigger("searchResults:fetched",{service:e,tracks:[]})},this))}};return function(){this.dataServices=e,this.searchServices=i,s.extend(this,o.Events,h),this.listenTo(this,"audioEmbedData:fetched",this._cacheDataLookupResults),this.listenTo(this,"audioEmbedData:error",this._cacheDataLookupResults)}}();e.exports=a},{backbone:"5kFNoY",jquery:"HlZQrA",lodash:"MicNly"}],248:[function(t,e,i){"use strict";function s(t){var e=d.parseUrl(t);return e&&e.path?e.path.replace(/^\/([^\/]+)\/.*/i,"$1"):""}var n=t("lodash"),o=t("jquery"),a=t("prima/component"),r=t("../utils/dom_stats"),l=t("./embed_data"),h=t("remarkable"),c=new h({html:!0}),u=t("prima/utils/dom"),d=t("prima/utils/url"),p=a.extend({name:"ContentStatsSupport",initialize:function(t){t=t||{},this.model=t.model,this.editor=t.editor,this.dateInitialized=new Date,this.mentionStats={},this.gifSearchStats={},this.editor&&this.editor.mentionSupport&&this.listenTo(this.editor.mentionSupport,"mention:set",this._onSetMention),this.editor&&this.editor.imageSearchSupport&&(this.listenTo(this.editor.imageSearchSupport,"gifSearch:query",this._onGifSearchQuery),this.listenTo(this.editor.imageSearchSupport,"gifSearch:accept",this._onGifSearchAccept)),this.contentStats=new r({htmlLength:function(t){return t.html().length},textLength:function(t){return t.text().length},textTools:{hr:"hr",h2:"h2",more:function(t){var e;return t&&(e=t.text())?e.match(/\[\[MORE\]\]/gi)||[]:[]},mentions:"a.tumblelog"},embeds:{selector:"figure.tmblr-embed, figure.tmblr-embed-placeholder",attribute:function(t){var e=t.attr("data-provider");return l.isValidEmbedServiceName(e)?e:"unknown"}},images:{selector:"img",attribute:function(t){var e;if(t&&t.attr("src")){if(e=t.attr("src").match(/.+[.](jpg|jpeg|png|gif)([?]|$)/i),e&&e.length>1)return e[1].toLowerCase()}else if(t&&""===t.attr("src"))return"empty";return"unknown"}},mentions:n.bind(this._getPurgedMentionStats,this),gifs:n.bind(this._getConsolidatedGifStats,this),gifSearch:n.bind(this._getGifSearchStats,this)})},_onSetMention:function(t,e){n.has(t,"name")&&n.has(e,"len")&&!n.has(this.mentionStats,t.name)&&(this.mentionStats[t.name]=e.len,this.mentionStats=this._getPurgedMentionStats(this._getWrappedContentDocument()))},_getPurgedMentionStats:function(t){return n.pick(this.mentionStats,n.map(t.find("a.tumblelog"),o.text))},_ensureGifSearchQueryEntry:function(t){return this.gifSearchStats[t]||(this.gifSearchStats[t]={added:[],searches:0}),this.gifSearchStats[t]},_onGifSearchQuery:function(t,e){var i=this._ensureGifSearchQueryEntry(t);i.searches++},_onGifSearchAccept:function(t,e,i){var n=this._ensureGifSearchQueryEntry(t);n.added.push(i+":"+s(e))},_getAttributionImages:function(t){return n.map(t.find("[data-tumblr-attribution]"),function(t){var e=o(t),i=e.find("img");return e.attr("data-tumblr-attribution")+":"+s(i.attr("src"))})},_getConsolidatedGifStats:function(t){var e=this._getAttributionImages(t),i={searches:0,added:0,kept:0};return n.forEach(this.gifSearchStats,function(t,s){i.searches+=t.searches,i.added+=t.added.length,i.kept+=n.intersection(e,t.added).length}),i},_getGifSearchStats:function(t){var e=this._getAttributionImages(t);return n.transform(this.gifSearchStats,function(t,i,s){n.forEach(i.added,function(i){n.contains(e,i)&&(t[i]=s)})},{})},_getContentNode:function(){var t="";return this.model&&this.model.editorField&&(t=this.model.getAttributeFromGeneric(this.model.editorField),"markdown"===this.model.get("editorType")&&(t=c.render(t))),u.nodeFromString(t)},_getWrappedContentDocument:function(){return o(this._getContentNode())},getStats:function(){var t={elapsed:parseInt((new Date-this.dateInitialized)/1e3,10)};return n.extend(t,this.contentStats.parse(this._getWrappedContentDocument())),t}});e.exports=p},{"../utils/dom_stats":307,"./embed_data":249,jquery:"HlZQrA",lodash:"MicNly","prima/component":511,"prima/utils/dom":567,"prima/utils/url":579,remarkable:"tJkXfs"}],249:[function(t,e,i){"use strict";var s=t("lodash"),n=t("jquery"),o=t("when"),a=t("prima/utils/dom"),r=2e3,l=t("prima/class"),r=2e3,h=function(t,e,i){this.name="EmbedError",this.message=t,this.input=e,this.data=i,this.stack=(new Error).stack};h.prototype=new Error;var c=l.extend({constructor:function(t){this.setEmbedRegexes(t||[])},setEmbedRegexes:function(t){this.regexes=t,this.services=s.unique(s.values(t))},isValidEmbedService:function(t){return s.any(this.regexes,function(e,i){return new RegExp(i,"mi").test(t)})},isValidEmbedServiceName:function(t){return s.contains(this.services,t)},getUrlFromEmbedCode:function(t){var e=n(a.nodeFromString(t)),i=e.find("iframe[src], embed[src], script[src]").first(),s=e.find("object[data]").first();return i.attr("src")||s.attr("data")||!1},fetchEmbedData:function(t,e,i){var a=n.ajax({url:"/svc/post/get_video_data",type:"POST",with_form_key:!0,data:JSON.stringify({embed_url:t,embed_width:e})});return o(a).then(function(n){if(s.isEmpty(n)||"false"===n)throw new h("Invalid embed response",t,n);if(n.thumbnail||i)return n;var a=s.bind(this.fetchEmbedData,this,t,e,!0);return o.promise(function(t,e){s.delay(function(){a().then(function(t){return t},function(){return n})},r)})})["catch"](function(t){return o.reject(t)})},parseEmbedData:function(t,e){if(!s.isString(t))throw"The input is invalid. Expected a string";var i=s.trim(t);if(this.isValidEmbedService(i))return this.fetchEmbedData(i,e);var n=this.getUrlFromEmbedCode(i);return s.isEmpty(n)?o.reject(new h("Invalid embed code",t)):o.resolve({unsupported:!0,thumbnail:!1,embed_render_context:"blank",url:n,preview_iframe:"",embed_code:t})}});e.exports=new c},{jquery:"HlZQrA",lodash:"MicNly","prima/class":509,"prima/utils/dom":567,when:"RG2dij"}],250:[function(t,e,i){"use strict";var s=t("lodash"),n=t("jquery"),o=t("prima/class"),a=t("prima/mixins/accessor"),r=t("../views/gif-search-popover"),l=t("../templates/image-search-attribution.tpl"),h=t("app/components/gif-search/collections/search-image-queries"),c=o.extend({constructor:function(t){this.initialize.apply(this,arguments)},defaults:{query:"",resultLimit:200,resultImageWidth:250},initialize:function(t){this.options=t=s.extend({},t),s.extend(this,s.pick(t,"editorView","editor")),n.browser.mozilla&&parseInt(n.browser.version,10)<=37&&(this.set("resultLimit",20),this.set("resultImageWidth",100)),this.searchImageQueries=new h,this.listenTo(this.searchImageQueries,"search",function(t,e){this.set("query",t),this.trigger("gifSearch:query",t,e),this.set("currentQuery",t)}),this.listenTo(this,"insertImage",function(t){this.trigger("gifSearch:accept",t.query,t.src,t.attribution)}),this._addToolbarButton(),s.isString(this.get("query"))&&this.searchImageQueries.fetchGifs(this.get("query"),this.get("resultLimit")),this.editorView.$el.on("click.image-search-support","[data-tumblr-attribution]",s.bind(this._onImageClick,this))},teardown:function(){this.gifSearch&&this.gifSearch.teardown(),this.editorView.$el.off(".image-search-support")},_addToolbarButton:function(){this.$imageSearchButton=n("<div />",{"class":"control add-gif","data-control-name":"gif",tabindex:"0",title:this.options.title,"data-enabled-title":this.options.title}),this.editor.inlineControls.addToTray(this.$imageSearchButton,this.options.trayOptions),this.$imageSearchButton.on("click",s.bind(function(t){this.prompt(this.get("query"))},this))},addTumblrAttribution:function(t,e,i,n){if(i.is("figure")){var o=i.filter("[data-tumblr-attribution]"),a=o.children("img").first();if(!s.isEmpty(o)&&!s.isEmpty(a)){var r=(o.attr("data-tumblr-attribution")||"").split(":");if(3!==r.length)return;r.push(o.attr("data-tumblr-query"),o.attr("data-tumblr-search")),r.unshift(o),this.updateTumblrAttribution.apply(this,r)}}},cleanupMarkup:function(t,e){e.find("figure[data-tumblr-query]").removeAttr("data-tumblr-query"),e.find("figure[data-tumblr-search]").removeAttr("data-tumblr-search"),e.find("figure[data-tumblr-attribution]").children(":not(img)").remove()},insertImage:function(t,e,i,o){!s.isUndefined(o)||(o=!0);var a=s.values(s.pick(t,"rootBlog","rootBlogKey","rootPostUrlHash")),r=this.editor.lastSelection?this.editor.lastSelection.anchorNode:null,l=function(r){var l=n(this.editor.getAsyncImage(r)),h=l.parent("figure");l.attr("src",t.mediaUrl),a.unshift(h),s.isString(e)||(e=h.attr("data-tumblr-query")),s.isString(i)||(i=e),a.push(e,i),this.updateTumblrAttribution.apply(this,a),o&&h.addClass("tmblr-full"),this.editorView.updateModelFromEditor(),this.trigger("insertImage",{query:i,src:t.mediaUrl,attribution:h.attr("data-tumblr-attribution")})};this.get("replaceKey")?(l.call(this,this.get("replaceKey")),this.unset("replaceKey"),this.editorView.focus()):this.editorView.insertImageFromUrl(t.mediaUrl,"",{targetNode:r}).then(s.bind(l,this))},_onImageClick:function(t){var e,i,s,o,a,r,l,h=n(t.target);this.gifSearch&&this.gifSearch.isOrWasRecentlyRendered(250)||h.is(".tmblr-attribution")||h.parents(".tmblr-attribution").length>0||(e=n(t.currentTarget),i=e.find("[data-img-key]"),i.is("[data-img-key]")&&e.is("[data-tumblr-query]")&&(s=i.attr("data-img-key"),o=e.attr("data-tumblr-query"),r=t.pageY-e.offset().top,l=e.height(),a=r>l-200?-97:-l+r,this.prompt(o,{pinnedTarget:e,shift:{x:0,y:a},selectedImageUrl:i.attr("src")}),this.set("replaceKey",s)))},updateTumblrAttribution:function(t,e,i,n,o,a){var r=t.children("img").first();t.attr("data-tumblr-attribution",e+":"+i+":"+n),s.isString(o)?t.attr("data-tumblr-query",o):t.removeAttr("data-tumblr-query"),s.isString(a)?t.attr("data-tumblr-search",a):t.removeAttr("data-tumblr-search"),t.closest(".media-holder").toggleClass("media-holder--gif-search",s.isString(o)),t.children().not(r).remove(),t.append(l({attributionUrl:"http://tmblr.co/"+n,attributionName:e}))},getButton:function(){return this.$imageSearchButton},prompt:function(t,e){e=s.extend({collection:this.searchImageQueries,query:t,resultLimit:this.get("resultLimit"),imageWidth:this.get("resultImageWidth"),autoTeardown:!0,teardownOnEscape:!1,pinnedTarget:this.getButton()},e);var i=function(){this.unset("replaceKey"),this.stopListening(this.gifSearch),this.gifSearch.teardown(),this.gifSearch=null};this.gifSearch&&i.call(this),this.gifSearch=new r(e),this.gifSearch.render(),this.listenToOnce(this.gifSearch,"selectImage",function(t){this.insertImage(t,this.get("query"),t.popularSearchTag),s.delay(s.bind(i,this),250)}),this.listenToOnce(this.gifSearch,"dismiss",s.bind(i,this)),this.listenToOnce(this.gifSearch,"close",function(){
this.gifSearch=null}),this.trigger("prompt")},calculateWidth:function(){var t=n(this.editor.element),e=t.width(),i=t.offset(),s=this.editor.inlineControls.tray,o=s.offset();return e-(o.left-i.left)},returnFocus:function(){if(this.editorView.inlineControlNode){var t=document.createRange(),e=window.getSelection();t.setStart(this.editorView.inlineControlNode,0),t.collapse(!0),e.removeAllRanges(),e.addRange(t)}this.getButton().focus()},isOpen:function(){return!s.isEmpty(this.gifSearch)}});a.applyTo(c.prototype),e.exports=c},{"../templates/image-search-attribution.tpl":264,"../views/gif-search-popover":322,"app/components/gif-search/collections/search-image-queries":57,jquery:"HlZQrA",lodash:"MicNly","prima/class":509,"prima/mixins/accessor":542}],251:[function(t,e,i){"use strict";var s=t("jquery"),n=function(){return{uploadImageUrl:function(t,e,i,n){var o=s.ajax({url:"/svc/post/upload_image_url",type:"POST",with_form_key:!0,data:{url:t}});return"function"==typeof e&&o.done(function(i){e.call(null,i,t)}),"function"==typeof i&&o.fail(i),"function"==typeof n&&o.always(n),o}}}();e.exports=n},{jquery:"HlZQrA"}],252:[function(t,e,i){"use strict";var s=t("lodash"),n=t("jquery"),o=t("backbone"),a=t("../views/inline_embed_field"),r=t("../services/embed_data"),l=(t("prima/lib/logger"),t("prima/lib/translate")),h=t("prima/utils/camelize-keys"),c="tmblr-embed",u="tmblr-embed-placeholder",d="embed_iframe",p=t("prima/utils/dom"),m=t("../templates/thumbnail_preview.tpl"),g=function(){var t={template:m,trayOpened:function(t){this.checkLimit(),this.inlineEmbedField.hide()},trayClosed:function(t){this.inlineEmbedField.hide()},disable:function(){var t=this.$inlineEmbedButton.attr("data-disabled-title");this.isDisabled=!0,this.$inlineEmbedButton.addClass("disabled").attr("title",t).attr("tabindex","-1")},enable:function(){var t=this.$inlineEmbedButton.attr("data-enabled-title");this.isDisabled=!1,this.$inlineEmbedButton.removeClass("disabled").attr("title",t).attr("tabindex","0")},checkLimit:function(){this.isAtLimit()?this.disable():this.enable()},isAtLimit:function(){var t=n(this.editor.element).find("figure."+c+", figure."+u);return t.length>=this.inlineEmbedsPerPost},calculateWidth:function(){var t=n(this.editor.element),e=t.width(),i=t.offset(),s=this.editor.inlineControls.tray,o=s.offset();return e-(o.left-i.left)},returnFocus:function(){if(this.editorView.inlineControlNode){var t=document.createRange(),e=window.getSelection();t.setStart(this.editorView.inlineControlNode,0),t.collapse(!0),e.removeAllRanges(),e.addRange(t)}this.getButton().focus()},insertEmbed:function(t){if(this.editor.inlineControls.isTrayOpen||this.editorView.get("hasGifSearchVariation")){var e={"class":u,"data-provider":encodeURIComponent(t.service),"data-orig-width":encodeURIComponent(t.widthOrig),"data-orig-height":encodeURIComponent(t.heightOrig),"data-embed-code":encodeURIComponent(t.embedCode)};s.isEmpty(t.url)||(e["data-url"]=encodeURIComponent(t.url));var i=this._buildEmbedThumbnailPreview(e,t.thumbnail,t.previewIframe),n=i.get(0);this.editor.insertMedia(n,!1,this.editorView.inlineControlNode,0),this.editor.inlineControls.close(),this.checkLimit()}},submitEmbedCode:function(){var t=s.trim(this.inlineEmbedField.getCurrentValue()||"");if(""===t)return void this.inlineEmbedField._set_field_state_default();var e=this.embedCodeParser(t,this.inlineMediaWidthFull);return e?void e.then(s.bind(function(e){return this.inlineEmbedField.set("embedCode",t),e&&e.embed_render_context&&"inline"===e.embed_render_context?(this.inlineEmbedField._set_field_state_default(),e=h(e),void this.insertEmbed(e)):void this.inlineEmbedField._set_field_state_invalid()},this),function(e){this.inlineEmbedField.set("embedCode",t),this.inlineEmbedField._set_field_state_invalid()}):(this.inlineEmbedField._set_field_state_invalid(),void this.inlineEmbedField.set("embedCode",t))},embedCodeParser:function(t,e){if(this._embedCodeParsing&&this._embedCodeParsing.abortEmbedCodeParse(),!s.isEmpty(s.trim(t))){var i=!1,n=this._parseEmbedCode=r.parseEmbedData(t,e).then(s.bind(function(t){return t},this),function(t){return!1});return n.abortEmbedCodeParse=function(){i=!0},n}},removeEmbedPlaceholders:function(t){var e=p.nodeFromString(t),i=function(t){return s.isEmpty(t)?!1:decodeURIComponent(t)};return n(e).find("figure."+u).each(s.bind(function(t,e){var s=n(e),o=i(s.attr("data-embed-code")),a=s.attr("data-url"),r={"class":c,"data-provider":s.attr("data-provider"),"data-orig-width":s.attr("data-orig-width"),"data-orig-height":s.attr("data-orig-height")};if(a&&(r["data-url"]=a),i(r["data-provider"])&&i(r["data-orig-width"])&&i(r["data-orig-height"])&&o){var l=this._buildEmbedFigure(r,o);s.replaceWith(l)}else s.remove()},this)),e.innerHTML},addEmbedPlaceholders:function(t){var e=this.editorView.hosts.safe_host+"/svc/embed/inline/",i=p.nodeFromString(t),o=function(t){return s.isEmpty(t)?!1:decodeURIComponent(t)};return n(i).find("figure."+c).each(s.bind(function(t,i){var a=n(i),r=a.parents(),l=r&&n(r).filter("blockquote").length>0;if(t<this.inlineEmbedsPerPost){var c={code:a.html(),provider:o(a.attr("data-provider")),url:o(a.attr("data-url")),width:o(a.attr("data-orig-width")),height:o(a.attr("data-orig-height"))},m=l?this.inlineMediaWidthReblog:this.inlineMediaWidthFull,g=Math.ceil(c.height*m/c.width),f=e+encodeURIComponent(c.url?c.url:c.code);f+="?w="+m+"&h="+g;var _={"class":d,src:f,scrolling:"no",frameBorder:"0",allowfullscreen:!0,mozallowfullscreen:!0,webkitallowfullscreen:!0},v=n("<iframe/>",_);v.attr("width",m),v.attr("height",g);var b=p.outerHTML(v.get(0)),y={"class":u,"data-provider":a.attr("data-provider"),"data-orig-width":a.attr("data-orig-width"),"data-orig-height":a.attr("data-orig-height"),"data-embed-code":encodeURIComponent(c.code),"data-url":a.attr("data-url")||f},w=this._buildEmbedFigure(y,b);w.find("iframe").attr("src",""),a.replaceWith(w),this.embedCodeParser(decodeURIComponent(y["data-url"]),this.inlineMediaWidthFull).then(s.bind(function(t){if("inline"===s.get(t,"embed_render_context")){t=h(t);var e=this._buildEmbedThumbnailPreview(y,t.thumbnail,b);n(this.editor.element).find('figure[data-url="'+y["data-url"]+'"]').replaceWith(e)}},this),function(t){})}else a.remove()},this)),this.checkLimit(),i.innerHTML},_buildEmbedThumbnailPreview:function(t,e,i){var s=n(i);s.addClass("hidden").attr("data-src",s.attr("src")).attr("src","");var o=n(this.template({width:s.attr("width")?s.attr("width")+"px":s.css("width"),height:s.attr("height")?s.attr("height")+"px":s.css("height"),imageUrl:e.url,message:l("Load video")}));return this._buildEmbedFigure(t,o).append(s).addClass("embed-thumbnail-preview")},_buildEmbedFigure:function(t,e){var i=n("<figure/>",t);return e&&i.html(e),this.fullWidthInlineMedia&&i.addClass(this.fullWidthClass),i},getButton:function(){return this.$inlineEmbedButton},prompt:function(){this.checkLimit(),this.isDisabled||(this.inlineEmbedField.show(),this.trigger("prompt"))}},e=function(e){var i;e=e||{},s.extend(this,o.Events,t),this.editorView=e.editorView,this.editor=e.editor,this.inlineEmbedsPerPost=e.inlineEmbedsPerPost,this.inlineMediaWidthReblog=e.inlineMediaWidthReblog,this.inlineMediaWidthFull=e.inlineMediaWidthFull,this.fullWidthInlineMedia=e.fullWidthInlineMedia,this.fullWidthClass=e.fullWidthClass,this.editorView&&this.editor&&(this.$inlineEmbedButton=n("<div />",{"class":"control add-inline-embed","data-control-name":"inline-embed",tabindex:"0",title:e.title,"data-enabled-title":e.title,"data-disabled-title":e.disabledTitle}),this.inlineEmbedField=this.editorView.subViews.inlineEmbedField=new a({placeholder:l("Paste a URL or embed code"),submitEmbedCode:s.bind(this.submitEmbedCode,this),calculateWidth:s.bind(this.calculateWidth,this),returnFocus:s.bind(this.returnFocus,this)}),this.inlineEmbedsPerPost>0&&(i=n("<div/>",{"data-subview":"inlineEmbedField"}),this.editor.inlineControls.addToTray(this.$inlineEmbedButton,e.trayOptions),this.editor.inlineControls.addToTray(i.get(0))),this.$inlineEmbedButton.on("click",this.prompt.bind(this)),n(this.editor.element).on("click",".embed-thumbnail-preview",s.bind(function(t){var e=n(t.currentTarget),i=e.find("iframe"),s=e.find(".thumbnail-preview");s.addClass("loading"),s.find(".Knight-Rider-loader").addClass("animate"),e.addClass("loading"),i.on("load",function(){s.removeClass("loading"),s.addClass("hidden"),e.removeClass("loading")}),i.removeClass("hidden"),i.attr("src",i.attr("data-src"))},this)),this.isDisabled=this.isAtLimit())};return e}();e.exports=g},{"../services/embed_data":249,"../templates/thumbnail_preview.tpl":298,"../views/inline_embed_field":326,backbone:"5kFNoY",jquery:"HlZQrA",lodash:"MicNly","prima/lib/logger":519,"prima/lib/translate":541,"prima/utils/camelize-keys":561,"prima/utils/dom":567}],253:[function(t,e,i){"use strict";var s=t("lodash"),n=t("jquery"),o=t("prima/events"),a=t("ligature").SelectionContext,r=t("backbone"),l=function(){var t=function(){},e={rangeDebounce:10},i={enterMention:function(e){this.currentMention=e,this.inMention=!0,this.renderGhost(e),this.dropdown.setPinnedTarget(this.editor.element),this.updatePopoverPosition(e),this.trigger("mention:enter"),t("MentionSupport:enterMention - querying server for [%s]",e.string),this.queryServer(e.string)},updateMention:function(e){if(this.inMention&&e.string!==this.currentMention.string){if(!this.isSameMention(e))return this.exitMention(e),void this.enterMention(e);this.currentMention=e,this.inMention=!0,this.renderGhost(e),this.trigger("mention:update"),t("MentionSupport:updateMention - querying server for [%s]",e.string),this.queryServer(e.string)}},exitMention:function(){this.currentMention=!1,this.inMention=!1,this.lastTypeahead="",this.teardownGhost(),this.editor.onChange(),this.trigger("mention:exit")},softConfirm:function(t){var e=h();e.caretPosition===e.offsetEnd&&this.confirmMention(t)},spaceConfirm:function(t){var e=h(),i=this.dropdown.getCurrentBlogChoice();i&&i.name===e.string&&this.confirmMention(t,i)},confirmMention:function(t,e){e=e||this.dropdown.getCurrentBlogChoice(),e&&this.setMention(e)},setMention:function(t){var e=this.lastInfo,i=t.name,s=document.createTextNode("​"),n=document.createElement("a"),o=this.lastSelection;n.setAttribute("class","tumblelog"),n.spellcheck=!1,n.innerHTML="@"+i,e.mentionRange.deleteContents(),e.mentionRange.insertNode(s),e.mentionRange.insertNode(n),e.mentionRange.setStartAfter(s),e.mentionRange.setEndAfter(s),o.removeAllRanges(),o.addRange(e.mentionRange),this.exitMention(e),this.trigger("mention:set",t,e)},linkToMention:function(e){var i,s,o,r=a.getSelection(),l=e.range.commonAncestorContainer.parentElement||n(e.range.commonAncestorContainer).parent().get(0);return this.currentMention!==!1&&this.exitMention(e),l.classList.contains("tumblelog")?(i=document.createRange(),i.selectNode(l),i.deleteContents(),s=document.createTextNode("@"+e.string),i.insertNode(s),o=document.createRange(),r.removeAllRanges(),o.setStart(s,e.caretPosition),o.setEnd(s,e.caretPosition),r.addRange(o),this.cleanupRangeArea(r,o),t("MentionSupport:linkToMention",e.string),void this.onSelection(r)):!1},abortMention:function(){this.escapeMention=h(),this.inMention&&this.exitMention(this.escapeMention)},isSameMention:function(t){return this.currentMention&&this.currentMention.offsetStart===t.offsetStart},isMentionLink:function(t){var e,i=document.createElement("div"),s=this.adjustRange(t);return s?(i.appendChild(s.cloneContents()),e=n(i).find("a:first"),e.length?e.hasClass("tumblelog"):!1):!1},cleanupRangeArea:function(t,e){var i,s,o=document.createElement("span");o.setAttribute("id","mention_cleanup_placeholder"),o.innerHTML="",e.insertNode(o),this.normalize(t,e),i=e.commonAncestorContainer.parentElement,i||(i=n(e.commonAncestorContainer).parent().get(0)),i.normalize(),1===n(i).length&&(s=n(i).html(),s=s.replace(/[\u200B]/g,""),n(i).html(s));var a=n(document).find("#mention_cleanup_placeholder");a.length>0&&(t.removeAllRanges(),e.selectNode(a.get(0)),e.deleteContents(),t.addRange(e),i.normalize())},adjustRange:function(t){var e,i;return s.isUndefined(t)?!1:(t=t.cloneRange(),e=t.commonAncestorContainer,i=3===e.nodeType?e.parentNode:e,i.textContent==="@"+t.toString()&&t.selectNode(i),t)},normalize:function(t,e){this.editor.element.normalize(),null===t||s.isUndefined(e)||(t.removeAllRanges(),t.addRange(e))},renderGhost:function(t){if(this.$ghost=n(document).find("#ui_mention_util_ghost"),!(this.$ghost.length>0)){var e=document.createElement("q");e.setAttribute("id","ui_mention_util_ghost"),e.innerHTML="&#8203;",e.className="mention-ghost",t.suffixRange.surroundContents(e),this.$ghost=n(document).find("#ui_mention_util_ghost"),this.trigger("ghost:render",this.$ghost)}},updatePopoverPosition:function(t){if(s.has(t,"range")){var e=this.getMentionRect(t),i=n(this.editor.element).offset(),o=n(window).scrollTop();this.dropdown.setShift({x:e.left-i.left-10,y:-(e.bottom-i.top+o+10)})}},teardownGhost:function(t){if(t&&t.range||(t=this.lastInfo),this.$ghost=n(document).find("#ui_mention_util_ghost"),0!==this.$ghost.length){var e=this.$ghost.parent().get(0),i=t.caretRange.commonAncestorContainer,s=a.getSelection(0),o=s?s.getRangeAt(0):!1;s&&"ui_mention_util_ghost"===n(i).attr("id")&&(o.selectNode(i),o.deleteContents(),o.collapse(!1)),this.$ghost=n(document).find("#ui_mention_util_ghost"),1===this.$ghost.length&&(this.$ghost.remove(),this.trigger("ghost:teardown")),e&&e.normalize(),s&&o&&(s.removeAllRanges(),s.addRange(o))}},insertGhost:function(t){var e=a.getSelection(0),i=e.getRangeAt(0);this.$ghost=n(document).find("#ui_mention_util_ghost"),0!==this.$ghost.length&&(this.$ghost.html(t),null===e||s.isUndefined(i)||(e.removeAllRanges(),e.addRange(i)))},maintainTypeaheadGhost:function(e,i){var s=this.dropdown.getBlogChoice(0),n=s?s.name:this.lastTypeahead;if(t("MentionSupport:maintainGhost - topSuggestion = %s, typeahead = %s, lastChar = %s",s,n,i),i&&this.lastTypeahead.length&&i===this.$ghost.text().substr(0,1))this.$ghost.text(this.$ghost.text().substr(1));else if(e&&8===e.keyCode){var o=n.substr(this.lastTypeahead.length-this.$ghost.text().length-1);t("MentionSupport:maintainGhost BACKSPACE"),this.$ghost.text(o)}else this.updateTypeahead(n);this.updatePopoverPosition(h())},stripGhost:function(t){if(!t)return t;var e=n("<span>"+t+"</span>");return e.find("#ui_mention_util_ghost").remove(),e.html()},updateTypeahead:function(e){var i=this.currentMention;if(t("MentionSupport:updateTypeahead - typeahead = [%s]",e),this.lastTypeahead=e,!i||!this.inMention||!e)return void this.teardownGhost();var s="";i=i.string;var n=i.toUpperCase(),o=e.toUpperCase();e.length>i.length&&n===o.substr(0,n.length)&&(s=e.substr(i.length,e.length-i.length)),this.insertGhost(s)},updateForInteractive:function(t){var e=this.dropdown.getCurrentBlogChoice();t&&e&&this.updateTypeahead(e.name)},bindEditorCallbacks:function(){this.editor.config.onSelection=s.bind(this.onSelection,this);var t=this.editor.config.onClientEvent||s.noop;this.editor.config.onClientEvent=s.bind(function(e){t(e),this.onClientEvent(e)},this)},setupListeners:function(){this.dropdown.listenTo(this,"editor:cycleUp",this.dropdown.cycleUp),this.dropdown.listenTo(this,"editor:cycleDown",this.dropdown.cycleDown),this.listenTo(this,"editor:abortMention",this.abortMention),this.listenTo(this,"editor:softConfirm",this.softConfirm),this.listenTo(this,"editor:spaceConfirm",this.spaceConfirm),this.listenTo(this,"editor:confirm",this.confirmMention),this.listenTo(this.dropdown,"dropdown:confirm",this.confirmMention),this.dropdown.listenTo(this,"ghost:render",this.dropdown.setPinnedTarget),this.dropdown.listenTo(this,"mention:exit",this.dropdown.teardown),this.listenTo(this.dropdown,"dropdown:render",this.maintainTypeaheadGhost),this.listenTo(this.dropdown,"dropdown:empty",this.exitMention),this.listenTo(this.dropdown,"dropdown:menuInteraction",this.updateForInteractive)},queryServer:function(t){var e={query:t,success:s.bind(this.dropdown.updateMentionDropdown,this.dropdown)};this.mentionModel.fetch(e)},getMentionRect:function(t){if(!(t&&t.range&&"getClientRects"in t.range))return!1;var e=t.range.getClientRects();return s.isUndefined(e[0])?!1:e[0]}},l=function(e,n){s.extend(this,r.Events,i),this.editor=e,this.dropdown=n,this.mentionModel=n.model,this.inMention=!1,this.currentMention=!1,this.escapeMention=!1,this.lastInfo=!1,this.lastSelection=!1,this.$ghost=!1,this.lastTypeahead="",this.debugMode=!1,this.bindEditorCallbacks(),this.setupListeners(),t=s.bind(t,this)},h=function(t){t=t||a.getSelection();var e=function(t){return/[^\-a-z0-9]/i.test(t)},i={isMention:!1,len:0,string:"",stringBefore:"",stringAfter:"",range:!1,mentionRange:!1,suffixRange:!1,caretRange:!1,offsetStart:!1,offsetEnd:!1,caretPosition:!1,caretNode:!1};if(i.caretRange=t&&t.rangeCount>0?t.getRangeAt(0):!1,i.caretRange===!1||i.caretRange.startOffset!==i.caretRange.endOffset)return!1;var n=i.caretRange.commonAncestorContainer;n.normalize(),i.caretNode=1===n.nodeType?n.firstChild:n;var o=null==i.caretNode?"":i.caretNode.nodeValue;if(i.caretPosition=i.caretRange.startOffset,null==o||0===o.length)return!1;for(var r=0,l=0;l<i.caretPosition;l++)e(o.charAt(l))?r=0:r++;i.stringBefore=o.substr(i.caretPosition-r,r);var h=!1;if(i.caretPosition-(r+2)>=0){h=o.substr(i.caretPosition-r-1,1);var c=o.substr(i.caretPosition-r-2,1);s.contains([32,160],c.charCodeAt(0))||(h=!1)}else i.caretPosition-(r+1)>=0&&(h=o.substr(i.caretPosition-r-1,1));for(i.isMention="@"===h,r=0,l=i.caretPosition;l<o.length&&!e(o.charAt(l));l++)r++;return i.stringAfter=o.substr(i.caretPosition,r),i.string=i.stringBefore+i.stringAfter,i.len=i.string.length,i.isMention||0!==i.len&&""!==i.string?(i.range=document.createRange(),i.offsetStart=i.caretRange.startOffset-i.stringBefore.length,i.offsetEnd=i.caretRange.startOffset+i.stringAfter.length,i.range.setStart(i.caretNode,i.offsetStart),i.range.setEnd(i.caretNode,i.offsetEnd),i.isMention?(i.mentionRange=document.createRange(),i.mentionRange.setStart(i.caretNode,i.offsetStart-1),i.mentionRange.setEnd(i.caretNode,i.offsetEnd),i.suffixRange=document.createRange(),i.suffixRange.setStart(i.caretNode,i.caretRange.startOffset+i.stringAfter.length),i.suffixRange.setEnd(i.caretNode,i.caretRange.startOffset+i.stringAfter.length),i):i):!1},c={keydown:{27:"editor:abortMention",38:"editor:cycleUp",40:"editor:cycleDown",39:"editor:softConfirm",32:"editor:spaceConfirm",9:"editor:confirm",13:"editor:confirm"}};return l.prototype.onClientEvent=function(t){o.trigger("richTextEditor:onClientEvent",t,this.editor);var e,i=["keyup","keydown","keypress"];if(this.inMention&&-1!==i.indexOf(t.type)){if(t=t||window.event,e=t.which||t.keyCode,"keydown"===t.type)e in c[t.type]?(this.trigger(c[t.type][e],t),39!==e&&32!==e&&(t.preventDefault(),t.stopImmediatePropagation())):8===e&&this.maintainTypeaheadGhost(t);else if("keyup"===t.type){if(e in c.keydown)return!1}else this.maintainTypeaheadGhost(t,String.fromCharCode(e));var s=h();s&&(this.lastInfo=s)}},l.prototype.onSelection=s.debounce(function(t){var e=h(t);e?(this.escapeMention&&(this.escapeMention.string===e.string?e.isMention=!1:this.escapeMention=!1),this.lastInfo=e,this.lastSelection=t):this.escapeMention=!1;var i=e&&this.isMentionLink(e.range);e&&e.isMention===!0&&!i?this.inMention&&this.isSameMention(e)?this.updateMention(e):this.enterMention(e):this.inMention?this.exitMention(e):e&&i&&this.linkToMention(e)},e.rangeDebounce),l}();e.exports=l},{backbone:"5kFNoY",jquery:"HlZQrA",ligature:620,lodash:"MicNly","prima/events":512}],254:[function(t,e,i){"use strict";var s=t("lodash"),n=t("jquery"),o=t("prima/class"),a=o.extend({fetchOpenGraphData:function(t){var e=n.ajax({url:"/svc/post/fetch_og",type:"POST",with_form_key:!0,data:{url:t}});return this.xhr=e,e.then(function(t){var e=n.parseJSON(t)||{};return e.response}).always(s.bind(function(){this.xhr=null},this))},abort:function(){this.xhr&&this.xhr.abort()}});e.exports=a},{jquery:"HlZQrA",lodash:"MicNly","prima/class":509}],255:[function(t,e,i){"use strict";var s=t("lodash"),n=t("jquery"),o=function(){var t=function(t){if(!s.trim(t.html||""))return s.isFunction(t.done)&&t.done(""),void(s.isFunction(t.always)&&t.always(""));var e=n.ajax({url:"/svc/filter_html_for_dash_preview",type:"POST",with_form_key:!0,data:{html:t.html||"",markdown:t.isMarkdown?1:0}});return s.isFunction(t.done)&&e.done(t.done),s.isFunction(t.fail)&&e.fail(t.fail),s.isFunction(t.always)&&e.always(t.always),e};return{filterForDash:function(e,i,s,n,o){return t({html:e,isMarkdown:i,done:s,fail:n,always:o})},filterHtmlForDash:function(e,i,s,n){return t({html:e,isMarkdown:!1,done:i,fail:s,always:n})},filterMarkdownForDash:function(e,i,s,n){return t({html:e,isMarkdown:!0,done:i,fail:s,always:n})}}};e.exports=o},{jquery:"HlZQrA",lodash:"MicNly"}],256:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __t,__p="";Array.prototype.join;with(obj||{})__p+='<div class="album-art--container"><div data-js-albumart class="album-art" style="'+(null==(__t=url?"background-image:url("+url+");":"")?"":_.escape(__t))+'"></div><div data-js-removebutton class="album-art--remove-button"><div class="v-center-outer"><div class="v-center-inner"><span data-js-removebuttontext>'+(null==(__t=__("Remove image"))?"":_.escape(__t))+'</span></div></div></div></div><div data-js-dropzone class="media-dropzone"><div data-js-mediaupload class="media-upload-button"><div class="v-center-outer"><div class="v-center-inner"><div class="dropzone-title"><span data-js-mediauploadtext class="dropzone-text">'+(null==(__t=dropzoneText)?"":_.escape(__t))+'</span></div></div></div><div class="media-upload"><div data-subview="upload"></div></div></div></div>';return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],257:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __t,__p="";Array.prototype.join;with(obj||{})__p+='<label class="binary_switch"><input type="checkbox" id="allowAnswers" type="checkbox" data-js-allowanswerscheckbox> <span class="binary_switch_track"></span> <span class="binary_switch_button"></span></label><label class="allow-answers-label" for="allowAnswers">'+(null==(__t=__("Let people answer this"))?"":_.escape(__t))+"</label>";return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],258:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __t,__p="";Array.prototype.join;with(obj||{})__p+='<div class="note_wrapper" data-name="askField"><div class="note_item"><div class="text"><p class="asker"><span class="name">'+(null==(__t=post.asking_tumblelog.name.toLowerCase())?"":_.escape(__t))+"</span> <span>"+(null==(__t=__("asked"))?"":_.escape(__t))+':</span></p><p class="note_text">'+(null==(__t=post.ask)?"":__t)+'</p></div><div class="nipple"></div></div><div class="avatar"><img src="'+(null==(__t=post.asking_tumblelog.avatar)?"":_.escape(__t))+'" alt="" width="40" height="40"></div></div>',showAnswerField&&(__p+='<div class="note_wrapper" data-name="answerField"><div class="note_item"><div class="text"><p class="answerer"><span class="name">'+(null==(__t=post.answering_tumblelog.name.toLowerCase())?"":_.escape(__t))+"</span> <span>"+(null==(__t=__("answered"))?"":_.escape(__t))+":</span></p>"+(null==(__t=post.answer)?"":__t)+'</div><div class="nipple"></div></div><div class="avatar"><img src="'+(null==(__t=post.answering_tumblelog.avatar)?"":_.escape(__t))+'" alt="" width="40" height="40"></div></div>'),__p+="";return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],259:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __t,__p="";Array.prototype.join;with(obj||{})__p+='<div class="media-dropzone" data-js-dropzone><div class="media-upload-button" data-js-mediaupload><div class="v-center-outer"><div class="v-center-inner"><div class="dropzone-icon '+(null==(__t=uploadIcon)?"":_.escape(__t))+'"></div></div></div><div class="media-upload"><div data-subview="upload"></div></div></div></div>';return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],260:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __t,__p="";Array.prototype.join;with(obj||{})__p+='<div class="channel-avatar avatar-container"><a class="avatar-link" href="'+(null==(__t=channel.url)?"":_.escape(__t))+'" target="_blank" title="'+(null==(__t=channel.directory_safe_title)?"":__t)+'" style="background-image: url(\''+(null==(__t=avatarUrl)?"":_.escape(__t))+'\')"><img class="avatar-image" src="'+(null==(__t=avatarUrl)?"":_.escape(__t))+'" alt="'+(null==(__t=channel.name)?"":_.escape(__t))+'"></a></div><div class="primary-avatar avatar-container"><a class="avatar-link" href="'+(null==(__t=primary.url)?"":_.escape(__t))+'" target="_blank" title="'+(null==(__t=primary.directory_safe_title)?"":__t)+'" style="background-image: url(\''+(null==(__t=subavatarUrl)?"":_.escape(__t))+'\')"><img class="avatar-image" src="'+(null==(__t=subavatarUrl)?"":_.escape(__t))+'" alt="'+(null==(__t=primary.name)?"":_.escape(__t))+'"></a></div>';return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],261:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __t,__p="";Array.prototype.join;with(obj||{})__p+='<label class="confirm-tos--label" data-name="confirm-tos"><div class="binary_switch"><input class="confirm-tos--checkbox" type="checkbox" name="confirm_tos" data-js-confirmtos> <span class="binary_switch_track"></span> <span class="binary_switch_button"></span></div><span class="confirm-tos--text">'+(null==(__t=__("This is my original work, or I %1$shave permission%2$s to post this.",'<a href="/terms-of-service" target="_blank">',"</a>"))?"":__t)+"</span></label>";return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],262:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __t,__p="";Array.prototype.join;with(obj||{})__p+='<div class="html-mode"><div class="tabs clearfix"><div class="tab src-button" data-js-srcbutton><span class="icon '+(null==(__t=isMarkdown?"markdown":"html")?"":_.escape(__t))+'" data-js-srcicon></span> <span class="tab-label" data-js-srclabel>'+(null==(__t=srcLabel)?"":_.escape(__t))+'</span></div><div class="tab preview-button" data-js-previewbutton><span class="icon"></span> <span class="tab-label" data-js-previewlabel>'+(null==(__t=previewLabel)?"":_.escape(__t))+'</span></div><div class="tab tooltip-container"><span class="icon" data-js-editorhelp></span></div></div><div class="views"><div class="view src-view" data-js-srcview><div data-js-ace></div></div><div class="view preview-view" data-js-previewview><div class="html-preview editor" data-js-htmlpreview></div></div></div></div>';return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],263:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __t,__p="";Array.prototype.join;with(obj||{})__p+="",_.forEach(id3Fields,function(t,e){__p+='<div class="id3-editor--container '+(null==(__t=id3FieldLabel[e]?"id3-editor--"+id3FieldLabel[e].toLowerCase():"")?"":_.escape(__t))+'"><input name="'+(null==(__t=e)?"":_.escape(__t))+'" value="'+(null==(__t=t)?"":_.escape(__t))+'" class="id3-editor--input" type="text"><label class="id3-editor--label">'+(null==(__t=id3FieldLabel[e]||__(_.capitalize(e)))?"":_.escape(__t))+"</label></div>"}),__p+="";return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],264:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __t,__p="";Array.prototype.join;with(obj||{})__p+='<p class="tmblr-attribution"><a href="'+(null==(__t=attributionUrl)?"":_.escape(__t))+'" target="_blank">'+(null==(__t=__("Originally posted by %1$s",attributionName))?"":_.escape(__t))+"</a></p>";return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],265:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __p="";Array.prototype.join;with(obj||{})__p+='<div class="inline-embed-field" data-name="inlineEmbedField"><div data-subview="inlineEmbedInput"></div></div>';return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],266:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __t,__p="";Array.prototype.join;with(obj||{})__p+="","spotify"===service&&(__p+='<iframe data-js-audioembed src="https://embed.spotify.com/?uri='+(null==(__t=encodeURIComponent(url))?"":_.escape(__t))+'&amp;view=coverart" width="500" height="580" frameborder="0" allowtransparency="true" scrolling="no" class="audio-embed--spotify"></iframe>'),__p+="","soundcloud"===service&&(__p+='<iframe data-js-audioembed src="https://w.soundcloud.com/player/?url='+(null==(__t=encodeURIComponent(url))?"":_.escape(__t))+'&amp;visual=true&amp;liking=false&amp;sharing=false&amp;auto_play=false&amp;show_comments=false&amp;continuous_play=false&amp;origin=tumblr" frameborder="0" allowtransparency="true" scrolling="no" width="500" height="500" class="audio-embed--soundcloud"></iframe>'),__p+="","bandcamp"===service&&(__p+='<iframe data-js-audioembed src="https://bandcamp.com/EmbeddedPlayer/size=medium/bgcol=ffffff/linkcol=0687f5/notracklist=true/transparent=true/'+(null==(__t=type)?"":_.escape(__t))+"="+(null==(__t=id)?"":_.escape(__t))+'/" frameborder="0" allowtransparency="true" scrolling="no" width="500" height="120" class="audio-embed--bandcamp"></iframe>'),__p+="","direct"===service&&(__p+='<div data-js-audioembed class="audio-embed--direct '+(null==(__t=canEditMedia?"audio-embed--direct-editable":"")?"":_.escape(__t))+'"><div data-subview="audioPlayer"></div><div data-subview="id3Editor"></div><div data-subview="albumArtUploader"></div></div>'),__p+="",canEditMedia&&(__p+='<div data-subview="removeButton"></div>'),__p+="";return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],267:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __t,__p="";Array.prototype.join;with(obj||{})__p+='<div data-js-sortable class="photoset--photo-dragger"></div><div data-js-mediaoverlay class="media-overlay"><div data-js-clickthroughurlbutton class="overlay-button '+(null==(__t=hasClickthroughUrl?"active":"")?"":_.escape(__t))+'"><div class="icon icon_editor_link"></div></div><div data-js-captionbutton class="overlay-button '+(null==(__t=hasCaption?"active":"")?"":_.escape(__t))+'"><div class="icon icon_editor_more"></div></div></div><div data-subview="removeButton"></div>';return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],268:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __p="";Array.prototype.join;with(obj||{})__p+='<div class="photobooth-container" data-js-photobooth></div><div class="photoset-container" data-js-photoset></div>';return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],269:[function(require,module,exports){
var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __p="";Array.prototype.join;with(obj||{})__p+='<div class="video-container" data-js-video></div>',canEditMedia&&(__p+='<div data-subview="removeButton"></div>'),__p+="";return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],270:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __t,__p="";Array.prototype.join;with(obj||{})__p+="","inline"===embedRenderContext?__p+='<div class="video-preview">'+(null==(__t=previewIframe)?"":__t)+"</div>":(__p+='<div class="video-preview video_preview '+(null==(__t=thumbnail&&thumbnail.url?"has_thumbnail":"no_thumbnail")?"":_.escape(__t))+'">',thumbnail&&thumbnail.url&&(__p+='<img src="'+(null==(__t=thumbnail.url)?"":_.escape(__t))+'" alt="" width="'+(null==(__t=thumbnail.width||"")?"":_.escape(__t))+'" height="'+(null==(__t=thumbnail.height||"")?"":_.escape(__t))+'">'),__p+='<div class="video_info_wrapper"><i class="icon_post_video"></i><div class="video_text"><span class="clippable">'+(null==(__t=__("Watch on %s",tumblelogHostname))?"":_.escape(__t))+'</span> <i class="icon_arrow_carrot_right"></i></div></div></div>'),__p+="";return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],271:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __t,__p="";Array.prototype.join;with(obj||{})__p+='<div class="video-error"><div class="v-center-outer"><div class="v-center-inner"><span class="icon"></span> <span class="error-message">'+(null==(__t=__("This video embed stopped working. Try another?"))?"":_.escape(__t))+"</span></div></div></div>";return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],272:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __t,__p="";Array.prototype.join;with(obj||{})__p+='<div class="media-preview"><div class="v-center-outer"><div class="v-center-inner"><div class="icon '+(null==(__t=icon)?"":_.escape(__t))+'" data-js-previewicon></div><p class="media-preview-text" data-js-previewmessage>'+(null==(__t=message)?"":_.escape(__t))+"</p></div></div></div>";return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],273:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __t,__p="";Array.prototype.join;with(obj||{}){__p+="";var dropzoneClasses=[];showInput&&dropzoneClasses.push("show-input"),splitDropzone&&dropzoneClasses.push("split-dropzone"),toggleDropzone&&dropzoneClasses.push("toggle-dropzone"),defaultBehavior&&dropzoneClasses.push("toggle-dropzone-"+defaultBehavior),__p+='<div class="media-dropzone '+(null==(__t=dropzoneClasses.join(" "))?"":_.escape(__t))+'" data-js-dropzone><div class="split-cells">',enableUpload&&(__p+='<div class="split-cell media-upload-button" data-js-mediaupload><div class="split-cell-inner"><div class="v-center-outer"><div class="v-center-inner">',uploadIcon&&(__p+='<div class="dropzone-icon '+(null==(__t=uploadIcon)?"":_.escape(__t))+'"></div>'),__p+="",uploadText&&(__p+='<div class="dropzone-title"><span class="dropzone-text" data-js-mediauploadtext>'+(null==(__t=toggleDropzone?dropzoneText:uploadText)?"":_.escape(__t))+"</span>",uploadTooltip&&(__p+='<div class="dropzone-tooltip" data-js-uploadtooltip><span class="icon icon_help" data-show-tooltip="uploadTooltip"></span></div>'),__p+="</div>"),__p+='</div></div></div><div class="media-upload"><div data-subview="upload"></div></div></div>'),__p+="",enableUrl&&(__p+='<div class="split-cell media-url-button" data-js-mediaurl><div class="split-cell-inner"><div class="v-center-outer"><div class="v-center-inner">',urlIcon&&(__p+='<div class="dropzone-icon '+(null==(__t=urlIcon)?"":_.escape(__t))+'"></div>'),__p+="",urlText&&(__p+='<div class="dropzone-title"><span class="dropzone-text" data-js-mediaurltext>'+(null==(__t=toggleDropzone?dropzoneText:urlText)?"":_.escape(__t))+"</span>",urlTooltip&&(__p+='<div class="dropzone-tooltip" data-js-urltooltip><span class="icon icon_help" data-show-tooltip="urlTooltip"></span></div>'),__p+="</div>"),__p+='</div></div></div><div class="media-url-cropper media-dropzone-cropper"><div class="media-url"><div class="v-center-outer"><div class="v-center-inner"><div data-subview="urlInput"></div></div></div></div></div><div data-subview="removeButton"></div></div>'),__p+="</div></div>"}return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],274:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __t,__p="";Array.prototype.join;with(obj||{})__p+='<div class="pop-menu"><div class="inner">',_.each(blogs,function(t,e){__p+="";var i=t.name.replace(queryRegex,"<u>$&</u>");__p+='<div id="mention_'+(null==(__t=e)?"":_.escape(__t))+'" class="item-option" data-tumblelog="'+(null==(__t=t.name)?"":_.escape(__t))+'"><div class="blog-info"><span class="blog-name">'+(null==(__t=i)?"":__t)+'</span> <span class="blog-title">'+(null==(__t=t.title)?"":_.escape(__t))+'</span></div><span class="blog-thumb" style="background-image:url(\''+(null==(__t=t.avatar_url)?"":_.escape(__t))+"')\"></span></div>"}),__p+="</div></div>";return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],275:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __t,__p="";Array.prototype.join;with(obj||{})__p+='<div class="overlay-button-popover" data-js-popover><input data-js-input type="text" value="'+(null==(__t=value)?"":_.escape(__t))+'" placeholder="'+(null==(__t=placeholder)?"":_.escape(__t))+'" aria-label="'+(null==(__t=ariaLabel)?"":_.escape(__t))+'" maxlength="'+(null==(__t=maxLength)?"":_.escape(__t))+'" class="input-field"><div data-js-confirm class="input-confirm">'+(null==(__t=confirmText)?"":_.escape(__t))+"</div></div>";return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],276:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __t,__p="";Array.prototype.join;with(obj||{})__p+='<div class="editor editor-plaintext" aria-label="'+(null==(__t=ariaLabel)?"":_.escape(__t))+'" contenteditable="true" data-js-plaintexteditor></div>';return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],277:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __t,__p="";Array.prototype.join;with(obj||{})__p+='<div class="post-margin" data-js-margin><div data-subview="avatar"></div></div><div class="post-container" data-js-container-outer><div class="post-container-inner post" data-js-container-inner><div class="post-form--header clearfix" data-js-header><div class="controls-container"><div class="control left"><div data-subview="tumblelogSelect"></div></div><div class="control right"><div data-subview="uploadingIndicator"></div><div data-subview="postSettings"></div></div></div></div><div class="post-form--form post-content-text"><div data-subview="postTypeForm"></div></div><div class="post-form--footer" data-js-footer><div data-subview="tagEditor"></div><div data-subview="editorButtons"></div></div><div class="post-form--guard"></div><div class="post-form--bottom" data-js-bottom><div class="post-form--controls" data-js-postformcontrols><div class="controls-container"><div class="control left"><button class="flat-button post-form--close" data-js-clickableclose="">'+(null==(__t=closeLabel)?"":_.escape(__t))+'</button></div><div class="control right"><div data-subview="socialButtons"></div></div><div class="control right"><div data-subview="savePostButton"></div></div></div></div><div data-subview="errorBar"></div></div><div data-subview="allowAnswers"></div><div data-subview="richTextEditorTutorial"></div></div></div>';return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],278:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __t,__p="";Array.prototype.join;with(obj||{})__p+='<form method="POST" target="_blank" action="'+(null==(__t=action)?"":_.escape(__t))+'">',_.each(inputs,function(t,e){__p+='<input type="hidden" name="'+(null==(__t=e)?"":_.escape(__t))+'" value="'+(null==(__t=t)?"":_.escape(__t))+'">'}),__p+="</form>";return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],279:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __p="";Array.prototype.join;with(obj||{})__p+='<button class="post-settings" data-js-clickablepostsettingscog><span class="dropdown settings-icon" data-js-postsettingscog></span></button>';return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],280:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __t,__p="";Array.prototype.join;with(obj||{})__p+='<div class="pop-menu"><div class="inner"><div class="form-horizontal"><div class="form-group"><div class="group-label"><label for="customUrl_input">'+(null==(__t=__("Custom URL"))?"":_.escape(__t))+'</label></div><div class="group-content"><div class="adjacent-content"><label for="customUrl_input" class="prefix" data-js-customurllabel>/post/123/</label><input name="customUrl" id="customUrl_input" class="field crystal" type="text" autocomplete="off" data-js-customurl value="'+(null==(__t=customUrl)?"":_.escape(__t))+'"></div></div></div><div class="form-group"><div class="group-label"><label for="sourceUrl_input">'+(null==(__t=__("Content source"))?"":_.escape(__t))+'</label></div><div class="group-content"><input id="sourceUrl_input" name="sourceUrl" class="field crystal" type="text" placeholder="http://..." autocomplete="off" data-js-sourceurl value="'+(null==(__t=sourceUrl)?"":_.escape(__t))+'"></div></div><div class="form-group"><div class="group-label"><label for="postDate_input">'+(null==(__t=__("Post date"))?"":_.escape(__t))+'</label></div><div class="group-content"><input id="postDate_input" name="postDate" class="field crystal" type="text" placeholder="'+(null==(__t=__("Now"))?"":_.escape(__t))+'" autocomplete="off" data-js-postdate value="'+(null==(__t=postDate)?"":_.escape(__t))+'"></div></div>',showPhotoRepliesOption&&(__p+='<div class="form-group"><div class="group-label">'+(null==(__t=__("Replies"))?"":_.escape(__t))+'</div><div class="group-content"><div class="checkbox field row"><label class="binary_switch"><input name="allow_photo_replies" type="checkbox" id="allowPhotoReplies" type="checkbox" data-js-allowphotoreplies> <span class="binary_switch_track"></span> <span class="binary_switch_button"></span></label><label for="allowPhotoReplies">'+(null==(__t=__("Let people photo reply"))?"":_.escape(__t))+"</label></div></div></div>"),__p+="",showEditorSelection&&(__p+='<div class="form-group"><div class="group-label">'+(null==(__t=__("Text editor"))?"":_.escape(__t))+'</div><div class="group-content"><div class="flat_select field row"><select name="editorType" id="editorType" data-js-editortype><option value="rich">'+(null==(__t=__("Rich text"))?"":_.escape(__t))+'</option><option value="html">'+(null==(__t=__("HTML"))?"":_.escape(__t))+'</option><option value="markdown">'+(null==(__t=__("Markdown"))?"":_.escape(__t))+'</option></select><label for="editorType" class="current_selection">'+(null==(__t=__("Rich text"))?"":_.escape(__t))+'</label><i class="icon"></i></div></div></div>'),__p+="</div></div></div>";return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],281:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __t,__p="";Array.prototype.join;with(obj||{})__p+='<div class="clear-results icon_close '+(null==(__t=0===resultCount?"inactive":"")?"":_.escape(__t))+'"></div><div class="copyright-warning '+(null==(__t=showCopyrightWarning===!1?"inactive":"")?"":_.escape(__t))+'">'+(null==(__t=copyrightWarningMessage)?"":__t)+"</div>",_.each(serviceResults,function(t,e){__p+='<div class="audio-result-set" data-service="'+(null==(__t=e)?"":__t)+'">',_.each(t,function(t){__p+='<div class="result '+(null==(__t="youtube"===e?"video-result":"audio-result")?"":_.escape(__t))+'" data-href="'+(null==(__t=t.href)?"":__t)+'"><span class="primary">'+(null==(__t=t.primary)?"":__t)+'</span><span class="secondary">'+(null==(__t=t.secondary)?"":__t)+'</span> <span class="info">'+(null==(__t=t.info)?"":__t)+"</span></div>"}),__p+="</div>"}),__p+="";return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],282:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __p="";Array.prototype.join;with(obj||{})__p+='<div class="media-wrapper" data-js-media><div data-subview="mediaPreview"></div><div data-js-mediacomposer class="audio-search-container"><div data-subview="searchField"></div><div data-subview="audioUploader"></div><div data-subview="searchResultList"></div></div></div><div class="caption-wrapper" data-js-tos><div data-subview="confirmTos"></div></div><div class="caption-wrapper" data-js-caption><div data-subview="reblogTree"></div><div data-subview="caption"></div></div>';return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],283:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __p="";Array.prototype.join;with(obj||{})__p+='<div data-subview="title"></div><div data-subview="chat"></div>';return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],284:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __p="";Array.prototype.join;with(obj||{})__p+='<div class="media-wrapper"><div class="media-container link-media-container"><div class="link-editor"><div data-subview="url"></div><section class="link-media-body" data-js-media><div class="thumbnail" data-js-image data-js-removable="false"></div><article data-js-article data-js-removable="true"><div class="publisher-container"><a href="#" data-js-publisher target="_blank" rel="bookmark" class="publisher"></a></div><div data-subview="title"></div><div data-subview="excerpt"></div><div data-js-author class="author"></div></article></section></div>',canEditMedia&&(__p+='<div data-subview="removeButton"></div>'),__p+='</div></div><div class="caption-wrapper" data-js-caption><div data-subview="reblogTree"></div><div data-subview="caption"></div></div>';return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],285:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __p="";Array.prototype.join;with(obj||{})__p+='<div data-subview="askField"></div><div data-subview="answerField"></div><div data-subview="reblogTree"></div><div data-subview="caption"></div>';return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],286:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __p="";Array.prototype.join;with(obj||{})__p+='<div class="media-wrapper" data-js-media><div data-subview="mediaPreview"></div><div data-subview="mediaComposer"></div></div><div class="caption-wrapper" data-js-caption><div data-subview="reblogTree"></div><div data-subview="caption"></div></div>';return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],287:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __p="";Array.prototype.join;with(obj||{})__p+='<div data-subview="quote"></div><div data-subview="source"></div>';return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],288:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __p="";Array.prototype.join;with(obj||{})__p+='<div data-subview="title"></div><div data-subview="reblogTree"></div><div data-subview="body"></div>';return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],289:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __p="";Array.prototype.join;with(obj||{})__p+='<div class="media-wrapper" data-js-media><div data-subview="mediaPreview"></div><div data-subview="mediaComposer"></div></div><div class="caption-wrapper" data-js-tos><div data-subview="confirmTos"></div></div><div class="caption-wrapper" data-js-caption><div data-subview="reblogTree"></div><div data-subview="caption"></div></div>';return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],290:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __t,__p="";Array.prototype.join;with(obj||{})__p+="",showReblogTree&&(__p+='<div class="control-reblog-tree post"><div class="reblog-tree post_content">'+(null==(__t=post.get("reblog_tree"))?"":__t)+'</div><div data-subview="removeButton"></div><div class="btn-show-tree btn-toggle-reblog">'+(null==(__t=__("Put reblogs back"))?"":_.escape(__t))+"</div></div>"),__p+="";return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],291:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __t,__p="";Array.prototype.join;with(obj||{})__p+='<div class="editor editor-richtext" aria-label="'+(null==(__t=ariaLabel)?"":_.escape(__t))+'" contenteditable="true" data-js-richtexteditor></div><div data-subview="htmlField"></div>';return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],292:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __t,__p="";Array.prototype.join;with(obj||{})__p+='<h3 class="title">'+(null==(__t=__("Want to style your text?"))?"":_.escape(__t))+'</h3><p class="content">'+(null==(__t=__("Just select it. You'll see."))?"":_.escape(__t))+'</p><button class="blue ok_button flat-button" type="button">'+(null==(__t=__("I see"))?"":_.escape(__t))+"</button>";return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],293:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __p="";Array.prototype.join;with(obj||{})__p+='<div class="split chrome blue"><div data-subview="loader"></div><button class="flat-button blue caption create_post_button" data-js-clickablesave></button><div class="flat-button blue dropdown options icon_arrow_carrot_down" data-js-clickablesavedropdown></div></div>';return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],294:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __t,__p="";Array.prototype.join;with(obj||{})__p+='<div class="pop-menu"><ul class="inner select-left" data-js-options><li class="item-option '+(null==(__t="published"===state?"icon_checkmark":"")?"":__t)+'" data-js-publish><span class="">'+(null==(__t=__("Post now"))?"":_.escape(__t))+'</span></li><li class="item-option '+(null==(__t="queued"===state?"icon_checkmark":"")?"":__t)+" "+(null==(__t=-1===activeOptions.indexOf("queued")?"hidden":"")?"":__t)+'" data-js-queue><span class="">'+(null==(__t=__("Add to queue"))?"":_.escape(__t))+'</span></li><li class="item-option '+(null==(__t="draft"===state?"icon_checkmark":"")?"":__t)+" "+(null==(__t=-1===activeOptions.indexOf("draft")?"hidden":"")?"":__t)+'" data-js-draft><span class="">'+(null==(__t=__("Save as draft"))?"":_.escape(__t))+'</span></li><li class="item-option '+(null==(__t="private"===state?"icon_checkmark":"")?"":__t)+'" data-js-private><span class="">'+(null==(__t=__("Post privately"))?"":_.escape(__t))+'</span></li><li class="item-option '+(null==(__t="scheduled"===state?"icon_checkmark":"")?"":__t)+" "+(null==(__t=-1===activeOptions.indexOf("scheduled")?"hidden":"")?"":__t)+'" data-js-schedule><span class="">'+(null==(__t=__("Schedule"))?"":_.escape(__t))+'</span><br><input class="field square solid" type="text" autocomplete="off" placeholder="Next Tuesday, 10am" data-js-scheduletext></li>',showPreview&&(__p+='<li class="item-option full" data-js-preview><button class="button flat-button">'+(null==(__t=__("Preview on blog"))?"":_.escape(__t))+"</button></li>"),__p+="</ul></div>";return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],295:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __t,__p="";Array.prototype.join;with(obj||{})__p+='<ul class="social-buttons"><li data-js-twitter data-service="twitter" data-js-tweetdropdownpin class="social-button twitter '+(null==(__t=twitter?"":"hidden")?"":_.escape(__t))+" "+(null==(__t=twitterOn?"checked":"")?"":_.escape(__t))+'"><label class="social-button--label social-button--twitter" data-js-shareicon data-js-twittericon></label></li><li data-js-facebook data-service="facebook" class="social-button facebook '+(null==(__t=facebook?"":"hidden")?"":_.escape(__t))+" "+(null==(__t=facebookOn?"checked":"")?"":_.escape(__t))+'"><label class="social-button--label social-button--facebook" data-js-shareicon data-js-facebookicon></label></li></ul>';return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],296:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __p="";Array.prototype.join;with(obj||{})__p+='<div class="tag-input-wrapper" data-js-taginputfieldwrapper><div data-subview="tagInputField"></div><div class="ghost" data-js-taginputghost></div></div>';return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],297:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __t,__p="";Array.prototype.join;with(obj||{})__p+='<div class="pop-menu"><div class="inner select-center"><div class="item-option-wrapper" data-js-tagsuggestwrapper>',_.each(results.userTags,function(t){__p+="";var e=_.escape(t).replace(queryRegex,"<u>$&</u>");__p+='<div class="item-option user-tags" data-tag="'+(null==(__t=_.escape(t))?"":__t)+'"><span class="tag-suggest-tag">'+(null==(__t=e)?"":__t)+"</span></div>"}),__p+='<div class="header-item">'+(null==(__t=__("Popular"))?"":_.escape(__t))+"</div>",_.each(results.suggestions,function(t){__p+="";var e=_.escape(t).replace(queryRegex,"<u>$&</u>");__p+='<div class="item-option suggest-tags" data-tag="'+(null==(__t=_.escape(t))?"":__t)+'"><span class="tag-suggest-tag">'+(null==(__t=e)?"":__t)+"</span></div>"}),__p+="</div></div></div>";return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],298:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __t,__p="";Array.prototype.join;with(obj||{})__p+='<div class="thumbnail-preview" style="background-image: url('+(null==(__t=imageUrl)?"":_.escape(__t))+"); width: "+(null==(__t=width)?"":_.escape(__t))+"; height: "+(null==(__t=height)?"":_.escape(__t))+'"><i class="icon_play"></i><div class="thumbnail-preview-message">'+(null==(__t=message)?"":_.escape(__t))+'</div><span class="Knight-Rider-loader"><span class="Knight-Rider-bar"></span> <span class="Knight-Rider-bar"></span> <span class="Knight-Rider-bar"></span></span></div>';return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],299:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __t,__p="";Array.prototype.join;with(obj||{})__p+='<div class="tooltip-inner">',__p+=sanitize?""+(null==(__t=text)?"":_.escape(__t)):""+(null==(__t=text)?"":__t),__p+="</div>";return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],300:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __t,__p="";Array.prototype.join;with(obj||{})__p+='<button class="tumblelog-select '+(null==(__t="edit"===post.get("mode")?"inactive":"")?"":_.escape(__t))+'" data-js-clickabletumbleloglabel><span class="caption" data-js-tumbleloglabel></span>',"edit"!==post.get("mode")&&(__p+=' <span class="dropdown icon_arrow_carrot_down" data-js-tumblelogselectpin></span>'),__p+="","reblog"===post.get("mode")&&(__p+=' <span class="reblog_source"><i class="reblog-icon"></i> <span class="reblog_name">'+(null==(__t=post.get("reblog_name"))?"":_.escape(__t))+"</span></span>"),__p+="</button>";return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],301:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __t,__p="";Array.prototype.join;with(obj||{})__p+='<div class="pop-menu"><ul class="inner select-right">',_.forEach(channels,function(t){__p+='<li class="item-option '+(null==(__t=t.name===tumblelog?"select":"")?"":_.escape(__t))+'" data-js-tumblelogchoice><img class="ts-avatar" src="'+(null==(__t=t.avatarUrl)?"":_.escape(__t))+'" alt="'+(null==(__t=t.name)?"":_.escape(__t))+'"><div class="ts-info"><p class="ts-name">'+(null==(__t=t.displayName)?"":_.escape(__t))+'</p><p class="ts-title">'+(null==(__t=t.directory_safe_title)?"":__t)+"</p></div></li>"}),__p+="</ul></div>";return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],302:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __t,__p="";Array.prototype.join;with(obj||{})__p+='<div data-js-tweetpopover><div class="tweet-container"><textarea aria-label="'+(null==(__t=__("Custom tweet"))?"":_.escape(__t))+'" data-js-customtweet class="tweet-textarea">'+(null==(__t=tweetText)?"":_.escape(__t))+'</textarea><div data-js-tweetremaining class="tweet-remaining">'+(null==(__t=tweetRemaining)?"":_.escape(__t))+'</div></div><button data-js-dismisstweet type="button" class="chrome small dismiss">'+(null==(__t=__("Done"))?"":_.escape(__t))+"</button></div>";return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],303:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __p="";Array.prototype.join;with(obj||{})__p+='<div data-subview="loader"></div>';return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],304:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __t,__p="";Array.prototype.join;with(obj||{})__p+='<div data-js-webcambutton class="webcam-button"><span data-js-smiley class="icon icon_postforms_selfie"></span> <span data-js-text class="dropzone-text">'+(null==(__t=__("Take a selfie"))?"":_.escape(__t))+"</span></div>";return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],305:[function(t,e,i){"use strict";var s=t("lodash"),n=function(t,e){return e||(e=this),function(){var i=s.toArray(arguments);return s.map(t,function(t){return t.apply(e,i)},e)}};e.exports=n},{lodash:"MicNly"}],306:[function(t,e,i){"use strict";var s=t("lodash"),n=function(t){if(s.isString(t)){if(t=t.toLowerCase(),"true"===t||"1"===t||"on"===t)return!0;if("false"===t||""===t||"off"===t)return!1;if(t=s.parseInt(t),s.isNaN(t))return!0}return!!t};e.exports=n},{lodash:"MicNly"}],307:[function(t,e,i){"use strict";function s(t,e){return"function"==typeof e?e(t):t.find(e)}function n(t,e){return"function"==typeof e?e(t):t.attr(e)}function o(t,e){var i=s(t,e);return!l.isNumber(i)&&l.has(i,"length")?i.length:i}function a(t,e){var i=s(t,e.selector);return l.countBy(i,function(t){return n(h(t),e.attribute)})}function r(t,e){return l.isFunction(e)||l.isString(e)?o(t,e):l.has(e,"attribute")?a(t,e):null}var l=t("lodash"),h=t("jquery"),c=function(t){this.lookups=t||{}};c.prototype.parse=function(t){var e={},i=h(t),s=function(t,e){l.each(t,function(t,n){var o=r(i,t);null!==o?e[n]=o:l.isObject(t)?(e[n]={},s(t,e[n])):e[n]=t})};return s(this.lookups,e),e},e.exports=c},{jquery:"HlZQrA",lodash:"MicNly"}],308:[function(t,e,i){"use strict";var s=t("lodash"),n=t("jquery"),o=t("backbone"),a=t("prima/class"),r=0,l=function(t){t=null==t||s.isPlainObject(t)?s.extend({target:"body",autostart:!1},t):{target:t,autostart:!1};var e=".drag_eventor_"+r++,i=n(t.target),l=!1,h=0,c=new a;s.extend(c,o.Events);var u=["dragenter","dragover","dragleave","dragend","drop"],d=function(t){c.trigger(t.type,t)};return c.start=function(){h++,l||(l=!0,s.forEach(u,function(t){i.on(t+e,d)}))},c.stop=function(){h--,0>=h&&(l=!1,s.forEach(u,function(t){i.off(t+e,d)}))},t.autostart&&c.start(),c};e.exports=l},{backbone:"5kFNoY",jquery:"HlZQrA",lodash:"MicNly","prima/class":509}],309:[function(t,e,i){"use strict";function s(t){var e,i=[];for(var s in t)e=t[s],i.push([new RegExp("(</?)("+s+")([>\\s])","gi"),"$1"+e+"$3"]);return i}function n(t,e){for(var i=0;i<e.length;i++)t=t.replace.apply(t,e[i]);return t}function o(t,e){for(var i,o=s(e||u),a=t.split(c),r=!1,d="",p=0;p<a.length;p++)i=a[p],d?i===d&&(d=""):r&&(">"===i?r=!1:i.match(h)&&(d=i)),!d&&i.match(l)&&(">"!==i.slice(-1)&&(r=!0),a[p]=n(i,o));return a.join("")}var a="<\\/?\\w+[\\s>]",r="['\"]",l=new RegExp(a,"g"),h=new RegExp(r,"g"),c=new RegExp("("+a+"|"+r+"|>)","g"),u={strong:"b",em:"i"};e.exports=o},{}],310:[function(t,e,i){"use strict";var s=t("lodash"),n={camel:s.camelCase,snake:s.snakeCase,kebab:s.kebabCase},o=function(t,e){return s.isString(e)&&(e=s.result(n,e)),s.isFunction(e)?s.map(t,e):t},a=function(t,e,i){return s.isString(e)&&(e=o(i||s.keys(t),e)),s.transform(t,function(t,i,n){t[s.result(e,n)||n]=i},{})};e.exports=a},{lodash:"MicNly"}],311:[function(t,e,i){"use strict";var s=t("lodash"),n=function(t,e,i){var n={};s.isPlainObject(t)&&(i=e,s.extend(n,t),t=n.width,e=n.height);var o=Math.round(e/t*i);return n.width=i,n.height=o,n};e.exports=n},{lodash:"MicNly"}],312:[function(t,e,i){"use strict";var s=t("lodash"),n={normalizeSpace:function(t){
return t.trim().replace(" "," ").replace(/\s\s+/," ")},stripScripts:function(t){return t.replace(new RegExp("<script[^>]*>([\\S\\s]*?)</script\\s*>","img"),"")},stripTags:function(t){return t.replace(/<\w+(\s+("[^"]*"|'[^']*'|[^>])+)?>|<\/\w+>/gi,"")},truncateLongStrings:function(t,e,i){return s.isString(t)||(t=""),i||(i="…"),t.length<=e?t:s.trunc(t,e-i.length,i)},stripHtml:function(t,e,i){if(!t)return"";"undefined"==typeof e&&(e=!0);var n=t;"string"==typeof i&&(n=s.trim(n.replace(/(<br\s*\/?>)/gi,"$1"+i).replace(/(<\/(?:p|figure|h[1-6])\s*>)/gi,"$1"+i)));try{var o=document.implementation.createHTMLDocument("");o.body.innerHTML=this.stripScripts(n),n=o.body.textContent||o.body.innerText||"",n=n.trim()}catch(a){n=this.stripScripts(this.stripTags(n)).trim()}return e&&(n=this.normalizeSpace(n)),n}};e.exports=n},{lodash:"MicNly"}],313:[function(t,e,i){"use strict";var s={isUrl:function(t){var e="%[0-9a-fA-F]{2}",i="(http|https):\\/\\/",s='([a-zA-Z0-9$\\-_.+!*"(),;:&=]|'+e+")+@",n="(25[0-5]|2[0-4][0-9]|[0-1][0-9][0-9]|[1-9][0-9]|[0-9])",o="("+n+"(\\."+n+"){3})",a="a-zA-Z0-9\\-\\_\\~",r="\\u00C0-\\u017F",l="(["+a+r+"]+\\.)+([a-zA-Z]{2,})",h="[0-9]+",c="("+o+"|localhost|"+l+")(:"+h+")?",u="a-zA-Z0-9-._\\~:\\[\\]@!$&'()*+,;=",d="(["+u+"]|"+e+")*",p=d+"(\\/"+d+")*",m="\\?(["+u+"/?]|"+e+")*",g="\\#(["+u+"/?]|"+e+")*",f=new RegExp("^"+i+"("+s+")?"+c+"(\\/?("+p+")?("+m+")?("+g+")?)?$");return f.test(t)===!0},isImageUrl:function(t){var e=s.isUrl(t),i=/.+[.](jpg|jpeg|png|gif)([?]|$)/.test(t)===!0;return e&&i}};e.exports=s},{}],314:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/lib/translate"),o=t("../templates/album_art_uploader.tpl"),a=t("./media_dropzone"),r=a.extend({className:"media-dropzone-container album-art-uploader",defaultOptions:s.defaults({enableUrl:!1,uploadOptions:{name:"album_art",maxUploadSize:10485760,uploadPattern:/^image\/(?:.*)$/i,accept:"image/*",url:"/svc/post/upload_album_art"}},a.prototype.defaultOptions),initialize:function(t){return s.defaults(this.defaultOptions,{dropzoneText:n("Select album art"),uploadText:n("Select album art")}),a.prototype.initialize.apply(this,arguments)},template:o,events:s.extend({"click [data-js-removeButton]":"_onClickRemoveButton"},a.prototype.events),_onClickRemoveButton:function(){this.set("url","")},_onUploadUrlChange:function(t,e){this.set("url",e)},_onUrlChange:function(t,e){this.model.set({preuploadAlbumArt:!s.isEmpty(e),albumArt:e}),this.js$("albumArt").css("background-image",e?"url("+e+")":""),this.$el.toggleClass("can-upload-album-art",s.isEmpty(e))},afterRender:function(){this.listenTo(this.upload,"change:url",this._onUploadUrlChange),this.listenTo(this,"change:url",this._onUrlChange),this.$el.toggleClass("can-upload-album-art",s.isEmpty(this.get("url"))),a.prototype.afterRender.apply(this,arguments)}});e.exports=r},{"../templates/album_art_uploader.tpl":256,"./media_dropzone":333,lodash:"MicNly","prima/lib/translate":541}],315:[function(t,e,i){"use strict";var s=t("prima/view"),n=t("lodash"),o=t("../utils/string_helpers"),a=t("prima/mixins/selectorcache"),r=t("../templates/allow_answers.tpl"),l=s.extend({mixins:[a],template:r,className:"post-form--allow-answers",events:{"click [data-js-allowAnswersCheckbox]":"updateModel"},initialize:function(t){this.model=t.model},_onModelChange:function(){var t=!1;n.each(this.model.allowAnswerFields,function(e){return this.endsWithQuestionMark(this.model.get(e))?(t=!0,!1):void 0},this),t?this.$el.slideDown():(this.js$("allowAnswersCheckbox").removeAttr("checked"),this.updateModel(),this.$el.slideUp())},endsWithQuestionMark:function(t){return t=o.stripHtml(t,!1),-1!==t.indexOf("?",t.length-1)},updateModel:function(){this.model.set("allow_answers",this.js$("allowAnswersCheckbox").is(":checked"))},render:function(){return this.addStateListeners(),this.$el.html(this.template()),this},addStateListeners:function(){"new"===this.model.get("mode")&&this.listenTo(this.model,"change",this._onModelChange)},teardown:function(){return this.stopListening(),this}});e.exports=l},{"../templates/allow_answers.tpl":257,"../utils/string_helpers":312,lodash:"MicNly","prima/mixins/selectorcache":553,"prima/view":580}],316:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/view"),o=t("prima/mixins/accessor"),a=t("prima/mixins/subviewable"),r=t("../templates/ask_field.tpl"),l=n.extend({template:r,mixins:[o,a],serialize:function(){return s.extend({post:this.model.toJSON(),showAnswerField:this.model.isReblog()},this.toJSON())},render:function(){return this.$el.html(this.template(this.serialize())),this}});e.exports=l},{"../templates/ask_field.tpl":258,lodash:"MicNly","prima/mixins/accessor":542,"prima/mixins/subviewable":554,"prima/view":580}],317:[function(t,e,i){"use strict";var s=t("lodash"),n=t("jquery"),o=t("../templates/audio_uploader.tpl"),a=t("./media_dropzone"),r=a.extend({className:"audio-direct-upload-button",defaultOptions:s.defaults({enableUrl:!1,dropzoneText:"",uploadIcon:"dropzone-add-audio-icon",uploadText:"",uploadOptions:{name:"audio",mediaType:"audio",maxUploadSize:10485760,uploadPattern:n.browser.mozilla?/^audio\/(?:.*)$/i:/^(?:audio\/mp3|audio\/mpeg)$/i,accept:"audio/mp3",url:"/svc/post/upload_audio"}},a.prototype.defaultOptions),template:o});e.exports=r},{"../templates/audio_uploader.tpl":259,"./media_dropzone":333,jquery:"HlZQrA",lodash:"MicNly"}],318:[function(t,e,i){"use strict";var s=t("lodash"),n=t("when"),o=t("velocity-animate").animate,a=t("prima/utils/sequence-with-context"),r=t("app/components/post-form-builder/utils/transition_speed"),l=t("prima/view"),h=t("app/lib/avatar-size"),c=t("prima/mixins/subviewable"),u=t("prima/mixins/selectorcache"),d=t("prima/mixins/accessor"),p=t("app/lib/currentuser"),m=t("../templates/avatar.tpl"),g=l.extend({className:"post-form--avatar",mixins:[c,u,d],template:m,defaultOptions:{size:128,determineViewState:!0},defaults:{flipQueued:!1,showSubavatar:!1,avatarUrl:""},initialize:function(t){if(this.options=t=s.extend({},this.defaultOptions,t),this.user=t.user||p(),s.extend(this.attributes,s.pick(t,s.keys(this.defaults))),t.post&&(this.post=t.post,this.tumblelog=t.tumblelog||this.user.getChannel(this.post.get("tumblelog")),this.listenTo(this.post,"change:tumblelog",this._onChangePostTumblelog)),!this.tumblelog)throw new Error("AvatarView requires a Tumblelog model!");this.options.determineViewState?this.updateViewState():this.get("avatarUrl")||this.set("avatarUrl",this.tumblelog.get("avatar_url")),this.listenTo(this,"change:showSubavatar",this._onChangeShowSubavatar),this.listenTo(this,"change:avatarUrl",this._onChangeAvatarUrl)},_onChangeShowSubavatar:function(t,e){e?this.showSubavatar():this.hideSubavatar()},_onChangeAvatarUrl:function(t,e){return this.queueFlipAvatar()},updateViewState:function(){this.set({showSubavatar:this.tumblelog.get("show_author_avatar"),avatarUrl:this.tumblelog.get("avatar_url")})},_onChangePostTumblelog:function(t,e){this.tumblelog=this.user.getChannel(e),this.updateViewState()},showSubavatar:function(t,e){return null!=t||(t=r(150)),null!=e||(e=r(300)),o(this.$$(".primary-avatar"),{scale:1},{display:"block",duration:t,delay:e,easing:[.25,1.5,.75,1]})},hideSubavatar:function(t,e){return null!=t||(t=r(100)),null!=e||(e=0),o(this.$$(".primary-avatar"),{scale:0},{display:"none",duration:t,delay:e,easing:[0,0,.6,1]})},queueFlipAvatar:function(t,e){if(this._avatarFlipping)return void this.set("flipQueued",!0);var i=this.flipAvatar();i.then(s.bind(function(){this.get("flipQueued")&&(this.set("flipQueued",!1),this.flipAvatar())},this))},flipAvatar:function(t,e){null!=t||(t=r(300)),null!=e||(e=r(50));var i=h(this.get("avatarUrl"),this.options.size),s=this.tumblelog.get("name"),l=this.$$(".channel-avatar"),c=l.clone();return this._avatarFlipping=!0,a([function(){return c.children(".avatar-link").css("background-image","url('"+i+"')"),c.children(".avatar-image").attr({src:i,alt:s}),o(c,{rotateY:[180,180]},{duration:0}).then(function(){c.insertAfter(l)})},function(){return n.join(o(l,{rotateY:[180,0]},{duration:t}),o(c,{rotateY:[360,180]},{duration:t}))},function(){return l.remove(),this.$$.remove(".channel-avatar"),o(c,{rotateY:[0,0]},{duration:0})},function(){this._avatarFlipping=!1}],this)},resetAvatar:function(){return this.set(s.defaults(s.pick(this.options,["showSubavatar","avatarUrl"]),s.pick(this.attributes,["showSubavatar","avatarUrl"]))),this},serialize:function(){return s.extend(this.toJSON(),{avatarUrl:h(this.get("avatarUrl"),this.options.size),subavatarUrl:h(this.user.getChannel().get("avatar_url"),this.options.size),primary:this.user.getChannel().toJSON(),channel:this.tumblelog.toJSON()})},render:function(){return this.$el.html(this.template(this.serialize())),this.get("showSubavatar")||(this.$$(".primary-avatar").css("display","none"),this.hideSubavatar(0)),this}});e.exports=g},{"../templates/avatar.tpl":260,"app/components/post-form-builder/utils/transition_speed":225,"app/lib/avatar-size":429,"app/lib/currentuser":432,lodash:"MicNly","prima/mixins/accessor":542,"prima/mixins/selectorcache":553,"prima/mixins/subviewable":554,"prima/utils/sequence-with-context":577,"prima/view":580,"velocity-animate":"lWl/mc",when:"RG2dij"}],319:[function(t,e,i){"use strict";var s=t("lodash"),n=t("jquery"),o=t("prima/view"),a=t("prima/lib/translate"),r=t("prima/mixins/subviewable"),l=t("prima/mixins/selectorcache"),h=t("prima/mixins/accessor"),c=t("../templates/confirm_tos.tpl"),u=o.extend({className:"confirm-tos",events:{"change [data-js-confirmTos]":"_onChangeConfirmTos"},mixins:[r,l,h],template:c,initialize:function(t){this.options=t=s.extend({},t),s.extend(this.attributes,s.pick(t,s.keys(this.defaults))),this.user=t.user,this.post=t.post},_onChangeConfirmTos:function(t){this.post.set("confirmTos",n(t.currentTarget).is(":checked"))},serialize:function(){return{__:a,confirmTos:this.post.get("confirmTos")}},render:function(){return this.$el.html(this.template(this.serialize())),this.js$("confirmTos").attr("checked",!!this.post.get("confirmTos")),this},teardown:function(){return this.$el.empty(),this}});e.exports=u},{"../templates/confirm_tos.tpl":261,jquery:"HlZQrA",lodash:"MicNly","prima/lib/translate":541,"prima/mixins/accessor":542,"prima/mixins/selectorcache":553,"prima/mixins/subviewable":554,"prima/view":580}],320:[function(t,e,i){"use strict";var s=t("prima/view"),n=t("prima/mixins/subviewable"),o=t("prima/mixins/selectorcache"),a=s.extend({mixins:[n,o],initialize:function(){},render:function(){return this}});e.exports=a},{"prima/mixins/selectorcache":553,"prima/mixins/subviewable":554,"prima/view":580}],321:[function(t,e,i){"use strict";var s=t("prima/view"),n=s.extend({className:"post-form--error-bar",showErrorBar:function(t){this.$el.html(t).slideDown()},hideErrorBar:function(){this.$el.hide()}});e.exports=n},{"prima/view":580}],322:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/views/base"),o=t("prima/mixins/popoverbase"),a=t("app/components/gif-search"),r=n.extend({className:"popover--gif-search",mixins:[o],defaults:{query:null},initialize:function(t){this.gifSearch=new a(s.pick(t,"collection","query","imageWidth","selectedImageUrl","resultLimit")),this.listenTo(this,"change:query",function(t,e){this.gifSearch.setQuery(e)}),this.listenTo(this.gifSearch,"all",this.trigger)},render:function(){this.gifSearch.render().$el.appendTo(this.$el)},teardown:function(){return s.result(this.gifSearch,"remove"),this.$el.remove(),this}});e.exports=r},{"app/components/gif-search":59,lodash:"MicNly","prima/mixins/popoverbase":550,"prima/views/base":581}],323:[function(t,e,i){"use strict";var s=t("jquery"),n=t("lodash"),o=t("prima/view"),a=t("prima/lib/translate"),r=t("../services/preview_service"),l=t("./tooltip"),h=t("prima/mixins/subviewable"),c=t("prima/mixins/selectorcache"),u=t("prima/mixins/accessor"),d=t("../templates/html_field.tpl"),p=t("app/vendor/ace"),m=p.require("ace/mode/html").Mode,g=p.require("ace/mode/markdown").Mode,f=t("app/components/code-editor/theme/post_form"),_=o.extend({mixins:[u,h,c],className:"html-field",events:{"click [data-js-editorHelp]":"_onClickEditorHelp","click [data-js-srcButton]":"_onClickSrcButton","click [data-js-previewButton]":"_onClickPreviewButton"},template:d,defaults:{name:"",editedSincePreview:!1,currentValue:"",htmlPreviewValue:null,markdownPreviewValue:null,isResizable:!1,isMarkdown:!1,wasFocused:!1,textareaClass:""},initialize:function(t){this.set(t),this.updateValueFromModel(),this.previewService=new r,this.tooltip=new l({className:"dropzone-tooltip-popover",text:a("Note that the dashboard doesn't display all HTML elements, but you're free to put them in your posts anyway.")}),this._renderPreview=n.bind(this.renderPreview,this)},_onClickEditorHelp:function(t){this.tooltip.isRendered()?this.tooltip.remove():this.tooltip.render()},_onClickSrcButton:function(t){this.showSource(!0)},_onClickPreviewButton:function(t){this.showPreview()},renderPreview:function(t,e){!n.isUndefined(t)||(t=this.get("currentValue")),!n.isUndefined(e)||(e=this.get("isMarkdown"));var i=this.get("htmlPreviewValue");this.get("editedSincePreview")||null==i?(this.js$("htmlPreview").html('<p style="text-align:center;"><b>'+a("Loading preview...")+"</b></p>"),this.previewService.filterForDash(t,e,n.bind(function(t){this.set(e?"markdownPreviewValue":"htmlPreviewValue",t),this.set("editedSincePreview",!1),this.js$("htmlPreview").html(t)},this),n.bind(function(){this.js$("htmlPreview").html('<p style="text-align:center;"><i>'+a("Failed to load preview :(")+"</i></p>")},this))):this.js$("htmlPreview").html(i)},teardown:function(){return this.stopListening(),this.$el.empty(),this.tooltip&&this.tooltip.remove(),this},serialize:function(){return{isMarkdown:this.get("isMarkdown"),srcLabel:a(this.get("isMarkdown")?"Markdown":"HTML"),previewLabel:a("Preview")}},beforeRender:function(){this.listenTo(this,"change:isMarkdown",function(t,e){this.js$("srcIcon").toggleClass("markdown",e).toggleClass("html",!e),this.js$("srcLabel").text(a(e?"Markdown":"HTML"));var i=e?g:m;this.editor.getSession().setMode(new i),this.setAriaLabel()})},setAriaLabel:function(){var t;this.editor&&this.editor.textInput&&(t=this.editor.textInput.getElement(),t&&s(t).attr("aria-label",a(this.get("isMarkdown")?"Markdown content":"HTML content")))},render:function(){return this.$el.html(this.template(this.serialize())),this.$el.attr("data-name",this.get("name")),this.tooltip.setPinnedTarget(this.js$("editorHelp")),this._initAce(this.js$("ace").get(0)),this.showSource(),this.updateEditor(),this.setAriaLabel(),this},hide:function(){this.$el.hide()},show:function(){this.$el.show(),this.updateEditor(),this.updatePreview()},focus:function(){this.editor&&s(this.editor.container).is(":visible")&&(this.get("wasFocused")||!function(t){n.defer(function(){t.blur(),n.defer(function(){t.focus()})}),t.blur()}(this.editor),this.editor.focus())},blur:function(){this.editor&&this.editor.blur()},updateValueFromModel:function(){this.set("currentValue",this.model.get(this.get("name"))||"")},showSource:function(t){this.js$("previewButton").removeClass("active"),this.js$("srcButton").addClass("active"),this.js$("previewView").hide(),this.js$("srcView").show(),t&&n.defer(n.bind(function(){this.focus()},this))},showPreview:function(){this.js$("srcButton").removeClass("active"),this.js$("previewButton").addClass("active"),this.updatePreview(),this.js$("srcView").hide(),this.js$("previewView").show()},updateEditor:function(){this.editor&&(this._ignoreAceChange=!0,this.editor.setValue(this.get("currentValue"),1),this._ignoreAceChange=!1)},updatePreview:function(){var t=this.get("currentValue");this._renderPreview(t)},_updateValueFromAce:function(t){var e=this.get("name"),i=this.model.get(e);this.set("editedSincePreview",!0),this.set("currentValue",t),this.model.set(e,t),this.model.set("htmlEdited",t&&i!==t)},_initAce:function(t){var e=this.editor=p.edit(t),i=e.getSession();i.setUseWorker(!1),i.setUseWrapMode(!0),i.setFoldStyle("manual"),i.on("change",n.bind(function(){this._ignoreAceChange||this._updateValueFromAce(i.getValue())},this)),i.setUseSoftTabs(!0),i.setTabSize(2);var s=this.get("isMarkdown")?g:m;i.setMode(new s),e.setTheme(f),e.setShowPrintMargin(!1),e.renderer.setShowGutter(!1),e.renderer.setPadding(20),e.renderer.setScrollMargin(20,20),e.setHighlightActiveLine(!1),e.setHighlightSelectedWord(!1),e.setBehavioursEnabled(!1),e.commands.removeCommands(["showSettingsMenu","goToNextError","goToPreviousError","centerselection","gotoline","fold","unfold","toggleFoldWidget","toggleParentFoldWidget","foldall","foldOther","unfoldall","findnext"," findprevious","selectOrFindNext","selectOrFindPrevious","find","overwrite","togglerecording","replaymacro","jumptomatching","selecttomatching","removeline","duplicateSelection","sortlines","togglecomment","toggleBlockComment","modifyNumberUp","modifyNumberDown","replace","copylinesup","movelinesup","copylinesdown","movelinesdown","cut_or_delete","blockoutdent","blockindent","splitline","transposeletters","touppercase","tolowercase","expandtoline","joinlines","inverSelection"]),e.commands.addCommand({name:"uncommand",bindKey:{win:"",mac:"Ctrl-A|Ctrl-B|Ctrl-D|Ctrl-E|Ctrl-F|Ctrl-H|Ctrl-K|Ctrl-N|Ctrl-P|Ctrl-V"},exec:function(t,e){return!0},readOnly:!0});var o=n.bind(function(){this.set("wasFocused",!0),e.off("focus",o)},this);e.on("focus",o),e.setOptions({autoScrollEditorIntoView:!0,maxLines:300})}});e.exports=_},{"../services/preview_service":255,"../templates/html_field.tpl":262,"./tooltip":362,"app/components/code-editor/theme/post_form":41,"app/vendor/ace":"4e8++S",jquery:"HlZQrA",lodash:"MicNly","prima/lib/translate":541,"prima/mixins/accessor":542,"prima/mixins/selectorcache":553,"prima/mixins/subviewable":554,"prima/view":580}],324:[function(t,e,i){"use strict";var s=t("lodash"),n=t("jquery"),o=t("prima/view"),a=t("prima/lib/translate"),r=t("../templates/id3_editor.tpl"),l=o.extend({className:"id3-editor",events:{"input .id3-editor--input":"_onChangeInput","change .id3-editor--input":"_onChangeInput"},template:r,initialize:function(t){this.options=t=s.extend({},t),s.extend(this,s.pick(t,["post","user"]))},_onChangeInput:function(t){var e=n(t.currentTarget);this.post.set(e.attr("name"),e.val())},serialize:function(){var t={id3Fields:s.pick(this.post.toJSON(),"trackTitle","trackArtist","trackAlbum"),id3FieldLabel:{trackTitle:a("Track"),trackArtist:a("Artist"),trackAlbum:a("Album")}};return t},render:function(){return this.$el.html(this.template(this.serialize())),this}});e.exports=l},{"../templates/id3_editor.tpl":263,jquery:"HlZQrA",lodash:"MicNly","prima/lib/translate":541,"prima/view":580}],325:[function(t,e,i){"use strict";var s=t("jquery"),n=t("lodash"),o=t("prima/component"),a=t("components/popover").FeatureHelpPopoverView,r=o.extend({name:"InlineControlsTutorial",initialize:function(t){this.options=t=n.extend({},t),this.editor=this.options.richTextEditor,this.popover=new a,this.animationShowDelay=n.isNumber(this.options.animationShowDelay)?this.options.animationShowDelay:500,this.animationHideDelay=n.isNumber(this.options.animationHideDelay)?this.options.animationHideDelay:500,this.animationClass=this.options.animationClass,this.config={name:"inline-controls",template:"standard",glass:!1,title:this.options.title,content:this.options.content,ok_text:this.options.buttonLabel,position:a.POSITION.BOTTOM|a.POSITION.LEFT},this.listenTo(this.editor,"controls:show",this._onInlineControlsShow)},show:function(){this.editor.toggleInlineControlsTray(!0),this.listenToOnce(this.editor,"controls:hide controls:embed:prompt controls:gif:prompt",this._onInlineControlsHide),this.listenToOnce(this.editor,"controls:close",this._onInlineControlsClose),this.listenToOnce(this.popover,"dismiss",this._onPopoverDismiss),this.popover.setHighlighted(s(".post-form .inline-controls .opener")),this.popover.show(this.config),this.animationClass&&setTimeout(n.bind(function(){s("body").addClass(this.animationClass)},this),this.animationShowDelay),this.editor.addElementToControlsCloseWhitelist(this.popover.getPopoverElement())},showWithDelay:function(){setTimeout(this.show.bind(this),this.animationShowDelay)},hide:function(){this.animationClass&&s("body").removeClass(this.animationClass),this.editor.removeElementFromControlsCloseWhitelist(this.popover.getPopoverElement()),this.stopListening(this.editor,"controls:hide controls:close controls:embed:prompt controls:gif:prompt"),this.stopListening(this.popover),this.popover.hide(),this.trigger("hide",this)},hideWithDelay:function(){setTimeout(this.hide.bind(this),this.animationHideDelay)},_onInlineControlsShow:function(){this.showWithDelay()},_onInlineControlsClose:function(){this.hideWithDelay()},_onInlineControlsHide:function(){this.hide()},_onPopoverDismiss:function(){this.trigger("dismiss")},remove:function(){this.hide(),o.prototype.remove.apply(this,arguments)}});e.exports=r},{"components/popover":469,jquery:"HlZQrA",lodash:"MicNly","prima/component":511}],326:[function(t,e,i){"use strict";var s=t("lodash"),n=t("jquery"),o=t("prima/view"),a=t("prima/mixins/accessor"),r=t("prima/mixins/subviewable"),l=t("prima/mixins/selectorcache"),h=t("./plaintext_editor"),c=t("../templates/inline_embed_field.tpl"),u=o.extend({className:"post-form--inline-embed-field",template:c,mixins:[a,r,l],initialize:function(t){this.options=s.extend({},this.defaults,t)},show:function(){this.inlineEmbedInput.setEditorValue(""),s.defer(s.bind(function(){this.inlineEmbedInput.focus()},this));var t=this.options.calculateWidth();t="100%",this.$el.add(this.inlineEmbedInput.element).width(t),this.$el.addClass("open"),this.$el.closest(".tray").addClass("inline-embed-open")},hide:function(){this.$el.removeClass("open"),this.$el.closest(".tray").removeClass("inline-embed-open")},getCurrentValue:function(){return this.inlineEmbedInput?this.inlineEmbedInput.getEditorValue():""},createSubViews:function(){var t=s.extend({placeholder:this.options.placeholder,ariaLabel:this.options.placeholder,name:"inlineEmbedInput",forceSingleLine:!0,syncWithModel:!1,pasteHook:s.bind(this._onInputPaste,this),onChange:s.bind(this._onInputChange,this),onClientEvent:s.bind(this._onInputClientEvent,this)});this.inlineEmbedInput=this.subViews.inlineEmbedInput=new h(t)},_set_field_state_default:function(){n(this.inlineEmbedInput.editor.element).removeClass("invalid")},_set_field_state_invalid:function(){n(this.inlineEmbedInput.editor.element).addClass("invalid")},_onInputChange:function(t){this.getCurrentValue()!==this.get("embedCode")&&this._set_field_state_default()},_onInputPaste:function(){s.defer(s.bind(this.options.submitEmbedCode,this))},_onInputClientEvent:function(t){if("keydown"===t.type)switch(t.which||t.keyCode){case 27:t.preventDefault(),t.stopImmediatePropagation(),this.options.returnFocus(),this.hide();break;case 13:t.preventDefault(),t.stopImmediatePropagation(),this.options.submitEmbedCode()}},beforeRender:function(){this.$el.html(this.template()),this.createSubViews()},render:function(){return this.attachSubViews(),this}});e.exports=u},{"../templates/inline_embed_field.tpl":265,"./plaintext_editor":337,jquery:"HlZQrA",lodash:"MicNly","prima/mixins/accessor":542,"prima/mixins/selectorcache":553,"prima/mixins/subviewable":554,"prima/view":580}],327:[function(t,e,i){"use strict";var s=t("lodash"),n=t("./base"),o=t("../id3_editor"),a=t("../album_art_uploader"),r=t("app/components/remove-button"),l=t("./audio_player_shim"),h=t("../../templates/media/audio.tpl"),c=n.extend({className:"audio-media-container media-container",defaults:s.defaults({url:"",service:"",albumArt:"",type:"",id:""},n.prototype.defaults),events:{mouseenter:"_onHoverRemoveButton",mouseleave:"_onHoverRemoveButton"},template:h,beforeTeardown:function(){return delete this.audioPlayer,this.$el.removeClass(this.post.get("service")),this.$el.empty(),this},_onHoverRemoveButton:function(t){var e="mouseover"===t.type||"mouseenter"===t.type;this.js$("removeButton").toggleClass("active",e)},beforeRender:function(){this.removeButton=this.subViews.removeButton=new r({onClick:s.bind(function(){this.trigger("media:remove",this)},this),buttonClass:"top-right"}),this.$el.addClass(this.post.get("service")),"direct"===this.post.get("service")&&(this.post.canEditMedia()&&(this.id3Editor=this.subViews.id3Editor=new o(this.options),this.albumArtUploader=this.subViews.albumArtUploader=new a(s.defaults({url:this.post.get("albumArt")||""},this.options))),this.audioPlayer=this.subViews.audioPlayer=new l({extra_classes:null,post_id:"",service:"upload",lightbox:!1,preview:this.post.canEditMedia(),cover:this.post.get("albumArt"),tracks:[{stream_url:this.post.get("url"),cover:this.post.get("albumArt"),track:this.post.get("trackTitle"),artist:this.post.get("trackArtist"),album:this.post.get("trackAlbum")}]}))},afterRender:function(){this.listenTo(this.post,"change:url change:service",function(t){this.$el.removeClass(t.previous("service")),this.teardown().render()}),this.renderSubViews(),this.trigger("media:ready",this)}});e.exports=c},{"../../templates/media/audio.tpl":266,"../album_art_uploader":314,"../id3_editor":324,"./audio_player_shim":328,"./base":329,"app/components/remove-button":377,lodash:"MicNly"}],328:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/view"),o=t("prima/mixins/subviewable"),a=s.get(window,"Tumblr.AudioPlayer"),r=n.extend({mixins:[o],initialize:function(t){this.options=s.extend({},t)},teardown:function(){return this.audioPlayer.unbind_events(),this.$el.empty(),delete this.audioPlayer,this},render:function(){a||(a=s.get(window,"Tumblr.AudioPlayer"));var t=s.defaults({replace:null,append_to:null,prepend_to:this.$el},this.options);return this.audioPlayer=new a(t),this.options.preview&&this.audioPlayer.$container.addClass("has_art"),this.$el.toggleClass("audio-player--preview-player",this.options.preview),this}});e.exports=r},{lodash:"MicNly","prima/mixins/subviewable":554,"prima/view":580}],329:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/view"),o=t("prima/mixins/accessor"),a=t("prima/mixins/subviewable"),r=t("prima/mixins/selectorcache"),l=s.template(""),h=n.extend({className:"media-container",template:l,mixins:[o,a,r],defaults:{canEditMedia:!0},defaultOptions:{},initialize:function(t){this.options=t=s.extend({},this.defaultOptions,t),s.extend(this.attributes,s.pick(t,s.keys(this.defaults))),s.extend(this,s.pick(t,["post","user","uploads","dragEvents"])),s.isFunction(this.afterInitialize)&&this.afterInitialize.apply(this,arguments)},serialize:function(){return this.toJSON()},teardown:function(){return this.stopListening(),this},render:function(){return this.$el.html(this.template(this.serialize())),this.attachSubViews(),this}});e.exports=h},{lodash:"MicNly","prima/mixins/accessor":542,"prima/mixins/selectorcache":553,"prima/mixins/subviewable":554,"prima/view":580}],330:[function(t,e,i){"use strict";var s=t("lodash"),n=t("app/components/photoset/views/photo"),o=t("app/components/remove-button"),a=n.prototype.template,r=t("../../templates/media/edit_photo.tpl"),l=n.extend({className:"photoset--photo media-container",events:s.extend({mouseenter:"_onHoverMediaContainer",mouseleave:"_onHoverMediaContainer","click [data-js-clickthroughUrlButton]":"_onClickClickthroughUrlButton","click [data-js-captionButton]":"_onClickCaptionButton"},n.prototype.events),defaults:s.extend({enableClickthroughUrl:!1,hasClickthroughUrl:!1,enableCaption:!1,hasCaption:!1,isActive:!1},n.prototype.defaults),template:function(t){return a(t)+r(t)},_onHoverMediaContainer:function(t){clearTimeout(this._removeButtonActive);var e="mouseover"===t.type||"mouseenter"===t.type;e?(this.set("isActive",!0),this.trigger("photoset:hover",this,this.photo)):this._removeButtonActive=s.delay(s.bind(function(){this.set("isActive",!1)},this),500)},_onClickClickthroughUrlButton:function(t){this.photo.trigger("photo:editClickthroughUrl",this.photo,t.currentTarget)},_onClickCaptionButton:function(t){this.photo.trigger("photo:editCaption",this.photo,t.currentTarget)},_updateOverlayButtons:function(){this.js$("clickthroughUrlButton").css("display",this.get("enableClickthroughUrl")?"block":"none"),this.js$("captionButton").css("display",this.get("enableCaption")?"block":"none"),this.js$("clickthroughUrlButton").toggleClass("active",this.get("hasClickthroughUrl")),this.js$("captionButton").toggleClass("active",this.get("hasCaption"))},addStateListeners:function(){this.listenTo(this,"change:isActive",function(t,e){this.js$("removeButton").toggleClass("active",e),this.js$("mediaOverlay").toggleClass("active",e)}),this.listenTo(this,"photoset:unhover",function(t,e){this.set("isActive",!1)}),this.listenTo(this,"change:enableClickthroughUrl change:enableCaption",this._updateOverlayButtons),this.listenTo(this,"change:hasClickthroughUrl change:hasCaption",this._updateOverlayButtons),this.listenTo(this.photos,"add remove",function(){this.photos.length>1?this.js$("sortable").attr("draggable",!0):this.js$("sortable").removeAttr("draggable")}),this.post&&this.listenTo(this.post,"change:linkthrough",function(t,e){this.set("hasClickthroughUrl",!!e)}),this.listenTo(this.photo,"change:caption",function(t,e){this.set("hasCaption",!!e)})},beforeRender:function(){var t=this.photos.length>1;this.set("enableClickthroughUrl",!t),this.set("enableCaption",t),this.set("hasClickthroughUrl",this.post?!!this.post.get("linkthrough"):!1),this.set("hasCaption",!!this.photo.get("caption")),this.removeButton=this.subViews.removeButton=new o({onClick:s.bind(function(){this.photoset.removePhoto(this.photo.id)},this),buttonClass:"top-right"}),this.addStateListeners()},afterRender:function(){n.prototype.afterRender.apply(this,arguments),this.photos.length>1&&this.js$("sortable").attr("draggable",!0),this._updateOverlayButtons()}});e.exports=l},{"../../templates/media/edit_photo.tpl":267,"app/components/photoset/views/photo":213,"app/components/remove-button":377,lodash:"MicNly"}],331:[function(t,e,i){"use strict";var s=t("lodash"),n=t("./base"),o=t("prima/lib/translate"),a=t("app/components/photoset"),r=t("app/components/photoset/models/photo"),l=t("app/components/photoset/views/editable_photoset"),h=t("app/components/webcam"),c=t("./edit_photo"),u=t("prima/mixins/promisifyevents"),d=t("../overlay_input"),p=t("../../templates/media/photo.tpl"),m=n.extend({className:"media-container photo-media-container",template:p,mixins:[u],defaults:s.defaults({canPreview:!0,showPhotoBooth:!1,minFullWidthSize:{}},n.prototype.defaults),afterInitialize:function(){this.addStateListeners(),this._updatePhotosetView=s.debounce(this.updatePhotosetView,50)},addStateListeners:function(){this.listenTo(this.post.photos,"add",this._onPhotosAdd),this.listenTo(this.post.photos,"remove",this._onPhotosRemove),this.listenTo(this,"change:showPhotoBooth",function(t,e){e?(this._createPhotoBooth(),s.isString(e)&&this.photobooth.indexView.set("watermarkUrl",e),this.js$("photoset").css("display","none")):(this.stopListening(this.photobooth),this.photobooth.remove(),this.js$("photoset").css("display",""))})},updatePhotosetView:function(){this.photoset.model.fixLayout(),this.photoset.indexView.trigger("update",this.photoset.model.photos,this.photoset.model.get("layout"))},_onPhotosAdd:function(t,e){this.post.set("linkthrough",""),t=this._preparePhotosetPhotoModel(t),this.photoset.model.add(t),this._updatePhotosetView()},_onPhotosRemove:function(t,e){this.post.set("linkthrough",""),this.photoset.model.remove(t.id),this.updatePhotosetView()},_preparePhotosetPhotoModel:function(t){s.isFunction(t.toJSON)&&(t=t.toJSON()),t.url=t.displayUrl;var e=s.keys(r.prototype.defaults);return e.unshift("id"),s.pick(t,e)},_syncPostToPhotoset:function(t){t||(t=this.photoset.model);var e=this.post.photos.map(this._preparePhotosetPhotoModel,this);t.photos.reset(e),t.set("layout",this.post.get("layout"))},_createPhotoBooth:function(){var t=this.photobooth=new h;t.render(),this.listenTo(t,"webcam:image",function(t){t&&t.base64&&this.post.photos.unshift({photoRaw:t.base64.split("base64,")[1],base64:t.base64,isSelfie:!0,isSelfieGif:t.isGif||!1,
height:t.height,width:t.width})}),this.listenTo(t,"webcam:error",function(t){this.trigger("webcam:error",t)}),this.listenTo(t,"webcam:reset",function(){this.post.photos.shift()}),this.listenTo(t,"webcam:close",function(){this.post.photos.shift(),this.trigger("webcam:close")}),this.js$("photobooth").append(t.getElement())},_createPhotoset:function(){var t={dynamic:!0,padding:2,width:540,minFullWidthSize:this.get("minFullWidthSize"),addMargin:this.options.fullWidthInlineMedia};this.get("canEditMedia")&&(t.PhotosetView=l,t.PhotoView=c,t.post=this.post);var e=this.photoset=new a(t);return this._syncPostToPhotoset(e.model),this.get("canEditMedia")&&(this.listenTo(this.photoset,"change:layout",function(t,e){this.post.set("layout",e)}),this.listenTo(this.photoset,"sort",function(t){this.post.photos.setIdOrder(t.pluck("id"))}),this.listenTo(this.photoset,"photo:remove",function(t,e,i){this.set("layout",i),this.post.photos.remove(e)}),this.listenTo(this.photoset.indexView,"photoset:predrag",function(){this.overlayPopover&&this.overlayPopover.teardown()}),this.listenTo(this.photoset,"photo:editClickthroughUrl",this._createClickthroughUrlPopover),this.listenTo(this.photoset,"photo:editCaption",this._createCaptionPopover),this.listenTo(this.photoset,"change:caption",function(t,e){var i=this.post.photos.get(t.id);i&&i.set("caption",e)})),this.photoset.model.fixLayout(),e.render(),this.js$("photoset").append(e.getElement()),this.get("canEditMedia")&&this.listenTo(this.dragEvents,"drop",this._onDrop),e},_createClickthroughUrlPopover:function(t,e){this.overlayPopover&&(this.overlayPopover=this.overlayPopover.remove());var i=this.overlayPopover=new d({pinnedTarget:e,pinnedTargetContainer:this.photoset.getElement(),value:this.post.get("linkthrough"),ariaLabel:o("Clickthrough URL"),placeholder:"http://"});i.render(),this.listenTo(i,"change:value",function(t,e){e=s.trim(e||""),this.post.set("linkthrough",e)}),this.listenToOnce(i,"close",function(){this.stopListening(i),delete this.overlayPopover})},_createCaptionPopover:function(t,e){this.overlayPopover&&(this.overlayPopover=this.overlayPopover.remove());var i=this.overlayPopover=new d({pinnedTarget:e,pinnedTargetContainer:this.photoset.getElement(),maxLength:200,value:t.get("caption"),placeholder:o("Caption this photo"),updateShift:!1});i.render(),this.listenTo(i,"change:value",function(e,i){t.set("caption",s.trim(i||""))}),this.listenToOnce(i,"close",function(){this.stopListening(i),delete this.overlayPopover})},_onDrop:function(t){if(!s.isEmpty(this.$el.find(t.target))){t.preventDefault();var e=s.result(t.originalEvent.dataTransfer,"files");e&&this.trigger("media:addFiles",e)}},beforeTeardown:function(){this.photobooth&&(this.stopListening(this.photobooth),this.photobooth.remove()),delete this.photobooth,this.photoset&&(this.stopListening(this.photoset),this.photoset.remove()),delete this.photoset,this.overlayPopover&&(this.overlayPopover.remove(),this.stopListening(this.overlayPopover)),delete this.overlayPopover},afterRender:function(){this.js$("photobooth",!0),this.js$("photoset",!0),this._createPhotoset(),this.photobooth=!1,this.trigger("media:ready",this),this.renderSubViews()}});e.exports=m},{"../../templates/media/photo.tpl":268,"../overlay_input":335,"./base":329,"./edit_photo":330,"app/components/photoset":203,"app/components/photoset/models/photo":204,"app/components/photoset/views/editable_photoset":212,"app/components/webcam":392,lodash:"MicNly","prima/lib/translate":541,"prima/mixins/promisifyevents":551}],332:[function(t,e,i){"use strict";var s=t("lodash"),n=t("jquery"),o=t("when"),a=t("prima/utils/delayed"),r=t("./base"),l=t("prima/mixins/promisifyevents"),h=t("components/crt/player"),c=t("prima/lib/translate"),u=t("../../utils/scale_to_width"),d=t("app/components/remove-button"),p=t("../../templates/media/video.tpl"),m=t("../../templates/media/video_upload.tpl"),g=t("../../templates/media/video_embed.tpl"),f=t("../../templates/media/video_error.tpl"),_=r.extend({className:"media-container video-media-container",events:{mouseenter:"_onHoverRemoveButton",mouseleave:"_onHoverRemoveButton"},template:p,mixins:[l],defaults:s.defaults({canPreview:!0,file:!1,embed:!1,width:!1,height:!1},r.prototype.defaults),afterInitialize:function(){this.addStateListeners()},addStateListeners:function(){this.listenTo(this,"change",this._onChangeVideo),this.listenTo(this.post,"change:preuploadUrl",this._onChangePreuploadUrl)},_onHoverRemoveButton:function(t){var e="mouseover"===t.type||"mouseenter"===t.type;this.js$("removeButton").toggleClass("active",e)},_onChangeVideo:function(){(this.hasChanged("file")||this.hasChanged("embed")||this.hasChanged("canPreview"))&&(this.hasChanged("file")?this.attributes.embed=!1:this.hasChanged("embed")&&(this.attributes.file=!1),this.hasChanged("canPreview")||this.set("canPreview",!0),this.isRendered()&&(this.teardown(),this.render(),this.addStateListeners()))},_onChangePreuploadUrl:function(t,e){this._updateUploadPreview(e,this.get("file"))},_updateUploadPreview:function(t,e){var i=e&&e.name?'"'+e.name+'"':"";t?(this.js$("previewIcon").removeClass("video-uploading").addClass("video-check"),this.js$("previewMessage").html(c("Your video %1$s has been uploaded",i))):(this.js$("previewIcon").removeClass("video-check").addClass("video-uploading"),this.js$("previewMessage").html(c("Uploading your video %1$s",i)))},_createVideoPlayer:function(t){if(!this.get("canPreview"))return this.js$("video").html(m({icon:"",message:""})),void this._updateUploadPreview(this.post.get("preuploadUrl"),t);var e=540,i=this.get("width"),n=this.get("height"),a=i&&n?u(i,n,e):{width:e};s.extend(a,{file:t,techOrder:["html5"]});var r=this.player=new h(document.createElement("video"),{attributes:{watch:!1},vjsOptions:a}),l=!1,c=this.whenEvent(r,"ready");return c.then(function(){r.player.on("error",function(){l=!0,s.defer(function(){this.set("canPreview",!1),this.trigger("media:ready",this)}.bind(this))}.bind(this))}.bind(this)),o.join(this.whenEvent(r,"change:loaded"),c).then(function(){if(!l){this.js$("video").append(r.$el);var t={width:"auto",height:"auto"},i=r.$video.prop("videoWidth"),s=r.$video.prop("videoHeight");i&&s&&(t=u(i,s,e)),r.$el.css(t),this.trigger("media:ready",this)}}.bind(this)),r.render(),r},_createVideoEmbed:function(){var t=function(t){return n('<a href="'+t.get("blog_url")+'"></a>').prop("hostname")}(this.user.getChannel(this.post.get("tumblelog"))),e=this.get("embed"),i=s.extend({tumblelogHostname:t},e);this.js$("video").html(g(i)),"inline"===e.embedRenderContext?a(function(){this.trigger("media:ready",this)},250,this)():this.trigger("media:ready",this)},beforeTeardown:function(){this.player&&this.player.teardown(),delete this.player},beforeRender:function(){this.removeButton=this.subViews.removeButton=new d({onClick:function(){this.trigger("media:remove",this)}.bind(this),buttonClass:"top-right"})},afterRender:function(){this.js$("video",!0),this.renderSubViews(),this.player=!1,this.get("file")?this._createVideoPlayer(this.get("file")):this.get("embed")?s.isEmpty(this.get("embed"))?(this.js$("video").html(f()),this.trigger("media:ready",this)):this._createVideoEmbed(this.get("embed")):this.trigger("media:ready",this)}});e.exports=_},{"../../templates/media/video.tpl":269,"../../templates/media/video_embed.tpl":270,"../../templates/media/video_error.tpl":271,"../../templates/media/video_upload.tpl":272,"../../utils/scale_to_width":311,"./base":329,"app/components/remove-button":377,"components/crt/player":446,jquery:"HlZQrA",lodash:"MicNly","prima/lib/translate":541,"prima/mixins/promisifyevents":551,"prima/utils/delayed":566,when:"RG2dij"}],333:[function(t,e,i){"use strict";var s=t("lodash"),n=t("jquery"),o=t("prima/view"),a=(t("prima/lib/logger"),t("app/components/upload")),r=t("./plaintext_editor"),l=t("app/components/remove-button"),h=t("./tooltip"),c=t("prima/mixins/accessor"),u=t("prima/mixins/subviewable"),d=t("prima/mixins/selectorcache"),p=t("../templates/media_dropzone.tpl"),m=n(document),g=o.extend({className:"media-dropzone-container media-container",template:p,mixins:[c,u,d],defaults:{droppable:!1,showInput:!1,toggleDropzone:!1,dropzoneText:"",enableUpload:!0,enableUrl:!0,uploadIcon:"",uploadText:"",uploadTooltip:"",urlIcon:!1,urlText:"",urlTooltip:"",url:"",urlPlaceholder:"http://",urlAriaLabel:"http://"},defaultOptions:{uploadOptions:{},modelKey:!1,urlParser:!1,documentDrag:!0,parseOnUpload:!1,parseOnInput:!1,parseOnEnter:!0,parseOnPaste:!0,inputDebounceTime:250},events:{mouseenter:"_onHoverMediaContainer",mouseleave:"_onHoverMediaContainer","click [data-show-tooltip]":"_onClickShowTooltip","click [data-js-mediaUrl]":"_focusUrlInput"},initialize:function(t){this.options=t=s.extend({},this.defaultOptions,t),s.isString(t.dropzoneFineprint)&&(t.dropzoneFineprint=[t.dropzoneFineprint]),s.extend(this.attributes,s.pick(t,s.keys(this.defaults))),s.defaults(this.attributes,{defaultBehavior:this.get("enableUpload")?"upload":"url",dropzoneBehavior:this.get("enableUpload")?"upload":"url",splitDropzone:this.get("enableUpload")&&this.get("enableUrl")}),this.upload=new a(t.uploadOptions),t.modelKey&&this.listenTo(this.upload,"change:url",this._onUploadUrlChange),this.listenTo(this.upload,"add",function(t){this.trigger("upload:start",t)}),this.listenTo(this.upload,"complete",function(t,e){this.trigger("upload:complete",e)}),this.listenTo(this.upload,"error",function(t,e){this.trigger("upload:error",e)}),this.listenTo(this.upload,"invalid",function(t,e){this.trigger("upload:invalid",e)}),this.listenTo(this.upload,"allComplete",function(t,e){this.trigger("uploads:allComplete",t)}),this.listenTo(this,"change:droppable",function(t,e){this.js$("dropzone").toggleClass("droppable",e)}),this.listenTo(this,"change:showInput",function(t,e){e?(this.js$("dropzone").addClass("show-input"),this._onUrlInputChange()):(this.js$("dropzone").removeClass("show-input"),this.js$("dropzone").height(""),this.get("defaultBehavior")!==this.get("dropzoneBehavior")&&this.set("dropzoneBehavior",this.get("defaultBehavior")))}),this.listenTo(this,"url:complete",this._onUrlComplete),this.listenTo(this,"url:error",this._onUrlError),this.listenTo(this,"change:toggleDropzone",function(t,e){e?(this.js$("dropzone").addClass("toggle-dropzone"),this.js$("mediaUploadText").text(this.get("dropzoneText")),this.js$("mediaUrlText").text(this.get("dropzoneText"))):(this.js$("dropzone").removeClass("toggle-dropzone"),this.js$("mediaUploadText").text(this.get("uploadText")),this.js$("mediaUrlText").text(this.get("urlText")))}),this.listenTo(this,"change:dropzoneBehavior",function(t,e){this.js$("dropzone").removeClass("toggle-dropzone-upload toggle-dropzone-url").addClass("toggle-dropzone-"+e)}),this.__updateUrlFromInput=s.debounce(this._updateUrlFromInput,this.options.inputDebounceTime),this.__onDragOver=s.bind(this._onDragOver,this),this.__onDragLeave=s.bind(this._onDragLeave,this)},urlParser:function(t,e){return s.isFunction(this.options.urlParser)?this.options.urlParser(t,this,e):void 0},addFiles:function(t){return this.upload.addFiles(t)},_addDragStartListener:function(t){n(document).on("dragover.dropzone dragenter.dropzone",this.__onDragOver)},_removeDragStartListener:function(t){n(document).off("dragover.dropzone dragenter.dropzone",this.__onDragOver)},_addDragEndListener:function(t){n(document).on("mouseout.dropzone",this.__onDragLeave)},_removeDragEndListener:function(t){n(document).off("mouseout.dropzone",this.__onDragLeave)},_onDragOver:function(t){this._dragging=!0,this.set("droppable",!0),this._removeDragStartListener(),this._addDragEndListener()},_onDragLeave:function(t){this._dragging=!1,this.set("droppable",!1),this._addDragStartListener(),this._removeDragEndListener()},_onClickShowTooltip:function(t){var e=this.$(t.currentTarget).data("showTooltip"),i=s.result(this,e);i&&i instanceof h&&!i.isOrWasRecentlyRendered()&&i.render()},_focusUrlInput:function(t){return this.js$("removeButton").is(t.target)||this.js$("removeButton").find(t.target).length?!0:(this.set("showInput",!0),void(this.urlInput&&this.urlInput.focus()))},_onUploadUrlChange:function(t,e){this.model&&(this.model.set(this.options.modelKey,e),this.options.parseOnUpload&&this.urlParser(e,"upload"))},_updateUrlFromInput:function(){var t=this.urlInput?s.trim(this.urlInput.getEditorValue()||""):"";this.set("url",t)},_onUrlInputChange:function(){this.urlInput&&this.get("showInput")&&(this.js$("dropzone").height(this.urlInput.$el.height()),this.__updateUrlFromInput())},_onUrlInputClientEvent:function(t){if("keydown"===t.type)switch(t.which||t.keyCode){case 27:t.preventDefault(),t.stopImmediatePropagation(),this.set("showInput",!1),this.urlInput.setEditorValue(""),this.js$("dropzone").removeClass("has-error"),this.urlInput.blur();break;case 13:this.options.parseOnEnter&&!t.shiftKey?(t.preventDefault(),t.stopImmediatePropagation(),this._updateUrlFromInput(),this.urlParser(this.get("url"),"enter")):this.options.parseOnInput&&(this.urlParser(this.get("url")),this.listenToOnce(this,"change:url",function(t,e){this.urlParser(e,"input")}));break;default:this.js$("dropzone").removeClass("has-error"),this.options.parseOnInput&&(this.urlParser(this.get("url")),this.listenToOnce(this,"change:url",function(t,e){this.urlParser(e,"input")}))}},_onUrlInputPasteEvent:function(t,e){s.delay(s.bind(function(){this.options.parseOnPaste&&(this._updateUrlFromInput(),this.urlParser(this.get("url"),"paste"))},this),0)},_onUrlComplete:function(){this.js$("dropzone").removeClass("has-error")},_onUrlError:function(){this.js$("dropzone").addClass("has-error")},_onHoverMediaContainer:function(t){clearTimeout(this._removeButtonActive);var e="mouseover"===t.type||"mouseenter"===t.type;e?this.js$("removeButton").addClass("active"):this._removeButtonActive=s.delay(s.bind(function(){this.js$("removeButton").removeClass("active")},this),500)},serialize:function(){return s.mapValues(this.toJSON(),function(t,e){return s.isFunction(t)&&e.match(/^(upload|url)(Icon|Text|Tooltip)$/)?t():t},this)},beforeTeardown:function(){this.upload.getElement().detach(),this.subViews.upload=void 0,m.off("keydown.postForm.dropzone keyup.postForm.dropzone")},afterTeardown:function(){this.uploadTooltip&&this.uploadTooltip.remove(),this.urlTooltip&&this.urlTooltip.remove(),delete this.uploadTooltip,delete this.urlTooltip,delete this.urlInput,delete this.urlInput,delete this.removeButton,this._removeDragStartListener(),this._removeDragEndListener()},beforeRender:function(){if(this.subViews.upload=this.upload.indexView,this.get("enableUrl")){var t={placeholder:this.get("urlPlaceholder"),name:"url",ariaLabel:this.get("urlAriaLabel"),syncWithModel:!1,onChange:s.bind(this._onUrlInputChange,this),onClientEvent:s.bind(this._onUrlInputClientEvent,this),pasteHook:s.bind(this._onUrlInputPasteEvent,this)};s.defaults(t,s.pick(this.options,s.keys(t))),this.urlInput=this.subViews.urlInput=new r(t),this.removeButton=this.subViews.removeButton=new l({onClick:s.bind(function(){this.set("showInput",!1),this.urlInput.setEditorValue(""),this.js$("dropzone").removeClass("has-error")},this),buttonClass:"top-right"})}m.on("keydown.postForm.dropzone keyup.postForm.dropzone",s.bind(function(t){switch(t.which||t.keyCode){case 18:var e=this.get("defaultBehavior"),i="url"===e?"upload":"url";"keydown"===t.type?this.set("dropzoneBehavior",i):this.get("showInput")||this.set("dropzoneBehavior",e)}},this)),this.options.documentDrag&&this._addDragStartListener()},afterRender:function(){this.get("enableUrl")&&this.urlInput.setEditorValue(this.get("url")||""),this.get("enableUpload")&&this.get("uploadTooltip")&&(this.uploadTooltip=new h({className:"dropzone-tooltip-popover",sanitize:!1,text:s.result(this.attributes,"uploadTooltip")}),this.uploadTooltip.setPinnedTarget(this.js$("uploadTooltip"))),this.get("enableUrl")&&this.get("urlTooltip")&&(this.urlTooltip=new h({className:"dropzone-tooltip-popover",sanitize:!1,text:s.result(this.attributes,"urlTooltip")}),this.urlTooltip.setPinnedTarget(this.js$("urlTooltip"))),this.renderSubViews()},render:function(){return this.$el.html(this.template(this.serialize())),this.attachSubViews(),this}});e.exports=g},{"../templates/media_dropzone.tpl":273,"./plaintext_editor":337,"./tooltip":362,"app/components/remove-button":377,"app/components/upload":389,jquery:"HlZQrA",lodash:"MicNly","prima/lib/logger":519,"prima/mixins/accessor":542,"prima/mixins/selectorcache":553,"prima/mixins/subviewable":554,"prima/view":580}],334:[function(t,e,i){"use strict";var s=t("lodash"),n=t("jquery"),o=t("prima/view"),a=t("prima/events"),r=t("../models/mention"),l=t("prima/mixins/accessor"),h=t("prima/mixins/popoverbase"),c=t("prima/mixins/selectorcache"),u=t("../templates/mention_dropdown.tpl"),d=function(){},p=o.extend({className:"popover--mention-dropdown",defaults:{currentKeyedChoice:-1,currentMousedChoice:-1,interactive:!1,lastResults:{},debugMode:!1},mixins:[l,c,h],template:u,initialize:function(){this.model=new r,this.listenTo(this,"change:lastResults",this.preRender),d=s.bind(d,this)},preRender:function(t,e){var i=(e.blogs||[]).length;d("MentionDropdown - PreRender with %d results.",i),this.set({currentKeyedChoice:-1,currentMousedChoice:-1,interactive:!1}),i?(this._rendered&&this.teardown(!0),this.set("numSuggestions",i),this.render(e)):this.trigger("dropdown:empty")},render:function(t){return d("MentionDropdown - Render"),this.$el.html(this.template(t)),this.trigger("dropdown:render"),a.trigger("postForms:dismissListener:suspend"),this},afterRender:function(){n(".item-option",this.$el).on("mousedown",s.bind(this.handleMouseClick,this)),n(".item-option",this.$el).on("mouseover",s.bind(this.handleMouseOver,this)),this.$el.on("mouseout",s.bind(this.handleMouseOut,this))},teardown:function(t){return this.$el.remove(),t||this.set({interactive:!1,lastResults:{}}),a.trigger("postForms:dismissListener:resume"),this},updateMentionDropdown:function(t,e,i){d("MentionDropdown - fetch callback",e),this.set("lastResults",e)},cycleUp:function(){this._cycle(-1)},cycleDown:function(){this._cycle(1)},_cycle:function(t){var e=this.get("currentKeyedChoice"),i=this.get("currentMousedChoice"),n=s.isNumber(i)&&-1!==i,o=n?i:e,a=this.get("numSuggestions"),r=(o+t)%a;a&&(this.set({currentKeyedChoice:0>r?a-1:r,currentMousedChoice:-1}),this.styleMenuItems(),this.set("interactive",this.get("currentKeyedChoice")>=0),this.trigger("dropdown:menuInteraction",!0))},styleMenuItems:function(t){var e,i=t&&"mouseout"!==t.type,o=this.get("currentKeyedChoice");s.each(n(".item-option",this.$el),function(s,a){i?n(s).toggleClass("cycled",t.currentTarget===s):(n(s).toggleClass("cycled",a===o),a===o&&(e=n(s)))},this)},handleMouseOver:function(t){var e=n(t.currentTarget).index(".item-option");this.styleMenuItems(t),this.set({interactive:!0,currentMousedChoice:e}),this.trigger("dropdown:menuInteraction",!0)},handleMouseOut:function(t){var e=-1!==this.get("currentKeyedChoice");this.styleMenuItems(t),this.set({interactive:e,currentMousedChoice:-1}),this.trigger("dropdown:menuInteraction",e)},handleMouseClick:function(t){this.set("interactive",!0),n(t.currentTarget).addClass("cycled"),this.trigger("dropdown:confirm")},getCurrentBlogChoice:function(){var t=this.get("lastResults");if(!this._rendered||s.isEmpty(t)||!("blogs"in t))return!1;var e=this.get("currentMousedChoice"),i=this.get("currentKeyedChoice"),n=0;return e>=0?n=e:i>=0&&(n=i),t.blogs[n]},getBlogChoice:function(t){var e=this.get("lastResults");return!1===s.isEmpty(e)&&"blogs"in e&&e.blogs[t]?e.blogs[t]:!1}});e.exports=p},{"../models/mention":238,"../templates/mention_dropdown.tpl":274,jquery:"HlZQrA",lodash:"MicNly","prima/events":512,"prima/mixins/accessor":542,"prima/mixins/popoverbase":550,"prima/mixins/selectorcache":553,"prima/view":580}],335:[function(t,e,i){"use strict";var s=t("lodash"),n=t("jquery"),o=t("when"),a=t("velocity-animate").animate,r=t("app/components/post-form-builder/utils/transition_speed"),l=t("prima/lib/translate"),h=t("prima/view"),c=t("prima/mixins/selectorcache"),u=t("prima/mixins/accessor"),d=t("prima/mixins/popoverbase"),p=t("../templates/overlay_input.tpl"),m=h.extend({className:"overlay-input-popover",mixins:[c,u,d],template:p,events:{"keydown [data-js-input]":"_onKeyDown","input [data-js-input]":"_onInput","keyup [data-js-input]":"_onInput","change [data-js-input]":"_onInput","click [data-js-confirm]":"_onClickConfirm"},defaultOptions:{updateValueOnInput:!1,updateValueOnClose:!0,updateShift:!0},defaults:{value:"",placeholder:"",ariaLabel:"",maxLength:2048,confirmText:l("Done")},initialize:function(t){this.options=t=s.extend({},this.defaultOptions,t),s.extend(this.attributes,s.pick(t,s.keys(this.defaults))),this.$pinnedContainer=n(t.pinnedTargetContainer)},_onKeyDown:function(t){switch(t.which||t.keyCode){case 13:this._onClickConfirm();break;case 27:t.stopPropagation(),this.teardown()}},_onInput:function(){this.options.updateValueOnInput&&this._updateValueFromInput()},_onClickConfirm:function(){this._updateValueFromInput(),this.teardown()},_updateValueFromInput:function(){var t=this.js$("input").val();this.set("value",t)},openAnimation:function(t){s.isNumber(t)||(t=r(100)),this._startWidth=this.$pinned.outerWidth(),this.js$("popover").width(this._startWidth);var e=this.$pinned.position().left;return s.isEmpty(this.$pinnedContainer)?this._offsetLeft=0:this._offsetLeft=this.$pinnedContainer.offset().left-this.$pinned.offset().left+e||0,this.options.updateShift&&this.setShift(s.defaults({x:this._offsetLeft},this.getShift())),o.all([a(this.$pinned,{opacity:0},{display:"none",duration:t}),a(this.js$("confirm"),{opacity:1},{duration:t}),a(this.js$("popover"),{marginLeft:this._offsetLeft,width:this._targetWidth},{duration:t})])},pinnedRect:function(){var t=this.$pinned.css("display");this.$pinned.css("display","block");var e=d.properties.defaults.pinnedRect.apply(this,arguments);return this.$pinned.css("display",t),e},closeAnimation:function(t){return s.isNumber(t)||(t=r(100)),o.all([a(this.$pinned,{opacity:1},{display:"block",duration:t}),a(this.js$("confirm"),{opacity:0},{duration:t}),a(this.js$("popover"),{marginLeft:0,width:this._startWidth},{duration:t})])},serialize:function(t){return this.toJSON()},render:function(){return this.$el.html(this.template(this.serialize())),s.isEmpty(this.$pinnedContainer)?this._targetWidth=520:this._targetWidth=this.$pinnedContainer.outerWidth()-20,this.setPinnedSide(!1),s.defer(s.bind(function(){this.openAnimation().then(s.bind(function(){this.js$("input").focus()},this))},this)),this},teardown:function(){return this.options.updateValueOnClose&&this._updateValueFromInput(),this.stopListening(),this.closeAnimation().then(s.bind(function(){this.remove()},this)),this}});e.exports=m},{"../templates/overlay_input.tpl":275,"app/components/post-form-builder/utils/transition_speed":225,jquery:"HlZQrA",lodash:"MicNly","prima/lib/translate":541,"prima/mixins/accessor":542,"prima/mixins/popoverbase":550,"prima/mixins/selectorcache":553,"prima/view":580,"velocity-animate":"lWl/mc",when:"RG2dij"}],336:[function(t,e,i){"use strict";var s=t("lodash"),n=t("./media_dropzone"),o=t("./webcam_button"),a=t("app/components/webcam/utils/get_user_media"),r=n.extend({defaults:s.extend({enableSelfie:a},n.prototype.defaults),events:s.extend({"click [data-js-webcamButton]":"_onClickWebcamButton"},n.prototype.events),_onClickWebcamButton:function(){this.trigger("webcam:show")},afterRender:function(){if(n.prototype.afterRender.apply(this,arguments),this.get("enableSelfie")){var t=this.subViews.webcamButton=new o;t.render().$el.appendTo(this.js$("mediaUpload").children(".split-cell-inner")),this.listenTo(this,"change:enableSelfie",function(e,i){i||(t.teardown().remove(),this.subViews.webcamButton=null,this.stopListening(this,"change:enableSelfie"))})}}});e.exports=r},{"./media_dropzone":333,"./webcam_button":367,"app/components/webcam/utils/get_user_media":397,lodash:"MicNly"}],337:[function(t,e,i){"use strict";var s=t("lodash"),n=t("jquery"),o=t("prima/view"),a=t("prima/events"),r=t("ligature"),l=t("prima/mixins/subviewable"),h=t("prima/mixins/selectorcache"),c=t("prima/mixins/accessor"),u=t("../templates/plaintext_editor.tpl"),d=o.extend({defaults:{placeholder:"",name:"",syncWithModel:!0,forceSingleLine:!1,smartQuotesEnabled:!1},events:{},mixins:[c,l,h],template:u,initialize:function(t){this.set(t),this.onChange=t.onChange||s.noop,this.onClientEvent=t.onClientEvent||s.noop,this.pasteHook=t.pasteHook||s.noop,this.smartQuotesEnabled=t.smartQuotesEnabled,this.disableEdit=t.disableEdit||!1;var e=this.get("name");e&&this.get("syncWithModel")&&this.$el.attr("data-name",e)},_initializeEditor:function(t,e){var i={placeholder:e,onChange:this._composeOnChange(),onClientEvent:this._composeOnClientEvent(),pasteHook:this.pasteHook,runIFrameSanitization:!0,forceSingleLine:this.get("forceSingleLine"),filterRules:{elements:["p","br"],attributes:{},remove_contents:["style","noscript","script","meta"],protocols:{}},smartQuotes:{enabled:this.smartQuotesEnabled}};this.editor=new r.PlainTextEditor(t,i),this.disableEdit&&this.disable()},_composeOnChange:function(){var t=[this.onChange],e=this;return this.get("syncWithModel")&&t.unshift(this.updateModelFromEditor),function(i){s.each(t,function(t){t.call(e,i)})}},_composeOnClientEvent:function(){var t=this.onClientEvent,e=this;return function(i){a.trigger("plainTextEditor:onClientEvent",i,e.editor),t.call(this,i)}},render:function(){this.$el.html(this.template({ariaLabel:this.get("ariaLabel")}));var t=this.js$("plainTextEditor").get(0);if(this._initializeEditor(t,this.get("placeholder")),this.get("syncWithModel")){var e=this._modelValue().length>0;e&&this.set("placeholder",!1),this.updateEditorFromModel()}return this},teardown:function(){return this.$el.empty(),delete this.editor,this},serialize:function(){return this.toJSON()},getEditorValue:function(t){return"undefined"!=typeof t||(t=!0),this.editor?this.editor.getData(t):null},setEditorValue:function(t){this.editor&&this.editor.setData(t)},updateModelFromEditor:function(){if(!this.editor)return!1;var t=this.get("name"),e=this.getEditorValue();""!==e?n(this.editor.element).addClass("has-text"):n(this.editor.element).removeClass("has-text"),this.model.get(t)!==e&&this.model.set(t,e)},updateEditorFromModel:function(){var t=this.getEditorValue(),e=this._modelValue();e.trim()&&e.trim()!==t.trim()&&this.setEditorValue(e)},_modelValue:function(){return this.model.get(this.get("name"))||""},focus:function(t){this.editor&&this.editor.focus(t)},blur:function(){this.editor&&this.editor.element.blur()},setCursorToEnd:function(){this.editor&&s.isFunction(this.editor.setCursorToEnd)&&this.editor.setCursorToEnd()},enable:function(){n(this.editor.element).attr("contenteditable",!0)},disable:function(){n(this.editor.element).removeAttr("contenteditable")}});e.exports=d},{"../templates/plaintext_editor.tpl":276,jquery:"HlZQrA",ligature:620,lodash:"MicNly","prima/events":512,"prima/mixins/accessor":542,"prima/mixins/selectorcache":553,"prima/mixins/subviewable":554,"prima/view":580}],338:[function(t,e,i){"use strict";var s=t("lodash"),n=t("jquery"),o=t("when"),a=t("velocity-animate").animate,r=t("prima/utils/sequence-with-context"),l=t("prima/utils/bindendevent"),h=t("prima/lib/translate"),c=t("prima/view"),u=t("prima/events"),d=t("prima/mixins/subviewable"),p=t("prima/mixins/selectorcache"),m=t("prima/mixins/accessor"),g=t("./avatar"),f=t("./tumblelog_select"),_=t("./post_settings"),v=t("./tag_editor"),b=t("./editor_buttons"),y=t("./social_buttons"),w=t("./save_post_button"),x=t("./allow_answers"),C=t("./error_bar"),k=t("./uploading_indicator"),S=t("./richtext_editor_tutorial"),T=t("./inline-controls-tutorial"),E=t("../services/content_stats_support"),P=t("./post_type_form/_create"),M=t("../templates/post_form.tpl"),F=c.extend({className:"post-form",defaults:{useMediaReady:!1,showFooter:!0,hideControlsLine:!1,enabled:!0,locked:!1,saving:!1,hasRichTextTutorial:!1,hasInlineControlsTutorial:!1,hasImageSearchTutorial:!1,showRichTextTutorial:!1,showInlineControlsTutorial:!1,showImageSearchTutorial:!1,disablePhotoFromUrl:!1,closeLabel:null},events:{"click [data-js-clickableClose]":"_onClickClose","click [data-js-clickableSave]":"_onClickSave","mousedown [data-js-clickableClose]":"cancelEditorBlur","mousedown [data-js-clickableSave]":"cancelEditorBlur",keydown:"_onKeyDown"},mixins:[d,p,m],template:M,_setup:function(){this.defaults.closeLabel=h("Close")},initialize:function(t){this.options=t=s.extend({},t),s.extend(this.attributes,s.pick(t,s.keys(this.defaults))),s.extend(this,s.pick(t,"post","user","uploads","dragEvents")),s.extend(this.attributes,s.pick(this.post.attributes,["mode"])),this.__onBeforeUnload=s.bind(this._onBeforeUnload,this)},_targetHandlesDrag:function(t){var e=n(t);return s.isEmpty(e.closest(".editable-photoset"))&&s.isEmpty(e.closest(".media-dropzone"))&&s.isEmpty(e.closest("input"))&&s.isEmpty(e.closest('[contenteditable="true"]'))?!1:!0},_onDragOver:function(t){this._targetHandlesDrag(t.target)&&!s.isEmpty(t.originalEvent.dataTransfer.files)&&(t.originalEvent.dataTransfer.dropEffect="copy"),t.preventDefault()},_onDrop:function(t){this._targetHandlesDrag(t.target)||t.preventDefault()},_onModelChange:function(){this.subViews.errorBar.hideErrorBar()},_onChangeHideControlsLine:function(t,e){this.$el.toggleClass("no-controls-line",e)},_onChangeShowFooter:function(t,e){this.isRendered()&&(e?this.js$("footer").css({display:"block",opacity:1}):this.js$("footer").css({display:"none",opacity:0}))},_onChangeEnabled:function(t,e){e?this.$el.removeClass("no-pointer-events"):this.$el.addClass("no-pointer-events")},_onChangeLocked:function(t,e){e?this.$$(".post-form--guard").addClass("visible"):this.$$(".post-form--guard").removeClass("visible")},_onClickClose:function(t){this.options.redirectTo?(n(window).off("beforeunload",this.__onBeforeUnload),window.location=this.options.redirectTo):(this.resumeEditorBlur(),u.trigger("postForms:close"))},_onClickSave:function(t){this.resumeEditorBlur(s.bind(this.save,this))},_onTypeSwitch:function(t,e){this.post.set("type",t),this.trigger("postForms:changePostType",e)},_getCurrentRichTextEditor:function(){return this.postTypeForm?this.postTypeForm.getRichTextEditor():void 0},_getEditorType:function(){return this.model.get("editorType")||"rich"},_sendTutorialReadFlag:function(){n.ajax({url:"/svc/post/set_seen_rte",type:"POST",with_form_key:!0})},_setHasTutorialStates:function(){var t=s.contains(["text","photo","audio","video","link"],this.post.get("type"));this.set("hasRichTextTutorial",t&&this.user.get("hasRichTextTutorial")),this.set("hasInlineControlsTutorial",t&&this.user.get("hasInlineControlsTutorial")),this.set("hasImageSearchTutorial",t&&this.user.get("hasImageSearchTutorial"))},_setShowRichTextTutorialState:function(){this.set("showRichTextTutorial",this.get("hasRichTextTutorial")&&"rich"===this._getEditorType()&&this.get("showFooter"))},_setShowInlineControlsTutorialState:function(){this.set("showInlineControlsTutorial",this.get("hasInlineControlsTutorial")&&"rich"===this._getEditorType()&&!this.get("hasRichTextTutorial"))},_setShowImageSearchTutorialState:function(){this.set("showImageSearchTutorial",this.get("hasImageSearchTutorial")&&"rich"===this._getEditorType()&&this.get("showFooter"))},_onChangeHasRichTextTutorial:function(t,e){this.$el.toggleClass("has-richtext-tutorial",e)},_onChangeShowRichTextTutorial:function(t,e){this.$el.toggleClass("show-richtext-tutorial",e),e&&this.user.get("hasRichTextTutorial")&&(this._sendTutorialReadFlag(),this.user.set("hasRichTextTutorial",!1))},_onRichTextTutorialRemoved:function(t){var e,i=function(t){this.set("hasRichTextTutorial",!1),this.$el.removeClass("closing-richtext-tutorial")};this.stopListening(t),this.stopListening(this,"change:showFooter",this._setShowRichTextTutorialState),this.stopListening(this.model,"change:editorType",this._setShowRichTextTutorialState),this.options.isModal?s.defer(function(){l.animation(this.$el,i.bind(this)),this.$el.addClass("closing-richtext-tutorial");
}.bind(this)):i.call(this),e=this._getCurrentRichTextEditor(),e&&e.focus(),this.set("showRichTextTutorial",!1)},_onInlineControlsTutorialHide:function(t){this.stopListening(t),this.stopListening(this,"change:hasRichTextTutorial",this._setShowInlineControlsTutorialState),this.stopListening(this.model,"change:editorType",this._setShowInlineControlsTutorialState),this.user.set("hasInlineControlsTutorial",!1),t.remove()},_onImageSearchTutorialHide:function(t){this.stopListening(t),this.stopListening(this.model,"change:editorType",this._setShowImageSearchTutorialState),this.user.set("hasImageSearchTutorial",!1),this._sendTutorialReadFlag(),t.remove()},_onChangeShowInlineControlsTutorial:function(t,e){var i=this._getCurrentRichTextEditor(),s=this.options.supportImageSearch,n=s?"animate-inline-controls-tutorial":"animate-inline-controls-tutorial-original",o=h(s?"Click the plus sign to insert photos, videos, reaction GIFs, horizontal lines, or read-more links.":"Click the plus sign to insert photos, videos, horizontal lines, or read-more links.");e&&i?(this.inlineControlsTutorial=new T({richTextEditor:i,animationClass:n,animationShowDelay:"text"===this.post.get("type")?500:750,title:h("But wait, there's more"),content:o}),this.listenToOnce(this.inlineControlsTutorial,"hide",this._onInlineControlsTutorialHide)):this.inlineControlsTutorial&&(this.inlineControlsTutorial.remove(),this.inlineControlsTutorial=null)},_onChangeShowImageSearchTutorial:function(t,e){var i=this._getCurrentRichTextEditor();e&&i?(this.imageSearchTutorial=new T({richTextEditor:i,animationClass:"animate-image-search-tutorial",animationShowDelay:"text"===this.post.get("type")?500:750,title:h("GIF your words"),content:h("Hit this button. Type a word. Pick a GIF. Express thyself."),buttonLabel:h("Dare thee try it?")}),this.listenToOnce(this.imageSearchTutorial,{hide:this._onImageSearchTutorialHide,dismiss:function(){i.openImageSearch()}})):this.imageSearchTutorial&&(this.imageSearchTutorial.remove(),this.imageSearchTutorial=null)},_createContentStatsSupport:function(){this.contentStatsSupport&&this.contentStatsSupport.remove(),this.contentStatsSupport=new E({model:this.model,editor:this._getCurrentRichTextEditor()})},getRect:function(){var t=this.$el.css("display");this.$el.css("display","block");var e=this.$el.offset(),i={};return i.offsetTop=e.top,i.offsetLeft=e.left,i.offsetHeight=this.$el.outerHeight(),i.offsetWidth=this.$el.outerWidth(),this.$el.css("display",t),i},measureHeight:function(){if(!this.isRendered())return void 0;var t=this.$el.css("display");this.$el.css("display","block");var e=this.$el.outerHeight();return this.$el.css("display",t),e},animateShow:function(t,e){t||(t=0),e||(e=0),t||this.js$("container-outer").css("opacity",1);var i=[a(this.js$("container-outer"),{opacity:[1,0]},{duration:t}),a(this.js$("container-inner"),{translateY:[0,10]},{duration:t,delay:e,complete:function(t){n(t).removeAttr("style")}})];return this.options.isModal&&i.push(a(this.js$("margin"),{opacity:[1,0]},{duration:t})),this.avatar&&this.avatar.updateViewState(),o.all(i)},animateHide:function(t,e){t||(t=0),e||(e=0),t||this.js$("container-outer").css("opacity",0),this.options.isModal||this.avatar.resetAvatar();var i=[];return this.js$("container-outer").length&&this.js$("container-inner").length&&(i.push(a(this.js$("container-outer"),{opacity:[0,1]},{duration:t})),i.push(a(this.js$("container-inner"),{translateY:[10,0]},{duration:t,delay:e}))),this.options.isModal&&this.js$("margin").length&&i.push(a(this.js$("margin"),{opacity:[0,1]},{duration:t})),o.all(i)},forceHidden:function(){return this.js$("container-outer").css("opacity",0),this.options.isModal&&this.js$("margin").css("opacity",0),a(this.js$("container-inner"),{translateY:[10,10]},{duration:0}),this},save:function(t){if(!this.get("saving")||t){var e;u.trigger("postForms:saving"),this.subViews.errorBar.hideErrorBar();var i=r([function(){!1===this.model.isValid()},function(){this.set({enabled:!1,locked:!0,saving:!0})},function(){},function(){try{this.model.set("contentStats",this.contentStatsSupport.getStats())}catch(t){}return e=this.model.save(this.options)},function(){this.set({enabled:!1,locked:!0,saving:!1,saved:!0})}],this).then(s.bind(function(t){if(t=t.filter(function(t){return t}),t.length&&(t=t[0]),s.isEmpty(t.errors)){if(this.options.redirectTo)n(window).off("beforeunload",this.__onBeforeUnload),window.location=this.options.redirectTo;else if(u.trigger("postForms:saved",{},e),"reblog"===this.model.get("mode")){var i=this.model.get("reblog_id"),o=window.Tumblr.Posts.find({id:i});o&&(o.updateReblogControl(),u.trigger("post:reblog:set",{model:o}))}}else{var a=[];for(var r in t.errors)a.push(s.escape(t.errors[r]));this.set({enabled:!0,locked:!1,saving:!1,saved:!1});var l=a.join("<br>");this.subViews.errorBar.showErrorBar(l),u.trigger("postForms:error")}},this));return i["catch"](s.bind(function(t){this.set({enabled:!0,locked:!1,saving:!1,saved:!1}),u.trigger("postForms:error")},this)),i}},createSubViews:function(){var t,e=["showPhotoBooth","supportImageSearch","minFullWidthSize","popoverContainer","dragEvents"],i=s.extend({user:this.user,post:this.post,uploads:this.uploads,model:this.model},s.pick(this.options,e),this.attributes),n=this.post.get("tumblelog");this.avatar=this.subViews.avatar=new g(s.extend(this.options.isModal?{}:{determineViewState:!1,showSubavatar:this.user.getChannel(n).get("show_author_avatar"),avatarUrl:this.user.getChannel(n).get("avatar_url")},i)),this.tumblelogSelect=this.subViews.tumblelogSelect=new f(i),this.postSettings=this.subViews.postSettings=new _(i),this.tagEditor=this.subViews.tagEditor=new v(i),this.editorButtons=this.subViews.editorButtons=new b(i),this.socialButtons=this.subViews.socialButtons=new y(i),this.savePostButton=this.subViews.savePostButton=new w(i),this.uploadIndicator=this.subViews.uploadingIndicator=new k(i),t=s.extend({},i,{tagEditor:this.tagEditor}),this.postTypeForm=this.subViews.postTypeForm=P(t),this.set("useMediaReady",this.postTypeForm.get("hasMediaView")),this.listenTo(this.postTypeForm,"media:ready",function(){var t=s.toArray(arguments);t.unshift("media:ready"),this.trigger.apply(this,t)}),this.set("hideControlsLine",this.postTypeForm.get("hideControlsLine")),this.listenTo(this.postTypeForm,"change:hideControlsLine",function(t,e){this.set("hideControlsLine",e)}),this.postTypeForm.has("showCaption")&&(this.set("showFooter",this.postTypeForm.get("showCaption")),this.listenTo(this.postTypeForm,"change:showCaption",function(t,e){this.set("showFooter",e)})),this.listenTo(u,"postForms:tumblelogSelectDropdown:open",function(){this.trigger("checkScrollSize"),this.trigger("pauseScrollHelper")}),this.listenTo(u,"postForms:tumblelogSelectDropdown:close",function(){this.trigger("checkScrollSize",!0),this.trigger("resumeScrollHelper")}),this.listenTo(this.savePostButton,"dropdown:intent",this.cancelEditorBlur),this.post.allowsTypeSwitch()&&this.listenTo(this.postTypeForm,"switchPostType",this._onTypeSwitch),this.subViews.allowAnswers=new x(i),this.subViews.errorBar=new C,this._setHasTutorialStates(),this._setShowRichTextTutorialState(),this._setShowInlineControlsTutorialState(),this._setShowImageSearchTutorialState(),this.get("hasRichTextTutorial")&&(this.richTextEditorTutorial=this.subViews.richTextEditorTutorial=new S,this.listenToOnce(this.richTextEditorTutorial,"removed",this._onRichTextTutorialRemoved),this.listenTo(this,"change:showFooter",this._setShowRichTextTutorialState),this.listenTo(this.model,"change:editorType",this._setShowRichTextTutorialState)),this.get("hasInlineControlsTutorial")&&(this.listenTo(this,"change:hasRichTextTutorial",this._setShowInlineControlsTutorialState),this.listenTo(this.model,"change:editorType",this._setShowInlineControlsTutorialState)),this.get("hasImageSearchTutorial")&&(this.listenTo(this,"change:showFooter",this._setShowImageSearchTutorialState),this.listenTo(this.model,"change:editorType",this._setShowImageSearchTutorialState))},addStateListeners:function(){this.listenTo(this,"change:hideControlsLine",this._onChangeHideControlsLine),this.listenTo(this,"change:showFooter",this._onChangeShowFooter),this.listenTo(this,"change:enabled",this._onChangeEnabled),this.listenTo(this,"change:locked",this._onChangeLocked),this.listenTo(this.model,"change",this._onModelChange),this.listenTo(this.dragEvents,"dragover",this._onDragOver),this.listenTo(this.dragEvents,"drop",this._onDrop),this.listenTo(this.tagEditor,"postForms:focusOnNextEditor",this.focusOnNextEditor),this.listenTo(this,"change:showRichTextTutorial",this._onChangeShowRichTextTutorial),this.listenTo(this,"change:hasRichTextTutorial",this._onChangeHasRichTextTutorial),this.listenTo(this,"change:showInlineControlsTutorial",this._onChangeShowInlineControlsTutorial),this.listenTo(this,"change:showImageSearchTutorial",this._onChangeShowImageSearchTutorial)},serialize:function(){return this.toJSON()},beforeRender:function(){this.dragEvents.start(),this.createSubViews(),this.addStateListeners(),n(window).on("beforeunload",this.__onBeforeUnload)},render:function(){return this.$el.html(this.template(this.serialize())),this.attachSubViews(),this.post.get("type")&&this.$el.addClass("post-form--"+this.post.get("type")),this.user.get("hasGifSearchVariation")&&this.$el.addClass("gif-search-variation"),this},afterRender:function(){this.$el.toggleClass("no-controls-line",this.get("hideControlsLine")),this.get("showFooter")||this.js$("footer").css({display:"none",opacity:0}),this.renderSubViews(),this._onChangeHasRichTextTutorial(this,this.get("hasRichTextTutorial")),this._onChangeShowRichTextTutorial(this,this.get("showRichTextTutorial")),this._onChangeShowInlineControlsTutorial(this,this.get("showInlineControlsTutorial")),this._onChangeShowImageSearchTutorial(this,this.get("showImageSearchTutorial")),this._createContentStatsSupport()},teardown:function(){return this.dragEvents.stop(),this.stopListening(),this.contentStatsSupport&&this.contentStatsSupport.remove(),this.inlineControlsTutorial&&this.inlineControlsTutorial.remove(),n(window).off("beforeunload",this.__onBeforeUnload),this},remove:function(){return this.teardown(),c.prototype.remove.apply(this,arguments)},_onKeyDown:function(t){this.focusOnNextEditor(t),this.keyboardSave(t)},focusOnNextEditor:function(t){if(9===t.keyCode){var e=this.$el.find(".editor[contenteditable]:visible, .post-form--close, .post-form--save-button .create_post_button:enabled"),i=n.inArray(t.target,e);if(-1!==i){t.preventDefault();var s=(i+(t.shiftKey?-1:1))%e.length;0>s&&(s+=e.length),n(e[s]).focus()}}},keyboardSave:function(t){var e=/Mac/.test(navigator.platform)?t.metaKey:t.ctrlKey;13===t.keyCode&&e&&this.post.isValid()&&(t.preventDefault(),t.stopPropagation(),this.save())},_onBeforeUnload:function(){if(this.model.deepHasChanged(this.get("initialPostState"))){var t=h("Sure you want to leave this page without saving? Your post will be discarded.");return"edit"===this.model.get("mode")&&(t=h("Sure you want to leave this page without saving? All your edits will be lost.")),t}},cancelEditorBlur:function(){var t=this._getCurrentRichTextEditor();t&&t.cancelBlur()},resumeEditorBlur:function(t){var e=this._getCurrentRichTextEditor();e&&s.isFunction(e.resumeBlur)?e.resumeBlur(t):s.isFunction(t)&&t()}});e.exports=F},{"../services/content_stats_support":248,"../templates/post_form.tpl":277,"./allow_answers":315,"./avatar":318,"./editor_buttons":320,"./error_bar":321,"./inline-controls-tutorial":325,"./post_settings":340,"./post_type_form/_create":343,"./richtext_editor_tutorial":355,"./save_post_button":356,"./social_buttons":358,"./tag_editor":359,"./tumblelog_select":363,"./uploading_indicator":366,jquery:"HlZQrA",lodash:"MicNly","prima/events":512,"prima/lib/translate":541,"prima/mixins/accessor":542,"prima/mixins/selectorcache":553,"prima/mixins/subviewable":554,"prima/utils/bindendevent":560,"prima/utils/sequence-with-context":577,"prima/view":580,"velocity-animate":"lWl/mc",when:"RG2dij"}],339:[function(t,e,i){"use strict";var s=t("prima/view"),n=t("../templates/post_preview.tpl"),o=s.extend({template:n,initialize:function(t){this.options=t},render:function(){return this.$el.html(this.template(this.options)),this}});e.exports=o},{"../templates/post_preview.tpl":278,"prima/view":580}],340:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/view"),o=t("prima/mixins/subviewable"),a=t("prima/mixins/selectorcache"),r=t("../templates/post_settings.tpl"),l=t("./post_settings_dropdown"),h=n.extend({className:"post-form--post-settings-button",events:{"click [data-js-clickablePostSettingsCog]":"togglePostSettingsDropdown"},mixins:[o,a],template:r,initialize:function(t){t=s.extend({},t,{shift:{x:0,y:10},identifier:"postForms:postSettingsDropdown"}),this.postSettingsDropdown=new l(t)},render:function(){return this.$el.html(this.template()),this.postSettingsDropdown.setPinnedTarget(this.js$("postSettingsCog")),this},togglePostSettingsDropdown:function(t){this.postSettingsDropdown.isOrWasRecentlyRendered()||this.postSettingsDropdown.render()}});e.exports=h},{"../templates/post_settings.tpl":279,"./post_settings_dropdown":341,lodash:"MicNly","prima/mixins/selectorcache":553,"prima/mixins/subviewable":554,"prima/view":580}],341:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/view"),o=t("prima/lib/translate"),a=t("prima/events"),r=t("prima/lib/flags"),l=t("app/components/dialog"),h=t("prima/mixins/accessor"),c=t("prima/mixins/selectorcache"),u=t("prima/mixins/popoverbase"),d=t("app/mixins/tumblrselect"),p=t("../templates/post_settings_dropdown.tpl"),m=n.extend({className:"popover--post-settings-dropdown",defaults:{textFields:["customUrl","sourceUrl","postDate"],checkboxFields:["allowPhotoReplies"],selectFields:["editorType"]},mixins:[h,c,u,d],template:p,initialize:function(t){this.options=t=s.extend({},t),s.extend(this,s.pick(t,["post","user","uploads"]))},render:function(){return this.$el.html(this.template(this.serialize())),this.setupTextInputFields(),this.setupCheckboxInputFields(),this.setupSelectFields(),this.delegateEvents(),a.trigger("postForms:dismissListener:suspend"),this},teardown:function(){return this.$el.remove(),a.trigger("postForms:dismissListener:resume"),this},serialize:function(){return s.extend({showEditorSelection:"chat"!==this.post.get("type"),showPhotoRepliesOption:!r.bool("disable_public_replies")},this.model.toJSON())},setupTextInputFields:function(){s.each(this.get("textFields"),function(t){var e=this["$"+t]=this.js$(t);return"sourceUrl"===t&&this.model.isReblog()?void e.attr("readonly",!0):(e.on("input",s.bind(function(t){this.model.set(e.attr("name"),e.val())},this)),void e.on("keydown",s.bind(function(t){var e=t.which||t.keyCode;13===e&&this.teardown()},this)))},this)},setupCheckboxInputFields:function(){s.each(this.get("checkboxFields"),function(t){var e=this["$"+t]=this.js$(t),i=e.attr("name");e.prop("checked",!!this.model.get(i)),e.on("change",s.bind(function(n){var o="_onChange"+s.camelCase("-"+t);s.isFunction(this[o])?this[o]():this.model.set(i,e.prop("checked"))},this))},this)},setupSelectFields:function(){s.each(this.get("selectFields"),function(t){var e=this["$"+t]=this.js$(t),i=e.attr("name");this.setUpSelector(e),e.children('[value="'+this.model.get(i)+'"]').attr("selected",!0),e.trigger("change"),e.on("change",s.bind(function(n){var o="_onChange"+s.camelCase("-"+t);s.isFunction(this[o])?this[o]():this.model.set(i,e.val())},this))},this)},setupInputListeners:function(){var t=this.get("checkboxFields");s.each(this.get("inputSelectorNames"),function(e){var i=this["$"+e];i.on("change",s.bind(function(s){var n=-1!==t.indexOf(e)?i.prop("checked"):i.val();this.model.set(i.attr("name"),n)},this))},this)},_onChangeEditorType:function(t){var e=this.model.get("editorType"),i=this.js$("editorType").val();if(!e)return void this.model.set("editorType",this.user.get("defaultEditorType")||"rich");if(e!==i)if("rich"!==e&&"rich"===i&&this.model.get("htmlEdited")){var n={text:o("%1$sGoing back to normal?%2$sYou might lose any code that doesn't get along with our text editor.%3$s","<h3>","</h3><small>","</small>"),keycommand_maintain:!0};l.confirm(n,s.bind(function(){this.js$("editorType").blur(),this.model.set({htmlEdited:!1,editorType:i}),this._delayedClose()},this))}else s.defer(s.bind(function(){this.model.set("editorType",i)},this)),this._delayedClose()},_delayedClose:function(t){s.isNumber(t)||(t=50),s.delay(s.bind(function(){this.teardown()},this),t)}});e.exports=m},{"../templates/post_settings_dropdown.tpl":280,"app/components/dialog":44,"app/mixins/tumblrselect":434,lodash:"MicNly","prima/events":512,"prima/lib/flags":"f/LVtH","prima/lib/translate":541,"prima/mixins/accessor":542,"prima/mixins/popoverbase":550,"prima/mixins/selectorcache":553,"prima/view":580}],342:[function(t,e,i){"use strict";var s=t("lodash"),n=t("jquery"),o=t("prima/view"),a=t("prima/mixins/accessor"),r=t("prima/mixins/subviewable"),l=t("../../templates/post_type_form/_audio_search_results.tpl"),h=o.extend({defaults:{currentChoice:-1,serviceResults:{},showCopyrightWarning:!1},events:{"click .clear-results":"clearResults","click .result":"_clickedChoice","mouseover .result":"resetCurrentChoice"},mixins:[a,r],template:l,initialize:function(){this.listenTo(this,"change:serviceResults",function(t){t.trigger("searchResults:updated",t._getResultCount())}),this.listenTo(this,"change:currentChoice",this._styleResults)},updateResultsForService:function(t){var e=this.get("serviceResults"),i=s.clone(e);i[t.service]=t.tracks,this.set("serviceResults",i),!1===s.isEqual(e,t)&&(this.resetCurrentChoice(),this.teardown(),this.render())},handleMenuCommand:function(t){var e=n(".result",this.$el),i=this.get("currentChoice");if("confirm"===t){if(-1!==i){var s=n(e[this.get("currentChoice")]),o=s.attr("data-href"),a=s.hasClass("audio-result")?"searchResults:selectAudio":"searchResults:selectVideo";this.trigger(a,o)}}else{var r="cycleUp"===t?-1:1,l=(this.get("currentChoice")+r+e.length)%e.length;this.set("currentChoice",l)}},render:function(){var t=s.extend(s.pick(this.attributes,"serviceResults"),{resultCount:this._getResultCount(),copyrightWarningMessage:this.get("copyrightWarningMessage")||"",showCopyrightWarning:!!this.get("showCopyrightWarning")});return this.$el.html(this.template(t)),this},teardown:function(){return this.$el.empty(),this},reset:function(){this.set("serviceResults",{})},resetCurrentChoice:function(){this.set("currentChoice",-1)},clearResults:function(){this.trigger("searchResults:clear")},hasResults:function(){return this._getResultCount()>0},setCopyrightWarningMessage:function(t){this.set("copyrightWarningMessage",t)},_clickedChoice:function(t){var e=n(t.currentTarget).attr("data-href"),i=t.currentTarget.classList.contains("audio-result")?"searchResults:selectAudio":"searchResults:selectVideo";this.trigger(i,e)},_getResultCount:function(){return s.reduce(this.get("serviceResults"),function(t,e){return t+(s.isArray(e)?e.length:0)},0)},_styleResults:function(t,e){s.each(n(".result",t.$el),function(t,i){n(t).toggleClass("cycled",i===e)})}});e.exports=h},{"../../templates/post_type_form/_audio_search_results.tpl":281,jquery:"HlZQrA",lodash:"MicNly","prima/mixins/accessor":542,"prima/mixins/subviewable":554,"prima/view":580}],343:[function(t,e,i){"use strict";var s=t("lodash"),n={text:t("./text"),photo:t("./photo"),link:t("./link"),quote:t("./quote"),chat:t("./chat"),audio:t("./audio"),video:t("./video"),note:t("./note")},o=t("./text"),a=function(t){var e,i;return s.isPlainObject(t)?e=t.model:(e=t,t={model:e}),new(i=n[e.get("type")]||o)(t)};e.exports=a},{"./audio":344,"./chat":346,"./link":347,"./note":348,"./photo":349,"./quote":350,"./text":351,"./video":352,lodash:"MicNly"}],344:[function(t,e,i){"use strict";var s=t("lodash"),n=t("./base"),o=t("prima/lib/translate"),a=(t("prima/lib/logger"),t("../../templates/post_type_form/audio.tpl")),r=t("../plaintext_editor"),l=t("./_audio_search_results"),h=t("../audio_uploader"),c=t("../media/audio"),u=t("../confirm_tos"),d=t("../richtext_editor"),p=t("../reblog_tree"),m=t("../../services/audio_search_service"),g=t("app/components/dialog"),f=n.extend({defaults:s.defaults({maxSearchResults:4,showSearchField:!0,showAudioUploader:!0,showSearchResultList:!1,showCopyrightWarning:!1,hasMediaView:!0,hasMedia:!1,showTos:!1,showCaption:!1},n.prototype.defaults),template:a,afterInitialize:function(){this.searchService=new m,(this.post.get("url")||"new"!==this.post.get("mode"))&&this.set({hasMedia:!0,showCaption:!0,showSearchField:!1,showAudioUploader:!1,showSearchResultList:!1,showCopyrightWarning:!1})},createSubViews:function(){var t=this.subViewOptions(),e=s.extend({className:"audio-search-field",placeholder:o("Search for a song or paste a URL"),ariaLabel:o("Search for a song or paste a URL"),name:"search",forceSingleLine:!0,onClientEvent:s.bind(this.handleSearchMenuKeys,this)},t),i=s.extend({},t),n={className:"audio-search-results-field"},a=s.extend({url:this.post.get("url"),service:this.post.get("service"),albumArt:this.post.get("albumArt"),canEditMedia:this.post.canEditMedia()},t);this.post.get("bandcamp")&&s.extend(a,this.post.get("bandcamp"));var m=s.extend({},t),g=s.extend({className:"caption-field",name:"caption",placeholder:o("Add a description, if you like"),ariaLabel:o("Description")},t),f=s.extend({isRemovable:!0},t);this.searchField=this.subViews.searchField=new r(e),this.audioUploader=this.subViews.audioUploader=new h(i),this.searchResultList=this.subViews.searchResultList=new l(n),this.mediaPreview=this.subViews.mediaPreview=new c(a),this.confirmTos=this.subViews.confirmTos=new u(m),this.caption=this.subViews.caption=new d(g),this.post.isReblog()&&(this.reblogTree=this.subViews.reblogTree=new p(f))},addStateListeners:function(){this.listenTo(this.audioUploader,"upload:start",this._onFileUploadStart),this.listenTo(this.audioUploader,"upload:complete",this._onFileUploadComplete),this.listenTo(this.audioUploader,"upload:error upload:invalid",this._onFileUploadError),this.searchResultList.listenTo(this.searchService,"searchResults:fetched",this.searchResultList.updateResultsForService),this.listenTo(this.searchService,"audioEmbedData:fetched",this._onAudioEmbedDataFetched),this.searchResultList.listenTo(this.searchField,"searchField:menuKey",this.searchResultList.handleMenuCommand),this.listenTo(this.searchResultList,"searchResults:updated",function(t){var e=s.isEmpty(this.post.get("url"))&&t>0;this.set("showSearchResultList",e)}),this.listenTo(this.searchResultList,"searchResults:selectAudio",this.setAudioContentFromUrl),this.listenTo(this.searchResultList,"searchResults:selectVideo",this.switchToVideoPost),this.listenTo(this.searchResultList,"searchResults:clear",function(){this.set("showCopyrightWarning",!1),this.post.unset("copyrightFallback")}),this.searchField.listenTo(this.searchResultList,"searchResults:clear",function(){this.setEditorValue(""),this.focus()}),this.listenTo(this.mediaPreview,"media:ready",function(){var t=s.toArray(arguments);t.unshift("media:ready"),this.trigger.apply(this,t)}),this.post.canEditMedia()&&this.listenTo(this.mediaPreview,"media:remove",this.removeMedia),this.listenTo(this.post,"change:search",s.debounce(this._onChangeSearchInput,200)),this.listenTo(this,"change:showSearchField",this._onChangeShowSearchField),this.listenTo(this,"change:showAudioUploader",this._onChangeShowAudioUploader),this.listenTo(this,"change:showSearchResultList",this._onChangeShowSearchResultList),this.listenTo(this,"change:hasMedia",this._onChangeHasMedia),this.listenTo(this,"change:showTos",this._onChangeShowTos),this.listenTo(this,"change:showCaption",this._onChangeShowCaption),this.listenTo(this,"change:showCopyrightWarning",this._onChangeShowCopyrightWarning)},removeMedia:function(){this.searchResultList.hasResults()||this.searchField.setEditorValue(""),this.post.softReset();var t=s.isEmpty(this.post.get("search"));this.set({hasMedia:!1,showSearchField:!0,showSearchResultList:!t,showAudioUploader:t,showTos:!1}),this.mediaPreview.set({url:"",service:""}),this.js$("confirmTos").attr("checked",!!this.post.get("confirmTos")),s.isEmpty(this.post.get("caption"))&&s.isEmpty(this.post.get("tags"))&&this.set("showCaption",!1),this.searchField.focus()},_onChangeShowSearchField:function(t,e){this.searchField.$el.css({display:e?"block":"none",opacity:e?1:0})},_onChangeShowAudioUploader:function(t,e){this.audioUploader.$el.css({display:e?"block":"none",opacity:e?1:0})},_onChangeShowSearchResultList:function(t,e){this.searchResultList.$el.css({display:e?"block":"none",opacity:e?1:0})},_onChangeShowCopyrightWarning:function(t,e){this.searchResultList.set("showCopyrightWarning",e)},_onChangeHasMedia:function(t,e){this.isRendered()&&(e?this.mediaPreview.$el.css({display:"block",opacity:1}):this.mediaPreview.$el.css({display:"none",opacity:0}))},_onChangeShowTos:function(t,e){this.isRendered()&&(e?this.js$("tos").css({display:"block",opacity:1}):this.js$("tos").css({display:"none",opacity:0}))},_onChangeShowCaption:function(t,e){this.isRendered()&&(e?this.js$("caption").css({display:"block",opacity:1}):this.js$("caption").css({display:"none",opacity:0}))},setAudioContent:function(t,e,i){s.isObject(t)&&(i=t,t=""),i=s.extend({preuploadUrl:"",url:(t||"").replace(/\u200B/g,""),service:e},i),("bandcamp"!==e||i.id&&i.type)&&(this.mediaPreview.set(i),this.post.set(s.pick(i,["url","preuploadUrl","service","albumArt","preuploadAlbumArt","trackTitle","trackArtist","trackAlbum"])))},setAudioContentFromUrl:function(t,e,i){e||(e=this.searchService.getServiceByUrl(t)),i||(i={}),this.setAudioContent(t,e,i),this.set({hasMedia:!0,showCaption:!0,showSearchField:!1,showSearchResultList:!1,showAudioUploader:!1,showTos:!s.isEmpty(i.preuploadUrl)}),this.caption.focus()},_onChangeSearchInput:function(t,e){e||(e="");var i=s.isEmpty(e)?!1:this.searchService.getServiceByUrl(e);if(i)"direct"===i?this.setAudioContentFromUrl(e,i):this.searchService.getData(e,i),this.post.unset("search");else if(s.isEmpty(e))this.searchResultList.reset(),this.set("showAudioUploader",this.get("showSearchField"));else{if(this.set("showAudioUploader",!1),this.get("showCopyrightWarning")){if(e===this.post.get("copyrightFallback"))return;this.set("showCopyrightWarning",!1),this.post.unset("copyrightFallback"),this.searchResultList.reset()}this._executeAudioSearches(e)}},_executeAudioSearches:function(t,e,i){e=s.isArray(e)?e:this.searchService.searchServices,s.forEach(e,function(e){this.searchService.search(e,t,i)},this)},_onAudioEmbedDataFetched:function(t,e,i){s.isObject(t)&&(i=t,t=i.url),this.setAudioContentFromUrl(t,e,i)},handleSearchMenuKeys:function(t){var e,i=["keyup","keydown"],s={13:"confirm",38:"cycleUp",40:"cycleDown"};return t=t||window.event,-1!==i.indexOf(t.type)&&(e=t.which||t.keyCode,e in s)?("keydown"===t.type&&13===e&&t.stopImmediatePropagation(),this.searchResultList.isRendered()&&"keyup"!==t.type&&(this.searchField.trigger("searchField:menuKey",s[e]),t.preventDefault()),!1):void 0},_onFileUploadStart:function(t){this.uploads.add(t)},_onFileUploadComplete:function(t){var e={preuploadUrl:t.get("url")},i=t.get("album_art_url");i&&(e.preuploadAlbumArt=!0,e.albumArt=i);var n=t.get("id3");s.isObject(n)&&(e.trackTitle=n.Title,e.trackArtist=n.Artist,e.trackAlbum=n.Album),this.setAudioContentFromUrl(e.preuploadUrl,"direct",e)},_onFileUploadError:function(t){var e=t.get("responseJSON");if(e){var i=parseInt(s.get(e,"meta.status"),10),n=s.get(e,"response.is_copyright");if(403===i&&n)return void this.uploadFailedCopyright(s.get(e,"response"))}var a=t.get("error")||o("Error uploading audio");s.isArray(a)&&(a=a.join("</p><p>")),g.alert("<p>"+a+"</p>")},afterRender:function(){this.renderSubViews(),s.forEach({showSearchField:this.searchField,showAudioUploader:this.audioUploader,showSearchResultList:this.searchResultList,hasMedia:this.mediaPreview},function(t,e){this.get(e)||t.$el.css({display:"none",opacity:0})},this),this.get("showTos")||this.js$("tos").css({display:"none",opacity:0}),this.get("showCaption")?this.delayedFocus(this.caption):(this.delayedFocus(this.searchField),this.js$("caption").css({display:"none",opacity:0}))},uploadFailedCopyright:function(t){var e="new"===this.post.get("mode")?["spotify","soundcloud","youtube"]:["spotify","soundcloud"],i={maxResults:3};this.searchResultList.setCopyrightWarningMessage(t.message),this.set({showCopyrightWarning:!0,showAudioUploader:!1}),this.subViews.searchField.setEditorValue(t.search_string),this.post.set("copyrightFallback",t.search_string),this._executeAudioSearches(t.search_string,e,i),this.searchField.focus()},switchToVideoPost:function(t){var e={postParams:{type:"video",copyrightFallback:this.post.get("copyrightFallback")},afterReload:function(e){e.postTypeForm.executeUrlParser(t)}};this.trigger("switchPostType","video",e)},getRichTextEditor:function(){return this.caption}});e.exports=f},{"../../services/audio_search_service":247,"../../templates/post_type_form/audio.tpl":282,"../audio_uploader":317,"../confirm_tos":319,"../media/audio":327,"../plaintext_editor":337,"../reblog_tree":353,"../richtext_editor":354,"./_audio_search_results":342,"./base":345,"app/components/dialog":44,lodash:"MicNly","prima/lib/logger":519,"prima/lib/translate":541}],345:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/view"),o=t("prima/mixins/accessor"),a=t("prima/mixins/subviewable"),r=t("prima/mixins/selectorcache"),l=t("prima/events"),h=t("prima/utils/image/types"),c=s.template(""),u=n.extend({template:c,mixins:[o,a,r],defaults:{hasMediaView:!1,hideControlsLine:!1},defaultOptions:{supportImageSearch:!1,minFullWidthSize:{}},initialize:function(t){if(this.options=t=s.extend({},this.defaultOptions,t),s.extend(this.attributes,s.pick(t,s.keys(this.defaults))),!t.post)throw new Error("PostFormView requires a Post model!");if(!t.user)throw new Error("PostFormView requires a User model");s.extend(this,s.pick(t,["post","user","uploads"])),s.isFunction(this.afterInitialize)&&this.afterInitialize.apply(this,arguments)},createSubViews:function(){},subViewOptions:function(){return s.extend({},s.pick(this.options,"supportImageSearch","minFullWidthSize","dragEvents"),s.pick(this,"model","uploads","user","post"))},addStateListeners:function(){},getRichTextEditor:function(){},serialize:function(){return s.extend({canEditMedia:this.post.canEditMedia()},this.post.toJSON(),this.toJSON())},teardown:function(){return this.stopListening(),this.$el.empty(),this},beforeRender:function(){this.createSubViews(),this.addStateListeners()},render:function(){return this.$el.html(this.template(this.serialize())),this.attachSubViews(),this},registerTitleKeyboardShortcut:function(t){var e=/Mac/.test(navigator.platform)?"meta":"ctrl";return this.listenTo(l,"DOMEventor:keydown:"+e+"+shift+1",function(){t.focus()}),t},delayedFocus:function(t,e,i){"undefined"!=typeof i||(i=!0),"number"==typeof e||(e=200),s.delay(s.bind(function(){t.focus(i),i&&t.setCursorToEnd()},this),e||0)},getMinFullWidthSize:function(t){var e=this.options.minFullWidthSize||{};return s.isEmpty(e)?null:s.isNumber(e)?e:(t=h.convertToNormalizedType(t),s.has(e,t)?e[t]:null)}});e.exports=u},{lodash:"MicNly","prima/events":512,"prima/mixins/accessor":542,"prima/mixins/selectorcache":553,"prima/mixins/subviewable":554,"prima/utils/image/types":574,"prima/view":580}],346:[function(t,e,i){"use strict";var s=t("lodash"),n=t("jquery"),o=t("prima/lib/translate"),a=t("./base"),r=t("ligature").SelectionPersistence,l=t("../plaintext_editor"),h=t("../../templates/post_type_form/chat.tpl"),c=/^([^(:|\n)]+:)/,u=a.extend({template:h,placeholders:["%1$sFirefighter:%2$s That's the way the cookie crumbles.%3$s%1$sButler:%2$s It falls on me to reassemble the cookie.","%1$sStockbroker:%2$s I need a vacation.%3$s%1$sTourist:%2$s I'm already on one.%3$s%1$sStockbroker:%2$s Get out of my office.","%1$sAbbott:%2$s Who is the man on first base?%3$s%1$sCostello:%2$s That's what I'm telling you!%3$s%1$sAbbott:%2$s I'm unqualified to manage a baseball team.","%1$sRick:%2$s Our problems don't amount to a hill of beans in this crazy world.%3$s%1$sIlsa:%2$s Great, now I'm hungry for beans.","%1$sAlbert Einstein:%2$s Energy equals mass times the speed of light squared.%3$s%1$sCop:%2$s Tell it to the judge.","%1$sAxl:%2$s Welcome to the jungle.%3$s%1$sCustomer:%2$s We'd like a table for two, please.%3$s%1$sAxl:%2$s Your table is right this way.","%1$sTourist:%2$s Could you give us directions to Olive Garden?%3$s%1$sNew Yorker:%2$s No, but I could give you directions to an actual Italian restaurant.","%1$sPangloss:%2$s Could you give me directions to the Olive Garden?%3$s%1$sCandide:%2$s No, but we can cultivate our own garden.%3$s%1$sPangloss:%2$s That sounds rational to me.","%1$sCharles Dickens:%2$s It was the best of mimes, it was the worst of mimes.%3$s%1$sMime:%2$s ...","%1$sJuliet:%2$s Romeo, Romeo, wherefore art thou, Romeo?%3$s%1$sRomeo:%2$s I'm right here, Juliet.?%3$s%1$sJuliet:%2$s “Wherefore” means “why” not “where.”%3$s%1$sRomeo:%2$s Misunderstandings like these are what define our relationship.","%1$sSeal:%2$s Did you know that when it snows my eyes become larger?%3$s%1$sOptometrist:%2$s That's highly abnormal. I'm going to refer you to a specialist.%3$s%1$sSeal:%2$s BABAAAAAAAYYYY!","%1$sSeal:%2$s There's so much a man can tell you, so much he can say.%3$s%1$sMan:%2$s I've just been waiting for someone to ask!","%1$sUsher:%2$s These are my confessions.%3$s%1$sTheater-goer:%2$s These are my tickets.%3$s%1$sUsher:%2$s Right this way."],
afterInitialize:function(){this.user.get("language")&&"en_US"!==this.user.get("language")?(this._placeholders=s.filter(this.placeholders,function(t){return o(t)!==t}),s.isEmpty(this._placeholders)&&(this._placeholders=this.placeholders)):this._placeholders=this.placeholders},randomPlaceholder:function(){var t=s.sample(this._placeholders||this.placeholders);return o(t,"<b>","</b>","<br>")},createSubViews:function(){var t=this.subViewOptions(),e=s.extend({className:"title-field",name:"title",isResizable:!0,placeholder:o("Title"),ariaLabel:o("Post title"),allowLinebreaks:!1},t),i=s.extend({className:"chat-field normal",name:"chat",placeholder:this.randomPlaceholder(),onChange:s.bind(function(t){this.formatText()},this),ariaLabel:o("Post body"),convertNewlinesToLinebreaks:!0},t);this.title=this.subViews.title=new l(e),this.chat=this.subViews.chat=new l(i),this.registerTitleKeyboardShortcut(this.title)},afterRender:function(){this.renderSubViews(),this.model.get("chat")&&this.formatText(),this.delayedFocus(this.chat)},formatText:function(){this.chat.getEditorValue()&&this.formatTextNode(this.chat.editor.element)},formatTextNode:function(t){if(t){if(t.nodeType!==Node.TEXT_NODE)return void s.each(t.childNodes,s.bind(function(t){this.formatTextNode(t)},this));if(this.stripZeroWidthSpaceFromNode(t),"B"===t.parentNode.tagName)return void this.cleanBoldNode(t.parentNode);if(!(n(t).prev().length>0&&"BR"!==n(t).prev()[0].tagName)){var e=t.nodeValue.match(c);if(e){var i=r.saveSelection(this.chat.editor.element),o=t.parentNode;if(s.isObject(o)){var a=e[0];t.nodeValue=t.nodeValue.replace(c,"");var l=document.createElement("b");l.innerHTML=a,o.insertBefore(l,t)}r.restoreSelection(i)}}}},cleanBoldNode:function(t){if("B"===t.tagName)if(t.childNodes.length>1)for(;t.childNodes.length>1&&t.innerHTML.match(/<br\s*[\/]?>/);)t.parentNode.insertBefore(t.firstChild,t);else{var e=t.firstChild;if(-1===e.nodeValue.indexOf(":"))return void this.unwrapNode(t);var i=/:(.+)$/,s=e.nodeValue.match(i);if(s){var n=r.saveSelection(this.chat.editor.element),o=s[1],a=document.createTextNode(o);e.nodeValue=e.nodeValue.replace(/:(.+)$/,":"),t.parentNode.insertBefore(a,t.nextSibling),r.restoreSelection(n)}}},unwrapNode:function(t){var e=r.saveSelection(this.chat.editor.element),i=t.parentNode,s=t.firstChild,n=s.nodeValue;n&&(i.insertBefore(s,t.nextSibling),i.normalize()),t.remove(),this.formatTextNode(i),r.restoreSelection(e)},stripZeroWidthSpaceFromNode:function(t){var e=/\u200B/g;if(t&&t.nodeType===Node.TEXT_NODE&&t.nodeValue.match(e)){var i=r.saveSelection(this.chat.editor.element);t.nodeValue=t.nodeValue.replace(e,""),Math.max(i.start,i.end)>t.nodeValue.length&&(i.start=i.end=t.nodeValue.length),r.restoreSelection(i)}}});e.exports=u},{"../../templates/post_type_form/chat.tpl":283,"../plaintext_editor":337,"./base":345,jquery:"HlZQrA",ligature:620,lodash:"MicNly","prima/lib/translate":541}],347:[function(t,e,i){"use strict";var s=t("jquery"),n=t("lodash"),o=t("prima/lib/translate"),a=t("./base"),r=t("../../templates/post_type_form/link.tpl"),l=t("../plaintext_editor"),h=t("../richtext_editor"),c=t("../reblog_tree"),u=t("app/components/remove-button"),d=t("../../services/open_graph_service"),p=t("../../utils/validation"),m=t("prima/utils/url"),g=t("prima/utils/image/loader"),f=a.extend({className:"link-post",events:{"mouseenter [data-js-removable=true]":"_onHoverRemoveButton","mouseleave [data-js-removable=true]":"_onHoverRemoveButton","mouseleave .media-container":"_onHoverRemoveButton"},template:r,defaults:n.defaults({hasMedia:!1,showCaption:!1,ogFetchPending:!1,tagEditor:null,hasCustomTags:!1,numOgTags:5},a.prototype.defaults),afterInitialize:function(){this._ogService=new d,"new"!==this.model.get("mode")&&this.set({hasMedia:!0,hasCustomTags:!0}),this.model.has("caption")&&this.set("showCaption",!0),this.set("hideControlsLine",!this.get("showCaption")),this.tagEditor=this.get("tagEditor")},afterRender:function(){this.renderSubViews(),this.model.canEditMedia()||(this.title.disable(),this.excerpt.disable(),this.url.disable(),this._hideEmptyFields()),this._onChangeThumbnail(this.model,this.model.get("thumbnail")),this._onChangeAuthor(this.model,this.model.get("author")),this._onChangeHasMedia(this,this.get("hasMedia")),this._onChangeShowCaption(this,this.get("showCaption")),this._onChangeShortUrl(this.model,this.model.get("url")),"new"!==this.model.get("mode")||n.isEmpty(this.model.get("url"))||(this.url.setEditorValue(this.model.get("url")),this._onChangeUrl(this.model,this.model.get("url"))),this.trigger("media:ready"),this.get("showCaption")?this.delayedFocus(this.caption):this.delayedFocus(this.url)},createSubViews:function(){var t=this.subViewOptions(),e=n.extend({className:"title",name:"title",isResizable:!1,placeholder:o("Enter a title"),ariaLabel:o("Link title"),forceSingleLine:!0},t),i=n.extend({className:"summary",name:"excerpt",isResizable:!1,placeholder:o("Enter a summary"),ariaLabel:o("Link summary"),forceSingleLine:!1},t),s=n.extend({className:"url",isResizable:!1,placeholder:o("Type or paste a URL"),ariaLabel:o("Type or paste a URL"),forceSingleLine:!0,pasteHook:n.bind(this._onPaste,this),onClientEvent:n.bind(this._onUrlClientEvent,this),onChange:n.bind(n.debounce(this._onUrlEditorChange,500),this)},t),a=n.extend({className:"caption",name:"caption",placeholder:o("Add a description, if you like"),ariaLabel:o("Description")},t),r=n.extend({isRemovable:!0},t);this.url=this.subViews.url=new l(s),this.title=this.subViews.title=new l(e),this.excerpt=this.subViews.excerpt=new l(i),this.caption=this.subViews.caption=new h(a),this.removeButton=this.subViews.removeButton=new u({buttonClass:"top-right"}),this.model.isReblog()&&(this.reblogTree=this.subViews.reblogTree=new c(r))},addStateListeners:function(){"reblog"!==this.model.get("mode")&&this.listenTo(this.model,"change:url",this._onChangeUrl),this.listenTo(this,"change:ogFetchPending",this._onChangeFetchPending),this.listenTo(this,"change:hasMedia",this._onChangeHasMedia),this.listenTo(this,"change:showCaption",this._onChangeShowCaption),this.listenTo(this.model,"change:thumbnail",this._onChangeThumbnail),this.listenTo(this.model,"change:url",this._onChangeShortUrl),this.listenTo(this.model,"change:author",this._onChangeAuthor),this.listenTo(this.model,"change:tagInput",this._onTagInputChange),this.listenTo(this.removeButton,"remove",this._onRemoveClick)},removeThumbnail:function(){this.model.unset("thumbnail")},removeMedia:function(){this.model.softReset(),this.title.setEditorValue(""),this.excerpt.setEditorValue(""),this.url.setEditorValue(""),this.tagEditor&&!this.get("hasCustomTags")&&this.tagEditor.removeTags(),n.isEmpty(this.model.get("caption"))&&(this.caption.setEditorValue(""),n.isEmpty(this.model.get("tags"))&&this.set("showCaption",!1)),this.set("hasMedia",!1),this.url.focus()},getRichTextEditor:function(){return this.caption},_onHoverRemoveButton:function(t){var e=s(t.relatedTarget||t.toElement),i="mouseover"===t.type||"mouseenter"===t.type;(i||0===e.parents('[data-subview="removeButton"]').length&&0===e.parents("[data-js-removable=true]").length)&&this.js$("removeButton").toggleClass("active",i)},_onChangeThumbnail:function(t,e){var i=this.js$("image"),o=!n.isEmpty(e);this.js$("media").toggleClass("has-thumbnail",o),this.js$("article").attr("data-js-removable",!o),this.$(".publisher-container").attr("data-js-removable",o),i.attr("data-js-removable",o),i.empty(),o&&i.append(s("<img />").attr("src",e)),"reblog"!==this.model.get("mode")&&(o?this.model.unset("remove_thumbnail"):this.model.set("remove_thumbnail",!0))},_onUrlClientEvent:function(t){this.get("ogFetchPending")&&"keydown"===t.type&&27===t.keyCode&&(this._cancelOpenGraphFetch(),t.stopPropagation(),t.preventDefault())},_onUrlEditorChange:function(){var t=this.url.getEditorValue(),e=this._normalizeUrl(t);n.isEmpty(e)||e===this.model.get("url")||this.model.set("url",e)},_onPaste:function(t){var e,i;n.isEmpty(this.url.getEditorValue())&&(e=t.getData("text/plain"),i=this._normalizeUrl(e),n.isEmpty(i)||this.model.set("url",i))},_shouldShowThumbnail:function(t){var e=this.getMinFullWidthSize(m.getExtension(t.src));return n.isNumber(e)&&n.has(t,"width")&&t.width>=e},_onChangeFetchPending:function(t,e){this.model.set("loading",e)},setPostData:function(t){t=t||{},n.has(t,"title")&&this.title.setEditorValue(t.title),n.has(t,"excerpt")&&this.excerpt.setEditorValue(t.excerpt),n.has(t,"thumbnail")&&this.model.set("thumbnail",t.thumbnail),n.has(t,"author")&&this.model.set("author",t.author),n.has(t,"tags")&&(n.each(t.tags,function(t){this.tagEditor.addTag(t.toLowerCase())},this),n.isEmpty(t.tags)||this.tagEditor.removePlaceholder())},_normalizeUrl:function(t){return n.isString(t)?(t=t.trim(),t=m.addProtocolIfMissing(t,"http:"),p.isUrl(t)?t:null):null},_onChangeUrl:function(t,e){this.get("ogFetchPending")||p.isUrl(e)&&(this.set("ogFetchPending",!0),this._ogService.fetchOpenGraphData(e).then(n.bind(this._updateWithGraphInfo,this),n.bind(this._onOpenGraphFail,this)))},_onChangeShortUrl:function(t,e){if(p.isUrl(e))try{var i,s=m.parseUrl(e);s&&n.has(s,"host")&&(i=s.host.replace(/^www\./i,""),this.js$("publisher").attr("href",e).text(i))}catch(o){}},_onChangeAuthor:function(t,e){var i=n.isEmpty(e)?"":o("By %1$s",e);this.js$("author").text(i).toggle(!n.isEmpty(e))},_onTagInputChange:function(t,e){e&&this.set("hasCustomTags",!0)},_updateWithGraphInfo:function(t){var e=t.image,i=function(e){var i,s={title:t.title,excerpt:t.description,author:t.author,thumbnail:e?"":t.image};!this.get("hasCustomTags")&&n.has(t,"tags")&&(i=this._parseOpenGraphTags(t.tags),n.extend(s,{tags:i.slice(0,this.get("numOgTags"))})),this.setPostData(s),this.set({hasMedia:!0,showCaption:!0,ogFetchPending:!1}),this.delayedFocus(this.caption)};n.isEmpty(e)?i.call(this,!1):g.load(e).then(n.bind(function(t){i.call(this,!this._shouldShowThumbnail(t))},this),n.bind(function(){i.call(this,!0)},this))},_onOpenGraphFail:function(){this.set({hasMedia:!0,showCaption:!0,ogFetchPending:!1}),this.delayedFocus(this.caption)},_cancelOpenGraphFetch:function(){this._ogService.abort()},_parseOpenGraphTags:function(t){return t=n.isString(t)?t.split(","):t,n.isArray(t)?t:[]},_onRemoveClick:function(){this.model.get("thumbnail")?this.removeThumbnail():this.removeMedia()},_onChangeHasMedia:function(t,e){this.$el.toggleClass("has-media",e),this.js$("media").toggle(e),this.url.$el.toggle(!e),this.removeButton.$el.toggle(e&&this.model.canEditMedia())},_onChangeShowCaption:function(t,e){this.set("hideControlsLine",!e),this.js$("caption").toggle(e)},_hideEmptyFields:function(){this.title.$el.toggle(!n.isEmpty(this.model.get("title"))),this.excerpt.$el.toggle(!n.isEmpty(this.model.get("excerpt")))}});e.exports=f},{"../../services/open_graph_service":254,"../../templates/post_type_form/link.tpl":284,"../../utils/validation":313,"../plaintext_editor":337,"../reblog_tree":353,"../richtext_editor":354,"./base":345,"app/components/remove-button":377,jquery:"HlZQrA",lodash:"MicNly","prima/lib/translate":541,"prima/utils/image/loader":573,"prima/utils/url":579}],348:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/lib/translate"),o=t("./base"),a=t("../ask_field"),r=t("../richtext_editor"),l=t("../reblog_tree"),h=t("../../templates/post_type_form/note.tpl"),c=o.extend({template:h,className:"post-composer_note-post",createSubViews:function(){var t=this.subViewOptions(),e=s.extend({className:"answer-field",name:"answer",placeholder:n("Your answer here"),ariaLabel:n("Answer")},t),i=s.extend({className:"caption-field",name:"caption",placeholder:n("Add your own text, if you like"),ariaLabel:n("Caption")},t),o=s.extend({isRemovable:!0},t);this.askField=this.subViews.askField=new a(t),this.post.isReblog()?(this.reblogTree=this.subViews.reblogTree=new l(o),this.caption=this.subViews.caption=new r(i)):this.answerField=this.subViews.answerField=new r(e)},afterRender:function(){this.renderSubViews(),this.post.isReblog()?this.delayedFocus(this.caption):this.delayedFocus(this.answerField)},getRichTextEditor:function(){return this.model.get("is_reblog")?this.caption:this.answerField}});e.exports=c},{"../../templates/post_type_form/note.tpl":285,"../ask_field":316,"../reblog_tree":353,"../richtext_editor":354,"./base":345,lodash:"MicNly","prima/lib/translate":541}],349:[function(t,e,i){"use strict";var s=t("lodash"),n=t("./base"),o=t("app/components/dialog"),a=(t("prima/lib/logger"),t("prima/lib/translate")),r=t("prima/utils/url"),l=t("prima/lib/data"),h="FileReader"in window&&"readAsDataURL"in FileReader.prototype,c=t("../../utils/validation"),u=t("../../models/photo"),d=t("../media/photo"),p=t("../photo_media_dropzone"),m=t("../richtext_editor"),g=t("../reblog_tree"),f=t("../../templates/post_type_form/photo.tpl"),_=2048,v=n.extend({template:f,defaults:s.defaults({hasMediaView:!0,hasMedia:!1,canAddMedia:!0,showPhotoBooth:!1,showCaption:!1,disablePhotoFromUrl:!1},n.prototype.defaults),afterInitialize:function(){this._urlParser=s.debounce(s.bind(this._photoUrlParser,this),100),!this.post.photos.isEmpty()||this.post.isReblog()?this.set({hasMedia:!0,showCaption:!0}):(this.post.get("caption")||!s.isEmpty(this.post.get("tags")))&&this.set("showCaption",!0),this.set("canAddMedia",this.post.canEditMedia()&&this.post.canAddPhotos()),this.set("hideControlsLine",!this.get("showCaption"))},_photoUrlParser:function(t,e,i){if(t=s.trim(t),t&&t.length<_&&c.isUrl(t)){var n=new u;this.listenTo(n,"photo:readUrl",function(t,i){t&&this.post.canAddPhotos()&&(this.post.photos.push(i),e.urlInput.setEditorValue(""),e.urlInput.blur(),e.set({showInput:!1,dropzoneBehavior:"url",defaultBehavior:"url"}))}),n.set("externalUrl",t)}},createSubViews:function(){var t=this.subViewOptions(),e=s.extend({canEditMedia:this.post.canEditMedia()},t),i=s.extend({toggleDropzone:this.get("hasMedia"),dropzoneText:a("Add another"),uploadIcon:"dropzone-add-photo-icon",uploadText:a("Upload photos"),urlIcon:"dropzone-add-url-icon",urlText:a("Add photo from web"),urlPlaceholder:a("Paste a URL"),urlAriaLabel:a("Paste a URL"),urlParser:this._urlParser,uploadOptions:{}},t);s.extend(i.uploadOptions,{name:"photo",maxUploadSize:10485760,uploadPattern:/^image\/(?:.*)$/i,accept:"image/*",url:"/svc/post/upload_photo",fileUpload:{multiple:!0}});var n=s.extend({className:"caption-field",name:"caption",placeholder:a("Add a caption, if you like"),ariaLabel:a("Caption")},t),o=s.extend({isRemovable:!0},t);this.mediaPreview=this.subViews.mediaPreview=new d(e),this.mediaComposer=this.subViews.mediaComposer=new p(i),this.caption=this.subViews.caption=new m(n),this.post.isReblog()&&(this.reblogTree=this.subViews.reblogTree=new g(o))},addStateListeners:function(){this.listenTo(this.mediaComposer,"upload:start",this._onFileUploadStart),this.listenTo(this.mediaComposer,"upload:complete",this._onFileUploadComplete),this.listenTo(this.mediaComposer,"upload:error upload:invalid",this._onFileUploadError),this.listenTo(this.mediaComposer,"webcam:show",function(){this.set("showPhotoBooth",!0)}),this.listenTo(this.post.photos,"add",this._onAddPhotos),this.listenTo(this.post.photos,"remove",this._onRemovePhotos),this.listenTo(this.mediaPreview,"media:ready",function(){var t=s.toArray(arguments);t.unshift("media:ready"),this.trigger.apply(this,t)}),this.listenTo(this.mediaPreview,"media:addFiles",function(t){this.mediaComposer.addFiles(t)}),this.listenTo(this.mediaPreview,"webcam:close",function(){this.set("showPhotoBooth",!1)}),this.listenTo(this.mediaPreview,"webcam:error",function(t){"NO_DEVICES_FOUND"===t&&(o.alert({text_ok:a("Aw, alright"),text:"<p>"+a("Sorry, beautiful. If you wanna take a selfie, you're gonna need a webcam.")+"</p>"}),this.mediaComposer.set("enableSelfie",!1))}),this.listenTo(this,"change:hasMedia",this._onChangeHasMedia),this.listenTo(this,"change:canAddMedia",this._onChangeCanAddMedia),this.listenTo(this,"change:showPhotoBooth",this._onChangeShowPhotoBooth),this.listenTo(this,"change:showCaption",this._onChangeShowCaption)},_onAddPhotos:function(t,e){this.set({hasMedia:!this.post.photos.isEmpty(),canAddMedia:this.post.canAddPhotos()}),s.isEmpty(this.post.get("caption"))&&s.isEmpty(this.post.get("tags"))?this.set("showCaption",this.get("hasMedia")):this.set("showCaption",!0),this.get("showCaption")&&this.caption.focus(),this.mediaComposer.set({toggleDropzone:!this.post.photos.isEmpty()})},_onRemovePhotos:function(t,e){this.set({hasMedia:!this.post.photos.isEmpty()||this.get("showPhotoBooth"),canAddMedia:this.post.canAddPhotos()}),this.mediaComposer.set({toggleDropzone:!this.post.photos.isEmpty()})},_onChangeHasMedia:function(t,e){this.isRendered()&&(e?this.mediaPreview.$el.css({display:"block",opacity:1}):this.mediaPreview.$el.css({display:"none",opacity:0}))},_onChangeCanAddMedia:function(t,e){this.isRendered()&&(this.mediaPreview.$el.toggleClass("photo-media-container--can-add",e),e?this.mediaComposer.$el.css({display:"block",opacity:1}):this.mediaComposer.$el.css({display:"none",opacity:0}))},_onChangeShowPhotoBooth:function(t,e){this.isRendered()&&(this.mediaPreview.set("showPhotoBooth",e),this.mediaPreview.$el.toggleClass("photo-media-container--show-photobooth",e),e?(this.mediaPreview.$el.css({display:"block",opacity:1}),this.mediaComposer.$el.css({display:"none",opacity:0})):(this._onChangeHasMedia(this,this.get("hasMedia")),this._onChangeCanAddMedia(this,this.get("canAddMedia"))))},_onChangeShowCaption:function(t,e){this.set("hideControlsLine",!e),this.isRendered()&&(e?this.js$("caption").css({display:"block",opacity:1}):this.js$("caption").css({display:"none",opacity:0}))},_onFileUploadStart:function(t){if(!s.isEmpty(t.get("error")))return this._onFileUploadError(t);this.uploads.add(t);var e=t.get("file");this.mediaPreview.set({file:e,canEditMedia:!0});var i=new u;h?this.listenTo(i,"photo:readFile",function(t,e){t&&this.post.canAddPhotos()&&(this.post.photos.push(e),this.mediaComposer.set({dropzoneBehavior:"upload",defaultBehavior:"upload"}))}):this.listenTo(i,"change:preuploadUrl",function(t,e){e&&(this.stopListening(t,"change:preuploadUrl"),this.post.canAddPhotos()&&(this.post.photos.push(t),this.mediaComposer.set({dropzoneBehavior:"upload",defaultBehavior:"upload"})))}),t.set("postPhoto",i),i.set("upload",t),i.set("file",e)},_onFileUploadComplete:function(t){var e=t.get("postPhoto");e&&(t.get("url")?e.set("preuploadUrl",t.get("url")):(o.alert("<p>"+[t.get("original_filename"),a(t.get("error"))].join("</p><p>")+"</p>"),this.post.photos.remove(e)))},_onFileUploadError:function(t){var e=t.get("error");s.isString(e)&&(e=[e]),s.isArray(e)||(e=[a("Woops :(")]),t.get("file")&&t.get("file").name&&e.unshift(t.get("file").name),o.alert("<p>"+e.join("</p><p>")+"</p>");var i=t.get("postPhoto");this.post.photos.remove(i),this.uploads.remove(t)},afterRender:function(){this.get("disablePhotoFromUrl")||this.checkUrl(),this.renderSubViews(),this.get("canAddMedia")?this.mediaPreview.$el.addClass("photo-media-container--can-add"):this.mediaComposer.$el.css({display:"none",opacity:0}),this.get("hasMedia")||this.mediaPreview.$el.css({display:"none",opacity:0}),this.get("showCaption")?this.delayedFocus(this.caption):this.js$("caption").css({display:"none",opacity:0}),this.get("showPhotoBooth")&&s.defer(s.bind(function(){this._onChangeShowPhotoBooth(this,this.get("showPhotoBooth"))},this))},checkUrl:function(){var t=r.getParameter("src"),e=r.getParameter("caption"),i=r.getParameter("tags");r.isAbsoluteUrl(t)||(t=l.get("Context.hosts.assets_host")+t),"edit"!==this.model.get("mode")&&t&&e&&i&&(this._photoUrlParser(t,this.mediaComposer),this.model.set("caption",e),this.model.set("tags",i.split(",")),this.get("disablePhotoFromUrl")||window.Backbone.history.navigate("/new/photo",{replace:!0}))},getRichTextEditor:function(){return this.caption}});e.exports=v},{"../../models/photo":240,"../../templates/post_type_form/photo.tpl":286,"../../utils/validation":313,"../media/photo":331,"../photo_media_dropzone":336,"../reblog_tree":353,"../richtext_editor":354,"./base":345,"app/components/dialog":44,lodash:"MicNly","prima/lib/data":514,"prima/lib/logger":519,"prima/lib/translate":541,"prima/utils/url":579}],350:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/lib/translate"),o=t("../../utils/string_helpers"),a=t("./base"),r=t("../plaintext_editor"),l=t("../richtext_editor"),h=t("../../templates/post_type_form/quote.tpl"),c=a.extend({defaults:s.defaults({fontSizes:["extra_large","large","medium","small"]},a.prototype.defaults),template:h,afterInitialize:function(){this.listenTo(this.model,"change:quote",this.updateQuoteSize),this.wrapSource()},createSubViews:function(){var t=this.subViewOptions(),e=s.extend({className:"quote-field",name:"quote",placeholder:"&ldquo;"+n("Quote")+"&rdquo;",ariaLabel:n("Quote")},t),i=s.extend({className:"source-field",name:"source",placeholder:n("Source"),ariaLabel:n("Source")},t);s.extend(i,{fullWidthInlineMedia:!1}),this.quote=this.subViews.quote=new r(e),this.source=this.subViews.source=new l(i)},afterRender:function(){return this.renderSubViews(),this.updateQuoteSize(this.model,this.model.get("quote")||""),s.isEmpty(this.model.get("source"))?this.delayedFocus(this.quote):this.delayedFocus(this.source),this.quote.editor.isEmpty()&&this.quote.editor.setData(""),this.cleanQuote(),this},teardown:function(){return this.$el.empty(),this},updateQuoteSize:function(t,e){if("string"==typeof e){var i=e.length;20>i?this._setQuoteSize("extra_large"):81>i?this._setQuoteSize("large"):300>i?this._setQuoteSize("medium"):this._setQuoteSize("small")}},_setQuoteSize:function(t){var e=this.quote.$el;e.hasClass(t)||(e.removeClass(this.get("fontSizes").join(" ")),e.addClass(t))},cleanQuote:function(){var t=this.model.get("quote");t&&this.model.set("quote",o.stripHtml(t,!1))},getRichTextEditor:function(){return this.source},wrapSource:function(){var t=this.model.get("source");!t||t.indexOf("<p>")>-1||this.model.set("source","<p>"+t+"</p>")}});e.exports=c},{"../../templates/post_type_form/quote.tpl":287,"../../utils/string_helpers":312,"../plaintext_editor":337,"../richtext_editor":354,"./base":345,lodash:"MicNly","prima/lib/translate":541}],351:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/lib/translate"),o=t("prima/lib/flags"),a=t("./base"),r=t("../plaintext_editor"),l=t("../reblog_tree"),h=t("../richtext_editor"),o=t("prima/lib/flags"),c=t("../../templates/post_type_form/text.tpl"),u=a.extend({events:{},template:c,createSubViews:function(){var t=this.subViewOptions(),e=this.post.isReblog(),i=e&&o.bool("reblog_ui_refresh"),a=s.extend({className:"title-field",name:"title",placeholder:n("Title"),ariaLabel:n("Post title"),smartQuotesEnabled:!0,disableEdit:i},t),c=s.extend({className:"caption-field",name:"body",placeholder:n("Your text here"),ariaLabel:n("Post body")},t),u=s.extend({isRemovable:!0,origType:this.post.get("type")},t);i&&"text"===this.post.get("type")?this.title=this.subViews.title=null:this.title=this.subViews.title=new r(a),this.body=this.subViews.body=new h(c),e&&(this.reblogTree=this.subViews.reblogTree=new l(u)),this.registerTitleKeyboardShortcut(this.title)},afterRender:function(){this.renderSubViews(),this.delayedFocus(this.body)},getRichTextEditor:function(){return this.body}});e.exports=u},{"../../templates/post_type_form/text.tpl":288,"../plaintext_editor":337,"../reblog_tree":353,"../richtext_editor":354,"./base":345,lodash:"MicNly","prima/lib/flags":"f/LVtH","prima/lib/translate":541}],352:[function(t,e,i){"use strict";var s=t("lodash"),n=t("jquery"),o=t("moment"),a=t("./base"),r=t("app/components/dialog"),l=(t("prima/lib/logger"),t("prima/lib/flags")),h=t("prima/lib/translate"),c=t("../../services/embed_data"),u=t("prima/utils/camelize-keys"),d=function(){return n.browser.chrome?".mp4,.mov,.wmv,video/*":n.browser.mozilla?"video/*":""}(),p=t("../media/video"),m=t("../media_dropzone"),g=t("../confirm_tos"),f=t("../richtext_editor"),_=t("../reblog_tree"),v=t("../../templates/post_type_form/video.tpl"),b=a.extend({template:v,maxVideoFileSize:104857600,defaults:s.defaults({hasMediaView:!0,hasMedia:!1,showTos:!1,showCaption:!1},a.prototype.defaults),afterInitialize:function(){this._urlParser=s.debounce(s.bind(this._embedCodeParser,this),100),this.post.getEmbedData()&&this.set({hasMedia:!0,showCaption:!0}),this.post.get("copyrightFallback")&&this.set({hasMedia:!0}),this.set("hideControlsLine",!this.get("showCaption"))},createSubViews:function(){var t=this.subViewOptions(),e=s.extend({embed:this.post.getEmbedData(),canEditMedia:this.post.canEditMedia()},t),i=s.extend({url:this.post.get("embedCode"),showInput:!s.isEmpty(this.post.get("embedCode")),embed:this.post.getEmbedData(),uploadIcon:"dropzone-add-video-icon",uploadText:h("Upload a video"),uploadTooltip:function(){var e=1e3*t.user.get("videoSecondsRemaining");return"<p>"+["<strong>"+h("Upload a video")+"</strong>",h("%1$s minutes of video remaining today.",o.utc(e).format("m:ss")),h("%1$s max per file.","100MB")].join("</p><p>")+"</p>"},urlIcon:"dropzone-add-url-icon",urlText:h("Add video from web"),urlPlaceholder:h("Paste a URL or embed code"),urlParser:this._urlParser,uploadOptions:{}},t);s.extend(i.uploadOptions,{name:"video",maxUploadSize:l.bool("ignore_video_upload_limits")?!1:this.maxVideoFileSize,uploadPattern:/^video\/(?:.*)$/i,accept:d,url:"/svc/post/upload_video"});var n=s.extend({},t),a=s.extend({className:"caption-field",name:"caption",placeholder:h("Add a caption, if you like"),ariaLabel:h("Caption")},t),r=s.extend({isRemovable:!0},t);this.mediaPreview=this.subViews.mediaPreview=new p(e),this.mediaComposer=this.subViews.mediaComposer=new m(i),this.confirmTos=this.subViews.confirmTos=new g(n),this.caption=this.subViews.caption=new f(a),this.post.isReblog()&&(this.reblogTree=this.subViews.reblogTree=new _(r))},addStateListeners:function(){this.listenTo(this.mediaComposer,"upload:start",this._onFileUploadStart),this.listenTo(this.mediaComposer,"upload:complete",this._onFileUploadComplete),this.listenTo(this.mediaComposer,"upload:error upload:invalid",this._onFileUploadError),this.listenTo(this.mediaPreview,"media:ready",function(){var t=s.toArray(arguments);t.unshift("media:ready"),this.trigger.apply(this,t)}),this.post.canEditMedia()&&this.listenTo(this.mediaPreview,"media:remove",this.removeMedia),this.listenTo(this,"change:hasMedia",this._onChangeHasMedia),this.listenTo(this,"change:showTos",this._onChangeShowTos),this.listenTo(this,"change:showCaption",this._onChangeShowCaption)},removeMedia:function(){this.post.softReset(),this.set({hasMedia:!1,showTos:!1}),this.mediaPreview.set({file:!1,embed:!1}),this.js$("confirmTos").attr("checked",!!this.post.get("confirmTos")),s.isEmpty(this.post.get("caption"))&&s.isEmpty(this.post.get("tags"))&&this.set("showCaption",!1)},_onChangeHasMedia:function(t,e){this.isRendered()&&(e?(this.mediaComposer.$el.css({display:"none",opacity:0}),this.mediaPreview.$el.css({display:"block",opacity:1})):(this.mediaPreview.$el.css({display:"none",opacity:0}),this.mediaComposer.$el.css({display:"block",opacity:1})))},_onChangeShowTos:function(t,e){this.isRendered()&&(e?this.js$("tos").css({display:"block",opacity:1}):this.js$("tos").css({display:"none",opacity:0}))},_onChangeShowCaption:function(t,e){this.set("hideControlsLine",!e),this.isRendered()&&(e?this.js$("caption").css({display:"block",opacity:1}):this.js$("caption").css({display:"none",opacity:0}))},_onFileUploadStart:function(t){this.uploads.add(t);var e=t.get("file");this.mediaPreview.set({file:e,canEditMedia:!0}),this.listenToOnce(this.mediaPreview,"media:ready",function(){this.set({hasMedia:!0,showTos:!0,showCaption:!0}),this.caption.focus()})},_onFileUploadComplete:function(t){var e=t.get("file"),i="portrait"===t.get("orientation");this.mediaPreview.set({file:e,canEditMedia:!0,width:i?t.get("height"):t.get("width"),height:i?t.get("width"):t.get("height")}),this.post.set({preuploadUrl:t.get("key"),preuploadKey:t.get("ch")})},_onFileUploadError:function(t){var e=t.get("error")||h("Error uploading video");s.isArray(e)&&(e=e.join("</p><p>")),l.bool("upload_to_vimeo")&&t.get("file").size>this.maxVideoFileSize||"Video file is too large"===e?this.launchVimeoDialog():r.alert("<p>"+e+"</p>"),this.removeMedia()},launchVimeoDialog:function(){var t={text:h("That's an impressively big video. Unfortunately, Tumblr can only handle 100MB at a time. If you're looking to post huuuuuge stuff, just use Vimeo."),type:"video-vimeo-error",visible_glass:!0,buttons:{0:{text:"Nevermind",callback:function(){}},1:{text:"Upload to Vimeo",selected:!0,btn_class:"blue upload-to-vimeo-btn",callback:function(){window.open("https://vimeo.com/upload?utm_source=tumblr&utm_medium=partner&utm_campaign=28742","_blank")}}},scroll_lock:!0};r.dialog(t)},_embedCodeParser:function(t,e,i){if(this._embedCodeParsing&&this._embedCodeParsing.abortEmbedCodeParse(),!s.isEmpty(s.trim(t))){var n=!1,o=this._parseEmbedCode=c.parseEmbedData(t,540).then(s.bind(function(i){n||(this._embedCodeParsing=!1),this.listenToOnce(this.mediaPreview,"media:ready",function(){this.set({hasMedia:!0,showCaption:!0}),this.caption.focus()}),this.mediaPreview.set(s.extend({embed:u(i),canEditMedia:!0},s.pick(i,["width","height"]))),e.trigger("url:complete"),this.post.set({embedCode:t})},this),function(t){e.trigger("url:error")});return o.abortEmbedCodeParse=function(){n=!0},o}},afterRender:function(){this.renderSubViews(),this.get("hasMedia")?this.mediaComposer.$el.css({display:"none",opacity:0}):this.mediaPreview.$el.css({display:"none",opacity:0}),this.get("showTos")||this.js$("tos").css({display:"none",opacity:0}),this.get("showCaption")?this.delayedFocus(this.caption):this.js$("caption").css({display:"none",opacity:0})},executeUrlParser:function(t){this.subViews.mediaComposer.urlParser(t)},getRichTextEditor:function(){return this.caption}});e.exports=b},{"../../services/embed_data":249,"../../templates/post_type_form/video.tpl":289,"../confirm_tos":319,"../media/video":332,"../media_dropzone":333,"../reblog_tree":353,"../richtext_editor":354,"./base":345,"app/components/dialog":44,jquery:"HlZQrA",lodash:"MicNly",moment:"iROhDJ","prima/lib/flags":"f/LVtH","prima/lib/logger":519,"prima/lib/translate":541,"prima/utils/camelize-keys":561}],353:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/view"),o=t("prima/lib/translate"),a=t("prima/lib/flags"),r=t("prima/mixins/subviewable"),l=t("prima/mixins/selectorcache"),h=t("prima/mixins/accessor"),c=t("../templates/reblog_tree.tpl"),u=t("app/components/remove-button"),d=n.extend({className:"post-reblog-tree",events:{"click .btn-toggle-reblog":"toggleRemoveReblogTree"},mixins:[r,l,h],template:c,render:function(){return this.removeButton=this.subViews.removeButton=new u({tooltip:o("Remove reblogs"),buttonClass:"btn-remove-tree btn-toggle-reblog"}),this.$el.html(this.template(this.serialize())),this.attachSubViews(),this},teardown:function(){return this.$el.empty(),this},serialize:function(){return{showReblogTree:!s.isUndefined(this.model.get("reblog_tree"))&&this.model.get("reblog_tree"),post:this.model}},toggleRemoveReblogTree:function(t){var e=this.$(t.currentTarget),i=e.closest(".control-reblog-tree"),s=this.model.has("remove_reblog_tree")&&this.model.get("remove_reblog_tree")===!0;this.model.set("remove_reblog_tree",!s),i.toggleClass("removed",!s)}});a.bool("reblog_ui_refresh")?e.exports=t("app/components/reblog-trail/views/reblog-trail"):e.exports=d},{"../templates/reblog_tree.tpl":290,"app/components/reblog-trail/views/reblog-trail":376,"app/components/remove-button":377,lodash:"MicNly","prima/lib/flags":"f/LVtH","prima/lib/translate":541,"prima/mixins/accessor":542,"prima/mixins/selectorcache":553,"prima/mixins/subviewable":554,"prima/view":580}],354:[function(t,e,i){"use strict";function s(t,e){e.find(".velocity-animating").each(function(t,e){c(e).removeClass("velocity-animating").removeAttr("style")}),e.find('[class=""]').removeAttr("class"),e.find('img[src^="data:"]').attr("src","")}function n(t,e,i,s){h.each(t,function(t,i){s.find("["+e+'="'+i+'"]').attr("data-uploading-key",i).removeAttr("src");
})}function o(t,e,i,s){h.each(t,function(t,i){s.find("["+e+'="'+i+'"]').remove()})}function a(t,e,i,s){h.each(t,function(t,i){s.find("["+e+'="'+i+'"]').attr("src",t)})}function r(t,e,i,s){s.find("["+t+"]").filter(e?":not([ "+e+"])":"*").removeAttr(t)}function l(t,e,i,s,n,o){o.find("["+s+'="'+t+'"]').removeAttr("data-uploading-key").removeAttr(s).attr("src",e)}var h=t("lodash"),c=t("jquery"),u=t("when"),d=t("prima/view"),p=t("velocity-animate").animate,m=t("velocity-animate").hook,g=t("prima/utils/exposer"),f=t("app/components/dialog"),_=(t("prima/lib/logger"),t("prima/lib/translate")),v=t("prima/events"),b=t("remarkable"),y=new b({html:!0}),w=t("to-markdown").toMarkdown,x=t("ligature"),C=t("ligature").HumanKeys,k=t("../services/mention_support"),S=t("../services/inline_embed_support"),T=t("../services/image-search-support"),E=t("./mention_dropdown"),P=t("./html_field"),M=t("app/components/upload"),F=t("prima/mixins/subviewable"),$=t("prima/mixins/selectorcache"),j=t("prima/mixins/accessor"),I=t("prima/mixins/tablimiter"),N=t("../templates/richtext_editor.tpl"),A=t("prima/lib/data"),R=t("../utils/validation"),D=t("prima/utils/url"),L=t("prima/utils/image/loader"),O=t("prima/utils/image/filereader"),B=t("prima/utils/image/canvas"),V=t("../services/image_url_upload"),U=t("../utils/remap-html-tags"),q=t("prima/utils/filter-html-by-dom"),H=t("prima/utils/dom"),z=t("../utils/apply-all"),W=t("prima/utils/image/types").convertToNormalizedType,G=1080,K=1,Q=2,J=d.extend({defaults:{placeholder:"",ariaLabel:"",name:"",syncWithModel:!0,supportImages:!0,supportImageSearch:!1,supportInlineEmbeds:!0,supportMentions:!0,fullWidthInlineMedia:!0,inlineMediaWidthReblog:250,inlineEmbedsPerPost:5,minFullWidthSize:{jpg:300,png:300,gif:300},fullWidthClass:"tmblr-full",animateInlineControls:!0},events:{},mixins:[j,F,$,I],template:N,pendingMedia:{},filtersToModel:[],filtersToEditor:[],initialize:function(t){t||(t=h.extend({},t)),h.extend(this.attributes,h.pick(t,h.keys(this.defaults))),h.extend(this,h.pick(t,"post")),h.has(t,"user")&&t.user.has("inlineEmbedsPerPost")?this.set("inlineEmbedsPerPost",t.user.get("inlineEmbedsPerPost")):this.set("inlineEmbedsPerPost",A.get("Components/PostFormBuilder/limits/inlineEmbedsPerPost")),this.hosts=A.get("Context/hosts"),this.editor=null,this.humanKeys=new C,this.keyCommands=J.KEYCOMMANDS,h.forEach(["onChange","onClientEvent","onImageAdded","pasteHook"],function(e){var i=t[e]||this[e];h.isFunction(i)?this[e]=h.bind(i,this):this[e]=h.noop},this);var e=this.get("name");e&&this.get("syncWithModel")&&(this.$el.attr("data-name",e),this.listenTo(this.model,"change:editorType",this._onChangeEditorType)),h.has(t,"user")&&t.user.has("inlineEmbedsPerPost")&&this.set("inlineEmbedsPerPost",t.user.get("inlineEmbedsPerPost")),h.has(t,"user")&&t.user.has("hasGifSearchVariation")&&this.set("hasGifSearchVariation",t.user.get("hasGifSearchVariation"))},_onChangeEditorType:function(t,e){var i=t.previous("editorType");"rich"===i?this.updateModelFromEditor("markdown"!==e?Q:K):"markdown"===i&&this.convertModelFromMarkdown(),"markdown"===e&&this.convertModelToMarkdown(),this.updateEditorType(e,!0),this.focus()},_initializeEditor:function(t,e){var i=h.bind(this.humanKeys.pretty,this.humanKeys),s={placeholder:e,flattenBlocks:!0,onChange:this._composeOnChange(),onAsyncImageAdded:h.bind(this.onAsyncImageAdded,this),onFileAdded:h.bind(this.insertImageFromFile,this),inlineControlsConfig:{openTray:h.bind(this.openInlineControlsTray,this),closeTray:h.bind(this.closeInlineControlsTray,this),onTrayOpened:h.bind(this.onInlineControlsTrayOpened,this),onTrayClosed:h.bind(this.onInlineControlsTrayClosed,this),onShow:h.bind(this.onInlineControlsShow,this),onHide:h.bind(this.onInlineControlsHide,this),customOffset:{x:0,y:0}},addImgAttrs:{toImg:!0,toImgParent:!0},formattingControlsConfig:{controls:{bold:{el:"b",className:"bold",command:"bold",type:"inline",title:_("Bold (%1$s)",i(this.keyCommands.BOLD)),keyboard:this.keyCommands.BOLD},italic:{el:"i",className:"italic",command:"italic",type:"inline",title:_("Italic (%1$s)",i(this.keyCommands.ITALIC)),keyboard:this.keyCommands.ITALIC},headline:{el:"h2",className:"headline",command:"formatBlock",type:"block",title:_("Headline (%1$s)",i(this.keyCommands.HEADLINE)),keyboard:this.keyCommands.HEADLINE},link:{el:"a",className:"link",command:"createLink",type:"inline",title:_("Link (%1$s)",i(this.keyCommands.LINK)),keyboard:this.keyCommands.LINK},strikethrough:{el:"strike",className:"strikethrough",command:"strikethrough",type:"inline",title:_("Strikethrough (%1$s)",i(this.keyCommands.STRIKETHROUGH)),keyboard:this.keyCommands.STRIKETHROUGH},orderedList:{el:"ol",className:"ordered-list",command:"insertOrderedList",type:"list",title:_("Ordered list (%1$s)",i(this.keyCommands.ORDEREDLIST)),keyboard:this.keyCommands.ORDEREDLIST},unorderedList:{el:"ul",className:"unordered-list",command:"insertUnorderedList",type:"list",title:_("Unordered list (%1$s)",i(this.keyCommands.UNORDEREDLIST)),keyboard:this.keyCommands.UNORDEREDLIST},blockquote:{el:"blockquote",className:"quote",command:"formatBlock",type:"block",title:_("Blockquote (%1$s)",i(this.keyCommands.BLOCKQUOTE)),keyboard:this.keyCommands.BLOCKQUOTE},clear:{el:"",command:"removeFormat",type:"inline",keyboard:this.keyCommands.REMOVEFORMAT},pre:{el:"pre",command:"formatBlock",type:"block",keyboard:this.keyCommands.PRE},superscript:{el:"sup",command:"superscript",type:"inline",keyboard:this.keyCommands.SUPERSCRIPT},subscript:{el:"sub",command:"subscript",type:"inline",keyboard:this.keyCommands.SUBSCRIPT},small:{el:"small",command:"insertHTML",type:"inline",keyboard:this.keyCommands.SMALL,keyboardInverse:this.keyCommands.SMALLINVERSE}},controlsOrder:["bold","italic","headline","link","strikethrough","orderedList","unorderedList","blockquote"]},pasteHook:this.pasteHook,blurHook:h.bind(this.blurHook,this),documentMousedownHook:h.bind(this.documentMousedownHook,this),runIFrameSanitization:!1,mediaHolderCallback:h.bind(this._mediaHolderCallback,this),filterRules:{elements:["a","b","i","strike","h2","blockquote","p","ul","ol","li","iframe","figure","img","br","hr","pre","code","small","sup","sub","figcaption"],attributes:{a:["href","title"],img:["src","alt","data-img-key","data-orig-width","data-orig-height","data-orig-src"],iframe:["src","width","height","allowfullscreen","mozallowfullscreen","webkitallowfullscreen","frameborder"],figure:["data-provider","data-url","data-orig-width","data-orig-height","data-orig-src","data-embed-code","data-tumblr-attribution"],hr:["data-label"]},classnames:{a:["tumblr_blog","tmblr-truncated-link"],hr:["tmblr-truncated"],blockquote:["link_og_blockquote"],figure:["tmblr-embed","tmblr-embed-placeholder","tmblr-full"]},remove_contents:["style","noscript","script","meta"],protocols:{a:!1,iframe:{src:["https://","http://","//"]}}},labels:{Edit:_("Edit"),Remove:_("Remove"),Open:_("Open"),Done:_("Done")},animateShowControls:function(t){t.element.show();var e=60,i=8;h.forEach(t.buttons,function(t,s){var n=c(t);p(n,"stop"),m(n,"translateY",i),n.css("opacity",0),p(n,{translateY:[0,i],opacity:[1,0]},{delay:.25*s*e,duration:e,complete:function(){n.attr("style","")}})},this)},animateHideControls:function(t){var e=100,i=8;h.forEach(t.buttons,function(s,n){var o=c(s);p(o,"stop");var a=p(o,{translateY:i,opacity:0},{duration:e});n===t.buttons.length-1&&a.then(function(){t.element.hide()})},this)},mediaKillerMarkup:'<div class="media-button icon_close"></div>',mediaMoverMarkup:'<div class="media-button icon_drag"></div>',showStaticControls:!1,smartQuotes:{enabled:!0}};this._setupEditorFilters(),this.editor=new x.RichTextEditor(t,s),this.inlineControlNode=!1,this.get("supportImages")&&this._initializeImageSupport(),this.inlineEmbedSupport=!1,this.get("supportInlineEmbeds")&&this._initializeInlineEmbedSupport(),this.imageSearchSupport=!1,this.get("supportImageSearch")&&this._initializeImageSearchSupport(),this.mentionSupport=!1,this.get("supportMentions")&&this._initializeMentionSupport(),this._initializeReadMoreSupport(),this.editor.config.filterForSetData=h.compose.apply(this,this.editorFilters.preSet),this.editor.config.filterForGetData=h.compose.apply(this,this.editorFilters.preGet),this.updateEditorType(),"markdown"===this.getEditorType()&&(this.model.set(this.get("name"),this._modelValue().replace(/^\s*<p>([\S\s]*)<\/p>\s*$/i,"$1")),this.htmlField.updateValueFromModel(),this.htmlField.updateEditor())},_setupEditorFilters:function(){this.editorFilters={preSet:[],preGet:[]},this.editorFilters.preSet.push(this._tagTranslator)},_tagTranslator:function(t,e){return e||(e={h1:"h2",h3:"b",h4:"b",h5:"b",h6:"b",strong:"b",em:"i"}),U(t,e)},updateInlineImages:function(){var t=!1,e=c(this.editor.element).find("img["+this.editor.config.imgKeyAttr+"]");e.each(h.bind(function(e,i){h.get(this.editor.mediaTracker[c(i).attr(this.editor.config.imgKeyAttr)],"updatedSource")||(t=!0)},this)),this.post.set("hasLoadingInlineImages",t)},_composeOnChange:function(){var t=[this.onChange],e=this;return this.get("syncWithModel")&&t.unshift(this.updateModelFromEditor),t.unshift(this.updateInlineImages),function(){h.each(t,function(t){t.call(e)})}},pasteHook:function(t,e){var i=t.getData("text/plain"),s=i.trim();return R.isImageUrl(s)&&!e?(this.insertImageFromUrl(s,i),!0):R.isUrl(s)&&!e?(this.editor.insertData('<a href="'+s+'">'+s+"</a>"),!0):void 0},cancelBlur:function(){this.cancelNextBlur=!0},resumeBlur:function(t){this.defaultBlur?this.defaultBlur(t):h.isFunction(t)&&t()},blurHook:function(t,e){return this.cancelNextBlur?(this.cancelNextBlur=!1,this.defaultBlur=e,!0):void 0},addElementToControlsCloseWhitelist:function(t){this.controlsCloseWhitelist||(this.controlsCloseWhitelist=[]),this.controlsCloseWhitelist.push(t)},removeElementFromControlsCloseWhitelist:function(t){h.isEmpty(this.controlsCloseWhitelist)||(this.controlsCloseWhitelist=h.without(this.controlsCloseWhitelist,t))},documentMousedownHook:function(t,e){return this.imageSearchSupport&&this.imageSearchSupport.isOpen()?!0:h.isEmpty(this.controlsCloseWhitelist)?void 0:h.find(this.controlsCloseWhitelist,function(e){return e===t.target||c.contains(e,t.target)})},_mediaHolderCallback:function(){this.mediaHolderCallback.apply(this,arguments)},mediaHolderCallback:function(t,e,i,s){i.is("hr, img, figure")&&h.isEmpty(i.find("iframe"))&&(s.addClass("media-holder-draggable"),h.isEmpty(i.find("[data-tumblr-query]"))||s.addClass("media-holder--gif-search")),s.addClass("media-holder-"+i.prop("tagName").toLowerCase())},_initializeImageSupport:function(){this.imageUploader=new M({name:"image",maxUploadSize:10485760,uploadPattern:/^image\/(?:.*)$/i,accept:"image/*",url:"/svc/post/upload_text_image"});var t=c("<div />",{"class":"control add-image","data-control-name":"inline-image",tabindex:"0",title:_("Insert photo (%1$s)",this.humanKeys.pretty(this.keyCommands.PHOTO))});t.on("click",h.bind(function(t){this.editor.staticControls.hide()},this)),t.append('<input type="file" accept="image/*" tabindex="-1" multiple="true">'),t.on('change input[type="file"]',h.bind(function(e){var i=c(e.target),s=h.toArray(i.prop("files"));h.forEach(s,function(t){this.insertImageFromFile(t)},this),i.remove(),t.append('<input type="file" accept="image/*" multiple="true">'),this.editor.inlineControls.close()},this)),this.editor.inlineControls.addToTray(t,{keyboard:{shortcut:this.keyCommands.PHOTO,callback:h.bind(function(){this._inlineControlKeyboardFocus(t)},this)}}),this.listenTo(this.imageUploader,"error",this._onFileUploadError)},_initializeImageSearchSupport:function(){var t=function(){this._inlineControlKeyboardFocus(this.imageSearchSupport.getButton(),function(){this.openImageSearch()},this)};this.imageSearchSupport=new T({editorView:this,editor:this.editor,title:_("Insert GIF (%1$s)",this.humanKeys.pretty(this.keyCommands.GIF)),trayOptions:{keyboard:{shortcut:this.keyCommands.GIF,callback:t,context:this}}}),this.mediaHolderCallback=z([this.mediaHolderCallback,h.bind(this.imageSearchSupport.addTumblrAttribution,this.imageSearchSupport)],this),this.filtersToModel.push(h.bind(this.imageSearchSupport.cleanupMarkup,this)),this.listenTo(this.imageSearchSupport,"prompt",function(){this.trigger("controls:gif:prompt")})},_onFileUploadError:function(t,e){var i=e.get("error")||_("Error uploading photo");f.alert("<p>"+i+"</p>")},insertImageFromUrl:function(t,e,i){e===!1||e||(e=t),i||(i={});var s=u.defer(),n=h.bind(function(){s.reject()},this);return L.load(t).then(h.bind(function(t){this.listenToOnce(this,"asyncImageAdded",function(t,e,i){s.resolve(t,e)}),this.editor.insertAsyncImage(t.src,null,i.targetNode,i.direction,i.skipSelectionUpdate)},this),h.bind(function(){e&&this.editor.insertData(e),n()},this)),s.promise},insertImageFromFile:function(t,e){e||(e={});var i=u.defer(),s=h.bind(function(){i.reject()},this);return t.type.match(/image\/(jpg|jpeg|png)/i)?O.read(t).then(h.bind(function(n){L.load(n.objectUrl||n.base64).then(h.bind(function(s){var o=new Image;o.src=s.src;var a=B.drawScaledAndRotated(o,s.width,s.height,n.rotation,n.mirrored,G);this.listenToOnce(this,"asyncImageAdded",function(t,e,s){i.resolve(t,e)}),this.editor.insertAsyncImage(a.toDataURL(n.file.type),t,e.targetNode,e.direction,e.skipSelectionUpdate)},this),s)},this),s):t.type.match(/image\/*/i)&&this.editor.insertAsyncImage(null,t,e.targetNode,e.direction,e.skipSelectionUpdate),i.promise},getMinFullWidthSize:function(t){var e=this.get("minFullWidthSize");return h.isNumber(e)?e:(t=W(t),h.has(e,t)?e[t]:null)},shouldBeFullWidth:function(t,e){var i;return this.get("fullWidthInlineMedia")&&(e=h.isNumber(e)?e:parseInt(e,10))?(i=this.getMinFullWidthSize(t),h.isNumber(i)?e>=i:!1):!1},addASyncImageFullWidthAttributes:function(t,e,i){var s;return e&&i&&this.shouldBeFullWidth(e,i)&&(s=this.editor.getAsyncImage(t))?(c(s).parent("figure").addClass(this.get("fullWidthClass")),!0):!1},onAsyncImageAdded:function(t,e,i,s){var n=h.has(s,"width")?s.width:null;if(i instanceof Blob)this.uploadInlineImage(t,i),this.pendingMedia[t]=e,this.addASyncImageFullWidthAttributes(t,i.type,n);else{if(!e||0!==e.lastIndexOf("http",0))return;D.isTumblrMediaUrl(e)?this.editor.updateAsyncImage(t,e):(this.uploadInlineImageUrl(t,e),this.pendingMedia[t]=e),this.addASyncImageFullWidthAttributes(t,D.getExtension(e),n)}this.trigger("asyncImageAdded",t,e,i)},updateImageAttributes:function(t,e,i){var s=this.model.get("editorType");"html"===s||"markdown"===s?("markdown"===s&&this.convertModelFromMarkdown(),this.model.set(this.get("name"),q(this._modelValue(),h.partial(l,t,e,i,this.editor.config.imgKeyAttr))),"markdown"===s&&this.convertModelToMarkdown(),this.htmlField.updateValueFromModel(),this.htmlField.updateEditor()):(this.editor.updateAsyncImage(t,e,i),this.updateModelFromEditor()),delete this.pendingMedia[t]},uploadInlineImageUrl:function(t,e){V.uploadImageUrl(e,h.bind(function(e){this.updateImageAttributes(t,e.response.url)},this),h.bind(function(){this.updateImageAttributes(t,e)},this),h.bind(function(){this.updateInlineImages()},this))},uploadInlineImage:function(t,e){var i=h.bind(function(t,e){this.listenTo(e,"change:complete change:error",h.bind(function(e){var i,s=e.get("url");e.get("raw_width")&&e.get("raw_height")&&(i={width:e.get("raw_width"),height:e.get("raw_height")}),h.has(e.changed,"error"),L.load(s).then(h.bind(function(e){this.updateImageAttributes(t,s,i)},this)).done(h.bind(function(){this.updateInlineImages()},this)),this.stopListening(e,"change:complete change:error")},this))},this),s=function(n){n.get("file")===e&&(i.call(this,t,n),this.stopListening(this.imageUploader,"add",s))},n=function(i,s){if(s.get("file")===e){var n=c(this.editor.getAsyncImage(t)),a=n.closest(".media-holder");a.length?a.remove():n.remove(),this.updateModelFromEditor();var r;r=s.get("error")||_("Error uploading photo"),h.isArray(r)&&(r=r.join("</p><p>")),f.alert("<p>"+r+"</p>",h.bind(this.editor.focus,this.editor)),o.call(this,i,s)}},o=function(t,i){var a=i.files?i.files[0]:i.file;a=a||i.get("file"),a===e&&(this.stopListening(this.imageUploader,"add",s),this.stopListening(this.imageUploader,"invalid",n),this.stopListening(this.imageUploader,"send",o))};this.listenTo(this.imageUploader,"add",s),this.listenTo(this.imageUploader,"invalid",n),this.listenTo(this.imageUploader,"send",o),this.imageUploader.addFiles([e])},toggleInlineControlsTray:function(t){h.has(this.editor,"inlineControls")&&(t=t||!1,this.editor.inlineControls.toggleTrayWithIntent(t))},openInlineControlsTray:function(t){t=t||this.editor.inlineControls.tray||c(),this.editor.inlineControls.isShown||this.editor.inlineControls.show(),p(t,"stop",!0),t.css({opacity:"",left:"",right:""}),this._logInteraction("open-inline-controls"),this.editor.setPlaceholder(!1),this.get("hasGifSearchVariation")||this.editor.blur(!0),this.$el.addClass("tray-open"),this.catchTabs(t),this.get("hasGifSearchVariation")||t.attr("tabindex",0).focus(),this.catchEsc(t,this.toggleInlineControlsTray),h.forEach(t.find("[data-control-name]"),function(t,e){var i=c(t);i.on("click.inline-control-logging",h.bind(function(t){var e=c(t.currentTarget);this._logInteraction("click-inline-control",{controlName:e.attr("data-control-name")})},this))},this);var e=function(){this.$el.closest(".gif-search-variation").addClass("gs-variation-ran-once"),this.set("gsVariationRanOnce",!0)};this.get("animateInlineControls")&&!this.get("gsVariationRanOnce")&&h.forEach(t.find(".control"),function(t,i,s){var n=c(t),o={opacity:0},a={opacity:1};this.get("hasGifSearchVariation")?(o.right="-25px",a.right=0):(o.left="-25px",a.left=0),p(t,"stop",!0),n.css(o),p(t,a,{delay:30*i,duration:300,easing:[.175,.885,.32,1.275],complete:t===h.last(s)?h.bind(e,this):null})},this)},closeInlineControlsTray:function(t){if(t=t||c(),this.releaseTabs(),this.releaseEsc(t),!this.get("hasGifSearchVariation")){t.find(".control").off("click.inline-control-logging");var e=function(){t.css({opacity:"",left:""}),t.length&&t.is(":visible")&&this.editor.focus(!0),this.editor.setPlaceholder(this.get("placeholder")),this.$el.removeClass("tray-open")};p(t,{opacity:0,left:"-=20px"},{duration:150,complete:h.bind(e,this)})}},onInlineControlsTrayOpened:function(t){this.inlineControlNode=this.editor.getCurrentElement(),this.inlineEmbedSupport&&(this.inlineEmbedSupport.trayOpened(t),this.trigger("controls:open",t))},onInlineControlsTrayClosed:function(t){this.get("delayGifSearchVariationUponEditMode")&&this.get("gsVariationRanOnce")&&(this.set("delayGifSearchVariationUponEditMode",!1),this.$(".inline-controls").removeClass("edit-mode-init-hide")),this.inlineControlNode=!1,this.inlineEmbedSupport&&(this.inlineEmbedSupport.trayClosed(t),this.trigger("controls:close",t))},onInlineControlsShow:function(t){this.get("delayGifSearchVariationUponEditMode")&&this.$(".inline-controls").addClass("edit-mode-init-hide"),t.element.show(),this.$el.addClass("inline-controls-show"),this.trigger("controls:show")},onInlineControlsHide:function(t){t.element.hide(),this.$el.removeClass("inline-controls-show"),this.trigger("controls:hide")},_initializeMentionSupport:function(){var t=["tumblelog"];h.isArray(this.editor.config.linkConfig.bypassClasses||!1)&&(t=h.union(this.editor.config.linkConfig.bypassClasses,t)),this.editor.linkControl.bypassClasses=t,this.mentionPopover=new E({pinnedSide:"none",teardownOnEscape:!1,identifier:"postForms:mentionDropdown"}),this.mentionSupport=new k(this.editor,this.mentionPopover),this.getEditorValue=h.compose(this.mentionSupport.stripGhost,this.getEditorValue)},_getReadMoreMarkup:function(){return'<hr class="tmblr-truncated" data-label="'+_("Keep reading")+'">'},convertReadMoreMagicKey:function(t){var e=t.replace(/\[\[MORE\]\]/g,this._getReadMoreMarkup());return e},convertReadMoreHtml:function(t){var e=c(H.nodeFromString(t));return e.find(".tmblr-truncated").replaceWith("[[MORE]]"),e.html()},_createEmptyParagraph:function(){return this.editor.isCursorAtStart()?this.editor.insertNewParagraphBefore():this.editor.insertNewParagraphAfter()},_inlineControlKeyboardFocus:function(t,e,i){var s;this.editor.hasSelection()||(s=function(){var s=this.get("animateInlineControls");this.set("animateInlineControls",!1),this.toggleInlineControlsTray(!0),t&&c(t).focus(),"function"==typeof e&&e.call(i||this,t),this.set("animateInlineControls",s)},this.editor.isEmptyElement()?s.call(this):(this.listenToOnce(this,"controls:show",function(){setTimeout(h.bind(s,this),50)}),this._createEmptyParagraph()))},_initializeReadMoreSupport:function(){var t=function(t){return t.stopPropagation(),t.preventDefault(),!1},e=h.bind(function(){this.editor.hasSelection()||this.editor.insertMedia("<hr>")},this),i=h.bind(function(){if(!this.editor.hasSelection()){var t=this.$(".media-holder .tmblr-truncated");t.length&&t.closest(".media-holder").remove(),this.editor.insertMedia(this._getReadMoreMarkup())}},this),s=c("<div />",{"class":"control add-hr","data-control-name":"hr",tabindex:"0",title:_("Insert horizontal line (%1$s)",this.humanKeys.pretty(this.keyCommands.HR))});s.on("click",e),s.on("mousedown",t);var n=c("<div />",{"class":"control add-read-more","data-control-name":"read-more",tabindex:"0",title:_("Insert read-more link (%1$s)",this.humanKeys.pretty(this.keyCommands.MORE))});n.on("click",i),n.on("mousedown",t),this.editor.inlineControls.addToTray(s,{keyboard:{shortcut:this.keyCommands.HR,callback:e}}),this.editor.inlineControls.addToTray(n,{keyboard:{shortcut:this.keyCommands.MORE,callback:i}}),this.editorFilters.preSet.push(h.bind(function(t){var e=t;return e=this.convertReadMoreMagicKey(e)},this)),this.editorFilters.preGet.push(h.bind(function(t){var e=t;return e=this.convertReadMoreHtml(e)},this))},_initializeInlineEmbedSupport:function(){var t=function(){this.inlineEmbedSupport&&!this.inlineEmbedSupport.isDisabled&&this._inlineControlKeyboardFocus(this.inlineEmbedSupport.getButton(),function(){this.inlineEmbedSupport.prompt()},this)};this.inlineEmbedSupport=new S({editorView:this,editor:this.editor,inlineEmbedsPerPost:this.get("inlineEmbedsPerPost"),inlineMediaWidthReblog:this.get("inlineMediaWidthReblog"),inlineMediaWidthFull:this.get("fullWidthInlineMedia")?540:500,fullWidthInlineMedia:this.get("fullWidthInlineMedia"),fullWidthClass:this.get("fullWidthClass"),title:_("Insert video (%1$s)",this.humanKeys.pretty(this.keyCommands.EMBED)),disabledTitle:_("Sorry, you can't add more than %1$s videos",this.get("inlineEmbedsPerPost")),trayOptions:{keyboard:{shortcut:this.keyCommands.EMBED,callback:t,context:this}}}),this.editorFilters.preSet.push(h.bind(function(t){return this.inlineEmbedSupport?this.inlineEmbedSupport.addEmbedPlaceholders(t):t},this)),this.editorFilters.preGet.push(h.bind(function(t){return this.inlineEmbedSupport?this.inlineEmbedSupport.removeEmbedPlaceholders(t):t},this)),this.listenTo(this.inlineEmbedSupport,"prompt",function(){this.trigger("controls:embed:prompt")})},beforeRender:function(){this.htmlField=this.subViews.htmlField=new P({model:this.model,name:this.get("name")})},afterRender:function(){if(this.renderSubViews(),this.get("hasGifSearchVariation")){this.getEditorValue()&&this.set("delayGifSearchVariationUponEditMode",!0);var t=setTimeout(h.bind(function(){this.openInlineControlsTray(),this.editor.setPlaceholder(this.get("placeholder"))},this),400);this.set("openTrayTimeout",t)}},remove:function(){this._removed=!0,this.subViews=null,clearTimeout(this.get("openTrayTimeout"))},render:function(){var t=this._modelValue().length>0;t&&this.set("placeholder",!1),this.$el.html(this.template({ariaLabel:this.get("ariaLabel")}));var e=this.js$("richTextEditor").get(0);return this._initializeEditor(e,this.get("placeholder")),t&&("rich"!==this.getEditorType()||this.editorValueMatchesModel()||this.updateEditorFromModel()),this.attachSubViews(),this},teardown:function(){return this.$el.empty(),this.editor.teardown(),this.imageUploader&&(this.stopListening(this.imageUploader),this.imageUploader.teardown(),delete this.imageUploader),this.imageSearchSupport&&this.imageSearchSupport.teardown(),delete this.mentionSupport,delete this.inlineEmbedSupport,delete this.imageSearchSupport,this.editorFilters&&delete this.editorFilters,this},serialize:function(){return this.toJSON()},getEditorType:function(){return this.model.get("editorType")},getEditorValue:function(t,e){return"undefined"!=typeof t||(t=!0),"undefined"!=typeof e||(e=!0),this.editor?this.editor.getData(t,e):null},setEditorValue:function(t,e,i){this.editor&&this.editor.setData(t,e,i)},convertModelFromMarkdown:function(){var t=y.render(this._modelValue());return this.model.set(this.get("name"),t),t},convertModelToMarkdown:function(){var t=w(this._modelValue());return t=t.replace(new RegExp(/<figcaption\b([^>]*)>([\s\S]*?)<\/figcaption>/gi),"$2"),t=t.replace(new RegExp(/<figure\b([^>]*)>([\s\S]*?)<\/figure>/gi),"$2"),this.model.set(this.get("name"),t),t},updateModelFromEditor:function(t,e){if(!this.editor)return!1;var i=this.get("name"),a=this.getEditorValue(),l=[s];h.isEmpty(this.pendingMedia)||(t===Q?l.push(h.partial(n,this.pendingMedia,this.editor.config.imgKeyAttr)):t===K&&l.push(h.partial(o,this.pendingMedia,this.editor.config.imgKeyAttr))),e||l.push(h.partial(r,this.editor.config.imgKeyAttr,"data-uploading-key")),h.isEmpty(this.filtersToModel)||(l=l.concat(this.filtersToModel)),a=q(a,l),this.model.set(i,a)},updateEditorFromModel:function(){var t=this.getEditorValue(),e=this._modelValue();t=q(t,s),h.isEmpty(this.filtersToEditor)||(e=q(e,this.filtersToEditor)),this.setEditorValue(e,!0)},editorValueMatchesModel:function(){var t=this.getEditorValue(),e=this._modelValue(),i=[s];return h.isEmpty(this.pendingMedia)||i.push(h.partial(n,this.pendingMedia,this.editor.config.imgKeyAttr)),i.push(h.partial(r,this.editor.config.imgKeyAttr,"data-uploading-key")),h.isEmpty(this.filtersToModel)||(i=i.concat(this.filtersToModel)),t=q(t,i),e.trim()===t.trim()},updateEditorType:function(t,e){t||(t=this.model.get("editorType"));var i=c(this.editor.wrapper),s=!!this.model.get("hasSeenHtml");if("rich"===t){this.htmlField.hide();var n=this._modelValue(!0),o=[];h.isEmpty(this.pendingMedia)||o.push(h.partial(a,this.pendingMedia,this.editor.config.imgKeyAttr)),o.push(h.partial(r,this.editor.config.imgKeyAttr,"data-uploading-key")),n=q(n,o),this.setEditorValue(n,!0,s),i.show()}else i.hide(),this.htmlField.updateValueFromModel(),this.htmlField.set("isMarkdown","markdown"===t),e&&this.htmlField.set("editedSincePreview",!0),this.htmlField.show(),this.htmlField.showSource(s),this.model.set("hasSeenHtml",!0)},_modelValue:function(t){var e=this.model.get(this.get("name"))||"";return e=e.replace(/<!-- +more +-->/gi,"[[MORE]]"),t&&h.result(this.model,"isReblog")&&(e=e.replace(/<p>\s*<br\s*\/?>\s<\/p>$/i,"")+"<p><br></p>"),e},focus:function(t){this.editor&&"rich"===this.getEditorType()?this.editor.focus(t):this.htmlField&&this.htmlField.focus()},blur:function(t){this.editor&&"rich"===this.getEditorType()?this.editor.blur(t):this.htmlField&&this.htmlField.blur()},catchEsc:function(t,e){c(t).on("keydown.rteCatchEsc",h.bind(function(t){27===t.keyCode&&(e.call(this),t.stopPropagation())},this))},releaseEsc:function(t){c(t).off("keydown.rteCatchEsc")},setCursorToEnd:function(){this.editor&&h.isFunction(this.editor.setCursorToEnd)&&this.editor.setCursorToEnd()},_logInteraction:function(t,e){var i={action:t,tumblelog:this.model.get("tumblelog"),mode:this.model.get("mode"),postType:this.model.get("type"),editorType:this.model.get("editorType")};i.inputLength=this.getEditorValue().length,e&&(i=h.extend(i,e)),v.trigger("postform-interaction:"+t,{loggingData:i})},openImageSearch:function(){this.imageSearchSupport&&this.imageSearchSupport.prompt(this.imageSearchSupport.get("query",!1))}},{KEYCOMMANDS:{BOLD:"meta+b",ITALIC:"meta+i",HEADLINE:"meta+shift+2",LINK:"meta+k",STRIKETHROUGH:"meta+shift+6",ORDEREDLIST:"meta+shift+7",UNORDEREDLIST:"meta+shift+8",BLOCKQUOTE:"meta+shift+9",REMOVEFORMAT:"meta+shift+0",PRE:"meta+shift+x",SUPERSCRIPT:"meta+dot",SUBSCRIPT:"meta+comma",SMALL:"meta+shift+minus",SMALLINVERSE:"meta+shift+plus",PHOTO:"meta+shift+p",GIF:"meta+shift+g",EMBED:"meta+shift+m",HR:"meta+shift+l",MORE:"meta+shift+k"}});g({"Tumblr.Prima.RichTextEditorView":J}),e.exports=J},{"../services/image-search-support":250,"../services/image_url_upload":251,"../services/inline_embed_support":252,"../services/mention_support":253,"../templates/richtext_editor.tpl":291,"../utils/apply-all":305,"../utils/remap-html-tags":309,"../utils/validation":313,"./html_field":323,"./mention_dropdown":334,"app/components/dialog":44,"app/components/upload":389,jquery:"HlZQrA",ligature:620,lodash:"MicNly","prima/events":512,"prima/lib/data":514,"prima/lib/logger":519,"prima/lib/translate":541,"prima/mixins/accessor":542,"prima/mixins/selectorcache":553,"prima/mixins/subviewable":554,"prima/mixins/tablimiter":555,"prima/utils/dom":567,"prima/utils/exposer":569,"prima/utils/filter-html-by-dom":570,"prima/utils/image/canvas":571,"prima/utils/image/filereader":572,"prima/utils/image/loader":573,"prima/utils/image/types":574,"prima/utils/url":579,"prima/view":580,remarkable:"tJkXfs","to-markdown":"ArhiFs","velocity-animate":"lWl/mc",when:"RG2dij"}],355:[function(t,e,i){"use strict";var s=t("prima/view"),n=t("prima/utils/bindendevent").animation,o=t("../templates/richtext_editor_tutorial.tpl"),a=s.extend({className:"post-form--richtext-editor-tutorial popover tutorial",template:o,events:{"click > button":"close"},remove:function(){return this.trigger("removed",this),s.prototype.remove.apply(this,arguments)},close:function(){n(this.$el,this.remove.bind(this)),this.trigger("closing",this),this.$el.addClass("closing")},render:function(){return this.$el.html(this.template(this.attributes)),this}});e.exports=a},{"../templates/richtext_editor_tutorial.tpl":292,"prima/utils/bindendevent":560,"prima/view":580}],356:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/view"),o=t("prima/lib/translate"),a=t("prima/events"),r=t("prima/mixins/accessor"),l=t("prima/mixins/subviewable"),h=t("prima/mixins/selectorcache"),c=t("../templates/save_post_button.tpl"),u=t("./save_post_dropdown"),d=t("components/knight-rider-loader"),p=n.extend({className:"post-form--save-button",events:{"click [data-js-clickableSaveDropdown]":"toggleSavePostDropdown","mousedown [data-js-clickableSaveDropdown]":"savePostDropdownIntent"},mixins:[r,l,h],template:c,initialize:function(t){this.options=t=s.extend({shift:{x:0,y:10},identifier:"postForms:savePostDropdown"},t),s.extend(this,s.pick(t,"post","user","uploads")),this.savePostDropdown=new u(t),this.set("initialPostPseudoState",this.post.get("pseudoState"))},checkCanPost:function(){this.set("canPost",this.post.isValid()&&!this.uploads.anyUploading())},checkIsActive:function(){this.set("isActive",this.get("canPost")&&!this.savePostDropdown.isRendered())},setStateForContext:function(){if("new"===this.post.get("mode")){var t=this.post.getContextPage();"drafts"===t?this.savePostDropdown.setOptionDraft():"queue"===t&&this.savePostDropdown.setOptionQueue()}},render:function(){return this.$el.html(this.template()),this.loader=this.subViews.loader=new d({variation:"centered small"}),this.savePostDropdown.setPinnedTarget(this.js$("clickableSaveDropdown")),this.attachSubViews(),this.loader.render(),this.setStateForContext(),this.checkCanPost(),this.checkIsActive(),this.set("buttonLabel",this.buttonLabelForPseudoState()),this.updateButtonLabel(),this.updateButtonEnabledState(),this},afterRender:function(){this.listenTo(this.post,"change validate",this.checkCanPost),this.listenTo(this.uploads,"change:uploading",this.checkCanPost),this.listenTo(this.savePostDropdown,"open close",this.checkIsActive),this.listenTo(this.post,"change:state",function(t,e){this.set("buttonLabel",this.buttonLabelForPseudoState(t.get("pseudoState")))}),this.listenTo(a,"postForms:saving",this.showLoader),this.listenTo(a,"postForms:error",this.hideLoader),this.listenTo(this,"change:canPost",this.checkIsActive),this.listenTo(this,"change:isActive",this.updateButtonEnabledState),this.listenTo(this,"change:buttonLabel",this.updateButtonLabel);
},updateButtonEnabledState:function(t,e){!s.isUndefined(e)||(e=this.get("isActive")),this.js$("clickableSave").toggleClass("disabled",!e).prop("disabled",!e)},updateButtonLabel:function(t,e){e||(e=this.get("buttonLabel")),this.js$("clickableSave").text(e)},showLoader:function(){this.toggleLoader(!0)},hideLoader:function(){this.toggleLoader(!1)},toggleLoader:function(t){var e=!!t;this.$el.css({width:e?this.$el.width():"",height:e?this.$el.height():""}),this.loader.set("loading",e),this.js$("clickableSaveDropdown").toggle(!e),this.js$("clickableSave").toggle(!e)},buttonLabelForPseudoState:function(t,e,i){switch(t||(t=this.post.get("pseudoState")),e||(e=this.get("initialPostPseudoState")),i||(i=this.post.get("mode")),t){case"published":return o("reblog"===i?"Reblog":"edit"===i&&"published"===e?"Save":"Post");case"queued":return o("Queue");case"scheduled":return o("Schedule");case"draft":return o("Save draft");case"private":return o("edit"===i&&"private"===e?"Save":"Post privately");default:return o("Post")}},toggleSavePostDropdown:function(t){s.isBoolean(t)||(t=!this.savePostDropdown.isOrWasRecentlyRendered()),t?this.savePostDropdown.render():this.savePostDropdown.remove()},savePostDropdownIntent:function(){this.trigger("dropdown:intent")}});e.exports=p},{"../templates/save_post_button.tpl":293,"./save_post_dropdown":357,"components/knight-rider-loader":461,lodash:"MicNly","prima/events":512,"prima/lib/translate":541,"prima/mixins/accessor":542,"prima/mixins/selectorcache":553,"prima/mixins/subviewable":554,"prima/view":580}],357:[function(t,e,i){"use strict";var s=t("jquery"),n=t("lodash"),o=t("prima/view"),a=t("prima/lib/translate"),r=t("prima/events"),l=t("prima/mixins/accessor"),h=t("prima/mixins/subviewable"),c=t("prima/mixins/selectorcache"),u=t("prima/mixins/popoverbase"),d=t("./post_preview"),p=t("../models/blog_preview_key"),m=t("../templates/save_post_dropdown.tpl"),g=o.extend({className:"popover--save-post-dropdown",events:{"click [data-js-preview]":"triggerPostPreview","click [data-js-publish]":"setOptionPublish","click [data-js-draft]":"setOptionDraft","click [data-js-private]":"setOptionPrivate","click [data-js-queue]":"setOptionQueue","click [data-js-schedule]":"setOptionSchedule","input [data-js-scheduleText]":"scheduleInputUpdated","keypress [data-js-scheduleText]":"checkScheduleComplete"},mixins:[l,h,c,u],postStateOptions:["published","queued","scheduled","draft","private"],template:m,initialize:function(t){this.user=t.user},render:function(){return this.delegateEvents(),this._updateViewAttributes(),this.$el.html(this.template(this.serialize())),this._updateViewElements(),r.trigger("postForms:dismissListener:suspend"),this},teardown:function(){return this.$el.remove(),r.trigger("postForms:dismissListener:resume"),this},serialize:function(){var t=n.extend({__:a},this.attributes);return t},_updateViewAttributes:function(){this.set({showPreview:this.model.canPreview(),state:this.model.get("pseudoState"),activeOptions:"edit"===this.model.get("mode")&&this.model.get("createdPost")?["published","private"]:this.postStateOptions})},_updateViewElements:function(){"scheduled"===this.model.get("state")?this.js$("scheduleText").val(this.model.get("publish_on")):s("[data-js-scheduleText]",this.$el).hide(),this.js$("preview").toggleClass("disabled",!this.model.isValid())},triggerPostPreview:function(){if(this.model.isValid()){var t=this._previewPost();t&&this.teardown()}},setOptionPublish:function(){this._unSchedule(),this.model.set({state:"published",is_private:!1}),this.teardown()},setOptionDraft:function(){this._unSchedule(),this.model.set("state","draft"),this.teardown()},setOptionPrivate:function(){this._unSchedule(),this.model.set({state:"private",is_private:!0}),this.teardown()},setOptionQueue:function(){this._unSchedule(),this.model.set("state","queued"),this.teardown()},setOptionSchedule:function(){if(!this.scheduling){this.scheduling=!0,this._selectOption(this.js$("schedule")),this.model.set("state","scheduled");var t=this.js$("scheduleText");if(!t.value){var e=t.attr("placeholder");t.val(e),this.model.set("publish_on",e)}this.js$("scheduleText").show()}},scheduleInputUpdated:function(t){this.model.set("publish_on",t.target.value)},checkScheduleComplete:function(t){13===t.which&&this.teardown()},_selectOption:function(t){this.js$("options").children().removeClass("icon_checkmark"),t.addClass("icon_checkmark")},_unSchedule:function(){this.scheduling=!1,this.model.set("publish_on","")},_previewPost:function(){var t=this.model.get("tumblelog"),e=this.user.getChannel(t).get("blog_url")+"post/preview",i=this.model.toJSON({url:"/svc/post/update",forServer:!0});if(i.preview_key=p.fetchForBlog(t),n.isEmpty(i.preview_key))return!1;var s=new d({action:e,inputs:i});return s.render().$("form").css({"pointer-events":"none",overflow:"hidden",position:"absolute",bottom:0,right:0,width:1,height:1,opacity:0}).appendTo("body").submit().remove(),!0}});e.exports=g},{"../models/blog_preview_key":235,"../templates/save_post_dropdown.tpl":294,"./post_preview":339,jquery:"HlZQrA",lodash:"MicNly","prima/events":512,"prima/lib/translate":541,"prima/mixins/accessor":542,"prima/mixins/popoverbase":550,"prima/mixins/selectorcache":553,"prima/mixins/subviewable":554,"prima/view":580}],358:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/view"),o=t("prima/mixins/subviewable"),a=t("prima/mixins/selectorcache"),r=t("prima/mixins/accessor"),l=t("../templates/social_buttons.tpl"),h=t("./tweet_dropdown"),c=n.extend({className:"post-forms--social-buttons",events:{"click [data-js-shareIcon]":"_onClickShareIcon","mouseenter [data-js-twitterIcon]":"_onMouseEnterTwitterIcon"},mixins:[o,a,r],services:["facebook","twitter"],template:l,defaults:{facebook:!1,twitter:!1,facebookOn:!1,twitterOn:!1},initialize:function(t){this.options=t=s.extend({},t,{shift:{x:90,y:10},identifier:"postForms:tweetDropdown"}),s.extend(this,s.pick(t,"post","user","uploads","dragEvents")),this.updateStateFromPost(),this.shouldShowSocialIcons()||this.set({twitter:!1,facebook:!1}),this.updatePostFromState()},_onClickShareIcon:function(t){t.preventDefault();var e=this.$(t.currentTarget),i=e.parent(),s=i.data("service"),n=this.post.get("tumblelog"),o=this.user.getChannel(n);switch(s){case"twitter":o.set("twitter_send_posts",!this.get("twitterOn")),this.post.set("send_to_twitter",!this.get("twitterOn")),this.toggleTweetDropdown(this.post.get("send_to_twitter"));break;case"facebook":o.set("facebook_opengraph_send_posts",!this.get("facebookOn")),this.post.set("send_to_fbog",!this.get("facebookOn"))}},_onMouseEnterTwitterIcon:function(t){this.get("twitterOn")&&(t.preventDefault(),this.toggleTweetDropdown(!0))},_onChangeTumblelog:function(){this.teardown(),this.updateStateFromPost(),this.updatePostFromState(),this.render()},_onChangePostState:function(){"private"===this.post.get("pseudoState")&&this.post.changed.is_private?(this.lastSettings=s.pick(this.attributes,"twitter","facebook"),this.set({twitter:!1,facebook:!1})):this.set(this.lastSettings)},shouldShowSocialIcons:function(){return"new"===this.post.get("mode")||"reblog"===this.post.get("mode")||"published"!==this.post.get("state")&&"private"!==this.post.get("state")},updateStateFromPost:function(){var t=this.post.get("tumblelog"),e=this.user.getChannel(t),i=e.get("can_send_to_twitter"),n=e.get("can_send_to_facebook");this.shouldShowSocialIcons()||(i=n=!1);var o=this.post.get("send_to_twitter"),a=this.post.get("send_to_fbog");"edit"!==this.post.get("mode")&&(o=e.get("twitter_send_posts"),a=e.get("facebook_opengraph_send_posts")),this.set({twitter:i,facebook:n,twitterOn:!!o,facebookOn:!!a}),this.lastSettings=s.pick(this.attributes,"twitter","facebook")},updatePostFromState:function(){this.post.set({send_to_twitter:this.get("twitterOn"),send_to_fbog:this.get("facebookOn")})},toggleTweetDropdown:function(t){t?!1===this.tweetDropdown.isRendered()&&this.tweetDropdown.render():this.tweetDropdown.teardown()},serialize:function(){return this.toJSON()},beforeRender:function(){this.tweetDropdown=new h(this.options),this.listenTo(this.post,"change:send_to_fbog",function(t,e){this.set("facebookOn",!!e)}),this.listenTo(this.post,"change:send_to_twitter",function(t,e){this.set("twitterOn",!!e)}),this.listenTo(this,"change:twitterOn",function(t,e){this.js$("twitter").toggleClass("hidden",!this.get("twitter")).toggleClass("checked",e)}),this.listenTo(this,"change:facebookOn",function(t,e){this.js$("facebook").toggleClass("hidden",!this.get("facebook")).toggleClass("checked",e)})},render:function(){return this.$el.html(this.template(this.toJSON())),this.tweetDropdown.setPinnedTarget(this.js$("tweetDropdownPin")),this},afterRender:function(){this.listenTo(this.post,"change:state",this._onChangePostState),this.listenTo(this.post,"change:tumblelog",this._onChangeTumblelog),this.listenTo(this.post,"change:send_to_twitter",function(t,e){e||this.post.unset("customTweet")})},teardown:function(){return this.stopListening(),this.tweetDropdown.teardown(),this}});e.exports=c},{"../templates/social_buttons.tpl":295,"./tweet_dropdown":365,lodash:"MicNly","prima/mixins/accessor":542,"prima/mixins/selectorcache":553,"prima/mixins/subviewable":554,"prima/view":580}],359:[function(t,e,i){"use strict";var s=t("lodash"),n=t("jquery"),o=t("prima/view"),a=t("prima/lib/translate"),r=t("prima/mixins/accessor"),l=t("prima/mixins/subviewable"),h=t("prima/mixins/selectorcache"),c=t("./plaintext_editor"),u=t("./tag_suggest"),d=t("app/components/sortable/sortable"),p=t("../templates/tag_editor.tpl"),m=t("./tag_label"),g=o.extend({className:"post-form--tag-editor",defaults:{maxTagLength:140,suggestMinLength:2,showSuggestPopover:!1,editorHistory:[],sortableTags:null,currentlySelectedTags:[],tagEntryPlaceholder:".tag-input-wrapper .editor-plaintext",currentTag:null},mixins:[r,l,h],template:p,events:{click:"focusOnTagEditor"},initialize:function(t){this.options=t=s.pick(t,"post","user","model"),s.extend(this,s.pick(t,"post","user")),this.placeholder=a("#tags")},addTagProperties:function(t,e){this.listenTo(t,"toggleTagSelection",this.toggleTagSelection),this.listenTo(t,"addHoverStyle",this.addHoverStyle),this.listenTo(t,"removeHoverStyle",this.removeHoverStyle),t.el.draggable=!0,this.subViews["tagLabel_"+e]=t,this.tagLabelViews.push(t)},createSubViews:function(){var t=s.extend({placeholder:this.model.get("tags").length>0?!1:this.placeholder,name:"tagInput",forceSingleLine:!0,onClientEvent:s.bind(this.handleInputKeys,this),ariaLabel:a("Post tags")},this.options),e={post:this.post,user:this.user,shift:{x:0,y:15},identifier:"postForms:tagSuggest"};this.tagInput=this.subViews.tagInputField=new c(t),this.tagSuggest=new u(e),this.tagLabelViews=[],s.forEach(this.post.get("tags"),function(t){var e=new m({label:t});this.addTagProperties(e,t)},this),this.makeTagsSortable()},attachSubViews:function(t){return this.attachSubView(this.tagInput,"tagInputField"),s.forEach(this.tagLabelViews,function(t){this.js$("tagInputFieldWrapper").before(t.$el)},this),this},beforeRender:function(){this.createSubViews(),this.addTagEditorListeners()},render:function(){return this.$el.html(this.template()),this.attachSubViews(),this},afterRender:function(){this.renderSubViews(),this.tagSuggest.setPinnedTarget(this.js$("tagInputGhost")),n(this.tagInput.editor.element).on("blur",s.bind(this.submitTag,this))},teardown:function(){return this.stopListening(),this.tagLabelViews=[],this.set("sortableTags",null),this.set("currentlySelectedTags",[]),this},makeTagsSortable:function(){this.set("sortableTags",new d({el:this.el,itemClassName:".tag-label",dropInParent:!0,afterDragEnd:s.bind(this.saveTagOrder,this),transparentPlaceholder:!0,scrollable:!1})).on("dragstart",this.selectCurrentTag,this)},selectCurrentTag:function(t){this.set("currentlySelectedTags",[]),this.$(".tag-label").removeClass("selected"),this.set("currentTag",this.$(".sortable-dragging").text())},getTagOrder:function(){return s.map(this.$(".tag-label"),function(t){return n(t).text()})},setTagOrder:function(t){t||(t=this.getTagOrder()),s.forEach(this.tagLabelViews,function(t){this.stopListening(t)},this),this.removeTags(),this.removePlaceholder();for(var e=0;e<t.length;e++)this.addTag(t[e]);this.post.set("tags",t)},saveTagOrder:function(){if(this.post.get("tags").length<=1)return!1;var t=this.getTagOrder();return s.isEqual(t,this.post.get("tags"))||this.setTagOrder(t),!0},addTagEditorListeners:function(){this.listenTo(this.model,"change:tagInput",this.handleTagInput),this.listenTo(this.tagInput,"tagInput:submitTag",this.submitTag),this.listenTo(this.tagSuggest,"tagSuggest:submitTag",this.submitTag),this.listenTo(this.tagInput,"tagInput:backspace",this.handleBackspace),this.tagSuggest.listenTo(this,"tagEditor:fetchSuggestions",this.tagSuggest.fetchSuggestions),this.tagSuggest.listenTo(this.tagInput,"tagInput:cycleUp",this.tagSuggest.cycleUp),this.tagSuggest.listenTo(this.tagInput,"tagInput:cycleDown",this.tagSuggest.cycleDown),this.tagSuggest.listenTo(this.tagInput,"tagInput:dismissSuggestions",this.tagSuggest.dismiss)},handleInputKeys:function(t){var e,i=["keyup","keydown","keypress"],s={keydown:{38:"tagInput:cycleUp",40:"tagInput:cycleDown",8:"tagInput:backspace",9:"tagInput:submitTag",13:"tagInput:submitTag"},keypress:{44:"tagInput:submitTag"}};if(-1!==i.indexOf(t.type))if(t=t||window.event,e=t.which||t.keyCode,"keydown"===t.type||"keypress"===t.type)if(e in s[t.type]){this.tagInput.trigger(s[t.type][e],t);var n=/Mac/.test(navigator.platform)?t.metaKey:t.ctrlKey;8===e||13===e&&n||(t.preventDefault(),t.stopImmediatePropagation())}else this.tagInput.getEditorValue().length>=this.get("maxTagLength")&&(t.preventDefault(),t.stopImmediatePropagation());else if(e in s.keypress||e in s.keydown&&8!==e)return!1},handleTagInput:function(t,e){var i=e&&e.length>=this.get("suggestMinLength");i?this.trigger("tagEditor:fetchSuggestions",e,this._postTags()):this.tagInput.trigger("tagInput:dismissSuggestions"),this.js$("tagInputGhost").text(e)},handleBackspace:function(){if(0===this.tagInput.getEditorValue().length){var t=this.get("currentlySelectedTags");t.length>0?(s.forEach(t,function(t){this.removeTag(t)},this),this.set("currentlySelectedTags",[]),this.$(this.get("tagEntryPlaceholder")).removeClass("tiny-width")):this._postTags().length&&this.removeTag()}},submitTag:function(t){if(t&&"blur"===t.type){if(this._postTags().length||this.tagInput.editor.setPlaceholder(this.placeholder),this.tagSuggest.get("interactive"))return}else this.tagInput.editor.setPlaceholder(!1);var e=this.tagSuggest.get("interactive")?this.tagSuggest.getCycledTag():this.tagInput.getEditorValue();if(""===e)return void this.trigger("postForms:focusOnNextEditor",t);e=e.toString().replace(/[,#]/g,""),e.match(/<.*>/)&&(e=e.replace(/[<>]/g,function(t){return s.escape(t)}));var i=e.match(/"/g),n=i?i.length:0;if(n%2===1){var o=e.lastIndexOf('"');e=e.replace(/"/g,function(t,e){return e===o?'"':""})}else n>0&&(e=e.replace(/"/g,""));e=e.trim().substr(0,this.get("maxTagLength")),this.clearInput();var a=this.addTag(e);if(a){var r=t?t.which||t.keyCode:!1;if(r===!1||"focusout"!==t.type&&(9!==r||!t.shiftKey))return this.tagInput.focus(),!1}},addTag:function(t){if(t&&!s.contains(this._postTags(!0),t.toLowerCase())){this.post.get("tags").push(t);var e=new m({label:t});return this.addTagProperties(e,t),this.js$("tagInputFieldWrapper").before(e.render().$el),this.removePlaceholder(),!0}return!1},removeTag:function(t){if(t||(t=s.last(this.post.get("tags"))),!t)return!1;var e=s.without(this._postTags(),t);s.isEmpty(e)&&(this.setPlaceholder(this.placeholder),this.tagInput.editor.setPlaceholder(this.placeholder)),this.model.set("tags",e);var i=this.subViews["tagLabel_"+t];return i&&(i.remove(),this.subViews["tagLabel_"+t]=null,s.remove(this.tagLabelViews,function(t){return i===t})),!0},removeTags:function(){s.each(this.model.get("tags"),function(t){this.removeTag(t)},this),this.setPlaceholder(this.placeholder)},clearInput:function(){this.tagInput.trigger("tagInput:dismissSuggestions"),this.tagInput.setEditorValue("")},removePlaceholder:function(){this.setPlaceholder(null),this.$(this.get("tagEntryPlaceholder")).addClass("tiny-width")},setPlaceholder:function(t){this.tagInput.editor.setPlaceholder(t),this.$(this.get("tagEntryPlaceholder")).removeClass("tiny-width")},_postTags:function(t){return t?s.map(this.model.get("tags"),function(t){return t.toLowerCase()}):s.clone(this.model.get("tags"))},focusOnTagEditor:function(t){this.subViews.tagInputField.focus()},toggleTagSelection:function(t){var e=n(t.target),i=n(t.target).text(),s=this.get("currentlySelectedTags"),o=s.indexOf(i),a=/Mac/.test(navigator.platform)?t.metaKey:t.ctrlKey;a?0>o?(s.push(i),this.set("currentlySelectedTags",s),e.addClass("selected")):(s.splice(o,1),this.set("currentlySelectedTags",s),e.removeClass("selected"),e.removeClass("hover-style")):0>o||s.length>1?(this.set("currentlySelectedTags",[i]),this.$(".tag-label").removeClass("selected"),e.addClass("selected")):(this.unselectAllTags(),e.removeClass("hover-style"))},addHoverStyle:function(t){this.get("currentTag")&&t.label!==this.get("currentTag")||this.$(t.eventTarget).addClass("hover-style")},removeHoverStyle:function(t){this.$(".tag-label").removeClass("hover-style"),this.set("currentTag",null)},unselectAllTags:function(t){this.set("currentlySelectedTags",[]),this.$(".tag-label").removeClass("selected")}});e.exports=g},{"../templates/tag_editor.tpl":296,"./plaintext_editor":337,"./tag_label":360,"./tag_suggest":361,"app/components/sortable/sortable":380,jquery:"HlZQrA",lodash:"MicNly","prima/lib/translate":541,"prima/mixins/accessor":542,"prima/mixins/selectorcache":553,"prima/mixins/subviewable":554,"prima/view":580}],360:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/view"),o=t("prima/mixins/accessor"),a=t("prima/mixins/subviewable"),r=t("prima/mixins/selectorcache"),l=n.extend({className:"tag-label",defaults:{label:""},mixins:[o,a,r],events:{click:"toggleTagSelection",mouseover:"hoveredTag",mouseout:"unhoveredTag"},tagName:"span",initialize:function(t){t=s.extend({},t),this.set(s.pick(t,s.keys(this.defaults)))},render:function(){return this.$el.text(this.get("label")),this},toggleTagSelection:function(t){this.trigger("toggleTagSelection",t)},hoveredTag:function(t){this.trigger("addHoverStyle",{label:this.get("label"),eventTarget:t.target})},unhoveredTag:function(t){this.trigger("removeHoverStyle",t)}});e.exports=l},{lodash:"MicNly","prima/mixins/accessor":542,"prima/mixins/selectorcache":553,"prima/mixins/subviewable":554,"prima/view":580}],361:[function(t,e,i){"use strict";var s=t("lodash"),n=t("jquery"),o=t("prima/view"),a=t("prima/events"),r=t("../models/tag_suggestion"),l=t("prima/mixins/accessor"),h=t("prima/mixins/popoverbase"),c=t("prima/mixins/selectorcache"),u=t("../templates/tag_suggest.tpl"),d=o.extend({className:"popover--tag-suggest",defaults:{currentKeyedChoice:-1,currentMousedChoice:-1,interactive:!1,numSuggestions:0,suggestPending:!1,lastResults:{}},mixins:[l,c,h],template:u,initialize:function(t){this.model=new r(t),this.post=t.post,this.listenTo(this.model,"error",this._fetchSuggestionsError),this.listenTo(this,"change:lastResults",this.preRender)},preRender:function(t,e){var i=s.reduce(e.results,function(t,e){return t+(s.isArray(e)?e.length:0)},0);this.set({currentKeyedChoice:-1,interactive:!1});var n=this.get("suggestPending");i>0&&n!==!1&&-1===this.post.get("tags").indexOf(n)&&this.render()},render:function(){return this.$el.html(this.template(this.get("lastResults"))),a.trigger("postForms:dismissListener:suspend"),this},afterRender:function(){this.$tagSuggestWrapper=this.js$("tagSuggestWrapper"),n(".item-option",this.$el).on("click",s.bind(this.selectCurrentCycledChoice,this)),n(".item-option",this.$el).on("mouseover",s.bind(this.handleMouseOver,this)),this.$el.on("mouseout",s.bind(this.handleMouseOut,this))},teardown:function(){return this.$el.remove(),a.trigger("postForms:dismissListener:resume"),this},cycleUp:function(){this._cycle(-1)},cycleDown:function(){this._cycle(1)},_cycle:function(t){var e=this.get("currentKeyedChoice"),i=this.get("currentMousedChoice"),n=s.isNumber(i)&&-1!==i,o=n?i:e,a=(o+t)%this.get("numSuggestions");this.get("numSuggestions")&&(this.set({currentKeyedChoice:a>=0?a:-1,currentMousedChoice:-1}),this.styleMenuItems(),this.set("interactive",this.get("currentKeyedChoice")>=0))},getCycledTag:function(){return n(".item-option.cycled",this.$el).data("tag")},selectCurrentCycledChoice:function(t){this.set("interactive",!0),n(t.currentTarget).addClass("cycled"),this.trigger("tagSuggest:submitTag")},styleMenuItems:function(t){var e,i=t&&"mouseout"!==t.type,o=this.get("currentKeyedChoice");s.each(n(".item-option",this.$el),function(s,a){i?n(s).toggleClass("cycled",t.currentTarget===s):(n(s).toggleClass("cycled",a===o),a===o&&(e=n(s)))},this),i||-1===o||this.cycleScroll(e)},cycleScroll:function(t){var e=parseInt(t.position().top,10),i=e+parseInt(t.height(),10),s=parseInt(t.outerHeight(),10),n=parseInt(this.$tagSuggestWrapper.height(),10),o=parseInt(this.$tagSuggestWrapper.scrollTop(),10);i>n?this.$tagSuggestWrapper.scrollTop(o+s):0>e&&this.$tagSuggestWrapper.scrollTop(e+o)},handleMouseOver:function(t){this.styleMenuItems(t),this.set({interactive:!0,currentMousedChoice:n(t.currentTarget).index(".item-option")})},handleMouseOut:function(t){this.styleMenuItems(t),this.set({interactive:-1!==this.get("currentKeyedChoice"),currentMousedChoice:-1})},fetchSuggestions:s.debounce(function(t,e){var i={query:t,success:s.bind(this.renderQueryResults,this),existing:e};this.set("suggestPending",t),this.model.fetch(i)},100),_fetchSuggestionsError:s.noop,renderQueryResults:function(t,e,i){var s=this.finalResultsFilter(t.attributes.tagSuggestions,i.existing);this.set("numSuggestions",s.userTags.length+s.suggestions.length),this._rendered&&this.teardown(),this.set("lastResults",{results:s,queryRegex:new RegExp(this.model._escapeRegex(i.query),"i")})},finalResultsFilter:function(t,e){return s.mapValues(t,function(t){return s.difference(t,e)})},dismiss:function(){this.teardown(),this.set({interactive:!1,suggestPending:!1,lastResults:{}})}});e.exports=d},{"../models/tag_suggestion":244,"../templates/tag_suggest.tpl":297,jquery:"HlZQrA",lodash:"MicNly","prima/events":512,"prima/mixins/accessor":542,"prima/mixins/popoverbase":550,"prima/mixins/selectorcache":553,"prima/view":580}],362:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/view"),o=t("prima/mixins/accessor"),a=t("prima/mixins/subviewable"),r=t("prima/mixins/selectorcache"),l=t("prima/mixins/popoverbase"),h=t("../templates/tooltip.tpl"),c=n.extend({className:"tooltip-popover",mixins:[o,a,r,l],template:h,defaults:{sanitize:!0,text:""},initialize:function(t){t=s.extend({},t),s.extend(this.attributes,s.pick(t,s.keys(this.defaults)))},serialize:function(){return this.toJSON()},render:function(){return this.$el.html(this.template(this.serialize())),this._popoverBase.pinnedSide="none",this._popoverBase.shift.x=4+this.$pinned.width(),this._popoverBase.shift.y=8,this},teardown:function(){return this.$el.remove(),this}});e.exports=c},{"../templates/tooltip.tpl":299,lodash:"MicNly","prima/mixins/accessor":542,"prima/mixins/popoverbase":550,"prima/mixins/selectorcache":553,"prima/mixins/subviewable":554,"prima/view":580}],363:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/view"),o=t("prima/mixins/accessor"),a=t("prima/mixins/subviewable"),r=t("prima/mixins/selectorcache"),l=t("../templates/tumblelog_select.tpl"),h=t("./tumblelog_select_dropdown"),c=n.extend({defaults:{modeRequiresDropdown:!0},events:{"click [data-js-clickableTumblelogLabel]":"toggleTumblelogSelectDropdown"},mixins:[o,a,r],template:l,initialize:function(t){this.options=t||{},this.user=t.user,this.listenTo(this.model,"change:tumblelog",this.adjustLabel),this.set("modeRequiresDropdown","edit"!==this.model.get("mode"))},render:function(){return this.$el.html(this.template({post:this.model})),this.adjustLabel(),this.createDropdown(),this},createDropdown:function(){var t=s.extend(this.options,{shift:{x:0,y:10},identifier:"postForms:tumblelogSelectDropdown"});this.get("modeRequiresDropdown")&&(this.tumblelogSelectDropdown=new h(t),this.tumblelogSelectDropdown.setPinnedTarget(this.js$("tumblelogSelectPin")))},toggleTumblelogSelectDropdown:function(){this.get("modeRequiresDropdown")&&(this.tumblelogSelectDropdown.isOrWasRecentlyRendered()||this.tumblelogSelectDropdown.render())},adjustLabel:function(){var t,e;this.user&&this.model&&(t=this.model.get("tumblelog"),e=this.user.getChannel(t),this.js$("tumblelogLabel").text(e?e.getDisplayName():t))}});e.exports=c},{"../templates/tumblelog_select.tpl":300,"./tumblelog_select_dropdown":364,lodash:"MicNly","prima/mixins/accessor":542,"prima/mixins/selectorcache":553,"prima/mixins/subviewable":554,"prima/view":580}],364:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/view"),o=t("prima/events"),a=t("app/lib/avatar-size"),r=t("prima/mixins/accessor"),l=t("prima/mixins/selectorcache"),h=t("prima/mixins/popoverbase"),c=t("app/lib/currentuser"),u=t("../templates/tumblelog_select_dropdown.tpl"),d=n.extend({className:"popover--tumblelog-select-dropdown",events:{"click [data-js-tumblelogChoice]":"selectBlog"},mixins:[r,l,h],template:u,defaultOptions:{size:128},defaults:{tumblelog:!1},initialize:function(t){this.options=t=s.extend({},this.defaultOptions,t),this.user=t.user||c(),s.extend(this.attributes,s.pick(t,s.keys(this.defaults))),this.get("tumblelog")||this.set("tumblelog",this.user.getChannel().get("name"))},render:function(){return this.delegateEvents(),this.$el.html(this.template(this.serialize())),o.trigger("postForms:dismissListener:suspend"),this},teardown:function(){return this.$el.remove(),o.trigger("postForms:dismissListener:resume"),this},serialize:function(){var t=this.toJSON();return t.channels=this.user.channels.map(function(t){return s.extend({avatarUrl:a(t.get("avatar_url"),this.options.size),displayName:t.getDisplayName()},t.toJSON())},this),t},selectBlog:function(t){var e=this.$(t.currentTarget).index();this.model.set("tumblelog",this.user.channels.at(e).get("name")),this.teardown()}});e.exports=d},{"../templates/tumblelog_select_dropdown.tpl":301,"app/lib/avatar-size":429,"app/lib/currentuser":432,lodash:"MicNly","prima/events":512,"prima/mixins/accessor":542,"prima/mixins/popoverbase":550,"prima/mixins/selectorcache":553,"prima/view":580}],365:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/view"),o=t("prima/events"),a=t("prima/mixins/accessor"),r=t("prima/mixins/subviewable"),l=t("prima/mixins/selectorcache"),h=t("prima/mixins/popoverbase"),c=t("../templates/tweet_dropdown.tpl"),u=t("../utils/string_helpers").truncateLongStrings,d=n.extend({className:"popover--tweet-dropdown",defaults:{focused:!1},events:{"input [data-js-customTweet]":"_onCustomTweetInput","keyup [data-js-customTweet]":"_onCustomTweetInput","change [data-js-customTweet]":"_onCustomTweetInput","click [data-js-dismissTweet]":"_onClickDismissTweet",keydown:"_onKeyDown"},mixins:[a,r,l,h],template:c,_onCustomTweetInput:function(t){var e=s.trim(this.js$("customTweet").val());this.model.set("customTweet",e),this.truncateTweet()},_onClickDismissTweet:function(){this.teardown()},_onKeyDown:function(t){27===t.keyCode&&(t.stopPropagation(),this.teardown())},_onChangePost:function(){s.isString(this.model.get("customTweet"))||this.js$("customTweet").val(this.model.getTweetText()),this.updateTweetLengthCount()},updateTweetLengthCount:function(t){var e=this.model.getTweetTextLength();this.js$("tweetRemaining").text(140-e)},truncateTweet:function(){var t=this.js$("customTweet"),e=t.get(0),i=t.val(),s=i;if(!(this.model.getTweetTextLength(i)<=140)){var n=this.model.shortUrlLength,o=i.match(/\[URL\]/gi),a=!0;if(o&&1===o.length){var r=i.toLowerCase().indexOf("[url]");140-n-1>r?(i=u(i,140-n+5),a=!1):r&&(i=u(i.split(/\[URL\]/i).join(""),140-n-1)+" [URL]")}else i=u(i,140);if(this.model.set("customTweet",i),s!==i){var l=e.selectionEnd||0,h=t.scrollTop();if(a){var c=i.toLowerCase().lastIndexOf("… [url]");0>c&&(c=i.toLowerCase().lastIndexOf("…[url]")),0>c&&(c=i.toLowerCase().lastIndexOf(" [url]")),0>c&&(c=i.toLowerCase().lastIndexOf("[url]")),c>=0&&l>c&&(l=c)}if(l=Math.max(0,Math.min(l,i.length)),t.val(i).focus(),e.setSelectionRange)e.setSelectionRange(l,l);else if(e.createRange){var d=e.createRange();d.setStart("character",l),d.setEnd("character",l),d.select()}t.scrollTop(h)}}},setCaret:function(t){var e=this.js$("customTweet"),i=e.get(0),s=e.val(),n=s.toLowerCase().lastIndexOf(" [url]");if(0>n&&(n=s.toLowerCase().lastIndexOf("[url]"),t&&n>=0&&(s=s.slice(0,n)+" "+s.slice(n),this.js$("customTweet").val(s))),0>n&&(n=s.length),e.focus(),i.setSelectionRange)i.setSelectionRange(n,n);else if(i.createRange){var o=i.createRange();o.setStart("character",n),o.setEnd("character",n),o.select()}},serialize:function(){return s.extend({tweetText:this.model.getTweetText(),tweetRemaining:140-this.model.getTweetTextLength()},this.toJSON())},afterRender:function(){this.listenTo(this.model,"change",this._onChangePost),s.defer(s.bind(function(){this.setCaret(!0)},this))},render:function(){return this.delegateEvents(),this.$el.html(this.template(this.serialize())),this.model.get("customTweet")&&this.js$("customTweet").val(this.model.get("customTweet")),o.trigger("postForms:dismissListener:suspend"),this},teardown:function(){return""===this.model.get("customTweet")&&this.model.set("send_to_twitter",!1),this.remove(),o.trigger("postForms:dismissListener:resume"),this}});e.exports=d},{"../templates/tweet_dropdown.tpl":302,"../utils/string_helpers":312,lodash:"MicNly","prima/events":512,"prima/mixins/accessor":542,"prima/mixins/popoverbase":550,"prima/mixins/selectorcache":553,"prima/mixins/subviewable":554,"prima/view":580}],366:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/view"),o=t("prima/mixins/accessor"),a=t("prima/mixins/subviewable"),r=t("prima/mixins/selectorcache"),l=t("../templates/uploading_indicator.tpl"),h=t("components/knight-rider-loader"),c=n.extend({className:"post-form--uploading-indicator",mixins:[o,a,r],template:l,defaults:{isUploading:!0,isVisible:!0,delay:200},initialize:function(t){this.options=t=s.extend({},t),s.extend(this,s.pick(t,"post","user","uploads")),s.extend(this.attributes,s.pick(t,s.keys(this.defaults))),this.updateIsUploading(),this.set("isVisible",this.get("isUploading"))},_onChangeIsUploading:function(t,e){e?(clearTimeout(this._changeIsVisibleTimeout),this._changeIsVisibleTimeout=!1,this.set("isVisible",e)):this._changeIsVisibleTimeout||(this._changeIsVisibleTimeout=s.delay(s.bind(function(){this._changeIsVisibleTimeout=!1,this.set("isVisible",e)},this),this.get("delay")))},_onChangeIsVisible:function(t,e){this.loader.set("loading",e)},updateIsUploading:function(){this.set("isUploading",this.post.get("hasLoadingInlineImages")||this.uploads.anyUploading()||this.post.get("loading"))},serialize:function(){return this.toJSON()},beforeRender:function(){this.loader=this.subViews.loader=new h({variation:"small"}),this.listenTo(this.uploads,"change:uploading",this.updateIsUploading),this.listenTo(this.post,"change:loading",this.updateIsUploading),this.listenTo(this.post,"change:hasLoadingInlineImages",this.updateIsUploading),this.listenTo(this,"change:isUploading",this._onChangeIsUploading),this.listenTo(this,"change:isVisible",this._onChangeIsVisible)},render:function(){return this.$el.html(this.template(this.serialize())),this.updateIsUploading(),this.loader.set("loading",this.get("isVisible")),this.attachSubViews(),this}});e.exports=c},{"../templates/uploading_indicator.tpl":303,"components/knight-rider-loader":461,lodash:"MicNly","prima/mixins/accessor":542,"prima/mixins/selectorcache":553,"prima/mixins/subviewable":554,"prima/view":580}],367:[function(t,e,i){"use strict";var s=t("lodash"),n=t("velocity-animate").animate,o=t("prima/view"),a=t("prima/mixins/accessor"),r=t("prima/mixins/subviewable"),l=t("prima/mixins/selectorcache"),h=t("../templates/webcam_button.tpl"),c=o.extend({
className:"webcam-button-container",template:h,events:{mouseenter:"_onMouseEnter",mouseleave:"_onMouseLeave"},mixins:[a,r,l],wink:function(t){!s.isUndefined(t)||(t=!this.js$("smiley").hasClass("icon_postforms_selfie_wink")),this.js$("smiley").toggleClass("icon_postforms_selfie_wink",t),this.js$("smiley").toggleClass("icon_postforms_selfie",!t)},_onMouseEnter:function(){var t=100;n(this.js$("text"),"stop"),n(this.js$("text"),{opacity:1},{duration:t});var e=this.js$("smiley").outerWidth()+this.js$("text").outerWidth();n(this.$el,"stop"),n(this.$el,{marginLeft:-Math.round(.5*e),width:e},{duration:t}).then(s.bind(function(){this._winkTimeout=s.delay(s.bind(function(){this.wink(!0),this._winkTimeout=s.delay(s.bind(function(){this.wink(!1)},this),100)},this),400)},this))},_onMouseLeave:function(){var t=100;clearTimeout(this._winkTimeout),this.wink(!1),n(this.js$("text"),"stop"),n(this.js$("text"),{opacity:0},{duration:t});var e=this.js$("smiley").outerWidth();n(this.$el,"stop"),n(this.$el,{marginLeft:-Math.round(.5*e),width:e},{duration:t}).then(s.bind(function(){}))},render:function(){return this.$el.html(this.template()),this},teardown:function(){return clearTimeout(this._winkTimeout),this}});e.exports=c},{"../templates/webcam_button.tpl":304,lodash:"MicNly","prima/mixins/accessor":542,"prima/mixins/selectorcache":553,"prima/mixins/subviewable":554,"prima/view":580,"velocity-animate":"lWl/mc"}],368:[function(t,e,i){var s=t("prima/collection"),n=t("../models/reblog-list-item"),o=s.extend({model:n});e.exports=o},{"../models/reblog-list-item":369,"prima/collection":510}],369:[function(t,e,i){var s=t("prima/model"),n=s.extend({defaults:{pid:null,name:null,permalink:null,content:null}});e.exports=n},{"prima/model":557}],370:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __t,__p="";Array.prototype.join;with(obj||{})__p+='<div class="reblog-header">',permalink?(__p+='<a class="reblog-avatar '+(null==(__t=isOriginalEntry||isFirstEntry?"":"sub-icon-reblog")?"":__t)+'" href="'+(null==(__t=permalink)?"":_.escape(__t))+'">',avatar_url&&(__p+='<img class="reblog-avatar-image-thumb" src="'+(null==(__t=avatar_url)?"":_.escape(__t))+'">'),__p+='</a> <a class="reblog-tumblelog-name" href="'+(null==(__t=permalink)?"":_.escape(__t))+'">'+(null==(__t=name)?"":_.escape(__t))+"</a>"):(__p+=' <span class="reblog-avatar inactive '+(null==(__t=isOriginalEntry?"":"sub-icon-reblog")?"":__t)+'">',avatar_url&&(__p+='<img class="reblog-avatar-image-thumb" src="'+(null==(__t=avatar_url)?"":_.escape(__t))+'">'),__p+='</span> <span class="reblog-tumblelog-name inactive">'+(null==(__t=name)?"":_.escape(__t))+"</span>"),__p+="</div>",title&&(__p+='<div class="reblog-title">'+(null==(__t=title)?"":_.escape(__t))+"</div>"),__p+="",content&&""!==content&&(__p+='<div class="reblog-content">'+(null==(__t=content)?"":__t)+"</div>"),__p+="";return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],371:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __t,__p="";Array.prototype.join;with(obj||{})__p+='<div class="reblog-header"><span class="reblog-avatar">',avatar_url&&(__p+='<img class="reblog-avatar-image-thumb" src="'+(null==(__t=avatar_url)?"":_.escape(__t))+'">'),__p+='</span> <span class="reblog-tumblelog-name inactive">'+(null==(__t=name)?"":_.escape(__t))+"</span></div>",title&&(__p+='<div class="reblog-title">'+(null==(__t=title)?"":_.escape(__t))+"</div>"),__p+="";return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],372:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __t,__p="";Array.prototype.join;with(obj||{})__p+='<div class="control-reblog-trail post"><div class="reblog-trail-post-content">',isRemovable&&(__p+='<div class="remove-button-wrapper" data-subview="removeButton"></div><div class="btn-show-trail btn-toggle-reblog">'+(null==(__t=__("Put reblogs back"))?"":_.escape(__t))+"</div>"),__p+="",this.subviews.reblogCollectionView&&(__p+=""+(null==(__t=_subview("reblogCollectionView"))?"":__t)),__p+="</div></div>";return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],373:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/views/base"),o=t("../templates/reblog-list-item.tpl"),a=n.extend({className:"reblog-list-item",template:o,defaults:{},initialize:function(t){this.options=s.merge({},this.defaults,t),this.options.origTextPost&&this.$el.addClass("reblog-list-item--text-post-original")},getTemplateData:function(){var t={name:this.model.get("name"),permalink:this.model.get("permalink"),avatar_url:this.model.get("avatar_url"),title:this.model.get("title"),content:s.trim(this.model.get("content"))?this.model.get("content"):"",isOriginalEntry:this.model.get("is_original_entry"),isFirstEntry:this.options.isFirstEntry};return t}});e.exports=a},{"../templates/reblog-list-item.tpl":370,lodash:"MicNly","prima/views/base":581}],374:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/views/base"),o=t("../templates/reblog-list-title.tpl"),a=n.extend({className:"reblog-list-title reblog-list-item",template:o,defaults:{},initialize:function(t){this.options=s.merge({},this.defaults,t)},getTemplateData:function(){var t={name:this.model.get("name"),avatar_url:this.model.get("avatar_url"),title:this.model.get("title")};return t}});e.exports=a},{"../templates/reblog-list-title.tpl":371,lodash:"MicNly","prima/views/base":581}],375:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/views/base"),o=t("./reblog-list-item"),a=t("../models/reblog-list-item"),r=t("./reblog-list-title"),l=n.extend({className:"reblog-list",initialize:function(t){this.options=s.merge({},this.defaults,t);var e=this.collection,i="text"===this.options.postType,n=this.options.titleData;if(n){var l=new a(n);this.subviews["reblog-list-item-title"]=new r({model:l})}e.each(function(t,e){var s=i&&t.get("is_original_entry");this.subviews["reblog-list-item-"+e]=new o({model:t,origTextPost:s,isFirstEntry:0===e})},this)},render:function(){return s.each(this.subviews,s.bind(function(t){this.$el.append(t.render().$el)},this)),this},teardown:function(){return s.each(this.subviews,function(t){t.remove()}),this}});e.exports=l},{"../models/reblog-list-item":369,"./reblog-list-item":373,"./reblog-list-title":374,lodash:"MicNly","prima/views/base":581}],376:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/mixins/selectorcache"),o=t("prima/lib/translate"),a=t("prima/views/base"),r=t("../collections/reblog-list"),l=t("app/components/remove-button"),h=t("./reblog-list"),c=t("../templates/reblog-list.tpl"),u=a.extend({template:c,defaults:{isRemovable:!1},mixins:[n],events:{"click .btn-toggle-reblog":"toggleRemoveReblogTree","mouseenter .reblog-trail-post-content":"_onMouseEnter","mouseleave .reblog-trail-post-content":"_onMouseLeave"},initialize:function(t){if(this.options=s.merge({},this.defaults,t),this._getReblogTrail(this.model)&&(this.reblogListCollection=new r(this._getReblogTrail(this.model))),this.reblogListCollection){var e=this.reblogListCollection.length?this.reblogListCollection.first().get("title"):!1,i=this._getCurrentTitleMeta(this.model);this.reblogCollectionView=this.subviews.reblogCollectionView=new h({collection:this.reblogListCollection,titleData:!e&&i?i:!1,postType:this.model.get("type")}),this.get("isRemovable")&&(this.removeButton=this.subviews.removeButton=new l({tooltip:o("Remove reblogs"),buttonClass:"btn-remove-trail btn-toggle-reblog"}),this.listenTo(this.removeButton,"mouseenter",this._onMouseEnterRemoveButton),this.listenTo(this.removeButton,"mouseleave",this._onMouseLeaveRemoveButton))}},_getReblogData:function(t){return JSON.parse(t.get("reblog_trail"))},_getReblogTrail:function(t){return s.get(this._getReblogData(t),"reblog_entries")},_getCurrentTitleMeta:function(t){return s.get(this._getReblogData(t),"current_title_meta")},getTemplateData:function(){return{isRemovable:this.get("isRemovable")}},toggleRemoveReblogTree:function(){var t=this.$$(".control-reblog-trail"),e=this.model.has("remove_reblog_tree")&&this.model.get("remove_reblog_tree");this.model.set("remove_reblog_tree",!e),t.toggleClass("removed",!e)},_onMouseEnter:function(){this.removeButton.setActive()},_onMouseLeave:function(){this.removeButton.setInactive()},_onMouseEnterRemoveButton:function(){this.reblogCollectionView.$el.addClass("fade")},_onMouseLeaveRemoveButton:function(){this.reblogCollectionView.$el.removeClass("fade")}});e.exports=u},{"../collections/reblog-list":368,"../templates/reblog-list.tpl":372,"./reblog-list":375,"app/components/remove-button":377,lodash:"MicNly","prima/lib/translate":541,"prima/mixins/selectorcache":553,"prima/views/base":581}],377:[function(t,e,i){"use strict";var s=t("./views/remove-button.js");e.exports=s},{"./views/remove-button.js":379}],378:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __t,__p="";Array.prototype.join;with(obj||{})__p+='<div class="remove-button '+(null==(__t=buttonClass)?"":_.escape(__t))+'"><span class="icon"></span></div>';return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],379:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/view"),o=t("prima/mixins/accessor"),a=t("prima/mixins/subviewable"),r=t("prima/mixins/selectorcache"),l=t("../templates/remove-button.tpl"),h=n.extend({events:{click:"_onClick",mouseenter:"_onMouseEnter",mouseleave:"_onMouseLeave"},template:l,mixins:[o,a,r],defaults:{dataJsName:"removeButton",buttonClass:""},initialize:function(t){t=s.extend({},t),s.extend(this.attributes,s.pick(t,s.keys(this.defaults))),this.onClick=t.onClick},serialize:function(){return this.toJSON()},render:function(){return this.$el.html(this.template(this.serialize())),this.get("dataJsName")&&this.$$(".remove-button").attr("data-js-"+this.get("dataJsName"),""),this},setActive:function(){this.$$(".remove-button").addClass("active")},setInactive:function(){this.$$(".remove-button").removeClass("active")},_onClick:function(){s.isFunction(this.onClick)?this.onClick(this):this.trigger("remove")},_onMouseEnter:function(){this.trigger("mouseenter")},_onMouseLeave:function(){this.trigger("mouseleave")}});e.exports=h},{"../templates/remove-button.tpl":378,lodash:"MicNly","prima/mixins/accessor":542,"prima/mixins/selectorcache":553,"prima/mixins/subviewable":554,"prima/view":580}],380:[function(t,e,i){"use strict";var s=t("lodash"),n=t("jquery"),o=t("prima/view"),a=t("velocity-animate"),r=o.extend({initialize:function(t){this.el=t.el||null,this.itemClassName=t.itemClassName||".item",this.dropInParent=t.dropInParent||!1,this.transparentPlaceholder=t.transparentPlaceholder||!0,this.beforeDragStart=t.beforeDragStart||s.noop,this.afterDragEnd=t.afterDragEnd||s.noop,this.scrollable=t.scrollable||!1,this.isAnimating=!1,this.disableAnimation=t.disableAnimation||!1,this.disableAnimation&&(this.calculateDropTarget=s.throttle(this.calculateDropTarget,500)),this.$items=n(this.itemClassName),this.$currentlyDraggedItem=null,this.$placeholder=null,this.placeholderElement=null,this.renderedPlaceholder=!1,this.reloadItems()},itemEvents:function(t){t||(t=this.itemClassName);var e={};return e["dragstart "+t]="setPlaceholder",e["dragenter "+t]="calculateDropTarget",e["dragend "+t]="resetPlaceholder",this.dropInParent?(e.dragover="cancelEvent",e.drop="dropItemAndResetPlaceholder"):(e["dragover "+t]="cancelEvent",e["drop "+t]="dropItem"),e},setPlaceholder:function(t){this.renderedPlaceholder=!1,t.originalEvent.dataTransfer.effectAllowed="move";try{t.originalEvent.dataTransfer.setData("text/html","")}catch(e){}if(this.$currentlyDraggedItem=n(t.currentTarget),this.$currentlyDraggedItem){if(this.$placeholder=this.$currentlyDraggedItem.clone().addClass("sortable-placeholder"),this.transparentPlaceholder&&this.$placeholder.addClass("transparent-placeholder"),!this.disableAnimation){var i=this.$currentlyDraggedItem.outerWidth();this.$placeholder.data("item-width",i).data("need-animation",!1)}this.placeholderElement=this.$placeholder.get(0),this.$currentlyDraggedItem.addClass("sortable-dragging"),this.beforeDragStart.call(this),this.trigger("dragstart",this),this.scrollable&&(this.$el.on("dragover."+this.cid,s.throttle(function(t){var e=.2,i=window.innerHeight,s=t.originalEvent.clientY/i,n=this.getBoundingClientRect();e>s&&n.top<0?window.scrollBy(0,-(200*(e-s))):s>1-e&&window.scrollBy(0,200*(e+s-1)),t.preventDefault()},50)),this.$currentlyDraggedItem.one("dragend",s.bind(function(){this.$el.off(["dragenter."+this.cid,"dragover."+this.cid].join(" "))},this)))}},calculateDropTarget:function(t){if(this.$currentlyDraggedItem&&!this.isAnimating){t.preventDefault(),this.renderedPlaceholder=!0;var e=t.currentTarget,i=n(e);if(e===this.placeholderElement)return!1;this.$currentlyDraggedItem.hide();var s,o=i.index(this.itemClassName),a=this.$placeholder.index(this.itemClassName),r=this.$placeholder.data("need-animation")||!1,l=this.$placeholder.data("item-width");return this.disableAnimation||(s=n("<span>").css({width:l,display:"inline-block"}),this.$placeholder.after(s),r&&this.$placeholder.css({width:0,padding:0})),o>a?i.after(this.placeholderElement):i.before(this.placeholderElement),this.disableAnimation||(r?this.animatePlaceholderWidth(s,this.$placeholder,l,200):this.$placeholder.data("need-animation",!0)),this.lastDroppable=e,!1}},animatePlaceholderWidth:function(t,e,i,n){this.isAnimating=!0,a.animate(t,"stop"),a.animate(e,"stop"),a.animate(t,{width:0},n,"easeInOutQuart",s.bind(function(){t.remove(),this.isAnimating=!1},this)),a.animate(e,{width:i},n,"easeInOutQuart")},cancelEvent:function(t){this.$currentlyDraggedItem&&t.preventDefault()},dropItem:function(t){return this.$currentlyDraggedItem&&this.renderedPlaceholder&&this.placeholderElement&&(t.stopPropagation(),this.$currentlyDraggedItem.insertAfter(this.placeholderElement)),!1},resetPlaceholder:function(t){this.renderedPlaceholder=!1,this.placeholderElement=null,this.$currentlyDraggedItem&&(this.$currentlyDraggedItem.removeClass("sortable-dragging").show(),this.$currentlyDraggedItem=null,this.$placeholder.detach(),t.stopPropagation(),this.afterDragEnd(),this.trigger("dragend",this),this.lastDroppable=null)},dropItemAndResetPlaceholder:function(t){return this.dropItem(t),this.resetPlaceholder(t)},sequence:function(){var t=this.$items.toArray();return s.uniq(s.pluck(t,"id"))},reloadItems:function(){return this.$items.attr("draggable",!0),this.$items.find("a").attr("draggable",!1),this.$items.find("img").attr("draggable",!1),this.delegateEvents(this.itemEvents(this.itemClassName)),this},disableItems:function(){return this.$items.attr("draggable",!1),this.undelegateEvents(),this},teardown:function(){return this.undelegateEvents(),this.scrollable&&this.$el.off(["dragenter."+this.cid,"dragover."+this.cid].join(" ")),this.$items.add("a, img",this.$items).removeAttr("draggable"),this.$items=null,this.$placeholder=null,this.beforeDragStart=null,this.afterDragEnd=null,this.calculateDropTarget=null,this}});e.exports=r},{jquery:"HlZQrA",lodash:"MicNly","prima/view":580,"velocity-animate":"lWl/mc"}],381:[function(t,e,i){"use strict";var s=t("jquery"),n=t("lodash"),o=t("prima/component"),a=t("prima/events"),r=t("prima/mixins/keycommands"),l=t("./views/fast_compose"),h=o.extend({name:"switcher",mixins:[r],keycommands:{"keydown:alt+c":"macFastCompose","keydown:z+c":"winFastCompose"},loggingData:{},initialize:function(){this.$body=s("body"),this.$glass=null,this.suspended=!1,this.bindEvents()},bindEvents:function(){this.listenTo(a,"keycommands:suspend",this.suspend),this.listenTo(a,"keycommands:resume",this.resume),this.listenTo(a,"fastCompose:close:complete",this.dismissFastCompose),this.listenTo(a,"fastCompose:dismiss",this.dismissFastCompose),this.listenTo(a,"fastCompose:init",this.initFastCompose)},suspend:function(){this.suspended=!0},resume:function(){this.suspended=!1},macFastCompose:function(t){"MacIntel"===navigator.platform&&this.initFastCompose(t)},winFastCompose:function(t){"Win32"===navigator.platform&&this.initFastCompose(t)},initFastCompose:function(t){this.suspended||this.fastCompose||(this.determineSource(t),this.fastCompose=new l({loggingData:this.loggingData}),this.$body.append(this.fastCompose.render().el),this.showPlexi(),this.fastCompose.open(),a.trigger("fastCompose:init:complete"))},dismissFastCompose:function(){this.fastCompose&&(this.hidePlexi(),this.fastCompose.teardown(),this.fastCompose=null),a.trigger("fastCompose:dismiss:complete")},showPlexi:function(){this.$glass=s("<div>",{"class":"glass show"}).appendTo(this.$body),n.defer(n.bind(function(){this.$glass.addClass("blue")},this)),a.trigger("drawer:suspend")},hidePlexi:function(){this.$glass.remove(),this.$glass=null,a.trigger("drawer:resume")},determineSource:function(t){this.loggingData.source="fast-compose",t&&(t.originalEvent instanceof window.KeyboardEvent?this.loggingData.source="keycommand":t.loggingData&&t.loggingData.source&&(this.loggingData.source=t.loggingData.source))}});e.exports=h},{"./views/fast_compose":383,jquery:"HlZQrA",lodash:"MicNly","prima/component":511,"prima/events":512,"prima/mixins/keycommands":547}],382:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __t,__p="";Array.prototype.join;with(obj||{})__p+='<div class="post-tab-switching"><div class="tab-post-types count-'+(null==(__t=icons.length)?"":_.escape(__t))+'">',_.forEach(icons,function(t,e){__p+='<div class="tab-post-type item" data-index="'+(null==(__t=e)?"":_.escape(__t))+'" data-post-type="'+(null==(__t=t.name)?"":_.escape(__t))+'"><div class="post-type-icon icon-'+(null==(__t=t.name)?"":_.escape(__t))+'"><i class="post-type-icon-overlay"></i></div><div class="post-type-name"><span class="post-type-name-span">'+(null==(__t=t.label)?"":_.escape(__t))+"</span></div></div>"}),__p+="</div></div>";return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],383:[function(t,e,i){"use strict";var s=t("jquery"),n=t("lodash"),o=t("velocity-animate"),a=t("prima/lib/data"),r=t("prima/lib/translate"),l=t("when"),h=t("prima/view"),c=t("prima/events"),u=t("prima/lib/flags"),d=t("prima/mixins/keycommands"),p=t("prima/mixins/accessor"),m=t("app/components/post-form-builder"),g=t("../templates/fast_compose.tpl"),f=h.extend({template:g,className:"fast-compose",defaults:{tabIndex:-1,icons:[{name:"text",label:"Text"},{name:"photo",label:"Photo"},{name:"quote",label:"Quote"},{name:"link",label:"Link"},{name:"chat",label:"Chat"},{name:"audio",label:"Audio"},{name:"video",label:"Video"}]},events:{"click .post-tab-switching .tab-post-type":"clickCreate","mouseover .post-tab-switching .tab-post-type":"mouseoverIcon","click .post-tab-switching":"close"},mixins:[p,d],keycommands:{"keydown:c":"nextIcon","keydown:shift+c":"previousIcon","keydown:tab":"nextIcon","keydown:shift+tab":"previousIcon","keydown:right":"nextIcon","keydown:left":"previousIcon","keydown:enter":"enterCreate","keydown:escape":"close"},initialize:function(t){this.loggingData=t?t.loggingData:{},n.forEach(this.get("icons"),function(t){t.label=r(t.label)}),this.$body=s("body"),this.$glass=null,this.$plexiInstance=s('.plexi[data-token="body-plexi"]'),this.resumeKeycommandsOnClose=!0},bindEvents:function(){this.listenTo(c,"DOMEventor:keydown:tab",this.disableKey),this.listenTo(c,"DOMEventor:keydown:shift+tab",this.disableKey),this.listenTo(this,"change:tabIndex",function(t,e){this.$(".selected").removeClass("selected"),this.$('[data-index="'+e+'"]').addClass("selected")})},render:function(){return this.$el.append(this.template(this.toJSON())),this.bindEvents(),this},open:function(){n.defer(n.bind(this.show,this))},show:function(){c.trigger("keycommands:suspend");var t=50;n.forEach(this.$(".tab-post-type"),function(e,i){var n=s(e),a=n.find(".post-type-icon"),r=n.find(".post-type-name");o.animate(a,{opacity:["1","0"],translateY:["0px","15px"]},{duration:150,delay:i*t}),o.animate(r,{opacity:["1","0"],translateY:["0px","-15px"]},{duration:150,delay:i*t})},this),s(".post-tab-switching").addClass("finish-animating")},enterCreate:function(t){var e=this.$(".selected");if(e.length){var i=e.attr("data-post-type");this.createNew(i),this.close()}},clickCreate:function(t){this.createNew(s(t.currentTarget).data("postType"))},disableKey:function(t){t.preventDefault()},mouseoverIcon:function(t){this.$(".selected").removeClass("selected"),this.set("tabIndex",s(t.currentTarget).data("index"))},nextIcon:function(t){var e=this.get("tabIndex")+1;e>=this.get("icons").length&&(e=0),this.set("tabIndex",e)},previousIcon:function(t){var e=this.get("tabIndex")-1;0>e&&(e=this.get("icons").length-1),this.set("tabIndex",e)},createNew:function(t){this.resumeKeycommandsOnClose=!1,a.has("Components/PostFormBuilder")?c.trigger("postForms:open",{updateURL:!1,postFormType:m.containerType("modal"),postType:t,fastCompose:!0,loggingData:this.loggingData}):c.trigger("fastCompose:create",{type:t,loggingData:this.loggingData})},close:function(){var t=50,e=this.$(".tab-post-type"),i=Math.floor(.5*(e.length-1));l.all(n.map(e,function(e,n){var a=s(e),r=Math.floor(Math.abs(n-i))*t;return o.animate(a,{opacity:["0","1"],translateY:["-500px","0px"]},{duration:150,delay:r})},this)).then(function(){c.trigger("fastCompose:close:complete")})},teardown:function(){return this.resumeKeycommandsOnClose&&c.trigger("keycommands:resume"),this.remove()}});e.exports=u.bool("is_logged_in")?f:n.noop},{"../templates/fast_compose.tpl":382,"app/components/post-form-builder":217,jquery:"HlZQrA",lodash:"MicNly","prima/events":512,"prima/lib/data":514,"prima/lib/flags":"f/LVtH","prima/lib/translate":541,"prima/mixins/accessor":542,"prima/mixins/keycommands":547,"prima/view":580,"velocity-animate":"lWl/mc",when:"RG2dij"}],384:[function(t,e,i){"use strict";var s=t("prima/component"),n=t("./views/tooltip"),o=s.extend({name:"ToolTip",class_name:"tumblr_tooltip",initialize:function(t){this.toolTipView=new n(t)}});e.exports=o},{"./views/tooltip":386,"prima/component":511}],385:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __t,__p="";Array.prototype.join;with(obj||{})__p+='<div class="tooltip_wrapper '+(null==(__t=placement)?"":_.escape(__t))+" "+(null==(__t=class_name)?"":_.escape(__t))+'" style="left:'+(null==(__t=left_css)?"":_.escape(__t))+'"><div class="tooltip">'+(null==(__t=text)?"":__t)+"</div></div>";return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],386:[function(t,e,i){"use strict";var s=t("jquery"),n=t("lodash"),o=t("prima/view"),a=t("../templates/tooltip.tpl"),r=o.extend({class_name:"tumblr_tooltip",template:a,defaults:{selector:"",class_name:"",offset:"50%",placement:"up"},initialize:function(t){this.options=t||{},this.options.selector=s.trim((t.selector||this.defaults.selector)+" "),this.options.class_name=t.class_name||this.defaults.class_name,this.options.offset=t.offset||this.defaults.offset,this.options.placement=t.placement||this.defaults.placement,this.tooltips=s(this.options.selector+"[data-tooltip]"),this.tooltips.on("remove",s.proxy(this.remove,this)),this.tooltips.on("mouseenter",n.bind(this.show,this)),this.tooltips.on("mouseleave",n.bind(this.hide,this))},show:function(t){var e=s(t.currentTarget);this.tooltip_template_data={tooltip:e.data("tooltip")};var i=s(this.tooltip(this.tooltip_template_data));e.append(i),this.setElement(i),this.delegateEvents(),i.removeClass("is_closed").addClass("is_open")},hide:function(t){var e=s(t.currentTarget),i=e.find("."+this.class_name);i.removeClass("is_open").addClass("is_closed"),i.on("transitionend webkitTransitionEnd oTransitionEnd MSTransitionEnd",n.bind(function(t){this.remove(t)},this))},remove:function(t){s(t.currentTarget).remove()},tooltip:function(t){return this.class_name="tooltip_wrapper",this.attributes={text:t.tooltip,placement:this.options.placement,class_name:this.options.class_name,left_css:this.options.offset},this.template(this.attributes)}});e.exports=r},{"../templates/tooltip.tpl":385,jquery:"HlZQrA",lodash:"MicNly","prima/view":580}],387:[function(t,e,i){"use strict";var s,n=t("jquery"),o=t("lodash"),a=t("prima/events"),r=t("prima/component"),l=r.extend({name:"TrackingPixels",initialize:function(){this.listenTo(a,"component:TrackingPixels",this.initPixels)},initPixels:function(t){t.init&&o.each(t.init,function(t){t.script&&n("body").append(t.script)})}});e.exports={setup:function(){return s||(s=new l),s}}},{jquery:"HlZQrA",lodash:"MicNly","prima/component":511,"prima/events":512}],388:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/collection"),o=t("../models/upload"),a=t("when"),r=n.extend({model:o,_listenToUploadModel:function(t){this.listenTo(t,"change",this._onUploadModelChange)},_stopListeningToUploadModel:function(t){this.stopListening(t)},_onUploadModelChange:function(t){s.has(t.changed,"complete")&&this.trigger("complete",this,t),s.has(t.changed,"error")&&t.get("error")&&this.trigger("error",this,t),s.has(t.changed,"complete")&&this.allComplete()&&this.trigger("allComplete",this)},add:function(t){return s.isArray(t)?s.forEach(t,this._listenToUploadModel,this):this._listenToUploadModel(t),n.prototype.add.apply(this,arguments)},remove:function(t){return s.isArray(t)?s.forEach(t,this._stopListeningToUploadModel,this):this._stopListeningToUploadModel(t),n.prototype.remove.apply(this,arguments)},removeIncomplete:function(t){var e=this.where({uploading:!1,complete:!1});return this.remove(e,t)},removeFailed:function(t){var e=this.filter(function(t){return t.get("error")});return this.remove(e,t)},allComplete:function(){return this.length?this.every(function(t){return t.get("complete")}):!1},anyUploading:function(){return this.length>0&&this.any(function(t){return t.get("uploading")})},getProgress:function(){var t=0,e=0;return this.forEach(function(i){i.get("error")&&(t+=i.get("bytesLoaded")||0,e+=i.get("bytesTotal")||0)}),e?t/e:0},promise:function(){if(this.allComplete())return a.resolve(this);var t=a.promise(s.bind(function(t,e){var i,n;i=s.bind(function(){this.stopListening(this,"uploads:allComplete",i),this.stopListening(this,"uploads:error",n),t.apply(this,arguments)},this),n=s.bind(function(){this.stopListening(this,"uploads:allComplete",i),this.stopListening(this,"uploads:error",n),e.apply(this,arguments)},this),this.listenToOnce(this,"uploads:allComplete",i),this.listenToOnce(this,"uploads:error",n)},this));return t}});e.exports=r},{"../models/upload":390,lodash:"MicNly","prima/collection":510,when:"RG2dij"}],389:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/component"),o=t("./views/fileupload"),a=t("./collections/uploads"),r=(t("./models/upload"),n.extend({name:"Upload",initialize:function(t){t=s.extend({},t),this.collection=t.collection||(t.collection=new a),this.indexView=new o(t),this.listenTo(this.collection,"all",this._relayCollectionEvent)},_relayCollectionEvent:function(){this.trigger.apply(this,arguments)},addFiles:function(t){return this.indexView.add({files:t})},promise:function(){return this.indexView.promise()},teardown:function(){return this.remove()},remove:function(){return this.indexView.remove(),this.stopListening(),this},render:function(){return this.indexView.render(),this},getElement:function(){return this.indexView.$el}}));e.exports=r},{"./collections/uploads":388,"./models/upload":390,"./views/fileupload":391,lodash:"MicNly","prima/component":511}],390:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/model"),o=n.extend({defaults:{url:"",file:null,error:!1,uploading:!1,complete:!1,bytesLoaded:0,bytesTotal:0},initialize:function(t,e){this.options=s.extend({},e),this.options.jqXHR&&this.setUploadRequest(this.options.jqXHR)},setUploadRequest:function(t){return this.jqXHR=t,t.then(function(){}),t},_uploadDone:function(){this.set({error:!1,uploading:!1,complete:!0})},_uploadFail:function(){this.set({error:!0,uploading:!1,complete:!1})},cancelUpload:function(){var t;return this.jqXHR&&(t=this.jqXHR.abort(),this.jqXHR=null),t},getProgress:function(){return this.get("bytesTotal")?this.get("bytesLoaded")/this.get("bytesTotal"):0}});e.exports=o},{lodash:"MicNly","prima/model":557}],391:[function(t,e,i){"use strict";var s=t("lodash"),n=t("sprintf-js").sprintf,o=t("prima/view"),a=t("prima/lib/mixin"),r=t("when"),l=t("prima/lib/translate"),h=t("../collections/uploads"),c=t("../models/upload"),u=t("prima/utils/recontextify"),d=["add","submit","send","done","fail","always","progress","progressall","start","stop","change","paste","drop","dragover","chunksend","chunkdone","chunkfail","chunkalways"],p=["add","send","progress","active","enable","disable"],m=o.extend({tagName:"input",attributes:{type:"file"},defaults:{name:"photo",maxUploadSize:!1,uploadPattern:!1,mediaType:"image",message:{cancel:"Canceled upload",error:"Upload error",filesize:"The file is too big. Squish it down, and try again!",filetype:"This is not valid %1$s file."},fileUpload:{singleFileUploads:!0,limitConcurrentUploads:1,sequentialUploads:!1,autoUpload:!0,formData:[],dataType:"json",dropZone:null,pasteZone:null}},_createUploadModel:function(t,e){var i=new c(t);return this.collection.add(i,e||{}),i},_createUploadModelForFile:function(t,e,i){e=s.extend({file:t},e);var n=this._createUploadModel(e,i);return t._uploadModel=n,n},initialize:function(t){if(this.options=s.merge({},this.defaults,t),this.options.url&&(this.options.fileUpload.url=this.options.url),this.options.collection?this.collection=this.options.collection:this.collection=new h,!this.options.fileUpload.url)throw new Error("Upload requires an endpoint URL");this.$el.prop("tabindex",-1),this.options.fileUpload.multiple&&this.$el.prop("multiple",!0),this.options.accept&&this.$el.prop("accept",this.options.accept);var e=s.merge({},this._fileUploadWrap);s.forEach(d,function(t){s.isFunction(e.defaults[t])||(e.defaults[t]=s.noop)},this);var i=new a(e);i.applyTo(this.options.fileUpload),s.forEach(d,function(t){this.options.fileUpload[t]=u(this.options.fileUpload[t],this)},this),this.$el.attr("name",this.options.name).fileupload(this.options.fileUpload),this._fileUpload=this.$el.data("blueimp-fileupload"),s.forEach(p,function(t){this[t]=function(){var e=s.toArray(arguments);e.unshift(t),this._fileUploadInvoke.apply(this,e)}},this)},_fileUploadInvoke:function(t){return this._fileUpload[t].apply(this._fileUpload,s.rest(arguments))},validateFile:function(t,e){e||(e=this.options);var i=[];return e.maxUploadSize&&t.size>e.maxUploadSize&&i.push({type:"filesize",message:n(e.message.filesize,e.maxUploadSize)}),e.uploadPattern&&t.type&&!e.uploadPattern.test(t.type)&&i.push({type:"filetype",message:n(e.message.filetype,e.mediaType)}),i},upload:function(t){this.add({files:[t]})},cancel:function(){var t;return this.jqXHR?(t=this.jqXHR.abort(),this.jqXHR=null):t=r.reject(this.options.message.cancel),t},_forMatchingFiles:function(t,e){var i=s.rest(arguments);this.collection.forEach(function(n){if(s.contains(t,n.get("file"))){var o=s.clone(i);o[0]=n,e.apply(this,o)}},this)},promise:function(){return this.collection.promise()},_fileUploadWrap:{defaults:{change:function(t,e,i){this._fileUpload.options.replaceFileInput&&this.setElement(t)},add:function(t,e,i){var n=i.files[0],o=this.validateFile(n),a={},r={};if(!s.isEmpty(o)){a.error=s.pluck(o,"message"),a.file=n;var l={errorType:"validation",messages:o,file:n};this.collection.trigger("invalid",this.collection,new this.collection.model(a)),this.trigger("error",l),r.silent=!0}return this._createUploadModelForFile(n,a,r),s.isEmpty(o)},send:function(t,e,i){return!0}},before:{},after:{
done:function(t,e,i){var n,o=s.get(i,"result.meta.status"),a=s.get(i,"result.response"),r=s.get(i,"result.errors");if(200!==o||s.isEmpty(a)){var h=function(){return a&&a.msg?a.msg:s.isArray(r)?s.isEmpty(r)?l("Woops :("):r:r.join(" ")}();n={error:h,uploading:!1}}else s.isArray(a)&&(a=a[0]),n=s.extend({complete:!0,uploading:!1},a);this._forMatchingFiles(i.files,function(t,e){t.set(e)},n)},fail:function(t,e,i){var n;n="abort"===i.errorThrown?{uploading:!1}:{error:this.options.message.error,uploading:!1},n.responseJSON=s.get(i,"jqXHR.responseJSON"),this._forMatchingFiles(i.files,function(t,e){t.set(e)},n)},progress:function(t,e,i){this._forMatchingFiles(i.files,function(t,e){t.set(e)},{bytesLoaded:i.loaded,bytesTotal:i.total})}},around:{add:function(t,e,i,n){var o=t.apply(this,s.rest(arguments));return o===!1||i.isDefaultPrevented()?!1:((n.autoUpload||n.autoUpload!==!1&&this._fileUpload.options.autoUpload)&&n.process().done(s.bind(function(){this.jqXHR=n.submit()},this)),o)},send:function(t,e,i,n){n.with_form_key=!0;var o=t.apply(this,s.rest(arguments));if(o){this._forMatchingFiles(n.files,function(t,e){t.set(e)},{uploading:!0});var a={files:n.files};this.collection.trigger("send",this.collection,a),this.trigger("send",a)}return o}}}});e.exports=m},{"../collections/uploads":388,"../models/upload":390,lodash:"MicNly","prima/lib/mixin":538,"prima/lib/translate":541,"prima/utils/recontextify":576,"prima/view":580,"sprintf-js":"qPOUxN",when:"RG2dij"}],392:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/component"),o=t("./views/webcam"),a=t("./utils/get_user_media"),r=n.extend({name:"Webcam",initialize:function(t){this.options=t=s.extend({},t),this.indexView=new o(t),this.listenTo(this.indexView,"all",this._relayViewEvent);var e=["teardown","render","remove"].concat(r.prototype.commands||[]);s.forEach(e,function(t){var e=this.indexView;this[t]=function(){return e[t].apply(e,arguments),this}},this)},_relayViewEvent:function(){this.trigger.apply(this,arguments)},getElement:function(){return this.indexView.$el},getHeightForWidth:function(t){return this.indexView.get("width")?t*this.indexView.get("height")/this.indexView.get("width"):0}},{hasUserMediaSupport:function(){return!!a}});e.exports=r},{"./utils/get_user_media":397,"./views/video_stream":399,"./views/webcam":400,lodash:"MicNly","prima/component":511}],393:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __p="";Array.prototype.join;with(obj||{})__p+='<div data-js-inner class="countdown-timer--inner"><div data-js-ticks class="countdown-timer--ticks"></div><div data-js-inner class="countdown-timer--fill"><div class="mask-static-half"><div class="fill"></div></div><div class="mask-rotating-half"><div data-js-rotator class="fill"></div></div></div></div>';return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],394:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __t,__p="";Array.prototype.join;with(obj||{})__p+='<video class="video-stream--video" width="'+(null==(__t=retina?2*width:width)?"":_.escape(__t))+'" height="'+(null==(__t=retina?2*height:height)?"":_.escape(__t))+'"></video><div data-js-novideo class="video-stream--no-video"><div data-subview="loader"></div></div>';return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],395:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __t,__p="";Array.prototype.join;with(obj||{})__p+='<div data-js-sizer class="webcam--sizer" style="padding-top:'+(null==(__t=ratio)?"":_.escape(__t))+'"><div class="webcam--container"><div data-js-videostreamcontainer class="webcam--container-layer"><div data-subview="videoStream"></div></div><div data-js-watermarkcontainer class="webcam-watermark '+(null==(__t=loading?"webcam-watermark--hidden":"")?"":_.escape(__t))+'"></div><div data-js-previewcontainer class="webcam--container-layer" style="display:'+(null==(__t=showPreviewContainer?"block":"none")?"":_.escape(__t))+'"><canvas data-js-canvas width="'+(null==(__t=retina?2*width:width)?"":_.escape(__t))+'" height="'+(null==(__t=retina?2*height:height)?"":_.escape(__t))+'" class="webcam--canvas"></canvas></div><div data-js-controlcontainer class="webcam--container-layer"><div data-subview="webcamControls"></div></div></div></div>';return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],396:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __t,__p="";Array.prototype.join;with(obj||{})__p+='<div data-js-overlaybuttons class="media-overlay">',enableFlash&&(__p+='<div data-js-flashbutton class="button webcam--flash-button '+(null==(__t=flash?"active":"")?"":_.escape(__t))+'"><div class="icon"></div></div>'),__p+="",enableRemove&&(__p+='<div data-subview="removeButton"></div>'),__p+='</div><div data-js-primarybutton class="big-button webcam--primary-button"><div data-js-snapbuttongroup="countdownTimer" class="big-button-group"><div data-subview="countdownTimer"></div></div><div data-js-snapbuttongroup="snapButton" class="big-button-group"><div data-js-snapbutton class="button webcam--snap-button"><div class="icon"></div></div>',enableGifMode&&(__p+='<div data-js-gifbutton class="button webcam--gif-button"><div class="icon"></div></div>'),__p+='</div><div data-js-snapbuttongroup="processing" class="big-button-group"><div data-js-processingbutton class="button webcam--processing-button"><div class="icon"></div></div></div><div data-js-snapbuttongroup="retakeButton" class="big-button-group"><div data-js-retakebutton class="button webcam--retake-button"><div class="icon"></div></div></div></div>';return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],397:[function(t,e,i){"use strict";var s=t("lodash"),n=t("jquery").browser,o=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia;n.mozilla&&Math.floor(n.version)>=20&&(o=navigator.mozGetUserMedia),o&&(o=s.bind(o,navigator)),e.exports=o},{jquery:"HlZQrA",lodash:"MicNly"}],398:[function(t,e,i){"use strict";var s=t("lodash"),n=t("jquery"),o=t("when"),a=t("velocity-animate").hook,r=t("velocity-animate").animate,l=t("prima/view"),h=t("prima/mixins/accessor"),c=t("prima/mixins/subviewable"),u=t("prima/mixins/selectorcache"),d=t("../templates/countdown_timer.tpl"),p=l.extend({className:"countdown-timer",template:d,mixins:[h,c,u],defaults:{duration:3e3,ticks:1},initialize:function(t){this.options=t=s.extend({},t),s.extend(this.attributes,s.pick(t,s.keys(this.defaults)))},start:function(t,e){s.isNumber(t)||(t=this.get("duration")),s.isNumber(e)||(e=this.get("ticks")),this.set({duration:t,ticks:e}),this._generateTickMarks(e),this.stop(),this.trigger("countdown:start"),this.js$("inner").removeClass("half-past"),this._halfPastTimeout=s.delay(s.bind(function(){this.js$("inner").addClass("half-past")},this),Math.floor(t/2));var i=0;return o.join(o.promise(s.bind(function(n,o){clearInterval(this._tickerInterval),this._tickerInterval=setInterval(s.bind(function(){this.trigger("countdown:tick",i++,e),i>=e&&(clearInterval(this._tickerInterval),n())},this),t/e)},this)),r(this.js$("rotator"),{rotateZ:["360deg","0deg"]},{easing:"linear",duration:t})).then(s.bind(function(){this.trigger("countdown:complete")},this))},stop:function(){clearTimeout(this._halfPastTimeout),clearInterval(this._tickerInterval),r(this.js$("rotator"),"stop")},teardown:function(){return clearTimeout(this._halfPastTimeout),clearInterval(this._tickerInterval),this.stopListening(),this},remove:function(){return this.teardown(),l.prototype.remove.apply(this,arguments)},_generateTickMarks:function(t){s.isNumber(t)||(t=this.get("ticks")),this.js$("ticks").empty(),t>1&&s.forEach(s.range(t),function(e){var i=n('<div class="countdown-timer--tick"></div>');a(i,"rotateZ",360*e/t+"deg"),a(i,"translateY","-50%"),this.js$("ticks").append(i)},this)},serialize:function(){return this.toJSON()},render:function(){return this.$el.html(this.template(this.serialize())),this._generateTickMarks(),this.attachSubViews(),this}});e.exports=p},{"../templates/countdown_timer.tpl":393,jquery:"HlZQrA",lodash:"MicNly","prima/mixins/accessor":542,"prima/mixins/selectorcache":553,"prima/mixins/subviewable":554,"prima/view":580,"velocity-animate":"lWl/mc",when:"RG2dij"}],399:[function(t,e,i){"use strict";var s=t("lodash"),n=t("jquery"),o=t("velocity-animate").animate,a=t("prima/view"),r=t("app/lib/create-object-url"),l=t("../utils/get_user_media"),h=t("prima/mixins/accessor"),c=t("prima/mixins/subviewable"),u=t("prima/mixins/selectorcache"),d=t("../templates/video_stream.tpl"),p=t("components/knight-rider-loader"),m=a.extend({className:"video-stream",template:d,mixins:[h,c,u],defaultOptions:{video:!0,audio:!1},defaults:{width:500,height:375,retina:!0,mirrored:!0,needsPermission:!0,running:!1},initialize:function(t){this.options=t=s.extend({},this.defaultOptions,t),s.extend(this.attributes,s.pick(t,s.keys(this.defaults)))},_onChangeRetina:function(t,e){e?this.$video.attr({width:2*this.get("width"),height:2*this.get("height")}):this.$video.attr({width:this.get("width"),height:this.get("height")})},_onChangeMirrored:function(t,e){this.$el.toggleClass("mirrored",e)},_onChangeRunning:function(t,e){this.loader&&this.loader.set("animate",!e),o(this.js$("noVideo"),"stop"),o(this.js$("noVideo"),{opacity:e?0:1},{display:e?"none":"block",delay:e?50:0,duration:100})},startStream:function(){if(!l)throw new Error("VideoStream: Cannot initialize without getUserMedia support");return l(s.pick(this.options,["audio","video"]),s.bind(this._onStreamReady,this),s.bind(this._onStreamError,this))},stopStream:function(){this.set("running",!1),this.streamURL=null,this.stream&&(this.stream.stop(),this.stream=null)},_onStreamReady:function(t){this.set("needsPermission",!1),this.stream=t,this.streamURL=r(this.stream),this._playVideoSteam()},_onStreamError:function(t){this.stopStream(),this.trigger("error",t)},_playVideoSteam:function(){this.video&&this.streamURL&&(this.video.src=this.streamURL,this.$video.one("loadeddata",s.bind(function(t){this.set("running",!0)},this)),this.video.play())},remove:function(){n(this.video).remove(),a.prototype.apply(this,arguments)},teardown:function(){return this.stopStream(),this.stopListening(),this},beforeRender:function(){this.loader=this.subViews.loader=new p({variation:"centered",loading:!this.get("running")}),this.listenTo(this,"change:retina",this._onChangeRetina),this.listenTo(this,"change:mirrored",this._onChangeMirrored),this.listenTo(this,"change:running",this._onChangeRunning)},render:function(){return this._onChangeMirrored(this,this.get("mirrored")),this.$el.html(this.template(this.toJSON())),this.attachSubViews(),this.$video=this.$(".video-stream--video"),this.video=this.$video.get(0),this._playVideoSteam(),this}});e.exports=m},{"../templates/video_stream.tpl":394,"../utils/get_user_media":397,"app/lib/create-object-url":431,"components/knight-rider-loader":461,jquery:"HlZQrA",lodash:"MicNly","prima/mixins/accessor":542,"prima/mixins/selectorcache":553,"prima/mixins/subviewable":554,"prima/view":580,"velocity-animate":"lWl/mc"}],400:[function(t,e,i){"use strict";var s=t("lodash"),n=t("jquery"),o=t("when"),a=t("velocity-animate").animate,r=t("prima/lib/data"),l=t("prima/view"),h=t("app/vendor/gif.js"),c=t("prima/utils/image/loader"),u=t("prima/utils/image/filereader"),d=t("prima/utils/image/canvas"),p=t("prima/mixins/accessor"),m=t("prima/mixins/subviewable"),g=t("prima/mixins/selectorcache"),f=t("../templates/webcam.tpl"),_=t("./video_stream"),v=t("./webcam_controls"),b=250,y=300,w=n(document),x="",C=l.extend({className:"webcam",template:f,mixins:[p,m,g],defaults:{watermarkUrl:"",width:540,height:405,retina:!0,mirrored:!0,enabled:!0,needsPermission:!0,showControls:!1,flash:!0,showPreviewContainer:!1,defaultTimer:3e3,timePerFrame:1e3,gifFrameCount:4,gifSpeed:200,enableFlash:!0,enableGifMode:!0,enableRemove:!0},commands:["toggleFlash","toggleMirrored","snap","gif","flash","gifStart","gifSnap","gifComplete","retake","close"],initialize:function(t){this.options=t=s.extend({},t),s.extend(this.attributes,s.pick(t,s.keys(this.defaults))),x=r.get("Context/hosts/assets_host"),this._WebcamControlsView=t.WebcamControlsView||v},_onChangeEnabled:function(t,e){e?this.videoStream.startStream():this.videoStream.stopStream()},_onChangeNeedsPermission:function(t,e){var i=200;e||clearTimeout(this._delayedPermissionCheck),a(this.$arrow,"stop"),a(this.$arrow,{opacity:e?1:0},{display:e?"block":"none",duration:i})},_onChangeWatermarkUrl:function(t,e){if(this.js$("watermarkContainer").empty(),this.$watermark=!1,e){if(!s.startsWith(e,"data:image/png;base64")&&(e.match(/^\w*:\/\//i)||!s.startsWith(e,"/")))throw new Error("Webcam watermark must be an absolute path or base64-encoded image.");s.startsWith(e,"/")&&(e=x+e),this.$watermark=n("<img/>",{alt:"",src:e}),this.js$("watermarkContainer").append(this.$watermark)}},_onChangeShowControls:function(t,e){var i=200;a(this.js$("controlContainer"),"stop"),a(this.js$("controlContainer"),{opacity:e?1:0},{display:e?"block":"none",duration:i})},_onChangeShowPreviewContainer:function(t,e){e?this.js$("previewContainer").css("display","block"):(this.js$("previewContainer").children("img").remove(),this.js$("previewContainer").css("display","none"))},startStream:function(){this.set("enabled",!0)},stopStream:function(){this.set("enabled",!1)},snap:function(t,e){this._snapFrame(t,e).then(s.bind(function(t){this.set("showPreviewContainer",!0),this.trigger("webcam:image",t),this.webcamControls.trigger("webcam:snapped")},this))},gif:function(t,e,i,n){s.isNumber(t)||(t=this.get("gifFrameCount")),s.isNumber(e)||(e=this.get("timePerFrame")),!s.isUndefined(i)||(i=this.get("flash")),!s.isUndefined(n)||(n=!!this.get("watermarkUrl")),this.gifStart();var o=0;clearInterval(this._gifInterval),this._gifInterval=setInterval(s.bind(function(){o++,this.gifSnap(o>=t),n&&clearInterval(this._gifInterval)},this),e)},gifStart:function(){this._frameBuffer=[]},gifSnap:function(t,e,i){this._snapFrame(e,i).then(s.bind(function(e){var i=this.js$("canvas"),s=i.get(0),n=document.createElement("canvas");n.width=.5*(s.width||i.width()),n.height=.5*(s.height||i.height()),d.drawElToCanvas(this.js$("canvas"),n),this._frameBuffer.push(n),t&&this.gifComplete()},this))},gifComplete:function(t){s.isNumber(t)||(t=this.get("gifSpeed"));var e=new h({workers:3,quality:1});s.forEach(this._frameBuffer,function(i){e.addFrame(i,{delay:t})},this),e.on("finished",s.bind(function(t){u.read(t).then(s.bind(function(t){c.load(t.base64).then(s.bind(function(t){var e=n('<img data-js-gif class="webcam--preview-image"/>');e.attr("src",t.src),this.js$("previewContainer").append(e),s.extend(t,{base64:t.src,isGif:!0}),this.trigger("webcam:image",t),this.webcamControls.showSnapButtonGroup("retakeButton"),this.set("showPreviewContainer",!0)},this))},this))},this)),e.render(),delete this._frameBuffer},retake:function(){this.set("showPreviewContainer",!1),this.trigger("webcam:reset")},close:function(){this.trigger("webcam:close")},_snapFrame:function(t,e){!s.isUndefined(t)||(t=this.get("flash")),!s.isUndefined(e)||(e=!!this.get("watermarkUrl"));var i=s.bind(this.flash,this),n=s.bind(this.grabVideoFrame,this,e);return o.promise(function(e,o){t?(i(),s.delay(function(){e(n())},.5*y)):e(n())})},drawWatermark:function(){var t=this.$watermark;if(t.get(0)){var e=this.js$("canvas").get(0),i=e.getContext("2d"),s=t.offset(),n=this.$el.offset();i.drawImage(t.get(0),2*(s.left-n.left),2*(s.top-n.top),t.width(),t.height())}},grabVideoFrame:function(t){d.drawElToCanvas(this.videoStream.video,this.js$("canvas"),this.get("mirrored")),t&&this.drawWatermark();var e=this.js$("canvas").get(0);return e?{width:e.width,height:e.height,base64:e.toDataURL("image/jpeg")}:{width:0,height:0,base64:null}},toggleFlash:function(t){!s.isUndefined(t)||(t=!this.get("flash")),this.set("flash",t)},toggleMirrored:function(t){!s.isUndefined(t)||(t=!this.get("mirrored")),this.set("mirrored",t)},flash:function(){return a(this.$flash,"stop"),this.$flash.css({display:"block",opacity:1}),a(this.$flash,{opacity:[0,1]},{display:"block",delay:y,duration:b}).then(s.bind(function(){this.$flash.css("display","none")},this))},_checkVideoStreamPermissions:function(){this._delayedPermissionCheck=s.delay(s.bind(function(){this.get("needsPermission")&&this._onChangeNeedsPermission(this,!0)},this),1e3),this.get("needsPermission")?(this.js$("controlContainer").css({display:"none",opacity:0}),this.listenToOnce(this.videoStream,"change:needsPermission",function(t,e){this.set("needsPermission",e)}),this.listenToOnce(this.videoStream,"change:running",function(t,e){clearTimeout(this._delayedPermissionCheck),e&&(this.set("needsPermission",!1),this.set("showControls",!0))})):this.set("showControls",!0)},serialize:function(){var t=this.toJSON();return t.ratio=(t.width?t.height/t.width*100:0)+"%",t.loading=this.videoStream?!this.videoStream.get("running"):!1,t},teardown:function(){return clearInterval(this._gifInterval),clearTimeout(this._delayedPermissionCheck),w.off("keydown.webcam keyup.webcam"),this.stopListening(),this.$flash&&this.$flash.remove(),delete this.$flash,this.$arrow&&this.$arrow.remove(),delete this.$arrow,this},remove:function(){return this.teardown(),l.prototype.remove.apply(this,arguments)},beforeRender:function(){var t=s.pick(this.attributes,s.keys(_.prototype.defaults)),e=s.pick(this.attributes,s.keys(this._WebcamControlsView.prototype.defaults));this.videoStream=this.subViews.videoStream=new _(t),this.webcamControls=this.subViews.webcamControls=new this._WebcamControlsView(e),this.$flash=n('<div class="webcam--flash"></div>').appendTo("body"),this.$arrow=n('<div class="webcam--permission-arrow"></div>').appendTo("body"),n.browser.mozilla&&this.$arrow.addClass("firefox"),this.set("needsPermission",!this.videoStream.get("running")),this.listenTo(this,"change:enabled",this._onChangeEnabled),this.listenTo(this,"change:needsPermission",this._onChangeNeedsPermission),this.listenTo(this,"change:watermarkUrl",this._onChangeWatermarkUrl),this.listenTo(this,"change:showControls",this._onChangeShowControls),this.listenTo(this,"change:showPreviewContainer",this._onChangeShowPreviewContainer),this.listenTo(this.videoStream,"change:running",function(t,e){this.js$("watermarkContainer").toggleClass("webcam-watermark--hidden",!e)}),this.listenTo(this.videoStream,"error",function(t){this.trigger("webcam:error",t),this.close()}),this.listenTo(this,"change:flash",function(t,e){this.webcamControls.set("flash",e)}),this.listenTo(this,"change:mirrored",function(t,e){this.videoStream.set("mirrored",e),this.webcamControls.set("mirrored",e)}),this.listenTo(this.webcamControls,"webcam",function(t){if(s.contains(this.commands,t)){var e=this[t];s.isFunction(e)&&e.apply(this,s.rest(arguments))}}),w.on("keydown.webcam keyup.webcam",s.bind(function(t){switch(t.which||t.keyCode){case 16:this.set("flash","keyup"===t.type);break;case 18:"keydown"===t.type&&t.metaKey&&this.toggle("mirrored");break;case 91:case 92:case 93:"keydown"===t.type&&t.altKey&&this.toggle("mirrored")}},this))},render:function(){return this.$el.html(this.template(this.serialize())),this.attachSubViews(),this._checkVideoStreamPermissions(),this.get("enabled")&&this.videoStream.startStream(),this.get("watermarkUrl")&&this._onChangeWatermarkUrl(this,this.get("watermarkUrl")),this}});e.exports=C},{"../templates/webcam.tpl":395,"./video_stream":399,"./webcam_controls":401,"app/vendor/gif.js":439,jquery:"HlZQrA",lodash:"MicNly","prima/lib/data":514,"prima/mixins/accessor":542,"prima/mixins/selectorcache":553,"prima/mixins/subviewable":554,"prima/utils/image/canvas":571,"prima/utils/image/filereader":572,"prima/utils/image/loader":573,"prima/view":580,"velocity-animate":"lWl/mc",when:"RG2dij"}],401:[function(t,e,i){"use strict";var s=t("lodash"),n=t("velocity-animate").hook,o=t("velocity-animate").animate,a=t("prima/view"),r=t("prima/mixins/accessor"),l=t("prima/mixins/subviewable"),h=t("prima/mixins/selectorcache"),c=t("./countdown_timer"),u=t("app/components/remove-button"),d=t("../templates/webcam_controls.tpl"),p=a.extend({className:"webcam-controls",template:d,events:{mouseenter:"_onHoverControls",mouseleave:"_onHoverControls","click [data-js-flashButton]":"_onClickFlashButton","click [data-js-snapButton]":"_onClickSnapButton","click [data-js-gifButton]":"_onClickGifButton","click [data-js-retakeButton]":"_onClickRetakeButton"},mixins:[r,l,h],defaults:{isActive:!1,flash:!0,mirrored:!0,defaultTimer:3e3,timePerFrame:1e3,gifFrameCount:4,enableFlash:!0,enableGifMode:!0,enableRemove:!0},initialize:function(t){this.options=t=s.extend({},t),s.extend(this.attributes,s.pick(t,s.keys(this.defaults)))},_onHoverControls:function(t){clearTimeout(this._removeIsActive);var e="mouseover"===t.type||"mouseenter"===t.type;e?this.set("isActive",!0):this._removeIsActive=s.delay(s.bind(function(){this.set("isActive",!1)},this),500)},_onClickFlashButton:function(){this.trigger("webcam","toggleFlash",!this.get("flash"))},_onClickSnapButton:function(t){var e=!t.altKey;this.countdownTimer.stop(),this.listenToOnce(this,"webcam:snapped",function(){this.showSnapButtonGroup("retakeButton")});var i=this.get("defaultTimer");e?(this.showSnapButtonGroup("countdownTimer",0),this.countdownTimer.start(i,1).then(s.bind(function(){this.trigger("webcam","snap")},this))):this.trigger("webcam","snap")},_onClickGifButton:function(t){this.countdownTimer.stop(),this.trigger("webcam","gifStart"),this.listenTo(this.countdownTimer,"countdown:tick",function(t,e){this.trigger("webcam","gifSnap",t+1>=e),e>t+1&&this.pulseButton()});var e=this.get("gifFrameCount"),i=this.get("timePerFrame");this.showSnapButtonGroup("countdownTimer",0),this.countdownTimer.start(e*i,e).then(s.bind(function(){this.stopListening(this.countdownTimer,"countdown:tick"),this.showSnapButtonGroup("processing")},this))},_onClickRetakeButton:function(t){this.showSnapButtonGroup("snapButton"),this.trigger("webcam","retake")},pulseButton:function(){var t=1.5;n(this.js$("primaryButton"),"translateX","-50%"),n(this.js$("primaryButton"),"scale",t),o(this.js$("primaryButton"),"stop"),o(this.js$("primaryButton"),{scale:[1,t]},{duration:200})},showSnapButtonGroup:function(t,e){s.isNumber(e)||(e=100);var i=this.js$("snapButtonGroup").filter('[data-js-snapButtonGroup="'+t+'"]');if(!s.isEmpty(i)){var n=this.js$("snapButtonGroup").not(i);o(i,"stop"),o(n,"stop"),o(this.js$("primaryButton"),"stop"),o(i,{opacity:1},{display:"block",duration:e}),o(n,{opacity:0},{display:"none",duration:e}),this.js$("primaryButton").toggleClass("invert","processing"===t);var a=60;"snapButton"===t&&this.get("enableGifMode")&&(a=150),o(this.js$("primaryButton"),{width:a},{display:"block",duration:e})}},serialize:function(){return this.toJSON()},teardown:function(){return this},beforeRender:function(){this.countdownTimer=this.subViews.countdownTimer=new c,this.listenTo(this,"change:flash",function(t,e){this.js$("flashButton").toggleClass("active",e)}),this.removeButton=this.subViews.removeButton=new u({buttonClass:"active",onClick:s.bind(function(){this.trigger("webcam","close")},this)}),this.listenTo(this,"change:isActive",function(t,e){this.js$("overlayButtons").toggleClass("active",e)})},render:function(){return this.$el.html(this.template(this.serialize())),this.attachSubViews(),this.showSnapButtonGroup("snapButton",0),this}});e.exports=p},{"../templates/webcam_controls.tpl":396,"./countdown_timer":398,"app/components/remove-button":377,lodash:"MicNly","prima/mixins/accessor":542,"prima/mixins/selectorcache":553,"prima/mixins/subviewable":554,"prima/view":580,"velocity-animate":"lWl/mc"}],402:[function(t,e,i){"use strict";var s=t("prima/component"),n=t("./views/archive-controls-view.js"),o=s.extend({name:"ArchivePlusComponent",initialize:function(t){this.options=t||{},this.archiveControlsView=new n({postType:t.postType||!1,tagName:t.tagName||!1})},setup:function(){return this}});e.exports=o},{"./views/archive-controls-view.js":403,"prima/component":511}],403:[function(t,e,i){"use strict";var s=t("jquery"),n=t("lodash"),o=t("prima/view"),a=o.extend({el:'[data-view="archive-controls"]',events:{"click .post_type_filter_menu":"toggleMenu","click .menu_item":"handleMenuFilter"},initialize:function(t){this.options=t||{},t.tagName&&this.setupTagged(),t.postType&&this.setupFiltered(),this.$el.removeClass("inactive")},setupTagged:function(){this.pathFragment="/tagged/",this.$el.html('<h3 class="archive-tagged-label">#'+n.escape(this.options.tagName)+"</h3>")},setupFiltered:function(){this.pathFragment="/filter-by/",this.$menu=this.$('[data-search-action-type="filter_post_type"]'),this.$menuLabel=this.$menu.find(".control_text"),"all"!==this.options.postType&&(this.$menuLabel.addClass("active"),this.$menuLabel.text(this.options.postType))},menuIsOpen:!1,toggleMenu:function(t){t.preventDefault(),this.$menu.toggleClass("show-menu",this.menuIsOpen=!this.menuIsOpen),this.menuIsOpen&&s(document).on("mousedown.fake-glass",n.bind(function(t){var e=s(t.target);e.closest(this.el).length||(s(document).off("mousedown.fake-glass"),this.toggleMenu(t))},this))},handleMenuFilter:function(t){var e=s(t.currentTarget);this.filterRedirect(e.data("search-action-value")),this.$menu.removeClass("show-menu")},filterRedirect:function(t){t.length&&("all"===t?document.location.href="/archive":document.location.href="/archive"+this.pathFragment+t)}});e.exports=a},{jquery:"HlZQrA",lodash:"MicNly","prima/view":580}],"Ymdf+y":[function(t,e,i){"use strict";var s=t("prima/lib/flags"),n=t("app/router"),o=t("./components/archive-plus"),a=n.extend({root:"/archive/",logs:function(){return[]},routes:{"tagged/:tag":"archivePlusTagged","filter-by/:type":"archivePlusFiltered",":year":"archive",":year/:month":"archive","*default":"archive"},initialize:function(){},archive:function(t,e,i){s.bool("archive-plus")&&this.archivePlusFiltered("all")},archivePlusTagged:function(t){s.bool("archive-plus")&&(this.ap=new o({tagName:t}),this.apView=this.ap.setup())},archivePlusFiltered:function(t){s.bool("archive-plus")&&(this.ap=new o({postType:t}),this.apView=this.ap.setup())}});e.exports=a,t("./legacy")},{"./components/archive-plus":402,"./legacy":406,"app/router":438,"prima/lib/flags":"f/LVtH"}],context:[function(t,e,i){e.exports=t("Ymdf+y")},{}],406:[function(t,e,i){var s=t("prima/utils/exposer");t("app/vendor/jquery-plugins/jquery.masonry.ghost.edition/jquery.masonry.ghost.edition"),s({})},{"app/vendor/jquery-plugins/jquery.masonry.ghost.edition/jquery.masonry.ghost.edition":442,"prima/utils/exposer":569}],407:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/component"),o=t("prima/lib/data"),a=n.extend({name:"AdsPaginationHelper",defaults:{nextAdPos:0},initialize:function(){var t=o.get("Components/AdsPaginationHelper");this.adsData=s.extend({},this.defaults,t)},getNextAdPos:function(){return this.adsData.nextAdPos}});e.exports=a},{lodash:"MicNly","prima/component":511,"prima/lib/data":514}],408:[function(t,e,i){"use strict";function s(t){return new n(t)}var n=t("./views/blog-search-view");e.exports=s},{"./views/blog-search-view":421}],409:[function(t,e,i){"use strict";var s=t("jquery"),n=t("lodash"),o=t("prima/events"),a=t("prima/model"),r=t("prima/collection"),l=a.extend({defaults:{maxRender:20,matchTerm:"",typeAheadMatches:[]},urlRoot:"/svc/search/blog_search_typeahead",url:function(){return this.urlRoot+"/"+this.get("blogname")},initialize:function(){this.items=new r,this.fetched=!1,this.listenTo(o,"peeprsearch:change:unsetTerm",this.onUnsetTermChange),this.listenTo(this,"change:matchTerm sync",this.setMatches)},onUnsetTermChange:function(t){this.set("matchTerm",t.term)},hasMatches:function(){return this.items.length&&this.get("typeAheadMatches").length||!this.fetched},setMatches:function(){var t=this.get("matchTerm");if(!t.length)return void this.set("typeAheadMatches",this.items.toJSON());var e=this.items.filter(function(e){return e.get("tag").indexOf(t)>-1});this.set("typeAheadMatches",n.invoke(e,"toJSON"))},getItems:function(){if(this.items.length){var t=s.Deferred();return t.resolve(),t.promise()}return this.fetch(arguments)},parse:function(t){return this.items.reset(t.tags),this.fetched=!0,n.omit(t,"tags")}});e.exports=l},{jquery:"HlZQrA",lodash:"MicNly","prima/collection":510,"prima/events":512,"prima/model":557}],410:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/events"),o=t("prima/model"),a=t("prima/collection"),r=o.extend({urlRoot:"/svc/search/blog_search",defaults:{next_offset:0,limit:10,sort:"CREATED_DESC",post_type:"ANY",term:"",unsetTerm:"",post_role:"ANY",filter_nsfw:!1,showOriginalPostsSwitch:!0,showNsfwSwitch:!1},initialize:function(){this.listenTo(this,"change:unsetTerm",this.onUnsetTermChange),this.listenTo(n,"peeprsearch:change:term",this.onTermSelect),this.listenTo(this,"change:term change:sort change:post_type change:post_role",this.resetSearch),this.posts=new a},resetSearch:function(){this.set(s.pick(this.defaults,["limit","next_offset"])),this.posts.reset(),this.trigger("search:reset")},reset:function(){this.posts.reset(),this.set(this.defaults),this.trigger("reset")},url:function(){return this.urlRoot+"/"+this.get("blogname")+"/"+this.get("term")},onTermSelect:function(t){this.search(t.term)},onUnsetTermChange:function(){n.trigger("peeprsearch:change:unsetTerm",{term:this.get("unsetTerm")})},search:function(t){t=t||this.get("unsetTerm"),t.length&&this.set("term",t)},fetch:function(){this.get("next_offset")<0||o.prototype.fetch.apply(this,arguments)},parse:function(t){return this.posts.length?s.each(t.response.posts,function(t){this.posts.add(t)},this):this.posts.reset(t.response.posts),delete t.response.posts,t.response},sync:function(t,e,i){"read"===t&&(i.data=this.pick("next_offset","limit","sort","post_type","post_role","filter_nsfw")),o.prototype.sync.apply(this,arguments)}});e.exports=r},{lodash:"MicNly","prima/collection":510,"prima/events":512,"prima/model":557}],411:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __t,__p="";Array.prototype.join;with(obj||{})__p+='<ul class="popover_inner_list search_filter_items"><li class="popover_menu_item sort_filter" data-filter="sort:POPULARITY_DESC"><span class="popover_menu_item_anchor"><i class="icon icon_checkmark"></i>'+(null==(__t=__("Top Posts"))?"":_.escape(__t))+'</span></li><li class="popover_menu_item sort_filter" data-filter="sort:CREATED_DESC"><span class="popover_menu_item_anchor"><i class="icon icon_checkmark"></i>'+(null==(__t=__("Recent Posts"))?"":_.escape(__t))+"</span></li></ul>",model.showOriginalPostsSwitch&&(__p+='<ul class="popover_inner_list search_filter_items"><li class="popover_menu_item sort_filter toggle"><span class="popover_menu_item_anchor"><div class="option-radio"><label class="binary_switch"><input type="checkbox" name="post_role" id="post_role" data-value="ORIGINAL"> <span class="binary_switch_track"></span> <span class="binary_switch_button"></span></label></div>'+(null==(__t=__("Original Posts"))?"":_.escape(__t))+"</span></li></ul>"),__p+='<ul class="popover_inner_list search_filter_items"><li class="popover_menu_item post_type_filter" data-filter="post_type:ANY"><span class="popover_menu_item_anchor"><i class="icon icon_checkmark"></i>'+(null==(__t=__("All Types"))?"":_.escape(__t))+'</span></li><li class="popover_menu_item post_type_filter post_text_filter" data-filter="post_type:TEXT"><span class="popover_menu_item_anchor"><i class="icon icon_checkmark"></i> <i class="icon post_type_icon icon_post_text_small"></i>'+(null==(__t=__("Text"))?"":_.escape(__t))+'</span></li><li class="popover_menu_item post_type_filter post_photo_filter" data-filter="post_type:PHOTO"><span class="popover_menu_item_anchor"><i class="icon icon_checkmark"></i> <i class="icon post_type_icon icon_post_photo_small"></i>'+(null==(__t=__("Photo"))?"":_.escape(__t))+'</span></li><li class="popover_menu_item post_type_filter post_quote_filter" data-filter="post_type:QUOTE"><span class="popover_menu_item_anchor"><i class="icon icon_checkmark"></i> <i class="icon post_type_icon icon_post_quote_small"></i>'+(null==(__t=__("Quote"))?"":_.escape(__t))+'</span></li><li class="popover_menu_item post_type_filter post_link_filter" data-filter="post_type:LINK"><span class="popover_menu_item_anchor"><i class="icon icon_checkmark"></i> <i class="icon post_type_icon icon_post_link_small"></i>'+(null==(__t=__("Link"))?"":_.escape(__t))+'</span></li><li class="popover_menu_item post_type_filter post_chat_filter" data-filter="post_type:CHAT"><span class="popover_menu_item_anchor"><i class="icon icon_checkmark"></i> <i class="icon post_type_icon icon_post_chat_small"></i>'+(null==(__t=__("Chat"))?"":_.escape(__t))+'</span></li><li class="popover_menu_item post_type_filter post_audio_filter" data-filter="post_type:AUDIO"><span class="popover_menu_item_anchor"><i class="icon icon_checkmark"></i> <i class="icon post_type_icon icon_post_audio_small"></i>'+(null==(__t=__("Audio"))?"":_.escape(__t))+'</span></li><li class="popover_menu_item post_type_filter post_video_filter" data-filter="post_type:VIDEO"><span class="popover_menu_item_anchor"><i class="icon icon_checkmark"></i> <i class="icon post_type_icon icon_post_video_small"></i>'+(null==(__t=__("Video"))?"":_.escape(__t))+"</span></li></ul>",
model.showNsfwSwitch&&(__p+='<ul class="popover_inner_list search_filter_items"><li class="popover_menu_item sort_filter toggle"><span class="popover_menu_item_anchor"><div class="option-radio"><label class="binary_switch"><input type="checkbox" name="filter_nsfw" id="filter_nsfw" data-value="true" class="search-nsfw-filter-checkbox-input"> <span class="binary_switch_track"></span> <span class="binary_switch_button"></span></label></div>'+(null==(__t=__("Safe search"))?"":_.escape(__t))+"</span></li></ul>"),__p+="";return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],412:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __p="";Array.prototype.join;with(obj||{})__p+='<i class="icon_filter show-filter-popover nav_icon"></i>';return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],413:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __t,__p="";Array.prototype.join;with(obj||{}){__p+='<ul class="popover_inner_list search_filter_items"><li class="popover_header">'+(null==(__t=__("Popular Tags:"))?"":_.escape(__t))+"</li>";for(var i=0;i<model.maxRender&&i<model.typeAheadMatches.length;i++)__p+='<li class="popover_menu_item" data-term="'+(null==(__t=model.typeAheadMatches[i].tag)?"":_.escape(__t))+'"><span class="popover_menu_item_anchor">#'+(null==(__t=model.typeAheadMatches[i].tag)?"":_.escape(__t))+"</span></li>";__p+="</ul>"}return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],414:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __t,__p="";Array.prototype.join;with(obj||{})__p+='<input type="text" class="blog-search-input" placeholder="'+(null==(__t=__("Search %s",model.blogname))?"":_.escape(__t))+'">';return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],415:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __t,__p="";Array.prototype.join;with(obj||{})__p+='<p class="no-results-text" style="color: '+(null==(__t=model.themeParams.title_color)?"":_.escape(__t))+'">'+(null==(__t=__("Nothing here about<br/>%s.",_.escape(model.term)))?"":__t)+"</p>";return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],416:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __p="";Array.prototype.join;with(obj||{})__p+='<div class="popover popover_menu popover_gradient"><div class="popover_inner"></div></div>';return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],417:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __p="";Array.prototype.join;with(obj||{})__p+='<form class="blog-search-form"><div data-subview="filters"></div><i class="icon_arrow_thin_left clear-search nav_icon"></i> <i class="icon_search toggle-search nav_icon"></i><div data-subview="input"></div></form>';return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],418:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/views/base"),o=t("../templates/blog-filters.tpl"),a=t("./popovers/blog-search-filter-popover"),r=n.extend({className:"search-filters",template:o,events:{"click .show-filter-popover":"showPopover"},initialize:function(){this.listenTo(this.model,"search:reset",this.hidePopover)},showPopover:function(){this.popover||(this.popover=new a({pinnedTarget:this.$el,model:this.model,preventInteraction:!0}),this.popover.render(),this.listenTo(this.popover,"close",this.onPopoverClose))},hidePopover:function(){this.popover&&this.popover.hide()},onPopoverClose:function(){s.defer(s.bind(function(){this.popover=null},this))}});e.exports=r},{"../templates/blog-filters.tpl":412,"./popovers/blog-search-filter-popover":426,lodash:"MicNly","prima/views/base":581}],419:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/views/base"),o=t("prima/events"),a=t("prima/mixins/selectorcache"),r=t("./popovers/blog-search-autocomplete-helper"),l=t("../models/blog-search-autocomplete-model"),h=t("../templates/blog-search-input.tpl"),c=n.extend({className:"search-input",template:h,mixins:[a],$$cacheKeys:{"blog-search-input":".blog-search-input"},initialize:function(){this.autocompletePopover=null,this.bindEvents(),this.blogSearchAutocompleteModel=new l({blogname:this.model.get("blogname")})},afterRender:function(){this.blogSearchAutocompleteHelper=new r({model:this.blogSearchAutocompleteModel,el:this.$$(".blog-search-input")})},events:{"focus .blog-search-input":"inputFocusHandler","keyup .blog-search-input":"inputKeyUpHandler","blur .blog-search-input":"inputBlurHandler"},bindEvents:function(){this.listenTo(this.model,"change:term",this.onTermChange),this.listenTo(this.model,"reset",this.onModelReset)},inputKeyUpHandler:function(){this.model.set("unsetTerm",this.getTerm()),this.blogSearchAutocompleteModel.set("matchTerm",this.getTerm())},focusInput:function(){this.$$(".blog-search-input").focus(),this.blogSearchAutocompleteHelper.showPopover()},getTerm:function(){return s.trim(this.$$(".blog-search-input").val())},setTerm:function(t){this.$$(".blog-search-input").val(t).blur()},onTermChange:function(t,e){this.setTerm(e)},onModelReset:function(){this.setTerm("")},inputFocusHandler:function(){o.trigger("indashblog:keycommands:suspend",!0)},inputBlurHandler:function(){o.trigger("indashblog:keycommands:resume")}});e.exports=c},{"../models/blog-search-autocomplete-model":409,"../templates/blog-search-input.tpl":414,"./popovers/blog-search-autocomplete-helper":422,lodash:"MicNly","prima/events":512,"prima/mixins/selectorcache":553,"prima/views/base":581}],420:[function(t,e,i){"use strict";var s=t("jquery"),n=t("lodash"),o=t("prima/events"),a=t("prima/views/base"),r=t("../templates/blog-search-no-results.tpl"),l=a.extend({className:"search-no-results",template:r,afterRender:function(){this.setHeight(),this.listenTo(o,"DOMEventor:flatresize",n.throttle(this.setHeight,300))},setHeight:function(){var t=s(".indash_blog .posts"),e=t.outerHeight()-t.height(),i=s(".indash_blog .header").height();this.$el.height(s(window).height()-i-e)}});e.exports=l},{"../templates/blog-search-no-results.tpl":415,jquery:"HlZQrA",lodash:"MicNly","prima/events":512,"prima/views/base":581}],421:[function(t,e,i){"use strict";var s=t("lodash"),n=t("jquery"),o=t("prima/views/base"),a=t("prima/events"),r=t("../templates/blog-search.tpl"),l=t("./blog-search-filters"),h=t("./blog-search-input"),c=t("./blog-search-no-results"),u=t("../models/blog-search-model"),d=o.extend({className:"peepr-blog-search",template:r,subviews:{filters:{constructor:l},input:{constructor:h}},events:{"submit .blog-search-form":"formSubmitHandler","click .blog-search-form":"onFormClick","click .clear-search":"clearSearch","click .toggle-search":"toggleSearch"},initialize:function(t){this.options=t,this.searchActive=!1,this.blog=t.blog,this.model=new u({blogname:this.blog.tumblelog_name_or_id,themeParams:this.blog.get("global_theme_params")}),s.each(this.subviews,function(t){t.options=t.options||{},t.options.model=this.model},this),this.bindEvents()},bindEvents:function(){this.listenTo(this.model.posts,"reset",this.onPostsReset),this.listenTo(this.model.posts,"add",this.onPostsAdd),this.listenTo(this.model,"search:reset",this.onSearchReset),this.listenTo(this.model,"change:next_offset",this.onOffsetChange),this.listenTo(this.model,"change:term",s.bind(this.log,this,"search-start",{})),this.listenTo(a,"indashblog:search:fetch-requested",this.onFetchRequested),this.listenTo(a,"indashblog:ready-animation-start",this.onPeeprReady)},onPeeprReady:function(){this.setWidth()},setWidth:function(){var t=this.$el.parents(".navigation_inner"),e=t.width(),i=t.find(".header_controls").outerWidth();this.$el.width(e-i)},onFetchRequested:function(t){this.model.fetch(t)},formSubmitHandler:function(t){t.preventDefault(),this.model.search()},onFormClick:function(t){t.stopPropagation()},toggleSearch:function(t){return t=s.defaults(t,{force:null,focus:!0}),this.model.get("term").length&&null===t.force?void this.clearSearch():(this.searchActive=s.isBoolean(t.force)?t.force:!this.searchActive,this.$el.toggleClass("show-search",this.searchActive),n(".indash_header_wrapper").toggleClass("search-active",this.searchActive),void(this.searchActive?t.focus&&s.delay(s.bind(this.input.focusInput,this.input),300):this.model.reset()))},clearSearch:function(){this.toggleSearch({force:!1}),a.trigger("indashblog:search:clear"),this.log("search-clear")},onSearchReset:function(){var t=this.model.get("term").length>0;this.$el.toggleClass("term-entered",t),t&&(a.trigger("indashblog:search:start"),this.searchActive||this.toggleSearch({focus:!1,force:!0}))},onPostsReset:function(t){t.length&&(a.trigger("indashblog:search:complete",t.toJSON()),this.log("search-complete"))},onOffsetChange:function(t,e){e>=0||(a.trigger("indashblog:search:results-end",this.model.posts.length?null:new c({model:this.model})),this.log("search-results-end"))},onPostsAdd:function(t){a.trigger("indashblog:search:post-added",t.toJSON())},log:function(t,e){var i={loggingData:s.defaults({blogname:this.blog.tumblelog_name_or_id,term:this.model.get("term"),sort:this.model.get("sort"),post_type:this.model.get("post_type"),post_role:this.model.get("post_role"),next_offset:this.model.get("next_offset")},e||{})};a.trigger("peepr-search:"+t,i)},remove:function(){this.model.stopListening(),o.prototype.remove.call(this)}});e.exports=d},{"../models/blog-search-model":410,"../templates/blog-search.tpl":417,"./blog-search-filters":418,"./blog-search-input":419,"./blog-search-no-results":420,jquery:"HlZQrA",lodash:"MicNly","prima/events":512,"prima/views/base":581}],422:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/views/base"),o=t("./blog-search-autocomplete-popover"),a=n.extend({events:{click:"showPopover",blur:"onInputBlur"},initialize:function(){this.popover=null,this.bindEvents()},bindEvents:function(){this.listenTo(this.model,"change:matchTerm",this.onMatchTermChange)},onMatchTermChange:function(){this.model.get("typeAheadMatches").length?this.showPopover():this.hidePopover()},showPopover:function(){this.model.getItems().then(s.bind(function(){!this.popover&&this.model.hasMatches()&&(this.popover=new o({pinnedTarget:this.$el,model:this.model,shift:{x:-this.getLeftOffset(),y:0},preventInteraction:!0,keycommands:!0}).render(),this.listenTo(this.popover,"close",this.onPopoverClose))},this))},getLeftOffset:function(){return this._leftOffset=this._leftOffset||this.$el.width()/2,this._leftOffset},onInputBlur:function(){s.delay(s.bind(this.hidePopover,this),100)},hidePopover:function(){this.popover&&this.popover.hide()},onPopoverClose:function(){s.defer(s.bind(function(){this.popover=null},this))}});e.exports=a},{"./blog-search-autocomplete-popover":424,lodash:"MicNly","prima/views/base":581}],423:[function(t,e,i){"use strict";var s=t("jquery"),n=t("prima/events"),o=t("prima/views/base"),a=t("../../templates/blog-search-autocomplete-list.tpl"),r=o.extend({template:a,events:{"click [data-term]":"onTermClick"},initialize:function(){this.bindEvents()},bindEvents:function(){this.listenTo(this.model,"change:typeAheadMatches",this.render)},onTermClick:function(t){this.selectTerm(s(t.currentTarget))},selectTerm:function(t){n.trigger("peeprsearch:change:term",{term:t.attr("data-term")})}});e.exports=r},{"../../templates/blog-search-autocomplete-list.tpl":413,jquery:"HlZQrA","prima/events":512,"prima/views/base":581}],424:[function(t,e,i){"use strict";var s=t("./blog-search-popover"),n=t("./blog-search-autocomplete-list"),o=s.extend({className:s.prototype.className+" blog-search-autocomplete-popover",bindEvents:function(){s.prototype.bindEvents.apply(this,arguments),this.listenTo(this,"itemSelected",this.subview.selectTerm)},Subview:n});e.exports=o},{"./blog-search-autocomplete-list":423,"./blog-search-popover":427}],425:[function(t,e,i){"use strict";var s=t("jquery"),n=t("prima/views/base"),o=t("../../templates/blog-filters-popover.tpl"),a=n.extend({template:o,events:{"click [data-filter]":"onFilterClick","click .sort_filter.toggle":"onToggleFilterClick","click .option-radio":"onCheckboxClick","change [type=checkbox]":"onCheckboxChange"},initialize:function(){this.bindEvents()},afterRender:function(){this.onPostTypeChange(),this.onSortChange(),this.onPostRoleChange(),this.onFilterNsfwChange()},bindEvents:function(){this.listenTo(this.model,"change:sort",this.onSortChange),this.listenTo(this.model,"change:post_type",this.onPostTypeChange),this.listenTo(this.model,"change:post_role",this.onPostRoleChange),this.listenTo(this.model,"change:filter_nsfw",this.onFilterNsfwChange)},onPostRoleChange:function(){this.$("#post_role").prop("checked",this.model.get("post_role")!==this.model.defaults.post_role)},onPostTypeChange:function(){this.$(".post_type_filter.active").removeClass("active"),this.$('[data-filter="post_type:'+this.model.get("post_type")+'"]').addClass("active")},onFilterNsfwChange:function(){this.$(".search-nsfw-filter-checkbox-input").prop("checked",this.model.get("filter_nsfw")!==this.model.defaults.filter_nsfw)},onSortChange:function(){this.$(".sort_filter.active").removeClass("active"),this.$('[data-filter="sort:'+this.model.get("sort")+'"]').addClass("active")},onFilterClick:function(t){var e=s(t.currentTarget).data("filter").split(":");this.model.set(e[0],e[1])},onCheckboxChange:function(t){var e=s(t.currentTarget),i=t.currentTarget.id,n=e.data("value"),o=e.prop("checked");this.model.set(i,o?n:this.model.defaults[i])},onCheckboxClick:function(t){t.stopPropagation()},onToggleFilterClick:function(t){var e=s(t.currentTarget).find("[type=checkbox]"),i=e.prop("checked");e.prop("checked",!i).trigger("change")}});e.exports=a},{"../../templates/blog-filters-popover.tpl":411,jquery:"HlZQrA","prima/views/base":581}],426:[function(t,e,i){"use strict";var s=t("./blog-search-popover"),n=t("./blog-search-filter-list"),o=s.extend({className:s.prototype.className+" blog-search-filters-popover",Subview:n});e.exports=o},{"./blog-search-filter-list":425,"./blog-search-popover":427}],427:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/mixins/popoverbase"),o=t("prima/view"),a=t("prima/utils/bindendevent").transition,r=t("prima/lib/clickoutside"),l=t("prima/mixins/keycommands"),h=t("../../templates/blog-search-popover.tpl"),c=o.extend({className:"popover--blog-search",mixins:[n,l],template:h,keycommands:{"keydown:down":"targetNextLi","keydown:tab":"targetNextLi","keydown:up":"targetPrevLi","keydown:shift+tab":"targetPrevLi","keyup:enter":"selectLi"},defaults:{keycommands:!1,keyboardFocusClass:"keyboard_focus"},initialize:function(t){return this.options=s.defaults(t,this.defaults),this.Subview?(this.subview=new this.Subview(t),void this.bindEvents()):void this.remove()},render:function(){return this.$el.html(this.template()),this.$(".popover_inner").append(this.subview.render().$el),this.$main=this.$el.find(".popover"),s.delay(s.bind(function(){this.$main.addClass("popover--active"),this.bindClickOutside()},this),1),this},bindEvents:function(){this.listenTo(this.subview,"remove",this.hide),this.options.keycommands||this.disableKeys()},bindClickOutside:function(){this._popoverBase.autoTeardown&&(this.clickOutside=new r(this.el),this.clickOutside.on("click:outside",this.hide,this))},unbindClickOutside:function(){this.clickOutside&&(this.clickOutside.remove(),this.clickOutside=null)},targetNextLi:function(t){t.preventDefault(),this.$active?(this.$active.removeClass(this.options.keyboardFocusClass),this.$active=this.$active.next().length?this.$active.next():this.$(".popover_menu_item").first()):this.$active=this.$(".popover_menu_item").first(),this.$active.addClass(this.options.keyboardFocusClass),this.scrollToActive()},targetPrevLi:function(t){t.preventDefault(),this.$active?(this.$active.removeClass(this.options.keyboardFocusClass),this.$active=this.$active.prev().length?this.$active.prev():this.$(".popover_menu_item").last()):this.$active=this.$(".popover_menu_item").last(),this.$active.addClass(this.options.keyboardFocusClass),this.scrollToActive()},selectLi:function(){this.$active&&this.trigger("itemSelected",this.$active)},scrollToActive:function(){this.$scrollable=this.$scrollable||this.$(".popover_inner"),this.$scrollable.scrollTop(this.$scrollable.scrollTop()+this.$active.position().top-this.$scrollable.height()+this.$active.outerHeight())},hide:function(){this.$main.removeClass("popover--active"),this.unbindClickOutside(),a(this.$el,s.bind(function(){this.subview.remove(),this.remove(),this.teardown()},this))}});e.exports=c},{"../../templates/blog-search-popover.tpl":416,lodash:"MicNly","prima/lib/clickoutside":513,"prima/mixins/keycommands":547,"prima/mixins/popoverbase":550,"prima/utils/bindendevent":560,"prima/view":580}],428:[function(t,e,i){"use strict";var s=t("prima/utils/exposer");s({"Tumblr.Prima.Upload":t("app/components/upload"),"Tumblr.Prima.Ligature":t("ligature"),"Tumblr.Events":t("prima/events"),"Tumblr.Prima.Events":t("prima/events"),"Tumblr.Prima.Dialog":t("app/components/dialog"),"Tumblr.Dialog":t("app/components/dialog"),"Tumblr.PostMessageChannel":t("components/post-message-channel"),"Tumblr.Prima.DOMEventor":t("prima/lib/domeventor"),"Tumblr.Prima.gutterMediaManager":t("app/components/gutter-media-manager"),"Tumblr.Prima.Vendor.when":t("when"),"Tumblr.Prima.Vendor.sequence":t("when/sequence"),"Tumblr.log_lady":t("prima/lib/loglady"),"Tumblr.Prima.logLady":t("prima/lib/loglady"),"Tumblr.Prima.Models.Post":t("app/models/post"),"Tumblr.Prima.Models.Tumblelog":t("app/models/tumblelog"),"Tumblr.Prima.CrtPlayer":t("components/crt/player"),"Tumblr.Prima.BlogCard":t("app/components/blog-card"),"Tumblr.Prima.Url":t("prima/utils/url"),ace:t("app/vendor/ace"),"Tumblr.Prima.ToolTip":t("app/components/tooltip"),"Tumblr.Prima.SharePopover":t("components/popover/views/share-popover"),"Tumblr.Prima.Messaging.SharePost":t("app/components/messaging-share-post"),"Tumblr.Prima.utils.caniuse":t("prima/utils/caniuse"),"Tumblr.Prima.ConfettiView":t("app/components/confetti/views/confetti-view"),"Tumblr.Prima.FlatSelect":t("app/components/flat-select"),"Tumblr.Prima.Mixins.loggingData":t("prima/mixins/generate-logging-data"),"Tumblr.Prima.Scrollbar":t("app/lib/scrollbar"),"Tumblr.Prima.MessageControlsPopover":t("components/popover/views/message-controls-popover"),"Tumblr.Prima.Block":t("app/lib/block"),"Tumblr.Prima.PeeprSearch":t("app/context/indash-blog/components/blog-search"),"Tumblr.Prima.MessagingPopover":t("app/components/peepr/components/messaging-popover"),"Tumblr.Prima.currentUser":t("app/lib/currentuser"),"Tumblr.Prima.AdsPaginationHelper":t("app/context/dashboard/components/ads_pagination_helper")}),e.exports=s},{"app/components/blog-card":30,"app/components/confetti/views/confetti-view":43,"app/components/dialog":44,"app/components/flat-select":52,"app/components/gutter-media-manager":72,"app/components/messaging-share-post":80,"app/components/peepr/components/messaging-popover":187,"app/components/tooltip":384,"app/components/upload":389,"app/context/dashboard/components/ads_pagination_helper":407,"app/context/indash-blog/components/blog-search":408,"app/lib/block":430,"app/lib/currentuser":432,"app/lib/scrollbar":433,"app/models/post":435,"app/models/tumblelog":436,"app/vendor/ace":"4e8++S","components/crt/player":446,"components/popover/views/message-controls-popover":475,"components/popover/views/share-popover":476,"components/post-message-channel":477,ligature:620,"prima/events":512,"prima/lib/domeventor":516,"prima/lib/loglady":532,"prima/mixins/generate-logging-data":546,"prima/utils/caniuse":562,"prima/utils/exposer":569,"prima/utils/url":579,when:"RG2dij","when/sequence":630}],429:[function(t,e,i){"use strict";var s=t("lodash"),n=[16,24,30,40,48,64,96,128,512],o=s.last(n),a=128,r=function(t){return t>=o?o:s.find(n,function(e){return e>=t})},l=function(t,e){var i=function(e){return e=null==e?a:r(e),t.replace(/^(.*_)?(\d+)(\D.*)?$/,"$1"+e+"$3")};return i.toString=function(){return this()},null!=e?i(e):i};e.exports=l},{lodash:"MicNly"}],430:[function(t,e,i){"use strict";var s=t("jquery"),n=t("lodash"),o=t("prima/lib/translate"),a=t("prima/lib/data"),r=t("app/components/dialog"),l=t("when"),h={_getCurrentTumblelog:function(){var t="",e=a.get("Context/userinfo");return e&&n.each(e.channels,function(e){e.is_current&&(t=e.name)}),t},block:function(t){t=t||{};var e={};return e.tumblelog=t.currentTumblelog||this._getCurrentTumblelog(),t.blockedTumblelog?e.blocked_tumblelog=t.blockedTumblelog:t.blockedPost&&(e.blocked_post=t.blockedPost),t.context&&(e.block_context=t.context),s.ajax({url:"/svc/block/add",type:"POST",data:e,with_form_key:!0})},unblock:function(t){t=t||{};var e={};return e.tumblelog=t.currentTumblelog||this._getCurrentTumblelog(),e.blocked_tumblelog=t.blockedTumblelog,s.ajax({url:"/svc/block/remove",type:"POST",data:e,with_form_key:!0})},confirmBlock:function(t){t=t||{};var e,i=t.currentTumblelog||this._getCurrentTumblelog(),s=l.defer();if(t.blockedTumblelog)e=o("%1$sAre you sure you want to block %2$s from %3$s?%4$sThey won't be able to follow %3$s, send %3$s messages, see %3$s in search results, or interact with any of %3$s's posts.%5$s","<h3>",t.blockedTumblelog,i,"</h3><small>","</small>");else{if(!t.blockedPost)return s.reject(),s.promise;e=o("%1$sBlock messages from this sender?%2$sAny further messages sent from their IP address will be blocked from your inbox. This can't be undone, by the way.%3$s","<h3>","</h3><small>","</small>")}return r.confirm(e,function(){s.resolve(t.blockedTumblelog?t.blockedTumblelog:t.blockedPost)},function(){s.reject()},o("Block"),o("Nevermind")),s.promise["catch"](n.noop),s.promise}};e.exports=h},{"app/components/dialog":44,jquery:"HlZQrA",lodash:"MicNly","prima/lib/data":514,"prima/lib/translate":541,when:"RG2dij"}],431:[function(t,e,i){"use strict";var s=(window.URL||window.webkitURL||window.mozURL||window.msURL||{}).createObjectURL;e.exports=s},{}],432:[function(t,e,i){"use strict";var s,n=t("app/models/user"),o=t("prima/lib/data"),a=t("prima/events"),r=function(){if(null==s){var t=o.get("Context/userinfo");s=t&&t.name?new n(t):!1,s&&(s.listenTo(a,"post:like:set",s.incrementLikeCount),s.listenTo(a,"post:unlike:set",s.decrementLikeCount),s.listenTo(a,"tumblelog:follow",s.incrementFollowingCount),s.listenTo(a,"tumblelog:unfollow",s.decrementFollowingCount))}return s};e.exports=r},{"app/models/user":437,"prima/events":512,"prima/lib/data":514}],433:[function(t,e,i){"use strict";var s=t("lodash"),n=t("jquery"),o=t("fastdom"),a=t("prima/events"),r=t("prima/view"),l=t("prima/mixins/accessor"),h=t("prima/mixins/selectorcache"),c=r.extend({mixins:[h,l],tplScrollbarWrapper:'<div class="tx-scroll"></div>',tplScrollbarTrackVertical:'<div data-js-track-vertical class="tx-scrollbar-track tx-scrollbar-track--vertical"><div data-js-thumb-vertical class="tx-scrollbar-thumb"></div></div>',tplScrollbarTrackHorizontal:'<div data-js-track-horizontal class="tx-scrollbar-track tx-scrollbar-track--horizontal"><div data-js-thumb-horizontal class="tx-scrollbar-thumb"></div></div>',defaults:{trackActiveClass:"tx-scrollbar-track--active",scrollingClass:"tx-scroll--scrolling",containerClass:"tx-scroll-container",containerClassVertical:"tx-scroll-container--vertical",containerClassHorizontal:"tx-scroll-container--horizontal",infiniteScrollPercent:.9,isScrollable:!1,isScrollableHorizontal:!1,isScrollableVertical:!1,isScrolling:!1,nativeScrollbarSize:20},events:{"mousedown [data-js-thumb-vertical]":"_onVerticalThumbMousedown","mousedown [data-js-thumb-horizontal]":"_onHorizontalThumbMousedown"},destroyed:!1,constructor:function(t){var e=this._getElementFromOptions(t);if(null!==e)return this.container=e,this.$container=n(e),s.extend(t,{el:this._getWrappedElement(e)}),r.prototype.constructor.call(this,t)},initialize:function(t){this.$window=n(window),this._onScrollStopDebounced=s.debounce(s.bind(this._onScrollStop,this),150),this._onResizeDebounced=s.debounce(s.bind(this._onResize,this),150),this.render()},render:function(){return this.rendered&&!this.destroyed?this:(this.listenTo(a,"DOMEventor:flatresize",this._onResizeDebounced),this.listenTo(this,"change:isScrollableVertical",this._onChangeIsScrollableVertical),this.listenTo(this,"change:isScrollableHorizontal",this._onChangeIsScrollableHorizontal),this.listenTo(this,"change:isScrollable",this._onChangeIsScrollable),this.update(),this.destroyed=!1,r.prototype.render.apply(this,arguments))},getVerticalTrack:function(t){var e=this.js$("track-vertical",t);return e.length>0?e:null},getHorizontalTrack:function(t){var e=this.js$("track-horizontal",t);return e.length>0?e:null},getVerticalThumb:function(t){var e=this.js$("thumb-vertical",t);return e.length>0?e:null},getHorizontalThumb:function(t){var e=this.js$("thumb-horizontal",t);return e.length>0?e:null},getScrollContainer:function(){return this.container},isScrollable:function(){return this.get("isScrollable")},isScrollableVertical:function(){return this.get("isScrollableVertical")},isScrollableHorizontal:function(){return this.get("isScrollableHorizontal")},update:function(){var t,e,i;this.destroyed||(t=this._isScrollableVertical(),e=this._isScrollableHorizontal(),i=t||e,this.set({isScrollableVertical:t,isScrollableHorizontal:e,isScrollable:i}),this._updateScrollConstants(),t&&(this._updateVerticalThumbHeight(),this._positionVerticalThumb()),e&&(this._updateHorizontalThumbWidth(),this._positionHorizontalThumb()))},remove:function(){return this.destroy()},destroy:function(){this.$container.off(".txScroll"),this.$window.off(".txScroll"),this.set({isScrollable:!1,isScrollableHorizontal:!1,isScrollableVertical:!1}),this.undelegateEvents(),this.stopListening(),this._unwrapContainer(),this.destroyed=!0},_getElementFromOptions:function(t){var e;return e=t instanceof n?t.get(0):t instanceof window.Element?t:s.get(t,"el",null)},_getWrappedElement:function(t){var e=t instanceof n?t:n(t),i=n(this.tplScrollbarWrapper);return e.wrap(i),i=e.parent(),i.get(0)},_unwrapContainer:function(){this.$container.unwrap()},_appendVerticalTrack:function(){this.$el.append(n(this.tplScrollbarTrackVertical))},_removeVerticalTrack:function(){var t=this.getVerticalTrack(!0);t&&t.remove()},_appendHorizontalTrack:function(){this.$el.append(n(this.tplScrollbarTrackHorizontal))},_removeHorizontalTrack:function(){var t=this.getHorizontalTrack(!0);t&&t.remove()},_onChangeIsScrollable:function(t,e){var i;this.destroyed||(i="ontouchstart"in document.documentElement,i||this.$container.off("wheel.txScroll"),this.$container.off("scroll.txScroll"),this.$container.toggleClass(this.get("containerClass"),e),e&&(this.$container.on("scroll",s.bind(this._onScroll,this)),i||this.$container.on("wheel.txScroll",s.bind(this._stealScroll,this))))},_onChangeIsScrollableVertical:function(t,e){this.destroyed||(this.$container.toggleClass(this.get("containerClassVertical"),e),e?this._appendVerticalTrack():this._removeVerticalTrack(),this.js$.update("track-vertical"),this.js$.update("thumb-vertical"))},_onChangeIsScrollableHorizontal:function(t,e){this.destroyed||(this.$container.toggleClass(this.get("containerClassHorizontal"),e),e?this._appendHorizontalTrack():this._removeHorizontalTrack(),this.js$.update("track-horizontal"),this.js$.update("thumb-horizontal"))},_updateScrollConstants:function(){var t=this.getVerticalTrack(),e=this.getHorizontalTrack(),i=this.getVerticalThumb(),s=this.getHorizontalThumb();this.currentScrollTop=this.$container.scrollTop(),this.currentScrollLeft=this.$container.scrollLeft(),this.get("isScrollableVertical")&&t&&i&&(this.percentageDifferenceVertical=(this.container.scrollHeight-this.$container.height())/(t.height()-i.height())),this.get("isScrollableHorizontal")&&e&&s&&(this.percentageDifferenceHorizontal=(this.container.scrollWidth-this.$container.width())/(e.width()-s.width()))},_onResize:function(){this.update()},_getAddedScrollbarHeight:function(){return this.get("isScrollableHorizontal")?this.get("nativeScrollbarSize"):0},_getAddedScrollbarWidth:function(){return this.get("isScrollableVertical")?this.get("nativeScrollbarSize"):0},_isScrollableVertical:function(){return this.container&&this.container.scrollHeight>this.$container.height()+this._getAddedScrollbarHeight()},_isScrollableHorizontal:function(){return this.container&&this.container.scrollWidth>this.$container.width()+this._getAddedScrollbarWidth()},_getScrollTop:function(t,e){return t.pageY-e.offset().top},_getScrollLeft:function(t,e){return t.pageX-e.offset().left},_onVerticalThumbMousedown:function(t){var e=this.getVerticalTrack();t.preventDefault(),e&&(e.addClass(this.get("trackActiveClass")),this.$window.on("mousemove.txScroll",s.bind(this._onVerticalThumbMousemove,this)),this.$window.on("mouseup.txScroll",s.bind(this._onVerticalThumbMouseup,this)),this.mouseDownOriginalOffsetY=this._getScrollTop(t,e),this._updateScrollConstants())},_onHorizontalThumbMousedown:function(t){var e=this.getHorizontalTrack();t.preventDefault(),e&&(e.addClass(this.get("trackActiveClass")),this.$window.on("mousemove.txScroll",s.bind(this._onHorizontalThumbMousemove,this)),this.$window.on("mouseup.txScroll",s.bind(this._onHorizontalThumbMouseup,this)),this.mouseDownOriginalOffsetX=this._getScrollLeft(t,e),this._updateScrollConstants())},_onVerticalThumbMousemove:function(t){var e,i=this.getVerticalTrack();i&&o.read(function(){this.destroyed||(e=this._getScrollTop(t,i)-this.mouseDownOriginalOffsetY,o.write(function(){this.destroyed||this.$container.scrollTop(this.currentScrollTop+e*this.percentageDifferenceVertical)},this))},this)},_onVerticalThumbMouseup:function(t){var e=this.getVerticalTrack();t.preventDefault(),e&&e.removeClass(this.get("trackActiveClass")),this.$window.off(".txScroll")},_onHorizontalThumbMousemove:function(t){var e,i=this.getHorizontalTrack();i&&o.read(function(){this.destroyed||(e=this._getScrollLeft(t,i)-this.mouseDownOriginalOffsetX,o.write(function(){this.destroyed||this.$container.scrollLeft(this.currentScrollLeft+e*this.percentageDifferenceHorizontal)},this))},this)},_onHorizontalThumbMouseup:function(t){var e=this.getHorizontalTrack();t.preventDefault(),e&&e.removeClass(this.get("trackActiveClass")),this.$window.off(".txScroll")},_updateVerticalThumbHeight:function(){var t,e=this.getVerticalThumb(),i=this.getVerticalTrack();i&&e&&(t=this.$container.height()/this.container.scrollHeight,e.height(i.height()*t))},_updateHorizontalThumbWidth:function(){var t,e=this.getHorizontalThumb(),i=this.getHorizontalTrack();i&&e&&(t=this.$container.width()/this.container.scrollWidth,e.width(i.width()*t))},_positionVerticalThumb:function(){var t,e,i,s=this.getVerticalTrack(),n=this.getVerticalThumb();!this.destroyed&&s&&n&&(i=this.container.scrollTop,t=i/(this.container.scrollHeight-this.$container.height()),e=s.height()-n.height(),o.write(function(){this.destroyed||(n.css("transform","translate3d(0, "+e*t+"px, 0)"),this.trigger("scroll:vertical",i,t),this.trigger("scroll",i,t),t>this.get("infiniteScrollPercent")&&this.trigger("infinitescroll",i,t))},this))},_positionHorizontalThumb:function(){var t,e,i,s=this.getHorizontalTrack(),n=this.getHorizontalThumb();!this.destroyed&&s&&n&&(i=this.container.scrollLeft,t=i/(this.container.scrollWidth-this.$container.width()),e=s.width()-n.width(),o.write(function(){this.destroyed||(n.css("transform","translate3d("+e*t+"px, 0, 0)"),this.trigger("scroll:horizontal",i,t))},this))},_onScroll:function(){this.get("isScrolling")||(this.trigger("scrollstart"),
this.$el.addClass(this.get("scrollingClass"))),this.set("isScrolling",!0),this._onScrollStopDebounced(),this.get("isScrollableVertical")&&o.read(s.bind(this._positionVerticalThumb,this)),this.get("isScrollableHorizontal")&&o.read(s.bind(this._positionHorizontalThumb,this))},_onScrollStop:function(){this.destroyed||(this.trigger("scrollstop"),this.set("isScrolling",!1),this.$el.removeClass(this.get("scrollingClass")))},_stealScroll:function(t){var e=t.currentTarget,i=t.originalEvent.deltaX,s=t.originalEvent.deltaY,o=Math.abs(i)>0,a=Math.abs(s)>0;this.get("isScrollableHorizontal")&&o&&(0>i&&e.scrollLeft<=0&&t.preventDefault(),i>0&&e.scrollLeft>=e.scrollWidth-n(e).width()-this._getAddedScrollbarWidth()&&t.preventDefault()),this.get("isScrollableVertical")&&a&&(0>s&&e.scrollTop<=0&&t.preventDefault(),s>0&&e.scrollTop>=e.scrollHeight-n(e).height()-this._getAddedScrollbarHeight()&&t.preventDefault())}});e.exports=c},{fastdom:609,jquery:"HlZQrA",lodash:"MicNly","prima/events":512,"prima/mixins/accessor":542,"prima/mixins/selectorcache":553,"prima/view":580}],434:[function(t,e,i){"use strict";var s=t("jquery"),n=t("lodash"),o=t("prima/lib/mixin"),a=new o({setUpSelector:function(t){t.on("change",n.bind(this.__select_change,this))},__select_change:function(t){var e=s(t.currentTarget);this.__update_select(e)},__update_select:function(t){var e=t.siblings("label");e.text(t.find(":selected").text())}});e.exports=a},{jquery:"HlZQrA",lodash:"MicNly","prima/lib/mixin":538}],435:[function(t,e,i){"use strict";var s=t("lodash"),n=t("jquery"),o=t("prima/model"),a=t("prima/events"),r=t("app/models/tumblelog"),l=t("app/components/dialog"),h=t("app/components/post-embed-code"),c=t("prima/lib/translate"),u=o.extend({defaults:{},endpoints:{like:"/svc/like",unlike:"/svc/unlike",reblog:"/fast_reblog",reply:"/svc/reply",publish:"/publish",queue:"/publish",destroy:"/svc/post/delete",promote:"/svc/promote",unpromote:"/svc/unpromote",answer:"/answer",deny:"/deny_submission",approve:"/approve_submission",remove_source:"remove_app_attribution"},initialize:function(t){this._createPostTumblelogModel("tumblelog",this.get("tumblelog-data")),this._createPostTumblelogModel("parentTumblelog",this.get("tumblelog-parent-data")),this._createPostTumblelogModel("rootTumblelog",this.get("tumblelog-root-data"))},_createPostTumblelogModel:function(t,e){t=t||"tumblelog",e=e||!1;var i=!1;e&&e.name&&(i=new r(s(e).omit(s.isUndefined).omit(s.isNull).value())),this[t]=i},_setTumblelog:function(){this.tumblelog=new r(s({name:this.get("tumblelog"),ignoring:!1,sponsor:this.get("sponsored"),following:this.get("following"),mention_key:this.get("tumblelog_mention_key")}).omit(s.isUndefined).omit(s.isNull).value())},_setReblogTumblelog:function(){var t=this.get("reblog_source");t&&t.name&&(this.reblogTumblelog=new r(s({name:t.name,ignoring:!1,following:t.following}).omit(s.isUndefined).omit(s.isNull).value()))},_xhrRequest:function(t,e,i){i.init&&i.init();var o=n.ajax({data:e,type:"POST",url:t,with_form_key:!0});return o.done(s.bind(function(t){i[200]&&i[200].call(this,t)},this)),o.fail(s.bind(function(t){i[t.status]&&i[t.status].call(this,t.status)},this)),o.always(s.bind(function(){i.always&&i.always()},this)),o},_xhrSuccess:function(t){this.trigger(t+":success")},_xhrFailure:function(t){l.alert(c("Sorry, we seem to be having technical trouble.  Please try again later.")),this.trigger(t+":failure")},_xhrForbidden:function(t){this.trigger(t+":forbidden")},save:function(t,e,i){if(i||(i={}),this.endpoints[t]){var n={200:s.bind(this._xhrSuccess,this,t),401:s.bind(this._xhrFailure,this,t),404:s.bind(this._xhrFailure,this,t),403:s.bind(this._xhrForbidden,this,t),500:s.bind(this._xhrFailure,this,t)};return this._xhrRequest(this.endpoints[t],e,s.defaults(i,n))}throw new Error("Missing endpoint url for "+t)},like:function(t){if(!this.get("is_mine")){if(this.get("liked")===!1){this.set("liked",!0);var e=this.likePayload(t,this.getLikeSource("like"));this.save("like",{data:e})}this.trigger("like:set",this),a.trigger("post:like:set",this.get("id"),this,t)}},unlike:function(){if(this.get("liked")===!0){this.set("liked",!1);var t=this.likePayload("mouse",this.getLikeSource("unlike"));this.save("unlike",{data:t})}this.trigger("unlike:set",this),a.trigger("post:unlike:set",this.get("id"))},toggleLike:function(){this.get("liked")?this.unlike():this.like()},getLikeSource:function(t){t=t||"like";var e="LIKE_";switch(t){case"unlike":e="UNLIKE_";break;case"reply":e="REPLY_";break;case"ignore":e="IGNORE_"}var i=location.pathname;return i.match(/^\/dashboard/)?e+"SOURCE_DASHBOARD":i.match(/^\/tagged/)?e+"SOURCE_TAG_PAGE":i.match(/^\/likes/)?e+"SOURCE_LIKES_PAGE":i.match(/^\/inbox/)?e+"SOURCE_INBOX":i.match(/^\/search/)?e+"SOURCE_SEARCH_RESULTS_PAGE":i.match(/^\/explore/)?e+"SOURCE_DISCOVER":i.match(/^\/tv/)?e+"SOURCE_TV":i.match(/^\/indash_blog\/peepr/)?e+this.getPeeprSource():e+"SOURCE_UNKNOWN"},getPeeprSource:function(){if(window.parent&&window.parent.location){var t=window.parent.location.pathname;if(t.match(/search/))return"SOURCE_SEARCH_PEEPR"}return"SOURCE_PEEPR"},getEmbedCode:function(t,e){var i={embed_key:this.get("embed_key"),embed_did:this.get("embed_did"),post_id:this.get("id"),post_url:this.get("post_url")};t&&(i.language=t),e&&(i.width=e);var s=new h(i);return s.getCode()},likePayload:function(t,e){return t=t||"mouse",e=e||"LIKE_SOURCE_UNKNOWN",{id:this.get("id"),root_id:this.get("root_id"),key:this.get("reblog_key"),method:t,source:e,placement_id:this.get("placement_id")||!1,is_recommended:this.get("is_recommended")||"",pt:this.get("pt")}},reblog:function(t){t=s.extend({},t,{reblogId:this.get("id"),reblogKey:this.get("reblog_key"),pt:this.get("pt")}),a.trigger("postForms:reblog",t)},fastReblog:function(t){t||(t=!1),this.trigger("fastreblog:success",t),a.trigger("post:fastreblog:set",{model:this});var e={reblog_key:this.get("reblog_key"),reblog_post_id:this.get("id"),queue:t,pt:this.get("pt")},i={200:s.bind(function(t){this.set("reblogged",!0),this.trigger("fastreblog:ajax:success",t.response)},this)};this.save("reblog",e,i)},reply:function(t){var e={reply_text:t,post_id:this.get("id"),tumblelog:this.get("tumblelog"),tumblelog_key:this.get("tumblelog-key")||this.get("tumblelog_key"),source:this.getLikeSource("reply")},i={200:s.bind(function(){this.trigger("replied")},this)};return this.save("reply",{data:e},i)},destroy:function(){var t={post_id:this.get("id"),channel_id:this.get("tumblelog")};this.save("destroy",t)},publish:function(){var t=this.save("publish",{id:this.get("id")});t.fail(s.bind(function(t){this.trigger("publish:failure",n.parseJSON(t.responseText))},this))},promote:function(t){var e={tag:t,post_id:this.get("id"),reblog_key:this.get("reblog_key"),tumblelog_name:this.get("tumblelog")};return this.save("promote",e)},unpromote:function(t){var e={tag_id:t,post_id:this.get("id"),reblog_key:this.get("reblog_key"),tumblelog_name:this.get("tumblelog")};return this.save("unpromote",e)},queue:function(){var t={id:this.get("id"),queue:"queue"};this.save("queue",t)},removeSource:function(){var t={post_id:this.get("id"),tumblelog_id:this.get("tumblelog")};return this.save("remove_source",t)},approve:function(t){var e={id:this.get("id"),queue:t};return this.save("approve",e)},deny:function(){return this.save("deny",{pid:this.get("id")})},answer:function(t){var e={post_id:this.get("id"),tumblelog:this.get("tumblelog"),key:this.get("tumblelog-key"),answer_text:t};return this.save("answer",e)},embedFocus:function(){this.trigger("embed:focus",this)},updateReblogControl:function(t){this.trigger("reblog:success",t)},dismiss:function(){this.trigger("dismiss",this)}});e.exports=u},{"app/components/dialog":44,"app/components/post-embed-code":215,"app/models/tumblelog":436,jquery:"HlZQrA",lodash:"MicNly","prima/events":512,"prima/lib/translate":541,"prima/model":557}],436:[function(t,e,i){"use strict";function s(t,e,i){var s=r.Deferred(),n={data:{tumblelog:t.get("name")}};i.placement_id&&(n.data.placement_id=i.placement_id),i.pt&&(n.data.pt=i.pt),i.source&&(n.data.source=i.source),i.context&&(n.data.context=i.context),i.tlt&&(n.data.tlt=i.tlt);var o=function(){i.wait||t.set({following:e.following},i)},a=function(n,o){i.wait||t.set({following:!e.following},i),s.reject(o)},l=function(){i.wait&&t.set({following:e.following},i),s.resolve()},h=e.following?"/svc/follow":"/svc/unfollow";return r.ajax({beforeSend:o,cache:!i.force,data:n,error:a,type:"POST",success:l,url:h,with_form_key:!0}),s.promise()}function n(t,e){var i=r.Deferred(),s={};l.has(e,"is_tumblelog_popover")&&(s.is_tumblelog_popover=e.is_tumblelog_popover),l.has(e,"is_user_mention")&&(s.is_user_mention=e.is_user_mention);var n=function(t,e){i.reject(e)},o=function(e){l.has(e,"highlighted_posts")||(e={highlighted_posts:e}),t.set(e),i.resolve()};return r.ajax({cache:!e.force,data:s,error:n,type:"GET",success:o,url:p(t),with_form_key:!0}),i.promise()}function o(t,e){return h.promise(function(i,s){var n={tumblelog:t.get("name")};l.has(e,"include_member_data")&&(n.include_member_data=e.include_member_data),l.has(e,"include_activity_data")&&l.has(e,"include_member_data")&&(n.include_activity_data=e.include_activity_data),l.has(e,"include_activity_notifications")&&l.has(e,"include_member_data")&&(n.include_activity_notifications=e.include_activity_notifications);var o=function(t,e){s(e)},a=function(e){t.set(e.response),i()};r.ajax({data:n,type:"GET",error:o,success:a,url:"/svc/data/tumblelog",with_form_key:!0})})}function a(t,e){return r.ajax({cache:!e.force,data:e.data,type:"GET",url:"/svc/tumblelog_popover/"+t,with_form_key:!0})}var r=t("jquery"),l=t("lodash"),h=t("when"),c=t("prima/events"),u=t("app/lib/block"),d=t("prima/singletonmodel"),p=function(){function t(t){return t.has("avatar_url")&&t.has("global_theme_params")}return function(e){return t(e)?"/svc/"+e.get("name")+"/posts/highlighted":"/svc/tumblelog_popover/"+e.get("name")}}(),m=d.extend({save_following:function(t,e){e||(e={}),t||(t={}),t.following=!!t.following;var i=this;return e.force||i.get("following")!==t.following?s(i,t,e).then(l.bindKey(i,"save_following",t)):r.when(i.get("following"))},fetch_popover_data:function(t){t||(t={}),t.is_user_mention=!!t.is_user_mention,t.is_tumblelog_popover=!!t.is_tumblelog_popover;var e=this;return!t.force&&e.has("highlighted_posts")?r.when(e.get("highlighted_posts")):n(e,t).then(l.bindKey(e,"fetch_popover_data",void 0))},fetch_analytics_data:function(){return o(this,{include_member_data:!0,include_activity_data:!0})},fetch_activity_notifications:function(){return o(this,{include_member_data:!0,include_activity_data:!0,include_activity_notifications:!0})},toggle_spam:function(){return r.ajax({url:"/spam/toggle",type:"POST",data:{tumblelog:this.id},with_form_key:!0})},toggle_nsfw:function(){return r.ajax({url:"/nsfw/toggle",type:"POST",data:{tumblelog:this.id},with_form_key:!0})},toggle_adult:function(){return r.ajax({url:"/adult/toggle",type:"POST",data:{tumblelog:this.id},with_form_key:!0})},toggle_uniblock:function(){return r.ajax({url:"/uniblock/toggle",type:"POST",data:{tumblelog:this.id},with_form_key:!0})},toggle_suspended:function(){return r.ajax({url:"/suspended/toggle",type:"POST",data:{tumblelog:this.id},with_form_key:!0})},follow:function(t){this.save_following({following:!0},t)},_unfollow:function(t){this.save_following({following:!1},t)},requestUnfollow:function(t){var e=h.defer();return e.promise.then(l.bind(this._unfollow,this,t))["catch"](l.noop),e},block:function(){return u.block({blockedTumblelog:this.id})},unblock:function(){return u.unblock({blockedTumblelog:this.id})},defaults:null,idAttribute:"name",initialize:function(){this.bindEvents()},bindEvents:function(){var t=this.get("name");this.on("change:following",function(){if(void 0!==this.previous("following")){var e=this.get("following")?"tumblelog:follow":"tumblelog:unfollow";c.trigger(e,{name:t,loggingData:t})}},this),this.on("change:twitter_send_posts",this._updateUserSocial),this.on("change:facebook_opengraph_send_posts",this._updateUserSocial)},_updateUserSocial:function(){var t={tumblelog_name_or_id:this.get("name"),page:"tumblelog","tumblelog[facebook_opengraph_send_posts]":this.get("facebook_opengraph_send_posts")?"on":"off","tumblelog[twitter_send_posts]":this.get("twitter_send_posts")?"on":"off"};r.ajax({data:t,type:"POST",url:"/settings/save",with_form_key:!0})},getDisplayName:function(){return this.get("is_legacy_private_channel")?this.get("directory_safe_title"):this.get("name")},parse:function(t){return t},validate:function(){return!1},destroy:function(){return this},fetch:function(){return this},save:function(){return this},url:function(){},urlRoot:function(){}},{collection:null,modelFromToken:function(t){var e,i=m.getCollection(),s=r.Deferred(),n=i.findWhere({token:t});return n?s.resolve(n):(e={data:{is_user_mention:!0}},a(t,e).then(function(e){var i=new m(e);i.set({token:t}),s.resolve(i)},function(){s.reject()})),s.promise()}});m.collection=m.getCollection(),e.exports=m},{"app/lib/block":430,jquery:"HlZQrA",lodash:"MicNly","prima/events":512,"prima/singletonmodel":559,when:"RG2dij"}],437:[function(t,e,i){"use strict";var s=t("prima/singletonmodel"),n=t("prima/model"),o=t("../collections/tumblelogs"),a=s.extend({idAttribute:"name",initialize:function(t){this.channels=new o(t.channels)},incrementLikeCount:function(){var t=this.get("liked_post_count");this.set("liked_post_count",t+1)},decrementLikeCount:function(){var t=this.get("liked_post_count");t>0&&this.set("liked_post_count",t-1)},incrementFollowingCount:function(){var t=this.get("friend_count");this.set("friend_count",t+1)},decrementFollowingCount:function(){var t=this.get("friend_count");t>0&&this.set("friend_count",t-1)},getUnreadCount:function(){return this.channels.reduce(function(t,e){return parseInt(t,10)+parseInt(e.get("unread_count"),10)},0)},getChannel:function(t){return null==t&&(t=this.get("primary")),this.channels.findWhere({name:t})},canMessage:function(){return this.get("can_message")},getChannelsEnabledForMessaging:function(){return this.channels.where({can_send_messages:!0})},toJSON:function(){var t=n.prototype.toJSON.apply(this,arguments);return t.channels=this.channels.toJSON(),t},getChannelProperty:function(t,e){var i=this.getChannel(t);if(!(i&&"get"in i))return null;var s=i.get(e);return"undefined"==typeof s?null:s}});e.exports=a},{"../collections/tumblelogs":2,"prima/model":557,"prima/singletonmodel":559}],438:[function(t,e,i){"use strict";var s=t("lodash"),n=t("sprintf-js").sprintf,o=t("backbone"),a=t("prima/router"),r=t("prima/lib/data"),l=t("prima/lib/flags"),h=t("app/lib/currentuser"),c=t("moment"),u=t("./bootloader"),d=t("app/components/header"),p=t("app/components/footer"),m=t("app/components/peepr"),g=t("app/components/ask-form"),f=t("standalone/mobile/components/mobile-header"),_=a.extend({logs:function(){var e=[t("logs/instruments/embed"),t("logs/instruments/help-form"),t("logs/instruments/keycommands"),t("logs/instruments/login-register"),t("logs/instruments/video-player"),t("logs/instruments/vendor-button"),t("logs/instruments/dashboard-sharing"),t("logs/instruments/related-recommendations"),t("logs/instruments/explore-trending"),t("logs/instruments/roadblock"),t("logs/instruments/linkpost-interactions"),t("logs/instruments/peepr"),t("logs/instruments/abuse-form"),t("logs/instruments/recommended-blogs"),t("logs/instruments/tour-guide-account"),t("logs/instruments/blocks"),t("logs/instruments/postform-interactions"),t("logs/instruments/header-search"),t("logs/instruments/postform-gifsearch"),t("logs/instruments/little-sister"),t("logs/instruments/messaging-interactions"),t("logs/instruments/onboarding-verified-blogs"),t("logs/instruments/reactivation"),t("logs/instruments/external-inline-images"),t("logs/instruments/activity-links"),t("logs/instruments/notes-interactions")];return s.union(e,a.prototype.logs.apply(this))},constructor:function(){a.apply(this,arguments),this.startHistory(),this.initializeApp()},getName:function(){return this.name=r.get("Context/name"),n("Context/%s",this.name)},initializeApp:function(){l.bool("is_mobile_handset")&&l.bool("responsive_help_docs")?new f:new d,new p,l.bool("indash_blogs")&&(this.peepr=new m),l.bool("ask_form")&&(this.askForm=new g({user:h()})),c.locale(r.get("Context.language"))},startHistory:function(t){o.History.started||s.isEmpty(this.routes)||(this.routeFound=o.history.start({pushState:"pushState"in window.history,hashChange:t?!("pushState"in window.history):!1,root:this.root}))}},{Bootloader:u});e.exports=_},{"./bootloader":1,"app/components/ask-form":25,"app/components/footer":54,"app/components/header":73,"app/components/peepr":194,"app/lib/currentuser":432,backbone:"5kFNoY",lodash:"MicNly","logs/instruments/abuse-form":480,"logs/instruments/activity-links":481,"logs/instruments/blocks":483,"logs/instruments/dashboard-sharing":484,"logs/instruments/embed":485,"logs/instruments/explore-trending":486,"logs/instruments/external-inline-images":487,"logs/instruments/header-search":488,"logs/instruments/help-form":489,"logs/instruments/keycommands":490,"logs/instruments/linkpost-interactions":491,"logs/instruments/little-sister":492,"logs/instruments/login-register":493,"logs/instruments/messaging-interactions":494,"logs/instruments/notes-interactions":495,"logs/instruments/onboarding-verified-blogs":496,"logs/instruments/peepr":497,"logs/instruments/postform-gifsearch":498,"logs/instruments/postform-interactions":499,"logs/instruments/reactivation":500,"logs/instruments/recommended-blogs":501,"logs/instruments/related-recommendations":502,"logs/instruments/roadblock":503,"logs/instruments/tour-guide-account":504,"logs/instruments/vendor-button":505,"logs/instruments/video-player":506,moment:"iROhDJ","prima/lib/data":514,"prima/lib/flags":"f/LVtH","prima/router":558,"sprintf-js":"qPOUxN","standalone/mobile/components/mobile-header":582}],439:[function(t,e,i){"use strict";var s=t("gif.js/dist/gif").GIF,n=t("./inline-worker"),o=function(t){var e=n;return t||(t={}),t.workerScript||(t.workerScript=e),new s(t)};e.exports=o},{"./inline-worker":440,"gif.js/dist/gif":610}],440:[function(t,e,i){var s=(window.URL||window.webkitURL||window.mozURL||window.msURL||{}).createObjectURL;s&&(e.exports=s(new Blob(["(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require==\"function\"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);throw new Error(\"Cannot find module '\"+o+\"'\")}var f=n[o]={exports:{}};t[o][0].call(f.exports,function(e){var n=t[o][1][e];return s(n?n:e)},f,f.exports,e,t,n,r)}return n[o].exports}var i=typeof require==\"function\"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({1:[function(require,module,exports){\n(function(b){function a(b,d){if({}.hasOwnProperty.call(a.cache,b))return a.cache[b];var e=a.resolve(b);if(!e)throw new Error('Failed to resolve module '+b);var c={id:b,require:a,filename:b,exports:{},loaded:!1,parent:d,children:[]};d&&d.children.push(c);var f=b.slice(0,b.lastIndexOf('/')+1);return a.cache[b]=c.exports,e.call(c.exports,c,c.exports,f,b),c.loaded=!0,a.cache[b]=c.exports}a.modules={},a.cache={},a.resolve=function(b){return{}.hasOwnProperty.call(a.modules,b)?a.modules[b]:void 0},a.define=function(b,c){a.modules[b]=c},a.define('/gif.worker.coffee',function(d,e,f,g){var b,c;b=a('/GIFEncoder.js',d),c=function(a){var c,e,d,f;return c=new b(a.width,a.height),a.index===0?c.writeHeader():c.firstFrame=!1,c.setTransparent(a.transparent),c.setRepeat(a.repeat),c.setDelay(a.delay),c.setQuality(a.quality),c.addFrame(a.data),a.last&&c.finish(),d=c.stream(),a.data=d.pages,a.cursor=d.cursor,a.pageSize=d.constructor.pageSize,a.canTransfer?(f=function(c){for(var b=0,d=a.data.length;b<d;++b)e=a.data[b],c.push(e.buffer);return c}.call(this,[]),self.postMessage(a,f)):self.postMessage(a)},self.onmessage=function(a){return c(a.data)}}),a.define('/GIFEncoder.js',function(e,h,i,j){function c(){this.page=-1,this.pages=[],this.newPage()}function b(a,b){this.width=~~a,this.height=~~b,this.transparent=null,this.transIndex=0,this.repeat=-1,this.delay=0,this.image=null,this.pixels=null,this.indexedPixels=null,this.colorDepth=null,this.colorTab=null,this.usedEntry=new Array,this.palSize=7,this.dispose=-1,this.firstFrame=!0,this.sample=10,this.out=new c}var f=a('/TypedNeuQuant.js',e),g=a('/LZWEncoder.js',e);c.pageSize=4096,c.charMap={};for(var d=0;d<256;d++)c.charMap[d]=String.fromCharCode(d);c.prototype.newPage=function(){this.pages[++this.page]=new Uint8Array(c.pageSize),this.cursor=0},c.prototype.getData=function(){var d='';for(var a=0;a<this.pages.length;a++)for(var b=0;b<c.pageSize;b++)d+=c.charMap[this.pages[a][b]];return d},c.prototype.writeByte=function(a){this.cursor>=c.pageSize&&this.newPage(),this.pages[this.page][this.cursor++]=a},c.prototype.writeUTFBytes=function(b){for(var c=b.length,a=0;a<c;a++)this.writeByte(b.charCodeAt(a))},c.prototype.writeBytes=function(b,d,e){for(var c=e||b.length,a=d||0;a<c;a++)this.writeByte(b[a])},b.prototype.setDelay=function(a){this.delay=Math.round(a/10)},b.prototype.setFrameRate=function(a){this.delay=Math.round(100/a)},b.prototype.setDispose=function(a){a>=0&&(this.dispose=a)},b.prototype.setRepeat=function(a){this.repeat=a},b.prototype.setTransparent=function(a){this.transparent=a},b.prototype.addFrame=function(a){this.image=a,this.getImagePixels(),this.analyzePixels(),this.firstFrame&&(this.writeLSD(),this.writePalette(),this.repeat>=0&&this.writeNetscapeExt()),this.writeGraphicCtrlExt(),this.writeImageDesc(),this.firstFrame||this.writePalette(),this.writePixels(),this.firstFrame=!1},b.prototype.finish=function(){this.out.writeByte(59)},b.prototype.setQuality=function(a){a<1&&(a=1),this.sample=a},b.prototype.writeHeader=function(){this.out.writeUTFBytes('GIF89a')},b.prototype.analyzePixels=function(){var g=this.pixels.length,d=g/3;this.indexedPixels=new Uint8Array(d);var a=new f(this.pixels,this.sample);a.buildColormap(),this.colorTab=a.getColormap();var b=0;for(var c=0;c<d;c++){var e=a.lookupRGB(this.pixels[b++]&255,this.pixels[b++]&255,this.pixels[b++]&255);this.usedEntry[e]=!0,this.indexedPixels[c]=e}this.pixels=null,this.colorDepth=8,this.palSize=7,this.transparent!==null&&(this.transIndex=this.findClosest(this.transparent))},b.prototype.findClosest=function(e){if(this.colorTab===null)return-1;var k=(e&16711680)>>16,l=(e&65280)>>8,m=e&255,c=0,d=16777216,j=this.colorTab.length;for(var a=0;a<j;){var f=k-(this.colorTab[a++]&255),g=l-(this.colorTab[a++]&255),h=m-(this.colorTab[a]&255),i=f*f+g*g+h*h,b=parseInt(a/3);this.usedEntry[b]&&i<d&&(d=i,c=b),a++}return c},b.prototype.getImagePixels=function(){var a=this.width,g=this.height;this.pixels=new Uint8Array(a*g*3);var b=this.image,c=0;for(var d=0;d<g;d++)for(var e=0;e<a;e++){var f=d*a*4+e*4;this.pixels[c++]=b[f],this.pixels[c++]=b[f+1],this.pixels[c++]=b[f+2]}},b.prototype.writeGraphicCtrlExt=function(){this.out.writeByte(33),this.out.writeByte(249),this.out.writeByte(4);var b,a;this.transparent===null?(b=0,a=0):(b=1,a=2),this.dispose>=0&&(a=dispose&7),a<<=2,this.out.writeByte(0|a|0|b),this.writeShort(this.delay),this.out.writeByte(this.transIndex),this.out.writeByte(0)},b.prototype.writeImageDesc=function(){this.out.writeByte(44),this.writeShort(0),this.writeShort(0),this.writeShort(this.width),this.writeShort(this.height),this.firstFrame?this.out.writeByte(0):this.out.writeByte(128|this.palSize)},b.prototype.writeLSD=function(){this.writeShort(this.width),this.writeShort(this.height),this.out.writeByte(240|this.palSize),this.out.writeByte(0),this.out.writeByte(0)},b.prototype.writeNetscapeExt=function(){this.out.writeByte(33),this.out.writeByte(255),this.out.writeByte(11),this.out.writeUTFBytes('NETSCAPE2.0'),this.out.writeByte(3),this.out.writeByte(1),this.writeShort(this.repeat),this.out.writeByte(0)},b.prototype.writePalette=function(){this.out.writeBytes(this.colorTab);var b=768-this.colorTab.length;for(var a=0;a<b;a++)this.out.writeByte(0)},b.prototype.writeShort=function(a){this.out.writeByte(a&255),this.out.writeByte(a>>8&255)},b.prototype.writePixels=function(){var a=new g(this.width,this.height,this.indexedPixels,this.colorDepth);a.encode(this.out)},b.prototype.stream=function(){return this.out},e.exports=b}),a.define('/LZWEncoder.js',function(e,g,h,i){function f(y,D,C,B){function w(a,b){r[f++]=a,f>=254&&t(b)}function x(b){u(a),k=i+2,j=!0,l(i,b)}function u(b){for(var a=0;a<b;++a)h[a]=-1}function A(z,r){var g,t,d,e,y,w,s;for(q=z,j=!1,n_bits=q,m=p(n_bits),i=1<<z-1,o=i+1,k=i+2,f=0,e=v(),s=0,g=a;g<65536;g*=2)++s;s=8-s,w=a,u(w),l(i,r);a:while((t=v())!=c){if(g=(t<<b)+e,d=t<<s^e,h[d]===g){e=n[d];continue}if(h[d]>=0){y=w-d,d===0&&(y=1);do if((d-=y)<0&&(d+=w),h[d]===g){e=n[d];continue a}while(h[d]>=0)}l(e,r),e=t,k<1<<b?(n[d]=k++,h[d]=g):x(r)}l(e,r),l(o,r)}function z(a){a.writeByte(s),remaining=y*D,curPixel=0,A(s+1,a),a.writeByte(0)}function t(a){f>0&&(a.writeByte(f),a.writeBytes(r,0,f),f=0)}function p(a){return(1<<a)-1}function v(){if(remaining===0)return c;--remaining;var a=C[curPixel++];return a&255}function l(a,c){g&=d[e],e>0?g|=a<<e:g=a,e+=n_bits;while(e>=8)w(g&255,c),g>>=8,e-=8;if((k>m||j)&&(j?(m=p(n_bits=q),j=!1):(++n_bits,n_bits==b?m=1<<b:m=p(n_bits))),a==o){while(e>0)w(g&255,c),g>>=8,e-=8;t(c)}}var s=Math.max(2,B),r=new Uint8Array(256),h=new Int32Array(a),n=new Int32Array(a),g,e=0,f,k=0,m,j=!1,q,i,o;this.encode=z}var c=-1,b=12,a=5003,d=[0,1,3,7,15,31,63,127,255,511,1023,2047,4095,8191,16383,32767,65535];e.exports=f}),a.define('/TypedNeuQuant.js',function(A,F,E,D){function C(A,B){function I(){o=[],q=new Int32Array(256),t=new Int32Array(a),y=new Int32Array(a),z=new Int32Array(a>>3);var c,d;for(c=0;c<a;c++)d=(c<<b+8)/a,o[c]=new Float64Array([d,d,d,0]),y[c]=e/a,t[c]=0}function J(){for(var c=0;c<a;c++)o[c][0]>>=b,o[c][1]>>=b,o[c][2]>>=b,o[c][3]=c}function K(b,a,c,e,f){o[a][0]-=b*(o[a][0]-c)/d,o[a][1]-=b*(o[a][1]-e)/d,o[a][2]-=b*(o[a][2]-f)/d}function L(j,e,n,l,k){var h=Math.abs(e-j),i=Math.min(e+j,a),g=e+1,f=e-1,m=1,b,d;while(g<i||f>h)d=z[m++],g<i&&(b=o[g++],b[0]-=d*(b[0]-n)/c,b[1]-=d*(b[1]-l)/c,b[2]-=d*(b[2]-k)/c),f>h&&(b=o[f--],b[0]-=d*(b[0]-n)/c,b[1]-=d*(b[1]-l)/c,b[2]-=d*(b[2]-k)/c)}function C(p,s,q){var h=2147483647,k=h,d=-1,m=d,c,j,e,n,l;for(c=0;c<a;c++)j=o[c],e=Math.abs(j[0]-p)+Math.abs(j[1]-s)+Math.abs(j[2]-q),e<h&&(h=e,d=c),n=e-(t[c]>>i-b),n<k&&(k=n,m=c),l=y[c]>>g,y[c]-=l,t[c]+=l<<f;return y[d]+=x,t[d]-=r,m}function D(){var d,b,e,c,h,g,f=0,i=0;for(d=0;d<a;d++){for(e=o[d],h=d,g=e[1],b=d+1;b<a;b++)c=o[b],c[1]<g&&(h=b,g=c[1]);if(c=o[h],d!=h&&(b=c[0],c[0]=e[0],e[0]=b,b=c[1],c[1]=e[1],e[1]=b,b=c[2],c[2]=e[2],e[2]=b,b=c[3],c[3]=e[3],e[3]=b),g!=f){for(q[f]=i+d>>1,b=f+1;b<g;b++)q[b]=d;f=g,i=d}}for(q[f]=i+n>>1,b=f+1;b<256;b++)q[b]=n}function E(j,i,k){var b,d,c,e=1e3,h=-1,f=q[i],g=f-1;while(f<a||g>=0)f<a&&(d=o[f],c=d[1]-i,c>=e?f=a:(f++,c<0&&(c=-c),b=d[0]-j,b<0&&(b=-b),c+=b,c<e&&(b=d[2]-k,b<0&&(b=-b),c+=b,c<e&&(e=c,h=d[3])))),g>=0&&(d=o[g],c=i-d[1],c>=e?g=-1:(g--,c<0&&(c=-c),b=d[0]-j,b<0&&(b=-b),c+=b,c<e&&(b=d[2]-k,b<0&&(b=-b),c+=b,c<e&&(e=c,h=d[3]))));return h}function F(){var c,f=A.length,D=30+(B-1)/3,y=f/(3*B),q=~~(y/w),n=d,o=u,a=o>>h;for(a<=1&&(a=0),c=0;c<a;c++)z[c]=n*((a*a-c*c)*m/(a*a));var i;f<s?(B=1,i=3):f%l!==0?i=3*l:f%k!==0?i=3*k:f%p!==0?i=3*p:i=3*j;var r,t,x,e,g=0;c=0;while(c<y)if(r=(A[g]&255)<<b,t=(A[g+1]&255)<<b,x=(A[g+2]&255)<<b,e=C(r,t,x),K(n,e,r,t,x),a!==0&&L(a,e,r,t,x),g+=i,g>=f&&(g-=f),c++,q===0&&(q=1),c%q===0)for(n-=n/D,o-=o/v,a=o>>h,a<=1&&(a=0),e=0;e<a;e++)z[e]=n*((a*a-e*e)*m/(a*a))}function G(){I(),F(),J(),D()}function H(){var b=[],g=[];for(var c=0;c<a;c++)g[o[c][3]]=c;var d=0;for(var e=0;e<a;e++){var f=g[e];b[d++]=o[f][0],b[d++]=o[f][1],b[d++]=o[f][2]}return b}var o,q,t,y,z;this.buildColormap=G,this.getColormap=H,this.lookupRGB=E}var w=100,a=256,n=a-1,b=4,i=16,e=1<<i,f=10,B=1<<f,g=10,x=e>>g,r=e<<f-g,z=a>>3,h=6,t=1<<h,u=z*t,v=30,o=10,d=1<<o,q=8,m=1<<q,y=o+q,c=1<<y,l=499,k=491,p=487,j=503,s=3*j;A.exports=C}),a('/gif.worker.coffee')}.call(this,this))\n//# sourceMappingURL=gif.worker.js.map\n// gif.worker.js 0.1.6 - https://github.com/jnordberg/gif.js\n\n},{}]},{},[1])"],{type:"text/javascript"})))},{}],441:[function(t,e,i){"use strict";var s=function(){},n=e.exports={};n.stringIsClean=function(t){for(var e=0;e<t.length;e++)if(t.charCodeAt(e)<32)return!1;return!0},n.parseNum=function(t,e,i,s){var n,o,a=">"===t;for(void 0===i&&(i=0),void 0===s&&(s=e.length-i),n=a?i:i+s-1;a?i+s>n:n>=i;a?n++:n--)o<<=8,o+=e.charCodeAt(n);return o},n.parseSnum=function(t,e,i,s){var n,o,a,r=">"===t;for(void 0===i&&(i=0),void 0===s&&(s=e.length-i),n=r?i:i+s-1;r?i+s>n:n>=i;r?n++:n--)void 0===a&&(a=128===(128&e.charCodeAt(n))),o<<=8,o+=a?255&~e.charCodeAt(n):e.charCodeAt(n);return a&&(o+=1,o*=-1),o},n.Rational=function(t,e){return this.num=t,this.den=e||1,this},n.Rational.prototype.toString=function(){return 0===this.num?""+this.num:1===this.den?""+this.num:1===this.num?this.num+" / "+this.den:this.num/this.den},n.Rational.prototype.asFloat=function(){return this.num/this.den},n.MetaGroup=function(t,e){return this.fieldName=t,this.description=e,this.metaProps={},this},n.MetaGroup.prototype._addProperty=function(t,e,i){var s=new n.MetaProp(t,e,i);this[s.fieldName]=s,this.metaProps[s.fieldName]=s},n.MetaGroup.prototype.toString=function(){return"[MetaGroup "+this.description+"]"},n.MetaProp=function(t,e,i){return this.fieldName=t,this.description=e,this.value=i,this},n.MetaProp.prototype.toString=function(){return""+this.value},n.JpegFile=function(t,e){var i=this._SOS;this.metaGroups={},this._binary_data=t,this.filename=e;var s,o,a,r,l,h,c,u=0,d=0;if(this._binary_data.slice(0,2)!==this._SOI_MARKER)throw new Error("Doesn't look like a JPEG file. First two bytes are "+this._binary_data.charCodeAt(0)+","+this._binary_data.charCodeAt(1)+".");for(u+=2;u<this._binary_data.length&&(s=this._binary_data.charCodeAt(u++),o=this._binary_data.charCodeAt(u++),d=u,s==this._DELIM)&&o!==i;){for(l=n.parseNum(">",this._binary_data,u,2),u+=l;u<this._binary_data.length;)if(s=this._binary_data.charCodeAt(u++),s==this._DELIM&&(a=this._binary_data.charCodeAt(u++),0!==a)){u-=2;break}r=u-d,this._markers[o]?(h=this._markers[o][0],c=this._markers[o][1]):(h="UNKN",c=void 0),c&&this[c](o,d+2)}if(void 0===this.general)throw Error("Invalid JPEG file.");return this},n.JpegFile.prototype.toString=function(){return"[JpegFile "+this.filename+" "+this.general.type+" "+this.general.pixelWidth+"x"+this.general.pixelHeight+" Depth: "+this.general.depth+"]"},n.JpegFile.prototype._SOI_MARKER="ÿØ",n.JpegFile.prototype._DELIM=255,n.JpegFile.prototype._EOI=217,n.JpegFile.prototype._SOS=218,n.JpegFile.prototype._sofHandler=function(t,e){if(void 0!==this.general)throw Error("Unexpected multiple-frame image");this._addMetaGroup("general","General"),this.general._addProperty("depth","Depth",n.parseNum(">",this._binary_data,e,1)),this.general._addProperty("pixelHeight","Pixel Height",n.parseNum(">",this._binary_data,e+1,2)),this.general._addProperty("pixelWidth","Pixel Width",n.parseNum(">",this._binary_data,e+3,2)),this.general._addProperty("type","Type",this._markers[t][2])},n.JpegFile.prototype._JFIF_IDENT="JFIF\x00",n.JpegFile.prototype._JFXX_IDENT="JFXX\x00",n.JpegFile.prototype._EXIF_IDENT="Exif\x00",n.JpegFile.prototype._types={1:["BYTE",1],2:["ASCII",1],3:["SHORT",2],4:["LONG",4],5:["RATIONAL",8],6:["SBYTE",1],7:["UNDEFINED",1],8:["SSHORT",2],9:["SLONG",4],10:["SRATIONAL",8],11:["FLOAT",4],12:["DOUBLE",8]},n.JpegFile.prototype._tifftags={256:["Image width","ImageWidth"],257:["Image height","ImageLength"],258:["Number of bits per component","BitsPerSample"],259:["Compression scheme","Compression",{1:"uncompressed",6:"JPEG compression"}],262:["Pixel composition","PhotmetricInerpretation",{2:"RGB",6:"YCbCr"}],274:["Orientation of image","Orientation",{1:"Normal",2:"Reverse?",3:"Upside-down",4:"Upside-down Reverse",5:"90 degree CW",6:"90 degree CW reverse",7:"90 degree CCW",8:"90 degree CCW reverse"}],277:["Number of components","SamplesPerPixel"],284:["Image data arrangement","PlanarConfiguration",{1:"chunky format",2:"planar format"
}],530:["Subsampling ratio of Y to C","YCbCrSubSampling"],531:["Y and C positioning","YCbCrPositioning",{1:"centered",2:"co-sited"}],282:["X Resolution","XResolution"],283:["Y Resolution","YResolution"],296:["Resolution Unit","ResolutionUnit",{2:"inches",3:"centimeters"}],273:["Image data location","StripOffsets"],278:["Number of rows per strip","RowsPerStrip"],279:["Bytes per compressed strip","StripByteCounts"],513:["Offset to JPEG SOI","JPEGInterchangeFormat"],514:["Bytes of JPEG Data","JPEGInterchangeFormatLength"],301:["Transfer function","TransferFunction"],318:["White point chromaticity","WhitePoint"],319:["Chromaticities of primaries","PrimaryChromaticities"],529:["Color space transformation matrix coefficients","YCbCrCoefficients"],532:["Pair of black and white reference values","ReferenceBlackWhite"],306:["Date and time","DateTime"],270:["Image title","ImageDescription"],271:["Make","Make"],272:["Model","Model"],305:["Software","Software"],315:["Person who created the image","Artist"],316:["Host Computer","HostComputer"],33432:["Copyright holder","Copyright"],34665:["Exif tag","ExifIfdPointer"],34853:["GPS tag","GPSInfoIfdPointer"]},n.JpegFile.prototype._exiftags={36864:["Exif Version","ExifVersion"],40960:["FlashPix Version","FlashpixVersion"],40961:["Color Space","ColorSpace"],37121:["Meaning of each component","ComponentsConfiguration"],37122:["Compressed Bits Per Pixel","CompressedBitsPerPixel"],40962:["Pixel X Dimension","PixelXDimension"],40963:["Pixel Y Dimension","PixelYDimension"],37500:["Manufacturer notes","MakerNote"],37510:["User comments","UserComment"],40964:["Related audio file","RelatedSoundFile"],36867:["Date Time Original","DateTimeOriginal"],36868:["Date Time Digitized","DateTimeDigitized"],37520:["DateTime subseconds","SubSecTime"],37521:["DateTimeOriginal subseconds","SubSecTimeOriginal"],37522:["DateTimeDigitized subseconds","SubSecTimeDigitized"],33434:["Exposure time","ExposureTime"],33437:["FNumber","FNumber"],34850:["Exposure program","ExposureProgram"],34852:["Spectral sensitivity","SpectralSensitivity"],34855:["ISO Speed Ratings","ISOSpeedRatings"],34856:["Optoelectric coefficient","OECF"],37377:["Shutter Speed","ShutterSpeedValue"],37378:["Aperture Value","ApertureValue"],37379:["Brightness","BrightnessValue"],37380:["Exposure Bias Value","ExposureBiasValue"],37381:["Max Aperture Value","MaxApertureValue"],37382:["Subject Distance","SubjectDistance"],37383:["Metering Mode","MeteringMode"],37384:["Light Source","LightSource"],37385:["Flash","Flash"],37386:["Focal Length","FocalLength"],37396:["Subject Area","SubjectArea"],41483:["Flash Energy","FlashEnergy"],41484:["Spatial Frequency Response","SpatialFrequencyResponse"],41486:["Focal Plane X Resolution","FocalPlaneXResolution"],41487:["Focal Plane Y Resolution","FocalPlaneYResolution"],41488:["Focal Plane Resolution Unit","FocalPlaneResolutionUnit"],41492:["Subject Location","SubjectLocation"],41493:["Exposure Index","ExposureIndex"],41495:["Sensing Method","SensingMethod"],41728:["File Source","FileSource"],41729:["Scene Type","SceneType"],41730:["CFA Pattern","CFAPattern"],41985:["Custom Rendered","CustomRendered"],41986:["Exposure Mode","Exposure Mode"],41987:["White Balance","WhiteBalance"],41988:["Digital Zoom Ratio","DigitalZoomRatio"],41989:["Focal length in 35 mm film","FocalLengthIn35mmFilm"],41990:["Scene Capture Type","SceneCaptureType"],41991:["Gain Control","GainControl"],41992:["Contrast","Contrast"],41993:["Saturation","Saturation"],41994:["Sharpness","Sharpness"],41995:["Device settings description","DeviceSettingDescription"],41996:["Subject distance range","SubjectDistanceRange"],42016:["Unique image ID","ImageUniqueID"],40965:["Interoperability tag","InteroperabilityIFDPointer"]},n.JpegFile.prototype._gpstags={0:["GPS tag version","GPSVersionID"],1:["North or South Latitude","GPSLatitudeRef"],2:["Latitude","GPSLatitude"],3:["East or West Longitude","GPSLongitudeRef"],4:["Longitude","GPSLongitude"],5:["Altitude reference","GPSAltitudeRef"],6:["Altitude","GPSAltitude"],7:["GPS time (atomic clock)","GPSTimeStamp"],8:["GPS satellites usedd for measurement","GPSSatellites"],9:["GPS receiver status","GPSStatus"],10:["GPS mesaurement mode","GPSMeasureMode"],11:["Measurement precision","GPSDOP"],12:["Speed unit","GPSSpeedRef"],13:["Speed of GPS receiver","GPSSpeed"],14:["Reference for direction of movement","GPSTrackRef"],15:["Direction of movement","GPSTrack"],16:["Reference for direction of image","GPSImgDirectionRef"],17:["Direction of image","GPSImgDirection"],18:["Geodetic survey data used","GPSMapDatum"],19:["Reference for latitude of destination","GPSDestLatitudeRef"],20:["Latitude of destination","GPSDestLatitude"],21:["Reference for longitude of destination","GPSDestLongitudeRef"],22:["Longitude of destination","GPSDestLongitude"],23:["Reference for bearing of destination","GPSDestBearingRef"],24:["Bearing of destination","GPSDestBearing"],25:["Reference for distance to destination","GPSDestDistanceRef"],26:["Distance to destination","GPSDestDistance"],27:["Name of GPS processing method","GPSProcessingMethod"],28:["Name of GPS area","GPSAreaInformation"],29:["GPS Date","GPSDateStamp"],30:["GPS differential correction","GPSDifferential"]},n.JpegFile.prototype._markers={192:["SOF0","_sofHandler","Baseline DCT"],193:["SOF1","_sofHandler","Extended sequential DCT"],194:["SOF2","_sofHandler","Progressive DCT"],195:["SOF3","_sofHandler","Lossless (sequential)"],197:["SOF5","_sofHandler","Differential sequential DCT"],198:["SOF6","_sofHandler","Differential progressive DCT"],199:["SOF7","_sofHandler","Differential lossless (sequential)"],200:["JPG",null,"Reserved for JPEG extensions"],201:["SOF9","_sofHandler","Extended sequential DCT"],202:["SOF10","_sofHandler","Progressive DCT"],203:["SOF11","_sofHandler","Lossless (sequential)"],205:["SOF13","_sofHandler","Differential sequential DCT"],206:["SOF14","_sofHandler","Differential progressive DCT"],207:["SOF15","_sofHandler","Differential lossless (sequential)"],196:["DHT",null,"Define Huffman table(s)"],204:["DAC",null,"Define arithmetic coding conditioning(s)"],208:["RST0",null,"Restart with modulo 8 count “0”"],209:["RST1",null,"Restart with modulo 8 count “1”"],210:["RST2",null,"Restart with modulo 8 count “2”"],211:["RST3",null,"Restart with modulo 8 count “3”"],212:["RST4",null,"Restart with modulo 8 count “4”"],213:["RST5",null,"Restart with modulo 8 count “5”"],214:["RST6",null,"Restart with modulo 8 count “6”"],215:["RST7",null,"Restart with modulo 8 count “7”"],216:["SOI",null,"Start of image"],217:["EOI",null,"End of image"],218:["SOS",null,"Start of scan"],219:["DQT",null,"Define quantization table(s)"],220:["DNL",null,"Define number of lines"],221:["DRI",null,"Define restart interval"],222:["DHP",null,"Define hierarchical progression"],223:["EXP",null,"Expand reference component(s)"],224:["APP0","_app0Handler","Reserved for application segments"],225:["APP1","_app1Handler"],226:["APP2",null],227:["APP3",null],228:["APP4",null],229:["APP5",null],230:["APP6",null],231:["APP7",null],232:["APP8",null],233:["APP9",null],234:["APP10",null],235:["APP11",null],236:["APP12",null],237:["APP13",null],238:["APP14",null],239:["APP15",null],240:["JPG0",null],241:["JPG1",null],242:["JPG2",null],243:["JPG3",null],244:["JPG4",null],245:["JPG5",null],246:["JPG6",null],247:["JPG7",null],248:["JPG8",null],249:["JPG9",null],250:["JPG10",null],251:["JPG11",null],252:["JPG12",null],253:["JPG13",null],254:["COM",null],1:["JPG13",null]},n.JpegFile.prototype._addMetaGroup=function(t,e){var i=new n.MetaGroup(t,e);return this[i.fieldName]=i,this.metaGroups[i.fieldName]=i,i},n.JpegFile.prototype._parseIfd=function(t,e,i,o,a,r,l){var h,c,u,d,p,m,g,f,_,v,b,y=n.parseNum(t,e,i+o,2);b=this._addMetaGroup(r,l);for(var w=0;y>w;w++)if(h=i+o+2+12*w,c=n.parseNum(t,e,h,2),d=n.parseNum(t,e,h+2,2),m=n.parseNum(t,e,h+4,4),g=n.parseNum(t,e,h+8,4),void 0!==this._types[d]){if(u=this._types[d][0],p=this._types[d][1],g=4>=p*m?h+8:i+g,"UNDEFINED"==u)f=void 0;else if("ASCII"==u)f=e.slice(g,g+m),f=f.split("\x00")[0],n.stringIsClean(f)||(f="");else{f=[];for(var x=0;m>x;x++,g+=p)("BYTE"==u||"SHORT"==u||"LONG"==u)&&f.push(n.parseNum(t,e,g,p)),("SBYTE"==u||"SSHORT"==u||"SLONG"==u)&&f.push(n.parseSnum(t,e,g,p)),"RATIONAL"==u&&(_=n.parseNum(t,e,g,4),v=n.parseNum(t,e,g+4,4),f.push(new n.Rational(_,v))),"SRATIONAL"==u&&(_=n.parseSnum(t,e,g,4),v=n.parseSnum(t,e,g+4,4),f.push(new n.Rational(_,v))),f.push();1===m&&(f=f[0])}a.hasOwnProperty(c)?b._addProperty(a[c][1],a[c][0],f):s("WARNING(jpegmeta.js): Unknown tag: ",c)}},n.JpegFile.prototype._jfifHandler=function(t,e){if(void 0!==this.jfif)throw Error("Multiple JFIF segments found");this._addMetaGroup("jfif","JFIF"),this.jfif._addProperty("version_major","Version Major",this._binary_data.charCodeAt(e+5)),this.jfif._addProperty("version_minor","Version Minor",this._binary_data.charCodeAt(e+6)),this.jfif._addProperty("version","JFIF Version",this.jfif.version_major.value+"."+this.jfif.version_minor.value),this.jfif._addProperty("units","Density Unit",this._binary_data.charCodeAt(e+7)),this.jfif._addProperty("Xdensity","X density",n.parseNum(">",this._binary_data,e+8,2)),this.jfif._addProperty("Ydensity","Y Density",n.parseNum(">",this._binary_data,e+10,2)),this.jfif._addProperty("Xthumbnail","X Thumbnail",n.parseNum(">",this._binary_data,e+12,1)),this.jfif._addProperty("Ythumbnail","Y Thumbnail",n.parseNum(">",this._binary_data,e+13,1))},n.JpegFile.prototype._app0Handler=function(t,e){var i=this._binary_data.slice(e,e+5);i==this._JFIF_IDENT?this._jfifHandler(t,e):i==this._JFXX_IDENT},n.JpegFile.prototype._app1Handler=function(t,e){var i=this._binary_data.slice(e,e+5);i==this._EXIF_IDENT&&this._exifHandler(t,e+6)},n.JpegFile.prototype._exifHandler=function(t,e){if(void 0!==this.exif)throw new Error("Multiple JFIF segments found");var i,s,o,a=this._binary_data.slice(e,e+2);if("II"===a)i="<";else{if("MM"!==a)throw new Error("Malformed TIFF meta-data. Unknown endianess: "+a);i=">"}if(s=n.parseNum(i,this._binary_data,e+2,2),42!==s)throw new Error("Malformed TIFF meta-data. Bad magic: "+s);if(o=n.parseNum(i,this._binary_data,e+4,4),this._parseIfd(i,this._binary_data,e,o,this._tifftags,"tiff","TIFF"),this.tiff.ExifIfdPointer&&this._parseIfd(i,this._binary_data,e,this.tiff.ExifIfdPointer.value,this._exiftags,"exif","Exif"),this.tiff.GPSInfoIfdPointer){if(this._parseIfd(i,this._binary_data,e,this.tiff.GPSInfoIfdPointer.value,this._gpstags,"gps","GPS"),this.gps.GPSLatitude){var r;r=this.gps.GPSLatitude.value[0].asFloat()+1/60*this.gps.GPSLatitude.value[1].asFloat()+1/3600*this.gps.GPSLatitude.value[2].asFloat(),"S"===this.gps.GPSLatitudeRef.value&&(r=-r),this.gps._addProperty("latitude","Dec. Latitude",r)}if(this.gps.GPSLongitude){var l;l=this.gps.GPSLongitude.value[0].asFloat()+1/60*this.gps.GPSLongitude.value[1].asFloat()+1/3600*this.gps.GPSLongitude.value[2].asFloat(),"W"===this.gps.GPSLongitudeRef.value&&(l=-l),this.gps._addProperty("longitude","Dec. Longitude",l)}}}},{}],442:[function(t,e,i){!function(t,e,i){"use strict";var s,n=e.event,o=!1;n.special.smartresize={setup:function(){e(this).bind("resize",n.special.smartresize.handler)},teardown:function(){e(this).unbind("resize",n.special.smartresize.handler)},handler:function(t,e){var i=this,o=arguments;t.type="smartresize",s&&clearTimeout(s),s=setTimeout(function(){a.onBeforeSmartResize(),n.dispatch.apply(i,o),a.onAfterSmartResize()},"execAsap"===e?0:100)}},e.fn.smartresize=function(t){return t?this.bind("smartresize",t):this.trigger("smartresize",["execAsap"])},e.Mason=function(t,i){this.element=e(i),this._create(t),this._init()},e.Mason.settings={isResizable:!0,isAnimated:!1,animationOptions:{queue:!1,duration:500},gutterWidth:0,isRTL:!1,isFitWidth:!1,containerStyle:{position:"relative"}},e.Mason.prototype={_filterFindBricks:function(t){var e=this.options.itemSelector;return e?t.filter(e).add(t.find(e)):t},_getBricks:function(t){var e=this._filterFindBricks(t).css({position:"absolute"}).addClass("masonry-brick");return e},_create:function(i){this.options=e.extend(!0,{},e.Mason.settings,i),this.styleQueue=[];var s=this.element[0].style;this.originalStyle={height:s.height||""};var n=this.options.containerStyle;for(var o in n)this.originalStyle[o]=s[o]||"";this.element.css(n),this.horizontalDirection=this.options.isRTL?"right":"left";var r=this.element.css("padding-"+this.horizontalDirection),l=this.element.css("padding-top");this.offset={x:r?parseInt(r,10):0,y:l?parseInt(l,10):0},this.isFluid=this.options.columnWidth&&"function"==typeof this.options.columnWidth;var h=this;setTimeout(function(){h.element.addClass("masonry")},0),this.ghoster=new a(h),this.options.isResizable&&e(t).bind("smartresize.masonry",function(){h.resize(),h.ghoster.resized()}),this.reloadItems()},_init:function(t){this._getColumns(),this._reLayout(t),this.ghoster.updateView()},option:function(t,i){e.isPlainObject(t)&&(this.options=e.extend(!0,this.options,t))},layout:function(t,e){for(var i=0,s=t.length;s>i;i++)this._placeBrick(t[i]);var n={};if(n.height=Math.max.apply(Math,this.colYs),this.options.isFitWidth){var o=0;for(i=this.cols;--i&&0===this.colYs[i];)o++;n.width=(this.cols-o)*this.columnWidth-this.options.gutterWidth}this.styleQueue.push({$el:this.element,style:n});var a,r=this.isLaidOut&&this.options.isAnimated?"animate":"css",l=this.options.animationOptions;for(i=0,s=this.styleQueue.length;s>i;i++)a=this.styleQueue[i],a.$el[r](a.style,l);this.ghoster.layout(this.styleQueue),this.ghoster.updateView(),this.styleQueue=[],e&&e.call(t),this.isLaidOut=!0},_getColumns:function(){var t=this.options.isFitWidth?this.element.parent():this.element,e=t.width();this.columnWidth=this.isFluid?this.options.columnWidth(e):this.options.columnWidth||this.ghoster.firstBrickOuterWidth()||e,this.columnWidth+=this.options.gutterWidth,this.cols=Math.floor((e+this.options.gutterWidth)/this.columnWidth),this.cols=Math.max(this.cols,1)},_placeBrick:function(t){var i,s,n,o,a,r=e(t);if(i=Math.ceil(this.ghoster.outerWidth(r)/this.columnWidth),i=Math.min(i,this.cols),1===i)n=this.colYs;else for(s=this.cols+1-i,n=[],a=0;s>a;a++)o=this.colYs.slice(a,a+i),n[a]=Math.max.apply(Math,o);for(var l=Math.min.apply(Math,n),h=0,c=0,u=n.length;u>c;c++)if(n[c]===l){h=c;break}var d={top:l+this.offset.y};d[this.horizontalDirection]=this.columnWidth*h+this.offset.x,this.styleQueue.push({$el:r,style:d});var p=l+this.ghoster.outerHeight(r),m=this.cols+1-u;for(c=0;m>c;c++)this.colYs[h+c]=p},resize:function(){var t=this.cols;this._getColumns(),(this.isFluid||this.cols!==t)&&this._reLayout()},_reLayout:function(t){var e=this.cols;for(this.colYs=[];e--;)this.colYs.push(0);this.layout(this.$bricks,t)},reloadItems:function(){this.$bricks=this._getBricks(this.element.children())},reload:function(t){this.reloadItems(),this._init(t)},appended:function(t,e,i){if(e){this._filterFindBricks(t).css({top:this.element.height()});var s=this;setTimeout(function(){s._appended(t,i)},1)}else this._appended(t,i)},_appended:function(t,e){var i=this._getBricks(t);this.$bricks=this.$bricks.add(i),this.layout(i,e)},remove:function(t){this.$bricks=this.$bricks.not(t),t.remove()},destroy:function(){this.$bricks.removeClass("masonry-brick").each(function(){this.style.position="",this.style.top="",this.style.left=""});var i=this.element[0].style;for(var s in this.originalStyle)i[s]=this.originalStyle[s];this.element.unbind(".masonry").removeClass("masonry").removeData("masonry"),e(t).unbind(".masonry"),this.ghoster.destroy()}};var a=e.fn.Ghost=function(){function s(){var t=document.createElement("script");return t.type="text/template",t.id=g(),t}function n(t,e,i){e||(e=250);var s,n;return function(){var o=i||this,a=+new Date,r=arguments;s&&s+e>a?(clearTimeout(n),n=setTimeout(function(){s=a,t.apply(o,r)},e)):(s=a,t.apply(o,r))}}function a(t){this.instance=t,this.options=t.options.ghoster||{},m.scrollTop=p.scrollTop(),m.documentHeight=d.height(),m.windowHeight=p.height(),m.windowWidth=p.width(),p.on("ghostscroll.ghoster",e.proxy(this.updateView,this)),o===!1&&(p.bind("scroll.ghoster",n(function(){m.scrollTop=p.scrollTop(),p.trigger("ghostscroll",[m])},h)),o=!0)}function r(t){for(var e,i=t.length;i--;)e=t[i],"IMG"===e.nodeName?e.src!==f&&(e.setAttribute("data-src",e.src),e.src=f):e.style.backgroundImage&&(e.style.backgroundImage="")}function l(t){for(var e,i,s=t.length;s--;)e=t[s],"IMG"===e.nodeName?e.src===f&&(e.src=e.getAttribute("data-src")):(i=e.getAttribute("data-imageurl"),-1===e.style.backgroundImage.indexOf(i)&&(e.style.backgroundImage="url("+i+")"))}var h=40,c=500,u=500,d=e(document),p=e(t),m={scrollTop:null,documentHeight:null,windowHeight:null,windowWidth:null},g=function(){var t=0,e="ghosted";return function(){return e+t++}}();a.onBeforeSmartResize=function(){m.scrollTop=p.scrollTop(),m.documentHeight=d.height(),m.windowHeight=p.height(),m.windowWidth=p.width(),p.trigger("ghostbeforeresize",[m])},a.onAfterSmartResize=function(){p.trigger("ghostafterresize",[m])},a._excluder=function(t,i){i=!!i,t instanceof jQuery?t=t.toArray():Array.isArray(t)||(t=[t]);for(var s=t.length;s--;){if(!(t[s]instanceof Element))throw"exclude takes either jquery object, arary of elements, or element.";e.data(t[s],"*exclude",i)}},a.exclude=function(t){return a._excluder(t,!0)},a.unexclude=function(t){return a._excluder(t,!1)};var f="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==";return a._brickBlanker=function(t,i){t instanceof Element&&(i=t,t="blank");var s=e.data(i,"*blankables");s&&s.length&&("blank"===t?r(s):l(s),e.data(i,"*blanked","blank"===t))},a._brickUnblanker=function(t){var i=e.data(t,"*blankables");i&&i.length&&r(i)},a.live=function(t){var i=e.data(t),s=i["*attached"],n=(i["*blanked"],i["*detachable"]),o=i["*placeholder"];s||(o.parentNode.replaceChild(n,o),e.data(t,"*attached",!0))},a.prototype.resized=function(){this.updateView()},a.prototype.destroy=function(){var t=["*top","*bottom","*parent","*outerHeight","*outerWidth"];this.instance.$bricks.each(function(){var i=this;e.removeData(i,t)}),p.unbind(".ghoster"),p=null,this.instance=null},a.prototype.updateView=function(){var t=this.instance,i=m.scrollTop-c,s=m.scrollTop+m.windowHeight+u;t.$bricks.each(function(){var t=this,n=e.data(t),o=n["*attached"],a=n["*blankable"],h=n["*blanked"],c=n["*bottom"],u=n["*top"],d=n["*exclude"],p=n["*detachable"],m=n["*placeholder"],g=n["*seen"];if(s>u&&c>i){if(a&&h&&(l(n["*blankables"]),e.data(t,"*blanked",!1)),g||e.data(t,"*seen",!0),o)return;m.parentNode.replaceChild(p,m),e.data(t,"*attached",!0)}else{if(!g||!o||d)return;a&&!h&&(r(n["*blankables"]),e.data(t,"*blanked",!0)),p.parentNode.replaceChild(m,p),e.data(t,"*attached",!1)}})},a.prototype.layout=function(t){var n,o,a,r,l,h,c,u,d,p,m=this.instance.element,g=m.get(0),f=e.data(g),_=f["*top"];_||(_=m.offset().top,e.data(g,"*top",_));for(var v=this.options.detachable,b=t.length;b--;)if(a=t[b].$el.get(0),g!==a){if(u=e.data(a),h=u["*outerHeight"],"undefined"==typeof h)throw"should have outerHeight already";d=u["*blankable"],r=u["*parent"],l=u["*placeholder"],o=u["*detachable"],r&&l&&o&&d!==i||(p=e.makeArray(a.querySelectorAll("[data-imageurl], img")),o=v?a.querySelector(v):a,l=s(),r=a.parentNode,e.data(a,"*blankable",!!p.length),e.data(a,"*blanked",!!p.length),e.data(a,"*blankables",p.length?p:null),e.data(a,"*attached",!0),e.data(a,"*seen",!1),e.data(a,"*detachable",o),e.data(a,"*parent",r),e.data(a,"*placeholder",l)),c=_+parseInt(a.style.top,10),n=c+h,e.data(a,"*bottom",n),e.data(a,"*top",c)}},a.prototype.firstBrickOuterWidth=function(){var t=this.instance.$bricks.get(0),i=this.instance.$bricks.eq(0);return e.data(t,"*outerWidth")||i.outerWidth(!0)},a.prototype.recalc=function(t){var i=this,s=t.get(0),n=e.data(s),o=t.outerHeight(!0),a=t.outerWidth(!0);return(n["*outerHeight"]!==o||n["*outerWidth"]!==a)&&(e.data(s,"*outerHeight",o),e.data(s,"*outerWidth",a),i._reLayout()),this},a.prototype.outerWidth=function(t){var i=t.get(0),s=e.data(i,"*outerWidth");return s||(s=t.outerWidth(!0),e.data(i,"*outerWidth",s)),s},a.prototype.outerHeight=function(t){var i=t.get(0),s=e.data(i,"*outerHeight");return s||(s=t.outerHeight(!0),e.data(i,"*outerHeight",s)),s},a}();e.fn.imagesLoaded=function(t){function i(){t.call(n,o)}function s(t){var n=t.target;n.src!==r&&-1===e.inArray(n,l)&&(l.push(n),--a<=0&&(setTimeout(i),o.unbind(".imagesLoaded",s)))}var n=this,o=n.find("img").add(n.filter("img")),a=o.length,r="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==",l=[];return a||i(),o.bind("load.imagesLoaded error.imagesLoaded",s).each(function(){var t=this.src;this.src=r,this.src=t}),n};var r=function(e){t.console&&t.console.error(e)};e.fn.ghost=function(t){if("string"==typeof t){var i=Array.prototype.slice.call(arguments,1);this.each(function(){var s=e.data(this,"masonry");if(!e.isFunction(s.ghoster[t]))throw"Bad Ghost method.";s.ghoster[t].apply(s,i)})}return this},e.fn.masonry=function(t){if("string"==typeof t){var i=Array.prototype.slice.call(arguments,1);this.each(function(){var s=e.data(this,"masonry");return s?e.isFunction(s[t])&&"_"!==t.charAt(0)?void s[t].apply(s,i):void r("no such method '"+t+"' for masonry instance"):void r("cannot call methods on masonry prior to initialization; attempted to call method '"+t+"'")})}else this.each(function(){var i=e.data(this,"masonry");i?(i.option(t||{}),i._init()):e.data(this,"masonry",new e.Mason(t,this))});return this}}(window,jQuery)},{}],443:[function(t,e,i){"use strict";e.exports=function(t){return t.subarray(0,t.byteLength-t[t.byteLength-1])}},{}],444:[function(t,e,i){e.exports=function(e){(function(){!function(t,e,i,s){"use strict";var n,o,a,r=1.1,l=500;o=function(t){return t.retries&&t.retries>=2},e.Hls=e.Flash.extend({init:function(t,i,s){var n=i.source,o=t.options();t.hls=this,delete i.source,i.swf=o.flash.swf,e.Flash.call(this,t,i,s),i.source=n,this.bytesReceived=0,this.hasPlayed_=!1,this.on(t,"loadstart",function(){this.hasPlayed_=!1,this.one(this.mediaSource,"sourceopen",this.setupFirstPlay)}),this.on(t,["play","loadedmetadata"],this.setupFirstPlay),this.currentTime=e.Hls.prototype.currentTime,this.setCurrentTime=e.Hls.prototype.setCurrentTime,this.segmentBuffer_=[],this.startCheckingBuffer_(),e.Hls.prototype.src.call(this,i.source&&i.source.src)}}),e.options.techOrder.unshift("hls"),e.Hls.GOAL_BUFFER_LENGTH=30,e.Hls.LIVE_SYNC_DURATION_COUNT=3,e.Hls.prototype.src=function(t){var i,o,a,r=this,l=this.player(),h=l.options().hls||{};t&&(this.src_&&this.resetSrc_(),this.src_=t,i=new e.MediaSource,a={src:e.URL.createObjectURL(i),type:"video/flv"},this.mediaSource=i,this.segmentBuffer_=[],this.segmentParser_=new e.Hls.SegmentParser,this.setupMetadataCueTranslation_(),this.mediaSource.addEventListener("sourceopen",e.bind(this,this.handleSourceOpen)),this.playlists&&this.playlists.dispose(),this.mediaIndex=0,this.playlists=new e.Hls.PlaylistLoader(this.src_,h.withCredentials),this.playlists.on("loadedmetadata",e.bind(this,function(){var t,i,n,a,r,h,c;o=this.playlists.media(),this.bandwidth===s&&this.setBandwidth({bandwidth:5*this.playlists.bandwidth}),t=this.selectPlaylist(),n=o.attributes&&o.attributes.BANDWIDTH||0,a=t.attributes&&t.attributes.BANDWIDTH||0,r=o.segments&&o.segments[this.mediaIndex].duration||o.targetDuration,h=r*a/this.bandwidth,h||(h=1/0),c=10,a>n&&c>=h?(this.playlists.media(t),i=e.bind(this,function(){this.setupFirstPlay(),this.fillBuffer(),l.trigger("loadedmetadata"),this.playlists.off("loadedplaylist",i)}),this.playlists.on("loadedplaylist",i)):(this.setupFirstPlay(),this.fillBuffer(),l.trigger("loadedmetadata"))})),this.playlists.on("error",e.bind(this,function(){l.error(this.playlists.error)})),this.playlists.on("loadedplaylist",e.bind(this,function(){var t=this.playlists.media();t&&(this.updateDuration(this.playlists.media()),this.mediaIndex=e.Hls.translateMediaIndex(this.mediaIndex,o,t),o=t,this.fetchKeys_())})),this.playlists.on("mediachange",e.bind(this,function(){n&&this.cancelKeyXhr(),l.trigger("mediachange")})),this.player().ready(function(){r.el()&&r.el().vjs_src(a.src)}))},e.Hls.getMediaIndexForLive_=function(t){if(!t.segments)return 0;for(var i=t.segments.length,s=0,n=(t.targetDuration||10)*e.Hls.LIVE_SYNC_DURATION_COUNT;n>s&&i>0;)s+=t.segments[i-1].duration,i--;return i},e.Hls.prototype.handleSourceOpen=function(){var t=this.player(),e=this.mediaSource.addSourceBuffer('video/flv; codecs="vp6,aac"');this.sourceBuffer=e,t.options().autoplay&&t.play(),e.appendBuffer(this.segmentParser_.getFlvHeader())},e.Hls.prototype.setupMetadataCueTranslation_=function(){var t,i=this,s=i.segmentParser_.metadataStream;i.player().addTextTrack&&(s.on("data",function(n){var o,a;if(!t)for(t=i.player().addTextTrack("metadata","Timed Metadata"),t.inBandMetadataTrackDispatchType=e.Hls.SegmentParser.STREAM_TYPES.metadata.toString(16).toUpperCase(),o=0;o<s.descriptor.length;o++)a=("00"+s.descriptor[o].toString(16).toUpperCase()).slice(-2),t.inBandMetadataTrackDispatchType+=a;i.segmentBuffer_[0].pendingMetadata.push({textTrack:t,metadata:n})}),i.on(i.player(),"seeking",function(){var s,n,o;if(t)for(s=i.playlists.media(),n=i.playlists.expiredPreDiscontinuity_+i.playlists.expiredPostDiscontinuity_,n+=e.Hls.Playlist.duration(s,s.mediaSequence,s.mediaSequence+i.mediaIndex),o=t.cues.length;o--;)t.cues[o].startTime>=n&&t.removeCue(t.cues[o])}))},e.Hls.prototype.addCuesForMetadata_=function(i){var s,n,o,a,r,l,h,c,u;for(h=this.playlists.expiredPreDiscontinuity_,h+=this.playlists.expiredPostDiscontinuity_,h+=e.Hls.Playlist.duration(i.playlist,i.playlist.mediaSequence,i.playlist.mediaSequence+i.mediaIndex),l=i.playlist.segments[i.mediaIndex],r=Math.min(isFinite(l.minVideoPts)?l.minVideoPts:1/0,isFinite(l.minAudioPts)?l.minAudioPts:1/0);i.pendingMetadata.length;){for(a=i.pendingMetadata[0].metadata,c=i.pendingMetadata[0].textTrack,s=0;s<a.frames.length;s++)o=a.frames[s],u=h+.001*(a.pts-r),n=new t.VTTCue(u,u,o.value||o.url||""),n.frame=o,n.pts_=a.pts,c.addCue(n);i.pendingMetadata.shift()}},e.Hls.prototype.setupFirstPlay=function(){var t,e;e=this.playlists.media(),!this.hasPlayed_&&this.sourceBuffer&&e&&this.paused()===!1&&(this.hasPlayed_=!0,this.duration()===1/0&&(t=this.seekable(),t.length&&this.setCurrentTime(t.end(0))))},e.Hls.prototype.play=function(){return this.ended()&&(this.mediaIndex=0),this.hasPlayed_?(this.duration()===1/0&&this.currentTime()<this.seekable().start(0)&&this.setCurrentTime(this.seekable().start(0)),void e.Flash.prototype.play.apply(this,arguments)):(e.Flash.prototype.play.apply(this,arguments),this.setupFirstPlay())},e.Hls.prototype.currentTime=function(){return this.lastSeekedTime_?this.lastSeekedTime_:this.el()&&this.el().vjs_getProperty?this.el().vjs_getProperty("currentTime"):0},e.Hls.prototype.setCurrentTime=function(t){return this.playlists&&this.playlists.media()&&this.playlists.media().segments?(t<this.seekable().start(0)?t=this.seekable().start(0):t>this.seekable().end(0)&&(t=this.seekable().end(0)),this.lastSeekedTime_=t,this.mediaIndex=this.playlists.getMediaIndexForTime_(t),this.sourceBuffer&&this.sourceBuffer.abort(),this.cancelSegmentXhr(),n&&(n.aborted=!0,this.cancelKeyXhr()),this.segmentBuffer_=[],void this.fillBuffer(1e3*t)):0},e.Hls.prototype.duration=function(){var t=this.playlists;return t?e.Hls.Playlist.duration(t.media()):0},e.Hls.prototype.seekable=function(){var t,i,s;return this.playlists&&(s=this.playlists.media())?(t=e.Hls.Playlist.seekable(s),t.length?(i=this.playlists.expiredPostDiscontinuity_-this.playlists.expiredPreDiscontinuity_,e.createTimeRange(i,i+(t.end(0)-t.start(0)))):t):e.createTimeRange()},e.Hls.prototype.updateDuration=function(t){var i=this.player(),s=i.duration(),n=e.Hls.Playlist.duration(t);s!==n&&i.trigger("durationchange")},e.Hls.prototype.resetSrc_=function(){this.cancelSegmentXhr(),this.cancelKeyXhr(),this.sourceBuffer&&this.sourceBuffer.abort()},e.Hls.prototype.cancelKeyXhr=function(){n&&(n.onreadystatechange=null,n.abort(),n=null)},e.Hls.prototype.cancelSegmentXhr=function(){this.segmentXhr_&&(this.segmentXhr_.onreadystatechange=null,this.segmentXhr_.abort(),this.segmentXhr_=null)},e.Hls.prototype.dispose=function(){this.stopCheckingBuffer_(),this.playlists&&this.playlists.dispose(),this.resetSrc_(),e.Flash.prototype.dispose.call(this)},e.Hls.prototype.selectPlaylist=function(){var t,i,s,n,o,a,l,h,c=this.player(),u=this.playlists.master.playlists.slice(),d=[],p=u.length;for(u.sort(e.Hls.comparePlaylistBandwidth);p--;)i=u[p],i.attributes&&i.attributes.BANDWIDTH&&(t=i.attributes.BANDWIDTH*r,t<c.hls.bandwidth&&(d.push(i),n||(n=i)));for(p=d.length,d.sort(e.Hls.comparePlaylistResolution),i=null,l=parseInt(getComputedStyle(c.el()).width,10),h=parseInt(getComputedStyle(c.el()).height,10);p--;)if(s=i,i=d[p],i.attributes&&i.attributes.RESOLUTION&&i.attributes.RESOLUTION.width&&i.attributes.RESOLUTION.height){if(i.attributes.RESOLUTION.width===l&&i.attributes.RESOLUTION.height===h){o=null,a=i;break}if(i.attributes.RESOLUTION.width<l&&i.attributes.RESOLUTION.height<h){s&&s.attributes&&s.attributes.RESOLUTION&&s.attributes.RESOLUTION.width&&s.attributes.RESOLUTION.height&&(o=s),a=i;break}}return o||a||n||u[0]},e.Hls.prototype.checkBuffer_=function(){this.checkBufferTimeout_&&(t.clearTimeout(this.checkBufferTimeout_),this.checkBufferTimeout_=null),this.fillBuffer(),this.drainBuffer(),this.checkBufferTimeout_=t.setTimeout(e.bind(this,this.checkBuffer_),l)},e.Hls.prototype.startCheckingBuffer_=function(){this.player().on("waiting",e.bind(this,this.drainBuffer)),this.checkBuffer_()},e.Hls.prototype.stopCheckingBuffer_=function(){t.clearTimeout(this.checkBufferTimeout_),this.checkBufferTimeout_=null,this.player().off("waiting",this.drainBuffer)},e.Hls.prototype.fillBuffer=function(t){var i,n,o=this.player(),a=o.buffered(),r=0;(o.hasClass("vjs-has-started")||"none"!==o.options().preload)&&o.currentSrc()&&this.playlists&&(this.segmentXhr_||"HAVE_NOTHING"!==this.playlists.state&&this.playlists.media()&&this.playlists.media().segments&&(this.playlists.media().endList||o.hasClass("vjs-has-started")||t!==s)&&"SWITCHING_MEDIA"!==this.playlists.state&&(i=this.playlists.media().segments[this.mediaIndex],i&&(a&&(r=o.buffered().end(0)-o.currentTime()),"number"!=typeof t&&r>=e.Hls.GOAL_BUFFER_LENGTH||(n=this.playlistUriToUrl(i.uri),this.loadSegment(n,t)))))},e.Hls.prototype.playlistUriToUrl=function(t){var e;return e=this.playlists.media().uri===this.src_?a(this.src_,t):a(a(this.src_,this.playlists.media().uri||""),t)},e.Hls.prototype.setBandwidth=function(t){var e=this;e.segmentXhrTime=t.roundTripTime,e.bandwidth=t.bandwidth,e.bytesReceived+=t.bytesReceived||0,e.trigger("bandwidthupdate")},e.Hls.prototype.loadSegment=function(t,i){var s=this,n=this.player(),o=n.options().hls||{};this.segmentXhr_=e.Hls.xhr({url:t,responseType:"arraybuffer",withCredentials:o.withCredentials},function(t,e){var o;return s.segmentXhr_=null,t?"timeout"===t?(s.bandwidth=1,s.playlists.media(s.selectPlaylist())):(s.error={status:this.status,message:"HLS segment request error at URL: "+e,code:this.status>=500?4:2},void s.mediaIndex++):void(this.response&&(s.setBandwidth(this),o={mediaIndex:s.mediaIndex,playlist:s.playlists.media(),offset:i,bytes:null,encryptedBytes:null,decrypter:null,pendingMetadata:[]},o.playlist.segments[o.mediaIndex].key?o.encryptedBytes=new Uint8Array(this.response):o.bytes=new Uint8Array(this.response),s.segmentBuffer_.push(o),n.trigger("progress"),s.drainBuffer(),s.mediaIndex++,s.playlists.media(s.selectPlaylist())))})},e.Hls.prototype.drainBuffer=function(t){var i,s,n,a,r,l,h,c,u,d,p=0,m=0,g=this.segmentBuffer_;if(g.length&&this.sourceBuffer&&!this.sourceBuffer.updating){if(i=g[0],s=i.mediaIndex,n=i.playlist,a=i.offset,l=i.bytes,h=n.segments[s],h.key&&!l)return o(h.key)?g.shift():h.key.bytes?i.decrypter?void 0:(u=h.key.iv||new Uint32Array([0,0,0,s+n.mediaSequence]),c=new e.Hls.Decrypter(i.encryptedBytes,h.key.bytes,u,function(t,e){i.bytes=e}),void(i.decrypter=c)):this.fetchKeys_();for(t=t||{},this.segmentParser_.parseSegmentBinaryData(l),
this.segmentParser_.flushTags(),r=[],this.segmentParser_.tagsAvailable()&&(this.segmentParser_.stats.h264Tags()&&(h.minVideoPts=this.segmentParser_.stats.minVideoPts(),h.maxVideoPts=this.segmentParser_.stats.maxVideoPts()),this.segmentParser_.stats.aacTags()&&(h.minAudioPts=this.segmentParser_.stats.minAudioPts(),h.maxAudioPts=this.segmentParser_.stats.maxAudioPts()));this.segmentParser_.tagsAvailable();)r.push(this.segmentParser_.getNextTag());if(this.addCuesForMetadata_(i),this.updateDuration(this.playlists.media()),"number"==typeof a){if(r.length){for(m=this.playlists.expiredPostDiscontinuity_+this.playlists.expiredPreDiscontinuity_,m+=e.Hls.Playlist.duration(n,n.mediaSequence,n.mediaSequence+s),m=a-1e3*m,d=m+r[0].pts;r[p+1]&&r[p].pts<d;)p++;this.el().vjs_setProperty("currentTime",.001*(r[p].pts-d+a)),r=r.slice(p)}this.lastSeekedTime_=null}h.discontinuity&&r.length&&this.el().vjs_discontinuity(),function(){var t,e,i=0;for(p=0;p<r.length;p++)i+=r[p].bytes.byteLength;for(e=new Uint8Array(i),p=0,t=0;p<r.length;p++)e.set(r[p].bytes,t),t+=r[p].bytes.byteLength;this.sourceBuffer.appendBuffer(e)}.call(this),g.shift(),this.duration()!==1/0&&s+1===n.segments.length&&this.mediaSource.endOfStream()}},e.Hls.prototype.fetchKeys_=function(){var t,i,s,a,r,l,h,c;if(!n&&this.segmentBuffer_.length)for(s=this,a=this.player(),r=a.options().hls||{},c=function(t){return function(e){return n=null,e||!this.response||16!==this.response.byteLength?(t.retries=t.retries||0,t.retries++,void(this.aborted||s.fetchKeys_())):(h=new DataView(this.response),t.bytes=new Uint32Array([h.getUint32(0),h.getUint32(4),h.getUint32(8),h.getUint32(12)]),void s.checkBuffer_())}},t=0;t<s.segmentBuffer_.length;t++)if(l=s.segmentBuffer_[t].playlist.segments[s.segmentBuffer_[t].mediaIndex],i=l.key,i&&!i.bytes&&!o(i)){n=e.Hls.xhr({url:this.playlistUriToUrl(i.uri),responseType:"arraybuffer",withCredentials:r.withCredentials},c(i));break}},e.Hls.supportsNativeHls=function(){var t,s,n=i.createElement("video");return e.Html5.isSupported()?(t=n.canPlayType("application/x-mpegURL"),s=n.canPlayType("application/vnd.apple.mpegURL"),/probably|maybe/.test(t)||/probably|maybe/.test(s)):!1}(),e.Hls.isSupported=function(){return!e.Hls.supportsNativeHls&&e.Flash.isSupported()&&e.MediaSource&&t.Uint8Array},e.Hls.canPlaySource=function(t){var e=/^application\/(?:x-|vnd\.apple\.)mpegurl/i;return e.test(t.type)},e.Hls.getPlaylistDuration=function(t,i,s){return e.log.warn("videojs.Hls.getPlaylistDuration is deprecated. Use videojs.Hls.Playlist.duration instead"),e.Hls.Playlist.duration(t,i,s)},e.Hls.getPlaylistTotalDuration=function(t){return e.log.warn("videojs.Hls.getPlaylistTotalDuration is deprecated. Use videojs.Hls.Playlist.duration instead"),e.Hls.Playlist.duration(t)},e.Hls.translateMediaIndex=function(t,i,s){var n;return 0===t?0:s&&s.segments?(n=t+(i.mediaSequence-s.mediaSequence),n>s.segments.length||0>n?e.Hls.getMediaIndexForLive_(s)+1:n):0},e.Hls.getMediaIndexByTime=function(){return e.log.warn("getMediaIndexByTime is deprecated. Use PlaylistLoader.getMediaIndexForTime_ instead."),0},e.Hls.comparePlaylistBandwidth=function(e,i){var s,n;return e.attributes&&e.attributes.BANDWIDTH&&(s=e.attributes.BANDWIDTH),s=s||t.Number.MAX_VALUE,i.attributes&&i.attributes.BANDWIDTH&&(n=i.attributes.BANDWIDTH),n=n||t.Number.MAX_VALUE,s-n},e.Hls.comparePlaylistResolution=function(e,i){var s,n;return e.attributes&&e.attributes.RESOLUTION&&e.attributes.RESOLUTION.width&&(s=e.attributes.RESOLUTION.width),s=s||t.Number.MAX_VALUE,i.attributes&&i.attributes.RESOLUTION&&i.attributes.RESOLUTION.width&&(n=i.attributes.RESOLUTION.width),n=n||t.Number.MAX_VALUE,s===n&&e.attributes.BANDWIDTH&&i.attributes.BANDWIDTH?e.attributes.BANDWIDTH-i.attributes.BANDWIDTH:s-n},a=e.Hls.resolveUrl=function(t,e){var s,n,o=i.querySelector("base"),a=i.querySelector("head"),r=i.createElement("a"),l=o;return o?s=o.href:l=a.appendChild(i.createElement("base")),l.href=t,r.href=e,n=r.href,o?o.href=s:a.removeChild(l),n}}(e,e.videojs,document),function(t,e){var i=function(){this.init=function(){var t={};this.on=function(e,i){t[e]||(t[e]=[]),t[e].push(i)},this.off=function(e,i){var s;return t[e]?(s=t[e].indexOf(i),t[e].splice(s,1),s>-1):!1},this.trigger=function(e){var i,s,n,o;if(i=t[e])for(o=Array.prototype.slice.call(arguments,1),n=i.length,s=0;n>s;++s)i[s].apply(this,o)},this.dispose=function(){t={}}}};i.prototype.pipe=function(t){this.on("data",function(e){t.push(e)})},t.Hls.Stream=i}(e.videojs),function(t){t.videojs=t.videojs||{},t.videojs.Hls=t.videojs.Hls||{};var e=t.videojs.Hls;e.FlvTag=function(t,i){var s,n=0,o=function(t,e){var i,s=t.position+e;s<t.bytes.byteLength||(i=new Uint8Array(2*s),i.set(t.bytes.subarray(0,t.position),0),t.bytes=i,t.view=new DataView(t.bytes.buffer))},a=e.FlvTag.widthBytes||new Uint8Array("width".length),r=e.FlvTag.heightBytes||new Uint8Array("height".length),l=e.FlvTag.videocodecidBytes||new Uint8Array("videocodecid".length);if(!e.FlvTag.widthBytes){for(s=0;s<"width".length;s++)a[s]="width".charCodeAt(s);for(s=0;s<"height".length;s++)r[s]="height".charCodeAt(s);for(s=0;s<"videocodecid".length;s++)l[s]="videocodecid".charCodeAt(s);e.FlvTag.widthBytes=a,e.FlvTag.heightBytes=r,e.FlvTag.videocodecidBytes=l}switch(this.keyFrame=!1,t){case e.FlvTag.VIDEO_TAG:this.length=16;break;case e.FlvTag.AUDIO_TAG:this.length=13,this.keyFrame=!0;break;case e.FlvTag.METADATA_TAG:this.length=29,this.keyFrame=!0;break;default:throw"Error Unknown TagType"}this.bytes=new Uint8Array(16384),this.view=new DataView(this.bytes.buffer),this.bytes[0]=t,this.position=this.length,this.keyFrame=i,this.pts=0,this.dts=0,this.writeBytes=function(t,e,i){var s,n=e||0;i=i||t.byteLength,s=n+i,o(this,i),this.bytes.set(t.subarray(n,s),this.position),this.position+=i,this.length=Math.max(this.length,this.position)},this.writeByte=function(t){o(this,1),this.bytes[this.position]=t,this.position++,this.length=Math.max(this.length,this.position)},this.writeShort=function(t){o(this,2),this.view.setUint16(this.position,t),this.position+=2,this.length=Math.max(this.length,this.position)},this.negIndex=function(t){return this.bytes[this.length-t]},this.nalUnitSize=function(){return 0===n?0:this.length-(n+4)},this.startNalUnit=function(){if(n>0)throw new Error("Attempted to create new NAL wihout closing the old one");n=this.length,this.length+=4,this.position=this.length},this.endNalUnit=function(t){var e,i;this.length===n+4?this.length-=4:n>0&&(e=n+4,i=this.length-e,this.position=n,this.view.setUint32(this.position,i),this.position=this.length,t&&t.push(this.bytes.subarray(e,e+i))),n=0},this.writeMetaDataDouble=function(t,e){var i;if(o(this,2+t.length+9),this.view.setUint16(this.position,t.length),this.position+=2,"width"===t)this.bytes.set(a,this.position),this.position+=5;else if("height"===t)this.bytes.set(r,this.position),this.position+=6;else if("videocodecid"===t)this.bytes.set(l,this.position),this.position+=12;else for(i=0;i<t.length;i++)this.bytes[this.position]=t.charCodeAt(i),this.position++;this.position++,this.view.setFloat64(this.position,e),this.position+=8,this.length=Math.max(this.length,this.position),++n},this.writeMetaDataBoolean=function(t,e){var i;for(o(this,2),this.view.setUint16(this.position,t.length),this.position+=2,i=0;i<t.length;i++)console.assert(t.charCodeAt(i)<255),o(this,1),this.bytes[this.position]=t.charCodeAt(i),this.position++;o(this,2),this.view.setUint8(this.position,1),this.position++,this.view.setUint8(this.position,e?1:0),this.position++,this.length=Math.max(this.length,this.position),++n},this.finalize=function(){var t,s;switch(this.bytes[0]){case e.FlvTag.VIDEO_TAG:this.bytes[11]=7|(this.keyFrame||i?16:32),this.bytes[12]=i?0:1,t=this.pts-this.dts,this.bytes[13]=(16711680&t)>>>16,this.bytes[14]=(65280&t)>>>8,this.bytes[15]=(255&t)>>>0;break;case e.FlvTag.AUDIO_TAG:this.bytes[11]=175,this.bytes[12]=i?0:1;break;case e.FlvTag.METADATA_TAG:this.position=11,this.view.setUint8(this.position,2),this.position++,this.view.setUint16(this.position,10),this.position+=2,this.bytes.set([111,110,77,101,116,97,68,97,116,97],this.position),this.position+=10,this.bytes[this.position]=8,this.position++,this.view.setUint32(this.position,n),this.position=this.length,this.bytes.set([0,0,9],this.position),this.position+=3,this.length=this.position}return s=this.length-11,this.bytes[1]=(16711680&s)>>>16,this.bytes[2]=(65280&s)>>>8,this.bytes[3]=(255&s)>>>0,this.bytes[4]=(16711680&this.dts)>>>16,this.bytes[5]=(65280&this.dts)>>>8,this.bytes[6]=(255&this.dts)>>>0,this.bytes[7]=(4278190080&this.dts)>>>24,this.bytes[8]=0,this.bytes[9]=0,this.bytes[10]=0,o(this,4),this.view.setUint32(this.length,this.length),this.length+=4,this.position+=4,this.bytes=this.bytes.subarray(0,this.length),this.frameTime=e.FlvTag.frameTime(this.bytes),console.assert(this.bytes.byteLength===this.length),this}},e.FlvTag.AUDIO_TAG=8,e.FlvTag.VIDEO_TAG=9,e.FlvTag.METADATA_TAG=18,e.FlvTag.isAudioFrame=function(t){return e.FlvTag.AUDIO_TAG===t[0]},e.FlvTag.isVideoFrame=function(t){return e.FlvTag.VIDEO_TAG===t[0]},e.FlvTag.isMetaData=function(t){return e.FlvTag.METADATA_TAG===t[0]},e.FlvTag.isKeyFrame=function(t){return e.FlvTag.isVideoFrame(t)?23===t[11]:e.FlvTag.isAudioFrame(t)?!0:e.FlvTag.isMetaData(t)?!0:!1},e.FlvTag.frameTime=function(t){var e=t[4]<<16;return e|=t[5]<<8,e|=t[6]<<0,e|=t[7]<<24}}(this),function(t){t.videojs.Hls.ExpGolomb=function(t){var e=t.byteLength,i=0,s=0;this.length=function(){return 8*e},this.bitsAvailable=function(){return 8*e+s},this.loadWord=function(){var n=t.byteLength-e,o=new Uint8Array(4),a=Math.min(4,e);if(0===a)throw new Error("no bytes available");o.set(t.subarray(n,n+a)),i=new DataView(o.buffer).getUint32(0),s=8*a,e-=a},this.skipBits=function(t){var n;s>t?(i<<=t,s-=t):(t-=s,n=t/8,t-=8*n,e-=n,this.loadWord(),i<<=t,s-=t)},this.readBits=function(t){var n=Math.min(s,t),o=i>>>32-n;return console.assert(32>t,"Cannot read more than 32 bits at a time"),s-=n,s>0?i<<=n:e>0&&this.loadWord(),n=t-n,n>0?o<<n|this.readBits(n):o},this.skipLeadingZeros=function(){var t;for(t=0;s>t;++t)if(0!==(i&2147483648>>>t))return i<<=t,s-=t,t;return this.loadWord(),t+this.skipLeadingZeros()},this.skipUnsignedExpGolomb=function(){this.skipBits(1+this.skipLeadingZeros())},this.skipExpGolomb=function(){this.skipBits(1+this.skipLeadingZeros())},this.readUnsignedExpGolomb=function(){var t=this.skipLeadingZeros();return this.readBits(t+1)-1},this.readExpGolomb=function(){var t=this.readUnsignedExpGolomb();return 1&t?1+t>>>1:-1*(t>>>1)},this.readBoolean=function(){return 1===this.readBits(1)},this.readUnsignedByte=function(){return this.readBits(8)},this.loadWord()}}(this),function(){var t,i=e.videojs.Hls.ExpGolomb,s=e.videojs.Hls.FlvTag;e.videojs.Hls.H264ExtraData=t=function(){this.sps=[],this.pps=[]},t.prototype.extraDataExists=function(){return this.sps.length>0},t.prototype.scaling_list=function(t,e){var i,s,n=8,o=8;for(i=0;t>i;++i)0!==o&&(s=e.readExpGolomb(),o=(n+s+256)%256),n=0===o?n:o},t.prototype.getSps0Rbsp=function(){for(var t=this.sps[0],e=1,i=1,s=0,n=t.byteLength-2,o=new Uint8Array(t.byteLength);n>e;)0===t[e]&&0===t[e+1]&&3===t[e+2]&&(o.set(t.subarray(i,e+1),s),s+=e+1-i,i=e+3),e++;return o.set(t.subarray(i),s),o.subarray(0,s+(t.byteLength-i))},t.prototype.metaDataTag=function(t){var e,n,o,a,r,l,h,c,u,d,p,m,g,f=new s(s.METADATA_TAG),_=0,v=0,b=0,y=0;if(f.dts=t,f.pts=t,e=new i(this.getSps0Rbsp()),n=e.readUnsignedByte(),e.skipBits(16),e.skipUnsignedExpGolomb(),(100===n||110===n||122===n||244===n||44===n||83===n||86===n||118===n||128===n)&&(o=e.readUnsignedExpGolomb(),3===o&&e.skipBits(1),e.skipUnsignedExpGolomb(),e.skipUnsignedExpGolomb(),e.skipBits(1),e.readBoolean()))for(a=3!==o?8:12,r=0;a>r;++r)e.readBoolean()&&(6>r?this.scaling_list(16,e):this.scaling_list(64,e));if(e.skipUnsignedExpGolomb(),l=e.readUnsignedExpGolomb(),0===l)e.readUnsignedExpGolomb();else if(1===l)for(e.skipBits(1),e.skipExpGolomb(),e.skipExpGolomb(),h=e.readUnsignedExpGolomb(),r=0;h>r;++r)e.skipExpGolomb();return e.skipUnsignedExpGolomb(),e.skipBits(1),c=e.readUnsignedExpGolomb(),u=e.readUnsignedExpGolomb(),d=e.readBits(1),0===d&&e.skipBits(1),e.skipBits(1),p=e.readBoolean(),p&&(_=e.readUnsignedExpGolomb(),v=e.readUnsignedExpGolomb(),b=e.readUnsignedExpGolomb(),y=e.readUnsignedExpGolomb()),m=16*(c+1)-2*_-2*v,g=(2-d)*(u+1)*16-2*b-2*y,f.writeMetaDataDouble("videocodecid",7),f.writeMetaDataDouble("width",m),f.writeMetaDataDouble("height",g),f},t.prototype.extraDataTag=function(t){var e,i=new s(s.VIDEO_TAG,!0);for(i.dts=t,i.pts=t,i.writeByte(1),i.writeByte(this.sps[0][1]),i.writeByte(this.sps[0][2]),i.writeByte(this.sps[0][3]),i.writeByte(255),i.writeByte(225),i.writeShort(this.sps[0].length),i.writeBytes(this.sps[0]),i.writeByte(this.pps.length),e=0;e<this.pps.length;++e)i.writeShort(this.pps[e].length),i.writeBytes(this.pps[e]);return i}}(),function(t){var e,i,s=t.videojs.Hls.FlvTag,n=t.videojs.Hls.H264ExtraData;t.videojs.Hls.NALUnitType=i={unspecified:0,slice_layer_without_partitioning_rbsp_non_idr:1,slice_data_partition_a_layer_rbsp:2,slice_data_partition_b_layer_rbsp:3,slice_data_partition_c_layer_rbsp:4,slice_layer_without_partitioning_rbsp_idr:5,sei_rbsp:6,seq_parameter_set_rbsp:7,pic_parameter_set_rbsp:8,access_unit_delimiter_rbsp:9,end_of_seq_rbsp:10,end_of_stream_rbsp:11},t.videojs.Hls.H264Stream=e=function(){this._next_pts=0,this._next_dts=0,this._h264Frame=null,this._oldExtraData=new n,this._newExtraData=new n,this._nalUnitType=-1,this._state=0,this.tags=[]},e.prototype.setTimeStampOffset=function(){},e.prototype.setNextTimeStamp=function(t,e,i){this._next_pts=t,this._next_dts=e,i&&this.finishFrame()},e.prototype.finishFrame=function(){this._h264Frame&&(this._newExtraData.extraDataExists()&&(this._oldExtraData=this._newExtraData,this._newExtraData=new n),this._oldExtraData.extraDataExists()&&(this._h264Frame.keyFrame||0===this.tags.length)&&(this.tags.push(this._oldExtraData.metaDataTag(this._h264Frame.pts)),this.tags.push(this._oldExtraData.extraDataTag(this._h264Frame.pts))),this._h264Frame.endNalUnit(),this.tags.push(this._h264Frame)),this._h264Frame=null,this._nalUnitType=-1,this._state=0},e.prototype.writeBytes=function(t,e,n){var o,a,r,l;if(e=e||0,n=n||0,!(0>=n))switch(this._state){default:case 0:this._state=1;case 1:if(t[e]<=1&&(o=this._h264Frame?this._h264Frame.nalUnitSize():0,o>=1&&0===this._h264Frame.negIndex(1))){if(1===t[e]&&o>=2&&0===this._h264Frame.negIndex(2))return o>=3&&0===this._h264Frame.negIndex(3)?this._h264Frame.length-=3:this._h264Frame.length-=2,this._state=3,this.writeBytes(t,e+1,n-1);if(n>1&&0===t[e]&&1===t[e+1])return o>=2&&0===this._h264Frame.negIndex(2)?this._h264Frame.length-=2:this._h264Frame.length-=1,this._state=3,this.writeBytes(t,e+2,n-2);if(n>2&&0===t[e]&&0===t[e+1]&&1===t[e+2])return this._state=3,this.writeBytes(t,e+3,n-3)}this._state=2;case 2:for(a=e,r=a+n,l=r-3;l>e;)if(t[e+2]>1)e+=3;else if(0!==t[e+1])e+=2;else if(0!==t[e])e+=1;else{if(1===t[e+2])return e>a&&this._h264Frame.writeBytes(t,a,e-a),this._state=3,e+=3,this.writeBytes(t,e,r-e);if(r-e>=4&&0===t[e+2]&&1===t[e+3])return e>a&&this._h264Frame.writeBytes(t,a,e-a),this._state=3,e+=4,this.writeBytes(t,e,r-e);e+=3}return this._state=1,void(this._h264Frame&&this._h264Frame.writeBytes(t,a,n));case 3:if(this._h264Frame)switch(this._nalUnitType){case i.seq_parameter_set_rbsp:this._h264Frame.endNalUnit(this._newExtraData.sps);break;case i.pic_parameter_set_rbsp:this._h264Frame.endNalUnit(this._newExtraData.pps);break;case i.slice_layer_without_partitioning_rbsp_idr:this._h264Frame.endNalUnit();break;default:this._h264Frame.endNalUnit()}return this._nalUnitType=31&t[e],this._h264Frame&&(this._nalUnitType===i.access_unit_delimiter_rbsp?this.finishFrame():this._nalUnitType===i.slice_layer_without_partitioning_rbsp_idr&&(this._h264Frame.keyFrame=!0)),this._h264Frame||(this._h264Frame=new s(s.VIDEO_TAG),this._h264Frame.pts=this._next_pts,this._h264Frame.dts=this._next_dts),this._h264Frame.startNalUnit(),this._state=2,this.writeBytes(t,e,n)}}}(this),function(t){var e=t.videojs.Hls.FlvTag,i=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3];t.videojs.Hls.AacStream=function(){var t,s,n,o,a,r,l,h,c,u,d,p,m;this.tags=[],this.setTimeStampOffset=function(t){o=t-1e3},this.setNextTimeStamp=function(e,i,o){t=e,n=i,o&&(s=0)},this.writeBytes=function(g,f,_){var v,b,y;for(f=f||0,_=_||0,_=_>n?n:_,n-=_,v=f+_;v>f;)switch(s){default:s=0;break;case 0:if(f>=v)return;if(255!==g[f])return console.assert(!1,"Error no ATDS header found"),f+=1,void(s=0);f+=1,s=1;break;case 1:if(f>=v)return;if(240!==(240&g[f]))return console.assert(!1,"Error no ATDS header found"),f+=1,void(s=0);a=!!(1&g[f]),f+=1,s=2;break;case 2:if(f>=v)return;r=((192&g[f])>>>6)+1,l=(60&g[f])>>>2,h=(1&g[f])<<2,f+=1,s=3;break;case 3:if(f>=v)return;h|=(192&g[f])>>>6,c=(3&g[f])<<11,f+=1,s=4;break;case 4:if(f>=v)return;c|=g[f]<<3,f+=1,s=5;break;case 5:if(f>=v)return;c|=(224&g[f])>>>5,c-=a?7:9,f+=1,s=6;break;case 6:if(f>=v)return;u=1024*((3&g[f])+1),d=1e3*u/i[l],b=r<<11|l<<7|h<<3,(b!==m||t-o>=1e3)&&(p=new e(e.METADATA_TAG),p.pts=t,p.dts=t,p.writeMetaDataDouble("audiocodecid",10),p.writeMetaDataBoolean("stereo",2===h),p.writeMetaDataDouble("audiosamplerate",i[l]),p.writeMetaDataDouble("audiosamplesize",16),this.tags.push(p),m=b,p=new e(e.AUDIO_TAG,!0),p.pts=t,p.dts=p.pts,p.view.setUint16(p.position,b),p.position+=2,p.length=Math.max(p.length,p.position),this.tags.push(p),o=t),f+=1,s=7;break;case 7:if(!a){if(2>v-f)return;f+=2}p=new e(e.AUDIO_TAG),p.pts=t,p.dts=t,s=8;break;case 8:for(;c;){if(f>=v)return;y=c>v-f?v-f:c,p.writeBytes(g,f,y),f+=y,c-=y}this.tags.push(p),s=0,t+=d}}}}(this),function(t,e,i){"use strict";var s,n=function(t,e,i){var s,n="";for(s=e;i>s;s++)n+="%"+("00"+t[s].toString(16)).slice(-2);return n},o=function(e,i,s){return t.decodeURIComponent(n(e,i,s))},a=function(e,i,s){return t.unescape(n(e,i,s))},r={TXXX:function(t){var e;if(3===t.data[0])for(e=1;e<t.data.length;e++)if(0===t.data[e]){t.description=o(t.data,1,e),t.value=o(t.data,e+1,t.data.length-1);break}},WXXX:function(t){var e;if(3===t.data[0])for(e=1;e<t.data.length;e++)if(0===t.data[e]){t.description=o(t.data,1,e),t.url=o(t.data,e+1,t.data.length);break}},PRIV:function(t){var e;for(e=0;e<t.data.length;e++)if(0===t.data[e]){t.owner=a(t.data,0,e);break}t.privateData=t.data.subarray(e+1)}};s=function(t){var i,n={debug:!(!t||!t.debug),descriptor:t&&t.descriptor},o=0,a=[],l=0;if(s.prototype.init.call(this),this.dispatchType=e.Hls.SegmentParser.STREAM_TYPES.metadata.toString(16),n.descriptor)for(i=0;i<n.descriptor.length;i++)this.dispatchType+=("00"+n.descriptor[i].toString(16)).slice(-2);this.push=function(t){var i,s,h,c,u;if(0===a.length&&(t.data.length<10||t.data[0]!=="I".charCodeAt(0)||t.data[1]!=="D".charCodeAt(0)||t.data[2]!=="3".charCodeAt(0)))return void(n.debug&&e.log("Skipping unrecognized metadata packet"));if(a.push(t),l+=t.data.byteLength,1===a.length&&(o=t.data[6]<<21|t.data[7]<<14|t.data[8]<<7|t.data[9],o+=10),!(o>l)){for(i={data:new Uint8Array(o),frames:[],pts:a[0].pts,dts:a[0].dts},u=0;o>u;)i.data.set(a[0].data,u),u+=a[0].data.byteLength,l-=a[0].data.byteLength,a.shift();s=10,64&i.data[5]&&(s+=4,s+=i.data[10]<<24|i.data[11]<<16|i.data[12]<<8|i.data[13],o-=i.data[16]<<24|i.data[17]<<16|i.data[18]<<8|i.data[19]);do{if(h=i.data[s+4]<<24|i.data[s+5]<<16|i.data[s+6]<<8|i.data[s+7],1>h)return e.log("Malformed ID3 frame encountered. Skipping metadata parsing.");c={id:String.fromCharCode(i.data[s],i.data[s+1],i.data[s+2],i.data[s+3]),data:i.data.subarray(s+10,s+h+10)},r[c.id]&&r[c.id](c),i.frames.push(c),s+=10,s+=h}while(o>s);this.trigger("data",i)}}},s.prototype=new e.Hls.Stream,e.Hls.MetadataStream=s}(e,e.videojs),function(t){var e,i,s=t.videojs,n=s.Hls.FlvTag,o=s.Hls.H264Stream,a=s.Hls.AacStream,r=s.Hls.MetadataStream;s.Hls.SegmentParser=function(){var t,l=this,h=new Uint8Array(e),c=0,u=new o,d=new a;l.stream={programMapTable:{}},l.metadataStream=new r,l.getFlvHeader=function(t,e,i){var s,o,a,r=new Uint8Array(9),l=new DataView(r.buffer);return t=t||0,e=void 0===e?!0:e,i=void 0===i?!0:i,l.setUint8(0,70),l.setUint8(1,76),l.setUint8(2,86),l.setUint8(3,1),l.setUint8(4,(e?4:0)|(i?1:0)),l.setUint32(5,r.byteLength),0>=t?(o=new Uint8Array(r.byteLength+4),o.set(r),o.set([0,0,0,0],r.byteLength),o):(s=new n(n.METADATA_TAG),s.pts=s.dts=0,s.writeMetaDataDouble("duration",t),a=s.finalize().length,o=new Uint8Array(r.byteLength+a),o.set(r),o.set(l.byteLength,a),o)},l.flushTags=function(){u.finishFrame()},l.tagsAvailable=function(){return u.tags.length+d.tags.length},l.getNextTag=function(){var t;return t=u.tags.length?d.tags.length&&d.tags[0].dts<u.tags[0].dts?d.tags.shift():u.tags.shift():d.tags.shift(),t.finalize()},l.parseSegmentBinaryData=function(i){var n,o=0;if(c>0){if(i.byteLength+c<e)return s.log("data.length + streamBuffer.length < MP2T_PACKET_LENGTH ??"),void h.readBytes(i,i.length,h.length);n=i.subarray(0,e-c),h.set(n,c),t(h),h=new Uint8Array(e),c=0}for(;;){for(;o<i.byteLength&&71!==i[o];)o++;if(i.byteLength-o<e)return void(i.byteLength-o>0&&(h.set(i.subarray(o),c),c+=i.byteLength-o));t(i.subarray(o,o+e))?o+=e:(s.log("error parsing m2ts packet, attempting to re-align"),o++)}},t=function(t){var n,o,a,r,h,c,p,m,g,f,_,v,b,y,w,x,C,k,S=0,T=S+e,E=!!(64&t[S+1]),P=(31&t[S+1])<<8|t[S+2],M=(48&t[S+3])>>>4;if(S+=4,M>1&&(S+=t[S]+1),0===P){if(E&&(S+=1+t[S]),n=t[S],0!==n&&s.log("the table_id of the PAT should be 0x00 but was"+n.toString(16)),o=!!(1&t[S+5]))for(a=(15&t[S+1])<<8|t[S+2],S+=8,c=S+(a-5-4);c>S;S+=4)if(r=t[S]<<8|t[S+1],h=(31&t[S+2])<<8|t[S+3],0===r)l.stream.networkPid=h;else if(void 0===l.stream.pmtPid)l.stream.pmtPid=h;else if(l.stream.pmtPid!==h)throw new Error("TS has more that 1 program")}else if(P===l.stream.programMapTable[i.h264]||P===l.stream.programMapTable[i.adts]||P===l.stream.programMapTable[i.metadata]){if(E){if(0!==t[S+0]||0!==t[S+1]||1!==t[S+2])throw new Error("PES did not begin with start code");p=t[S+4]<<8|t[S+5],m=0!==(4&t[S+6]),g=t[S+7],f=t[S+8],S+=9,192&g&&(_=(14&t[S+0])<<28|(255&t[S+1])<<21|(254&t[S+2])<<13|(255&t[S+3])<<6|(254&t[S+4])>>>2,_/=45,v=_,64&g&&(v=(14&t[S+5])<<28|(255&t[S+6])<<21|(254&t[S+7])<<13|(255&t[S+8])<<6|(254&t[S+9])>>>2,v/=45)),S+=f,P===l.stream.programMapTable[i.h264]?u.setNextTimeStamp(_,v,m):P===l.stream.programMapTable[i.adts]&&d.setNextTimeStamp(_,p,m)}P===l.stream.programMapTable[i.adts]?d.writeBytes(t,S,T-S):P===l.stream.programMapTable[i.h264]?u.writeBytes(t,S,T-S):P===l.stream.programMapTable[i.metadata]&&l.metadataStream.push({pts:_,dts:v,data:t.subarray(S)})}else if(l.stream.pmtPid===P){if(E&&(S+=1+t[S]),2!==t[S]&&s.log("The table_id of a PMT should be 0x02 but was "+t[S].toString(16)),b=!!(1&t[S+5]))for(l.stream.programMapTable={},w=(15&t[S+1])<<8|t[S+2],y=(15&t[S+10])<<8|t[S+11],w-=y,w-=13,l.stream.programMapTable.pcrPid=(31&t[S+8])<<8|t[S+9],S+=12+y;w>0;){if(x=t[S+0],C=(31&t[S+1])<<8|t[S+2],x===i.h264&&l.stream.programMapTable[x]&&l.stream.programMapTable[x]!==C)throw new Error("Program has more than 1 video stream");if(x===i.adts&&l.stream.programMapTable[x]&&l.stream.programMapTable[x]!==C)throw new Error("Program has more than 1 audio Stream");l.stream.programMapTable[x]=C,k=(15&t[S+3])<<8|t[S+4],x===i.metadata&&(l.metadataStream.descriptor=new Uint8Array(t.subarray(S+5,S+5+k))),S+=5+k,w-=5+k}}else l.stream.networkPid===P||17===P||8191===P||l.stream.programMapTable.pcrPid||s.log("Unknown PID parsing TS packet: "+P);return!0},l.getTags=function(){return u.tags},l.stats={h264Tags:function(){return u.tags.length},minVideoPts:function(){return u.tags[0].pts},maxVideoPts:function(){return u.tags[u.tags.length-1].pts},aacTags:function(){return d.tags.length},minAudioPts:function(){return d.tags[0].pts},maxAudioPts:function(){return d.tags[d.tags.length-1].pts}}},s.Hls.SegmentParser.MP2T_PACKET_LENGTH=e=188,s.Hls.SegmentParser.STREAM_TYPES=i={h264:27,adts:15,metadata:21}}(e),function(t,i,s,n,o){var a,r,l,h=function(){},c=function(){var t="[^=]*",e='"[^"]*"|[^,]*',i="(?:"+t+")=(?:"+e+")";return new RegExp("(?:^|,)("+i+")")}(),u=function(t){for(var e,i=t.split(c),s=i.length,n={};s--;)""!==i[s]&&(e=/([^=]*)=(.*)/.exec(i[s]).slice(1),e[0]=e[0].replace(/^\s+|\s+$/g,""),e[1]=e[1].replace(/^\s+|\s+$/g,""),e[1]=e[1].replace(/^['"](.*)['"]$/g,"$1"),n[e[0]]=e[1]);return n},d=t.Hls.Stream;a=function(){var t="";a.prototype.init.call(this),this.push=function(e){var i;for(t+=e,i=t.indexOf("\n");i>-1;i=t.indexOf("\n"))this.trigger("data",t.substring(0,i)),t=t.substring(i+1)}},a.prototype=new d,r=function(){r.prototype.init.call(this)},r.prototype=new d,r.prototype.push=function(t){var e,s;return t=t.replace(/^\s+|\s+$/g,""),0!==t.length?"#"!==t[0]?void this.trigger("data",{type:"uri",uri:t}):0!==t.indexOf("#EXT")?void this.trigger("data",{type:"comment",text:t.slice(1)}):(t=t.replace("\r",""),(e=/^#EXTM3U/.exec(t))?void this.trigger("data",{type:"tag",tagType:"m3u"}):(e=/^#EXTINF:?([0-9\.]*)?,?(.*)?$/.exec(t))?(s={type:"tag",tagType:"inf"},e[1]&&(s.duration=parseFloat(e[1])),e[2]&&(s.title=e[2]),void this.trigger("data",s)):(e=/^#EXT-X-TARGETDURATION:?([0-9.]*)?/.exec(t))?(s={type:"tag",tagType:"targetduration"},e[1]&&(s.duration=i(e[1],10)),void this.trigger("data",s)):(e=/^#ZEN-TOTAL-DURATION:?([0-9.]*)?/.exec(t))?(s={type:"tag",tagType:"totalduration"},e[1]&&(s.duration=i(e[1],10)),void this.trigger("data",s)):(e=/^#EXT-X-VERSION:?([0-9.]*)?/.exec(t))?(s={type:"tag",tagType:"version"},e[1]&&(s.version=i(e[1],10)),void this.trigger("data",s)):(e=/^#EXT-X-MEDIA-SEQUENCE:?(\-?[0-9.]*)?/.exec(t))?(s={type:"tag",tagType:"media-sequence"},e[1]&&(s.number=i(e[1],10)),void this.trigger("data",s)):(e=/^#EXT-X-DISCONTINUITY-SEQUENCE:?(\-?[0-9.]*)?/.exec(t))?(s={type:"tag",tagType:"discontinuity-sequence"},e[1]&&(s.number=i(e[1],10)),void this.trigger("data",s)):(e=/^#EXT-X-PLAYLIST-TYPE:?(.*)?$/.exec(t))?(s={type:"tag",tagType:"playlist-type"},e[1]&&(s.playlistType=e[1]),void this.trigger("data",s)):(e=/^#EXT-X-BYTERANGE:?([0-9.]*)?@?([0-9.]*)?/.exec(t))?(s={type:"tag",tagType:"byterange"},e[1]&&(s.length=i(e[1],10)),e[2]&&(s.offset=i(e[2],10)),void this.trigger("data",s)):(e=/^#EXT-X-ALLOW-CACHE:?(YES|NO)?/.exec(t))?(s={type:"tag",tagType:"allow-cache"},e[1]&&(s.allowed=!/NO/.test(e[1])),void this.trigger("data",s)):(e=/^#EXT-X-STREAM-INF:?(.*)$/.exec(t))?(s={type:"tag",tagType:"stream-inf"},e[1]&&(s.attributes=u(e[1]),s.attributes.RESOLUTION&&!function(){var t=s.attributes.RESOLUTION.split("x"),e={};t[0]&&(e.width=i(t[0],10)),t[1]&&(e.height=i(t[1],10)),s.attributes.RESOLUTION=e}(),s.attributes.BANDWIDTH&&(s.attributes.BANDWIDTH=i(s.attributes.BANDWIDTH,10)),s.attributes["PROGRAM-ID"]&&(s.attributes["PROGRAM-ID"]=i(s.attributes["PROGRAM-ID"],10))),void this.trigger("data",s)):(e=/^#EXT-X-ENDLIST/.exec(t))?void this.trigger("data",{type:"tag",tagType:"endlist"}):(e=/^#EXT-X-DISCONTINUITY/.exec(t))?void this.trigger("data",{type:"tag",tagType:"discontinuity"}):(e=/^#EXT-X-KEY:?(.*)$/.exec(t))?(s={type:"tag",tagType:"key"},e[1]&&(s.attributes=u(e[1]),s.attributes.IV&&("0x"===s.attributes.IV.substring(0,2)&&(s.attributes.IV=s.attributes.IV.substring(2)),s.attributes.IV=s.attributes.IV.match(/.{8}/g),s.attributes.IV[0]=i(s.attributes.IV[0],16),s.attributes.IV[1]=i(s.attributes.IV[1],16),s.attributes.IV[2]=i(s.attributes.IV[2],16),s.attributes.IV[3]=i(s.attributes.IV[3],16),s.attributes.IV=new Uint32Array(s.attributes.IV))),void this.trigger("data",s)):void this.trigger("data",{type:"tag",data:t.slice(4,t.length)})):void 0},l=function(){var t,e=this,i=[],c={};l.prototype.init.call(this),this.lineStream=new a,this.parseStream=new r,this.lineStream.pipe(this.parseStream),this.manifest={allowCache:!0,discontinuityStarts:[]},this.parseStream.on("data",function(a){({tag:function(){(({"allow-cache":function(){this.manifest.allowCache=a.allowed,"allowed"in a||(this.trigger("info",{message:"defaulting allowCache to YES"}),this.manifest.allowCache=!0)},byterange:function(){var t={};"length"in a&&(c.byterange=t,t.length=a.length,"offset"in a||(this.trigger("info",{message:"defaulting offset to zero"}),a.offset=0)),"offset"in a&&(c.byterange=t,t.offset=a.offset)},endlist:function(){this.manifest.endList=!0},inf:function(){"mediaSequence"in this.manifest||(this.manifest.mediaSequence=0,this.trigger("info",{message:"defaulting media sequence to zero"})),"discontinuitySequence"in this.manifest||(this.manifest.discontinuitySequence=0,this.trigger("info",{message:"defaulting discontinuity sequence to zero"})),a.duration>=0&&(c.duration=a.duration),this.manifest.segments=i},key:function(){return a.attributes?"NONE"===a.attributes.METHOD?void(t=null):a.attributes.URI?(a.attributes.METHOD||this.trigger("warn",{message:"defaulting key method to AES-128"}),t={method:a.attributes.METHOD||"AES-128",uri:a.attributes.URI},void(a.attributes.IV!==o&&(t.iv=a.attributes.IV))):void this.trigger("warn",{message:"ignoring key declaration without URI"}):void this.trigger("warn",{message:"ignoring key declaration without attribute list"})},"media-sequence":function(){return s(a.number)?void(this.manifest.mediaSequence=a.number):void this.trigger("warn",{message:"ignoring invalid media sequence: "+a.number})},"discontinuity-sequence":function(){return s(a.number)?void(this.manifest.discontinuitySequence=a.number):void this.trigger("warn",{message:"ignoring invalid discontinuity sequence: "+a.number})},"playlist-type":function(){return/VOD|EVENT/.test(a.playlistType)?void(this.manifest.playlistType=a.playlistType):void this.trigger("warn",{message:"ignoring unknown playlist type: "+a.playlist})},"stream-inf":function(){return this.manifest.playlists=i,a.attributes?(c.attributes||(c.attributes={}),void(c.attributes=n(c.attributes,a.attributes))):void this.trigger("warn",{message:"ignoring empty stream-inf attributes"})},discontinuity:function(){c.discontinuity=!0,this.manifest.discontinuityStarts.push(i.length)},targetduration:function(){return!s(a.duration)||a.duration<0?void this.trigger("warn",{message:"ignoring invalid target duration: "+a.duration}):void(this.manifest.targetDuration=a.duration)},totalduration:function(){return!s(a.duration)||a.duration<0?void this.trigger("warn",{message:"ignoring invalid total duration: "+a.duration}):void(this.manifest.totalDuration=a.duration)}})[a.tagType]||h).call(e)},uri:function(){c.uri=a.uri,i.push(c),!this.manifest.targetDuration||"duration"in c||(this.trigger("warn",{message:"defaulting segment duration to the target duration"}),c.duration=this.manifest.targetDuration),t&&(c.key=t),c={}},comment:function(){}})[a.type].call(e)})},l.prototype=new d,l.prototype.push=function(t){this.lineStream.push(t)},l.prototype.end=function(){this.lineStream.push("\n")},e.videojs.m3u8={LineStream:a,ParseStream:r,Parser:l}}(e.videojs,e.parseInt,e.isFinite,e.videojs.util.mergeOptions),function(t){t.Hls.xhr=function(i,s){var n,o,a={method:"GET",timeout:45e3};return"function"!=typeof s&&(s=function(){}),"object"==typeof i&&(a=t.util.mergeOptions(a,i),i=a.url),n=new e.XMLHttpRequest,n.open(a.method,i),n.url=i,n.requestTime=(new Date).getTime(),a.responseType&&(n.responseType=a.responseType),a.withCredentials&&(n.withCredentials=!0),a.timeout&&(o=e.setTimeout(function(){4!==n.readyState&&(n.timedout=!0,n.abort())},a.timeout)),n.onreadystatechange=function(){return 4===this.readyState?(e.clearTimeout(o),n.timedout?s.call(this,"timeout",i):this.status>=400||0===this.status?s.call(this,!0,i):(this.response&&(this.responseTime=(new Date).getTime(),this.roundTripTime=this.responseTime-this.requestTime,this.bytesReceived=this.response.byteLength||this.response.length,this.bandwidth=Math.floor(this.bytesReceived/this.roundTripTime*8*1e3)),s.call(this,!1,i))):void 0},n.send(null),n}}(e.videojs),function(t,e){"use strict";var i,s,n,o,a,r,l,h,c=10;a=function(t,e){return t=isFinite(t)?t:1/0,e=isFinite(e)?e:1/0,Math.min(t,e)},r=function(t,e){return t=isFinite(t)?t:-(1/0),e=isFinite(e)?e:-(1/0),Math.max(t,e)},s=function(t,e){return t-e},i=function(t,e,i,n){var o,a=[],r=(t.discontinuityStarts||[]).concat(i),h=0;if(e>=i)return 0;for(r.sort(s),
o=0;o<r.length;o++)if(r[o]>e){a.push({start:e,end:r[o]}),o++;break}for(;o<r.length;o++){if(r[o]>=i){a.push({start:r[o-1],end:i});break}a.push({start:a[a.length-1].end,end:r[o]})}for(o=0;o<a.length;o++)h+=l(t,a[o],o===a.length-1&&n);return h},l=function(t,e,i){var s,n,o,l=0,h=t.targetDuration||c;for(n=e.start;n<e.end&&(s=t.segments[n],void 0===s.minVideoPts&&void 0===s.minAudioPts);n++)l+=s.duration||h;if(i&&(s=t.segments[e.end],s&&(void 0!==s.minVideoPts||void 0!==s.minAudioPts)))return l+=.001*(a(s.minVideoPts,s.minAudioPts)-a(t.segments[n].minVideoPts,t.segments[n].minAudioPts));for(o=e.end-1;o>=n&&(s=t.segments[o],void 0===s.maxVideoPts&&void 0===s.maxAudioPts);o--)l+=s.duration||h;return o>=n&&(l+=.001*(r(t.segments[o].maxVideoPts,t.segments[o].maxAudioPts)-a(t.segments[n].minVideoPts,t.segments[n].minAudioPts))),l},o=function(t,e,s,n){var o,a,l=0;return void 0===e&&(e=t.mediaSequence||0),void 0===s&&(s=e+(t.segments||[]).length),o=t.targetDuration||c,a=r(t.mediaSequence-e,0),l+=a*o,l+=i(t,e+a-t.mediaSequence,s-t.mediaSequence,n)},n=function(e,i,s,n){if(!e)return 0;if(void 0===n&&(n=!0),void 0===i&&void 0===s){if(e.totalDuration)return e.totalDuration;if(!e.endList)return t.Infinity}return o(e,i,s,n)},h=function(t){var i,s,r,l,h,u,d;if(!t.segments)return e.createTimeRange();if(t.endList)return e.createTimeRange(0,n(t));if(i=0,s=o(t,t.mediaSequence,t.mediaSequence+t.segments.length),l=t.targetDuration||c,!t.endList)for(r=l*e.Hls.LIVE_SYNC_DURATION_COUNT,d=t.segments.length-1;d>=0&&r>0;d--)h=t.segments[d],u=a(n(t,t.mediaSequence+d,t.mediaSequence+d+1),r),r-=u,s-=u;return e.createTimeRange(i,s)},e.Hls.Playlist={duration:n,seekable:h}}(e,e.videojs),function(t,e){"use strict";var i=e.Hls.resolveUrl,s=e.Hls.xhr,n=e.Hls.Playlist,o=e.util.mergeOptions,a=function(t,e){var i,s,n=!1,a=o(t,{});for(i=t.playlists.length;i--;)if(s=a.playlists[i],s.uri===e.uri){if(s.segments&&e.segments&&s.segments.length===e.segments.length&&s.mediaSequence===e.mediaSequence)continue;a.playlists[i]=o(s,e),a.playlists[e.uri]=a.playlists[i],s.segments&&(a.playlists[i].segments=r(s.segments,e.segments,e.mediaSequence-s.mediaSequence)),n=!0}return n?a:null},r=function(t,e,i){var s,n,a=e.slice();for(i=i||0,s=Math.min(t.length,e.length+i),n=i;s>n;n++)a[n-i]=o(t[n],a[n-i]);return a},l=function(n,o){var r,h,c,u,d=this;if(l.prototype.init.call(this),!n)throw new Error("A non-empty playlist URL is required");u=function(i,s,n){var o,r,l;return d.setBandwidth(c||s),c=null,i?(d.error={status:s.status,message:"HLS playlist request error at URL: "+n,responseText:s.responseText,code:s.status>=500?4:2},d.trigger("error")):(d.state="HAVE_METADATA",o=new e.m3u8.Parser,o.push(s.responseText),o.end(),o.manifest.uri=n,l=a(d.master,o.manifest),r=1e3*(o.manifest.targetDuration||10),l?(d.master=l,d.updateMediaPlaylist_(o.manifest)):r/=2,d.media().endList||(t.clearTimeout(h),h=t.setTimeout(function(){d.trigger("mediaupdatetimeout")},r)),void d.trigger("loadedplaylist"))},d.state="HAVE_NOTHING",d.expiredPostDiscontinuity_=0,d.expiredPreDiscontinuity_=0,r=this.dispose,d.dispose=function(){c&&(c.onreadystatechange=null,c.abort(),c=null),t.clearTimeout(h),r.call(this)},d.media=function(t){var e=!1;if(!t)return d.media_;if("HAVE_NOTHING"===d.state||"HAVE_MASTER"===d.state)throw new Error("Cannot switch media playlist from "+d.state);if("string"==typeof t){if(!d.master.playlists[t])throw new Error("Unknown playlist URI: "+t);t=d.master.playlists[t]}if(e=t.uri!==d.media_.uri,d.master.playlists[t.uri].endList)return c&&(c.onreadystatechange=null,c.abort(),c=null),d.state="HAVE_METADATA",d.media_=t,void(e&&d.trigger("mediachange"));if(e){if(d.state="SWITCHING_MEDIA",c){if(i(d.master.uri,t.uri)===c.url)return;c.onreadystatechange=null,c.abort(),c=null}c=s({url:i(d.master.uri,t.uri),withCredentials:o},function(e){u(e,this,t.uri),d.trigger("mediachange")})}},d.setBandwidth=function(t){d.bandwidth=t.bandwidth},d.on("mediaupdatetimeout",function(){"HAVE_METADATA"===d.state&&(d.state="HAVE_CURRENT_METADATA",c=s({url:i(d.master.uri,d.media().uri),withCredentials:o},function(t){u(t,this,d.media().uri)}))}),s({url:n,withCredentials:o},function(a){var r,l;if(a)return d.error={status:this.status,message:"HLS playlist request error at URL: "+n,responseText:this.responseText,code:2},d.trigger("error");if(r=new e.m3u8.Parser,r.push(this.responseText),r.end(),d.state="HAVE_MASTER",r.manifest.uri=n,r.manifest.playlists){for(d.master=r.manifest,l=d.master.playlists.length;l--;)d.master.playlists[d.master.playlists[l].uri]=d.master.playlists[l];return c=s({url:i(n,r.manifest.playlists[0].uri),withCredentials:o},function(t){u(t,this,r.manifest.playlists[0].uri),t||d.trigger("loadedmetadata")}),d.trigger("loadedplaylist")}return d.master={uri:t.location.href,playlists:[{uri:n}]},d.master.playlists[n]=d.master.playlists[0],u(null,this,n),d.trigger("loadedmetadata")})};l.prototype=new e.Hls.Stream,l.prototype.updateMediaPlaylist_=function(t){var e,i,s;if(this.media_){if(i=t.mediaSequence-this.media_.mediaSequence,e=this.media_.mediaSequence,this.media_.discontinuitySequence!==t.discontinuitySequence)for(s=i;s--;)if(this.media_.segments[s].discontinuity){e=s+this.media_.mediaSequence,this.expiredPreDiscontinuity_+=this.expiredPostDiscontinuity_,this.expiredPostDiscontinuity_=0;break}this.expiredPreDiscontinuity_+=n.duration(this.media_,this.media_.mediaSequence,e),this.expiredPostDiscontinuity_+=n.duration(this.media_,e,t.mediaSequence)}this.media_=this.master.playlists[t.uri]},l.prototype.getMediaIndexForTime_=function(t){var e;if(!this.media_)return 0;if(t-=this.expiredPreDiscontinuity_+this.expiredPostDiscontinuity_,0>t)return 0;for(e=0;e<this.media_.segments.length;e++)if(t-=n.duration(this.media_,this.media_.mediaSequence+e,this.media_.mediaSequence+e+1,!1),0>=t)return e;return this.media_.segments.length-1},e.Hls.PlaylistLoader=l}(e,e.videojs),function i(e,s,n){function o(r,l){if(!s[r]){if(!e[r]){var h="function"==typeof t&&t;if(!l&&h)return h(r,!0);if(a)return a(r,!0);throw new Error("Cannot find module '"+r+"'")}var c=s[r]={exports:{}};e[r][0].call(c.exports,function(t){var i=e[r][1][t];return o(i?i:t)},c,c.exports,i,e,s,n)}return s[r].exports}for(var a="function"==typeof t&&t,r=0;r<n.length;r++)o(n[r]);return o}({1:[function(t,i,s){(function(e){e.window.pkcs7={unpad:t("./unpad")}}).call(this,"undefined"!=typeof self?self:"undefined"!=typeof e?e:{})},{"./unpad":2}],2:[function(t,e,i){"use strict";e.exports=function(t){return t.subarray(0,t.byteLength-t[t.byteLength-1])}},{}]},{},[1]),function(t,e,i){"use strict";var s,n,o,a,r;r=function(t){return t<<24|(65280&t)<<8|(16711680&t)>>8|t>>>24},s=function(t){this._precompute();var e,i,s,n,o,a=this._tables[0][4],r=this._tables[1],l=t.length,h=1;if(4!==l&&6!==l&&8!==l)throw new Error("Invalid aes key size");for(n=t.slice(0),o=[],this._key=[n,o],e=l;4*l+28>e;e++)s=n[e-1],(e%l===0||8===l&&e%l===4)&&(s=a[s>>>24]<<24^a[s>>16&255]<<16^a[s>>8&255]<<8^a[255&s],e%l===0&&(s=s<<8^s>>>24^h<<24,h=h<<1^283*(h>>7))),n[e]=n[e-l]^s;for(i=0;e;i++,e--)s=n[3&i?e:e-4],4>=e||4>i?o[i]=s:o[i]=r[0][a[s>>>24]]^r[1][a[s>>16&255]]^r[2][a[s>>8&255]]^r[3][a[255&s]]},s.prototype={_tables:[[[],[],[],[],[]],[[],[],[],[],[]]],_precompute:function(){var t,e,i,s,n,o,a,r,l,h=this._tables[0],c=this._tables[1],u=h[4],d=c[4],p=[],m=[];for(t=0;256>t;t++)m[(p[t]=t<<1^283*(t>>7))^t]=t;for(e=i=0;!u[e];e^=s||1,i=m[i]||1)for(a=i^i<<1^i<<2^i<<3^i<<4,a=a>>8^255&a^99,u[e]=a,d[a]=e,o=p[n=p[s=p[e]]],l=16843009*o^65537*n^257*s^16843008*e,r=257*p[a]^16843008*a,t=0;4>t;t++)h[t][e]=r=r<<24^r>>>8,c[t][a]=l=l<<24^l>>>8;for(t=0;5>t;t++)h[t]=h[t].slice(0),c[t]=c[t].slice(0)},decrypt:function(t,e,i,s,n,o){var a,r,l,h,c=this._key[1],u=t^c[0],d=s^c[1],p=i^c[2],m=e^c[3],g=c.length/4-2,f=4,_=this._tables[1],v=_[0],b=_[1],y=_[2],w=_[3],x=_[4];for(h=0;g>h;h++)a=v[u>>>24]^b[d>>16&255]^y[p>>8&255]^w[255&m]^c[f],r=v[d>>>24]^b[p>>16&255]^y[m>>8&255]^w[255&u]^c[f+1],l=v[p>>>24]^b[m>>16&255]^y[u>>8&255]^w[255&d]^c[f+2],m=v[m>>>24]^b[u>>16&255]^y[d>>8&255]^w[255&p]^c[f+3],f+=4,u=a,d=r,p=l;for(h=0;4>h;h++)n[(3&-h)+o]=x[u>>>24]<<24^x[d>>16&255]<<16^x[p>>8&255]<<8^x[255&m]^c[f++],a=u,u=d,d=p,p=m,m=a}},a=function(t,e,i){var n,o,a,l,h,c,u,d,p,m=new Int32Array(t.buffer,t.byteOffset,t.byteLength>>2),g=new s(Array.prototype.slice.call(e)),f=new Uint8Array(t.byteLength),_=new Int32Array(f.buffer);for(n=i[0],o=i[1],a=i[2],l=i[3],p=0;p<m.length;p+=4)h=r(m[p]),c=r(m[p+1]),u=r(m[p+2]),d=r(m[p+3]),g.decrypt(h,c,u,d,_,p),_[p]=r(_[p]^n),_[p+1]=r(_[p+1]^o),_[p+2]=r(_[p+2]^a),_[p+3]=r(_[p+3]^l),n=h,o=c,a=u,l=d;return f},n=function(){this.jobs=[],this.delay=1,this.timeout_=null},n.prototype=new e.Hls.Stream,n.prototype.processJob_=function(){this.jobs.shift()(),this.jobs.length?this.timeout_=setTimeout(e.bind(this,this.processJob_),this.delay):this.timeout_=null},n.prototype.push=function(t){this.jobs.push(t),this.timeout_||(this.timeout_=setTimeout(e.bind(this,this.processJob_),this.delay))},o=function(t,e,s,a){var l=o.STEP,h=new Int32Array(t.buffer),c=new Uint8Array(t.byteLength),u=0;for(this.asyncStream_=new n,this.asyncStream_.push(this.decryptChunk_(h.subarray(u,u+l),e,s,c,u)),u=l;u<h.length;u+=l)s=new Uint32Array([r(h[u-4]),r(h[u-3]),r(h[u-2]),r(h[u-1])]),this.asyncStream_.push(this.decryptChunk_(h.subarray(u,u+l),e,s,c));this.asyncStream_.push(function(){a(null,i(c))})},o.prototype=new e.Hls.Stream,o.prototype.decryptChunk_=function(t,e,i,s){return function(){var n=a(t,e,i);s.set(n,t.byteOffset)}},o.STEP=32e3,e.Hls.decrypt=a,e.Hls.Decrypter=o,e.Hls.AsyncStream=n}(e,e.videojs,e.pkcs7.unpad)}).call(e)}},{"./unpad":443}],445:[function(t,e,i){e.exports=function(t){var e,i=0,s=t.MediaSource||t.WebKitMediaSource||{},n=t.URL||{},o=/video\/flv(;\s*codecs=["']vp6,aac["'])?$/,a="blob:vjs-media-source/";e=function(){},e.prototype.init=function(){this.listeners=[]},e.prototype.addEventListener=function(t,e){this.listeners[t]||(this.listeners[t]=[]),this.listeners[t].unshift(e)},e.prototype.removeEventListener=function(t,e){for(var i=this.listeners[t],s=i.length;s--;)if(i[s]===e)return i.splice(s,1)},e.prototype.trigger=function(t){for(var e=this.listeners[t.type]||[],i=e.length;i--;)e[i](t)},videojs.MediaSource=function(){var t=this;videojs.MediaSource.prototype.init.call(this),this.sourceBuffers=[],this.readyState="closed",this.listeners={sourceopen:[function(e){t.swfObj=document.getElementById(e.swfId),t.readyState="open",t.swfObj&&t.swfObj.vjs_load()}],webkitsourceopen:[function(e){t.trigger({type:"sourceopen"})}]}},videojs.MediaSource.prototype=new e,videojs.MediaSource.BYTES_PER_SECOND_GOAL=4194304,videojs.MediaSource.TICKS_PER_SECOND=60,videojs.MediaSource.prototype.addSourceBuffer=function(t){var e;if(o.test(t))e=new videojs.SourceBuffer(this);else{if(!this.nativeSource)throw new Error("NotSupportedError (Video.js)");e=this.nativeSource.addSourceBuffer.apply(this.nativeSource,arguments)}return this.sourceBuffers.push(e),e},videojs.MediaSource.prototype.endOfStream=function(){this.readyState="ended"},videojs.mediaSources={},videojs.MediaSource.open=function(t,e){var i=videojs.mediaSources[t];if(!i)throw new Error("Media Source not found (Video.js)");i.trigger({type:"sourceopen",swfId:e})},videojs.SourceBuffer=function(e){var i=this,s=[],n=0,o=function(e){t.setTimeout(e,Math.ceil(1e3/videojs.MediaSource.TICKS_PER_SECOND))},a=function(){var e,r,l,h,c,u="";if(s.length){for(c=document.hidden?videojs.MediaSource.BYTES_PER_SECOND_GOAL:Math.ceil(videojs.MediaSource.BYTES_PER_SECOND_GOAL/videojs.MediaSource.TICKS_PER_SECOND),h=new Uint8Array(Math.min(c,n)),r=h.byteLength;r;)e=s[0].subarray(0,r),h.set(e,h.byteLength-r),e.byteLength<s[0].byteLength?s[0]=s[0].subarray(r):s.shift(),r-=e.byteLength;for(n-=h.byteLength,r=0,l=h.byteLength;l>r;r++)u+=String.fromCharCode(h[r]);b64str=t.btoa(u),i.source.swfObj.CallFunction('<invoke name="vjs_appendBuffer"returntype="javascript"><arguments><string>'+b64str+"</string></arguments></invoke>"),0!==n?o(a):(i.updating=!1,i.trigger({type:"updateend"}),"ended"===i.source.readyState&&i.source.swfObj.vjs_endOfStream())}};videojs.SourceBuffer.prototype.init.call(this),this.source=e,this.updating=!1,this.appendBuffer=function(t){var e;if(this.updating)throw e=new Error("SourceBuffer.append() cannot be called while an update is in progress"),e.name="InvalidStateError",e.code=11,e;0===s.length&&o(a),this.updating=!0,this.source.readyState="open",this.trigger({type:"update"}),s.push(t),n+=t.byteLength},this.abort=function(){s=[],n=0,this.source.swfObj.vjs_abort(),this.updating&&(this.updating=!1,this.trigger({type:"updateend"}))}},videojs.SourceBuffer.prototype=new e,videojs.URL={createObjectURL:function(t){var e=a+i;return i++,videojs.mediaSources[e]=t,e}},videojs.plugin("mediaSource",function(t){var e=this;e.on("loadstart",function(){var t,i=e.currentSrc(),o=function(e){t.trigger(e)};"Html5"===e.techName&&0===i.indexOf(a)&&(t=videojs.mediaSources[i],t.nativeUrl||(t.nativeSource=new s,t.nativeSource.addEventListener("sourceopen",o,!1),t.nativeSource.addEventListener("webkitsourceopen",o,!1),t.nativeUrl=n.createObjectURL(t.nativeSource)),e.src(t.nativeUrl))})})}},{}],446:[function(t,e,i){"use strict";var s=t("lodash"),n=t("jquery"),o=t("scrollmonitor"),a=t("fastdom"),r=t("prima/class"),l=t("prima/mixins/accessor"),h=t("prima/lib/flags"),c=t("prima/events"),u=t("prima/utils/caniuse"),d=t("./plugins/videojs-crt"),p=r.extend({mixins:[l],defaults:{loaded:!1,paused:!0,muted:!1,autoplay:!1,_preload:!1,_preloadThreshold:10,loop:!0,autoheight:!1,watch:!0,duration:0,hideFullscreen:!1,_elapsed:0,_position:0,_startSeekJumpTime:null,minLoopDuration:1},classNames:{base:"crt-video crt-skin-default",autoplay:"crt-state-autoplaying",autoheight:"crt-autoheight",hideFullscreen:"crt-hide-fullscreen-toggle"},constructor:function(t,e){this._id=s.uniqueId("crtplayer"),this.initialize(t,e)},initialize:function(t,e){e||(e={}),s.isObject(e.attributes)&&this.set(e.attributes),this.video=t,this.$video=n(this.video);var i=this.$video.data("crt-options")||{};this.$video.removeAttr("data-crt-options"),this.vjsOptions=s.defaults({crt:this,crtOptions:i},e.vjsOptions||{}),i&&i.duration&&this.set("duration",i.duration),a.write(function(){this.$video.addClass(this.classNames.base)},this)},render:function(){return a.write(function(){d(this.video,this.vjsOptions).then(s.bind(this.ready,this))},this),this},ready:function(t){this.player=t,this.el=t.player_.el(),this.$el=n(this.el),this.$post=this.$el.closest(".post, .video-ad"),this.playerID=this.player.id_,this.hasLooped=!1,this._bindEvents(),this.setAutoplayState(this.shouldAutoplay()),this.setMutedState(this.shouldAutoplay()),this.setLoopState(!0),this.setAutoheightState(s.get(this.vjsOptions,"crtOptions.autoheight")),this.setFullscreenControl(!u.prop("requestFullscreen")),this.shouldForceHD()&&this.player.src({src:this.vjsOptions.crtOptions.hdUrl,type:"video/mp4"}),this.get("watch")&&this.setupWatcher(),c.trigger("CrtPlayer:ready",this),this.trigger("ready",this)},_bindEvents:function(){this.listenTo(c,"peepr:open",this.pause),this.listenTo(c,"post:form:show",this.pause),this.listenTo(c,"post:docked:afterRender",this.onDockedAfterRender),this.on("change:autoplay",this.onChangeAutoplay,this),this.on("change:autoheight",this.onChangeAutoheight,this),this.on("change:duration",this.onChangeDuration,this),this.on("change:loop",this.onChangeLoop,this),this.on("change:muted",this.onChangeMuted,this),this.player.on("loadedmetadata",s.bind(this.onLoadedMetadata,this)),this.player.on("durationchange",s.bind(this.onUpdateDuration,this)),this.player.on("play",s.bind(this.onPlay,this)),this.player.on("pause",s.bind(this.onPause,this)),this.player.on("ended",s.bind(this.onEnded,this)),this.player.on("fullscreenchange",s.bind(this.onFullscreenChange,this)),this.player.on("error",s.bind(this.onError,this))},setupWatcher:function(){this.watcher=o.create(this.el,-100),this.watcher.fullyEnterViewport(s.bind(function(){this.trigger("fullyEnterViewport")},this)),this.watcher.partiallyExitViewport(s.bind(function(){this.trigger("partiallyExitViewport")},this)),this.watcher.exitViewport(s.bind(function(){this.trigger("exitViewport"),this.shouldAutoplay()&&this.pause()},this)),this.shouldAutoplay()&&this.$el.on("click.crtAutoPlay touchend.crtAutoPlay",s.bind(this.onClickPlayer,this))},onClickPlayer:function(t){n(t.target).closest(".vjs-mute-control").length||n(t.target).closest(".vjs-fullscreen-control").length?this.restart():this.pause(),this.set("autoplay",!1),this.set("muted",!1),this.$el.off("click.crtAutoPlay touchend.crtAutoPlay")},restart:function(){this.get("autoplay")&&(this.set("autoplay",!1),this.set("muted",!1),this.onTimeUpdate(),this.player.trigger({type:"restart",start:this.player.currentTime(),end:0}),this.player.currentTime(0))},pollTimeUpdate:function(){this.get("paused")||(this.onTimeUpdate(),setTimeout(s.bind(this.pollTimeUpdate,this),150))},shouldAutoplay:function(){return this.get("autoplay")&&!h.bool("is_mobile")&&this.get("duration")>this.get("minLoopDuration")&&this.$el.is(":visible")},shouldForceHD:function(){return!(!this.vjsOptions.forceHD||!this.vjsOptions.crtOptions.hdUrl)},play:function(t){t||(t={}),this.player.paused()&&(this.player.play(),t.skipLog||(t.type="userPlay",this.player.trigger(t)))},pause:function(t){t||(t={}),this.player.paused()||(this.player.pause(),t.skipLog||this.player.trigger("userPause"))},onPlay:function(){this.set("paused",!1),this.pollTimeUpdate()},onPause:function(){this.set("paused",!0)},onUpdateDuration:function(t){this.get("duration")||this.set("duration",this.player.duration())},onLoadedMetadata:function(t){this.set("loaded",!0)},onEnded:function(t){this.get("loop")===!0?(this.play({skipLog:!0}),this.player.trigger("looped"),this.get("autoplay")||this.hasLooped||(this.hasLooped=!0)):(this.pause({skipLog:!0}),this.player.trigger("videoEnded"))},onError:function(t){this.set("paused",!0),this.set("loop",!1),this.set("autoplay",!1)},onChangeAutoplay:function(t,e,i){this.setAutoplayState(e,i)},onChangeAutoheight:function(t,e){this.setAutoheightState(e)},onChangeDuration:function(t,e){this.setLoopState(!0)},onChangeLoop:function(t,e){this.setLoopState(e)},onChangeMuted:function(t,e){this.player.muted(e)},onFullscreenChange:function(){this.$post.hasClass("docked")&&(this.player.isFullscreen()?(this.cached_top=this.$el.position().top,this.$el.css("top",0)):this.$el.css("top",this.cached_top))},onDockedAfterRender:function(t){s.isEmpty(t.embedID)||this.playerID===t.embedID&&this.player.trigger("CRTPlayer:updateDimensions")},setLoopState:function(t){s.isUndefined(t)&&(t=this.get("loop")),this.set("loop",t),"undefined"!=typeof this.get("duration")&&this.get("duration")<=this.get("minLoopDuration")&&this.set("loop",!1)},setMutedState:function(t){s.isUndefined(t)&&(t=this.get("muted")),this.set("muted",t)},setAutoplayState:function(t){s.isUndefined(t)&&(t=this.get("autoplay")),this.set("autoplay",t),this.toggleAttrClass("autoplay",t),!t&&this.get("duration")&&this.setLoopState(!0)},setAutoheightState:function(t){(s.isUndefined(t)||s.isNull(t))&&(t=this.get("autoheight")),this.set("autoheight",t),this.toggleAttrClass("autoheight",t)},setFullscreenControl:function(t){s.isUndefined(t)&&(t=this.get("hideFullscreen")),this.set("hideFullscreen",t),this.toggleAttrClass("hideFullscreen",t)},onTimeUpdate:function(){var t=.3,e=this.get("_position"),i=this.player.currentTime(),s=Math.abs(e-i);t>s&&this.set("_elapsed",this.get("_elapsed")+s),this.set("_position",i),this.set("_startSeekJumpTime",i)},getStartSeekJumpPosition:function(){return this.get("_startSeekJumpTime")},getPosition:function(){return Math.floor(this.get("_position"))},getElapsed:function(){return Math.floor(this.get("_elapsed"))},toggleAttrClass:function(t,e){this.classNames[t]&&a.write(function(){this.$el.toggleClass(this.classNames[t],e)},this)},teardown:function(){this.trigger("teardown",this),this.off(),this.stopListening(),this.watcher&&(this.watcher.destroy(),this.watcher=null),this.player&&(this.player.dispose(),this.player=null)}});e.exports=p},{"./plugins/videojs-crt":460,fastdom:609,jquery:"HlZQrA",lodash:"MicNly","prima/class":509,"prima/events":512,"prima/lib/flags":"f/LVtH","prima/mixins/accessor":542,"prima/utils/caniuse":562,scrollmonitor:"y33VHk"}],447:[function(t,e,i){"use strict";var s=t("video.js"),n=t("./templates/mute_toggle.tpl"),o=s.MuteToggle.extend({init:function(t,e){s.MuteToggle.prototype.init.call(this,t,e),this.addListeners(t)},addListeners:function(t){this.on("click",this.onMuteClick)},onMuteClick:function(){this.player_.trigger("muteClicked")},createEl:function(){var t="vjs-mute-control vjs-control";return this.player_.options_.muted&&(t+=" vjs-vol-0"),s.Button.prototype.createEl.call(this,"div",{className:t,innerHTML:n()})},update:function(){var t=this.player_.volume(),e=3;0===t||this.player_.muted()?e=0:.33>t?e=1:.67>t&&(e=2),this.player_.muted()?"Unmute"!==this.el_.children[1].children[0].innerHTML&&(this.el_.children[1].children[0].innerHTML="Unmute"):"Mute"!==this.el_.children[1].children[0].innerHTML&&(this.el_.children[1].children[0].innerHTML="Mute");for(var i=0;4>i;i++)s.removeClass(this.el_,"vjs-vol-"+i);s.addClass(this.el_,"vjs-vol-"+e)}});e.exports=o},{"./templates/mute_toggle.tpl":459,"video.js":"AcVSFw"}],448:[function(t,e,i){"use strict";var s=t("lodash"),n=t("jquery"),o=t("video.js"),a=o.CoreObject.extend({init:function(t,e){this.options=e||{},this.player=t,this.$player=n(this.player.el()),this._selectorCache(),this.player.on("dispose",s.bind(this.dispose,this)),this.initialize.apply(this,arguments)},_selectorCache:function(){this.$$=s.memoize(function(t){return this.$player.find(t)},s.identity),this.$$.remove=s.bind(function(t){this.$$.cache["delete"](t)},this),this.$$.clear=s.bind(function(){this.$$.cache=new s.memoize.Cache},this)},initialize:function(){},dispose:function(){this.$$.clear(),this.$player.off()}});e.exports=a},{jquery:"HlZQrA",lodash:"MicNly","video.js":"AcVSFw"}],449:[function(t,e,i){"use strict";var s=t("jquery"),n=t("lodash"),o=t("video.js"),a=t("prima/utils/bindendevent").animation,r=o.Button.extend({init:function(){o.Button.prototype.init.apply(this,arguments),this.player().usingNativeControls()&&this.player().controls(!1)},createEl:function(){return o.Button.prototype.createEl.call(this,"div",{className:"vjs-big-play-button",innerHTML:'<span class="vjs-big-play-button-icon"></span><span class="vjs-big-pause-button-icon"></span></span><span aria-hidden="true"></span>',"aria-label":"play video"})},onClick:function(){this.$el=this.$el||s(this.el()),this.player_.userActive(!0),this.player().usingNativeControls()?this.player().paused()&&(this.player().play(),this.player().controls(!0)):this.togglePlay()},togglePlay:function(){a(this.$el,n.bind(function(t){this.$el.removeClass("poof-play poof-pause")},this)),this.player().paused()?(this.player().play(),this.$el.removeClass("poof-pause").addClass("poof-play")):(this.player().pause(),this.$el.removeClass("poof-play").addClass("poof-pause"))}});e.exports=r},{jquery:"HlZQrA",lodash:"MicNly","prima/utils/bindendevent":560,"video.js":"AcVSFw"}],450:[function(t,e,i){"use strict";var s=t("video.js"),n=s.SeekBar.extend({onMouseMove:function(t){s.SeekBar.prototype.onMouseMove.apply(this,arguments),this.update()},update:function(){if(this.el_){var t=this.getPercent(),e=this.handle,i=this.bar;isNaN(t)&&(t=0);var n=s.round(100*t,2)+"%";e.el().style.left=n,i.el().style.width=n}}});e.exports=n},{"video.js":"AcVSFw"}],451:[function(t,e,i){"use strict";var s=t("lodash"),n=t("./base/base-plugin"),o=n.extend({elSelector:".vjs-progress-holder",lastPlayPosition:0,currentPlayPosition:0,lastWaitedTime:0,buffering:!1,polling:!1,interval:100,initialize:function(t,e){this.player.on("play",s.bind(this.startPolling,this)),this.player.on("ended",s.bind(this.stopPolling,this)),this.player.on("pause",s.bind(this.stopPolling,this))},checkBuffering:function(){this.currentPlayPosition=this.player.currentTime();var t=1/this.interval;if(!this.buffering&&this.currentPlayPosition<this.lastPlayPosition+t&&!this.player.paused()&&(this.lastWaitedTime=s.now(),this.$player.trigger("waiting"),this.buffering=!0),this.buffering&&this.currentPlayPosition>this.lastPlayPosition+t&&!this.player.paused()){var e=s.now()-this.lastWaitedTime;this.$player.trigger("stopwaiting",{timeWaited:e}),this.buffering=!1}this.lastPlayPosition=this.currentPlayPosition},tick:function(){this.polling&&(this.checkBuffering(),s.delay(s.bind(this.tick,this),this.interval))},startPolling:function(t){this.polling||(this.polling=!0,this.tick())},stopPolling:function(t){this.polling=!1}});e.exports=o},{"./base/base-plugin":448,lodash:"MicNly"}],452:[function(t,e,i){"use strict";var s=t("lodash"),n=t("jquery"),o=t("prima/events"),a=t("prima/lib/flags"),r=t("./base/base-plugin"),l=r.extend({videoConversionLogged:!1,loggingInProgress:!1,startSeekTime:null,loadStartTime:0,triggerElement:n(),initialize:function(t,e){this.player.crt.on("ready",s.bind(function(){this.setPlayerData(),this.bindEvents(),this.cacheUnloadData()},this)),this.$doc=n(document)},setPlayerData:function(){this.playerData={id:this.player.crt.playerID,tech:this.player.techName,postData:this.player.crt.$post.data("json"),duration:this.player.crt.get("duration")}},bindEvents:function(){this.$player.on("mousedown touchstart",s.bind(this.setTriggerElement,this)),this.player.on("userPlay",s.bind(this.onUserPlay,this)),this.player.on("play",s.bind(this.onVJSPlay,this)),this.player.on("userPause",s.bind(this.onUserPause,this)),this.player.on("pause",s.bind(this.onVJSPause,this)),this.player.on("looped",s.bind(this.onLooped,this)),this.player.on("videoEnded",s.bind(this.onVideoEnded,this)),this.player.on("restart",s.bind(this.onRestart,this)),this.player.on("muteClicked",s.bind(this.onMuteClicked,this)),this.player.on("fullscreenchange",s.bind(this.onFullscreenChange,this)),this.player.on("error",s.bind(this.onError,this)),this.player.on("seeking",s.bind(this.onSeeking,this)),this.player.on("resolutionchange",s.bind(this.onResolutionChange,this)),this.player.on("timeupdate",s.bind(this.onTimeUpdate,this)),this.$player.on("stopwaiting",s.bind(this.onStopWaiting,this)),this.player.on("firstplay",s.bind(this.onLoadStart,this)),this.player.on("loadeddata",s.bind(this.onLoadedData,this))},triggerEvent:function(t,e){e=this._buildLoggingData(e),o.trigger("VideoPlayer:"+t,{loggingData:e})},_buildLoggingData:function(t){return t=s.extend({},this.playerData,t),t.elapsed=this.player.crt.getElapsed(),t.position=this.player.crt.getPosition(),t},setTriggerElement:function(t){this.triggerElement=n(t.target)},onLogComplete:function(){this.triggerElement=n()},cacheUnloadData:function(){this.triggerEvent("cacheUnload")},onError:function(t){var e=this.player.error(),i="MEDIA_ERR_CUSTOM";if(e){switch(e.code){case 1:i="MEDIA_ERR_ABORTED";break;case 2:i="MEDIA_ERR_NETWORK";break;case 3:i="MEDIA_ERR_DECODE";break;case 4:i="MEDIA_ERR_SRC_NOT_SUPPORTED";break;case 5:i="MEDIA_ERR_ENCRYPTED"}this.triggerEvent("error",{code:e.code,name:i})}},onUserPlay:function(t){this.onPlay(!0,t)},onVJSPlay:function(t){this.onPlay(!1,t)},onPlay:function(t,e){if(t||0!==this.triggerElement.closest(".vjs-big-play-button").length||0!==this.triggerElement.closest(".vjs-play-control").length){var i=this.player.crt.get("autoplay"),s={};e.onDock&&(s.onDock=!0),this.logConversion({name:"CONVERSION_ACTION_HTML5_VIDEO",extra:{player:this.player.techName,player_version:2}}),this.triggerEvent(i?"autoplay":"play",s),this.onLogComplete()}},onUserPause:function(){this.onPause(!0)},onVJSPause:function(){this.onPause(!1)},onPause:function(t){(t||0!==this.triggerElement.closest(".vjs-big-play-button").length||0!==this.triggerElement.closest(".vjs-play-control").length)&&(this.triggerEvent("pause",this.playerData),this.onLogComplete())},onLooped:function(){this.triggerEvent("looped")},onVideoEnded:function(){this.triggerEvent("ended")},onRestart:function(t){var e=s.pick(t,["start","end"]);this.triggerEvent("restart",e)},onFullscreenChange:function(){this.triggerEvent("fullscreen",{fullscreen:this.player.isFullscreen()}),this.onLogComplete()},onMuteClicked:function(){this.triggerEvent("muted",{muted:this.player.muted()}),this.onLogComplete()},onSeeking:function(){0!==this.triggerElement.closest(".vjs-progress-control").length&&(this.startSeekTime||(this.startSeekTime=this.player.crt.getStartSeekJumpPosition()),this.$doc.one("mouseup.crtEvents touchend.crtEvents",s.bind(this.onSeeked,this)))},onSeeked:function(){if(this.startSeekTime){var t={start:this.startSeekTime,end:this.player.currentTime()};this.triggerEvent("seek",t),this.startSeekTime=null}},onTimeUpdate:function(){this.triggerEvent("timeupdate")},onResolutionChange:function(t){var e=s.pick(t,"resolution");this.triggerEvent("resolutionchange",e)},onStopWaiting:function(t,e){!e.timeWaited||e.timeWaited<2e3||this.triggerEvent("waiting",e)},onLoadStart:function(){this.loadStartTime=s.now()},onLoadedData:function(){var t=s.now()-this.loadStartTime;this.triggerEvent("initialLoad",{loadTime:t})},logConversion:function(t){if(!this.videoConversionLogged&&a.bool("is_logged_in")&&!this.loggingInProgress){this.loggingInProgress=!0;var e=n.ajax({url:"/svc/log/conversion",type:"POST",contentType:"application/x-www-form-urlencoded",with_form_key:!0,data:"log="+JSON.stringify(t)});e.done(s.bind(this.onConversionSuccess,this)),e.fail(s.bind(this.onConversionFail,this))}},onConversionSuccess:function(){this.videoConversionLogged=!0,this.loggingInProgress=!1},onConversionFail:function(){this.loggingInProgress=!1}});e.exports=l},{"./base/base-plugin":448,jquery:"HlZQrA",lodash:"MicNly","prima/events":512,"prima/lib/flags":"f/LVtH"}],453:[function(t,e,i){"use strict";var s=t("lodash"),n=t("video.js"),o=n.Component.extend({sdURL:null,hdURL:null,forceHD:null,isUsingSD:!0,timeIntervalBinding:null,init:function(t,e){n.Component.prototype.init.call(this,t,e),this.addListeners(t)},addListeners:function(t){this.on("click",this.toggleHDState)},createEl:function(){if(this.hdURL=this.player_.options_.crtOptions.hdUrl,this.forceHD=this.player_.options_.forceHD,!this.hdURL||this.forceHD)return n.Component.prototype.createEl.call(this,"div",{});this.player_.addClass("vjs-has-hd-toggle");var t=n.Component.prototype.createEl.call(this,"div",{className:"vjs-hd-toggle vjs-sd vjs-menu-button vjs-control",innerHTML:"<span>HD</span>"});return t},currentSource:function(){return this.player_.currentSrc()},toggleSrc:function(){var t;this.isUsingSD?(this.sdURL=this.currentSource(),t=this.hdURL,n.removeClass(this.el_,"vjs-sd"),n.addClass(this.el_,"vjs-hd")):(t=this.sdURL,n.removeClass(this.el_,"vjs-hd"),n.addClass(this.el_,"vjs-sd")),this.isUsingSD=!this.isUsingSD,this.player_.src({src:t,type:"video/mp4"})},toggleHDState:function(){var t=this.player_.currentTime(),e=this.player_.paused(),i=this.player_.muted();this.player_.addClass("vjs-quality-toggling"),this.player_.trigger({type:"resolutionchange",resolution:this.isUsingSD?"hd":"sd"}),s.delay(s.bind(function(){this.player_.pause(),this.toggleSrc(),this.player_.ready(function(){this.player_.one("loadedmetadata",s.bind(function(){this.player_.currentTime(t)},this)),this.timeIntervalBinding=s.bind(function(){this.player_.currentTime()-t>.1&&(this.player_.removeClass("vjs-quality-toggling"),this.player_.off("timeupdate",this.timeIntervalBinding),e&&(this.player_.pause(),this.player_.muted(i)))},this),this.player_.on("timeupdate",this.timeIntervalBinding),s.defer(s.bind(function(){this.player_.load(),i===!1&&e===!0&&this.player_.muted(!0),this.player_.play()},this))})},this),300)}});e.exports=o},{lodash:"MicNly","video.js":"AcVSFw"}],454:[function(t,e,i){"use strict";var s=t("jquery"),n=t("video.js"),o=t("./base/base-plugin"),a=o.extend({seeking:!1,render:function(){return this.$el=s('<div class="vjs-hover-handle vjs-slider-handle" aria-live="off"><span class="vjs-control-text"></span></div>'),this},afterRender:function(){this.$seekHandle=this.$$(".vjs-seek-handle")},update:function(t){t||(t={}),this.$time_el=this.$time_el||this.$el.find(".vjs-hover-handle-time");
var e=t.hoverX||0,i=t.hoverTime||"0:00",s=n.formatTime(i);this.$time_el.html(s),this.$el.css("left",e+"px")}});e.exports=a},{"./base/base-plugin":448,jquery:"HlZQrA","video.js":"AcVSFw"}],455:[function(t,e,i){"use strict";var s=t("jquery"),n=t("video.js"),o=t("./base/base-plugin"),a=o.extend({render:function(){return this.$el=s('<div class="vjs-hover-slider-time" aria-live="off"></div>'),this},update:function(t){t||(t={});var e=t.hoverX||0,i=t.hoverTime||"0:00",s=n.formatTime(i);this.$el.html(s),this.$el.css("left",e+"px")}});e.exports=a},{"./base/base-plugin":448,jquery:"HlZQrA","video.js":"AcVSFw"}],456:[function(t,e,i){"use strict";var s=t("lodash"),n=t("video.js"),o=t("./base/base-plugin"),a=t("./hover-slider-handle"),r=t("./hover-slider-time"),l=t("./progress-bar-tooltip"),h=o.extend({elSelector:".vjs-progress-holder",initialize:function(t,e){this.children={},this.$el=this.$$(this.elSelector),this.slider_width=this.$el.width(),this.createChildren(),this.$player.on("mousemove.sliderHover",this.elSelector,s.bind(this.onMouseMove,this)),this.$player.on("mouseenter.sliderHover",this.elSelector,s.bind(this.onMouseEnter,this)),this.$player.on("mouseout.sliderHover",this.elSelector,s.bind(this.onMouseOut,this)),this.player.on("dispose",s.bind(this.dispose,this)),this.player.on("fullscreenchange",s.bind(this.onUpdateDimensions,this)),this.player.on("CRTPlayer:updateDimensions",s.bind(this.onUpdateDimensions,this))},onUpdateDimensions:function(){this.slider_width=this.$el.width()},createChildren:function(){this.children.hoverSliderHandle=new a(this.player),this.children.hoverSliderTime=new r(this.player),this.player.options_.crtOptions.filmstrip&&(this.$el.addClass("with-filmstrip"),this.children.progressBarTooltip=new l(this.player)),this.appendChildren()},appendChildren:function(){s.each(this.children,s.bind(function(t){this.$el.append(t.render().$el)},this))},updateChildren:function(t){s.each(this.children,function(e){e.update(t)})},onMouseMove:function(t){this.$el.removeClass("auto-hide");var e=n.findPosition(this.$el[0]),i=t.pageX-e.left,s=n.Slider.prototype.calculateDistance.apply(this.player.controlBar.progressControl,[t.originalEvent]),o=s*this.player.player().duration(),a=o/this.player.player().duration();0>i?i=0:i>this.slider_width&&(i=this.slider_width),this.updateChildren({hoverX:i,hoverTime:o,hoverPercent:a})},onMouseOut:function(t){this.$el.addClass("auto-hide")},onMouseEnter:function(t){this.$el.removeClass("auto-hide")},dispose:function(){s.each(this.children,function(t){s.result(t,"dispose")}),o.prototype.dispose.apply(this,arguments)}});e.exports=h},{"./base/base-plugin":448,"./hover-slider-handle":454,"./hover-slider-time":455,"./progress-bar-tooltip":458,lodash:"MicNly","video.js":"AcVSFw"}],457:[function(t,e,i){"use strict";var s=t("jquery"),n=t("lodash"),o=t("video.js"),a=o.Component.extend({isHidden:!0,init:function(t,e){o.Component.call(this,t,e),t.ready(n.bind(this.onReady,this))},onReady:function(){this.$player=s(this.player().el_),this.$el=s(this.el()),this.$loader=this.$el.find(".Knight-Rider-loader");var t=n.bind(this.hideLoader,this),e=n.bind(this.showLoader,this);this.player().on("waiting",e),this.player().on("canplay",t),this.player().on("canplaythrough",t),this.player().on("playing",t),this.player().on("seeking",e),this.player().on("seeked",t),this.player().on("ended",t),this.player().on("resolutionchange",e)},createEl:function(){return o.Component.prototype.createEl.call(this,"div",{className:"vjs-loading-spinner",innerHTML:'<div class="Knight-Rider-loader centered"><div class="Knight-Rider-bar"></div><div class="Knight-Rider-bar"></div><div class="Knight-Rider-bar"></div></div>',"aria-label":"loading"})},hideLoader:function(t){return this.isHidden?this:(this.$loader.removeClass("animate"),this.$player.removeClass("vjs-loading"),this.isHidden=!0,this)},showLoader:function(t){return this.isHidden?(this.$loader.addClass("animate"),this.$player.addClass("vjs-loading"),this.isHidden=!1,this):this},dispose:function(){o.Component.prototype.dispose.apply(this,arguments),this.$player=null,this.$el=null}});e.exports=a},{jquery:"HlZQrA",lodash:"MicNly","video.js":"AcVSFw"}],458:[function(t,e,i){"use strict";var s=t("jquery"),n=t("./base/base-plugin"),o=n.extend({filmstrip_thumbnail_count:10,render:function(){var t=this.player.options_.crtOptions.filmstrip,e=t.url,i=.5*t.width,n=.5*t.height,o=6;return this.$el=s('<div class="crt-progress-tooltip"></div>'),this.$thumbnail=s('<div class="crt-progress-tooltip-thumbnail"></div>'),this.$el.css({transform:"translateX(-50%)",width:i+o+"px",height:n+o+"px"}),this.$thumbnail.css({width:i+"px",height:n+"px","background-image":"url("+e+")","background-size":i*this.filmstrip_thumbnail_count+"px "+n+"px"}),this.$el.append(this.$thumbnail),this},update:function(t){t||(t={});var e=t.hoverX||0;this.$el.css("left",e+"px");var i=isNaN(t.hoverPercent)?0:100*t.hoverPercent,s=100/(this.filmstrip_thumbnail_count-1),n=Math.floor(i/this.filmstrip_thumbnail_count)*s;this.$thumbnail.css("background-position",n+"% 0%")}});e.exports=o},{"./base/base-plugin":448,jquery:"HlZQrA"}],459:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __p="";Array.prototype.join;with(obj||{})__p+='<div class="mute-icon"><div class="speaker"></div><div class="unmuted"></div><div class="muted"></div></div><div><span class="vjs-control-text">Mute</span></div>';return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],460:[function(t,e,i){"use strict";function s(t,e){var i=n.merge({},m(),e);i.crtOptions.livestream?delete i.techOrder:n.extend(i,n.pick(e,"techOrder"));var s=a.defer(),r=function(){var t;e.src&&e.type?(this.src(e),s.resolve(this)):e.file?(t=e.file.type||"video/mp4",this.src({src:l(e.file),type:t}),s.resolve(this),delete e.file):s.resolve(this)};return o(t,i,r),s.promise}var n=t("lodash"),o=t("video.js");o.Flash.embed=function(t,e,i,s,n){var a=o.Flash.getEmbedCode(t,i,s,n),r=o.createEl("div",{innerHTML:a}).childNodes[0];return e.parentNode.replaceChild(r,e),r},t("app/vendor/videojs-contrib-media-sources/videojs-media-sources")(window),t("app/vendor/videojs-contrib-hls/videojs.hls")(window);var a=t("when"),r=t("prima/lib/data"),l=t("app/lib/create-object-url"),h=t("./hover-slider"),c=t("./detect-buffering"),u=t("./event-dispatcher");o.BigPlayToggle=t("./big-play-toggle"),o.AnimatingMuteToggle=t("./animating-mute-toggle"),o.CrtSeekBar=t("./crt-seekbar"),o.LoadingSpinner=t("./loading-spinner"),o.HDToggle=t("./hd-toggle"),o.log=n.noop,o.log.error=n.noop,o.log.warn=n.noop,o.log.history=[];var d=function(t){this.crt=this.options_.crt,this.options_.crt=null,this.hoverSlider=new h(this,t),this.detectBuffering=new c(this,t),this.eventDispatcher=new u(this,t)};o.plugin("crt",d);var p,m=function(){var t=r.get("Context/hosts");return p||(p={children:["mediaLoader","posterImage","bigPlayToggle",{name:"controlBar",children:["playToggle","currentTimeDisplay","timeDivider","durationDisplay","remainingTimeDisplay",{name:"progressControl",children:["crtSeekBar"]},"fullscreenToggle","hDToggle","animatingMuteToggle","loadingSpinner"]},"errorDisplay"],hls:{withCredentials:!1},plugins:{crt:{}},crtOptions:{filmstrip:!1,hdUrl:!1,duration:null,livestream:!1},controls:!0,autoplay:!1,defaultVolume:.8,flash:{swf:t.assets_host+"/assets/src/scripts/vendor/video-js/video-js-swf-4.5.2.swf"},techOrder:["html5","flash"]}),p};e.exports=s},{"./animating-mute-toggle":447,"./big-play-toggle":449,"./crt-seekbar":450,"./detect-buffering":451,"./event-dispatcher":452,"./hd-toggle":453,"./hover-slider":456,"./loading-spinner":457,"app/lib/create-object-url":431,"app/vendor/videojs-contrib-hls/videojs.hls":444,"app/vendor/videojs-contrib-media-sources/videojs-media-sources":445,lodash:"MicNly","prima/lib/data":514,"video.js":"AcVSFw",when:"RG2dij"}],461:[function(t,e,i){"use strict";var s=t("./views/knight-rider-loader-view.js");e.exports=s},{"./views/knight-rider-loader-view.js":463}],462:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __t,__p="";Array.prototype.join;with(obj||{})__p+='<div class="knight-rider-loader '+(null==(__t=variation)?"":_.escape(__t))+'" data-js-knightrider><div class="knight-rider-bar"></div><div class="knight-rider-bar"></div><div class="knight-rider-bar"></div></div>';return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],463:[function(t,e,i){"use strict";var s=t("prima/views/base"),n=t("../templates/knight-rider-loader.tpl"),o=s.extend({className:"knight-rider-container",template:n,defaults:{variation:"",loading:!1},_onChangeLoading:function(t,e){this.$el.toggleClass("loading",e),this.$el.find("[data-js-knightRider]").toggleClass("animate",e),this.$el.toggle(e)},afterRender:function(){this._onChangeLoading(this,this.get("loading")),this.listenTo(this,"change:loading",this._onChangeLoading)}});e.exports=o},{"../templates/knight-rider-loader.tpl":462,"prima/views/base":581}],464:[function(t,e,i){"use strict";var s=t("./views/base.js");e.exports=s},{"./views/base.js":468}],465:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __p="";Array.prototype.join;with(obj||{})__p+='<div class="bar white"></div><div class="bar red"></div><div class="bar orange"></div><div class="bar green"></div><div class="bar purple"></div>';return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],466:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __t,__p="";Array.prototype.join;with(obj||{})__p+=""+(null==(__t=_subview("loaderType"))?"":__t);return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],467:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/views/base"),o=t("../templates/bar.tpl"),a=n.extend({className:"loader-bar",template:o,defaults:{classModifiers:"",loading:!1},initialize:function(t){this.options=s.extend({},this.defaults,t),this.$el.addClass(this.get("classModifiers")),this.interval=null,this.timeout=null},afterRender:function(){this.$bars=this.$el.find(".bar"),this.get("loading")===!0&&this.toggleLoading(this.get("loading"))},toggleLoading:function(t){this.currentBar=0,this.counter=0,t===!0?(clearTimeout(this.timeout),this.$el.addClass("loading"),this.$bars.addClass("animating"),this.startAnimating()):(this.$el.removeClass("loading"),this.stopAnimating(),setTimeout(s.bind(function(){this.$bars.removeClass("animating")},this),300))},showBar:function(t){this.$bars.eq(t).addClass("active")},hideBar:function(t){this.$bars.eq(t).removeClass("active")},loop:function(){var t=this.$bars.eq(this.currentBar);t.remove(),this.$el.append(t),this.currentBar+=1,this.currentBar>=this.$bars.length&&(this.currentBar=0),this.counter++},startAnimating:function(){this.stopAnimating(),this.loop(),this.interval=setInterval(s.bind(function(){this.loop()},this),300)},stopAnimating:function(){clearInterval(this.interval)}});e.exports=a},{"../templates/bar.tpl":465,lodash:"MicNly","prima/views/base":581}],468:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/views/base"),o=t("./bar.js"),a=t("../templates/base.tpl"),r=n.extend({className:"loader-container",template:a,defaults:{type:"",classModifiers:"",loading:!1},initialize:function(t){this.options=s.extend({},this.defaults,t),this.$container=t.$container,"bar"===this.get("type")&&this.createBarLoader(),this.listenTo(this,"change:loading",this._onChangeLoading),this.attach()},createBarLoader:function(){this.subviews.loaderType=new o(this.options)},_onChangeLoading:function(t,e){this.subviews.loaderType.toggleLoading(e)},attach:function(){this.render(),this.$el.attr("data-subview=loader"),this.$container.find("[data-subview=loader]").replaceWith(this.$el)}});e.exports=r},{"../templates/base.tpl":466,"./bar.js":467,lodash:"MicNly","prima/views/base":581}],469:[function(t,e,i){"use strict";e.exports={SharePopoverView:t("./views/share-popover"),FeatureHelpPopoverView:t("./views/feature-help-popover")}},{"./views/feature-help-popover":474,"./views/share-popover":476}],470:[function(t,e,i){"use strict";var s=t("jquery"),n=t("lodash"),o=t("prima/model"),a=t("prima/lib/data"),r=t("prima/lib/flags"),l=t("app/components/post-embed-code"),h=o.extend({url:function(){return"/svc/post/share/"+this.get("tumblelog_name")+"/"+this.get("post_id")},parse:function(t){return!n.isUndefined(t)&&n.has(t,"response")?n.result(t.response,"share_popover_data")||{}:{}},hostname:function(){var t=a.get("Context/hosts");return n.isEmpty(t)?"http://www.tumblr.com":t.www_host},defaults:{abuse_url:"",embed_code:"",embed_did:"",form_key:s("#tumblr_form_key").attr("content"),has_facebook:!1,has_user:!1,is_private:!1,permalink_label:"",post_id:"",post_tiny_url:"",post_url:"",root_id:"",show_email:!0,show_embed:!0,show_facebook:!0,show_permalink:!0,show_pinterest:!0,show_reporting_links:!0,show_twitter:!0,show_reddit:!0,show_flagging:!0,tumblelog_name:"",twitter_username:"",embed_key:"",pinterest_share_window:{}},initialize:function(t){this.get("embed_code")||this.set("embed_code",new l(this.toJSON()).getCode()),r.bool("enable_share_embed_code")||this.set("show_embed",!1),r.bool("pinterest_sharing")||this.set("show_pinterest",!1),r.bool("reddit_sharing")||this.set("show_reddit",!1)},shareEmail:function(t){return this.share("/svc/share/email",t)},shareTwitter:function(t){return this.share("/svc/share/twitter",t)},shareFacebook:function(t){return this.share("/svc/share/facebook",t)},sharePinterest:function(t){return this.share("/svc/share/pinterest",t)},shareReddit:function(t){return this.share("/svc/share/reddit",t)},facebookStatus:function(){return s.ajax({url:this.hostname()+"/svc/facebook_status",type:"post",data:{form_key:this.get("form_key")}})},share:function(t,e){return e=e||[],e.push({name:"form_key",value:this.get("form_key")}),s.ajax({url:this.hostname()+t,type:"post",data:e,success:n.bind(function(){this.trigger("success")},this),error:n.bind(function(){this.trigger("error")},this)}),this}});e.exports=h},{"app/components/post-embed-code":215,jquery:"HlZQrA",lodash:"MicNly","prima/lib/data":514,"prima/lib/flags":"f/LVtH","prima/model":557}],471:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __t,__p="";Array.prototype.join;with(obj||{})__p+="","undefined"!=typeof template&&"standard"===template?(__p+='<div class="popover tutorial '+(null==(__t=name)?"":_.escape(__t))+'_step">',"undefined"!=typeof title&&(__p+='<h3 class="title">'+(null==(__t=title)?"":__t)+"</h3>"),__p+='<p class="content">'+(null==(__t=content)?"":_.escape(__t))+"</p>","undefined"!=typeof ok_text&&(__p+='<button class="chrome blue ok_button" type="button">'+(null==(__t=ok_text)?"":_.escape(__t))+"</button>"),__p+="</div>"):"undefined"!=typeof template&&"appearance"===template&&(__p+='<div class="popover tutorial '+(null==(__t=name)?"":_.escape(__t))+'_step"><div class="popover_inner">',"undefined"!=typeof title&&(__p+='<h3 class="title">'+(null==(__t=title)?"":__t)+"</h3>"),__p+='<p class="content">'+(null==(__t=content)?"":_.escape(__t))+'</p></div><div class="appearance small" style="background-color:'+(null==(__t=appearance_data.global_theme_params.background_color)?"":_.escape(__t))+"; color:"+(null==(__t=appearance_data.global_theme_params.background_color)?"":_.escape(__t))+'"><div class="navigation"><a class="chrome edit_button" href="/settings/blog/'+(null==(__t=appearance_data.name)?"":_.escape(__t))+'">'+(null==(__t=edit_text)?"":_.escape(__t))+'</a></div><div class="header_image" style="background-image:url('+(null==(__t=appearance_data.global_theme_params.header_image_focused)?"":_.escape(__t))+')"></div><div class="avatar '+(null==(__t=appearance_data.global_theme_params.avatar_shape)?"":_.escape(__t))+'" style="background-image:url('+(null==(__t=appearance_data.avatar_url)?"":_.escape(__t))+')"><img src="'+(null==(__t=appearance_data.avatar_url)?"":_.escape(__t))+'" alt=""></div><div class="info" style="color:'+(null==(__t=appearance_data.global_theme_params.title_color)?"":_.escape(__t))+'">',appearance_data.title&&(__p+='<h1 class="title" style="font-weight:'+(null==(__t=appearance_data.global_theme_params.title_font_weight)?"":_.escape(__t))+'">'+(null==(__t=appearance_data.title)?"":_.escape(__t))+"</h1>"),__p+="",appearance_data.description&&(__p+='<div class="description"><p class="description_inner">'+(null==(__t=appearance_data.description)?"":_.escape(__t))+"</p></div>"),__p+="</div></div></div>"),__p+='<div class="glass blue"></div>';return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],472:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __t,__p="";Array.prototype.join;with(obj||{})__p+='<div class="popover popover_menu popover_gradient message-controls-popover"><div class="popover_inner"><ul>',this.showFlagAndBlock&&(__p+='<li class="popover_menu_item" data-action="block" data-block="'+(null==(__t=this.options.blockString)?"":_.escape(__t))+'"><a class="popover_menu_item_anchor" href="#">'+(null==(__t=__("Block"))?"":_.escape(__t))+'</a></li><li class="popover_menu_item" data-action="flag"><a class="popover_menu_item_anchor" href="#">'+(null==(__t=__("Flag"))?"":_.escape(__t))+"</a></li>"),__p+='<li class="popover_menu_item" data-action="delete" data-confirm="'+(null==(__t=__("Are you sure you want to delete this?"))?"":__t)+'"><a class="popover_menu_item_anchor" href="#">'+(null==(__t=__("Delete"))?"":_.escape(__t))+"</a></li></ul></div></div>";return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],473:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __t,__p="";Array.prototype.join;with(obj||{})__p+='<div class="popover popover_menu popover_gradient popover_share_social"><div class="popover_inner"><ul class="share_options active" data-tumblelog-name="'+(null==(__t=tumblelog_name)?"":_.escape(__t))+'" data-post-id="'+(null==(__t=post_id)?"":_.escape(__t))+'" data-root-id="'+(null==(__t=root_id)?"":_.escape(__t))+'" data-post-url="'+(null==(__t=post_url)?"":_.escape(__t))+'" data-post-tiny-url="'+(null==(__t=post_tiny_url)?"":_.escape(__t))+'" data-embed-key="'+(null==(__t=embed_key)?"":_.escape(__t))+'" data-embed-did="'+(null==(__t=embed_did)?"":_.escape(__t))+'">',is_private||(__p+="",show_permalink&&(__p+='<li class="share_permalink popover_menu_item"><a class="popover_menu_item_anchor" data-share-type="permalink" href="'+(null==(__t=post_url)?"":_.escape(__t))+'" target="_blank" class="external" title="'+(null==(__t=permalink_label)?"":_.escape(__t))+'">'+(null==(__t=permalink_label)?"":_.escape(__t))+'<i class="icon icon_arrow_carrot_right"></i></a></li>'),__p+="",show_embed&&(__p+='<li class="embed_post popover_menu_item"><a class="popover_menu_item_anchor" data-share-type="embed" href="#">'+(null==(__t=__("Embed"))?"":_.escape(__t))+"</a></li>"),__p+="",show_email&&(__p+='<li class="share_email popover_menu_item"><a class="popover_menu_item_anchor" data-share-type="email" href="#">'+(null==(__t=__("Email"))?"":_.escape(__t))+"</a></li>"),__p+="",show_twitter&&(__p+='<li class="share_twitter popover_menu_item" data-twitter-username="'+(null==(__t=twitter_username)?"":_.escape(__t))+'"><a class="popover_menu_item_anchor" data-share-type="twitter" href="#">'+(null==(__t=__("Twitter"))?"":_.escape(__t))+"</a></li>"),__p+="",show_facebook&&(__p+='<li class="share_facebook popover_menu_item" data-has-facebook="'+(null==(__t=has_facebook?"1":"")?"":__t)+'"><a class="popover_menu_item_anchor" data-share-type="facebook" href="#">'+(null==(__t=__("Facebook"))?"":_.escape(__t))+"</a></li>"),__p+="",show_pinterest&&(__p+='<li class="share_pinterest popover_menu_item"><a class="popover_menu_item_anchor" data-share-type="pinterest" href="#">'+(null==(__t=__("Pinterest"))?"":_.escape(__t))+"</a></li>"),__p+="",show_reddit&&(__p+='<li class="share_reddit popover_menu_item"><a class="popover_menu_item_anchor" data-share-type="reddit" href="#">'+(null==(__t=__("Reddit"))?"":_.escape(__t))+"</a></li>"),__p+="",show_flagging&&(__p+='<li class="flag_post popover_menu_item"><a class="popover_menu_item_anchor" href="#">'+(null==(__t=__("Flag this post"))?"":_.escape(__t))+"</a></li>"),__p+="",show_reporting_links&&(__p+='<li class="popover_menu_item"><a class="popover_menu_item_anchor" target="_blank" href="'+(null==(__t=abuse_url)?"":_.escape(__t))+'">'+(null==(__t=__("Report Abuse"))?"":_.escape(__t))+"</a></li>"),__p+=""),__p+="</ul>",is_private||(__p+='<form method="post" class="share_form email_form" id="share_email_'+(null==(__t=post_id)?"":_.escape(__t))+'" novalidate><div class="form_wrapper"><div class="share_label" data-embed-label="'+(null==(__t=__("Embed"))?"":_.escape(__t))+'"></div><span class="cancel service icon_arrow_thin_left"></span><div class="input_group"><ul><li><input type="email" class="email_address" name="email_address" maxlength="100" placeholder="'+(null==(__t=__("Email"))?"":_.escape(__t))+'" title="'+(null==(__t=__("Email"))?"":_.escape(__t))+'"> <input type="hidden" name="post_id" value="'+(null==(__t=post_id)?"":_.escape(__t))+'"> <input type="hidden" name="tumblelog_name" value="'+(null==(__t=tumblelog_name)?"":_.escape(__t))+'"> <span class="cancel icon_close"></span></li><li><textarea name="message" class="share_message" maxlength="255" placeholder="'+(null==(__t=__("Message (Optional)"))?"":_.escape(__t))+'" title="'+(null==(__t=__("Message (Optional)"))?"":_.escape(__t))+'"></textarea><div class="character_count">140</div></li></ul></div>',show_embed&&(__p+='<div class="embed_code_wrapper"><textarea name="embed_code" class="embed_code_text" spellcheck="false" readonly="readonly">'+(null==(__t=embed_code)?"":_.escape(__t))+"</textarea></div>"),__p+="",has_user&&(__p+='<div class="reply_to" title="'+(null==(__t=__("Let them reply to"))?"":_.escape(__t))+'"><div class="menu_item_option"><label class="binary-switch"><input type="checkbox" id="allow_reply_to_'+(null==(__t=post_id)?"":_.escape(__t))+'" class="reply_to_input" name="allow_reply_to"> <span class="binary-switch-track"></span> <span class="binary-switch-button"></span></label></div><label class="menu_item_label" for="allow_reply_to_'+(null==(__t=post_id)?"":_.escape(__t))+'">'+(null==(__t=__("Let them reply to <span>"))?"":__t)+"</label></div>"),__p+='<div class="error_status"></div><button type="submit" class="flat-button blue email_submit" data-label-sending="'+(null==(__t=__("Sending..."))?"":_.escape(__t))+'" data-label="'+(null==(__t=__("Send"))?"":_.escape(__t))+'" disabled="disabled">'+(null==(__t=__("Send"))?"":_.escape(__t))+'</button></div></form><div class="status" data-sent="'+(null==(__t=__("Sent!"))?"":_.escape(__t))+'" data-error="'+(null==(__t=__("Error!"))?"":_.escape(__t))+'"><span class="status_message">'+(null==(__t=__("Sent!"))?"":_.escape(__t))+"</span></div>"),__p+="</div></div>";return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],474:[function(t,e,i){"use strict";var s=t("jquery"),n=t("lodash"),o=t("prima/view"),a=t("prima/events"),r=t("prima/lib/domeventor"),l=t("prima/utils/bindendevent").transition,h=t("../templates/feature-help-popover.tpl"),c={TOP:1,BOTTOM:2,LEFT:4,RIGHT:8,CENTER:16},u=o.extend({className:"tour_guide",template:h,events:{"click .glass":"_onHide","click .ok_button":"_onDismiss"},_onDismiss:function(t){this.trigger("dismiss"),this._onHide(t)},_onHide:function(t){t.preventDefault(),this.hide(),this.trigger("hide")},_onScroll:function(t){n.get(this.config,"isFadeOnScroll",!0)&&(this.scrollPosition=t,this.isDim&&this.fadeGlass())},initialize:function(t){this.$body=s("body"),this.$highlighted=s(),this.$glass=s(),this.$popover=s(),this.isDim=!1,this.isOpen=!1,this.openScrollPosition=0,this.highlightedClass="",this.scrollPosition=r.rect(),this.listenTo(a,"DOMEventor:flatscroll",this._onScroll)},setHighlighted:function(t,e){this.$highlighted=t,this.highlightedClass=e},show:function(t){return this.config=t,this.$el.html(this.template(t)),this.$body.addClass("tour_guide_open").append(this.$el),this.isOpen=!0,this.config.pinnedTarget&&(this.$highlighted=s(this.config.pinnedTarget)),this.config.highlightedClass&&(this.highlightedClass=this.config.highlightedClass),this.config.glass&&(this.$el.addClass("dim"),this.isDim=!0),this.config.name&&this.$body.attr("data-help-popover",this.config.name),this.config.glass&&this.$highlighted.length&&this.$highlighted.addClass("tour_guide_element").addClass(this.highlightedClass),this.$highlighted.length?this.openScrollPosition=this.scrollPosition.windowScrollTop:this.openScrollPosition=this.scrollPosition.windowScrollTop+.5*this.scrollPosition.windowHeight,this.$glass=this.$(".glass"),this.$popover=this.$(".popover"),this.config.className&&this.$popover.addClass(this.config.className),this.delegateEvents(),this.positionPopover(),this},hide:function(){this.$el.addClass("removing"),this.$body.addClass("help-popover-removing"),l(this.$el,this.remove.bind(this))},remove:function(){this.undelegateEvents(),this.isDim=!1,this.isOpen=!1,this.config=null,this.$el.removeClass("dim removing").remove(),this.$body.removeClass("tour_guide_open help-popover-removing").removeAttr("data-help-popover"),this.$highlighted.length&&(this.$highlighted.off(".tour_guide_highlighted").removeClass("tour_guide_element").removeClass(this.highlightedClass),this.$highlighted=s(),this.highlightedClass=""),this.trigger("removed")},fadeGlass:function(){var t=(this.openScrollPosition-this.scrollPosition.windowScrollTop)/this.scrollPosition.windowHeight,e=t>0?1-t:t+1;return 0>=e?(this.isDim=!1,this.hide(),void this.trigger("hide")):void this.$glass.css("opacity",e)},positionPopover:function(){if(this.$popover.length){var t=this.$popover.outerHeight(!0),e=this.$popover.outerWidth(!0);if(this.$highlighted.length){var i,n,o=this.config.position,a=this.$highlighted.offset(),r=this.$highlighted.outerWidth(),l=a.left,h=a.top,u=h-t<this.scrollPosition.windowScrollTop+80;if(o||(o=c.CENTER|u?c.BOTTOM:c.TOP),o&c.LEFT?(n=l,this.$popover.addClass("horizontal-left")):o&c.RIGHT?(n=l-e+r,this.$popover.addClass("horizontal-right")):(n=l-.5*(e-r),this.$popover.addClass("horizontal-center")),this.$popover.css("left",n),this.config.fixed_position)return this.$popover.css("position","fixed"),void(s("#site_notice").length&&this.$popover.css("margin-top","+="+s("#site_notice").outerHeight()+"px"));o&c.TOP?(i=h-t,this.$popover.addClass("vertical-top")):(i=h+this.$highlighted.outerHeight(),this.$popover.addClass("vertical-bottom")),this.$popover.css("top",i)}else this.$popover.addClass("centered").css({top:.5*this.scrollPosition.windowHeight-.5*t,left:.5*this.scrollPosition.windowWidth-.5*e})}},getPopoverElement:function(){return this.$popover?this.$popover.get(0):void 0},getGlassElement:function(){return this.$glass}},{POSITION:c});e.exports=u},{"../templates/feature-help-popover.tpl":471,jquery:"HlZQrA",lodash:"MicNly","prima/events":512,"prima/lib/domeventor":516,"prima/utils/bindendevent":560,"prima/view":580}],475:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/view"),o=t("prima/events"),a=t("prima/mixins/popoverbase"),r=t("prima/lib/data"),l=t("../templates/message-controls-popover.tpl"),h=n.extend({className:"popover--message-controls-popover",mixins:[a],template:l,events:{'click [data-action="delete"]':"_delete",'click [data-action="block"]':"_block",'click [data-action="flag"]':"_flag"},initialize:function(t){this.options=s.extend({},t),this.showFlagAndBlock=this.options.blockString&&this._notUsersOwnBlog(),this.post=t.post},_getSender:function(){return this.options.blockString&&-1===this.options.blockString.indexOf(":")?this.options.blockString:!1},_notUsersOwnBlog:function(){var t=this._getSender();if(t){var e=r.get("Context/userinfo/channels");return e=s.pluck(e,"name"),!s.includes(e,t)}return!0},_delete:function(t){t.preventDefault(),this.post["delete"](t)},_block:function(t){t.preventDefault(),this.post.block(t)},_flag:function(t){t.preventDefault();var e={mode:"message",post:this.post.model},i=this._getSender();i&&(e.sender=i),o.trigger("abuseform:open",e)},render:function(){return this.$el.html(this.template()),this},teardown:function(){return this.$el.remove(),this}});e.exports=h},{"../templates/message-controls-popover.tpl":472,lodash:"MicNly","prima/events":512,"prima/lib/data":514,"prima/mixins/popoverbase":550,"prima/view":580}],476:[function(t,e,i){"use strict";var s=t("jquery"),n=t("lodash"),o=t("prima/view"),a=t("prima/events"),r=t("prima/utils/cookie"),l=t("prima/mixins/popoverbase"),h=t("../templates/share-popover.tpl"),c=t("../models/share-popover"),u=t("app/models/post"),a=t("prima/events"),d=t("prima/mixins/generate-logging-data"),p=o.extend({className:"popover--post-share-popover",mixins:[l,d],template:h,defaults:{popoverData:{},forceSocialFallback:!1,forceEmailFallback:!1},events:{"click .embed_post":"__embedPostClick","click .share_email":"__emailTriggerClick","click .share_facebook":"__shareFacebookClick","click .share_pinterest":"__sharePinterestClick","click .share_twitter":"__shareTwitterClick","click .share_reddit":"__shareRedditClick","click .share_permalink":"__sharePermalinkClick","click .flag_post":"__flagPostClick","click .cancel":"__cancelClick","click .popover_menu_item_anchor":"__checkIfPremiumPost","input .email_address":"__emailFormInput","input .twitter .share_message":"__shareTwitterInput","change .reply_to_input":"__replyToChange","keydown .share_form":"__submitKeydown","submit .share_form":"__submit","focus input":"__suspendKeyCommands","focus textarea":"__suspendKeyCommands","blur textarea":"__resumeKeyCommands","blur input":"__resumeKeyCommands"},__embedPostClick:function(t){t.preventDefault(),a.trigger("dashboard-share:embed"),this._showEmbedCode()},__emailTriggerClick:function(t){t.preventDefault(),a.trigger("dashboard-share:email"),this._toggleEmailForm()},__shareFacebookClick:function(t){t.preventDefault(),a.trigger("dashboard-share:facebook"),this._shareFacebook()},__sharePinterestClick:function(t){t.preventDefault(),a.trigger("dashboard-share:pinterest"),this._sharePinterest()},__shareRedditClick:function(t){t.preventDefault(),a.trigger("dashboard-share:reddit"),this._shareReddit()},__shareTwitterClick:function(t){t.preventDefault(),a.trigger("dashboard-share:twitter"),this._shareTwitter()},__sharePermalinkClick:function(){this.resetAndHide()},__flagPostClick:function(t){t.preventDefault(),this.onClickOutside(),a.trigger("abuseform:open",{mode:"post",post:this.model})},__cancelClick:function(t){t.preventDefault(),this._cancelOrClose()},__emailFormInput:function(){var t=p.validateEmail(this.$emailAddress.val());this.$submitButton.attr("disabled",!t)},__shareTwitterInput:function(t){t.preventDefault();var e=p.validateTwitter(this.$shareMessage.val(),this.$characterCount);this.$submitButton.attr("disabled",!e)},__replyToChange:function(t){var e=s(t.currentTarget).is(":checked");r.set("share_popover_reply_to",e,31536e3)},__submitKeydown:function(t){13===t.keyCode&&(t.ctrlKey||t.metaKey||t.altKey)&&(t.preventDefault(),t.stopPropagation(),this.submitForm())},__submit:function(){return this.submitForm(),!1},__submitSuccess:function(){this.$status.show(),this._fadeoutPopover()},__submitError:function(){this.$errorStatus.html(this.errorText),this.$submitButton.html(this.$submitButton.data("label")),this.$submitButton.attr("disabled",!1),this.$errorStatus.addClass("active")},__suspendKeyCommands:function(){
a.trigger("keycommands:suspend indashblog:keycommands:suspend")},__resumeKeyCommands:function(){a.trigger("keycommands:resume indashblog:keycommands:resume")},__checkIfPremiumPost:function(){var t=s("[data-id="+this.options.popoverData.post_id+"]").data("json");if(t&&t.pt){var e=new u(t),i=this.loggingData({userAction:"share"});i&&i.modelData&&(i.modelData=e.toJSON()),a.trigger("useraction:explore_click:share",{model:e,loggingData:i})}},_shareTwitter:function(){!this.options.forceSocialFallback&&this.twitterUsername?(this.$serviceCancel.show(),this.$submitButton.html("Tweet"),this.$shareForm.data("type","twitter"),this.$shareLabel.text("@"+this.twitterUsername),this.$shareMessage.val(" [URL]"),this.$shareForm.addClass("active"),this.$shareOptions.removeClass("active"),this.$shareMessage.get(0).setSelectionRange(0,0),this.$shareMessage.attr("placeholder",""),this.$submitButton.attr("disabled",!1),this.$shareForm.addClass("twitter"),p.validateTwitter(this.$shareMessage.val(),this.$characterCount),this.$shareForm.hasClass("active")&&(this.$shareMessage.focus(),this.$shareMessage.get(0).setSelectionRange(0,0))):this._shareTwitterFallback()},_shareTwitterFallback:function(){window.open("https://twitter.com/intent/tweet?url="+encodeURIComponent(this.tinyUrl||this.url),"twitter-share-dialog","width=626,height=258");var t=this._getGenericShareData();this.model.shareTwitter(t),this.resetAndHide()},_shareFacebook:function(){!this.options.forceSocialFallback&&this.hasFacebook?this.model.facebookStatus().done(n.bind(this._shareFacebookSuccess,this)).fail(n.bind(this._shareFacebookFallback,this)):this._shareFacebookFallback()},_shareFacebookSuccess:function(t){t?(this.$serviceCancel.show(),this.$submitButton.html(this.$submitButton.data("label")),this.$shareForm.data("type","facebook"),this.$shareLabel.text(t),this.$submitButton.attr("disabled",!1),this.$shareForm.addClass("facebook"),this.$shareOptions.toggleClass("active"),this.$shareForm.toggleClass("active"),this.$shareForm.hasClass("active")&&this.$shareMessage.focus()):this._shareFacebookFallback()},_shareFacebookFallback:function(){window.open("https://www.facebook.com/sharer/sharer.php?u="+encodeURIComponent(this.url),"facebook-share-dialog","width=626,height=436");var t=this._getGenericShareData();this.model.shareFacebook(t),this.resetAndHide()},_sharePinterest:function(){var t=this.model.get("pinterest_share_window");window.open(t.url,t.name,t.dimensions);var e=this._getGenericShareData();this.model.sharePinterest(e),this.resetAndHide()},_shareReddit:function(){window.open("https://reddit.com/submit?url="+this.model.get("post_url"),"reddit-share-dialog","scrollbars=1,width=860,height=600");var t=this._getGenericShareData();this.model.shareReddit(t),this.resetAndHide()},_toggleEmailForm:function(){return this.options.forceEmailFallback||!this.model.get("has_user")?void this._emailFormFallback():(this.$submitButton.html(this.$submitButton.data("label")),this.$shareForm.data("type","email"),this.$shareOptions.toggleClass("active"),this.$shareForm.toggleClass("active"),this.$replyTo.addClass("active"),void(this.$shareForm.hasClass("active")&&this.$emailAddress.length&&this.$emailAddress.focus()))},_emailFormFallback:function(){var t=this._getGenericShareData();this.model.shareEmail(t);var e="mailto:?body="+this.url;if(this.model.get("embed_key")){var i=window.open();i.document.write('<html><script>location.href = "'+e+'";setTimeout(function(){window.close();},500);</script></html>'),i.document.close()}else window.location.href=e;this.resetAndHide()},_showEmbedCode:function(){this.$serviceCancel.show(),this.$shareForm.data("type","embed"),this.$shareLabel.text(this.$shareLabel.data("embed-label")),this.$shareForm.addClass("active"),this.$shareOptions.removeClass("active"),this.$shareMessage.attr("placeholder",""),this.$shareForm.addClass("embed");var t=this.$shareForm.find(".embed_code_text");t.length&&(t.click(function(){t.select()}),setTimeout(function(){t.trigger("click")},100))},_fadeoutPopover:function(){setTimeout(n.bind(function(){this.$el.fadeOut(150,n.bind(this.resetAndHide,this))},this),1250)},_cancelOrClose:function(){var t=this.$emailAddress.val()||"";"email"===this.$shareForm.data("type")&&t.length?(this.$emailAddress.val(""),this.$submitButton.attr("disabled",!0)):this.resetForm()},_getGenericShareData:function(){return[{name:"post_id",value:this.model.get("post_id")},{name:"tumblelog_name",value:this.model.get("tumblelog_name")},{name:"share_fallback",value:!0}]},initialize:function(t){this.options=n.extend({},this.defaults,t),this.model=new c(this.options.popoverData),this.listenTo(this.model,"error",this.__submitError),this.listenTo(this.model,"success",this.__submitSuccess)},cacheSelectors:function(){this.$shareForm=this.$(".share_form"),this.$shareLabel=this.$(".share_label"),this.$replyTo=this.$(".reply_to"),this.$shareOptions=this.$(".share_options"),this.$submitButton=this.$("button.email_submit"),this.$emailAddress=this.$(".email_address"),this.$shareMessage=this.$(".share_message"),this.$embedCode=this.$(".embed_code_text"),this.$characterCount=this.$(".character_count"),this.$serviceCancel=this.$(".cancel.service"),this.$status=this.$(".status"),this.$errorStatus=this.$(".error_status"),this.$statusMessage=this.$(".status_message"),this.$replyToInput=this.$(".reply_to_input"),this.sentText=this.$status.data("sent")||"",this.errorText=this.$status.data("error")||"",this.$(".share_twitter").length&&(this.twitterUsername=this.$(".share_twitter").data("twitter-username")),this.$(".share_facebook").length&&(this.hasFacebook=this.$(".share_facebook").data("has-facebook")),this.url=this.$shareOptions.data("post-url"),this.tinyUrl=this.$shareOptions.data("post-tiny-url"),this.tumblelogName=this.$shareOptions.data("tumblelog-name"),this.embedKey=this.$shareOptions.data("embed-key"),this.postId=this.$shareOptions.data("post-id"),this.rootId=this.$shareOptions.data("root-id")},render:function(){return this.delegateEvents(),this.$el.html(this.template(this.model.toJSON())),this.cacheSelectors(),this.$replyToInput.prop("checked","true"===r.get("share_popover_reply_to")),this},resetForm:function(){this.$serviceCancel.hide(),this.$submitButton.html(this.$submitButton.data("label")),this.$submitButton.attr("disabled",!0),this.$emailAddress.val(""),this.$shareMessage.val(""),this.$shareMessage.attr("placeholder",this.$shareMessage.attr("title")),this.$shareOptions.addClass("active"),this.$shareForm.removeClass("active"),this.$shareForm.removeClass("facebook"),this.$shareForm.removeClass("twitter"),this.$shareForm.removeClass("embed"),this.$status.hide(),this.$statusMessage.html(this.sentText),this.$replyTo.removeClass("active"),this.$errorStatus.removeClass("active"),this.$el.show()},resetAndHide:function(){this.resetForm(),this.teardown()},submitForm:function(){var t=this.$shareForm.serializeArray();switch(this.$shareForm.data("type")){case"facebook":this.model.shareFacebook(t);break;case"twitter":this.model.shareTwitter(t);break;default:this.model.shareEmail(t)}this.$submitButton.attr("disabled",!0),this.$submitButton.html(this.$submitButton.data("label-sending"))},teardown:function(){return this.__resumeKeyCommands(),this.$el.remove(),this}},{placeholderSupport:function(){var t=document.createElement("input");return"placeholder"in t},validateEmail:function(t){var e=/\S+@\S+\.\S+/;return e.test(t)},validateTwitter:function(t,e){var i=t.match(/\[URL\]/gi),s=i?24*i.length:0,n=140-t.length-s,o=e&&e.length?e:!1;return o&&(o.removeClass("character-limit").html(n),10>n&&o.addClass("character-limit")),0>n||140===n?!1:!0}});e.exports=p},{"../models/share-popover":470,"../templates/share-popover.tpl":473,"app/models/post":435,jquery:"HlZQrA",lodash:"MicNly","prima/events":512,"prima/mixins/generate-logging-data":546,"prima/mixins/popoverbase":550,"prima/utils/cookie":565,"prima/view":580}],477:[function(t,e,i){"use strict";function s(t){return"string"==typeof t||t&&"object"==typeof t&&"[object String]"===d.call(t)||!1}function n(){var t=new m;return t.cid=g,g+=1,f[t.cid]=t,t}function o(t,e){for(var i,s=_.length-1;s>=0;s--)_[s].message_callback(t,e);for(s=v.length-1;s>=0;s--)i=v[s],i&&i.shouldRespond&&i.shouldRespond(t,e)&&i.cb(t,e)}function a(t){if(t||(t={}),!(h&&h.stringify&&h.parse))throw"Must have JSON parsing and stringify";if(t.iframe&&(t.window=t.iframe.contentWindow,!t.origin)){var e=t.iframe.src,i=e.match(/^(http(?:s)?:\/\/[\w_\-\.]+(?::\d+)?)\/?/);i&&(t.origin=i[1])}this.namespace=t.namespace?t.namespace+":":"",this.origin=t.origin||"*",this.responders={_method_callback_responder:b,_syn:u(this._syn,this)},this._on_connected=new p,this._unanswered_calls={},this.on_connection(u(this.enable_sending_post_message,this)),_.push(this),t.window&&this.setWindow(t.window)}function r(t,e,i){i||(i=this.origin),t.postMessage(e,i)}var l=t("prima/utils/clean-window-object"),h=l("JSON",function(t){return t&&t.stringify}),c=[].slice,u=function(t,e){return function(){return t.apply(e,arguments)}},d=Object.prototype.toString,p=t("./utils/one_time_event"),m=t("./utils/deferred"),g=1,f={},_=[],v=[];!function(){var t=window.addEventListener?"addEventListener":"attachEvent",e=window[t],i="attachEvent"===t?"onmessage":"message";e(i,function(t){var e;if("string"==typeof t.data){try{t.data&&"{"===t.data[0]&&(e=h.parse(t.data))}catch(i){}e&&e.method&&o(t,e)}},!1)}();var b=function(t){if(t.cid_response&&t.cid_response in f){var e=f[t.cid_response];e.resolve.call(null,this,t.response),delete f[t.cid_response]}};a.prototype.setWindow=function(t){if(t){this.window=t;var e=this.call("_syn");e.then(u(function(t,e){"ack"===e&&this._is_connected()},this))}},a.on=function(t,e){var i;i="*"===t?function(){return!0}:"*"===t[t.length-1]?function(e,i){return 0===i.method.indexOf(t.substring(0,t.length-2))}:function(e,i){return i.method===t},v.push({shouldRespond:i,cb:e})},a.off=function(t){for(var e,i=v.length-1;i>=0;i--)if(v[i].cb===t){e=i;break}return e&&e>-1?(v.splice(e,1),!0):!1},a.prototype.match_origin=function(t){return"*"===this.origin?!0:this.origin===t},a.prototype.message_callback=function(t,e){var i;if((!this.window||t.source===this.window)&&this.match_origin(t.origin)){if(e.method&&e.method.slice(0,this.namespace.length)===this.namespace&&(i=e.method.slice(this.namespace.length,e.method.length)),e.args&&s(e.args))try{e.args=h.parse(e.args)}catch(n){return}this.call_responder(i,t,e)}},a.prototype.call_responder=function(t,e,i){var s,n;if(t){if(i.args||(i.args=[]),n=this.responders[t],!n)return this._unanswered_calls[t]||(this._unanswered_calls[t]=[]),void this._unanswered_calls[t].push(arguments);s=n.apply(e,i.args),i.cid&&"_method_callback_responder"!==t&&this.send_to_window(e.source,"_method_callback_responder",{cid_response:i.cid,response:s})}},a.prototype._syn=function(){return this._is_connected(),"ack"},a.prototype._is_connected=function(){this.connected||(this.connected=!0,this._on_connected.trigger(this))},a.prototype.on_connection=function(t){return this._on_connected.push.apply(this._on_connected,arguments),this},a.prototype.method=function y(t){var e=this,y=function(){var i=1<=arguments.length?c.call(arguments,0):[];return i.unshift(t),e.send.apply(e,i)};return y},a.prototype.call=function(){var t=1<=arguments.length?c.call(arguments,0):[];return this.window?(t.unshift(this.window),this.call_on_window.apply(this,t)):void console.warn("no window specified on channel")},a.prototype.call_on_window=function(t,e){var i=3<=arguments.length?c.call(arguments,2):[],s=n();try{var o=h.stringify({method:this.namespace+e,args:i,cid:s.cid});"_syn"===e||"_method_callback_responder"===e?r.call(this,t,o):this.send_post_message(t,o)}catch(a){s.reject(a)}return s.promise()},a.prototype.send=function(){var t=1<=arguments.length?c.call(arguments,0):[];return this.window?(t.unshift(this.window),this.send_to_window.apply(this,t)):void console.warn("no window specified on channel")},a.prototype.send_to_window=function(t,e){var i=3<=arguments.length?c.call(arguments,2):[],s=h.stringify({method:this.namespace+e,args:i});"_syn"===e||"_method_callback_responder"===e?r.call(this,t,s):this.send_post_message(t,s)},a.prototype.send_post_message=function(){this._delayed_sent_messages||(this._delayed_sent_messages=[]),this._delayed_sent_messages.push(arguments)},a.prototype.enable_sending_post_message=function(){if(this.send_post_message=r,this._delayed_sent_messages){for(var t=0;t<this._delayed_sent_messages.length;t+=1)r.apply(this,this._delayed_sent_messages[t]);delete this._delayed_sent_messages}},a.prototype.listening_to=function(t){return t in this.responders},a.prototype.listen_to=function(t,e,i){if(s(t)){if(t in this.responders)return void console.warn("already listening to this method, turn it off first");if(i&&(e=u(e,i)),this.responders[t]=e,this._unanswered_calls[t]){var n,o=this._unanswered_calls[t];delete this._unanswered_calls[t];for(var a=0;a<o.length;a+=1)n=o[a],this.call_responder.apply(this,n)}}else{var r=t;for(t in r)r.hasOwnProperty(t)&&this.listen_to(t,r[t],i)}},a.prototype.stop_listen_to=function(t){return"_method_callback_responder"===t?void console.warn("cannot disable the method callback responder"):void delete this.responders[t]},a.prototype.ensureChannelConnection=function(t){this.send_to_window(t,"_syn")},e.exports=a},{"./utils/deferred":478,"./utils/one_time_event":479,"prima/utils/clean-window-object":563}],478:[function(t,e,i){"use strict";function s(){this._on_resolved=new a,this._on_rejected=new a,this.then=o(this.then,this),this.fail=o(this.fail,this),this.resolve=o(this.resolve,this),this.reject=o(this.reject,this)}var n=[].slice,o=function(t,e){return function(){return t.apply(e,arguments)}},a=t("./one_time_event");s.prototype.then=function(){return this._on_resolved.push.apply(this._on_resolved,arguments),this},s.prototype.success=s.prototype.then,s.prototype.fail=function(){return this._on_resolved.push.apply(this._on_rejected,arguments),this},s.prototype.resolve=function(){return this.resolved||this.rejected?void 0:(this._on_resolved.trigger.apply(this._on_resolved,arguments),this.resolved=!0,this)},s.prototype.reject=function(){return this.resolved||this.rejected?void 0:(this._on_rejected.trigger.apply(this._on_rejected,arguments),this.rejected=!0,this)},s.prototype.reject_timeout=function(){var t=1<=arguments.length?n.call(arguments,0):[],e=t.shift();return setTimeout(o(function(){this.reject.apply(this,t)},this),e),this},s.prototype.promise=function(){function t(){var t=this;this.fail=function(){return e.fail.apply(e,arguments),t},this.then=function(){return e.then.apply(e,arguments),t},this.success=this.then,this.reject_timeout=function(){return e.reject_timeout.apply(e,arguments),t},this.cid=e.cid}var e=this;return new t},e.exports=s},{"./one_time_event":479}],479:[function(t,e,i){"use strict";function s(){this.length=0}var n=[].slice,o=[].push;s.prototype={slice:n,indexOf:Array.prototype.indexOf},s.prototype.push=function(){if(this.triggered_with)for(var t=1<=arguments.length?n.call(arguments,0):[],e=0;e<t.length;e+=1)t[e].apply(null,this.triggered_with);return o.apply(this,arguments)},s.prototype.trigger=function(){var t=1<=arguments.length?n.call(arguments,0):[],e=this.length;this.triggered_with=t;for(var i=0;e>i;i+=1)this[i].apply(null,this.triggered_with);return this},e.exports=s},{}],480:[function(t,e,i){"use strict";var s=t("logs/instruments/base"),n=s.extend({logKey:"abuseform",events:{"abuseform:*":"handleEvent"},logEnv:{location:document.location.pathname},handleEvent:function(t,e){this.log(t,e)}});e.exports=n},{"logs/instruments/base":482}],481:[function(t,e,i){"use strict";var s=t("logs/instruments/base"),n=s.extend({logKey:"activity_links",logOptions:{init_event:!1},logEnv:{location:document.location.pathname},events:{"activityLinks:*":"handleEvent"},handleEvent:function(t,e){this.log(t,e)}});e.exports=n},{"logs/instruments/base":482}],482:[function(t,e,i){"use strict";var s=t("backbone"),n=t("lodash"),o=t("prima/class"),a=t("prima/events"),r=t("prima/lib/logger"),l=[];l.push(t("prima/lib/loglady/endpoints/cslogger"));var h=/^\/(.+)\/([gimy]*)$/,c=o.extend({constructor:function(){this._eventHandlers=[],this.setupEndpoints(),this.initialize();var t=n.result(this,"events")||{};n.forEach(t,this._addEventHandlerByString,this);var e=n.result(this,"eventBus");this.listenTo(e,"all",this._handleEvent),r.log("LogLady","[instrument]",this.logKey)},logSpots:l,eventBus:a,_addEventHandlerByString:function(t,e){var i,s=e.match(h);if(s){var n=new RegExp(s[1],s[2]);i=function(t){var e=t.match(n);if(e){for(var i=new Array(e.length-1),s=0;s<e.length;s+=1)s>0&&(i[s-1]=e[s]);return i}}}else if("*"===e[e.length-1]){var o=e.substring(0,e.length-1);i=function(t){var e=t.indexOf(o);return 0===e?[t.substring(o.length,t.length)]:void 0}}else i=function(t){return t===e?[t]:null};this._addEventHandler(t,i)},_addEventHandler:function(t,e){this._eventHandlers.push({method:t,matcher:e})},_handleEvent:function(t,e){for(var i,s,o,a=this._eventHandlers.length-1;a>=0;a--)i=this._eventHandlers[a],o=i.callback||this[i.method],o&&(s=i.matcher.call(this,t,e),n.isArray(s)&&(e&&e.loggingData&&s.push(n.cloneDeep(e.loggingData)),o.apply(this,s)))},setupEndpoints:function(){var t=n.result(this,"logSpots");this.loggers=n(t).map(function(t){return t(this)},this).compact().value()},initialize:n.noop,log:function(){for(var t=this.loggers.length-1;t>=0;t--){var e=this.loggers[t];e.trigger.apply(e,arguments)}}},{start:function(){return this._setupInstance||(this._setupInstance=new this),this._setupInstance}});n.extend(c.prototype,s.Events),e.exports=c},{backbone:"5kFNoY",lodash:"MicNly","prima/class":509,"prima/events":512,"prima/lib/logger":519,"prima/lib/loglady/endpoints/cslogger":524}],483:[function(t,e,i){"use strict";var s=t("logs/instruments/base"),n=s.extend({logKey:"blocks",events:{"blocks:*":"handleEvent"},logEnv:{location:document.location.pathname},handleEvent:function(t,e){this.log(t,e)}});e.exports=n},{"logs/instruments/base":482}],484:[function(t,e,i){"use strict";var s=t("logs/instruments/base"),n=s.extend({logKey:"dashboard_sharing",events:{"dashboard-share:*":"handleEvent"},logEnv:{location:document.location.pathname},handleEvent:function(t,e){e=e||{},this.log(t,e)}});e.exports=n},{"logs/instruments/base":482}],485:[function(t,e,i){"use strict";var s=t("lodash"),n=t("logs/instruments/base"),o=n.extend({logKey:"dashboard_embed",logOptions:{init_event:!1},events:{"/^post:((?:un)?docked)$/":"handleEvent","post:embed:stateChange":"logStateChange"},handleEvent:function(t,e){var i=s.extend({},e);i.postData&&(i.post_id=i.postData.id,i.tumblelog=i.postData.tumblelog,delete i.postData),this.log(t,i)},logStateChange:function(t,e){if(!s.isEmpty(e)&&e.state&&e.postID&&e.service){if("tumblr"===e.service)return;this.log(e.state,{service:e.service,post_id:e.postID})}}});e.exports=o},{lodash:"MicNly","logs/instruments/base":482}],486:[function(t,e,i){"use strict";var s=t("logs/instruments/base"),n=s.extend({logKey:"explore_trending",logOptions:{init_event:!1},events:{"explore-trending:*":"log"},logEnv:{location:document.location.pathname}});e.exports=n},{"logs/instruments/base":482}],487:[function(t,e,i){"use strict";var s=t("logs/instruments/base"),n=s.extend({logKey:"external_inline_images",logOptions:{init_event:!1},events:{"external-inline-images:*":"handleEvent"},logEnv:{location:document.location.pathname},handleEvent:function(t,e){this.log(t,e)}});e.exports=n},{"logs/instruments/base":482}],488:[function(t,e,i){"use strict";var s=t("logs/instruments/base"),n=s.extend({logKey:"header_search",logEnv:{referrer:document.location.pathname},events:{"header_search:*":"log"}});e.exports=n},{"logs/instruments/base":482}],489:[function(t,e,i){"use strict";var s=t("logs/instruments/base"),n=s.extend({logKey:"helpform",events:{"helpform:*":"handleEvent"},logEnv:{location:document.location.pathname},handleEvent:function(t,e){this.log(t,e)}});e.exports=n},{"logs/instruments/base":482}],490:[function(t,e,i){"use strict";var s=t("logs/instruments/base"),n=s.extend({logKey:"keycommands_trigger",events:{"keycommands:*":"handleEvent"},initialize:function(){this.hasLoggedJK=!1},handleEvent:function(t,e){if("jk"===t){if(this.hasLoggedJK)return;this.hasLoggedJK=!0}this.log(t,e)}});e.exports=n},{"logs/instruments/base":482}],491:[function(t,e,i){"use strict";var s=t("logs/instruments/base"),n=s.extend({logKey:"linkpost_interactions",logOptions:{init_event:!1},events:{"linkpost:*":"handleEvent"},logEnv:{location:document.location.pathname},handleEvent:function(t,e){this.log(t,e)}});e.exports=n},{"logs/instruments/base":482}],492:[function(t,e,i){"use strict";var s=t("logs/instruments/base"),n=t("prima/lib/loglady/endpoints/lslogger/lslogger"),o=t("prima/lib/flags"),a=s.extend({logKey:null,logSpots:[],events:function(){var t={};return o.bool("little_sister_kill_switch")||(t["LSLog:*"]="log"),t},log:function(t,e){if(e&&e.pt){var i={pt:e.pt,eventName:t};e.video_details&&(i.video_details=e.video_details),n.log(e.pt).trigger(t,i),e.is_ad&&n.flush()}}});e.exports=a},{"logs/instruments/base":482,"prima/lib/flags":"f/LVtH","prima/lib/loglady/endpoints/lslogger/lslogger":531}],493:[function(t,e,i){"use strict";var s=t("logs/instruments/base"),n=t("prima/lib/flags"),o=s.extend({FLOW_VERSION_SINGLEFIELD:"singlefield",FLOW_VERSION_STANDARD:"standard",logKey:"loginregister",events:{"loginregister:*":"handleEvent"},initialize:function(){this.hasStartedFunnel=!1},logEnv:function(){return{actionType:"/login"===document.location.pathname?"login":"register",captchaType:"recaptcha",version:this._getFlowVersion()}},handleEvent:function(t,e){if("beginFlow"===t){if(this.hasStartedFunnel)return;this.hasStartedFunnel=!0}this.log(t,e)},_getFlowVersion:function(){return n.bool("oneid_force_newlandingpage")?this.FLOW_VERSION_SINGLEFIELD:this.FLOW_VERSION_STANDARD}});e.exports=o},{"logs/instruments/base":482,"prima/lib/flags":"f/LVtH"}],494:[function(t,e,i){"use strict";var s=t("logs/instruments/base"),n=s.extend({logKey:"messaging_interactions",logOptions:{init_event:!1},events:{"messaging-interaction:*":"handleEvent"},logEnv:{location:document.location.pathname},handleEvent:function(t,e){this.log(t,e)}});e.exports=n},{"logs/instruments/base":482}],495:[function(t,e,i){"use strict";var s=t("logs/instruments/base"),n=s.extend({logKey:"notes_interactions",logOptions:{init_event:!1},logEnv:{location:document.location.pathname},events:{"notes-interactions:click:*":"log"}});e.exports=n},{"logs/instruments/base":482}],496:[function(t,e,i){"use strict";var s=t("logs/instruments/base"),n=t("prima/lib/data"),o=s.extend({logKey:"verified_onboarding_blogs",logEnv:{context:n.get("Context/name"),location:document.location.pathname},logOptions:{init_event:!1},events:{"verifiedBlogs:*":"log"}});e.exports=o},{"logs/instruments/base":482,"prima/lib/data":514}],497:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/lib/data"),o=t("prima/lib/loglady/endpoints/cslogger"),a=t("prima/lib/loglady/utils/uuid"),r=t("logs/instruments/base"),l=r.extend({logKey:"peepr",logEnv:{baseSessionId:n.get("Components/LogLady/default_session"),context:n.get("Context/name")},events:{"peepr:message:*":"logMessage","peepr:open":"logOpen","peepr:close":"logClose","peepr:log:*":"logMessage"},logMessage:function(t,e){this.log(t,e.payload)},logOpen:function(){this.logger()},logClose:function(){this._logger.stop(),this._logger=null},setupEndpoints:s.noop,logOptions:function(){return{uuid:a()}},logger:function(){return this._logger||(this._logger=o(this)),this._logger},log:function(){var t=this.logger();t.trigger.apply(t,arguments)}});e.exports=l},{lodash:"MicNly","logs/instruments/base":482,"prima/lib/data":514,"prima/lib/loglady/endpoints/cslogger":524,"prima/lib/loglady/utils/uuid":537}],498:[function(t,e,i){"use strict";var s=t("logs/instruments/base"),n=s.extend({logKey:"gifsearch_interactions",logOptions:{init_event:!1},events:{"gifsearch:*":"handleEvent"},logEnv:{location:document.location.pathname},handleEvent:function(t,e){"unload"!==t&&this.log(t,e)}});e.exports=n},{"logs/instruments/base":482}],499:[function(t,e,i){"use strict";var s=t("logs/instruments/base"),n=s.extend({logKey:"postform_interactions",logOptions:{init_event:!1},events:{"postform-interaction:*":"handleEvent"},logEnv:{location:document.location.pathname},handleEvent:function(t,e){this.log(t,e)}});e.exports=n},{"logs/instruments/base":482}],500:[function(t,e,i){"use strict";var s=t("logs/instruments/base"),n=s.extend({logKey:"reactivation",logOptions:{init_event:!1},events:{"reactivation:*":"handleEvent"},logEnv:{location:document.location.pathname},handleEvent:function(t,e){this.log(t,e)}});e.exports=n},{"logs/instruments/base":482}],501:[function(t,e,i){"use strict";var s=t("logs/instruments/base"),n=t("prima/lib/data"),o=s.extend({logKey:"recommended_blogs",logEnv:{context:n.get("Context/name"),location:document.location.pathname},logOptions:{init_event:!1},events:{"recommendedBlogs:*":"log"}});e.exports=o},{"logs/instruments/base":482,"prima/lib/data":514}],502:[function(t,e,i){"use strict";var s=t("logs/instruments/base"),n=s.extend({logKey:"related_recommendations",logOptions:{init_event:!1},events:{"rapid-recommendations:*":"handleEvent"},logEnv:{location:document.location.pathname},handleEvent:function(t,e){this.log(t,e)}});e.exports=n},{"logs/instruments/base":482}],503:[function(t,e,i){"use strict";var s=t("logs/instruments/base"),n=s.extend({logKey:"roadblock",events:{"roadblock:*":"log"}});e.exports=n},{"logs/instruments/base":482}],504:[function(t,e,i){"use strict";var s=t("logs/instruments/base"),n=s.extend({logKey:"tourguide_account",logEnv:{referrer:document.location.pathname},logOptions:{init_event:!1},events:{"TourGuideAccount:*":"log"}});e.exports=n},{"logs/instruments/base":482}],505:[function(t,e,i){"use strict";var s=t("lodash"),n=t("logs/instruments/base"),o=n.extend({logKey:"vendorbutton",logEnv:{referrer:document.location.pathname},events:{"VendorButton:*":"handleEvent"},handleEvent:function(t,e){var i=s.extend({},e);i.post_id=e.postData.id,i.root_post_id=e.postData.root_id,i.tumblelog=e.postData.tumblelog,delete i.postData,this.log(t,i)}});e.exports=o},{lodash:"MicNly","logs/instruments/base":482}],506:[function(t,e,i){"use strict";var s=t("lodash"),n=t("logs/instruments/base"),o=n.extend({logKey:"videoplayer",logEnv:{referrer:document.location.pathname},events:{"VideoPlayer:cacheUnload":"cacheUnloadLog","VideoPlayer:timeupdate":"updateLogCache","VideoPlayer:*":"handleEvent"},initialize:function(){this.excludedEvents=["cacheUnload","timeupdate"],this.unloadData={},s.each(this.loggers,function(t){t.before_unloaded=s.bind(this.beforeUnloaded,this)},this)},handleEvent:function(t,e){if(!s.contains(this.excludedEvents,t)){var i=s.extend({},e);i.postData&&(i.post_id=i.postData.id,delete i.postData),this.log(t,i)}},cacheUnloadLog:function(t,e){this.unloadData[e.id]=e},beforeUnloaded:function(t){s.each(this.unloadData,function(t){this.handleEvent("unload",t)},this)},updateLogCache:function(t,e){var i=["elapsed","position"];this.unloadData[e.id]=s.extend(this.unloadData[e.id],s.pick(e,i))}});e.exports=o},{lodash:"MicNly","logs/instruments/base":482}],507:[function(t,e,i){"use strict";var s=t("lodash"),n={loadedLogs:[],init:function(){},startLogs:function(t){s.each(t,function(t){var e=t.start();this.loadedLogs.push(e.logKey)},this)},startLog:function(t){this.startLogs([t])}};e.exports=n},{lodash:"MicNly"}],508:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/class"),o=t("prima/lib/data"),a=t("prima/lib/logger"),r=t("prima/lib/translate"),l=t("prima/lib/templateutils"),h=t("logs/logging-manager"),c=n.extend({constructor:function(t){s.isEmpty(t)&&(t=this._getBootstrap()),this.setup(t),this.initialize()},setup:function(t){if(s.isEmpty(t),!1)throw new Error("No bootstrap data for the bootloader O_O");o.setup(t),a.log("Exec","Bootstrap/Data"),r.setup(t.Translations),a.log("Exec","Bootstrap/Translations"),h.init(),a.log("Exec","Bootstrap/logs")},initialize:function(){throw new Error("No router defined")},_getBootstrap:function(){var t={},e=document.getElementById("bootloader");return e&&(t=JSON.parse(e.getAttribute("data-bootstrap")),e.parentNode.removeChild(e)),t}});s.extend(s.templateSettings.imports,l),e.exports=c},{lodash:"MicNly","logs/logging-manager":507,"prima/class":509,"prima/lib/data":514,"prima/lib/logger":519,"prima/lib/templateutils":539,"prima/lib/translate":541}],509:[function(t,e,i){"use strict";function s(){}var n=t("backbone"),o=t("./lib/extendwithmixins");s.extend=n.Model.extend,o.applyTo(s),e.exports=s},{"./lib/extendwithmixins":518,backbone:"5kFNoY"}],510:[function(t,e,i){"use strict";var s=t("backbone").Collection,n=t("./mixins/withformkeytrue"),o=t("./lib/extendwithmixins"),s=s.extend();n.applyTo(s.prototype),o.applyTo(s),e.exports=s},{"./lib/extendwithmixins":518,"./mixins/withformkeytrue":556,backbone:"5kFNoY"}],511:[function(t,e,i){"use strict";var s=t("lodash"),n=t("backbone"),o=t("./class"),a=t("./lib/data"),r=(t("./lib/logger"),t("./utils/ensure-element")),l=t("./mixins/accessor/simple"),h=["selector","container","rootEl","view","viewOptions","autoAppend"],c=o.extend({name:null,rootEl:null,selector:null,view:null,viewOptions:{},autoAppend:!1,defaults:{},constructor:function(t){t||(t={}),this.cid=s.uniqueId("component"),s.extend(this,s.pick(t,h));var e=s.result(this,"defaults"),i=s.extend({},e,s.pick(t,s.keys(e)));this.attributes={},this.set(i,{silent:!0}),this.changed={},(this.autoAppend||this.selector)&&this.setContainer(),this.selector||(this.selector=this.defaultSelector),this.view&&this.view.prototype&&this.view.prototype instanceof n.View?this.view=new this.view(this.viewOptions):s.isFunction(this.view)&&(this.view=this.view.call(this,this.viewOptions)),this.initialize.apply(this,arguments),this.autoAppend&&this.append()},initialize:s.noop,setContainer:function(){return this.selector||(this.selector=this.defaultSelector),this.container=this.selector,this.container},getOwnData:function(){return this.data},remove:function(){s.result(this,"beforeRemove"),this.view&&s.isFunction(this.view.remove)&&this.view.remove();var t=["container","view","defaults","attributes"];return s.each(t,s.bind(function(t){this[t]&&delete this[t]},this)),this.stopListening(),this.trigger("remove"),this},append:function(){return this.view&&s.isFunction(this.view.render)&&(this.container?this.container.appendChild(this.view.render().el):this.view.render()),this.trigger("append"),this}});Object.defineProperties(c.prototype,{defaultSelector:{get:function(){return"[prima-component="+this.name+"]"},set:function(){}},container:{get:function(){return this._container},set:function(t){var e=r(t,this.rootEl);this._container=e}},data:{get:function(){return this._data||(this._data=a.get("Components/"+this.name)),this._data},set:function(t){this._data=t}}}),l.mixin.applyTo(c.prototype),e.exports=c},{"./class":509,"./lib/data":514,"./lib/logger":519,"./mixins/accessor/simple":543,"./utils/ensure-element":568,backbone:"5kFNoY",lodash:"MicNly"}],512:[function(t,e,i){"use strict";var s=t("lodash"),n=t("backbone"),o=function(){};o.extend=n.Model.extend,s.extend(o.prototype,n.Events),o.prototype.trigger=function(){return s.isObject(arguments[1])&&(arguments[1].loggingData=arguments[1].loggingData||{}),n.Events.trigger.apply(this,arguments)},e.exports=new o},{backbone:"5kFNoY",lodash:"MicNly"}],513:[function(t,e,i){"use strict";function s(t,e){this.options=n.extend({preventInteraction:!1,ignoreSelectors:[]},e),this._onClick=n.bind(this._onClick,this,t),document.addEventListener("click",this._onClick,!0)}var n=t("lodash"),o=t("jquery"),a=t("backbone");s.prototype._isForcedInsideTarget=function(t){return n.isEmpty(this.options.ignoreSelectors)?!1:!n.isEmpty(t.closest(this.options.ignoreSelectors.join(",")))},s.prototype._onClick=function(t,e){var i=o(e.target);t===e.target||o.contains(t,e.target)||this._isForcedInsideTarget(i)?this.trigger("click:inside",e):(this.trigger("click:outside"),
this.options.preventInteraction&&(e.preventDefault(),e.stopPropagation()))},s.prototype.remove=function(){return document.removeEventListener("click",this._onClick,!0),this.off(),this},n.extend(s.prototype,a.Events),e.exports=s},{backbone:"5kFNoY",jquery:"HlZQrA",lodash:"MicNly"}],514:[function(t,e,i){"use strict";function s(t){if(!a)throw new Error("Data hasn't been initialized with `setup`.");if(!r.isString(t))return null;var e=r.get(a,t.replace(/\//g,"."));return r.cloneDeep(e)}function n(t){if(!a)throw new Error("Data hasn't been initialized with `setup`.");return r.isString(t)?r.has(a,t.replace(/\//g,".")):null}function o(t){a=r.isObject(t)?t:{}}var a,r=t("lodash");e.exports={get:s,has:n,setup:r.once(o)}},{lodash:"MicNly"}],515:[function(t,e,i){"use strict";function s(t){t=n.extend({entries:{},name:"Dictionary"},t),this._hadLastLookup=!1,this._entries=t.entries,this._name=t.name}var n=t("lodash"),o=(t("./logger"),t("sprintf-js").sprintf),a=function(t,e,i){null!=i||(i=this);var s=t.apply(i,e);return e=Array.prototype.slice.call(e,1),e.unshift(s),e};s.prototype.addEntries=function(t){return n.extend(this._entries,t),this},s.prototype.lookup=function(t){return n.has(this._entries,t)?(this._hadLastLookup=!0,this._entries[t]):(this._hadLastLookup=!1,t)},s.prototype.lookupWithFormatting=function(t){var e;return arguments.length>1?(e=this.lookup(o.apply(this,arguments)),this._hadLastLookup||(e=o.apply(this,a(this.lookup,arguments,this)))):e=this.lookup(t),e},s.prototype.get=function(t){var e=this.lookupWithFormatting.apply(this,arguments);return!this._hadLastLookup&&this.logMissing,e},s.prototype.getEntries=function(){return n.cloneDeep(this._entries)},e.exports=s},{"./logger":519,lodash:"MicNly","sprintf-js":"qPOUxN"}],516:[function(t,e,i){"use strict";function s(){function t(t){o(),u.trigger("DOMEventor:flatresize",m),e=!1}var e;p.on("resize.DOMEventor-nextResizeLoop",function(){e||(f(t),e=!0)})}function n(){function t(t){i--||(g.documentHeight=m.documentHeight,m.documentHeight=d.height(),i=1),g.windowScrollTop=g.windowScrollY=m.windowScrollTop,m.windowScrollTop=m.windowScrollY=p.scrollTop(),u.trigger("DOMEventor:flatscroll",m),e=!1}var e,i=0;p.on("scroll.DOMEventor-nextScrollLoop",function(){e||(f(t),e=!0)})}function o(){g.documentHeight=m.documentHeight,m.documentHeight=d.height(),g.windowHeight=m.windowHeight,m.windowHeight=p.height(),g.windowWidth=m.windowWidth,m.windowWidth=p.width(),g.windowScrollTop=g.windowScrollY=m.windowScrollTop,m.windowScrollTop=m.windowScrollY=p.scrollTop()}function a(){var t=[],e={8:"backspace",9:"tab",13:"enter",16:"shift",17:"ctrl",18:"alt",20:"capslock",27:"escape",32:"space",33:"pageup",34:"pagedown",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",45:"insert",46:"delete",48:"0",49:"1",50:"2",51:"3",52:"4",53:"5",54:"6",55:"7",56:"8",57:"9",65:"a",66:"b",67:"c",68:"d",69:"e",70:"f",71:"g",72:"h",73:"i",74:"j",75:"k",76:"l",77:"m",78:"n",79:"o",80:"p",81:"q",82:"r",83:"s",84:"t",85:"u",86:"v",87:"w",88:"x",89:"y",90:"z",91:"leftmeta",92:"rightmeta",93:"rightmeta",96:"num0",97:"num1",98:"num2",99:"num3",100:"num4",101:"num5",102:"num6",103:"num7",104:"num8",105:"num9",106:"multiply",107:"add",109:"subtract",110:"decimal",111:"devide",112:"f1",113:"f2",114:"f3",115:"f4",116:"f5",117:"f6",118:"f7",119:"f8",120:"f9",121:"f10",122:"f11",123:"f12",144:"numlock",145:"scrolllock",186:"semicolon",187:"equal",188:"comma",189:"dash",190:"period",191:"forwardslash",192:"graveaccent",219:"openbracket",220:"backslash",221:"closebracket",222:"singlequote"};d.on("keydown.DOMEventor keyup.DOMEventor",function(i){var s=i.type;if("keyup"===s||"keydown"===s){var n=c(i.target),o=i.which;if(!((n.is("input")||n.is("textarea")||n.is("select"))&&o>=48&&90>=o)||i.metaKey||i.ctrlKey||i.altKey){o>=48&&90>=o&&"keydown"===s&&(t[o]=1);var a="";for(var r in t)"keydown"===s&&o!==parseInt(r,10)&&(a+=e[r]?e[r]+"+":"");var l=s+":"+(i.altKey&&18!==o?"alt+":"")+(i.ctrlKey&&17!==o?"ctrl+":"")+(i.metaKey&&91!==o&&92!==o&&93!==o?"meta+":"")+(i.shiftKey&&16!==o?"shift+":"")+(a||"")+(e[o]||"");u.trigger("DOMEventor:"+l,i,l),"keyup"===s&&(t=[])}}}),u.off("DOMEventor:startKeyboardObserver"),u.on("DOMEventor:stopKeyboardObserver",r)}function r(){d.off("keydown.DOMEventor keyup.DOMEventor"),u.on("DOMEventor:startKeyboardObserver",a),u.off("DOMEventor:stopKeyboardObserver")}function l(){o(),n(),s(),a(),u.on("DOMEventor:updateRect",o)}var h=t("lodash"),c=t("jquery"),u=t("../events"),d=c(document),p=c(window),m={},g={};m.documentHeight=g.documentHeight=null,m.windowHeight=g.windowHeight=null,m.windowWidth=g.windowHeight=null,m.windowScrollTop=g.windowScrollTop=null,m.windowScrollY=g.windowScrollY=null;var f=!Object.hasOwnProperty.call(window,"requestAnimationFrame")&&window.requestAnimationFrame||!Object.hasOwnProperty.call(window,"webkitRequestAnimationFrame")&&window.webkitRequestAnimationFrame||!Object.hasOwnProperty.call(window,"mozRequestAnimationFrame")&&window.mozRequestAnimationFrame||!Object.hasOwnProperty.call(window,"oRequestAnimationFrame")&&window.oRequestAnimationFrame||function(t){window.setTimeout(function(){t()},50)},_={init:h.once(l),rect:function(){return m},lastRect:function(){return g}};e.exports=_},{"../events":512,jquery:"HlZQrA",lodash:"MicNly"}],517:[function(t,e,i){"use strict";function s(t){function e(){a.removeEventListener("DOMContentLoaded",e),t()}a.addEventListener("DOMContentLoaded",e)}function n(t){o||(o=/^loaded|^i|^c/.test(a.readyState)),o?setTimeout(t):s(t)}var o,a=document;e.exports=n},{}],518:[function(t,e,i){"use strict";function s(t){var e=a.apply(this,arguments);return o.has(t,"mixins")&&t.mixins.forEach(function(t){t.applyTo(e.prototype)}),e}function n(t){t.extend=s}var o=t("lodash"),a=t("backbone").Model.extend;e.exports.applyTo=n},{backbone:"5kFNoY",lodash:"MicNly"}],519:[function(t,e,i){"use strict";var s=t("lodash"),n=(t("./domready"),{}),o=function(){return n};n.log=o,n.logSaw=o,n.count=s.noop,n.echo=o,n.flush=o,n.flushCount=o,n.groupNameWithUrl=s.identity,e.exports=n},{"./domready":517,lodash:"MicNly"}],520:[function(t,e,i){"use strict";function s(t){this.watching={},this.pending_events=[],this.endpoint=t.endpoint,t.event_payload_name&&(this.event_payload_name=t.event_payload_name),t.event_filter&&(this.event_filter=t.event_filter),t.payload_formatter&&(this.payload_formatter=t.payload_formatter),n.bindAll(this,"_flush_from_timeout"),this._flush_from_timeout();var e=t.EventClass||f;this.Log=g.extend({EventClass:e}),o(window).on("beforeunload.log_lady",n.bind(this._flush_on_unload,this)),this.set_flush_rate()}var n=t("lodash"),o=t("jquery"),a=t("backbone"),r=(t("prima/lib/logger"),t("prima/lib/flags")),l=t("prima/utils/realnow"),h=l.getRealNow,c=t("../utils/extend-with-defaults"),u=t("../utils/uuid"),d=t("../utils/send-beacon"),p=[].slice,m=t("./config"),g=t("./log"),f=t("./logladyphp/event"),_=1e3;n.extend(s.prototype,a.Events,{initialize:n.noop,defaults:{flush_rate:15*_},min_flush_rate:function(){var t=n.map(this.watching,function(t){return n.result(t,"flush_rate")});return t.push(this.defaults.flush_rate),n.min(t)},set_flush_rate:function(t){return t&&(this.defaults.flush_rate=t),this.flush_rate=this.min_flush_rate(),this.flush_is_overdue()&&this._flush_from_timeout(),this.flush_rate},flush:function(){var t=this.build_payload();if(!(t[this.event_payload_name].length<1)&&r.bool("log_lady"))return d(this.endpoint,t,!this.unloading),this.last_flush_at=h(),!0},_flush_on_unload:function(){this._flush_timeout&&clearTimeout(this._flush_timeout),this._trigger_unloads(),this.unloading=!0,this.flush()},_trigger_unloads:function(){var t;for(var e in this.watching)t=this.watching[e],"function"==typeof t.unloaded&&t.unloaded()},_flush_from_timeout:function(){this._flush_timeout&&clearTimeout(this._flush_timeout);var t=this.flush();t!==!1&&(this._flush_timeout=setTimeout(this._flush_from_timeout,this.flush_rate))},flush_is_overdue:function(){this.last_flush_at||(this.last_flush_at=h());var t=h()-this.last_flush_at;return t>this.flush_rate},watch:function(){var t,e,i,s=p.apply(arguments);for(i=0;i<s.length;i++)t=s[i],this.is_valid(t)&&(t.log_lady=this,this.watching[t.log_key]&&(e=this.watching[t.log_key],e&&n.isFunction(e.replaced)&&e.replaced(t)),this.watching[t.log_key]=t);return this.set_flush_rate(),this},unwatch:function(t){this.watching[t.log_key]&&t&&n.isFunction(t.replaced)&&t.replaced(),delete this.watching[t.log_key]},pending_log_events:function(){var t=this.pending_events;return this.pending_events=[],t},event_payload_name:"payload",payload_formatter:function(t){return t},event_filter:function(){return!0},build_payload:function(){var t=n.merge({},this.watching,[this]),e=n(t).collect(function(t){return t.pending_log_events()}).flatten().filter(this.event_filter).collect(n.bind(function(t){return t.json},this)).value(),i={};return i[this.event_payload_name]=this.payload_formatter(e),i},is_valid:function(t){var e=!!t;return e&&(e=n.result(t,"log_key")),e&&(e=n.result(t,"uuid")),e&&(e=n.isFunction(t.pending_log_events)),e},log:function(t,e){if(t){if(!(t in this.watching)){e&&e.log_key&&console.warn("log key gets overridden by log name");var i=m("keys",t);e=n.extend({},i,e,{log_key:t});var s=new this.Log(e);this.watch(s)}return this.watching[t]}},new_uuid:u}),s.extend=c,s.Log=g,e.exports=s},{"../utils/extend-with-defaults":535,"../utils/send-beacon":536,"../utils/uuid":537,"./config":522,"./log":526,"./logladyphp/event":528,backbone:"5kFNoY",jquery:"HlZQrA",lodash:"MicNly","prima/lib/flags":"f/LVtH","prima/lib/logger":519,"prima/utils/realnow":575}],521:[function(t,e,i){"use strict";var s,n=t("prima/lib/data"),o=function(){return s||(s=n.get("Components/LogLady")),s};e.exports=o()},{"prima/lib/data":514}],522:[function(t,e,i){"use strict";function s(){for(var t,e=a.apply(arguments),i=o,s=0;s<e.length;s++){if(t=e[s],!i||!n.has(i,t))return;i=i[t]}return i}var n=t("lodash"),o=t("./bootstrap"),a=[].slice;e.exports=s},{"./bootstrap":521,lodash:"MicNly"}],523:[function(t,e,i){"use strict";function s(t){return o.isString(t)?t:JSON.stringify(t)}function n(t,e,i){this.name=e,this.log_key=o.result(t,"log_key"),this.data=i||null;var n=l(),a=o.result(t,"generate_relative_id"),c=o.result(t,"env"),u=t.uuid,d={category:this.log_key},p=8,m=new Array(p);m[0]=s(n),m[1]=s(h),m[2]=s(u),m[3]=s(a),m[4]=s(r.getElapsed(n)),m[5]=s(e),m[6]=s(i),m[7]=s(c),d.fields=m,this.json=d}var o=t("lodash"),a=t("prima/utils/cookie"),r=t("prima/utils/realnow"),l=r.getRealNow,h=a.get("tmgioct");e.exports=n},{lodash:"MicNly","prima/utils/cookie":565,"prima/utils/realnow":575}],524:[function(t,e,i){"use strict";function s(t){var e=n.result(t,"logKey"),i=n.result(t,"logEnv");if(e){var s=n.result(t,"logOptions")||{};return i&&(s.env=i),o.log(e,s)}}var n=t("lodash"),o=t("./logger");e.exports=s},{"./logger":525,lodash:"MicNly"}],525:[function(t,e,i){"use strict";var s=t("../base"),n=t("./event"),o=new s({EventClass:n,event_payload_name:"payload",event_filter:function(){return!0},endpoint:"/services/cslog"});e.exports=o},{"../base":520,"./event":523}],526:[function(t,e,i){"use strict";function s(t,e){t.uuid?(e=t,t=e.uuid):e||!t||n.isString(t)||(e=t,t=void 0),this.options=n.extend({},this.defaults,e),delete this.options.log_key,delete this.options.env,delete this.options.uuid,l(this,"uuid",t||this._generate_uuid()),e.env||(e.env={}),n.each(e.flags,function(t){e.env.flags||(e.env.flags={}),e.env.flags[t]=a.bool(t)}),l(this,"env",e.env),this.log_key=e.log_key||this.log_key,this.events=[],this.event_count=0,this.pending_events=[],this.event_counts={},this.started_at||(this.started_at=this.options.started_at||r.getRealNow()),delete this.options.started_at,this.initialize(e),this.options.init_event&&this.trigger("init")}var n=t("lodash"),o=t("backbone"),a=t("prima/lib/flags"),r=t("prima/utils/realnow"),l=t("../utils/define-immutable-property"),h=t("../utils/extend-with-defaults"),c=t("../utils/uuid"),u=t("./config"),d=t("./logladyphp/event");n.extend(s.prototype,o.Events,{EventClass:d,initialize:n.noop,_generate_uuid:function(){return u("default_session")||c()},defaults:{init_event:!0,keep_counts:!1},pending_log_events:function(){var t=this.pending_events;return this.pending_events=[],t},generate_relative_id:function(){return this.event_count},unloaded:function(t){t||(t={}),t=this.before_unloaded(t)||{},this.options.keep_counts&&n.extend(t,{event_counts:this.event_counts}),n.isEmpty(t)||this.trigger("unload",t)},before_unloaded:function(t){return t},replaced:function(t){this.before_replaced(t);for(var e=this.pending_log_events();e.length;)this.log_lady.pending_events.push(e.shift())},before_replaced:n.noop,stop:function(){this.log_lady&&this.log_lady.unwatch(this)},trigger:function(t,e){var i=new this.EventClass(this,t,e);return this.options.keep_counts&&"init"!==t&&"unload"!==t&&(this.event_counts[t]||(this.event_counts[t]=0),this.event_counts[t]++),this.event_count+=1,this.pending_events.push(i),o.Events.trigger.call(this,t,i,this),this}}),s.extend=h,e.exports=s},{"../utils/define-immutable-property":534,"../utils/extend-with-defaults":535,"../utils/uuid":537,"./config":522,"./logladyphp/event":528,backbone:"5kFNoY",lodash:"MicNly","prima/lib/flags":"f/LVtH","prima/utils/realnow":575}],527:[function(t,e,i){"use strict";var s=t("lodash"),n=t("../config"),o=s.keys(n("keys"));e.exports=function(t){return o.indexOf(t.log_key)>=0}},{"../config":522,lodash:"MicNly"}],528:[function(t,e,i){"use strict";function s(t,e,i){this.name=e,this.log_key=n.result(t,"log_key"),this.data=i||null;var s=a(),o=n.result(t,"generate_relative_id"),l=n.result(t,"env"),h=t.uuid,c={};c.log_key=this.log_key,c.uuid=h,c.event=this.name,c.ts=s,o!==!1&&void 0!==o&&(c.rid=o),c.elapsed=c.ts-r,c.data=this.data,c.env=l,this.json=c}var n=t("lodash"),o=t("prima/utils/realnow"),a=o.getRealNow,r=o.realStartedAt;e.exports=s},{lodash:"MicNly","prima/utils/realnow":575}],529:[function(t,e,i){"use strict";var s=t("prima/events"),n=t("../base"),o=t("./event"),a=t("./event-filter"),r=new n({EventClass:o,event_payload_name:"events",event_filter:a,endpoint:"/svc/log/lady"});s.on("Capture:push",function(t,e,i){r.log(t,{init_event:!1}).trigger(e,i)}),e.exports=r},{"../base":520,"./event":528,"./event-filter":527,"prima/events":512}],530:[function(t,e,i){"use strict";function s(t,e,i){this.name=e,this.log_key=n.result(t,"log_key"),this.data=i||{};var s=a(),o={pt:this.data.pt,event_data:{timestamp:s,eventString:this.data.eventName}};this.data.video_details&&(o.event_data.data=this.data.video_details),this.json=o}var n=t("lodash"),o=t("prima/utils/realnow"),a=o.getRealNow;e.exports=s},{lodash:"MicNly","prima/utils/realnow":575}],531:[function(t,e,i){"use strict";function s(t){var e=[];return n.forEach(t,function(t){var i=n.find(e,{pt:t.pt});i||(i={pt:t.pt,events:[]},e.push(i)),i.events.push(t.event_data)}),e}var n=t("lodash"),o=t("../base"),a=t("./event"),r=new o({EventClass:a,event_payload_name:"trackers",event_filter:function(t){return t.data&&t.data.pt},payload_formatter:s,endpoint:"https://ls.srvcs.tumblr.com/services/bblog"});e.exports=r},{"../base":520,"./event":530,lodash:"MicNly"}],532:[function(t,e,i){"use strict";var s=t("./endpoints/logladyphp/logger");e.exports=s},{"./endpoints/logladyphp/logger":529}],533:[function(t,e,i){"use strict";function s(t){var e,i;Object.freeze(t);for(i in t)e=t[i],t.hasOwnProperty(i)&&null!==e&&"object"==typeof e&&!Object.isFrozen(e)&&s(e)}e.exports=s},{}],534:[function(t,e,i){"use strict";function s(t,e,i){n.isObject(i)&&o(i),Object.defineProperty(t,e,{value:i,writeable:!1,enumerable:!0,configurable:!1})}var n=t("lodash"),o=t("./deepfreeze");e.exports=s},{"./deepfreeze":533,lodash:"MicNly"}],535:[function(t,e,i){"use strict";function s(t,e){var i,s=this;i=t&&n.has(t,"constructor")?t.constructor:function(){return s.apply(this,arguments)},n.extend(i,s,e);var o=function(){this.constructor=i};return o.prototype=s.prototype,i.prototype=new o,t.defaults&&(n.extend(i.prototype.defaults,t.defaults),delete t.defaults),t&&n.extend(i.prototype,t),i.__super__=s.prototype,i}var n=t("lodash");e.exports=s},{lodash:"MicNly"}],536:[function(t,e,i){"use strict";function s(t,e,i){return!!a.ajax({url:t,type:"POST",data:JSON.stringify(e),contentType:"text/plain",async:i})}function n(t,e,i){var n=window.navigator.sendBeacon(t,JSON.stringify(e));return n||(n=s(t,e,i)),n}var o,a=t("jquery");o=window.navigator&&window.navigator.sendBeacon?n:s,e.exports=o},{jquery:"HlZQrA"}],537:[function(t,e,i){"use strict";function s(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var e=16*Math.random()|0,i="x"===t?e:3&e|8;return i.toString(16)})}e.exports=s},{}],538:[function(t,e,i){"use strict";function s(t,e){c.each(e,function(e,i){var s=t[i];t[i]=function(){return e.apply(this,arguments),s.apply(this,arguments)}})}function n(t,e){c.each(e,function(e,i){var s=t[i];t[i]=function(){var t=s.apply(this,arguments);return e.apply(this,arguments),t}})}function o(t,e){c.each(e,function(e,i){var s=t[i];t[i]=function(){var t=c.toArray(arguments);return t.unshift(c.bind(s,this)),e.apply(this,t)}})}function a(t,e){c.each(e,function(e,i){var s=i in t?t[i]:!1;t[i]=function(){var t=c.toArray(arguments),i=s?c.bind(s,this):c.noop;return t.unshift(i),e.apply(this,t)}})}function r(t,e){c.defaults(t,e)}function l(t,e){c.extend(t,e)}function h(){this.mixins=c.filter(arguments,function(t){return t instanceof h}),this.properties=arguments[this.mixins.length]||{}}var c=t("lodash");h.prototype.mixins=null,h.prototype.properties=null,h.prototype.applyTo=function(t){var e=this.properties;r(t,e.defaults),l(t,e.extend),c.extend(t,c.omit(e,"before","after","around","onto","defaults","extend","applyTo")),c.invoke(this.mixins,"applyTo",t),s(t,e.before),n(t,e.after),o(t,e.around),a(t,e.onto),c.isFunction(e.applyTo)&&e.applyTo.apply(this,arguments)},h.before=s,h.after=n,h.around=o,h.onto=a,e.exports=h},{lodash:"MicNly"}],539:[function(t,e,i){"use strict";var s=t("sprintf-js").sprintf,n=t("prima/lib/translate"),o=t("./subview");t("prima/lib/logger");e.exports={__:n,sprintf:s,_subview:o}},{"./subview":540,"prima/lib/logger":519,"prima/lib/translate":541,"sprintf-js":"qPOUxN"}],540:[function(t,e,i){"use strict";e.exports=function(t){return'<noscript data-subview="'+t+'"></noscript>'}},{}],541:[function(t,e,i){"use strict";function s(t){a.addEntries(n.isObject(t)?t:{})}var n=t("lodash"),o=t("./dictionary"),a=new o({name:"Translations"}),r=n.bind(a.get,a);r.setup=n.once(s),e.exports=r},{"./dictionary":515,lodash:"MicNly"}],542:[function(t,e,i){"use strict";var s=t("lodash"),n=t("backbone"),o=t("../../lib/mixin"),a=t("./simple"),r=new o(s.extend({},a.props,{defaults:s.extend({},n.Events),before:{initialize:function(){var t=s.defaults({},s.result(this,"defaults"));this.attributes={},this.set(t),this.changed={}}}}));e.exports=r},{"../../lib/mixin":538,"./simple":543,backbone:"5kFNoY",lodash:"MicNly"}],543:[function(t,e,i){"use strict";var s=t("lodash"),n=t("backbone"),o=t("../../lib/mixin"),a=n.Model.prototype,r={get:a.get,has:a.has,set:a.set,unset:a.unset,clear:a.clear,hasChanged:a.hasChanged,changedAttributes:a.changedAttributes,previous:a.previous,toJSON:a.toJSON,toggle:function(t){this.set(t,!this.get(t))},_validate:s.constant(!0)},l=new o(s.extend({},r,{defaults:s.extend({},n.Events)}));e.exports={props:r,mixin:l}},{"../../lib/mixin":538,backbone:"5kFNoY",lodash:"MicNly"}],544:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/lib/mixin"),o=new n({defaults:{removeCollectionSubviews:function(t){var e=this[t];this.subviews[t]&&!s.isEmpty(e)&&(e=this[t],this._subviews=s.difference(this._subviews,e),s.invoke(e,"remove"),this[t].length=0)},removeCollectionSubview:function(t,e){var i,n=this[t];this.subviews[t]&&!s.isEmpty(n)&&(i=s.findWhere(n,{model:e}),i&&(this._subviews=s.without(this._subviews,i),i.remove(),this[t]=s.without(this[t],i)))},addNewCollectionSubview:function(t,e,i){var n=this.subviews[t];if(i||(i=this._getSubviewCollection(t)),n&&i){var o=n.container||this._createDefaultContainerFunction(t),a=n.prepareViewForAdd||this._createDefaultPrepareViewForAddFunction(t),r=n.options||{},l={insertionIndex:i.indexOf(e)},h=s.has(this,t),c=this.createCollectionSubviewRenderer([e],o,a,r,t,h,l);return this._isBatchRenderingInProgress(t)?void this.once("rendered:"+t,c,this):void(this.rendered?c():this.once("rendered",c,this))}},sortCollectionSubviews:function(t,e){var i,n=this.subviews[t];e||(e=this._getSubviewCollection(t)),n&&e&&this[t]&&(i=s.pluck(e.models,"cid"),i=s.zipObject(i,s.range(0,i.length)),this[t]=s.sortBy(this[t],function(t){return s.get(i,t.model.cid,0)}))},batchRenderCollectionSubviews:function(t){var e=this.subviews[t];if(e){var i=e.container||this._createDefaultContainerFunction(t),n=e.prepareView||this._createDefaultPrepareViewFunction(t),o=e.options||{},a=s.result(e,"batchSize")||5,r=s.result(e,"batchDelay")||100,l=this._getSubviewCollection(t),h=s.chunk(l.models,a),c=s.map(h,function(e,a){return s.bind(function(){var s=this.createCollectionSubviewRenderer(e,i,n,o,t,a>0);return s.call(this)},this)},this),u=s.bind(function(){this._scheduleBatchRenders(t,c,r)},this);this.rendered?u():this.once("rendered",u,this)}},_isBatchRenderingInProgress:function(t){return s.get(this._deferredRenders,t,[]).length>0},_scheduleBatchRenders:function(t,e,i){var n=e.length,o=function(){this._afterBatchRenderCollectionSubviews(t)},a=function(e){e.call(this,t),this._afterEachBatchRenderCollectionSubviews(t),n--,0===n&&o.call(this)};return this._deferredRenders||(this._deferredRenders={}),s.has(this._deferredRenders,t)||(this._deferredRenders[t]=[]),this._cancelBatchRenders(t),0===n?void o.call(this):void s.each(e,function(e,n){var o;return 0===n?void a.call(this,e):(o=setTimeout(s.bind(function(){a.call(this,e),this._deferredRenders[t]=s.without(this._deferredRenders[t],o)},this),i*(n+1)),void this._deferredRenders[t].push(o))},this)},_cancelBatchRenders:function(t){s.isEmpty(this._deferredRenders)||(s.isEmpty(t)||s.has(this._deferredRenders,t))&&(s.isEmpty(t)?(s.each(this._deferredRenders,function(t,e){s.each(t,function(t){clearTimeout(t)},this)},this),this._deferredRenders={}):(s.each(this._deferredRenders[t],function(t){clearTimeout(t)},this),this._deferredRenders[t].length=0))},_afterEachBatchRenderCollectionSubviews:function(t){this.trigger("batch:rendered:"+t)},_afterBatchRenderCollectionSubviews:function(t){this.trigger("rendered:"+t)},_attachCollectionListeners:function(t){var e=this._getSubviewCollection(t);e&&(this.listenTo(e,"add",s.partial(this.addNewCollectionSubview,t)),this.listenTo(e,"remove",s.partial(this.removeCollectionSubview,t)),this.listenTo(e,"reset",s.partial(this.renderCollectionSubviews,t)),this.listenTo(e,"update",s.partial(this.sortCollectionSubviews,t)))},_getSubviewCollection:function(t){var e=s.get(this.subviews[t],"collection");return e===!0?this.collection:s.isFunction(e)?e(this):e?e:null},_createDefaultPrepareViewForAddFunction:function(t){var e=this.subviews[t];return s.bind(function(i,n){var o=i.children(),a=new e.constructor(n),r=n.insertionIndex;return a.$el.attr("data-subview",t),s.isNumber(r)&&r<o.length?a.$el.insertBefore(o.get(r)):i.append(a.$el),a},this)}},before:{renderSubviews:function(){s.each(this.subviews,function(t,e){t.collection&&this._attachCollectionListeners(e)},this)},beforeRemove:function(){this._cancelBatchRenders()}},around:{renderCollectionSubviews:function(t,e){var i=this.subviews[e];if(i)return this.removeCollectionSubviews(e),s.result(i,"enableBatchRendering")===!0?this.batchRenderCollectionSubviews(e):t.apply(this,s.rest(arguments))}}});e.exports=o},{lodash:"MicNly","prima/lib/mixin":538}],545:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/lib/mixin"),o=new n({delegateObject:function(t){var e={},i={};t&&(s.each(t,function(t,s){"undefined"!=typeof t&&("function"==typeof t?e[s]=t:i[s]=t)},this),n.onto(this,e),s.extend(this,i))}});e.exports=o},{lodash:"MicNly","prima/lib/mixin":538}],546:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/lib/mixin"),o=new n({loggingData:function(t){var e={};return!s.isEmpty(this.model)&&s.isFunction(this.model.toJSON)&&(e.modelData=this.model.toJSON()),s.isObject(t)&&(e=s.extend(e,t)),e}});e.exports=o},{lodash:"MicNly","prima/lib/mixin":538}],547:[function(t,e,i){"use strict";var s=t("prima/lib/mixin"),n=t("prima/events"),o=t("lodash"),a=t("./registry"),r=new s({__bindKeycommands:function(){o.result(this,"keycommands")&&(o.each(o.result(this,"keycommands"),this.__bindKey,this),a.add({id:this.__keyId,keys:o.keys(o.result(this,"keycommands"))}))},__bindKey:function(t,e){this.listenTo(n,"DOMEventor:"+e,this.__keyFn)},__keyFn:function(t,e){!this.__keysDisabled&&a.shouldRun(e,this.__keyId)&&this[this.keycommands[e]].apply(this,arguments)},focusKeys:function(){a.focus(this.__keyId)},unfocusKeys:function(){a.unfocus(this.__keyId)},soloKeys:function(t){a.solo(this.__keyId,t)},unSoloKeys:function(){a.unSolo(this.__keyId)},disableKeys:function(){this.__keysDisabled=!0},enableKeys:function(){this.__keysDisabled=!1},before:{initialize:function(){this.keycommands||(this.keycommands={}),this.__keysDisabled=!1,this.__keyId=o.uniqueId("keycomms"),this.__bindKeycommands()},stopListening:function(){a.remove(this.__keyId)}}});e.exports=r},{"./registry":548,lodash:"MicNly","prima/events":512,"prima/lib/mixin":538}],548:[function(t,e,i){"use strict";var s=t("prima/class"),n=t("lodash"),o=s.extend({soloId:null,constructor:function(){this.keySets=[],this.soloBubblingWhitelist=[]},add:function(t){this.keySets.unshift(t)},remove:function(t){var e=this.getSetForId(t);e&&(this.unSolo(t),this.keySets=n.without(this.keySets,e),this.soloBubblingWhitelist=n.without(this.soloBubblingWhitelist,t))},focus:function(t){var e=this.getSetForId(t);e&&(this.keySets=n.without(this.keySets,e),this.keySets.unshift(e))},unfocus:function(t){var e=this.getSetForId(t);e&&(this.keySets=n.without(this.keySets,e),this.keySets.push(e))},solo:function(t,e){var i=this.getSetForId(t);i&&(this.soloId=t,e===!0&&this.soloBubblingWhitelist.push(t))},unSolo:function(t){this.soloId===t&&(this.soloId=null,this.soloBubblingWhitelist=n.without(this.soloBubblingWhitelist,t))},getSetForId:function(t){return this.keySets[n.findIndex(this.keySets,{id:t})]},getSetsWithKey:function(t){return n.where(this.keySets,{keys:[t]})},shouldRun:function(t,e){var i=this.getSetsWithKey(t);return this.soloId===e?!0:n.isEmpty(this.soloBubblingWhitelist)||n.contains(this.soloBubblingWhitelist,e)?i.length>1?i[0].id===e:!0:!1}});e.exports=new o},{lodash:"MicNly","prima/class":509}],549:[function(t,e,i){"use strict";var s=t("lodash"),n=t("when"),o=t("prima/lib/mixin"),a=new o({extend:{setNextLink:function(t){var e,i=this.hasNextPage();this._nextLink=t,e=this.hasNextPage(),i!==e&&this.trigger("change:hasNextPage",this,e)},setPreviousLink:function(t){var e,i=this.hasPreviousPage();this._previousLink=t,e=this.hasPreviousPage(),i!==e&&this.trigger("change:hasPreviousPage",this,e)},getNextLink:function(){return this._nextLink},getPreviousLink:function(){return this._previousLink},hasNextPage:function(){return!s.isEmpty(this.getNextLink())},hasPreviousPage:function(){return!s.isEmpty(this.getPreviousLink())},fetchNextPage:function(t,e){return t=t||{},this.hasNextPage()?(t.isInfiniteScroll!==!1&&s.extend(t,{skipParsePreviousLink:!0,remove:!1}),this._fetchPage(this.getNextLink(),t)):n.reject()},fetchPreviousPage:function(t,e){return t=t||{},this.hasPreviousPage()?(t.isInfiniteScroll!==!1&&s.extend(t,{skipParseNextLink:!0,remove:!1}),this._fetchPage(this.getPreviousLink(),t)):n.reject()},_fetchPage:function(t,e){var i=s.isString(t)?t:t.href;return e=e||{},s.extend(e,{url:i}),this.fetch(e)}},defaults:{parsePreviousLink:function(t,e){return null},parseNextLink:function(t,e){return null}},before:{reset:function(t){this.setPreviousLink(null),this.setNextLink(null)},parse:function(t,e){e=e||{},e.skipParseLinks||(!e.skipParsePreviousLink&&s.isFunction(this.parsePreviousLink)&&this.setPreviousLink(this.parsePreviousLink(t,e)),!e.skipParseNextLink&&s.isFunction(this.parseNextLink)&&this.setNextLink(this.parseNextLink(t,e)))}}});e.exports=a},{lodash:"MicNly","prima/lib/mixin":538,when:"RG2dij"}],550:[function(t,e,i){"use strict";var s=t("jquery"),n=t("lodash"),o=(t("sprintf-js").sprintf,t("../lib/mixin")),a=t("prima/events"),r=t("prima/mixins/subviewable"),l=!1,h=s("body"),c=s(window),u=t("prima/lib/clickoutside"),d=function(t){return n.noop},p=new o(r,{removeAutoTeardown:function(){this._popoverBase.clickOutside&&(this._popoverBase.clickOutside.remove(),this._popoverBase.clickOutside=null)},setupAutoTeardown:function(){this._rendered&&(this.removeAutoTeardown(),this._popoverBase.autoTeardown&&(this._popoverBase.clickOutside=new u(this.el,this.options),this._popoverBase.clickOutside.on("click:outside",this.onClickOutside,this)))},onClickOutside:function(){this._popoverBase.shouldTeardown?(this._popoverBase.lastAutoTeardown=n.now(),this.teardown()):this._popoverBase.shouldTeardown=!0},reposition:function(){if(!this.$pinned.closest("body").length)return void this.$el.css("visibility","hidden");var t=this.pinnedRect(),e={scrollTop:this.isContainerBody?0:this.$container.scrollTop(),scrollLeft:this.isContainerBody?0:this.$container.scrollLeft(),realTop:this.isContainerBody?0:this.$container.offset().top,realLeft:this.isContainerBody?0:this.$container.offset().left},i=this._popoverBase.shift,s=this._popoverBase.pinnedSide,o={visibility:"visible"},a={},r=this.$el.width(),l=null,h=null,c=null,u=null;this.debug("reposition: pinnedSide=%s, shift=%O, pinnedRect=%O",s,i,t),this._popoverBase.isFixedPosition&&(o.position="fixed"),"top"===s||"bottom"===s?(n.extend(o,{left:t.left+Math.floor(t.width/2)+i.x}),a={top:t.top+e.scrollTop-i.y,bottom:t.top+e.scrollTop+t.height+i.y,left:t.left+e.scrollLeft-i.x,right:t.left+e.scrollLeft+t.width+i.x},a.center=(a.right-a.left)/2,l=e.realTop+a.top-this.$el.height(),h=e.realTop+a.bottom+this.$el.height(),"top"===s&&this._crossesViewportEdge("top",l)&&!this._crossesViewportEdge("bottom",h)&&(s="bottom"),"bottom"===s&&this._crossesViewportEdge("bottom",h)&&!this._crossesViewportEdge("top",l)&&(s="top"),"bottom"===s?n.extend(o,{top:a.bottom,transform:"translateX(-50%)"}):"top"===s&&n.extend(o,{top:a.top,transform:"translateX(-50%) translateY(-100%)"}),c=e.realLeft+(a.center+a.left)-r/2,u=e.realLeft+(a.center+a.left)+r/2,this._crossesViewportEdge("left",c)&&!this._crossesViewportEdge("right",u)&&n.extend(o,{left:this._popoverBase.minDistanceFromContainer+"px",transform:"top"===s?"translateX(0) translateY(-100%)":"translateX(0)"}),!this._crossesViewportEdge("left",c)&&this._crossesViewportEdge("right",u)&&n.extend(o,{left:"auto",right:this._popoverBase.minDistanceFromContainer+"px",transform:"top"===s?"translateX(0) translateY(-100%)":"translateX(0)"})):"left"===s||"right"===s?(n.extend(o,{top:t.top-i.y}),a={left:t.left+e.scrollLeft-i.x,right:t.left+e.scrollLeft+t.width+i.x},c=e.realLeft+a.left-this.$el.width(),u=e.realLeft+a.right+this.$el.width(),"left"===s&&this._crossesViewportEdge("left",c)&&!this._crossesViewportEdge("right",u)&&(s="right"),"right"===s&&this._crossesViewportEdge("right",u)&&!this._crossesViewportEdge("left",c)&&(s="left"),"left"===s?n.extend(o,{left:a.left,transform:"translateX(-100%) translateY(-50%)"}):"right"===s&&n.extend(o,{left:a.right,transform:"translateY(-50%)"})):n.extend(o,{top:t.top-i.y,left:t.left+i.x,transform:""}),n.extend(o,{transform:o.transform}),this.$el.css(o),this.debug("reposition: ad-hoc css %O",o),this.$el.removeClass("top bottom left right").addClass(s)},_crossesViewportEdge:function(t,e){var i=s(window),n={top:i.scrollTop(),left:i.scrollLeft(),right:i.scrollLeft()+i.width(),bottom:i.scrollTop()+i.height()};return this.debug("viewportCheck against %s side (%s) coordinate=[%s]",t,n[t],e),"top"===t?n.top>e:"bottom"===t?n.bottom<e:"left"===t?n.left>e:"right"===t?n.right<e:void 0},isRendered:function(){return this._rendered},isOrWasRecentlyRendered:function(t){n.isNumber(t)||(t=100);var e=this._popoverBase.lastAutoTeardown,i=n.now()-e;
return t>i||this._rendered},setPinnedSide:function(t){return this._popoverBase.pinnedSide=t,this},setPinnedTarget:function(t){return this.$pinned=s(t).addClass("pinned-target"),this.debug("setPinnedTarget: %O",this.$pinned),this},setPopoverContainer:function(t){return this.$container=s(t),this.isContainerBody=this.$container.is(h),this.debug("setPopoverContainer: %O, isContainerBody=%s",this.$container,this.isContainerBody),this},setShift:function(t){if(!n.isObject(t)||!n.isNumber(t.x)||!n.isNumber(t.y))throw new Error("Popover shift needs to be: {Object} => x: {Number}, y: {Number}");return this._popoverBase.shift.x=t.x,this._popoverBase.shift.y=t.y,this},getShift:function(){return this._popoverBase.shift},_initializeDebugger:function(){this.debug=l?d(this):n.noop},defaults:{pinnedRect:function(){var t,e,i=this.$container.offset();t=this.$pinned.offset(),e=t,this._popoverBase.isFixedPosition&&(this.isContainerBody?t.top-=c.scrollTop():t.top-=this.$container.scrollTop());var s={};return s.height=this.$pinned.outerHeight(),s.width=this.$pinned.outerWidth(),s.top=Math.round(t.top-i.top),s.left=Math.round(e.left-i.left),s.bottom=Math.round(s.top+s.height),s.right=Math.round(s.left+s.width),this.debug("pinnedRect calculation: container %O, pinned %O, containerOffset %O, pinnedOffset %O",this.$container,this.$pinned,i,e),this.debug("pinnedRect results: height(pinnedOuterHeight)=%s, width(pinnedOuterWidth)=%s, top(pTop-cTop)=%s, left=(pLeft-cLeft)=%s, bottom(top+height)=%s, right(left+width)=%s",s.height,s.width,s.top,s.left,s.bottom,s.right),s}},after:{initialize:function(t){var e={identifier:"popover",pinnedSide:"bottom",className:"popover--base",autoTeardown:!0,teardownOnEscape:!0,minDistanceFromContainer:10,shift:{x:0,y:0},clickOutside:null,lastAutoTeardown:0,shouldTeardown:!0,isFixedPosition:!1};this._popoverBase=n.defaults(n.pick(t||{},n.keys(e)),e),this._initializeDebugger(),this.setPinnedTarget(t.pinnedTarget||null),this.setPopoverContainer(t.popoverContainer||h)},render:function(){this.$el.addClass(this._popoverBase.className),this.$el.appendTo(this.$container);var t=this.$el.children().first(),e=t.width();t.width(e-e%2),this._popoverBase.autoTeardown&&this.setupAutoTeardown(),this.reposition(),this.isContainerBody&&(this.debug("DOMEventor subscribe: flatresize + flatscroll reposition active"),this.listenTo(a,"DOMEventor:flatresize",this.reposition),this._popoverBase.isFixedPosition||this.listenTo(a,"DOMEventor:flatscroll",this.reposition)),this._popoverBase.teardownOnEscape&&this.listenTo(a,"DOMEventor:keyup:escape",this.teardown),this.trigger("open",this),a.trigger(this._popoverBase.identifier+":open",this)},teardown:function(){this.$pinned.removeClass("pinned-target"),this._popoverBase.teardownOnEscape&&this.stopListening(a,"DOMEventor:keyup:escape"),this.$el.off("mousewheel DOMMouseScroll"),this.removeAutoTeardown(),this.trigger("close",this),a.trigger(this._popoverBase.identifier+":close",this)}}});e.exports=p},{"../lib/mixin":538,jquery:"HlZQrA",lodash:"MicNly","prima/events":512,"prima/lib/clickoutside":513,"prima/mixins/subviewable":554,"sprintf-js":"qPOUxN"}],551:[function(t,e,i){"use strict";var s=t("lodash"),n=t("when"),o=t("../lib/mixin"),a=new o({defaults:{whenEvent:function(t,e){return 1===arguments.length&&(e=t,t=this),n.promise(s.bind(function(i,s){this.listenToOnce(t,e,function(){i.call(void 0,arguments)})},this))}}});e.exports=a},{"../lib/mixin":538,lodash:"MicNly",when:"RG2dij"}],552:[function(t,e,i){"use strict";var s=t("lodash"),n=t("backbone"),o=t("prima/lib/mixin"),a=new o({defaults:{relationKeys:function(){return s.keys(this.relations)},getRelations:function(){return s.pick(this.attributes,this.relationKeys())}},before:{initialize:function(t,e){this._bootstrapRelations(t,e)}},extend:{_isModelOrCollection:function(t){return t instanceof n.Collection||t instanceof n.Model},_bootstrapRelations:function(t,e){this._isBootstrapped||(s.each(this.relations,function(i,n){var o=this.attributes[n];(s.isEmpty(o)||!o instanceof i)&&(this.attributes[n]=new i(t[n],e))},this),this._isBootstrapped=!0)}},around:{set:function(t,e,i,o){var a,r,l,h,c,u,d=this.relations,p=this.attributes;return s.isObject(e)?(a=e,o=i):(a={})[e]=i,o=o||{},c=s.result(o,"relationalSetOptions")||{},this._bootstrapRelations(a,o),r=s.pick(a,s.keys(d)),s.isEmpty(d)||s.isEmpty(r)?t.apply(this,s.rest(arguments)):(u=s.isEmpty(this.relationsOrder)?s.keys(r):this.relationsOrder,s.each(u,function(t){a[t]&&(h=r[t],l=p[t],this._isModelOrCollection(l)&&(o.unset?l instanceof n.Collection?l.reset():l instanceof n.Model&&l.clear():(this._isModelOrCollection(h)&&(h=h.toJSON()),o.reset&&l instanceof n.Collection?l.reset(h,s.extend({},o,c[t])):l.set(h,s.extend({},o,c[t])))))},this),t.call(this,s.omit(a,s.keys(d)),o))},toJSON:function(t){var e=t.apply(this,s.rest(arguments))||{};for(var i in this.relations)e[i]=s.result(e[i],"toJSON")||e[i];return e}}});e.exports=a},{backbone:"5kFNoY",lodash:"MicNly","prima/lib/mixin":538}],553:[function(t,e,i){"use strict";function s(t){return n.trim(t)}var n=t("lodash"),o=t("../lib/mixin"),a=function(t,e){return t=s(t),e&&n.isFunction(this.$$)&&this.$$.cache["delete"](t),t},r=function(t){return this.$$?(t=s(t),this.$(t)):void 0},l=function(t){this.$$&&(t=s(t),this.$$.cache["delete"](t))},h=function(t){return this.$$?(t=s(t),this.$$.cache["delete"](t),this.$(t)):void 0},c=function(){this.$$&&(this.$$.cache=new n.memoize.Cache)},u=function(t){return"[data-js-"+t+"]"},d=function(t){return function(){var t=n.memoize(n.bind(r,this),n.bind(a,this));t.update=n.bind(h,this),t.remove=n.bind(l,this),t.empty=n.bind(c,this);var e=function(e,i){return t(u(e),i)};return e.update=function(e){t.update(u(e))},e.remove=function(e){t.remove(u(e))},this.$$=t,this.js$=e,this.$$initialize=n.noop,t}.call(t)},p=new o({defaults:{$$cacheKeys:{},$$cacheSelectors:function(t){return"undefined"==typeof t&&(t=this.$$cacheKeys),n.forEach(t,function(t){this.$$.update(t)},this),this},$$initialize:function(){return d(this)},$$:function(){return d(this).apply(this,arguments)}},before:{initialize:function(){this.$$initialize()},render:function(){this.$$.empty()}},after:{setElement:function(){n.isFunction(this.$$.empty)&&this.$$.empty()},remove:function(){n.isFunction(this.$$.empty)&&this.$$.empty()},render:function(){n.isFunction(this.$$cacheSelectors)&&this.$$cacheSelectors()}}});e.exports=p},{"../lib/mixin":538,lodash:"MicNly"}],554:[function(t,e,i){"use strict";var s=t("lodash"),n=t("../lib/mixin"),o=new n({defaults:{teardown:function(){return this},beforeTeardown:function(){},afterTeardown:function(){return this.teardownSubViews()},render:function(){return this},beforeRender:function(){},afterRender:function(){return this.renderSubViews()},attachSubView:function(t,e){if(1===arguments.length)if("string"==typeof t){if(e=t,t=this.subViews[e],!t)return this}else e=t.$el.data("subview")||"";var i=this.$('[data-subview="'+e+'"]');return i.length>1&&(i=i.first()),t&&i.length&&(i.replaceWith(t.$el),t.$el.attr("data-subview",e)),this},attachSubViews:function(t){return s.forEach(this.subViews,this.attachSubView,this),this},teardownSubViews:function(){return s.forEach(this.subViews,function(t,e){t&&s.isFunction(t.teardown)&&t.teardown(),this.subViews[e]=null},this),this.subViews={},this},renderSubViews:function(){return s.forEach(this.subViews,function(t){t&&s.isFunction(t.render)&&t.render()},this),this},isInitialized:function(){return this._initialized},isRendered:function(){return this._rendered},isRendering:function(){return this._rendering},isRemoved:function(){return this._removed}},around:{initialize:function(t){this._initialized=!1,this._rendering=!1,this._rendered=!1,this._removed=!1,this.subViews={};var e=t.apply(this,s.rest(arguments));return this._initialized=!0,e},teardown:function(t){var e=s.rest(arguments);s.isFunction(this.beforeTeardown)&&this.beforeTeardown.apply(this,e);var i=t.apply(this,e);return s.isFunction(this.afterTeardown)&&this.afterTeardown.apply(this,e),this._rendered=!1,i},render:function(t){var e=s.rest(arguments);this._rendering=!0,s.isFunction(this.beforeRender)&&this.beforeRender.apply(this,e);var i=t.apply(this,e);return s.isFunction(this.afterRender)&&this.afterRender.apply(this,e),this._rendering=!1,this._rendered=!0,this.trigger("rendered"),i}},after:{remove:function(){this._removed=!0,this.subViews=null}}});e.exports=o},{"../lib/mixin":538,lodash:"MicNly"}],555:[function(t,e,i){"use strict";var s=t("jquery"),n=t("lodash"),o=t("prima/lib/mixin"),a=t("prima/events"),r=new o({defaults:{$tabLimiterEl:s(),_tabLimiterAutoFocus:!1,_tabLimiterItems:[],_tabLimiterSelector:["input","select","textarea","button","object","a","div"],_tabLimiterCurrentIndex:-1,_tabLimiterEnterKey:!0},__tabLimiterTabKeydown:function(t){return t.preventDefault(),t.stopPropagation(),t.shiftKey&&-1===this._tabLimiterCurrentIndex&&(this._tabLimiterCurrentIndex=0),this._tabLimiterCurrentIndex=(this._tabLimiterCurrentIndex+(t.shiftKey?-1:1)+this._tabLimiterItems.length)%this._tabLimiterItems.length,this._focusTabbableItem(),!1},__tabLimiterItemKeydown:function(t){t=t||window.event;var e=t.which||t.keyCode;if(13===e){t.preventDefault(),t.stopPropagation();var i=s(t.target),n=i.find("input");return n.length?n.trigger("click"):i.trigger("click"),!1}},__tabbableItemFocus:function(t){var e=n.indexOf(this._tabLimiterItems,t.target);this._tabLimiterCurrentIndex=e>=0?e:this._tabLimiterCurrentIndex},_focusTabbableItem:function(){if(this.$tabLimiterEl&&this.$tabLimiterEl.length){var t=s(this._tabLimiterItems[this._tabLimiterCurrentIndex]);t.length&&t.focus()}},isTabbable:function(t){var e=s(t),i=t.nodeName.toLowerCase(),n=e.attr("tabindex"),o=!1;return o=/input|select|textarea|button|object/.test(i)?!t.disabled&&!e.is(":hidden"):(t.href||!isNaN(n))&&!e.is(":hidden"),(isNaN(n)||n>=0)&&o},updateTabbableItems:function(){this.$tabLimiterEl&&this.$tabLimiterEl.length&&(this._tabLimiterItems=n.filter(this.$tabLimiterEl.find(this._tabLimiterSelector.join(",")),n.bind(function(t){return this.isTabbable(t)},this)),this._tabLimiterItems.length&&(this._tabLimiterItems=n.sortBy(this._tabLimiterItems,function(t){return t.tabIndex})))},catchTabs:function(t){if(this.releaseTabs(),this.$tabLimiterEl=t?s(t):this.$tabLimiterEl,this.$tabLimiterEl&&this.$tabLimiterEl.length){this.updateTabbableItems(),this._tabLimiterAutoFocus&&this._focusTabbableItem();var e=this._tabLimiterSelector.join(",");this.listenTo(a,"DOMEventor:keydown:tab",this.__tabLimiterTabKeydown),this.listenTo(a,"DOMEventor:keydown:shift+tab",this.__tabLimiterTabKeydown),this.$tabLimiterEl.on("focus.tablimiter",e,n.bind(this.__tabbableItemFocus,this)),this._tabLimiterEnterKey&&this.$tabLimiterEl.on("keydown.tablimiter",e,n.bind(this.__tabLimiterItemKeydown,this))}},releaseTabs:function(){this.$tabLimiterEl&&this.$tabLimiterEl.length&&(this._tabLimiterItems=[],this._tabLimiterCurrentIndex=-1,this.stopListening(a,"DOMEventor:keydown:tab",this.__tabLimiterTabKeydown),this.stopListening(a,"DOMEventor:keydown:shift+tab",this.__tabLimiterTabKeydown),this.$tabLimiterEl.off(".tablimiter"))}});e.exports=r},{jquery:"HlZQrA",lodash:"MicNly","prima/events":512,"prima/lib/mixin":538}],556:[function(t,e,i){"use strict";var s=t("../lib/mixin"),n=new s({before:{sync:function(t,e,i){i.with_form_key=!0}}});e.exports=n},{"../lib/mixin":538}],557:[function(t,e,i){"use strict";var s=t("backbone"),n=t("./mixins/withformkeytrue"),o=t("./lib/extendwithmixins"),a=s.Model.extend({});n.applyTo(a.prototype),o.applyTo(a),e.exports=a},{"./lib/extendwithmixins":518,"./mixins/withformkeytrue":556,backbone:"5kFNoY"}],558:[function(t,e,i){"use strict";var s=t("backbone"),n=t("prima/bootloader"),o=(t("prima/lib/logger"),t("logs/logging-manager")),a=s.Router.extend({root:"/",logs:function(){return[]},constructor:function(){o.startLogs(this.logs()),s.Router.apply(this,arguments)},getName:function(){return"Prima/Router"}},{Bootloader:n,bootloader:function(t){return new this.Bootloader(t)}});e.exports=a},{backbone:"5kFNoY","logs/logging-manager":507,"prima/bootloader":508,"prima/lib/logger":519}],559:[function(t,e,i){"use strict";function s(t,e){function i(t,e){var i,s;if(!n.isObject(t))throw new Error("SingletonModel requires attributes");if(i=t[d],n.isEmpty(i)&&!n.isNumber(i)&&n.defer(function(){throw new Error('SingletonModel attributes require a "'+d+'"')}),s=c[i],u[i]++||(u[i]=1),s)n.keys(t).length>=2&&s.set(t,e),s.collection!==!0&&(s.collection=!0);else{c[i]=this;try{Object.defineProperty(this,"collection",{value:!0,configurable:!1,enumerable:!0,writable:!1})}finally{this.collection||(this.collection=!0)}this.constructor.__super__.constructor.call(this,t,e),h.add(this)}return s||this}function s(){return this.id}function r(){return h}function l(){0===--u[this.id]&&(delete c[this.id],delete u[this.id],h.remove(this))}t||(t={}),e||(e={});var h=new o.Collection,c=Object.create(null),u=Object.create(null),d=t.idAttribute||a.prototype.idAttribute;return t.constructor=i,t.release=l,t.toString=s,t.toJSON=t.toJSON||a.prototype.toJSON,e.getCollection=r,a.extend(t,e)}var n=t("lodash"),o=t("backbone"),a=t("./model");e.exports.extend=s},{"./model":557,backbone:"5kFNoY",lodash:"MicNly"}],560:[function(t,e,i){"use strict";function s(){var t,e,i={animation:null,transition:null},s=document.createElement("div"),n={animation:"animationend",MozAnimation:"animationend",WebkitAnimation:"webkitAnimationEnd"};for(e in n)if(void 0!==s.style[e]){i.animation=n[e];break}var o={transition:"transitionend",MozTransition:"transitionend",WebkitTransition:"webkitTransitionEnd"};for(t in o)if(void 0!==s.style[t]){i.transition=o[t];break}return i}function n(t,e){r.animation?a(t).one(r.animation,function(t){e(t)}):setTimeout(function(t){e(t)},0)}function o(t,e){r.transition?a(t).one(r.transition,function(t){e(t)}):setTimeout(function(t){e(t)},0)}var a=t("jquery"),r=s();e.exports={animation:n,transition:o}},{jquery:"HlZQrA"}],561:[function(t,e,i){"use strict";var s=t("lodash"),n=function(t,e){return null==e?e=5:s.isNumber(e)||(e=0),s.transform(t,function(t,i,o){e&&s.isObject(i)&&(i=n(i,e-1)),t[s.camelCase(o)]=i})};e.exports=n},{lodash:"MicNly"}],562:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/class"),o={requestFullscreen:["requestFullScreen"]},a=n.extend({vendors:["moz","webkit","ms","o","khtml"],el:document.body||document.documentElement,get:s.memoize(function(t){var e=this._getProp(t);return!e&&o[t]&&s.each(o[t],function(t){var i=this._getProp(t);i&&(e=i)},this),e}),prop:function(t){return!!this.get(t)},_getProp:function(t){var e=!1;return"string"==typeof this.el[t]?t:"string"==typeof this._styles()[t]?t:(t=t.charAt(0).toUpperCase()+t.substr(1),s.forEach(this.vendors,function(i){"undefined"!=typeof this.el[i+t]&&(e=i+t),"undefined"!=typeof this._styles()[i+t]&&(e=i+t)},this),e)},_styles:s.memoize(function(){return this.el.style})});e.exports=new a},{lodash:"MicNly","prima/class":509}],563:[function(t,e,i){"use strict";function s(t,e){if(t in n)return n[t];var i=window[t];if(!e||!e(i)){var s=document.createElement("iframe");document.body.appendChild(s),i=s.contentWindow[t],document.body.removeChild(s)}return n[t]=i,i}var n={};e.exports=s},{}],564:[function(t,e,i){"use strict";function s(t,e,i){return"#"+((1<<24)+(t<<16)+(e<<8)+i).toString(16).slice(1)}function n(t){t=String(t).replace(/[^0-9a-f]/gi,""),t.length<6&&(t=t[0]+t[0]+t[1]+t[1]+t[2]+t[2]);var e=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);return e?{r:parseInt(e[1],16),g:parseInt(e[2],16),b:parseInt(e[3],16)}:null}function o(t,e,i){var s=Math.min(Math.min(t,e),i),n=Math.max(Math.max(t,e),i),o=n-s,a={h:6,s:n?(n-s)/n:0,v:n/255};return o?n===t?a.h+=(e-i)/o:n===e?a.h+=2+(i-t)/o:a.h+=4+(t-e)/o:a.h=0,a.h=60*a.h%360,a}function a(t,e,i){var s,n,o;if(e){s=n=o=0;var a=(t+360)%360/60,r=i*e,l=i-r,h=r*(1-Math.abs(a%2-1));1>a?(s=r,n=h):2>a?(s=h,n=r):3>a?(n=r,o=h):4>a?(n=h,o=r):5>a?(o=r,s=h):(o=h,s=r),s+=l,n+=l,o+=l}else s=n=o=i;return{r:Math.round(255*s),g:Math.round(255*n),b:Math.round(255*o)}}function r(t){t=String(t).replace(/[^0-9a-f]/gi,""),t.length<6&&(t=t[0]+t[0]+t[1]+t[1]+t[2]+t[2]);var e=n(t),i=o(e.r,e.g,e.b);return i}function l(t,e,i){var n=a(t,e,i),o=s(n.r,n.g,n.b);return o}function h(t,e){t=String(t).replace(/[^0-9a-f]/gi,""),t.length<6&&(t=t[0]+t[0]+t[1]+t[1]+t[2]+t[2]),e=e||0;var i,s,n,o=parseInt(t,16),a=0>e?0:255,r=0>e?-e:e,l=o>>16,h=o>>8&255,c=255&o;return i=Math.round((a-l)*r)+l,s=Math.round((a-h)*r)+h,n=Math.round((a-c)*r)+c,"#"+(16777216+65536*i+256*s+n).toString(16).slice(1)}function c(t,e,i){return"string"==typeof t&&(t=r(t)),e||(e=.2),i||(i=.8),t.s<e&&t.v>i}function u(t){return"string"==typeof t&&(t=r(t)),c(t)?"#444":"#FFF"}function d(t,e,i){var s={upperBound:.8,lowerBound:.2,diffBound:.1,hueBound:15};p.extend(s,i);var n=s.upperBound,o=s.lowerBound,a=s.diffBound,r=s.hueBound,l=Math.abs(t.h-e.h),h=Math.abs(t.s-e.s),c=Math.abs(t.v-e.v);return a>=l&&a>=h&&a>=c?!0:a>=h&&a>=c&&(h>=n||o>=h&&c>=n||o>=c&&r>=l)?!0:!1}var p=t("lodash");e.exports={rgbToHex:s,hexToRgb:n,rgbToHsv:o,hsvToRgb:a,hexToHsv:r,hsvToHex:l,brighten:h,readable:u,compare:d,isLight:c}},{lodash:"MicNly"}],565:[function(t,e,i){"use strict";function s(t){return new RegExp(t+"=([^;]+)").test(decodeURIComponent(document.cookie))}function n(t){var e=decodeURIComponent(document.cookie).match(new RegExp(t+"=([^;]+)"));return e&&e.length>1?e[1]:null}function o(t,e,i,s){"object"==typeof e&&(e=JSON.stringify(e));var n=encodeURIComponent(t)+"="+encodeURIComponent(e);if(h.isPlainObject(i)&&(s=i,i=s?s.expires:!1),s=h.extend({expires:i},c,s),s.expires instanceof Date)n+=";expires="+s.expires.toGMTString();else if("number"==typeof s.expires){var o=new Date;o.setTime(o.getTime()+1e3*s.expires),n+=";expires="+o.toGMTString()}s.path&&(n+=";path="+encodeURI(s.path)),s.secure&&(n+=";secure"),s.domain&&(n+=";domain="+encodeURI(s.domain)),document.cookie=n}function a(t){o(t,"",-1)}function r(t,e){var i=n(t);try{i=JSON.parse(i)}catch(s){return i}return e?h.get(i,e):i}function l(t,e,i,s){var n;h.isPlainObject(e)?(s=i,n=e):(n=r(t)||{},h.isPlainObject(n)||(n={}),h.set(n,e,i)),o(t,JSON.stringify(n),s)}var h=t("lodash"),c={path:"/",secure:!1,domain:""},u={has:s,get:n,set:o,unset:a,getHash:r,setHash:l};e.exports=u},{lodash:"MicNly"}],566:[function(t,e,i){"use strict";function s(t,e,i){return function(){i||(i=this);var s=arguments;return setTimeout(function(){t.apply(i,s)},e)}}e.exports=s},{}],567:[function(t,e,i){"use strict";function s(t){var e=document.implementation.createHTMLDocument("");return e.body.innerHTML=t,e.body}function n(t){var e=document.implementation.createHTMLDocument("");return e.body.appendChild(t.cloneNode(!0)),e.body}function o(t){return n(t).innerHTML}function a(t){var e,i=document.implementation.createHTMLDocument("");return i.body.innerHTML=t,e=i.body.textContent||i.body.innerText||"",e=e.trim()}e.exports={nodeFromString:s,wrapNode:n,outerHTML:o,stripTags:a}},{}],568:[function(t,e,i){"use strict";function s(t){return t&&t.nodeType&&1===t.nodeType}var n=t("lodash");e.exports=function(t,e){if(s(t))return t;if(n.isString(t)){var i=(e||document).querySelector(t);if(s(i))return i}return t&&t.jquery?t.get(0):!1}},{lodash:"MicNly"}],569:[function(t,e,i){"use strict";function s(t,e){e=e||"Exposer";var i=window;n.each(t,function(t,s){if(n.has(i,s))throw new Error('"'+s+'" already exists');o.log(e,"%s.%s",i,s),n.set(i,s,t)})}var n=t("lodash"),o=t("../lib/logger");e.exports=s},{"../lib/logger":519,lodash:"MicNly"}],570:[function(t,e,i){"use strict";function s(t,e){var i=a.nodeFromString(t),s=o(i);return n.isFunction(e)&&(e=n.rest(arguments)),n.each(e,function(t){t(i,s)}),s.html()}var n=t("lodash"),o=t("jquery"),a=t("prima/utils/dom");e.exports=s},{jquery:"HlZQrA",lodash:"MicNly","prima/utils/dom":567}],571:[function(t,e,i){"use strict";var s=t("jquery"),n=function(t,e,i){if(0===i)return 0;var s=null==i?e:e/i;return 2===arguments.length?Math.round(t*s):void 0},o=function(t,e,i){if(0===i)return 0;var s=null==i?e:e/i;return Math.round(t/s)},a=function(t,e,i,s){var a=t,r=e,l=t/e,h=i/s;return(t>i||e>s)&&(l>h?(a=i,r=o(a,l)):(r=s,a=n(r,l))),{width:a,height:r}},r=function(t,e,i,s,a,r){null!=a||(a=.5),null!=r||(r=.5);var l=0,h=0,c=t,u=e,d=t/e,p=i/s;return d>p?(c=n(e,p),l=Math.round(a*(t-c))):p>d&&(u=o(t,p),l=Math.round(r*(e-u))),{left:l,top:h,width:c,height:u}},l=function(t){var e;t instanceof s?(e=t,t=e.get(0)):e=s(t);var i=document.createElement("canvas");return i.width=t.width||e.width(),i.height=t.height||e.height(),i},h=function(t,e,i){var n;t instanceof s?(n=t,t=n.get(0)):n=s(t),e?e instanceof s&&(e=e.get(0)):e=l(t);var o=e.width,a=e.height,r=e.getContext("2d");return r.save(),i&&(r.translate(e.width,0),r.scale(-1,1)),r.drawImage(t,0,0,o,a),r.restore(),e},c=function(t,e,i,n,a,r){var l;t instanceof s?(l=t,t=l.get(0)):l=s(t);var h=90===n||270===n;h?r&&i>r&&(e=o(r,i,e),i=r):r&&e>r&&(i=o(r,e,i),e=r);var c=document.createElement("canvas");h?(c.width=i,c.height=e):(c.width=e,c.height=i);var u=c.getContext("2d");return u.save(),u.translate(.5*c.width,.5*c.height),u.rotate(n*Math.PI/180),a&&u.scale(-1,1),u.drawImage(t,-.5*e,-.5*i,e,i),u.restore(),c},u={widthForHeight:n,heightForWidth:o,maxSize:a,cropBox:r,createCanvasForEl:l,drawElToCanvas:h,drawScaledAndRotated:c};e.exports=u},{jquery:"HlZQrA"}],572:[function(t,e,i){"use strict";var s=t("lodash"),n=t("when"),o=t("prima/class"),a="FileReader"in window&&"readAsDataURL"in FileReader.prototype,r=(window.URL||window.webkitURL||window.mozURL||window.msURL||{}).createObjectURL,l=[],h=t("app/vendor/jpegmeta").JpegFile,c=o.extend({constructor:function(t){null!=t&&this.read(t)},read:function(t,e){if(!s.isUndefined(e)||(e=!0),this.file=t,!t)return n.reject("No file to read");if(!a)return n.reject("FileReader is not supported");t.type.match(/image\/(jpg|jpeg)/i)||(e=!1);var i;return i=e&&"readAsBinaryString"in FileReader.prototype?this.readBinaryString(t).then(s.bind(function(e){try{var i=new h(e.binary,t.name);e.rotation=function(t){switch(t){case 1:return 0;case 2:return 0;case 3:return 180;case 4:return 180;case 5:return 270;case 6:return 90;case 7:return 90;case 8:return 270;default:return 0}}(i.tiff.Orientation.value),e.mirrored=function(t){switch(t){case 2:return!0;case 4:return!0;case 5:return!0;case 7:return!0;default:return!1}}(i.tiff.Orientation.value)}catch(n){}return this.readDataUrl(t).then(s.bind(function(t){return s.extend(e,t)},this))},this)):this.readDataUrl(t),this.promise=i,i},readDataUrl:function(t){var e=new FileReader;return"readAsDataURL"in e?n.promise(function(i,s){e.onload=function(t){var s=t.target.result;i(s),e.onload=null,e.onerror=null},e.onerror=function(){s(),e.onload=null,e.onerror=null},e.readAsDataURL(t)}).then(s.bind(this._onLoadDataUrl,this),s.bind(this._onError,this)):n.reject("FileReader.readAsDataURL is not supported")},_onLoadDataUrl:function(t){var e={base64:t,file:this.file};return r&&(e.objectUrl=r(this.file),l.push(e.objectUrl)),n.resolve(e)},readBinaryString:function(t){var e=new FileReader;return"readAsBinaryString"in e?n.promise(function(i,s){e.onload=function(t){var s=t.target.result;i(s),e.onload=null,e.onerror=null},e.onerror=function(){s(),e.onload=null,e.onerror=null},e.readAsBinaryString(t)}).then(s.bind(this._onLoadBinaryString,this),s.bind(this._onError,this)):n.reject("FileReader.readAsBinaryString is not supported")},_onLoadBinaryString:function(t){return n.resolve({binary:t,file:this.file})},_onError:function(t){return n.reject("Failed to read file")}},{read:function(t,e){var i=new c(t,e);return i.promise},canReadFiles:function(){return a}});e.exports=c},{"app/vendor/jpegmeta":441,lodash:"MicNly","prima/class":509,when:"RG2dij"}],573:[function(t,e,i){"use strict";var s=t("lodash"),n=t("when"),o=t("prima/class"),a=o.extend({constructor:function(t){null!=t&&this.load(t)},load:function(t,e){if(this.src=t,!t)return n.reject("No URL to load");var i=this,o=n.promise(function(n,o){var a=new Image;a.src=t,i._img=a;var r;if(a.onload=function(){n(a),a.onload=null,a.error=null,clearInterval(r)},a.onerror=function(){o(a),a.onload=null,a.error=null,clearInterval(r)},a.complete)a.naturalWidth||a.naturalHeight?"function"==typeof a.onload&&a.onload():"function"==typeof a.onerror&&a.onerror();else if(e){var l=function(){return a.naturalWidth||a.naturalHeight?("function"==typeof a.onload&&a.onload(),!0):!1};l()||(s.isNumber(e)||(e=100),r=setInterval(l,e))}});return this.promise=o=o.then(s.bind(this._onLoad,this),s.bind(this._onError,this)),o},_onLoad:function(t){return this._img===t?(this.width=t.naturalWidth,this.height=t.naturalHeight,this.src=t.src,this.loaded=!0,n.resolve({width:this.width,height:this.height,src:this.src})):this.promise},_onError:function(t){return this._img===t?(this.width=null,this.height=null,this.src=t.src,this.loaded=!1,n.reject(this.src+" failed to load")):this.promise}},{load:function(t,e){var i=new a(t,e);return i.promise}});e.exports=a},{lodash:"MicNly","prima/class":509,when:"RG2dij"}],574:[function(t,e,i){"use strict";function s(t){return/.+[.](jpg|jpeg|png|gif)([?]|$)/.test(t)===!0}function n(t){var e={jpeg:"jpg"},i=a.last((t||"").split("/")).toLowerCase();return a.has(e,i)?e[i]:i}function o(t){var e,i;return a.isString(t)&&(i=t.match(/^data:(image\/.*?);/i),i?e=i[1]:s(t)&&(e=r.getExtension(t))),e?n(e):void 0}var a=t("lodash"),r=t("prima/utils/url");e.exports={convertToNormalizedType:n,getImageType:o,isImageUrl:s}},{lodash:"MicNly","prima/utils/url":579}],575:[function(t,e,i){"use strict";var s,n=t("lodash"),o=t("../lib/data"),a=function(t,e){var i=t&&t.timing&&t.timing.responseStart||Date.now();return function(){return e+(Date.now()-i)}}(window.performance,o.get("Context/time")),r={getRealNow:n.get(window,"Tumblr.getRealNow"),realStartedAt:n.get(window,"Tumblr.real_started_at"),startedAt:n.get(window,"Tumblr.started_at")},l=function(){return s||(s=r.getRealNow?r:{getRealNow:a,realStartedAt:a(),startedAt:(new Date).getTime()}),s};e.exports=l(),e.exports.getElapsed=function(t){return t||(t=this.getRealNow()),t-this.realStartedAt}},{"../lib/data":514,lodash:"MicNly"}],576:[function(t,e,i){"use strict";var s=function(t,e){return e||(e=this),function(){var i=Array.prototype.slice.call(arguments);return i.unshift(this),t.apply(e,i)}};e.exports=s},{}],577:[function(t,e,i){"use strict";var s=t("lodash"),n=t("when/sequence"),o=function(t,e){t=s.map(t,function(t){return s.bind(t,this)},e||this);var i=Array.prototype.slice.call(arguments,1);return i[0]=t,n.apply(void 0,i)};e.exports=o},{lodash:"MicNly","when/sequence":630}],578:[function(t,e,i){"use strict";function s(t){return n.isFunction(t.serialize)?t.serialize():n.isFunction(t.toJSON)?t.toJSON():void 0}var n=t("lodash");e.exports=s},{lodash:"MicNly"}],579:[function(t,e,i){"use strict";var s=t("lodash"),n={aElement:document.createElement("a"),acceptedProtocols:["http:","https:","tumblr:","mailto:"],_setUrl:function(t){return this.aElement.setAttribute("href",t),this.aElement.setAttribute("href",this.aElement.href),this.aElement.href},parseUrl:function(t){if(!s.startsWith(t,"http"))throw new URIError("Missing protocol in URL to be parsed. Must be http or https");return this._setUrl(t),{url:t,href:this.aElement.href,protocol:this.aElement.protocol,host:this.aElement.hostname,port:this.aElement.port,query:this.aElement.search,hash:this.aElement.hash,path:this.aElement.pathname}},parseTumblelogUrl:function(t){try{-1===t.indexOf("://")&&(t="http://"+t);var e=this.parseUrl(t),i=!1;if(s.endsWith(e.host,"tumblr.com")?i=e.host.match(/([a-zA-Z0-9-_]+)\.tumblr\.com/i):s.endsWith(e.host,"tumblr.net")?i=e.host.match(/(?:^|\/\/)(?:([\w\-\_]+)\.)(?:[\w\-\_]+\.)*tumblr\.net/i):s.endsWith(e.host,"t.dev")&&(i=e.host.match(/([a-zA-Z0-9-_]+)\.t\.dev/i)),i){var n=i[1];if("www"===n)return!1;var o={tumblelog_name:n},a=e.path.match(/post\/([0-9]+)/i);return a&&(o.post_id=a[1]),o}return!1}catch(r){return!1}},isTumblelogUrl:function(t){return this.parseTumblelogUrl(t)===!1?!1:!0},parseTumblelogShortUrl:function(t){try{-1===t.indexOf("://")&&(t="http://"+t);var e=this.parseUrl(t);return"tmblr.co"!==e.host?!1:s.startsWith(e.path,"/m")?{mentionKey:e.path.match(/^\/m([^\/]+)/)[0]}:s.startsWith(e.path,"/Z")?{postTinyUrlHash:e.path.match(/^\/Z([^\/]+)/)[0]}:!1}catch(i){return!1}return!1},isTumblelogShortUrl:function(t){return this.parseTumblelogShortUrl(t)!==!1},isTumblrMediaUrl:function(t){return t?(-1===t.indexOf("://")&&(t="http://"+t),!!t.match(/^https?:\/\/(\d+\.)media\.tumblr\.com\//i)):!1},hasAllowedProtocol:function(t){this._setUrl(t);var e=this.aElement.protocol;if(":"===e&&(e=location.protocol),-1===this.acceptedProtocols.indexOf(e))throw new Error("Unsupported protocol detected in URL: "+t);return!0},isAbsoluteUrl:function(t){var e=new RegExp("^(?:[a-z]+:)?//","i");return!!e.test(t||"")},getParameter:function(t){var e=new RegExp("[?|&]"+t+"=([^&;]+?)(&|#|;|$)"),i=e.exec(location.search)||[null,""],s=i[1].replace(/\+/g,"%20"),n=decodeURIComponent(s);return n||null},httpBuildQuery:function(t,e){var i=[];for(var s in t)if(t.hasOwnProperty(s)){var n=e?e+"["+s+"]":s,o=t[s];if(!o)continue;i.push("object"==typeof o?this.httpBuildQuery(o,n):encodeURIComponent(n)+"="+encodeURIComponent(o))}return i.join("&")},buildUrl:function(t,e){var i=this.httpBuildQuery(e);return t+(s.isEmpty(i)?"":"?"+i)},getQueryStringHash:function(t){var e={};return t.replace(new RegExp("([^?=&]+)(=([^&]*))?","g"),function(t,i,s,n){e[i]=n}),e},isProtocolRelative:function(t){var e=new RegExp("^//[^/]","i");return e.test(t||"")},getExtension:function(t){var e,i;return this.isProtocolRelative(t)&&(t=this.addProtocolIfMissing(t,"http:")),s.startsWith(t,"http")&&(i=this.parseUrl(t),s.isEmpty(i.path)||(e=i.path)),e||(e=t),s.last(e.split("."))},addProtocolIfMissing:function(t,e){if(s.any(this.acceptedProtocols,function(e){return s.startsWith(t,e)}))return t;if(-1===this.acceptedProtocols.indexOf(e))throw new Error("Attempting to add an unsupported protocol: "+e);return(this.isProtocolRelative(t)?e:e+"//")+t}};e.exports=n},{lodash:"MicNly"}],580:[function(t,e,i){"use strict";function s(t,e){e||(e={}),t||(t=[]),n.each(t,function(t){n.isFunction(this[t])&&this[t].call(this,e)},this)}var n=t("lodash"),o=t("backbone"),a=t("./lib/extendwithmixins"),r=["model","collection","el","id","attributes","className","tagName","events"],l=["_setup"],h=o.View.extend({constructor:function(t){this.cid=n.uniqueId("view"),t||(t={}),n.extend(this,n.pick(t,r)),this._elAttributes=this.attributes,this.attributes={},this._ensureElement(),this.setupMethods=n.union(l,this.constructor.__super__.setupMethods,this.setupMethods),s.call(this,this.setupMethods,t),this.initialize.apply(this,arguments),this.delegateEvents()},_setup:n.noop,_ensureElement:function(){if(this.el)this.setElement(n.result(this,"el"),!1);else{var t=n.extend({},n.result(this,"_elAttributes"));this.id&&(t.id=n.result(this,"id")),this.className&&(t["class"]=n.result(this,"className"));var e=o.$("<"+n.result(this,"tagName")+">").attr(t);this.setElement(e,!1)}}});a.applyTo(h),e.exports=h},{"./lib/extendwithmixins":518,backbone:"5kFNoY",lodash:"MicNly"}],581:[function(t,e,i){"use strict";function s(t,e,i){return n.isFunction(t)&&(t=t(e,i)),t instanceof o?t:e.$(t)}var n=t("lodash"),o=t("jquery"),a=t("backbone"),r=t("when"),l=t("prima/utils/serialize"),h=t("prima/mixins/accessor/simple"),c=t("../view"),u=c.extend({rendered:!1,disposed:!1,keepElement:!1,_setup:function(t){t||(t={});var e=n.extend({},n.result(this.constructor.__super__,"defaults"),n.result(this,"defaults"));n.extend(e,n.pick(t,n.keys(e))),this.attributes={},this.set(e),this.changed={};var i=this.render;this.render=n.bind(function(){this._beforeRender.apply(this,arguments),this.beforeRender.apply(this,arguments);var t=i.apply(this,arguments);return this.afterRender.apply(this,arguments),this._afterRender.apply(this,arguments),t},this);var s=this.remove;this.remove=n.bind(function(){if(this.disposed)return this;this._beforeRemove.apply(this,arguments),this.beforeRemove.apply(this,arguments);var t=s.apply(this,arguments);return this.afterRemove.apply(this,arguments),
this._afterRemove.apply(this,arguments),t},this),this.subviews=n.extend({},this.subviews,t.subviews)},initialize:n.noop,_registerSubview:function(t){return this._subviews||(this._subviews=[]),this._subviews.push(t),t},appendSubview:function(t,e){return n.isString(e)&&(e=this.$(e)),this._registerSubview(t),t.render(),(e||this.$el).append(t.el),t},removeSubviews:function(){var t=n.flatten(this._subviews);t&&(n.invoke(t,"remove"),delete this._subviews)},renderSubviews:function(){this.subviews&&n.forEach(this.subviews,function(t,e){t instanceof a.View?this.renderSubview(t,{name:e}):t.collection?this.renderCollectionSubviews(e):this.renderSubview(e)},this)},_createDefaultContainerFunction:function(t){return n.bind(function(){return this.$('[data-subview="'+t+'[]"]')},this)},_createDefaultPrepareViewFunction:function(t){var e=this.subviews[t];return n.bind(function(i,s){var n=new e.constructor(s);return n.$el.attr("data-subview",t),i.append(n.$el),n},this)},renderCollectionSubviews:function(t){var e=this.subviews[t];if(e){var i=e.container||this._createDefaultContainerFunction(t),s=e.prepareView||this._createDefaultPrepareViewFunction(t),n=e.options||{},o=this.createCollectionSubviewRenderer(e.collection,i,s,n,t);this.rendered?o():this.once("rendered",o,this)}},renderSubview:function(t,e){var i,s,o,r;if(n.isString(t)){if(r=t,t=this.subviews[r],!t)return;i=t.container||'[data-subview="'+r+'"]',o=t.options||{},s=t.prepareView||function(e,i){if(!n.isEmpty(e)){var s=new t.constructor(i);return s.$el.attr("data-subview",r),e.replaceWith(s.$el),s}}}else t instanceof a.View&&(e||(e={}),r=e.name||"",i=e.container||'[data-subview="'+r+'"]',o=e.options||{},s=e.prepareView||function(e){return t.$el.attr("data-subview",r),e.replaceWith(t.$el),t});var l=this.createSubviewRenderer(i,s,o,r);this.rendered?l():this.once("rendered",l,this)},createSubviewRenderer:function(t,e,i,o){return n.bind(function(){if(this.el){i=i||{},n.isFunction(i)&&(i=i.call(i,this));var a=s(t,this,o),r=e.call(this,a,i);o&&n.set(this,o,r),r.render(),this._registerSubview(r)}},this)},createCollectionSubviewRenderer:function(t,e,i,o,r,l,h){var c;return n.bind(function(){if(this.el){var u=0;if(r&&(l?u=this[r].length:this[r]=[]),t===!0&&(t=this.collection),n.isFunction(t)&&(t=t(this)),t instanceof a.Collection&&(t=t.models),!n.isEmpty(t)){var d=s(e,this,r);n.isEmpty(d)||(l||(c=d,d=c.clone()),n.forEach(t,function(t,e){var s;s=n.isFunction(o)?o.call(o,this,t)||{}:n.extend({},o),s.model||(s.model=t);var a="";r&&(a=r+"["+(u+e)+"]"),h&&n.extend(s,h),this.createSubviewRenderer(d,i,s,a).call(this)},this),l||c.replaceWith(d))}}},this)},_beforeRender:n.noop,beforeRender:n.noop,render:function(){return this.disposed?!1:(this.renderWithTemplate(),this)},afterRender:n.noop,_afterRender:function(){this.renderSubviews(),this.rendered=!0,this.trigger("rendered",this),this._verifySubviewsRendered()},getTemplateData:function(){var t=l(this);return this.model&&(t.model=l(this.model)),this.collection&&(t.collection={items:l(this.collection),length:this.collection.length}),t},renderWithTemplate:function(t){if(n.isUndefined(this.template))throw new Error("Template function needed.");var e;return e=n.isFunction(this.template)?this.template(t||this.getTemplateData()):this.template,this.$el.html(e),this},afterRenderSubviews:n.noop,_verifySubviewsRendered:function(){var t=n.bind(function(){this.afterRenderSubviews(),this.trigger("renderedSubviews")},this),e=n.reject(this._subviews,function(t){return t.rendered===!0||t._rendered===!0});n.isEmpty(e)?t():r.map(e,function(t){return r.promise(n.partial(function(e,i){t.once("rendered",e)},t))}).then(t)},_beforeRemove:function(){this.removeSubviews()},beforeRemove:n.noop,remove:function(){return this.keepElement?(this.undelegateEvents(),this.stopListening()):c.prototype.remove.apply(this,arguments),this},afterRemove:n.noop,_afterRemove:function(){var t=["el","$el","options","model","collection","subviews","_subviews","defaults","attributes"];n.forEach(t,n.bind(function(t){this[t]&&delete this[t]},this)),this.rendered=!1,this.disposed=!0}});h.mixin.applyTo(u.prototype),e.exports=u},{"../view":580,backbone:"5kFNoY",jquery:"HlZQrA",lodash:"MicNly","prima/mixins/accessor/simple":543,"prima/utils/serialize":578,when:"RG2dij"}],582:[function(t,e,i){"use strict";var s=t("prima/component"),n=t("./views/header-view"),o=s.extend({name:"MobileNav",autoAppend:!0,view:function(){return this.data?new n(this.data):void 0}});e.exports=o},{"./views/header-view":597,"prima/component":511}],583:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __p="";Array.prototype.join;with(obj||{})__p+='<i class="icon_filter"></i>';return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],584:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __p="";Array.prototype.join;with(obj||{})__p+='<svg width="19px" height="22px" viewBox="0 0 26 22" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:sketch="http://www.bohemiancoding.com/sketch/ns"><g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd" sketch:type="MSPage"><path class="top-open" d="M13,10.0178223 L13,6.87965469 C13,6.06618011 12.84,2.7245838 14.527,1.44641061 C15.998,-0.143241692 17.454,0.00292164862 19.602,0.00392966862 C21.465,0.00292164862 23.022,0.163197309 24.209,1.44641061 C25.399,2.73063194 26,4.966427 26,6.87965469 L26,10.0178223 L23,10.0178223 L23,7.11103029 C23,6.27883295 22.983076,5.4231481 22.7865717,4.7089045 C22.6847765,4.3389045 22.5347899,4.00686105 22.314,3.73570197 C21.664,2.94225222 20.538,2.65089839 19.602,2.65089839 C19.4989445,2.65089839 19.3929679,2.65441527 19.2850939,2.66172851 C18.4111108,2.72097959 17.4125863,3.02942637 16.834,3.73570197 C16.189,4.53260651 16,5.84772931 16,7.11103029 L16,10.0178223 L13,10.0178223 Z" fill="#000000" sketch:type="MSShapeGroup"></path><path class="top-closed" d="M3,10.0178223 L3,6.87965469 C3,6.06618011 2.84,2.7245838 4.527,1.44641061 C5.998,-0.143241692 7.454,0.00292164862 9.602,0.00392966862 C11.465,0.00292164862 13.022,0.163197309 14.209,1.44641061 C15.399,2.73063194 16,4.966427 16,6.87965469 L16,10.0178223 L13,10.0178223 L13,7.11103029 C13,6.27883295 12.983076,5.4231481 12.7865717,4.7089045 C12.6847765,4.3389045 12.5347899,4.00686105 12.314,3.73570197 C11.664,2.94225222 10.538,2.65089839 9.602,2.65089839 C9.49894451,2.65089839 9.39296788,2.65441527 9.28509392,2.66172851 C8.41111079,2.72097959 7.41258628,3.02942637 6.834,3.73570197 C6.189,4.53260651 6,5.84772931 6,7.11103029 L6,10.0178223 L3,10.0178223 Z" fill="#000000" sketch:type="MSShapeGroup"></path><path d="M3,10.0178223 L1,10.0845369 C0.421,10.2438046 0,10.6084343 0,11.0882532 L0,20.991977 C0,21.4707879 0.527,22 1,22 L18,22 C18.476,22 19,20.9597202 19,20.9597202 L19,11.0882532 C19,10.0802302 18.475,10.0178223 18,10.0178223 L16,10.0178223 L3,10.0178223 Z" fill="#000000" sketch:type="MSShapeGroup"></path></g></svg>';return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],585:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __p="";Array.prototype.join;with(obj||{})__p+='<div class="nav-wrapper"><div data-subview="primaryNav"></div><div data-subview="secondaryNav"></div></div>';return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],586:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __t,__p="";Array.prototype.join;with(obj||{})__p+='<div class="splash-bg" data-img-src="'+(null==(__t=splash.image)?"":_.escape(__t))+'"></div><div class="splash-sections"><div class="splash-section top"><a href="/login" class="splash-login">'+(null==(__t=__("Log in"))?"":_.escape(__t))+'</a></div><div class="splash-section middle"><div class="middle-inner"><span class="splash-pitch">'+(null==(__t=__("Splash headline"))?"":_.escape(__t))+'</span> <a href="/register" class="signin flat-button blue">'+(null==(__t=__("Get started"))?"":_.escape(__t))+"</a>",has_app&&(__p+='<a href="'+(null==(__t=app_url)?"":_.escape(__t))+'" class="flat-button get-the-app">'+(null==(__t=__("Get the app"))?"":_.escape(__t))+"</a>"),__p+='</div></div><div class="splash-section bottom"><a href="'+(null==(__t=splash.url)?"":_.escape(__t))+'" target="_blank" rel="nofollow" class="splash-avatar" style="background-image:url('+(null==(__t=splash.avatar)?"":_.escape(__t))+')"></a> <a href="'+(null==(__t=splash.url)?"":_.escape(__t))+'" target="_blank" rel="nofollow" class="splash-name">'+(null==(__t=__("Posted by"))?"":_.escape(__t))+"&nbsp;<strong>"+(null==(__t=splash.name)?"":_.escape(__t))+"</strong></a></div></div>";return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],587:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __p="";Array.prototype.join;with(obj||{})__p+='<div class="mobile-logo-wrapper',show_page_title&&(__p+=" show-page-title "),__p+=" ",!_.isUndefined(show_search_field)&&show_search_field&&(__p+=" show-search-field "),__p+='"><div data-subview="logo"></div><div data-subview="pageTitle"></div><div data-subview="searchField"></div></div>';return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],588:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __p="";Array.prototype.join;with(obj||{})__p+='<a href="/" class="logo-link"><svg class="tumblr-svg-t" width="29px" height="39px" viewBox="0 0 29 39" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><g class="t-logo" id="Dashboard" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><path class="large-shadow" d="M21.9956664,26.3 L21.9956664,19.0055544 L27.9954227,19.0055542 L27.9954227,13.0048828 L27.9954227,11.0108643 L23.522766,11.0108643 L23.5540067,11.6669807 L23.7388305,15.5486452 L17.6832886,15.4792482 L17.4,24 C17.5,26.3 18.8,26.5 19.8,26.5 C20.2,26.5 21.4956664,26.4 21.9956664,26.3 Z M18.7154541,4.00225829 L17.4,2.9 L17.4,8 L22.000122,7.34490957 L22.000122,4.00225829 L18.7154541,4.00225829 Z M24.3,29.6 L24.9,31.5 C23.8,32.9 21,34 18.4,34 L18.1,34 C16.3,34 14.8,33.7 13.6,33.2 C15,35.4 17.5999998,38.0021971 21.7999998,38.0021971 C21.7999996,38.6099361 22.0022113,38.0021971 22.0999998,38.0021971 C24.6999998,38.0021971 27.4,36.1 28.6,34.7 L26.7,28.8 C26,29.2 25.1,29.5 24.3,29.6 Z" id="Shape" opacity="0.5" fill="#000000"></path><path class="inner" d="M18.5,33.6 L18.3,33.6 C11.1,33.6 9,28.2005493 9,25.0005493 L9,15 C8.58245849,15 4.99298096,15 5,15 L4.99298096,10.0285034 C4.99298096,9.92850342 5.1,9.9 5.2,9.9 C8.9,8.5 11.3,6.7 11.9,2.3 C11.8,2 12,2 12,2 L16.8,2 L17,2 L17,9.00006104 L23.012207,9.00006104 L23.012207,15 L17,15 L17,24.0839844 C17,26.1839844 17.8,27.3 19.8,27.3 C20.6,27.3 21.5,27.1 22.4,26.8 C22.5,26.8 22.6,26.8 22.6,26.9 L24.1,31.3 L24.1,31.7 C23,32.8 20.7,33.6 18.5,33.6 Z"></path><path class="outer" d="M26.1,32.2 L26.3,31.9 L23.9,25.1 C23.9,25 23.8,25 23.8,25 L19.2,25 C19.1,25 19,25.1 19,25 C18.9,24.8 19,24.4 19,24.1 L19,17 L25,17 L25,7 C25,7 19,7 19,7 L19,0 L8,0 C7.3,0 6.4,0.8 6.3,1.8 C5.8,5.9 4.1,7.5 0.5,8.7 L0.1,8.8 C0,8.9 0,8.9 0,9 L0,17.0000006 C0,17.1000006 0.1,17 0.1,17 L4,17 L4,24.8 C4,31.8 8.46560059,36.0067139 17.3656006,36.0067139 C22.0656006,36.0067139 25,33.7 26.1,32.2 Z M18.5,33.6 L18.3,33.6 C11.1,33.6 9,28.2005493 9,25.0005493 L9,15 C8.58245849,15 4.99298096,15 5,15 L4.99298096,10.0285034 C4.99298096,9.92850342 5.1,9.9 5.2,9.9 C8.9,8.5 11.3,6.7 11.9,2.3 C11.8,2 12,2 12,2 L16.8,2 L17,2 L17,9.00006104 L23.012207,9.00006104 L23.012207,15 L17,15 L17,24.0839844 C17,26.1839844 17.8,27.3 19.8,27.3 C20.6,27.3 21.5,27.1 22.4,26.8 C22.5,26.8 22.6,26.8 22.6,26.9 L24.1,31.3 L24.1,31.7 C23,32.8 20.7,33.6 18.5,33.6 Z"></path><path class="small-shadow" d="M4,19 L7,19 L7,17.0833333 C7,17 6.9,17 6.9,17 L4,17 L4,19 L4,19 Z" opacity="0.5" fill="#37465D"></path></g></svg></a>';return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],589:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __p="";Array.prototype.join;with(obj||{})__p+='<div class="menu-burger"><div class="burger bun top"></div><div class="burger patty"></div><div class="burger bun bottom"></div></div><div class="drawer" data-subview="drawer"></div><div class="sneeze-guard"></div>';return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],590:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __p="";Array.prototype.join;with(obj||{})__p+="",__p+=show_filter_icon?' <span class="toggle-filter"><div data-subview="filterIcon"></div><div data-subview="filters"></div></span>':' <span class="toggle-nsfw-filter"><div data-subview="lockIcon"></div></span>',__p+=' <span class="search-label" for="search-input"></span>';return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],591:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __t,__p="";Array.prototype.join;with(obj||{})__p+=""+(null==(__t=page_title)?"":_.escape(__t));return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],592:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __t,__p="";Array.prototype.join;with(obj||{})__p+='<nav class="nav-site-sections"><a href="/dashboard" class="nav-item with-icon"><span class="nav-text nav-item-dashboard">'+(null==(__t=__("Dashboard"))?"":_.escape(__t))+'</span></a> <a href="/likes" class="nav-item with-icon"><span class="nav-count">',parseInt(likes,10)>0&&(__p+=""+(null==(__t=likes)?"":_.escape(__t))),__p+='</span><span class="nav-text nav-item-likes">'+(null==(__t=__("Likes"))?"":_.escape(__t))+'</span></a> <a href="/following" class="nav-item with-icon"><span class="nav-count">'+(null==(__t=following)?"":_.escape(__t))+'</span><span class="nav-text nav-item-following">'+(null==(__t=__("Following"))?"":_.escape(__t))+'</span></a> <a href="/settings" class="nav-item with-icon" data-subnav="settings"><span class="nav-text nav-item-settings has-subnav">'+(null==(__t=__("Settings"))?"":_.escape(__t))+'</span></a> <a href="'+(null==(__t=url_prefix)?"":_.escape(__t))+'/new/text" class="nav-item with-icon"><span class="nav-text nav-item-create-post">'+(null==(__t=__("Create a post"))?"":_.escape(__t))+'</span></a></nav><nav class="nav-blog-list"><span class="nav-section-title">'+(null==(__t=__("Blogs"))?"":_.escape(__t))+"</span>",_.each(blogs,function(t){__p+=' <a href="'+(null==(__t=t.url)?"":_.escape(__t))+'" class="nav-item"><img src="'+(null==(__t=t.avatar)?"":_.escape(__t))+'" class="blog-avatar"><div class="blog-name-wrapper"><span class="blog-name">'+(null==(__t=t.name)?"":_.escape(__t))+'</span> <span class="blog-title">'+(null==(__t=t.safe_title)?"":__t)+"</span></div></a>"}),__p+="</nav>";return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],593:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __t,__p="";Array.prototype.join;with(obj||{})__p+='<form action="/search" method="get"><input type="text" placeholder="'+(null==(__t=__("Search Tumblr"))?"":_.escape(__t))+'" autocomplete="off" class="search-input" id="search-input" name="q" value="',search_term&&(__p+=""+(null==(__t=search_term)?"":_.escape(__t))),__p+='"> <input type="hidden" class="search-nsfw-filter-input" name="filter_nsfw"> <input type="hidden" class="filter-sort-input" name="sort" value="top"> <input type="hidden" class="filter-post-type-input" name="filter_post_type" value="any">'+(null==(__t=_subview("loader"))?"":__t)+"</form>";return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],594:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __t,__p="";Array.prototype.join;with(obj||{})__p+='<nav class="nav-site-sections"><a href="/settings/password" class="nav-item"><span class="nav-text">'+(null==(__t=__("Change Password"))?"":_.escape(__t))+'</span></a> <a href="/settings/tfa" class="nav-item"><span class="nav-text">'+(null==(__t=__("Two Factor Authentication"))?"":_.escape(__t))+'</span></a> <a href="/help" class="nav-item"><span class="nav-text">'+(null==(__t=__("Help"))?"":_.escape(__t))+'</span></a> <a href="/settings/account" class="nav-item" target="_blank"><span class="nav-text desktop-view">'+(null==(__t=__("Account"))?"":_.escape(__t))+'</span></a> <a href="/settings/notifications" class="nav-item" target="_blank"><span class="nav-text desktop-view">'+(null==(__t=__("Notifications"))?"":_.escape(__t))+'</span></a> <a href="/settings/apps" class="nav-item" target="_blank"><span class="nav-text desktop-view">'+(null==(__t=__("Apps"))?"":_.escape(__t))+"</span></a></nav>";return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],595:[function(require,module,exports){var _=require("lodash");module.exports=Function(_.keys(_.templateSettings.imports),"return "+function(obj){var __p="";Array.prototype.join;with(obj||{})__p+='<div data-subview="navMenu"></div><div data-subview="logoTitle"></div><div data-subview="search"></div>';return __p}.toString()).apply(void 0,_.values(_.templateSettings.imports))},{lodash:"MicNly"}],596:[function(t,e,i){"use strict";var s=t("prima/views/base"),n=t("../templates/_filter-icon.tpl"),o=s.extend({template:n,className:"filter-icon",render:function(){return this.$el.html(this.template()),this}});e.exports=o},{"../templates/_filter-icon.tpl":583,"prima/views/base":581}],597:[function(t,e,i){"use strict";var s=t("jquery"),n=t("lodash"),o=t("prima/view"),a=t("prima/events"),r=t("prima/lib/domeventor"),l=t("prima/lib/flags"),h=t("prima/mixins/subviewable"),c=t("prima/mixins/accessor"),u=t("../templates/header.tpl"),d=t("./logo-title-view"),p=t("./nav-menu-view"),m=t("./nav-search"),g=o.extend({className:"mobile-header",mixins:[h,c],template:u,defaults:{logged_in:!1},initialize:function(t){t=n.extend({},t),n.extend(this.attributes,n.pick(t,n.keys(this.defaults))),this.subViews.logoTitle=new d(t),this.subViews.navMenu=new p(t),l.bool("mobile_web_sticky_header")&&this.setSticky(),l.bool("mobile_web_search")&&(this.subViews.search=new m(t))},render:function(){return this.$el.html(this.template()),this.attachSubViews(),this},setSticky:function(){s("body").addClass("sticky-header"),this.lastPosition=r.rect().windowScrollTop,this.listenTo(a,"DOMEventor:flatscroll",this.getScrollDirection)},getScrollDirection:function(t){t.windowScrollTop>45?n.delay(n.bind(function(){this.$el.addClass("sticky")},this),500):this.$el.removeClass("sticky"),this.lastPosition<t.windowScrollTop&&t.windowScrollTop>45?this.$el.addClass("hide-nav"):this.$el.removeClass("hide-nav"),this.lastPosition=t.windowScrollTop}});e.exports=g},{"../templates/header.tpl":595,"./logo-title-view":601,"./nav-menu-view":603,"./nav-search":604,jquery:"HlZQrA",lodash:"MicNly","prima/events":512,"prima/lib/domeventor":516,"prima/lib/flags":"f/LVtH","prima/mixins/accessor":542,"prima/mixins/subviewable":554,"prima/view":580}],598:[function(t,e,i){"use strict";var s=t("prima/view"),n=t("../templates/_lock-icon.tpl"),o=s.extend({template:n,className:"lock-icon",render:function(){return this.$el.html(this.template()),this}});e.exports=o},{"../templates/_lock-icon.tpl":584,"prima/view":580}],599:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/view"),o=t("prima/mixins/accessor"),a=t("prima/mixins/subviewable"),r=t("../templates/_logged-in-nav.tpl"),l=t("./primary-nav"),h=t("./secondary-nav"),c=n.extend({template:r,mixins:[a,o],className:"drawer logged-in",initialize:function(t){t=s.extend({},t),s.extend(this.attributes,t),this.subViews.primaryNav=new l(t),this.subViews.secondaryNav=new h(t)},render:function(){return this.$el.html(this.template(this.toJSON())),this.attachSubViews(),this}});e.exports=c},{"../templates/_logged-in-nav.tpl":585,"./primary-nav":606,"./secondary-nav":608,lodash:"MicNly","prima/mixins/accessor":542,"prima/mixins/subviewable":554,"prima/view":580}],600:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/view"),o=t("prima/mixins/accessor"),a=t("prima/events"),r=t("../templates/_logged-out-nav.tpl"),l=n.extend({template:r,mixins:[o],className:"drawer logged-out",initialize:function(t){t=s.extend({},t),s.extend(this.attributes,t),this.listenToOnce(a,"drawer:open",this.downloadBackground)},downloadBackground:function(){var t=new Image,e=this.$splashBg.data("img-src");t.onload=s.bind(function(){this.$splashBg.css("background-image","url("+e+")"),this.$splashBg.addClass("loaded")},this),t.src=e},render:function(){return this.$el.html(this.template(this.toJSON())),this.$splashBg=this.$(".splash-bg"),this}});e.exports=l},{"../templates/_logged-out-nav.tpl":586,lodash:"MicNly","prima/events":512,"prima/mixins/accessor":542,"prima/view":580}],601:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/view"),o=t("prima/lib/flags"),a=t("prima/mixins/subviewable"),r=t("prima/mixins/accessor"),l=t("../templates/_logo-title.tpl"),h=t("./logo-view"),c=t("./page-title-view"),u=t("./search-field-view"),d=n.extend({className:"nav-logo-title",mixins:[a,r],template:l,initialize:function(t){t=s.extend({},t),s.extend(this.attributes,t),this.subViews.logo=new h,o.bool("mobile_web_page_titles")&&this.get("page_title")&&this.get("logged_in")&&!this.get("search_term")?(this.subViews.pageTitle=new c(t),this.set("show_page_title",!0)):this.set("show_page_title",!1),o.bool("mobile_web_search")?(this.set("show_search_field",!!this.get("search_term")),this.subViews.searchField=new u(t)):this.set("show_search_field",!1)},render:function(){return this.$el.html(this.template(this.toJSON())),this.attachSubViews(),this}});e.exports=d},{"../templates/_logo-title.tpl":587,"./logo-view":602,"./page-title-view":605,"./search-field-view":607,lodash:"MicNly","prima/lib/flags":"f/LVtH","prima/mixins/accessor":542,"prima/mixins/subviewable":554,"prima/view":580}],602:[function(t,e,i){"use strict";var s=t("prima/view"),n=t("../templates/_logo.tpl"),o=s.extend({template:n,className:"mobile-logo",render:function(){return this.$el.html(this.template()),this}});e.exports=o},{"../templates/_logo.tpl":588,"prima/view":580}],603:[function(t,e,i){"use strict";var s=t("lodash"),n=t("jquery"),o=t("prima/view"),a=t("prima/mixins/subviewable"),r=t("prima/mixins/accessor"),l=t("prima/events"),h=t("../templates/_nav-menu.tpl"),c=t("./logged-in-view"),u=t("./logged-out-view"),d=o.extend({className:"nav-menu",template:h,mixins:[a,r],events:{"click .menu-burger":"__clickMenuBurger","click [data-subnav]":"__clickSubnav","click .sneeze-guard":"__clickSneezeGuard"},__clickSneezeGuard:function(t){t.preventDefault(),this.closeDrawer()},__clickSubnav:function(t){t.preventDefault(),this.openSubNav(n(t.currentTarget).data("subnav"))},__clickMenuBurger:function(t){t.preventDefault(),this.toggleDrawer()},initialize:function(t){t=s.extend({},t),s.extend(this.attributes,t),this.get("drawer_open")&&this.openDrawer(),this.get("logged_in")?this.subViews.drawer=new c(t):this.subViews.drawer=new u(t),this.listenTo(l,"mobileHeader:search:click",this.closeDrawer)},render:function(){return this.$el.html(this.template()),this.$body=n("body"),this.$html=n("html"),this.attachSubViews(),this},toggleDrawer:function(){this.$el.hasClass("subnav-active")?this.closeSubNav():this.get("drawer_open")?this.closeDrawer():this.openDrawer()},openDrawer:function(){this.set("drawer_open",!0),this.$body.addClass("nav-drawer-open"),this.$html.addClass("nav-drawer-open"),this.$el.addClass("active"),l.trigger("drawer:open")},closeDrawer:function(){this.set("drawer_open",!1),this.$body.removeClass("nav-drawer-open"),this.$html.removeClass("nav-drawer-open"),this.$el.removeClass("active subnav-active"),l.trigger("drawer:closed")},openSubNav:function(t){this.$el.addClass("subnav-active"),l.trigger("drawer:subnav:open",t)},closeSubNav:function(){this.$el.removeClass("subnav-active"),l.trigger("drawer:subnav:close")}});e.exports=d},{"../templates/_nav-menu.tpl":589,"./logged-in-view":599,"./logged-out-view":600,jquery:"HlZQrA",lodash:"MicNly","prima/events":512,"prima/mixins/accessor":542,"prima/mixins/subviewable":554,"prima/view":580}],604:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/events"),o=t("prima/view"),a=t("prima/mixins/subviewable"),r=t("prima/mixins/accessor"),l=t("prima/lib/flags"),h=t("../templates/_nav-search.tpl"),c=t("./lock-icon-view"),u=t("./filter-icon-view"),d=t("app/context/indash-blog/components/blog-search/views/popovers/blog-search-filter-popover"),p=t("app/context/indash-blog/components/blog-search/models/blog-search-model"),m=o.extend({className:"nav-search",mixins:[a,r],template:h,defaults:{show_filter_icon:!1},events:{"click .toggle-nsfw-filter":"__lockIconClick","click .search-label":"__searchLabelClick"},__lockIconClick:function(){this.set("filter_nsfw",!this.get("filter_nsfw")),this.lockIconUpdate(),n.trigger("mobileHeader:nsfw:update",this.get("filter_nsfw"))},__searchLabelClick:function(){n.trigger("mobileHeader:search:click")},lockIconUpdate:function(){this.get("filter_nsfw")?this.lockIconUpdateEnable():this.lockIconUpdateDisable()},lockIconUpdateDisable:function(){this.set("filter_nsfw",!1),this.$el.removeClass("nsfw-filter-on"),this.$el.addClass("nsfw-filter-off")},lockIconUpdateEnable:function(){this.set("filter_nsfw",!0),this.$el.removeClass("nsfw-filter-off"),this.$el.addClass("nsfw-filter-on")},togglePopover:function(){this.popover||(this.popover=new d({pinnedTarget:this.subViews.filterIcon.$el,model:this.model}),this.popover.render(),this.listenTo(this.popover,"close",this.onPopoverClose))},onPopoverClose:function(){s.defer(s.bind(function(){this.popover=null},this))},__filterIconClick:function(){this.togglePopover()},onFilterChange:function(t){n.trigger("mobileHeader:filter:update",t),this.popover.hide()},bindEvents:function(){this.model&&(this.listenTo(this.model,"change:sort",this.onFilterChange),this.listenTo(this.model,"change:post_type",this.onFilterChange),this.listenTo(this.model,"change:filter_nsfw",this.onFilterChange)),this.events["click .toggle-filter"]="__filterIconClick"},initialize:function(t){this.subViews.lockIcon=new c,t=s.extend({},t),s.extend(this.attributes,t),l.bool("mobile_web_search_filter")&&this.get("logged_in")&&(this.subViews.filterIcon=new u,this.set("show_filter_icon",!0),this.model=new p({showOriginalPostsSwitch:!1,showNsfwSwitch:!0,sort:this.get("filter_sort").toUpperCase(),post_type:this.get("filter_post_type").toUpperCase(),filter_nsfw:this.get("filter_nsfw")}),this.bindEvents())},render:function(){return this.lockIconUpdate(),this.$el.html(this.template(this.toJSON())),this.attachSubViews(),this},teardown:function(){this.popover&&this.popover.teardown()}});e.exports=m},{"../templates/_nav-search.tpl":590,"./filter-icon-view":596,"./lock-icon-view":598,"app/context/indash-blog/components/blog-search/models/blog-search-model":410,"app/context/indash-blog/components/blog-search/views/popovers/blog-search-filter-popover":426,lodash:"MicNly","prima/events":512,"prima/lib/flags":"f/LVtH","prima/mixins/accessor":542,"prima/mixins/subviewable":554,"prima/view":580}],605:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/view"),o=t("prima/mixins/accessor"),a=t("../templates/_page-title.tpl"),r=n.extend({template:a,className:"page-title",mixins:[o],initialize:function(t){t=s.extend({},t),s.extend(this.attributes,t)},render:function(){return this.$el.html(this.template(this.toJSON())),this}});e.exports=r},{"../templates/_page-title.tpl":591,lodash:"MicNly","prima/mixins/accessor":542,"prima/view":580}],606:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/view"),o=t("prima/mixins/accessor"),a=t("../templates/_primary-nav.tpl"),r=n.extend({template:a,mixins:[o],className:"primary-nav",initialize:function(t){t=s.extend({},t),s.extend(this.attributes,t)},render:function(){return this.$el.html(this.template(this.toJSON())),this}});e.exports=r},{"../templates/_primary-nav.tpl":592,lodash:"MicNly","prima/mixins/accessor":542,"prima/view":580}],607:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/view"),o=t("prima/events"),a=t("prima/mixins/accessor"),r=t("../templates/_search-field.tpl"),l=t("components/loader"),h=n.extend({template:r,className:"search-field",mixins:[a],events:{"submit form":"__submitForm"},__submitForm:function(){this.toggleLoader(!0)},__handleSearchClick:function(){var t=this.$searchInput.val();this.$el.hasClass("search-term-exists")?t===this.get("search_term")?this.setFocus():this.$submitForm.trigger("submit"):!t&&this.$mobileLogoWrapper.hasClass("show-search-field")?this.hideSearchField():t&&this.$mobileLogoWrapper.hasClass("show-search-field")?this.$submitForm.trigger("submit"):this.showSearchField()},__handleNsfwFilterClick:function(t){this.$searchNsfwFilterInput.val(t),this.$submitForm.prop("action","/search/"+this.get("search_term")),this.$searchInput.prop("name",""),this.$submitForm.trigger("submit")},__handleFilterChange:function(t){var e="top";"CREATED_DESC"===t.get("sort")&&(e="recent");var i=t.get("post_type").toLowerCase();this.$searchFilterSortInput.val(e),this.$searchFilterPostTypeInput.val(i),this.$searchNsfwFilterInput.val(t.get("filter_nsfw")),this.$submitForm.prop("action","/search/"+this.get("search_term")),this.$searchInput.prop("name",""),this.$submitForm.trigger("submit")},initialize:function(t){t=s.extend({},t),s.extend(this.attributes,t),this.listenTo(o,"mobileHeader:search:click",this.__handleSearchClick),this.listenTo(o,"mobileHeader:nsfw:update",this.__handleNsfwFilterClick),this.listenTo(o,"mobileHeader:filter:update",this.__handleFilterChange),this.listenTo(o,"drawer:open",this.hideSearchField)},render:function(){return this.get("search_term")&&this.$el.addClass("search-term-exists"),this.$el.html(this.template(this.toJSON())),this.$searchInput=this.$(".search-input"),this.$searchNsfwFilterInput=this.$(".search-nsfw-filter-input"),this.$searchFilterSortInput=this.$(".filter-sort-input"),this.$searchFilterPostTypeInput=this.$(".filter-post-type-input"),this.$submitForm=this.$("form"),this.$mobileLogoWrapper=this.$el.parent(),this},toggleLoader:function(t){t?this.loader?this.loader.set("loading",!0):this.loader=new l({$container:this.$el,type:"bar",classModifiers:"top",loading:!0}):this.loader.set("loading",!1)},showSearchField:function(){this.$mobileLogoWrapper.addClass("show-search-field"),s.delay(s.bind(this.setFocus,this),250)},hideSearchField:function(){this.$searchInput.blur(),this.$mobileLogoWrapper.removeClass("show-search-field")},setFocus:function(){var t=2*this.$searchInput.val().length;this.$searchInput.focus(),this.$searchInput.get(0).setSelectionRange(t,t)}});e.exports=h},{"../templates/_search-field.tpl":593,"components/loader":464,lodash:"MicNly","prima/events":512,"prima/mixins/accessor":542,"prima/view":580}],608:[function(t,e,i){"use strict";var s=t("lodash"),n=t("prima/view"),o=t("prima/mixins/accessor"),a=t("prima/events"),r=n.extend({mixins:[o],className:"secondary-nav",templates:{settings:t("../templates/_settings-nav.tpl")
},_getTemplate:function(t){return"settings"===t?this.templates.settings(this.toJSON()):void 0},initialize:function(t){t=s.extend({},t),s.extend(this.attributes,t),this.listenTo(a,"drawer:subnav:open",this.render)},render:function(t){return t?(this.$el.html(this._getTemplate(t)),this):this}});e.exports=r},{"../templates/_settings-nav.tpl":594,lodash:"MicNly","prima/events":512,"prima/mixins/accessor":542,"prima/view":580}],609:[function(t,e,i){!function(t){"use strict";function i(){this.frames=[],this.lastId=0,this.raf=s,this.batch={hash:{},read:[],write:[],mode:null}}var s=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.msRequestAnimationFrame||function(t){return window.setTimeout(t,1e3/60)};window.cancelAnimationFrame||window.cancelRequestAnimationFrame||window.mozCancelAnimationFrame||window.mozCancelRequestAnimationFrame||window.webkitCancelAnimationFrame||window.webkitCancelRequestAnimationFrame||window.msCancelAnimationFrame||window.msCancelRequestAnimationFrame||function(t){window.clearTimeout(t)};i.prototype.read=function(t,e){var i=this.add("read",t,e),s=i.id;this.batch.read.push(i.id);var n="reading"===this.batch.mode||this.batch.scheduled;return n?s:(this.scheduleBatch(),s)},i.prototype.write=function(t,e){var i=this.add("write",t,e),s=this.batch.mode,n=i.id;this.batch.write.push(i.id);var o="writing"===s||"reading"===s||this.batch.scheduled;return o?n:(this.scheduleBatch(),n)},i.prototype.defer=function(t,e,i){"function"==typeof t&&(i=e,e=t,t=1);var s=this,n=t-1;return this.schedule(n,function(){s.run({fn:e,ctx:i})})},i.prototype.clear=function(t){if("function"==typeof t)return this.clearFrame(t);var e=this.batch.hash[t];if(e){var i=this.batch[e.type],s=i.indexOf(t);delete this.batch.hash[t],~s&&i.splice(s,1)}},i.prototype.clearFrame=function(t){var e=this.frames.indexOf(t);~e&&this.frames.splice(e,1)},i.prototype.scheduleBatch=function(){var t=this;this.schedule(0,function(){t.batch.scheduled=!1,t.runBatch()}),this.batch.scheduled=!0},i.prototype.uniqueId=function(){return++this.lastId},i.prototype.flush=function(t){for(var e;e=t.shift();)this.run(this.batch.hash[e])},i.prototype.runBatch=function(){try{this.batch.mode="reading",this.flush(this.batch.read),this.batch.mode="writing",this.flush(this.batch.write),this.batch.mode=null}catch(t){throw this.runBatch(),t}},i.prototype.add=function(t,e,i){var s=this.uniqueId();return this.batch.hash[s]={id:s,fn:e,ctx:i,type:t}},i.prototype.run=function(t){var e=t.ctx||this,i=t.fn;if(delete this.batch.hash[t.id],!this.onError)return i.call(e);try{i.call(e)}catch(s){this.onError(s)}},i.prototype.loop=function(){var t=this,e=this.raf;this.looping||(e(function i(){var s=t.frames.shift();t.frames.length?e(i):t.looping=!1,s&&s()}),this.looping=!0)},i.prototype.schedule=function(t,e){return this.frames[t]?this.schedule(t+1,e):(this.loop(),this.frames[t]=e)},t=t||new i,"undefined"!=typeof e&&e.exports?e.exports=t:"function"==typeof define&&define.amd?define(function(){return t}):window.fastdom=t}(window.fastdom)},{}],610:[function(t,e,i){(function(t){function e(t,i){if({}.hasOwnProperty.call(e.cache,t))return e.cache[t];var s=e.resolve(t);if(!s)throw new Error("Failed to resolve module "+t);var n={id:t,require:e,filename:t,exports:{},loaded:!1,parent:i,children:[]};i&&i.children.push(n);var o=t.slice(0,t.lastIndexOf("/")+1);return e.cache[t]=n.exports,s.call(n.exports,n,n.exports,o,t),n.loaded=!0,e.cache[t]=n.exports}e.modules={},e.cache={},e.resolve=function(t){return{}.hasOwnProperty.call(e.modules,t)?e.modules[t]:void 0},e.define=function(t,i){e.modules[t]=i};var i=function(e){return e="/",{title:"browser",version:"v0.10.26",browser:!0,env:{},argv:[],nextTick:t.setImmediate||function(t){setTimeout(t,0)},cwd:function(){return e},chdir:function(t){e=t}}}();e.define("/gif.coffee",function(t,i,s,n){function o(t,e){return{}.hasOwnProperty.call(t,e)}function a(t,e){for(var i=0,s=e.length;s>i;++i)if(i in e&&e[i]===t)return!0;return!1}function r(t,e){function i(){this.constructor=t}for(var s in e)o(e,s)&&(t[s]=e[s]);return i.prototype=e.prototype,t.prototype=new i,t.__super__=e.prototype,t}var l,h,c,u,d;c=e("events",t).EventEmitter,l=e("/browser.coffee",t),d=function(t){function e(t){var e,i;this.running=!1,this.options={},this.frames=[],this.freeWorkers=[],this.activeWorkers=[],this.setOptions(t);for(e in h)i=h[e],null!=this.options[e]?this.options[e]:this.options[e]=i}return r(e,t),h={workerScript:"gif.worker.js",workers:2,repeat:0,background:"#fff",quality:10,width:null,height:null,transparent:null},u={delay:500,copy:!1},e.prototype.setOption=function(t,e){return this.options[t]=e,null==this._canvas||"width"!==t&&"height"!==t?void 0:this._canvas[t]=e},e.prototype.setOptions=function(t){var e,i;return function(s){for(e in t)o(t,e)&&(i=t[e],s.push(this.setOption(e,i)));return s}.call(this,[])},e.prototype.addFrame=function(t,e){var i,s;null==e&&(e={}),i={},i.transparent=this.options.transparent;for(s in u)i[s]=e[s]||u[s];if(null!=this.options.width||this.setOption("width",t.width),null!=this.options.height||this.setOption("height",t.height),"undefined"!=typeof ImageData&&null!=ImageData&&t instanceof ImageData)i.data=t.data;else if("undefined"!=typeof CanvasRenderingContext2D&&null!=CanvasRenderingContext2D&&t instanceof CanvasRenderingContext2D||"undefined"!=typeof WebGLRenderingContext&&null!=WebGLRenderingContext&&t instanceof WebGLRenderingContext)e.copy?i.data=this.getContextData(t):i.context=t;else{if(null==t.childNodes)throw new Error("Invalid image");e.copy?i.data=this.getImageData(t):i.image=t}return this.frames.push(i)},e.prototype.render=function(){var t,e;if(this.running)throw new Error("Already running");if(null==this.options.width||null==this.options.height)throw new Error("Width and height must be set prior to rendering");this.running=!0,this.nextFrame=0,this.finishedFrames=0,this.imageParts=function(e){for(var i=function(){var t;t=[];for(var e=0;0<=this.frames.length?e<this.frames.length:e>this.frames.length;0<=this.frames.length?++e:--e)t.push(e);return t}.apply(this,arguments),s=0,n=i.length;n>s;++s)t=i[s],e.push(null);return e}.call(this,[]),e=this.spawnWorkers();for(var i=function(){var t;t=[];for(var i=0;e>=0?e>i:i>e;e>=0?++i:--i)t.push(i);return t}.apply(this,arguments),s=0,n=i.length;n>s;++s)t=i[s],this.renderNextFrame();return this.emit("start"),this.emit("progress",0)},e.prototype.abort=function(){for(var t;;){if(t=this.activeWorkers.shift(),!(null!=t))break;console.log("killing active worker"),t.terminate()}return this.running=!1,this.emit("abort")},e.prototype.spawnWorkers=function(){var t;return t=Math.min(this.options.workers,this.frames.length),function(){var e;e=[];for(var i=this.freeWorkers.length;this.freeWorkers.length<=t?t>i:i>t;this.freeWorkers.length<=t?++i:--i)e.push(i);return e}.apply(this,arguments).forEach(function(t){return function(e){var i;return console.log("spawning worker "+e),i=new Worker(t.options.workerScript),i.onmessage=function(t){return function(e){return t.activeWorkers.splice(t.activeWorkers.indexOf(i),1),t.freeWorkers.push(i),t.frameFinished(e.data)}}(t),t.freeWorkers.push(i)}}(this)),t},e.prototype.frameFinished=function(t){return console.log("frame "+t.index+" finished - "+this.activeWorkers.length+" active"),this.finishedFrames++,this.emit("progress",this.finishedFrames/this.frames.length),this.imageParts[t.index]=t,a(null,this.imageParts)?this.renderNextFrame():this.finishRendering()},e.prototype.finishRendering=function(){var t,e,i,s,n,o,a;n=0;for(var r=0,l=this.imageParts.length;l>r;++r)e=this.imageParts[r],n+=(e.data.length-1)*e.pageSize+e.cursor;n+=e.pageSize-e.cursor,console.log("rendering finished - filesize "+Math.round(n/1e3)+"kb"),t=new Uint8Array(n),o=0;for(var h=0,c=this.imageParts.length;c>h;++h){e=this.imageParts[h];for(var u=0,d=e.data.length;d>u;++u)a=e.data[u],i=u,t.set(a,o),o+=i===e.data.length-1?e.cursor:e.pageSize}return s=new Blob([t],{type:"image/gif"}),this.emit("finished",s,t)},e.prototype.renderNextFrame=function(){var t,e,i;if(0===this.freeWorkers.length)throw new Error("No free workers");return this.nextFrame>=this.frames.length?void 0:(t=this.frames[this.nextFrame++],i=this.freeWorkers.shift(),e=this.getTask(t),console.log("starting frame "+(e.index+1)+" of "+this.frames.length),this.activeWorkers.push(i),i.postMessage(e))},e.prototype.getContextData=function(t){return t.getImageData(0,0,this.options.width,this.options.height).data},e.prototype.getImageData=function(t){var e;return null!=this._canvas||(this._canvas=document.createElement("canvas"),this._canvas.width=this.options.width,this._canvas.height=this.options.height),e=this._canvas.getContext("2d"),e.setFill=this.options.background,e.fillRect(0,0,this.options.width,this.options.height),e.drawImage(t,0,0),this.getContextData(e)},e.prototype.getTask=function(t){var e,i;if(e=this.frames.indexOf(t),i={index:e,last:e===this.frames.length-1,delay:t.delay,transparent:t.transparent,width:this.options.width,height:this.options.height,quality:this.options.quality,repeat:this.options.repeat,canTransfer:"chrome"===l.name},null!=t.data)i.data=t.data;else if(null!=t.context)i.data=this.getContextData(t.context);else{if(null==t.image)throw new Error("Invalid frame");i.data=this.getImageData(t.image)}return i},e}(c),t.exports=d}),e.define("/browser.coffee",function(t,e,i,s){var n,o,a,r,l;r=navigator.userAgent.toLowerCase(),a=navigator.platform.toLowerCase(),l=r.match(/(opera|ie|firefox|chrome|version)[\s\/:]([\w\d\.]+)?.*?(safari|version[\s\/:]([\w\d\.]+)|$)/)||[null,"unknown",0],o="ie"===l[1]&&document.documentMode,n={name:"version"===l[1]?l[3]:l[1],version:o||parseFloat("opera"===l[1]&&l[4]?l[4]:l[2]),platform:{name:r.match(/ip(?:ad|od|hone)/)?"ios":(r.match(/(?:webos|android)/)||a.match(/mac|win|linux/)||["other"])[0]}},n[n.name]=!0,n[n.name+parseInt(n.version,10)]=!0,n.platform[n.platform.name]=!0,t.exports=n}),e.define("events",function(t,e,s,n){i.EventEmitter||(i.EventEmitter=function(){});var o=e.EventEmitter=i.EventEmitter,a="function"==typeof Array.isArray?Array.isArray:function(t){return"[object Array]"===Object.prototype.toString.call(t)},r=10;o.prototype.setMaxListeners=function(t){this._events||(this._events={}),this._events.maxListeners=t},o.prototype.emit=function(t){if("error"===t&&(!this._events||!this._events.error||a(this._events.error)&&!this._events.error.length))throw arguments[1]instanceof Error?arguments[1]:new Error("Uncaught, unspecified 'error' event.");if(!this._events)return!1;var e=this._events[t];if(!e)return!1;if("function"!=typeof e){if(a(e)){for(var i=Array.prototype.slice.call(arguments,1),s=e.slice(),n=0,o=s.length;o>n;n++)s[n].apply(this,i);return!0}return!1}switch(arguments.length){case 1:e.call(this);break;case 2:e.call(this,arguments[1]);break;case 3:e.call(this,arguments[1],arguments[2]);break;default:var i=Array.prototype.slice.call(arguments,1);e.apply(this,i)}return!0},o.prototype.addListener=function(t,e){if("function"!=typeof e)throw new Error("addListener only takes instances of Function");if(this._events||(this._events={}),this.emit("newListener",t,e),this._events[t])if(a(this._events[t])){if(!this._events[t].warned){var i;i=void 0!==this._events.maxListeners?this._events.maxListeners:r,i&&i>0&&this._events[t].length>i&&(this._events[t].warned=!0,console.error("(node) warning: possible EventEmitter memory leak detected. %d listeners added. Use emitter.setMaxListeners() to increase limit.",this._events[t].length),console.trace())}this._events[t].push(e)}else this._events[t]=[this._events[t],e];else this._events[t]=e;return this},o.prototype.on=o.prototype.addListener,o.prototype.once=function(t,e){var i=this;return i.on(t,function s(){i.removeListener(t,s),e.apply(this,arguments)}),this},o.prototype.removeListener=function(t,e){if("function"!=typeof e)throw new Error("removeListener only takes instances of Function");if(!this._events||!this._events[t])return this;var i=this._events[t];if(a(i)){var s=i.indexOf(e);if(0>s)return this;i.splice(s,1),0==i.length&&delete this._events[t]}else this._events[t]===e&&delete this._events[t];return this},o.prototype.removeAllListeners=function(t){return t&&this._events&&this._events[t]&&(this._events[t]=null),this},o.prototype.listeners=function(t){return this._events||(this._events={}),this._events[t]||(this._events[t]=[]),a(this._events[t])||(this._events[t]=[this._events[t]]),this._events[t]}}),t.GIF=e("/gif.coffee")}).call(this,this)},{}],611:[function(t,e,i){var s=t("./debugConsole"),n=function(){function t(t,e){"number"==typeof t&&"number"==typeof e&&this.element.css({left:t+"px",top:e+"px"})}function e(){var t=this.element.get(0).getBoundingClientRect().left;0>t&&this.element.css("left","+="+-1*t+"px");var e=this.element.get(0).getBoundingClientRect().top;0>e&&this.element.css("top","+="+-1*e+"px")}var i=function(t){return this.element?(t=t||{},this.onShow=t.onShow||function(t){t.element.show()},this.onHide=t.onHide||function(t){t.element.hide()},this.isShown=!1,void this.element.hide()):(s.error("ControlBase requires an element"),null)};return i.prototype.hide=function(){this.isShown&&(this.isShown=!1,this.onHide(this))},i.prototype.showOverTarget=function(t,i){var s=t-this.element.width()/2,n=i-this.element.height()-10;this.show(s,n),e.call(this)},i.prototype.show=function(e,i){t.call(this,e,i),this.isShown||(this.isShown=!0,this.onShow(this))},i.prototype.size=function(t,e){t&&"number"==typeof t&&this.element.width(t),e&&"number"==typeof e&&this.element.width(e)},i}();e.exports=n},{"./debugConsole":613}],612:[function(t,e,i){var s=t("lodash"),n=t("jquery"),o=t("./sanitize"),a=function(){function t(t){t.normalize();for(var e=document.createTreeWalker(t,NodeFilter.SHOW_TEXT,null,!1);e.nextNode();){var i=e.currentNode,s=n(i).parent().is(t);s&&""!==i.nodeValue.trim()&&n(i).wrap("<p>")}}function e(e){t(e),n(e).children().each(function(){var t=n(this).get(0),e=t.nodeName===f,i=t.nodeName===_;v(t)||b(t)||e||i||n(this).wrap("<p>")})}function i(t){return s.filter(n(t).find("*").toArray(),function(t){return v(t)||w(t)})}function a(t,o){t.normalize(),o||e(t);var a=i(t);(a.length||!o)&&(o&&(e(t),a=i(t)),n(t).empty(),s.each(a,function(e){var i=s.some(n(e).children().toArray(),function(t){return v(t)});(w(e)||!u(e)&&!i)&&n(t).append(e)}))}function r(t){if(!w(t)){var e=n(t).children(m.join()).toArray(),i=!1;s.each(e,function(t){i||(n(t).unwrap(),i=!0),r(t)})}}function l(t,e){var o=i(t);s.each(o,function(t){n(t).find("li").contents().unwrap(),e&&(n(t).find("br:last-child").remove(),n(t).append("<br>")),n(t).contents().unwrap()})}function h(t){var i=x(t);i.shift();for(var s=i.shift();s&&!n(s).is("[contentEditable]");){var o=s.parentNode;n(s).contents().unwrap(),e(o),s=i.shift()}}function c(t){if(t&&t.length){for(var e=t.shift(),i=!1,o=["style","dir"];e;){var a=n(e).find("span").toArray();"SPAN"===e.nodeName&&a.push(e),a.length&&(i=!0),n(a).contents().unwrap(),s.each(o,function(t){n(e).removeAttr(t),n(e).find("["+t+"]").removeAttr(t)}),e=t.shift()}return i}}function u(t,e){var i=n(t).text();e&&(i=i.replace(/\n|\r/gm,"").trim());var s=t&&t.nodeName===_;return""===i&&!b(t)&&!y(t)&&!s}function d(t){var e=document.implementation.createHTMLDocument("");return e.body.innerHTML=t,e.body}function p(t){var e=document.implementation.createHTMLDocument("");return e.body.appendChild(t.cloneNode(!0)),e.body}var m=["P","FIGURE","H2","BLOCKQUOTE","UL","OL","PRE"],g=["FIGURE","IFRAME","IMG","HR"],f="DIV",_="HR",v=function(t){return s.contains(m,t.nodeName)},b=function(t){return t&&s.contains(g,t.nodeName)},y=function(t){return n(t).find(g.join()).length},w=function(t){return"false"===n(t).attr("contenteditable")},x=function(t){return s.filter(t,function(t){return s.contains(m,t.nodeName)})},C=function(t){this.sanitizeConfig=t};return C.prototype.flattenBlocksDown=function(t,e){a(t,e)},C.prototype.unBlock=function(t){r(t)},C.prototype.unwrapParentBlocks=function(t){h(t)},C.prototype.scrubSpansAndBadAttrs=function(t,e){return c(t,e)},C.prototype.blockifyInlineNodes=function(t){e(t)},C.prototype.inlinify=function(t,e){l(t,e)},C.prototype.getBlockNodes=function(t){return i(t)},C.prototype.isEmptyElement=function(t,e){return u(t,e)},C.prototype.filterHTML=function(t){var e=d(t),i=new o(this.sanitizeConfig),s=i.clean_node(e),n=p(s),a=n.innerHTML,r=a.replace(/[<]p[>][ ]*[<]\/p[>]/g,"");return r},C.prototype.filterPlaintext=function(t,e){var i=s.escape(t);return i=i.replace(/\r\n/g,"\n"),i=i.replace(/\r/g,"\n"),e&&(i=i.replace(/\n([ ]*\n)+/g,"</p><p>")),i=i.replace(/\n/g,"<br>"),e&&(i="<p>"+i+"</p>"),i},C.prototype.convertToBrowserSpaces=function(t){return t.replace(/[ ]{2}/g,"  ").replace(/[ ]$/," ")},C.prototype.sanitizeIFrames=function(t){var e=d(t);return n(e).find("iframe").each(function(){n(this).attr("data-original-src",n(this).attr("src")),n(this).attr("src","javascript:''")}),e.innerHTML},C.prototype.unSanitizeIFrames=function(t){var e=d(t);return n(e).find("iframe[data-original-src]").each(function(){n(this).attr("src",n(this).attr("data-original-src")),n(this).removeAttr("data-original-src")}),e.innerHTML},C}();e.exports=a},{"./sanitize":623,jquery:"HlZQrA",lodash:"MicNly"}],613:[function(t,e,i){var s=t("lodash"),n=t("./ligature"),o=["assert","clear","constructor","count","debug","dir","dirxml","error","group","groupCollapsed","groupEnd","info","log","markTimeline","profile","profileEnd","table","time","timeEnd","timeStamp","timeline","timelineEnd","trace","warn"],a=function(t){return function(){return n.debugMode?window.console[t].bind(window.console).apply(this,arguments):s.noop}},r={};s.each(o,function(t){r[t]=a(t)}),e.exports=r},{"./ligature":618,lodash:"MicNly"}],614:[function(t,e,i){var s=t("lodash"),n=t("jquery"),o=t("velocity-animate"),a=o.animate,r=t("./controlBase"),l=function(){function t(){var t=this,e=s.reduce(this.controlsOrder,function(t,e){return s.has(this.controls,e)&&t.push(this.template(s.extend({name:e},this.controls[e]))),t},[],this);this.element=n("<div />",{"class":"bubbles"}).css({position:"absolute",top:0,left:0}).html(e),this.buttons=n(this.element).find("[data-command]"),this.hide(),this.buttons.on("mousedown",function(t){t.preventDefault()}),this.buttons.on("mouseup",function(e){e.preventDefault(),l.call(t,this)})}function e(){s.each(this.controls,function(t,e){s.has(t,"keyboard")&&this.keyboardEvents.on(t.keyboard,s.partial(o.bind(this),e)),s.has(t,"keyboardInverse")&&this.keyboardEvents.on(t.keyboardInverse,s.partial(i.bind(this),e))},this)}function i(t){s.has(this.controls,t)&&d[t]&&o.call(this,t)}function o(t){var e,i,n,o;s.has(this.controls,t)&&(e=d[t],i=this.controls[t],n=i.command,o=i.el,e&&this.inverseCommand&&"function"==typeof this.inverseCommand?this.inverseCommand(n,o,this):this.applyCommand&&"function"==typeof this.applyCommand&&this.applyCommand(n,o,this),this.onAction(this))}function l(t){o.call(this,n(t).attr("data-name"))}function h(){this.buttons.removeClass("active"),this.buttons.filter(function(){return d[n(this).attr("data-name")]}).addClass("active")}function c(t,e){var i=!1;return n.each(t,function(t,s){return s===e||"undefined"!=typeof s.nodeName&&s.nodeName===e?(i=!0,!1):void 0}),i}var u='<div class="<%= className %>" title="<%= title %>" data-name="<%= name %>" data-el="<%= el %>" data-command="<%= command %>" data-type="<%= type %>">&nbsp;</div>',d={},p=function(i,n,o){o=o||{},this.applyCommand=i,this.inverseCommand=n,this.template=s.template(o.template||u),this.controls=o.controls||{},this.controlsOrder=o.controlsOrder||s.keys(this.controls),this.onAction=o.onAction||s.noop,this.keyboardEvents=o.keyboardEvents,t.call(this),this.keyboardEvents&&e.call(this),r.call(this,o)};return s.assign(p.prototype,r.prototype),p.prototype.setActives=function(t){d=s.reduce(this.controls,function(e,i,s){var n=i.command,o=(i.el||"").toUpperCase(),a=c(t,o),r=!1;try{r=document.queryCommandEnabled(n)&&document.queryCommandState(n)}catch(l){r=!1}return e[s]=r||a,e},{},this),h.call(this)},p.prototype.open=function(t,e){if(!this.isShown){var i=n(this.element).children("[data-command]"),s=n(this.element).find(".shim");n(this.element).css({width:"auto"}),s.remove(),i.removeAttr("style")}this.showOverTarget(t,e)},p.prototype.closeWithShim=function(t,e,i,o){var r=n(this.element),l=n(t),h=n('<div class="shim">&nbsp;</div>').get(0),c=s.has(a,"Promise");i=c?i:200;var u=r.width();r.css("width",u+e);var d=l.position().left,p=u/2-(d+e/2);l.before(h).hide();var m=n(h).offset().left+p,g=n(h).offset().top;this.isAnimating=!0,s.forEach(this.buttons,function(t,e){a(t,"stop"),a(t,{opacity:0},{duration:.5*i})}),a(r,{left:"+="+p},{easing:"ease",duration:i});var f=a(h,{width:e},{easing:"ease",duration:i}),_=s.bind(function(){s.isFunction(o)&&o.call(this,m,g),this.isAnimating=!1,this.hide()},this);c?f.then(_):s.delay(_,i)},p.prototype.getActiveStates=function(){return d},p}();e.exports=l},{"./controlBase":611,jquery:"HlZQrA",lodash:"MicNly","velocity-animate":"lWl/mc"}],615:[function(t,e,i){var s=t("lodash"),n=function(){function t(){return navigator.platform.match(/^Win/i)?"Win":navigator.platform.match(/^Mac/i)?"Mac":navigator.platform.match(/^Linux/i)?"Linux":navigator.platform}function e(){return s.extend({},this.prettyMapping,this.platformPrettyMapping[t.call(this)])}function i(){return this.platformModifiers[t.call(this)]||{}}function n(){var e=t.call(this);return s.has(this.platformPrettySeperators,e)?this.platformPrettySeperators[e]:this.seperator}function o(t){return this.specialKeys[t.keyCode]||String.fromCharCode(t.keyCode)}function a(t){return s.filter(this.modifiers,function(e){return t[e+"Key"]})}function r(t){return t.charAt(0).toUpperCase()+t.slice(1).toLowerCase()}var l=["ctrl","meta","alt","shift"],h="+",c={37:"LEFT",38:"UP",39:"RIGHT",40:"DOWN",187:"PLUS",61:"PLUS",188:"COMMA",189:"MINUS",173:"MINUS",190:"DOT",32:"SPACE"},u={LEFT:"←",RIGHT:"→",DOWN:"↓",UP:"↑",PLUS:"+",COMMA:",",MINUS:"-",DOT:".",SPACE:"Space"},d={Win:{meta:"ctrl"},Linux:{meta:"ctrl"}},p={Mac:{meta:"⌘",shift:"⇧",alt:"⌥"}},m={Win:"-",Linux:"-",Mac:""},g=function(t){t=t||{},this.modifiers=t.modifiers||l,this.separator=t.separator||h,this.specialKeys=t.specialKeys||c,this.prettyMapping=t.prettyMapping||u,this.platformModifiers=t.platformsModififiers||d,this.platformPrettyMapping=t.platformPrettyModifiers||p,this.platformPrettySeperators=t.platformPrettySeperators||m};return g.prototype.translate=function(t){var e=a.call(this,t);return 0===e.length?null:e.concat(o.call(this,t)).join(this.separator)},g.prototype.normalize=function(t){var e=t.split(this.separator),n=i.call(this),o="";return s.each(this.modifiers,function(t){var i=s.indexOf(e,t.toLowerCase()),a=n[t]||t;i>=0&&(o+=a+this.separator,e.splice(i,1))},this),o+e.join(this.separator).toUpperCase()},g.prototype.pretty=function(t){var i=this.normalize(t),o=e.call(this),a=n.call(this);return s.map(i.split(this.separator),function(t){return o[t]||r(t)},this).join(a)},g}();e.exports=n},{lodash:"MicNly"}],616:[function(t,e,i){var s=t("lodash"),n=t("jquery"),o=t("./controlBase"),a=function(){function t(){this.element=n("<div />",{"class":"inline-controls"}).css({position:"absolute",top:0,left:0}),this.opener=n("<div />",{"class":"opener"}),this.isTrayOpen=!1;var t=this;this.opener.on("mousedown",function(i){return i.preventDefault(),i.stopPropagation(),e.call(t,null,!0),!1}),this.tray=n("<div />",{"class":"tray"}),this.element.append(this.opener),this.element.append(this.tray),this.hide()}function e(t,e){"boolean"!=typeof t&&(t=!this.isTrayOpen),t?(this.openTray.call(this,this.tray),this.isTrayOpen=!0,this.onTrayOpened.call(this,e)):(this.closeTray.call(this,this.tray),this.isTrayOpen=!1,this.onTrayClosed.call(this,e)),n(this.opener).toggleClass("open",this.isTrayOpen),e?n(this.opener).toggleClass("closed",!this.isTrayOpen):n(this.opener).removeClass("closed")}var i=function(e){e=e||{},this.openTray=e.openTray||this.openTray,this.closeTray=e.closeTray||this.closeTray,this.onTrayOpened=e.onTrayOpened||function(t){},this.onTrayClosed=e.onTrayClosed||function(t){},this.customOffset=e.customOffset||s.noop,this.keyboardEvents=e.keyboardEvents,t.call(this),o.call(this,e)};s.assign(i.prototype,o.prototype);var a=s.memoize(function(t,e){var i;return s.isFunction(e)?i=e.call():s.isObject(e)&&(i=e),s.pick(s.defaults(s.isObject(i)?i:{},{x:t.x||t,y:t.y||0}),["x","y"])});return i.prototype.addToTray=function(t,e){var i;e=e||{},this.tray.append(t),i=e.keyboard,this.keyboardEvents&&i&&this.keyboardEvents.on(i.shortcut,i.callback,i.context)},i.prototype.openTray=function(t){t.show()},i.prototype.closeTray=function(t){t.hide()},i.prototype.open=function(t,i){if(t){i=a(i||0,this.customOffset||0);var s=n(t).position(),o=parseInt(n(t).css("margin-top"),10)||0;e.call(this,!1),this.show(s.left+i.x,s.top+i.y+o)}},i.prototype.close=function(){e.call(this,!1),this.hide()},i.prototype.toggleTrayWithIntent=function(t){e.call(this,t,!0)},i}();e.exports=a},{"./controlBase":611,jquery:"HlZQrA",lodash:"MicNly"}],617:[function(t,e,i){var s=t("lodash"),n=t("jquery"),o=t("./humanKeys"),a=function(){function t(){n(this.element).on("keydown.keycombos",i.bind(this)),this.listening=!0}function e(){n(this.element).off("keydown.keycombos"),this.listening=!1}function i(t){var e=this.humanKeys.translate(t);e&&r.call(this,e)&&(a.call(this,e,t),t.preventDefault(),t.stopImmediatePropagation())}function a(t,e){s.each(h.call(this,t),function(i){s.has(i,"callback")&&s.has(i,"context")&&i.callback.call(i.context,e,t)})}function r(t){return h.call(this,t).length>0}function l(t,e){var i=h.call(this,t);return s.filter(i,{callback:e}).length>0}function h(t){return s.has(this.subscribers,t)?this.subscribers[t]:[]}function c(e,i,n){return l.call(this,e,i)?void 0:(s.has(this.subscribers,e)||(this.subscribers[e]=[]),this.subscribers[e].push({callback:i,context:n}),this.listening||t.call(this),this)}function u(){this.subscribers={},e.call(this)}function d(t,i){return t?s.has(this.subscribers,t)?(i&&(this.subscribers[t]=s.reject(this.subscribers[t],{callback:i})),i&&0!==this.subscribers[t].length||delete this.subscribers[t],0===s.values(this.subscribers).length&&e.call(this),this):this:(u.call(this),this)}var p=function(t){t=t||{},this.debounceRate=t.debounceRate||100,this.element=t.element||document,this.humanKeys=t.humanKeys||new o,this.subscribers={},this.listening=!1};return p.prototype.on=function(t,e,i){s.each((t||"").split(" "),function(t){c.call(this,this.humanKeys.normalize(t),e,i)},this)},p.prototype.off=function(t,e){t?s.each(t.split(" "),function(t){d.call(this,this.humanKeys.normalize(t),e)},this):d.call(this,null,e)},p}();e.exports=a},{"./humanKeys":615,jquery:"HlZQrA",lodash:"MicNly"}],618:[function(t,e,i){var s={debugMode:!1};e.exports=s},{}],619:[function(t,e,i){var s=t("lodash"),n=t("jquery"),o=t("velocity-animate"),a=t("./utils"),r=t("./selectionPersistence"),l=t("./controlBase"),h=t("./debugConsole"),c=function(){function t(){this.element=n("<div />",{"class":"link-bubbles"}).css({position:"absolute",top:0,left:0}),this.linkUrl=n("<div />",{"class":"url"}),this.linkEditInput=n("<input />",{type:"text",placeholder:"http://"}),this.linkEditDone=n("<div />",{"class":"done"}).text(this.actionNames.done),this.linkUrl.hide(),this.linkUrl.append(this.linkEditInput).append(this.linkEditDone),e.call(this),this.element.append(this.linkUrl),this.hide()}function e(){var t=this,e=n("<div />",{"class":"options"}),s={edit:function(){i.call(this)},remove:function(){var t=window.getSelection(),e=document.createRange();e.selectNodeContents(this.linkElement),t.removeAllRanges(),t.addRange(e),window.document.execCommand("unlink",!1,null),t.removeAllRanges(),this.onChange(),this.hide()},open:function(){var t=n(this.linkElement).attr("href");-1===t.indexOf("://")&&(t="http://"+t),window.open(t,"_blank")}};for(var o in s){var a=n("<div />",{"class":o}).text(this.actionNames[o]);n(a).on("click",function(e){return function(){e.call(t)}}(s[o])),e.append(a)}e.hide(),n(this.element).append(e)}function i(){this.linkElement||h.error("Cannot edit link without a valid linkElement");var t=this.linkElement;c.call(this,function(e){n(t).attr("href",e)},n(t).attr("href"))}function c(t,e){e&&(this.linkEditInput.val(e),this.linkUrl.addClass("modified"));var i=this,s=function(){var e=n(i.linkEditInput).val().trim();t(e),i.onChange(),i.close()};n(this.linkEditInput).on("keydown",function(t){i.linkUrl.addClass("modified"),t.keyCode===d.enter?(t.preventDefault(),s()):t.keyCode===d.esc&&(i.close(),i.onDismiss(),t.stopPropagation())}),n(this.linkEditInput).on("keyup",function(t){t.keyCode!==d.esc&&t.keyCode!==d.enter&&u.call(i)}),n(this.linkEditInput).on("paste",function(t){i.linkUrl.addClass("modified"),u.call(i)}),this.linkEditDone.on("click",function(t){t.preventDefault(),s()}),this.element.find(".options").hide(),this.linkUrl.show(),this.show(),u.call(this),n(this.linkEditInput).focus()}function u(){var t=n(this.linkEditInput).val(),e=n(this.linkEditDone).outerWidth(),i=n(this.linkUrl).outerWidth()-n(this.linkUrl).width(),s=a.calcTextWidth(n(this.linkEditInput).get(0),t),r=a.calcTextWidth(n(this.linkEditInput).get(0),"A"),l=s+e+i+r,h=l<this.minWidth?this.minWidth:l;h=h>this.maxWidth?this.maxWidth:h;var c=n(this.element),u=h-c.width();if(0!==u){var d=Math.floor(u/2);o(c,{width:h,left:"-="+d},{duration:40,easing:"ease"})}}var d={shift:16,enter:13,esc:27,"delete":8,tab:9},p=function(e){this.onChange="onChange"in e&&s.isFunction(e.onChange)?e.onChange:s.noop,this.onDismiss=e.onDismiss||s.noop,this.bypassClasses="bypassClasses"in e&&s.isArray(e.bypassClasses)?e.bypassClasses:[],this.maxWidth="maxWidth"in e&&s.isNumber(e.maxWidth)?e.maxWidth:600,this.minWidth="minWidth"in e&&s.isNumber(e.minWidth)?e.minWidth:200,this.linkElement=null,this.labels=s.extend({},{Edit:"Edit",Remove:"Remove",Open:"Open",Done:"Done"},e.labels),this.actionNames={edit:this.labels.Edit,remove:this.labels.Remove,open:this.labels.Open,done:this.labels.Done},t.call(this),l.call(this)};return s.assign(p.prototype,l.prototype),p.prototype.createLink=function(t){c.call(this,function(e){r.restoreSelection(t),window.document.execCommand("createLink",!1,e);var i=window.getSelection(),s=i.getRangeAt(0);s.collapse(!1),i.removeAllRanges(),i.addRange(s)})},p.prototype.showOptions=function(t){this.linkElement=t,this.linkUrl.hide(),this.element.css({width:"",left:0}),this.element.find(".options").show()},p.prototype.close=function(){this.linkUrl.hide(),this.element.find(".options").hide(),this.element.css("width",""),this.linkEditInput.val("").unbind(),this.linkEditDone.unbind(),this.linkUrl.removeClass("modified"),this.linkElement=null,this.hide()},p.prototype.isValidLink=function(t){return t?!s.some(this.bypassClasses,function(e){return n(t).hasClass(e)}):!1},p}();e.exports=c},{"./controlBase":611,"./debugConsole":613,"./selectionPersistence":625,"./utils":628,jquery:"HlZQrA",lodash:"MicNly","velocity-animate":"lWl/mc"}],620:[function(t,e,i){var s=t("lodash"),n=t("./ligature");e.exports=s.extend(n,{RichTextEditor:t("./richTextEditor"),PlainTextEditor:t("./plainTextEditor"),SelectionContext:t("./selectionContext"),SelectionPersistence:t("./selectionPersistence"),Utils:t("./utils"),HumanKeys:t("./humanKeys")})},{"./humanKeys":615,"./ligature":618,"./plainTextEditor":621,"./richTextEditor":622,"./selectionContext":624,"./selectionPersistence":625,"./utils":628,lodash:"MicNly"}],621:[function(t,e,i){var s=t("lodash"),n=t("jquery"),o=t("./dataFilter"),a=t("./selectionPersistence"),r=t("./selectionContext"),l=t("./undoManager"),h=t("./smartQuoter"),c=t("./keyComboEvents"),u=t("./debugConsole"),d=function(){function t(){g.call(this,k);var t=n("<div />",{"data-js":"editor-wrapper","class":"editor-wrapper"}).css("position","relative"),i=n("<div />",{"data-js":"editor-slot","class":"editor-slot"}).css("position","relative");n(this.element).wrap(t).wrap(i),this.placeholderElement=n("<div />",{"data-js":"editor-placeholder","class":"editor-placeholder"}).css("position","absolute"),i=n(this.element).parent(),
i.append(this.placeholderElement),d.call(this),e.call(this)}function e(){var t=this,e=function(){y.call(this),i.call(this),this.onChange()};n(this.element).on("input keydown keyup keypress mousedown mouseup",function(e){t.config.onClientEvent.call(t,e)}),n(this.element).on("keydown",function(e){if(e.keyCode===E.shift)t.keyModifiers.shift=!0;else if(e.keyCode===E.backspace)C.call(t);else if(e.keyCode===E.enter)return t.config.forceSingleLine||e.metaKey||v.call(t,this,!1),void e.preventDefault();s.defer(function(){t.onChange(e)})}),n(this.element).on("keyup",function(i){i.keyCode===E.shift?t.keyModifiers.shift=!1:i.keyCode===E.enter?C.call(t):(i.keyCode===E.backspace||i.keyCode===E["delete"])&&s.defer(function(){C.call(t)}),e.call(t)}),n(this.element).on("input",function(i){e.call(t)}),n(this.element).on("blur",function(e){t.onChange()});var o=!1;n(this.element).on("mouseup",function(){o=!1,i.call(t)}),n(this.element).on("mousedown",function(t){o=!0}),n(this.element).on("mouseleave",function(){o&&i.call(t)}),n(this.element).on("paste",function(e){var i=(e.originalEvent||e).clipboardData;t.config.pasteHook(i,t.keyModifiers.shift)||p.call(t,i,e),e.preventDefault()}),n(this.element).on("drop",function(t){t.stopPropagation(),t.preventDefault()}),this.placeholderElement.on("click",function(){t.isEmpty()&&n(t.element).focus()}),n(this.element).on("focus",function(){s.defer(function(){t.onChange()})})}function i(){var t=this;setTimeout(function(){var e=r.getSelection();t.config.onSelection.call(t,e)},200)}function d(){var t=this.isEmpty()?this.config.placeholder:"",e=n(this.placeholderElement);e.html(t);var i=e.outerHeight();i&&n(this.element).css("min-height",Math.max(parseInt(e.css("min-height"),10)||0,i))}function p(t,e){var i="";if(s.contains(t.types,"text/plain"))i=t.getData("text/plain"),i=this.dataFilter.filterPlaintext(i),_.call(this,i);else{if(!s.contains(t.types,"text/html"))return;i=t.getData("text/html"),i=this.dataFilter.filterHTML(i);var n=i.replace(/<br(\s*)\/*>/gi,"\n").replace(/(<[p|div])/gi,"\n$1"),o=document.implementation.createHTMLDocument("");o.body.innerHTML=n;var a=o.body,r=a.textContent||a.innerText||"",l=r.split("\n").join("<br>");_.call(this,l)}if(this.config.forceSingleLine){var h=f.call(this).replace(/<br\s*\/*>/g," ");g.call(this,h)}this.onChange(e)}function m(){n(this.element).contents().filter(function(){return 3===this.nodeType}).wrap("<span></span>")}function g(t){n(this.element).html(t)}function f(){return n(this.element).html().trim()}function _(t){if(t=t.replace(/[<]br\s?\/?[>]$/,""),t=this.dataFilter.convertToBrowserSpaces(t),!t)return void u.warn("Cannot insert empty data");var e=r.getSelection();if(!e||!e.focusNode)return void u.warn("Cannot insert without the editor having a cursor or selection");var i=e.getRangeAt(0);i.deleteContents();var s=i.createContextualFragment(t);i.insertNode(s),e.removeAllRanges(),i.collapse(!1),e.addRange(i)}function v(t,e){e||t.lastChild&&"br"===t.lastChild.nodeName.toLowerCase()||t.appendChild(document.createElement("br"));var i=r.getSelection();if(i){var s=i.getRangeAt(0),n=document.createElement("br");s.deleteContents(),s.insertNode(n),s.setStartAfter(n),s.setEndAfter(n),s.collapse(!1),i.removeAllRanges(),i.addRange(s)}}function b(t){n(t).contents().each(function(t,e){e.nodeType===Node.TEXT_NODE?e.textContent=e.textContent.replace(T,""):e.nodeType===Node.ELEMENT_NODE&&b(e)})}function y(){if(!this.isEmpty()){var t=w.call(this);if(t&&t.nodeType===Node.ELEMENT_NODE){var e=t.textContent||t.innerText||"",i=e.match(T);if(i){var s=a.saveSelection(t);s.start-=(e.substr(0,s.start).match(T)||"").length||0,s.end-=(e.substr(0,s.end).match(T)||"").length||0,b(t),a.restoreSelection(s)}}}}function w(){var t=x.call(this);if(!t){var e=n(this.element).children();if(!e.length)return null;t=e.last().get(0)}return t}function x(t){return t||(t=!r.getSelection()&&this.lastSelection?r.getParentNodes(this.lastSelection.anchorNode):r.getNodeList()),s.find(t.reverse(),function(t){return t.nodeType===Node.ELEMENT_NODE})}function C(){this.isEmpty()&&(g.call(this,k),this.setCursorToEnd())}var k="<span>&#8203;</span>",S="<span>​</span>",T=/\u200B/g,E={shift:16,enter:13,esc:27,backspace:8,"delete":46,tab:9,right:39},P=function(e,i){if(!e)throw new Error("A valid element parameter is required to initalize the editor");this.element=e,this.keyComboEvents=i.keyComboEvents||new c({element:this.element}),this.keyComboEvents.on("meta+b meta+i meta+k meta+u",s.noop),this.config={placeholder:!1,onChange:function(){},onSelection:function(t){},onClientEvent:function(t){},pasteHook:function(t,e){return!1},filterForSetData:function(t){return t},filterForGetData:function(t){return t},filterRules:{elements:["p","br","div"],attributes:{},remove_contents:["style","noscript","script","meta"],protocols:{}},forceSingleLine:!1,smartQuotes:{enabled:!1,config:{}}},s.extend(this.config,i||{}),this.dataFilter=new o(this.config.filterRules),this.onChange=function(){this.previousRawData!==f.call(this)&&(m.call(this),d.call(this),this.config.onChange.apply(this,arguments),this.previousRawData=f.call(this))},this.keyModifiers={shift:!1},this.undoManager=new l(this),this.config.smartQuotes.enabled&&(this.smartQuoter=new h(this)),t.call(this)};return P.prototype.getData=function(t){var e=f.call(this);e=this.config.filterForGetData.call(this,e);var i=e.replace(/<br(\s*)\/*>/gi,"\n").replace(/(<[p|div])/gi,"\n$1").replace(T,""),s=document.createElement("div");s.innerHTML=i;var n=s.textContent||s.innerText||"",o=t?n.trim():n;return o},P.prototype.setData=function(t){t=this.config.filterForSetData.call(this,t),t=this.dataFilter.filterPlaintext(t),g.call(this,t),C.call(this),this.onChange()},P.prototype.setHTML=function(t){g.call(this,t),this.onChange()},P.prototype.getHTML=function(){return f.call(this)},P.prototype.insertData=function(t,e){e&&(t=this.dataFilter.filterHTML(t)),_.call(this,t),this.onChange()},P.prototype.blur=function(){return n(this.element).blur()},P.prototype.focus=function(t){var e=n(this.element).focus();return t||this.setCursorToEnd(),e},P.prototype.hasFocus=function(){return n(this.element).is(":focus")},P.prototype.setPlaceholder=function(t){this.config.placeholder=t,d.call(this)},P.prototype.isEmpty=function(){var t=this.getData(!1);if(""===t||"\n"===t||"\r\n"===t)return!0;var e=f.call(this);return e===k||e===S||""===e},P.prototype.getCurrentElement=function(){return r.getNearestElement()},P.prototype.setCursorToStart=function(t){var e=n(this.element);t=t&&e.find(t).first().get(0)||e.children().first().get(0),t&&a.setToStart(t)},P.prototype.setCursorToEnd=function(t){var e=n(this.element);t=t&&e.find(t).last().get(0)||e.children().last().get(0),t&&a.setToEnd(t)},P.prototype.teardown=function(){this.undoManager.teardown(),this.keyComboEvents.off()},P}();e.exports=d},{"./dataFilter":612,"./debugConsole":613,"./keyComboEvents":617,"./selectionContext":624,"./selectionPersistence":625,"./smartQuoter":626,"./undoManager":627,jquery:"HlZQrA",lodash:"MicNly"}],622:[function(t,e,i){var s=t("lodash"),n=t("jquery"),o=t("velocity-animate").animate,a=t("./linkControl"),r=t("./formattingControls"),l=t("./dataFilter"),h=t("./selectionPersistence"),c=t("./selectionContext"),u=t("./inlineControls"),d=t("./utils"),p=t("./undoManager"),m=t("./smartQuoter"),g=t("./keyComboEvents"),f=t("./humanKeys"),_=(window.URL||window.webkitURL||window.mozURL||window.msURL||{}).createObjectURL,v=t("./debugConsole"),b=function(){function t(t,e){return s.mapValues(t,function(t,e){return e.match(/^on[A-Z]/)&&s.isFunction(t)?s.bind(t,this):t},e)}function e(){B.call(this,ct);var t=n("<div />",{"data-js":"editor-wrapper","class":"editor-wrapper"}).css("position","relative"),e=n("<div />",{"data-js":"editor-slot","class":"editor-slot"}).css("position","relative");n(this.element).wrap(t).wrap(e),e=n(this.element).parent(),this.wrapper=e.parent().get(0),this.placeholderElement=n("<div />",{"data-js":"editor-placeholder","class":"editor-placeholder"}).css("position","absolute"),e.append(this.contextualControls.element),e.append(this.linkControl.element),e.append(this.placeholderElement),e.append(this.inlineControls.element),L.call(this),this.controlBar=n("<div />",{"data-js":"control-bar","class":"control-bar disabled"});var o=n("<div />",{"class":"static-controls control"});this.controlBar.append(o),this.controlBar.append(this.staticControls.element);var a=this;o.on("mousedown",function(t){t.preventDefault(),t.stopPropagation();var e=c.getNodeList();a.staticControls.setActives(s.pluck(e,"nodeName"));var i=n(this).position();return a.staticControls.isShown?a.staticControls.hide():a.staticControls.open(i.left+n(this).width()/2,0),a.contextualControls.hide(),a.linkControl.close(),!1}),this.config.showStaticControls&&n(this.wrapper).append(this.controlBar),i.call(this),S.call(this)}function i(){var t=this,e=function(){var e=t.inlineControls.isTrayOpen||t.contextualControls.isShown||t.staticControls.isShown||t.linkControl.isShown;return e};n(this.element).on("input keydown keyup keypress mousedown mouseup",function(e){t.controlBar.removeClass("disabled"),t.config.onClientEvent.call(t,e)});var i=function(){N.call(this),this.onChange()};n(this.element).on("keydown",function(i){if(i.keyCode===vt.shift)t.keyModifiers.shift=!0;else{if(i.keyCode===vt.esc)return void(e()&&(t.contextualControls.hide(),t.staticControls.hide(),t.inlineControls.isTrayOpen&&t.inlineControls.toggleTrayWithIntent(!1),i.stopPropagation()));i.keyCode===vt.backspace?(k.call(t,i),z.call(t)):i.keyCode===vt.enter&&(w.call(t,i),y.call(t,i),d.browser.safari&&i.shiftKey&&(i.preventDefault(),b.call(t)))}M.call(t,i),N.call(t,i)}),n(this.element).on("keyup",function(e){e.keyCode===vt.shift?t.keyModifiers.shift=!1:e.keyCode===vt.enter?z.call(t):(e.keyCode===vt.backspace||e.keyCode===vt["delete"])&&(I.call(t),s.defer(function(){C.call(t)}));var n=!1;e.keyCode===vt.right&&!e.shiftKey&&t.inlineControls&&(n=t.inlineControls.isShown),e.keyCode===vt.esc||n||i.call(t)}),n(this.element).on("input",function(){i.call(t)});var o=!1;n(this.element).on("mouseup",function(){o=!1,N.call(t)}),n(this.element).on("mousedown",function(t){o=!0}),document.addEventListener("mousedown",function(e){var i=function(){o=!1,x.call(t),t.controlBar.addClass("disabled")};t.wrapper===e.target||n.contains(t.wrapper,e.target)||t.config.documentMousedownHook(e,i)||i()},!0),document.addEventListener("mouseup",function(e){o&&(N.call(t),o=!1)},!0),n(this.element).on("focus",function(){if(t.controlBar.removeClass("disabled"),!H.call(t)){var e=n(t.element).children(dt.join());if(e.length){var i=e.first().get(0);h.setToStart(i)}}s.defer(function(){t.onChange()})}),n(this.element).on("blur",function(i){var n=function(i){if(!e()){var n=c.getSelection();n&&c.isInContext(n,t.element)&&n.removeAllRanges(),t.lastSelection=null,N.call(t,function(){t.onChange(),s.isFunction(i)&&i()})}};t.config.blurHook(i,n)||s.defer(n)}),n(this.element).on("paste",function(e){var i=(e.originalEvent||e).clipboardData;i&&(t.config.pasteHook(i,t.keyModifiers.shift)||O.call(t,i),D.call(t),e.preventDefault())}),n(this.element).on("cut",function(e){t.contextualControls.hide(),t.staticControls.hide(),t.linkControl.close(),s.defer(function(){C.call(t),D.call(t),t.onChange()})})}function b(){for(var t=H.call(this),e=s.contains(mt,t.nodeName)?"\n":"<br>",i=c.isCursorAtEnd(t)&&!c.isCursorAtStart(t)?1:0,n=0;i>n;n++)e+=e;U.call(this,e)}function y(t){var e,i,o=c.getNodeByNames(mt);o&&!this.keyModifiers.shift&&c.isCursorAtEnd(o)&&(i=n(o),e=i.text(),t.preventDefault(),e.match(/\n\n$/)?(s.last(i.contents()).remove(),this.insertNewParagraphAfter(o)):(i.append("\n\n"),h.setToEnd(o)))}function w(t){var e=c.getNodeByNames(["BLOCKQUOTE"]);if(e&&!this.keyModifiers.shift&&c.isCursorAtEnd(e,!0)){var i="P"===e.lastElementChild.nodeName?e.lastChild:null;i&&i.previousSibling&&this.dataFilter.isEmptyElement(i,!0)&&(t.preventDefault(),n(i).remove(),this.insertNewParagraphAfter(e))}}function x(){this.contextualControls.hide(),this.staticControls.hide(),this.linkControl.close(),this.inlineControls.close()}function C(){if(!n(this.element).has(_t.join()).length){var t=n(this.element).find("ul:not(:has(li)),ol:not(:has(li))");t.remove();var e=s.some(n(this.element).children().toArray(),function(t){return t.textContent.length>0});e||(B.call(this,""),z.call(this),L.call(this))}}function k(t){var e=c.getSelection();if(e.isCollapsed){var i=H.call(this);if(i&&!(h.saveSelection(i).start>0)){var s=n(i).prev().get(0);s&&rt.call(this,s)&&(n(s).remove(),t.preventDefault())}}}function S(){var t=this,e=n(t.element).offset().top,i=null,o="dragstart dragenter dragleave dragover dragend drop",a=!1,r=function(t){var e=t.dataTransfer.types&&s.some(t.dataTransfer.types,function(t){return"Files"===t});return e},l=function(t){return"false"===n(t.target||t.srcElement).attr("contenteditable")},h=function(e,i,n){e.length&&(t.onChange(),s.each(e,function(e){t.config.onFileAdded.call(t,e,i,n)}),N.call(t))},c=function(t,e){return t<e.top+.66*e.height},u=function(t,i){var s=n(i).offset().top-e,o=n(i).get(0).getBoundingClientRect().height,a=t>s+.66*o;return{element:i,top:s,bottom:s+o,height:o,isAfter:a}},d=function(){n(t.element).find(".over-top, .over-bottom").each(function(){n(this).removeClass("over-top").removeClass("over-bottom"),""===n(this).attr("class").trim()&&n(this).removeAttr("class")})},p=function(s){var o=null,a=s.pageY-e,r=n(t.element).children();i&&a>i.top&&c(a,i)||(r.each(function(){var t=u(a,this);return c(a,t)&&(s.target||s.srcElement)!==this?(o=t,!1):void 0}),o||(o=u(a,r.last().get(0)),o.isAfter=!0),o&&i&&i.element===o.element&&i.isAfter===o.isAfter||(d(),i=o))};n(t.element).unbind(o),n(t.element).on("dragleave",function(t){d()}),n(t.element).on("dragover",function(t){return a?(s.debounce(p,100)(t.originalEvent),i&&(n(i.element).addClass(i.isAfter?"over-bottom":"over-top"),r(t.originalEvent)&&t.stopPropagation()),void t.preventDefault()):(t.preventDefault(),void t.stopPropagation())}),n(t.element).on("dragenter",function(t){t.preventDefault(),r(t.originalEvent)&&(a="file")}),n(t.element).on("dragstart",function(e){if(x.call(t),l(e.originalEvent)){a="media";var i=e.originalEvent.target||e.originalEvent.srcElement,o=e.originalEvent.dataTransfer;if(o){o.effectAllowed="move",o.dropEffect="move";try{var r=n(i).find("img").attr("src")||"";r.match(/^\s*data:/)&&(r=""),o.setData("text/uri-list",r),o.setData("text/plain",r)}catch(e){}}s.defer(function(){n(i).addClass("dragging")})}}),n(t.element).on("drop",function(t){d(),r(t.originalEvent)&&h(t.originalEvent.dataTransfer.files,i.element,i.isAfter?1:-1),t.stopPropagation(),t.preventDefault()}),n(t.element).on("dragend",function(e){if(l(e.originalEvent)){d();var s=e.originalEvent.target||e.originalEvent.srcElement,o=n(s).data("origHeight"),r=s;if(i&&r!==i.element){var h=n(s).remove();i.isAfter?n(i.element).after(h):n(i.element).before(h),st.call(t,h)}n(r).animate({height:o},200,function(){n(r).removeClass("dragging")}),t.onChange(),N.call(t)}a=!1})}function T(t,e,i){var s=n(this.element),o=h.saveSelection(this.element);s.find(i).wrap("<"+e+">"),s.find(i).contents().unwrap(),h.restoreSelection(o),window.document.execCommand(t),s.find(e).wrap("<"+i+">"),s.find(e).contents().unwrap(),h.restoreSelection(o)}function E(t,e,i){var o=this,a=function(){window.document.execCommand(t),o.config.flattenBlocks&&j.call(o)},r=function(){var t=h.saveSelection(o.element),e=200,s=240;!i||i.isAnimating||t.selection.isCollapsed||setTimeout(function(){n(o.linkControl.linkEditInput).focus();var a=function(i,s){var a=i-n(o.wrapper).offset().left,r=s-n(o.wrapper).offset().top;o.linkControl.size(e),o.linkControl.show(a,r),o.linkControl.createLink(t)};i.closeWithShim(i.element.find(".link").get(0),e,s,a),t.selection.removeAllRanges(),o.blur(!0)},30)},l=function(t){var e=h.saveSelection(o.element),i=c.getRootElements();switch(s.each(pt,function(t){var e=c.getNodesByNames(i,[t]);e.length&&P.call(o,"formatBlock",t)}),$.call(o),t.toLowerCase()){case"blockquote":i=c.getRootElements();var a=[],r=[];i=s.each(i,function(t){s.contains(ft,t.nodeName.toUpperCase())?r.push(t):(a.push(r),r=[])}),r.length&&a.push(r),s.each(a,function(e){n(e).wrapAll(document.createElement(t))});break;case"pre":window.document.execCommand("formatBlock",!1,"<"+t+">"),F.call(this);break;default:window.document.execCommand("formatBlock",!1,"<"+t+">")}h.restoreSelection(e)},u=function(){var t=o.contextualControls.controls,e=o.contextualControls.getActiveStates();s.each(e,function(e,i){var s=t[i];e&&P.call(o,s.command,s.el)}),window.document.execCommand("removeFormat")};switch(t){case"formatBlock":l(e);break;case"createLink":r();break;case"insertOrderedList":a();break;case"insertUnorderedList":a();break;case"removeFormat":u();break;case"insertHTML":T.call(this,"underline","U",e);break;default:window.document.execCommand(t)}N.call(this),I.call(this),o.onChange()}function P(t,e){var i=this;switch(t){case"formatBlock":var o=h.saveSelection(this.element);$.call(i),s.each(c.getRootElements(),function(t){i.dataFilter.unBlock(t),"pre"===t.nodeName.toLowerCase()&&(t.innerHTML=t.innerHTML.replace("\n","<br>"));var e=t.nodeName.toUpperCase();if(s.contains(pt,e)){var o=n(t).contents();n(o).wrapAll("<p>"),n(t.firstChild).unwrap()}}),h.restoreSelection(o);break;case"insertOrderedList":$.call(this);break;case"insertUnorderedList":$.call(this);break;case"createLink":window.document.execCommand("unlink");break;case"insertHTML":T.call(this,"underline","U",e);break;default:window.document.execCommand(t)}I.call(this),N.call(this),this.onChange()}function M(t){var e=function(){var t=c.getNodeByNames(["UL","OL"]);return!!t};t.keyCode===vt.tab&&e()&&(t.preventDefault(),t.stopPropagation(),t.shiftKey?(E.call(this,"outdent"),e()||E.call(this,"formatBlock","p")):E.call(this,"indent"))}function F(){var t=c.getNodeByNames(mt);t&&n(t).find("br").replaceWith("\n")}function $(){var t=c.getNodeByNames(gt);if(t){do window.document.execCommand("outdent");while(c.getNodeByNames(gt));c.getNodeByNames(["H2"])||window.document.execCommand("formatBlock",!1,"<p>"),this.dataFilter.blockifyInlineNodes(this.element)}}function j(){var t=h.saveSelection(this.element),e=c.getNodeList(null,!0);this.dataFilter.unwrapParentBlocks(e),h.restoreSelection(t)}function I(){var t=h.saveSelection(this.element),e=c.getNodeList(),i=this.dataFilter.scrubSpansAndBadAttrs(e);i&&t.end>t.start&&h.restoreSelection(t)}function N(t){var e=this;setTimeout(function(){var i=c.getSelection();return i?(i.isCollapsed?R.call(e,i):A.call(e,i),tt.call(e),W.call(e),e.config.onSelection.call(e,i),c.isInContext(i,e.element)&&(e.lastSelection=h.saveSelection(e.element)),D.call(e),L.call(e),void(s.isFunction(t)&&t())):(tt.call(e),void(s.isFunction(t)&&t()))},20)}function A(t){if(c.isInContext(t,this.element)){var e=c.getContextCoordinates(n(this.element).parent().parent()),i=c.getNodeList(t);this.contextualControls.setActives(s.pluck(i,"nodeName")),this.staticControls.setActives(s.pluck(i,"nodeName")),this.linkControl.close(),this.inlineControls.close(),""!==t.toString().trim()&&e&&!this.staticControls.isShown&&this.contextualControls.open(e.x,e.y)}}function R(t){this.contextualControls.hide();var e=c.getNodeList(t),i=s.find(e,function(t){return"A"===t.nodeName});if(this.linkControl.isValidLink(i)){var o=c.getContextCoordinates(n(this.element).parent().parent(),i);this.linkControl.showOptions(i),this.linkControl.showOverTarget(o.x,o.y)}else this.linkControl.close();this.staticControls.setActives(s.pluck(e,"nodeName"))}function D(){var t=c.getSelection(),e=t&&t.isCollapsed;if(!e||!c.isInContext(t,this.element))return void this.inlineControls.close();var i=H.call(this);if(i&&"P"===i.nodeName&&this.dataFilter.isEmptyElement(i)&&!this.isEmpty())this.inlineControls.open(i);else if(this.isEmpty()){this.inlineControls.open(i);var s=d.calcTextWidth(this.placeholderElement,this.config.placeholder);this.inlineControls.open(i,s)}else this.inlineControls.close()}function L(){var t=this.isEmpty()?this.config.placeholder:"",e=n(this.placeholderElement);e.html(t);var i=e.outerHeight();i&&n(this.element).css("min-height",Math.max(parseInt(e.css("min-height"),10)||0,i))}function O(t){var e="";if(t.items&&t.items.length){var i=s.find(t.items,function(t){return/image\/\w+/.test(t.type)});if(i){var o=i.getAsFile();if(o)return void this.config.onFileAdded.call(this,o)}}s.contains(t.types,"text/html")?e=t.getData("text/html"):(e=t.getData("text/plain"),e=this.dataFilter.filterPlaintext(e,!0)),e=e.replace(new RegExp("</t(d|h)></tr>","g"),"<br></td></tr>"),e=e.replace(/\u00a0/g," "),e=this.dataFilter.filterHTML(e),e=this.dataFilter.convertToBrowserSpaces(e);var a=document.createElement("div");a.innerHTML=e,this.dataFilter.flattenBlocksDown(a,!0),n(a).find(_t.join()).remove();var r=s.some(a.children,function(t){return s.contains(dt,t.nodeName)});if(r){var l=c.getSelection(),h=l.getRangeAt(0);h.deleteContents();var u=H.call(this);if(""===n(u).text().trim()){var d=n(u).index(),p=n(u).parent(),m=d+a.children.length-1;n(u).replaceWith(a.children);var g=n(p).children().eq(m).get(0);h.selectNodeContents(g),h.collapse(!1),l.removeAllRanges(),l.addRange(h)}else this.dataFilter.inlinify(a),U.call(this,a.innerHTML)}else U.call(this,a.innerHTML);this.onChange()}function B(t){n(this.element).html(t)}function V(){return n(this.element).html().trim()}function U(t){if(!t)return void v.warn("Cannot insert empty data");var e=c.getSelection();if(!e||!e.focusNode)return void v.warn("Cannot insert without the editor having a cursor or selection");var i=e.getRangeAt(0);i.deleteContents(),t=this.dataFilter.convertToBrowserSpaces(t);var s=document.createElement("div");s.innerHTML=t;for(var n,o=s.lastChild,a=document.createDocumentFragment();n=s.firstChild;)a.appendChild(n);i.insertNode(a),i.setStartAfter(o),i.collapse(!1),e.removeAllRanges(),e.addRange(i)}function q(){var t=H.call(this);if(!t){var e=n(this.element).children(dt.join());if(!e.length)return null;t=e.last().get(0)}return t}function H(){var t=c.getSelection()||this.lastSelection;return c.getNodeByNames(dt,!0,t)}function z(){var t=q.call(this);if(t){if("div"===t.nodeName.toLowerCase())try{window.document.execCommand("formatBlock",!1,"<p>")}catch(e){}}else B.call(this,ct),this.setCursorToStart()}function W(){var t=n(this.element).children(ft.join()).last().get(0);t||n(this.element).append(ct)}function G(t,e,i,o,a){var r=this,l=function(t){var l,h,c,u,d=s.uniqueId(),p=0===t.lastIndexOf("data:",0)?"file":t;r.mediaTracker[d]={originalSource:p,file:e},h=n("<img />",{src:t}),l=h.get(0),u=n("<figure />"),c=u.get(0),h.attr(r.config.imgKeyAttr,d),u.append(h),Y.call(r,c,i,o,a),Q.call(r,l,function(i){K.call(r,l,i),r.config.onAsyncImageAdded.call(r,d,t,e,i||{})}),r.onChange()};if(!t&&e)if(_)l(_(e));else{var h=new FileReader;h.onload=function(t){l(t.target.result)},h.readAsDataURL(e)}else{if("string"!=typeof t)return void r.config.onAsyncImageFailed.call(r);l(t)}}function K(t,e){var i,o={},a=this.config,r=n(t).parent("figure").get(0),l={toImg:t,toImgParent:r};a.addImgAttrs&&(i=s.reduce(l,function(t,e,i){return(a.addImgAttrs===!0||a.addImgAttrs[i]===!0)&&t.push(e),t},[])),s.isEmpty(i)||!a.imgSizeAttrs||s.isEmpty(e)||(a.imgSizeAttrs.height&&(o[a.imgSizeAttrs.height]=e.height),a.imgSizeAttrs.height&&(o[a.imgSizeAttrs.width]=e.width),n(i).attr(o))}function Q(t,e){var i=function(t){var i={width:t.naturalWidth,height:t.naturalHeight};s.isFunction(e)&&e.call(this,i)};t.complete?i.call(this,t):n(t).one({"load.getImageAttributes":s.bind(s.partial(i,t),this),error:s.bind(function(){n(t).off(".getImageAttributes"),e.call(this,null)},this)})}function J(t){return n(this.element).find("img["+this.config.imgKeyAttr+'="'+t+'"]').get(0)}function Z(t,e,i){var o=J.call(this,t);s.isEmpty(i)||o&&K.call(this,o,i),e&&(n(o).attr("src",e),this.mediaTracker[t].updatedSource=e)}function Y(t,e,i,s){var o;e=e||q.call(this),o=this.dataFilter.isEmptyElement(e.outerHTML,!0)?0:c.isCursorAtStart(e)?-1:1,i="number"==typeof i?i:o;var a=n(t).get(0),r=it.call(this,a);st.call(this,r),0>i?n(e).before(r):i>0?n(e).after(r):0===i&&n(e).replaceWith(r),x.call(this);var l=n(r).nextAll(ft.join()).get(0);l||(l=n(ct).get(0),n(r).after(l)),s||(this.focus(!0),h.setToStart(l)),X.call(this,r,!1,N)}function X(t,e,i){var a=this;e=e||!1,i=i||s.noop;var r=n(t),l=r.find("figure"),h=r.find(".media-button"),c=200;return r.length&&l.length?(e&&h.length&&h.hide(),o(l,{opacity:e?0:[1,0],translateY:e?-25:[0,-25]},{duration:.9*c,easing:"easeOutQuad",complete:function(){l.removeAttr("style")}}),void o(t,e?"slideUp":"slideDown",{duration:c,easing:"easeOutQuart",begin:function(){r.css("pointer-events","none")},complete:function(){r.css("pointer-events",""),i.call(a,t)}})):void i.call(a)}function tt(){var t=this,e=H.call(this);n(e).removeClass(t.config.fakeClass),n(t.element).children("p").each(function(i,s){e!==s&&t.dataFilter.isEmptyElement(s)&&(0===i&&rt.call(t,n(s).next().get(0))||n(s).is(":last-child")&&rt.call(t,n(s).prev().get(0))?et.call(t,s):rt.call(t,n(s).prev().get(0))&&rt.call(t,n(s).next().get(0))?et.call(t,s):n(s).hasClass(t.config.fakeClass)&&n(s).remove()),void 0!==n(s).attr("class")&&""===n(s).attr("class").trim()&&n(s).removeAttr("class")}),n(this.element).children("."+this.config.mediaHolderClass).each(function(e,i){var s=n(this).next().get(0);(!s||rt.call(t,s))&&n(this).after(et.call(t));var o=n(this).prev().get(0);o||n(this).before(et.call(t))})}function et(t){return t=t||n(ct).get(0),n(t).addClass(this.config.fakeClass),t}function it(t){var e=n(t),i=n("<div />",{"class":this.config.mediaHolderClass,contentEditable:!1,draggable:!0});e.wrap(i),i=e.parent(),s.isFunction(this.config.mediaHolderCallback)&&this.config.mediaHolderCallback(this,t,e,i);var o=n(this.config.mediaKillerMarkup);o.addClass("media-killer"),i.append(o);var a=!i.hasClass("media-holder-draggable");if(a){var r=n(this.config.mediaMoverMarkup);r.addClass("media-mover"),i.append(r)}return i}function st(t){var e=this,i=t?n(t):n(this.element).find('[contenteditable="false"]'),s=this.config.mediaHolderEvents;i.each(function(t,i){var o=n(i),a=null;o.off("keydown").on("keydown",function(t){s.keydown.call(null,t,o),t.isPropagationStopped()||((t.keyCode===vt["delete"]||t.keyCode===vt.backspace)&&o.remove(),t.preventDefault(),t.stopPropagation())}),o.off("keyup").on("keyup",function(t){s.keyup.call(null,t,o)}),o.on("mousedown",function(t){a=t.originalEvent.target,s.mousedown.call(null,t,o,a)}),o.on("mouseup",function(t){s.mouseup.call(null,t,o,a);var i=n(a);i.hasClass("media-killer")&&a===t.target&&X.call(e,o,!0,function(){o.remove(),C.call(e),N.call(e),e.onChange()})}),o.on("mouseenter",function(t){n(t.currentTarget).addClass("show-controls"),s.mouseenter.call(null,t,o,a)}),o.on("mouseleave",function(t){n(t.currentTarget).removeClass("show-controls"),s.mouseleave.call(null,t,o,a)}),o.on("dragstart",function(t){var e=n(a);e.hasClass("media-killer")&&(t.preventDefault(),t.stopPropagation()),o.hasClass("media-holder-draggable")||e.hasClass("media-mover")||(t.preventDefault(),t.stopPropagation()),s.dragstart.call(null,t,o,a)})})}function nt(t){s.each(n(t).find("."+this.config.mediaHolderClass),function(t){n(t).find(".media-killer, .media-mover").remove();var e=n(t).children().first();e.length?n(e).unwrap():(n(t).contents().wrap("<div>"),n(t).children().first().unwrap().contents().unwrap())})}function ot(t){var e=this,i=n(t).find("."+this.config.fakeClass+", ."+this.config.fakeClass+"-intent");s.each(i,function(t){e.dataFilter.isEmptyElement(t)&&n(t).remove()})}function at(){var t=this;s.each(n(this.element).find(_t.join()),function(e){var i=c.getParentNodes(e),n=s.some(i,function(t){return s.contains(_t,t.nodeName)});lt.call(t,e)||n||it.call(t,e)})}function rt(t){return n(t).hasClass(this.config.mediaHolderClass)}function lt(t){var e=n(t).closest("[class="+this.config.mediaHolderClass+"]");return e.length?e.get(0):null}function ht(t,e,i){var o,a;return e=s.isBoolean(e)?e:!1,t=t||q.call(this),o=n(t)[e?"prev":"next"](),!i&&o.length>0&&this.dataFilter.isEmptyElement(o)?(h.setToStart(o.get(0)),o):(a=n(ct).get(0),n(t)[e?"before":"after"](a),h.setToStart(a),a)}var ct="<p><br></p>",ut="<p></p>",dt=["P","FIGURE","H2","BLOCKQUOTE","UL","OL","DIV","PRE"],pt=["H2","BLOCKQUOTE","PRE"],mt=["PRE"],gt=["UL","OL"],ft=["P","H2","BLOCKQUOTE","UL","OL","PRE"],_t=["IMG","IFRAME","FIGURE","HR"],vt={shift:16,enter:13,esc:27,backspace:8,"delete":46,tab:9,right:39},bt=function(i,o){if(!i)throw new Error("A valid element parameter is required to initalize the editor");o=o||{},this.element=i,this.humanKeys=new f,this.keyComboEvents=o.keyComboEvents||new g({element:this.element,humanKeys:this.humanKeys});var d=s.template("<%= title %> (<%= shortcut %>)"),_=s.bind(function(t,e){return d({title:t,shortcut:this.humanKeys.pretty(e)})},this);this.config={labels:{},placeholder:!1,onChange:s.noop,onSelection:function(t){},onAsyncImageAdded:function(t,e,i,s){},onAsyncImageFailed:function(){v.warn("Unknown source type for inserting an image.")},onFileAdded:function(t,e,i){},onClientEvent:function(t){},flattenBlocks:!0,smartQuotes:{enabled:!1,config:{}},runIFrameSanitization:!1,mediaHolderClass:"media-holder",mediaHolderCallback:function(t,e,i,n){i.is("hr, img, figure")&&s.isEmpty(i.find("iframe"))&&n.addClass("media-holder-draggable"),n.addClass("media-holder-"+i.prop("tagName").toLowerCase())},mediaHolderEvents:{keydown:s.noop,keyup:s.noop,mousedown:s.noop,mouseup:s.noop,mouseenter:s.noop,mouseleave:s.noop,click:s.noop,dragstart:s.noop},imgKeyAttr:"data-img-key",imgSizeAttrs:{width:"data-orig-width",height:"data-orig-height"},addImgAttrs:{toImg:!1,toImgParent:!1},fakeClass:"fake",mediaKillerMarkup:"<div>×</div>",mediaMoverMarkup:"<div>&#8597;</div>",pasteHook:function(t,e){return!1},blurHook:function(t){return!1},documentMousedownHook:function(t){return!1},filterForSetData:function(t){return t},filterForGetData:function(t){return t},filterRules:{elements:["a","b","i","ul","ol","li","p","h2","blockquote","img","iframe","figure","br","hr","pre","sub","sup","small"],attributes:{a:["href","title"],img:["src","alt","data-orig-width","data-orig-height"],hr:["data-label"],iframe:["src","width","height","frameborder"],figure:["data-orig-width","data-orig-height"]},classnames:{hr:["read-more"]},remove_contents:["style","noscript","script","meta"],protocols:{a:{href:["http","https","mailto"]}}},animateShowControls:function(t){t.element.show()},animateHideControls:function(t){t.element.hide()},linkConfig:{bypassClasses:[],labels:o.labels,onChange:function(){this.onChange.call(this)},onDismiss:function(){this.lastSelection&&(h.restoreSelection(this.lastSelection),N.call(this))}},inlineControlsConfig:{openTray:u.prototype.openTray,closeTray:u.prototype.closeTray,onTrayOpened:function(t){},onTrayClosed:function(t){},keyboardEvents:this.keyComboEvents},formattingControlsConfig:{controls:{bold:{el:"b",className:"bold",command:"bold",type:"inline",title:_("Bold","meta+b"),keyboard:"meta+b"},italic:{el:"i",className:"italic",command:"italic",type:"inline",title:_("Italic","meta+i"),keyboard:"meta+i"},headline:{el:"h2",className:"headline",command:"formatBlock",type:"block",title:_("Headline","meta+shift+2"),keyboard:"meta+shift+2"},link:{el:"a",className:"link",command:"createLink",type:"inline",title:_("Link","meta+k"),keyboard:"meta+k"},strikethrough:{el:"strike",className:"strikethrough",command:"strikethrough",type:"inline",title:_("Strikethrough","meta+shift+6"),keyboard:"meta+shift+6"},orderedList:{el:"ol",className:"ordered-list",command:"insertOrderedList",type:"list",title:_("Ordered List","meta+shift+7"),keyboard:"meta+shift+7"},unorderedList:{el:"ul",className:"unordered-list",command:"insertUnorderedList",type:"list",title:_("Unordered List","meta+shift+8"),keyboard:"meta+shift+8"},blockquote:{el:"blockquote",className:"quote",command:"formatBlock",type:"block",title:_("Blockquote","meta+shift+9"),keyboard:"meta+shift+9"},clear:{el:"",command:"removeFormat",type:"inline",keyboard:"meta+shift+0"
},pre:{el:"pre",command:"formatBlock",type:"block",keyboard:"meta+alt+1"},superscript:{el:"sup",command:"superscript",type:"inline",keyboard:"meta+dot"},subscript:{el:"sub",command:"subscript",type:"inline",keyboard:"meta+comma"},small:{el:"small",command:"insertHTML",type:"inline",keyboard:"meta+shift+minus",keyboardInverse:"meta+shift+plus"}},controlsOrder:["bold","italic","headline","link","strikethrough","orderedList","unorderedList","blockquote"],onShow:function(t){s.isFunction(this.animateShowControls)?this.animateShowControls.call(this,t):t.element.show()},onHide:function(t){s.isFunction(this.animateHideControls)?this.animateHideControls.call(this,t):t.element.hide()},onAction:function(t){var e=c.getNodeList();t.setActives(e)}},showStaticControls:!0},s.merge(this.config,o||{}),this.applyCommand=s.bind(E,this),this.inverseCommand=s.bind(P,this),this.animateShowControls=s.bind(this.config.animateShowControls,this),this.animateHideControls=s.bind(this.config.animateHideControls,this),this.onChange=function(t){var e=V.call(this);this.previousRawData!==e&&(L.call(this),this.config.onChange.call(this),this.previousRawData=e)};var b=t(this.config.linkConfig,this);this.linkControl=new a(b);var y=t(this.config.inlineControlsConfig,this);this.inlineControls=new u(y);var w=t(s.defaults({keyboardEvents:this.keyComboEvents},this.config.formattingControlsConfig),this);this.contextualControls=new r(this.applyCommand,this.inverseCommand,w);var x=this.config.formattingControlsConfig.onShow,C=this.config.formattingControlsConfig.onHide,k=t(s.defaults({onShow:function(t){x.apply(this,arguments),t.listener=t.listener||function(e){var i=c.getNodeList();t.setActives(i),document.removeEventListener("mousedown",t.listener,!1)},document.addEventListener("mousedown",t.listener)},onHide:function(t){C.apply(this,arguments),document.removeEventListener("mousedown",t.listener,!1)}},this.config.formattingControlsConfig),this);this.staticControls=new r(this.applyCommand,this.inverseCommand,k),this.dataFilter=new l(this.config.filterRules),this.keyModifiers={shift:!1},this.undoManager=new p(this,s.bind(function(){for(var t in this.mediaTracker){var e=this.mediaTracker[t].updatedSource;if(e){var i=J.call(this,t);n(i).attr("src",e)}}D.call(this)},this)),this.config.smartQuotes.enabled&&(this.smartQuoter=new m(this,this.config.smartQuotes.config)),this.mediaTracker={},e.call(this)};return bt.prototype.getData=function(t,e){var i=this,o=V.call(this);o=this.config.filterForGetData.call(this,o),this.config.runIFrameSanitization&&(o=this.dataFilter.unSanitizeIFrames(o));var a=document.createElement("div");if(a.innerHTML=o,nt.call(this,a),ot.call(this,a),e||n(a).find("["+i.config.imgKeyAttr+"]").removeAttr(i.config.imgKeyAttr),t)for(var r=function(t){var e=n(a).children(":"+t+"-child").get(0);return e&&i.dataFilter.isEmptyElement(e,!0)?e:null},l=function(){return s.compact([r("first"),r("last")])};l().length;)s.forEach(l(),function(t){n(t).remove()});return a.innerHTML},bt.prototype.setData=function(t,e,i){e&&(t=this.config.filterForSetData.call(this,t),t=this.dataFilter.filterHTML(t)),this.config.runIFrameSanitization&&(t=this.dataFilter.sanitizeIFrames(t)),B.call(this,t),i?this.dataFilter.flattenBlocksDown(this.element):this.dataFilter.blockifyInlineNodes(this.element),z.call(this),at.call(this),st.call(this),W.call(this),this.onChange()},bt.prototype.insertData=function(t,e,i){e&&(t=this.dataFilter.filterHTML(t)),U.call(this,t),i&&this.dataFilter.flattenBlocksDown(c.getNearestElement()),this.onChange()},bt.prototype.blur=function(t){return t||x.call(this),n(this.element).blur()},bt.prototype.focus=function(t){var e=n(this.element).focus();return t||this.setCursorToEnd(),e},bt.prototype.hasFocus=function(){return n(this.element).is(":focus")},bt.prototype.setPlaceholder=function(t){this.config.placeholder=t,L.call(this)},bt.prototype.insertMedia=function(t,e,i,s){e&&(t=this.dataFilter.filterHTML(t)),Y.call(this,t,i,s),this.onChange()},bt.prototype.addControl=function(t){var e=n(this.wrapper).find("[data-js=control-bar]");e.append(t)},bt.prototype.isEmpty=function(){var t=V.call(this);return""===t||"<br>"===t||t===ct||t===ut},bt.prototype.getCurrentElement=function(){return c.getNearestElement()},bt.prototype.getAsyncImage=function(t){return J.call(this,t)},bt.prototype.insertAsyncImage=function(t,e,i,s,n){G.call(this,t,e,i,s,n),this.onChange()},bt.prototype.updateAsyncImage=function(t,e,i){Z.call(this,t,e,i),this.onChange("updateAsyncImage")},bt.prototype.setCursorToStart=function(t,e){var i=n(this.element);t=t&&i.find(t).first().get(0)||i.children().first().get(0),t&&h.setToStart(t),e||N.call(this)},bt.prototype.setCursorToEnd=function(t,e){var i=n(this.element);t=t&&i.find(t).last().get(0)||i.children().last().get(0),t&&h.setToEnd(t),e||N.call(this)},bt.prototype.insertNewParagraphAfter=function(t,e){return ht.call(this,t,!1,e)},bt.prototype.insertNewParagraphBefore=function(t,e){return ht.call(this,t,!0,e)},bt.prototype.isEmptyElement=function(t){return t=t||q.call(this),this.dataFilter.isEmptyElement(t)},bt.prototype.hasSelection=function(t){return t=t||q.call(this),c.hasSelection(t)},bt.prototype.isCursorAtEnd=function(t){return t=t||q.call(this),c.isCursorAtEnd(t)},bt.prototype.isCursorAtStart=function(t){return t=t||q.call(this),c.isCursorAtStart(t)},bt.prototype.teardown=function(){this.undoManager.teardown(),this.keyComboEvents.off()},bt}();e.exports=b},{"./dataFilter":612,"./debugConsole":613,"./formattingControls":614,"./humanKeys":615,"./inlineControls":616,"./keyComboEvents":617,"./linkControl":619,"./selectionContext":624,"./selectionPersistence":625,"./smartQuoter":626,"./undoManager":627,"./utils":628,jquery:"HlZQrA",lodash:"MicNly","velocity-animate":"lWl/mc"}],623:[function(t,e,i){function s(){var t,e;for(e=arguments[0]||{},this.config={},this.config.elements=e.elements?e.elements:[],this.config.attributes=e.attributes?e.attributes:{},this.config.attributes[s.ALL]=this.config.attributes[s.ALL]?this.config.attributes[s.ALL]:[],this.config.allow_comments=e.allow_comments?e.allow_comments:!1,this.allowed_elements={},this.config.protocols=e.protocols?e.protocols:{},this.config.classnames=e.classnames?e.classnames:{},this.config.add_attributes=e.add_attributes?e.add_attributes:{},this.dom=e.dom?e.dom:document,t=0;t<this.config.elements.length;t++)this.allowed_elements[this.config.elements[t]]=!0;if(this.config.remove_element_contents={},this.config.remove_all_contents=!1,e.remove_contents)if(e.remove_contents instanceof Array)for(t=0;t<e.remove_contents.length;t++)this.config.remove_element_contents[e.remove_contents[t]]=!0;else this.config.remove_all_contents=!0;this.transformers=e.transformers?e.transformers:[]}s.REGEX_PROTOCOL=/^([A-Za-z0-9\+\-\.\&\;\*\s]*?)(?:\:|&*0*58|&*x0*3a)/i,s.RELATIVE="__RELATIVE__",s.ALL="__ALL__",s.prototype.clean_node=function(t){function e(t,e){var i;for(i=0;i<e.length;i++)if(e[i]===t)return i;return-1}function i(){var t,e,i=[],s={};for(t=0;t<arguments.length;t++)if(arguments[t]&&arguments[t].length)for(e=0;e<arguments[t].length;e++)s[arguments[t][e]]||(s[arguments[t][e]]=!0,i.push(arguments[t][e]));return i}function n(t){var e;switch(t.nodeType){case 1:a.call(this,t);break;case 3:e=t.cloneNode(!1),this.current_element.appendChild(e);break;case 5:e=t.cloneNode(!1),this.current_element.appendChild(e);break;case 8:this.config.allow_comments&&(e=t.cloneNode(!1),this.current_element.appendChild(e));break;default:console&&console.log&&console.log("unknown node type",t.nodeType)}}function o(t,i){for(var s=[],n=0;n<t.length;n++)-1!==e(t[n],i)&&s.push(t[n]);return s}function a(t){var a,l,h,c,u,d,p,m,g,f,_=r.call(this,t);if(t=_.node,h=t.nodeName.toLowerCase(),l=this.current_element,this.allowed_elements[h]||_.whitelist){this.current_element=this.dom.createElement(t.nodeName),l.appendChild(this.current_element);var v=this.config.attributes;for(c=i(v[h],v[s.ALL],_.attr_whitelist),this.config.classnames[h]&&this.config.classnames[h].length&&c.push("class"),a=0;a<c.length;a++){d=c[a];var b="object"==typeof c[a]||c[a]instanceof Object;if(d=b?c[a].name:c[a],u=t.attributes[d]){m=u.value;var y=m.toLowerCase();if(f=!0,this.config.protocols[h]&&this.config.protocols[h][d]){f=!1,g=this.config.protocols[h][d],g.push(s.RELATIVE);for(var a in g)if(0===y.indexOf(g[a].toLowerCase())){f=!0;break}}"class"===d&&this.config.classnames[h]&&(m=o(m.split(" "),this.config.classnames[h]).join(" "),f=!!m),b&&(f=y.match(c[a].value)),f&&(p=document.createAttribute(d),p.value=m,this.current_element.setAttributeNode(p))}}if(this.config.add_attributes[h])for(d in this.config.add_attributes[h])p=document.createAttribute(d),p.value=this.config.add_attributes[h][d],this.current_element.setAttributeNode(p)}else if(-1!==e(t,this.whitelist_nodes)){for(this.current_element=t.cloneNode(!0);this.current_element.childNodes.length>0;)this.current_element.removeChild(this.current_element.firstChild);l.appendChild(this.current_element)}if(!this.config.remove_all_contents&&!this.config.remove_element_contents[h])for(a=0;a<t.childNodes.length;a++)n.call(this,t.childNodes[a]);this.current_element.normalize&&this.current_element.normalize(),this.current_element=l}function r(t){var s,n,o,a={attr_whitelist:[],node:t,whitelist:!1};for(s=0;s<this.transformers.length;s++)if(o=this.transformers[s]({allowed_elements:this.allowed_elements,config:this.config,node:t,node_name:t.nodeName.toLowerCase(),whitelist_nodes:this.whitelist_nodes,dom:this.dom}),null!==o){if("object"!=typeof o)throw new Error("transformer output must be an object or null");if(o.whitelist_nodes&&o.whitelist_nodes instanceof Array)for(n=0;n<o.whitelist_nodes.length;n++)-1===e(o.whitelist_nodes[n],this.whitelist_nodes)&&this.whitelist_nodes.push(o.whitelist_nodes[n]);a.whitelist=o.whitelist?!0:!1,o.attr_whitelist&&(a.attr_whitelist=i(a.attr_whitelist,o.attr_whitelist)),a.node=o.node?o.node:a.node}return a}var l=this.dom.createDocumentFragment();this.current_element=l,this.whitelist_nodes=[];for(var h=0;h<t.childNodes.length;h++)n.call(this,t.childNodes[h]);return l.normalize&&l.normalize(),l},e.exports=s},{}],624:[function(t,e,i){var s=t("lodash"),n=t("jquery"),o=function(){var t=function(t){return Array.prototype.indexOf.call(t.parentNode.childNodes,t)},e=function(t){return t instanceof HTMLElement},i={getParentNodes:function(t,e){if(e=e||[],!t||i.isEditorNode(t))return e;var s=t.parentNode;return i.isEditorNode(s)?e:s?(e.push(s),i.getParentNodes(s,e)):e},getRootElements:function(s){s=s||i.getSelection();var n=s&&s.anchorNode?s.anchorNode:null;if(!n||i.isEditorNode(n))return[];var o=i.getParentNodes(n),a=s.focusNode,r=i.getParentNodes(a),l=o.length?o.pop():n,h=r.length?r.pop():a,c=t(l),u=t(h);if(c>u){var d=c;c=u,u=d}for(var p=[],m=l.parentNode,g=c;u>=g;g++){var f=m.childNodes[g];e(f)&&p.push(f)}return p},getNodeList:function(t,e){t=t||i.getSelection();var n=t&&t.anchorNode?t.anchorNode:null;if(!n||i.isEditorNode(n))return[];var o=t.focusNode,a=[n];o&&!i.isEditorNode(o)&&(a=a.concat([o]));var r=i.getParentNodes(n);if(a=a.concat(r),!e){var l=i.getParentNodes(o);a=a.concat(l)}var h=s.union(a);return h},getNodeByNames:function(t,e,s){var n=i.getNodeList(s);return n=e?n.reverse():n,this.getNodesByNames(n,t)[0]},getNodesByNames:function(t,e){return s.filter(t,function(t){return-1!==s.indexOf(e,t.nodeName)})},getNearestElement:function(t){t=t||i.getSelection();var e=i.getNodeList();return s.find(e,function(t){return 1===t.nodeType})},getContextCoordinates:function(t,e){var s=i.getSelection(),o=s.getRangeAt(0).cloneRange(),a=n(t).offset();if(e||!s.isCollapsed){var r=(e||o).getBoundingClientRect();return{x:r.left+r.width/2-a.left,y:r.top-a.top+n(window).scrollTop()}}if(o.getClientRects){o.collapse(!0);var l=o.getClientRects()[0];if(l)return{x:l.left-a.left,y:l.top-a.top+n(window).scrollTop()}}},getSelection:function(){var t=window.getSelection();if(t.anchorNode){var e=n(t.anchorNode).closest("[contenteditable]").length;return e?t:null}return null},collapseToEnd:function(){var t=i.getSelection();t&&t.collapseToEnd()},collapseToStart:function(){var t=i.getSelection();t&&t.collapseToStart()},isInContext:function(t,e){return n(t.anchorNode).closest(e).length>0},isEditorNode:function(t){return n(t).is('[contentEditable="true"]')},hasSelection:function(){var t=i.getSelection();return t&&!t.isCollapsed},rangeFromElement:function(t){var e,s,n=i.getSelection();return n&&n.isCollapsed?(s=n.getRangeAt(0),e=s.cloneRange(),e.selectNodeContents(t),e.setEnd(s.startContainer,s.startOffset),e):!1},isCursorAtEnd:function(t,e){var i=this.rangeFromElement(t);if(!i)return!1;var s=i.toString(),n=t.textContent;return e&&(s=s.trim(),n=n.trim()),s.length===n.length},isCursorAtStart:function(t){var e=this.rangeFromElement(t);return e?0===e.startOffset&&0===e.endOffset:!1}};return i}();e.exports=o},{jquery:"HlZQrA",lodash:"MicNly"}],625:[function(t,e,i){var s=function(){return{saveSelection:function(t,e){if(e=e||window.getSelection(),!e||!e.rangeCount)return null;for(var i,s,n,o=e.getRangeAt(0),a=0,r=[t];!n&&(i=r.pop());){if(i.nodeType===i.TEXT_NODE)i===o.startContainer?(a+=o.startOffset,n=!0):a+=i.length;else{var l=i.childNodes.length;if("false"!==i.getAttribute("contenteditable"))for(;l--;)r.push(i.childNodes[l])}s=i}return{container:t,endContainer:o.endContainer,start:a,end:a+o.toString().length,selection:e,anchorNode:e.anchorNode}},restoreSelection:function(t){if(t){var e=0,i=document.createRange();i.setStart(t.container,0),i.collapse(!0);for(var s,n,o=[t.container],a=!1,r=!1;!r&&(s=o.pop());){if(s.nodeType===s.TEXT_NODE){var l=e+s.length;!a&&t.start>=e&&t.start<l&&(i.setStart(s,t.start-e),a=!0),a||l!==t.end||(i.setStart(s,t.end-e),a=!0),a&&t.end>=e&&t.end<=l&&(i.setEnd(s,t.end-e),r=!0),e=l}else{var h=s.childNodes.length;if("false"!==s.getAttribute("contenteditable"))for(;h--;)o.push(s.childNodes[h])}n=s}if(!r){var c=t.end-e;try{i.setEnd(t.endContainer,c)}catch(u){}}var d=window.getSelection();d.removeAllRanges();try{d.addRange(i)}catch(u){}}},setToStart:function(t){if(t){var e=document.createRange();e.setStart(t,0),e.setEnd(t,0),e.collapse(!0);var i=window.getSelection();i.removeAllRanges();try{i.addRange(e)}catch(s){}}},setToEnd:function(t){for(var e=[t],i=null,s=t,n=0;i=e.pop();)if(3===i.nodeType)s=i,n=i.length;else for(var o=i.childNodes.length;o--;)e.push(i.childNodes[o]);var a=document.createRange();a.setStart(s,n),a.setEnd(s,n),a.collapse(!0);var r=window.getSelection();r.removeAllRanges();try{r.addRange(a)}catch(l){}}}}();e.exports=s},{}],626:[function(t,e,i){var s=t("lodash"),n=t("jquery"),o=t("./selectionContext"),a=t("./selectionPersistence"),r=t("./utils"),l=function(){function t(){var t=this;n(this.editor.element).on("keypress",function(s){var n=!1;if(34===s.charCode)n=i.call(t);else{if(39!==s.charCode)return;n=e.call(t)}n&&s.preventDefault()})}function e(){var t=this.config.singleQuotes;return l.call(this,t.open,t.close,t.prime)}function i(){var t=this.config.doubleQuotes;return l.call(this,t.open,t.close,t.prime)}function l(t,e,i){var r=o.getSelection();if(!r.isCollapsed)return!1;var l=r.anchorNode;l.normalize();var h=a.saveSelection(l),c=l.textContent,u=c.slice(0,h.start),d=u.charAt(u.length-1),p=l.lastChild&&"BR"===l.lastChild.nodeName?l.lastChild:null,m=s.any(this.config.openingMatches,function(t){return t.test(d)})||p,g="";g=!d||m?t:/\d/.test(d)?i:e;var f=document.createTextNode(g),_=r.getRangeAt(0);return _.deleteContents(),_.insertNode(f),p&&p.previousSibling&&"BR"===p.previousSibling.nodeName&&n(p).remove(),_.setEndAfter(f),_.collapse(!1),r.removeAllRanges(),r.addRange(_),!0}var h=function(e,i){return r.browser.msie?null:(this.editor=e,this.config={openingMatches:[/\s/,/\u200B/,/[=]/],singleQuotes:{open:"‘",close:"’",prime:"′"},doubleQuotes:{open:"“",close:"”",prime:"″"}},s.extend(this.config,i||{}),void t.call(this))};return h}();e.exports=l},{"./selectionContext":624,"./selectionPersistence":625,"./utils":628,jquery:"HlZQrA",lodash:"MicNly"}],627:[function(t,e,i){var s=t("lodash"),n=t("jquery"),o=t("./selectionPersistence"),a=function(){function t(){var t=this,s=function(t){return/Mac/.test(navigator.platform)?t.metaKey:t.ctrlKey};n(this.editor.element).on("keydown.undoManager",function(n){return n.keyCode===c.z&&s(n)&&!n.altKey?(n.shiftKey?i.call(t):e.call(t),n.preventDefault(),!1):void 0})}function e(){if(l.call(this),this.undoStates.length){var t=this.undoStates.pop();h.call(this,t),this.redoStates.push(this.currState),a.call(this)}}function i(){if(this.redoStates.length){var t=this.redoStates.pop();h.call(this,t),this.undoStates.push(this.currState),a.call(this)}}function a(){this.currState=r.call(this)}function r(){var t={data:this.editor.getData(!0,!0),selection:o.saveSelection(this.editor.element)};return t}function l(){var t=r.call(this);return this.currState?void(t.data!==this.currState.data&&(this.undoStates.push(this.currState),this.currState=t)):void(this.currState=t)}function h(t){if(this.isRestoring=!0,this.editor.setData(t.data,!0),t.selection)o.restoreSelection(t.selection);else{var e=window.getSelection();e.removeAllRanges()}this.afterRestore()}var c={command:91,control:17,shift:16,z:90},u=500,d=function(e,i){this.editor=e,this.modifierKeyCode=!1,this.isShift=!1,this.currState=null,this.undoStates=[],this.redoStates=[],this.afterRestore=i||function(){},this.isRestoring=!1;var n=this,o=s.debounce(function(){n.isTorndown||l.call(n)},u);this.defaultOnChange=e.onChange,e.onChange=function(t){if(n.isRestoring)n.isRestoring=!1;else{if("updateAsyncImage"===t)return;n.currState?o():l.call(n)}n.defaultOnChange.call(this)},t.call(this)};return d.prototype.undo=function(){e.call(this)},d.prototype.redo=function(){i.call(this)},d.prototype.teardown=function(){this.isTorndown=!0,this.editor.onChange=this.defaultOnChange,this.undoStates.length=0,this.redoStates.length=0,this.currState=null,n(this.editor.element).off(".undoManager")},d}();e.exports=a},{"./selectionPersistence":625,jquery:"HlZQrA",lodash:"MicNly"}],628:[function(t,e,i){var s=t("lodash"),n=t("jquery"),o=function(){var t=function(){};return t.calcTextWidth=function(t,e){var i=["font-style","font-weight","font-size","font-family"],o=s.reduce(i,function(e,i){return e+" "+n(t).css(i)},"").trim(),a=document.createElement("canvas"),r=a.getContext("2d");r.font=o;var l=r.measureText(e);return Math.round(l.width)},t.browser=function(){var t=function(t){t=t.toLowerCase();var e=/(chrome)[ \/]([\w.]+)/.exec(t)||/(webkit)[ \/]([\w.]+)/.exec(t)||/(opera)(?:.*version|)[ \/]([\w.]+)/.exec(t)||/(trident)[ \/]([\w.]+)/.exec(t)||/(msie) ([\w.]+)/.exec(t)||t.indexOf("compatible")<0&&/(mozilla)(?:.*? rv:([\w.]+)|)/.exec(t)||[];return{browser:e[1]||"",version:e[2]||"0"}},e=t(navigator.userAgent),i={};return e.browser&&(i[e.browser]=!0,i.version=e.version),i.trident&&(i.msie=!0),i.chrome?i.webkit=!0:i.webkit&&(i.safari=!0),i}(),t}();e.exports=o},{jquery:"HlZQrA",lodash:"MicNly"}],629:[function(t,e,i){"use strict";function s(t,e){return e?t.replace(r,function(t,i,s){return!s||l.test(s)?i:("/"!==s[0]&&(s="/"+s),'url("'+e+s+'")')}):t}function n(t){a.styleSheet.cssText=t}function o(t){for(;a.hasChildNodes();)a.removeChild(a.firstChild);a.appendChild(document.createTextNode(t))}var a=document.createElement("style");document.head.appendChild(a);var r=/(url(?:\(['|"]?)(.*?)(?:['|"]?\)))/g,l=/^\s*(https?:)\/\//,h=a.styleSheet?n:o,c=function(t){return h(a.innerHTML.replace(t,""))};i.insertHost=s,i.element=a,i.inject=h,i.eject=c},{}],630:[function(t,e,i){!function(t){t(function(t){var e=t("./when"),i=e.Promise.all,s=Array.prototype.slice;return function(t){function n(t){return o.push(t),o}var o=[];return i(s.call(arguments,1)).then(function(i){return e.reduce(t,function(t,s){return e(s.apply(void 0,i),n)},o)})}})}("function"==typeof define&&define.amd?define:function(i){e.exports=i(t)})},{"./when":"RG2dij"}]},{},[]);